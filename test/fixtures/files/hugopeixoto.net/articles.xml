<?xml version="1.0" encoding="UTF-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <id>https://hugopeixoto.net/</id>
  <title>Hugo Peixoto's blog</title>
  <updated>2023-02-19T00:00:00Z</updated>
  <link rel="alternate" href="https://hugopeixoto.net/"/>
  <link rel="self" href="https://hugopeixoto.net/articles.xml"/>
  <author>
    <name>Hugo Peixoto</name>
    <uri>http://hugopeixoto.net</uri>
  </author>
  <entry>
    <id>tag:hugopeixoto.net,2023-02-19:/articles/status-update-2023-01-31.html</id>
    <title type="html">Status update, January and February 2023</title>
    <published>2023-02-19T00:00:00Z</published>
    <updated>2023-02-19T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/status-update-2023-01-31.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;For the second half of January, I focused on getting ready for ANSOL meetings with the Portuguese Members of the European Parliament (MEPs). During the first week of February, I was in Brussels having meetings and attending &lt;a href=&quot;https://fosdem.org&quot;&gt;FOSDEM&lt;/a&gt;. This week, I attended the &lt;a href=&quot;https://pt2023.mini.debconf.org/&quot;&gt;Mini Debconf in Lisbon&lt;/a&gt;.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;For the second half of January, I focused on getting ready for ANSOL meetings
with the Portuguese Members of the European Parliament (MEPs). During the first
week of February, I was in Brussels having meetings and attending
&lt;a href=&quot;https://fosdem.org&quot;&gt;FOSDEM&lt;/a&gt;. This week, I attended the &lt;a href=&quot;https://pt2023.mini.debconf.org/&quot;&gt;Mini Debconf in
Lisbon&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&quot;fosdem--brussels&quot;&gt;FOSDEM / Brussels&lt;/h2&gt;

&lt;p&gt;My visit to Brussels was mostly as a representative of ANSOL. We had scheduled
meeting with the Portuguese MEPs with a focus on the Child Sexual Abuse
Material Regulation proposal (also known as &lt;a href=&quot;https://chatcontrol.eu/&quot;&gt;Chat Control&lt;/a&gt;).
Before our meetings, I attended &lt;a href=&quot;https://international.eco.de/event/bxltalk/&quot;&gt;a panel discussion on the subject&lt;/a&gt; with a
member of EDRi and two MEPs. This helped me understand how the European
Parliament currently feels about the topic.&lt;/p&gt;

&lt;p&gt;When the meetings were done, we helped the FSFE team organize their booth at
FOSDEM and socialized a bit with them over the weekend. This year, I managed to
meet and interact with a bunch of people. It was exhausting, but hopefully
useful.&lt;/p&gt;

&lt;p&gt;On Monday, I joined a LibreOfficeTech hackfest, which I used mostly as an
excuse to give LibreOffice Impress a try. I have to thank &lt;a href=&quot;https://pintosilva.com/&quot;&gt;Pedro
Silva&lt;/a&gt; for the invitation.&lt;/p&gt;

&lt;h2 id=&quot;minidebconf-lisbon&quot;&gt;MiniDebConf Lisbon&lt;/h2&gt;

&lt;p&gt;There was a MiniDebConf in Lisbon last week. I’ve been using Debian for almost
20 years now, and I never attended any Debian events. Since this one was so
close to home, there was no excuse.&lt;/p&gt;

&lt;p&gt;I submitted a presentation reflecting on the last 10 years of Porto Codes. The
organization needed some help with the AV stuff, so I helped by handling the
recording of each talk, operating the microphones and the camera. During the
event, I restarted my &lt;a href=&quot;/articles/html-xml-utils-fix.html&quot;&gt;attempt at updating the html-xml-utils
package&lt;/a&gt;. This time, with so many
knowledgeable people around, I was able to understand the tools and processes
with which that package is managed.&lt;/p&gt;

&lt;p&gt;Since the event included February 14, also known as the “I &amp;lt;3 Free Software
Day”, I ordered some FSFE materials and set up a little booth distributing
stickers and flyers. ANSOL also took the opportunity to recruit new members. I
was responsible for handling these sign-ups during the event.&lt;/p&gt;

&lt;h2 id=&quot;the-year-of-self-hosting&quot;&gt;2023: the year of self-hosting&lt;/h2&gt;

&lt;p&gt;I started working on migrating Conversas em Código away from Simplecast. The
first step was to download the current RSS feed and try to generate it from a
set of yaml files and a ruby script. I didn’t have much time to work on it yet,
but it’s a work in progress.&lt;/p&gt;

&lt;p&gt;I’ve also been discussing with other groups the possibility of setting up a
shared &lt;a href=&quot;https://mobilizon.org/&quot;&gt;Mobilizon&lt;/a&gt; instance. There is a &lt;a href=&quot;https://gancio.org&quot;&gt;Gancio&lt;/a&gt;
instance focused on Portuguese events, but I’m not sure if those two platforms
serve the same purpose.&lt;/p&gt;

&lt;h2 id=&quot;porto-codes&quot;&gt;Porto Codes&lt;/h2&gt;

&lt;p&gt;On January 19, there was the first Porto Codes meetup in a while (excluding
Hacktoberfest events). I had to postpone February’s edition due to a conflict
with MiniDebConf, it’s now scheduled for &lt;a href=&quot;https://www.meetup.com/portocodes/events/291706615/&quot;&gt;March 2,
2023&lt;/a&gt;.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;


    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2023-01-29:/articles/printer-certificate-shenanigans.html</id>
    <title type="html">Printer certificate shenanigans</title>
    <published>2023-01-29T00:00:00Z</published>
    <updated>2023-01-29T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/printer-certificate-shenanigans.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;After moving, my computer and printer stopped talking to each other. Obviously, I only noticed the issue when I was in a hurry to print something. Today I finally stopped to fix it.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;After moving, my computer and printer stopped talking to each other. Obviously,
I only noticed the issue when I was in a hurry to print something. Today I
finally stopped to fix it.&lt;/p&gt;

&lt;p&gt;CUPS would detect the printer, and I was able to queue the job, but as soon as
the job started processing, it would fail and the printer would enter a
“Paused” state.&lt;/p&gt;

&lt;p&gt;I don’t know much about printers or CUPS, so I looked for some log files in
&lt;code&gt;/var/log/&lt;/code&gt;. There are two: &lt;code&gt;/var/log/cups/access_log&lt;/code&gt; and
&lt;code&gt;/var/log/cups/error_log&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;I enabled debug logging with &lt;code&gt;cupsctl --debug-logging&lt;/code&gt;, restarted cups, and
queued another print job. I’m not sure if this was necessary to debug this
particular issue, but it wouldn’t hurt.&lt;/p&gt;

&lt;p&gt;The error log contained the following snippet (with some identifiers hidden
just in case):&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;D [28/Jan/2023:19:49:18 +0000] [Notifier] state=3
D [28/Jan/2023:19:49:18 +0000] [Notifier] JobProgress
D [28/Jan/2023:19:49:18 +0000] [Notifier] state=3
D [28/Jan/2023:19:49:18 +0000] [Notifier] state=3
D [28/Jan/2023:19:49:18 +0000] [Notifier] state=3
D [28/Jan/2023:19:49:18 +0000] [Notifier] PrinterStateChanged
D [28/Jan/2023:19:49:19 +0000] [Job 32] update_reasons(attr=0(), s=\&quot;-cups-certificate-error\&quot;)
D [28/Jan/2023:19:49:19 +0000] [Job 32] Connection is encrypted.
I [28/Jan/2023:19:49:19 +0000] Expiring subscriptions...
D [28/Jan/2023:19:49:19 +0000] [Job 32] Credentials are invalid (New credentials are older than stored credentials.)
D [28/Jan/2023:19:49:19 +0000] [Job 32] Printer credentials: HPFFFFFF-2 (issued by HP) / Sat, 28 Sep 2032 03:45:61 GMT / RSA-SHA256 / AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
D [28/Jan/2023:19:49:19 +0000] [Job 32] Stored credentials: HPFFFFFF (issued by HP) / Tue, 07 Jun 2037 10:24:56 GMT / RSA-SHA256 / BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB
D [28/Jan/2023:19:49:19 +0000] [Job 32] update_reasons(attr=0(), s=\&quot;-cups-pki-invalid,cups-pki-changed,cups-pki-expired,cups-pki-unknown\&quot;)
D [28/Jan/2023:19:49:19 +0000] [Job 32] update_reasons(attr=0(), s=\&quot;+cups-pki-invalid\&quot;)
D [28/Jan/2023:19:49:19 +0000] [Job 32] STATE: +cups-pki-invalid
D [28/Jan/2023:19:49:19 +0000] cupsdMarkDirty(P----)
D [28/Jan/2023:19:49:19 +0000] cupsdSetBusyState: newbusy=&quot;Printing jobs and dirty files&quot;, busy=&quot;Printing jobs and dirty files&quot;
D [28/Jan/2023:19:49:19 +0000] cupsdMarkDirty(---J-)
D [28/Jan/2023:19:49:19 +0000] cupsdSetBusyState: newbusy=&quot;Printing jobs and dirty files&quot;, busy=&quot;Printing jobs and dirty files&quot;
D [28/Jan/2023:19:49:19 +0000] cupsdMarkDirty(----S)
D [28/Jan/2023:19:49:19 +0000] cupsdSetBusyState: newbusy=&quot;Printing jobs and dirty files&quot;, busy=&quot;Printing jobs and dirty files&quot;
D [28/Jan/2023:19:49:19 +0000] [Notifier] state=3
D [28/Jan/2023:19:49:19 +0000] [Notifier] PrinterStateChanged
D [28/Jan/2023:19:49:19 +0000] [Notifier] state=3
D [28/Jan/2023:19:49:19 +0000] [Job 32] The IPP Backend exited with the status 4
D [28/Jan/2023:19:49:19 +0000] [Client 8] HTTP_STATE_WAITING Closing for error 32 (Broken pipe)
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It seems that the printer, when connecting to the new network, started
announcing its name with a &lt;code&gt;-2&lt;/code&gt; suffix. My desktop had a cached certificate
with the old name (without the suffix), so the connection failed.&lt;/p&gt;

&lt;p&gt;To solve the problem all I had to do was remove the now stale certificate:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;rm&lt;/span&gt; /etc/cups/ssl/HPEEEEEEFFFFFF.local.crt
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Immediately requesting another print job worked, no need to restart cups.&lt;/p&gt;

&lt;p&gt;Comparing both the old and the new cached certificate, I confirmed that the
Subject had a different CN in both: no suffix on the old one, &lt;code&gt;-2&lt;/code&gt; suffix on
the new one. Not sure why the printer decided to change names, but it probably
had something to do with having to configure a new wifi network.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2023-01-14:/articles/status-update-2022-12-31.html</id>
    <title type="html">Status update, November and December 2022</title>
    <published>2023-01-14T00:00:00Z</published>
    <updated>2023-01-14T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/status-update-2022-12-31.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;Porto Codes is restarting. Cyberscore now uses Twig templates. I’m going to FOSDEM.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;After moving and unpacking, I was away from the computer for a couple of weeks.&lt;/p&gt;

&lt;h2 id=&quot;advent-of-code&quot;&gt;Advent of code&lt;/h2&gt;

&lt;p&gt;I didn’t have much time to participate in Advent of Code this year, but I
managed to solve most of them by now: &lt;a href=&quot;https://github.com/hugopeixoto/aoc2022&quot;&gt;https://github.com/hugopeixoto/aoc2022&lt;/a&gt;.
I was having trouble solving &lt;a href=&quot;https://adventofcode.com/2022/day/19&quot;&gt;day 19 part
2&lt;/a&gt;, so I’d like to give it another try
soon.&lt;/p&gt;

&lt;h2 id=&quot;cyberscore&quot;&gt;Cyberscore&lt;/h2&gt;

&lt;p&gt;Cyberscore HTML templates were pure PHP instead of something like Twig. This
had a number of problems. First, there was no way to enable HTML autoescaping
by default, meaning we were one missing &lt;code&gt;h()&lt;/code&gt; call away from suffering from
XSS. Second, it was hard to stop someone from adding SQL queries and complex
PHP code to template files. Third, templates had access to every global
variable defined in the PHP file that rendered the template.&lt;/p&gt;

&lt;p&gt;With this in mind, I &lt;a href=&quot;https://gitlab.com/cyberscore/cyberscore/-/merge_requests/1556&quot;&gt;added support for Twig
templates&lt;/a&gt;. Now
things are automatically HTML escaped, you need to explicitly list which
variables the template can see, and no more PHP can leak onto them.&lt;/p&gt;

&lt;p&gt;There are ~13k lines of template code on cyberscore, all of which will need to
be ported to Twig. I’m roughly 25% there, but there are some &lt;a href=&quot;https://gitlab.com/cyberscore/cyberscore/-/blob/5fc4f1c5f9bad922fc894fc9c4b2b50bab45fa20/src/templates/charts/show.php&quot;&gt;scary
files&lt;/a&gt;
that will take some time to convert.&lt;/p&gt;

&lt;h2 id=&quot;forge-federation-grant-proposal&quot;&gt;Forge federation grant proposal&lt;/h2&gt;

&lt;p&gt;I submitted a proposal to be funded by NLNet to add federation support to
gitlab. I am expecting an answer some time this month:
&lt;a href=&quot;https://forum.forgefriends.org/t/federation-in-gitlab-nlnet-grant-proposal-maybe-december-2022/933&quot;&gt;https://forum.forgefriends.org/t/federation-in-gitlab-nlnet-grant-proposal-maybe-december-2022/933&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;porto-codes&quot;&gt;Porto Codes&lt;/h2&gt;

&lt;p&gt;This January we’ll have the first proper Porto Codes event in a long time, with
two talks:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;From top secret to common knowledge: how sensitive is sensitive data?, by
Rita Silva&lt;/li&gt;
  &lt;li&gt;A informática hospitalar e das instituições públicas - reflexões de um quase
aposentado, by Mário Seixas&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;See the complete details on our meetup page:
&lt;a href=&quot;https://www.meetup.com/portocodes/events/290857364/&quot;&gt;https://www.meetup.com/portocodes/events/290857364/&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;ansol--fosdem&quot;&gt;ANSOL / FOSDEM&lt;/h2&gt;

&lt;p&gt;In what probably wasn’t the smartest idea, I volunteered to go to FOSDEM
representing ANSOL. I’ll be there some days before to attend a few smaller
events.&lt;/p&gt;

&lt;h2 id=&quot;the-year-of-self-hosting&quot;&gt;2023: The year of self-hosting&lt;/h2&gt;

&lt;p&gt;I’ve started doing this last year, but I’m going to continue to migrate away
from third party hosted services to self hosting solutions (even if it’s on a
VPS). Initially my plan was to migrate at least one service per month. Here’s a
quick list of services that I’m thinking of self-hosting:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Simplecast, where we host the podcast &lt;a href=&quot;https://conversasemcodigo.pt&quot;&gt;https://conversasemcodigo.pt&lt;/a&gt;. We
haven’t published any new episodes in a bit, and it’s a bit costly to
maintain.&lt;/li&gt;
  &lt;li&gt;I’d like to leave &lt;code&gt;meetup.com&lt;/code&gt; but given its network effect, it’s going to be
a bit hard to do. Maybe if I setup a mobilizon instance and offer it to the
local meetups or something, not sure.&lt;/li&gt;
  &lt;li&gt;Matrix, I’m using an account on &lt;code&gt;matrix.org&lt;/code&gt; and I’d like to use my own
homeserver with my own domain. I am waiting on &lt;code&gt;conduit.rs&lt;/code&gt; to reach 1.0 but
maybe I can give it a try anyway.&lt;/li&gt;
  &lt;li&gt;Ultimately, email.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;This doesn’t cover 12 months, but the last item alone will be a multi month
project.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2022-11-15:/articles/status-update-2022-10-31.html</id>
    <title type="html">Status update, October 2022</title>
    <published>2022-11-15T00:00:00Z</published>
    <updated>2022-11-15T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/status-update-2022-10-31.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;Late october update, I’m moving cities again. I managed to do a bunch of small tasks in several different projects.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;Another late update — I was busy with stuff during the first half of October.
I’m moving places again, so until December I’ll probably be busy packing and
moving things around. Oh, and I’m on the fediverse now: &lt;a href=&quot;https://ciberlandia.pt/@hugopeixoto&quot;&gt;@hugopeixoto@ciberlandia.pt&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&quot;porto-codes&quot;&gt;Porto Codes&lt;/h2&gt;

&lt;p&gt;During this year’s hacktoberfest we organized &lt;a href=&quot;https://www.meetup.com/portocodes/events/289194405/&quot;&gt;contributing
session&lt;/a&gt; on
&lt;a href=&quot;https://significa.co/&quot;&gt;Significa&lt;/a&gt;’s office. We had around a dozen folks show
up, with some making their first open source contribution.&lt;/p&gt;

&lt;h2 id=&quot;ansol&quot;&gt;ANSOL&lt;/h2&gt;

&lt;p&gt;I’m working on translating the &lt;a href=&quot;https://fedigov.ch/&quot;&gt;Fedigov&lt;/a&gt; website to
Portuguese. Hopefully I’ll publish it this week.
&lt;a href=&quot;https://git.ansol.org/ansol/saucy&quot;&gt;Saucy&lt;/a&gt; has some issues that need fixing, so
I’ll be working on that this week.&lt;/p&gt;

&lt;h2 id=&quot;d3---defesa-dos-direitos-digitais&quot;&gt;D3 - Defesa dos Direitos Digitais&lt;/h2&gt;

&lt;p&gt;I upgraded our instance of bitwarden and hedgedoc to the latest versions and
wrote some documentation on how things are currently deployed.&lt;/p&gt;

&lt;h2 id=&quot;cyberscore&quot;&gt;Cyberscore&lt;/h2&gt;

&lt;p&gt;I did a big data model change to cyberscore. Each chart can have a bunch of
flags and point modifiers. The way these modifiers and flags were stored was
weird and hard to query. Here’s the old schema:&lt;/p&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;TABLE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;chart_modifiers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;chart_id&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;UNSIGNED&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;INT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;PRIMARY&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;KEY&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;csp_modifier&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;UNSIGNED&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;INT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;DEFAULT&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;chart_flag&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;UNSIGNED&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;INT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;DEFAULT&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If a chart had two chart flags and three csp modifiers, it would have five
entries in this table. With this layout, it wasn’t easy to find charts that had
two chart flags, or charts that had no csp modifiers. It also relied on &lt;code&gt;int&lt;/code&gt;
based enums which made our code a bit more unreadable. This is the new schema:&lt;/p&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;TABLE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;chart_modifiers2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;chart_id&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;UNSIGNED&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;INT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;PRIMARY&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;KEY&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;standard&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;BOOLEAN&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;DEFAULT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;speedrun&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;BOOLEAN&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;DEFAULT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;solution&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;BOOLEAN&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;DEFAULT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;-- ...&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;significant_regional_differences&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;BOOLEAN&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;DEFAULT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;significant_device_differences&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;BOOLEAN&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;DEFAULT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;-- ...&lt;/span&gt;

&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It has a bunch more columns than the previous schema and their names are
longer, but it’s easier to query and to update. After fixing all the
references, we ended up with fewer lines of code. This is the summary of the
merge request: &lt;code&gt;122 files, +1522, -1735&lt;/code&gt;.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2022-10-02:/articles/status-update-2022-09-30.html</id>
    <title type="html">Status update, September 2022</title>
    <published>2022-10-02T00:00:00Z</published>
    <updated>2022-10-02T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/status-update-2022-09-30.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;This month I was mostly focused on organizing events. I was the AV team for a conference in Lisbon and the organizer of another one in Porto.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;This month I was mostly focused on organizing events. I was the AV team for a
conference in Lisbon and the organizer of another one in Porto.&lt;/p&gt;

&lt;h2 id=&quot;ansol&quot;&gt;ANSOL&lt;/h2&gt;

&lt;p&gt;I organized an event celebrating &lt;a href=&quot;https://softwarefreedomday.org/&quot;&gt;Software Freedom Day 2022&lt;/a&gt;. This
included finding speakers, designing the poster, finding and booking a dining
place, spreading the word, and recording and editing the videos. The
presentations are now &lt;a href=&quot;https://viste.pt/w/p/4irPoTqG4bSHPU4JD56TGL&quot;&gt;available online&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Our &lt;a href=&quot;https://git.ansol.org/ansol/saucy&quot;&gt;member management platform&lt;/a&gt; is ready to be deployed. It now
includes a task that imports data from a custom CiviCRM dump, so the only thing
that we need to do is enable saucy and disable CiviCRM. Our ansible repository
needed some changes so I took the time to redesign our LXD saucy container.&lt;/p&gt;

&lt;p&gt;We have the opportunity to prepare a document for the &lt;a href=&quot;https://www.opengovpartnership.org/events/europe-regional-meeting/&quot;&gt;2022 OGP Europe Regional
Meeting&lt;/a&gt;. We only have a week or so to prepare, so it’s kind of
tight. I’ll probably be focusing on that this week.&lt;/p&gt;

&lt;h2 id=&quot;cyberscore&quot;&gt;Cyberscore&lt;/h2&gt;

&lt;p&gt;Cyberscore has a feature where you upload a bunch of screenshots and it
automatically scans the images for high scores. This saves players a lot of
time when submitting to games with tons of charts.&lt;/p&gt;

&lt;p&gt;This feature is implemented as a bunch of javascript and a &lt;a href=&quot;https://gitlab.com/cyberscore/auto-proofer&quot;&gt;WASM rust
module&lt;/a&gt; that does the actual image detection. I’m not super happy
with the state of things, so I’ve been working on redesigning most of it. One
important thing is having some feedback when the module fails to detect any
high scores, so I’m adding a debug mode that displays some logging information
and bounding boxes.  I’ve also moved from vanilla javascript to
&lt;a href=&quot;https://preactjs.com/&quot;&gt;Preact&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;We’re having some weird server issues that causes occasional downtime windows.
I still haven’t found the cause, but it’s likely that it’s caused by the cron
jobs that recalculate the scoreboards slowing down. Since the cron job runs
every five minutes, sometimes a new job starts before the last one finishes,
which probably makes things worse.&lt;/p&gt;

&lt;h2 id=&quot;random-stuff&quot;&gt;Random stuff&lt;/h2&gt;

&lt;p&gt;Like I mentioned, I volunteered to be the AV team for &lt;a href=&quot;https://gambiconf.dev/&quot;&gt;GambiConf&lt;/a&gt;,
an in-person conference in Lisbon. You can read more about the experience in
&lt;a href=&quot;/articles/my-conference-livestreaming-setup-at-gambiconf.html&quot;&gt;My conference livestreaming setup at GambiConf&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I’ve been working with &lt;a href=&quot;https://devpt.co&quot;&gt;DevPT&lt;/a&gt; to start a weekly code challenge
initiative. We’ll be using codewars, so we’ll be picking some code challenges
from their roster instead of having to design our own. I built a &lt;a href=&quot;https://github.com/devpt-org/codewars&quot;&gt;custom
leaderboard&lt;/a&gt; for our members. I’ve also volunteered to setup a FOSS
infrastructure for their meetups to get them off Zoom.&lt;/p&gt;

&lt;h2 id=&quot;october-plans&quot;&gt;October plans&lt;/h2&gt;

&lt;p&gt;It’s hacktoberfest again, so I’m planning on organizing an event or two focused
on open source contributions. I’d also like to finish implementing all the base
set cards on my &lt;a href=&quot;https://github.com/hugopeixoto/tcg-engine&quot;&gt;Pokémon TCG engine&lt;/a&gt; and start to implement a
graphical interface.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;


    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2022-09-25:/articles/my-conference-livestreaming-setup-at-gambiconf.html</id>
    <title type="html">My conference livestreaming setup at GambiConf</title>
    <published>2022-09-25T00:00:00Z</published>
    <updated>2022-09-25T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/my-conference-livestreaming-setup-at-gambiconf.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;I volunteered to be the AV team at GambiConf, an in-person conference in Lisbon. Some things didn’t go exactly as planned, so here’s a summary of how things went.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;I volunteered to be the AV team at &lt;a href=&quot;https://gambiconf.dev/&quot;&gt;GambiConf&lt;/a&gt;, an
in-person conference in Lisbon. Some things didn’t go exactly as planned, so
here’s a summary of how things went.&lt;/p&gt;

&lt;h2 id=&quot;the-original-plan&quot;&gt;The original plan&lt;/h2&gt;

&lt;p&gt;We wanted to capture the speaker’s voice, computer screen, and have a camera
pointed at the stage. We also wanted to livestream the whole thing. The
organizers told me the venue had a large screen, so no need to bring an image
projector.&lt;/p&gt;

&lt;p&gt;The plan was to use OBS on a dedicated Mini-ITX computer with a bunch of USB-C
ports. Then, a Canon camera with “clean HDMI” output would be connected via an
HDMI to USB-C capture adapter. We had a wireless microphone whose receiver was
connected via 3.5’’ to the camera, so that everything would be synced. Then,
the idea was to use an AverMedia LGP 4k to intercept the speaker’s computer
connection to the TV and stream it to the OBS machine over USB-C.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;gambiconf-setup-diagram.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Like every plan, it didn’t survive first contact.&lt;/p&gt;

&lt;h2 id=&quot;obs-machine-issues&quot;&gt;OBS machine issues&lt;/h2&gt;

&lt;p&gt;I purchased most of the pieces recently, but the hard drive was the one from my
&lt;a href=&quot;/articles/upgrading-my-backup-servers-hard-drive.html&quot;&gt;backup server&lt;/a&gt;. This was a mistake. It is slow, causing the
full disk encryption unlocking to take around five minutes. If I mistyped the
passphrase, I had to wait 5 minutes before being able to try again. I’ve since
added an m.2 SSD so I won’t have the same issues again.&lt;/p&gt;

&lt;h2 id=&quot;computer-screen&quot;&gt;Computer screen&lt;/h2&gt;

&lt;p&gt;I arrived at the venue and hit the first issue almost immediately: the screen
had a weird resolution of 1366x768. My fedora powered macbook pro was able to
connect to it, but the organizer’s computer (running both MacOS and Windows
under Parallels) was having trouble and the AverMedia device also doesn’t
support that resolution. I tried to replace the AverMedia with a backup HDMI
splitter, but it also didn’t work.&lt;/p&gt;

&lt;p&gt;As a last resort, we tried &lt;a href=&quot;https://vdo.ninja&quot;&gt;VDO.Ninja&lt;/a&gt;, which uses WebRTC to transmit
video peer to peer. We connected my laptop to the venue’s screen, loaded
VDO.Ninja on both laptops and used the screenshare functionality to cast the
speaker’s screen on the venue’s big screen. We had to enable the 1080p option
in VDO.Ninja for things to work, otherwise it would default to a low
resolution. This worked great, except when one of the speaker was using a VPN,
causing some lag between what they had on their computer and what showed up on
the big screen.&lt;/p&gt;

&lt;p&gt;The VDO.Ninja solution also made it easy to plug the computer screen stream
into OBS, as I could just load the same URL as a browser source.&lt;/p&gt;

&lt;h2 id=&quot;camera&quot;&gt;Camera&lt;/h2&gt;

&lt;p&gt;I had a Canon camera with me with clean HDMI output. I connected it to the OBS
machine with a hdmi2usb capture thingie, and it seemed to work… most of the
time. If I turned off the camera or temporarily unplugged the cables, OBS would
show a blank screen. The camera stream also turned black once after some
minutes of operation.&lt;/p&gt;

&lt;p&gt;Sometimes, removing and adding the camera source would solve the problem.
Sometimes, I’d have to reboot the OBS machine. Instead of relying on this and
having to reboot things mid-talk, I switched to a different plan: use a backup
smartphone and stream its camera source with VDO.Ninja. Not as fancy as a
Canon, but it worked, without any timeouts or disconnections. I forgot to bring
a smartphone clamp, but fortunately someone had one of those light ring tripods
that we could use.&lt;/p&gt;

&lt;p&gt;There were some sound issues: the smartphone was emitting some sort of
feedback. I could hear my fingers whenever I touched it, like it was monitoring
its own microphone. I couldn’t figure out a way to disable that, so I lowered
the volume as far as I could to minimize the issue.&lt;/p&gt;

&lt;p&gt;Another advantage of using a smartphone with VDO.Ninja is that we were no
longer needed a cable connecting the camera to the OBS machine. This gives us
more freedom in placing the camera.&lt;/p&gt;

&lt;h2 id=&quot;speakers-microphone&quot;&gt;Speaker’s microphone&lt;/h2&gt;

&lt;p&gt;The plan was to use a Rode Go microphone system, connecting the receiver to the
camera. Since we were no longer using the camera, I connected it directy to the
mic port on the OBS machine.&lt;/p&gt;

&lt;p&gt;At first I was confused because I could hear people talking, but talking
directly to the Rode wouldn’t be significantly louder. After a while I figured
out that the sound was coming from the smartphone stream instead. After
removing that audio source, I still couldn’t hear anything, but eventually
found that the receiver had the output pad set to -24dB. After changing this to
-9dB, things worked fine.&lt;/p&gt;

&lt;h2 id=&quot;conclusions&quot;&gt;Conclusions&lt;/h2&gt;

&lt;p&gt;The first takeaway was that having a backup plan pays off. The AverMedia had
the HDMI splitter and VDO.Ninja fallback options. The camera had the smartphone
fallback option. I didn’t have a backup plan for the OBS machine and the
microphones, but those were the pieces less likely to fail.&lt;/p&gt;

&lt;p&gt;Another takeaway was that being a single-person AV team isn’t really feasible.
I had to recruit someone to monitor the livestream, someone to help me debug
the audio problems, and the organizer set up the OBS layout himself.&lt;/p&gt;

&lt;p&gt;The whole thing was very tiring, but rewarding. My day started at 5AM and ended
at 2AM because I had to travel from Porto to Lisbon and back, I spent most of
the morning on my knees messing with cables, and I was monitoring everything
during the afternoon. Nevertheless, it was a fun experience, I met some
interesting folks, and now I know what works and what needs improving.&lt;/p&gt;

&lt;p&gt;You can check the final result on &lt;a href=&quot;https://www.youtube.com/watch?v=EVJZavbMThs&quot;&gt;GambiConf’s youtube
channel&lt;/a&gt;. I really enjoyed the
talks that I managed to watch, so I recommend checking them out. Here’s a
picture of final setup:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;gambiconf-setup.jpg&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;


    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2022-08-20:/articles/status-update-2022-08-20.html</id>
    <title type="html">Status update, July and August 2022</title>
    <published>2022-08-20T00:00:00Z</published>
    <updated>2022-08-20T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/status-update-2022-08-20.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;Cyberscore is now Free Software; ANSOL is organizing a Software Freedom Day event; I installed a bunch of Linux distros on my computers; and finally, I started yet another Pokémon project.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;I’m grouping together July and August, since July was mostly hyper-focusing on
a new silly project.&lt;/p&gt;

&lt;h2 id=&quot;cyberscore&quot;&gt;Cyberscore&lt;/h2&gt;

&lt;p&gt;Big news: Cyberscore is now Free Software!&lt;/p&gt;

&lt;p&gt;During August, I finally took the final steps to open source the project’s
codebase: resetting all the passwords and hardening the server a bit. We have
some passwords in the git history, so instead of messing with
&lt;code&gt;git-filter-branch&lt;/code&gt;, I rotated everything. We were also using mysql’s root
username/password for everything: the website, forums, and other side projects.
Now we have a user per project, limited to their own database. There were some
old CPanel mysql users from the previous webhost still in there, so I removed
them as well. Our phpmyadmin by is now limited to being accessed from a
specific IP address, and I uninstalled some random services we had from older
experiences.&lt;/p&gt;

&lt;p&gt;The codebase is now available at &lt;a href=&quot;https://gitlab.com/cyberscore/cyberscore&quot;&gt;https://gitlab.com/cyberscore/cyberscore&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;ansol&quot;&gt;ANSOL&lt;/h2&gt;

&lt;p&gt;We’re almost done with migrating away from &lt;a href=&quot;https://civicrm.org&quot;&gt;CiviCRM&lt;/a&gt; to
&lt;a href=&quot;https://git.ansol.org/ansol/saucy&quot;&gt;saucy&lt;/a&gt;. Timings were right and &lt;a href=&quot;https://blog.gitea.io/2022/07/gitea-1.17.0-is-released/&quot;&gt;Gitea 1.17
was released&lt;/a&gt;,
allowing us to self-host the container image using the new Package Registry
feature. I’m still working on the data migration scripts, but we should fully
migrate in the next couple of weeks.&lt;/p&gt;

&lt;p&gt;We’re also planning a meetup/event to celebrate &lt;a href=&quot;https://www.softwarefreedomday.org/&quot;&gt;Software Freedom
Day&lt;/a&gt;. It’ll be in Porto on the 17th of
September. We haven’t publicly announced it yet, but we already have a couple
of talks lined up.&lt;/p&gt;

&lt;h2 id=&quot;personal-infrastructure&quot;&gt;Personal Infrastructure&lt;/h2&gt;

&lt;p&gt;These last two months have been full of hardware updates.&lt;/p&gt;

&lt;p&gt;I needed to be away from my desk for a few days, and my XPS 13 isn’t in great
shape (problem registering keystrokes), so I needed a replacement laptop. I
grabbed a 2015 macbook pro that I had lying around from my &lt;a href=&quot;https://lifeonmars.pt&quot;&gt;old
company&lt;/a&gt;’s inventory and took it with me without even
trying to boot it. When I sat down and tried to use it, it failed to detect the
boot partition. I tried to reinstall Mac OS using their built-in internet
recovery thing, but had no success, so I grabbed a USB flash drive, asked
someone to put a Fedora installer in there, and installed Fedora 36 on the Mac.&lt;/p&gt;

&lt;p&gt;Not everything works: Bluetooth crashes, resuming after closing the lid takes
around 10 minutes, and it doesn’t have drivers for the webcam, but it’s good
enough to work on my projects while away from home.&lt;/p&gt;

&lt;p&gt;I’m doing the live streaming and recording for &lt;a href=&quot;https://gambiconf.dev/&quot;&gt;GambiConf
EU&lt;/a&gt;, an in-person conference in September, so I ordered
some PC components for a OBS streaming build. I ended up with a mini-ITX board
with a Ryzen 5600G. I wasn’t sure what distro to use, so at first I used the
same Fedora Live CD I used on the mbp to test it out. I had to do some
shenanigans to enable every flatpak from flathub to be able to install OBS, and
I wasn’t really feeling it, so I switched to something else.&lt;/p&gt;

&lt;p&gt;The next candidate was Arch Linux. I didn’t really feel like spending the time
I thought it would take to get to a working system a DE and OBS working, so I
went with Manjaro instead. It took me a while to get used to &lt;code&gt;pacman&lt;/code&gt; and
understanding &lt;code&gt;makepkg&lt;/code&gt;’s output, but I managed to get &lt;code&gt;obs-studio-browser&lt;/code&gt;
working.&lt;/p&gt;

&lt;p&gt;After installing two new Linux distros, I was in the mood to keep trying new
things, so I grabbed the Nexus 5 that a friend had gifted me earlier this year
and installed Ubuntu Touch. The installation process was alright (I used
&lt;a href=&quot;https://devices.ubuntu-touch.io/installer/&quot;&gt;UBports installer&lt;/a&gt;), but I’m not
sure what to do with it now. The battery is practically dead, and the
FluffyChat version available is too old to support encrypted chats. I was a bit
sad that I couldn’t &lt;code&gt;apt install&lt;/code&gt; things; maybe there’s a way, but I haven’t
figured it out yet.&lt;/p&gt;

&lt;h2 id=&quot;pokmon-tcg-engine&quot;&gt;Pokémon TCG engine&lt;/h2&gt;

&lt;p&gt;In June, I started a new silly project. I was browsing Pokémon TCG Live’s
subreddit, and all the complaints about weird bugs led to me searching for
unofficial implementations. I found &lt;a href=&quot;https://tcgone.net&quot;&gt;TCG ONE&lt;/a&gt;, which is
partially free software. They have most of the cards implementation in an
Apache licensed repository, but the engine that it relies on is closed source.
I spent the following weeks working on my own engine. I didn’t go far yet, but
you can check out my progress on &lt;a href=&quot;https://github.com/hugopeixoto/tcg-engine&quot;&gt;https://github.com/hugopeixoto/tcg-engine&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The scope of this project is too big for anyone to tackle in a couple of weeks,
but I like the challenge of figuring out how to structure the code in a way
that new cards and their effects can easily be added. I don’t expect to get
this to a completed state, but I want to at least be able to play some games,
even if it’s against myself via the command line.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2022-07-28:/articles/upgrading-my-backup-servers-hard-drive.html</id>
    <title type="html">Upgrading my backup server&#39;s hard drive</title>
    <published>2022-07-28T00:00:00Z</published>
    <updated>2022-07-28T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/upgrading-my-backup-servers-hard-drive.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;My backup server was running out of space, so I replaced the 320GB hard drive with a 4TB one. I ruined the boot partition in the process, but managed to fix it.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;Earlier this year, I setup a server to host offsite backups for a bunch of
projects. The hardware is a donated &lt;a href=&quot;https://en.wikipedia.org/wiki/Acer_AspireRevo&quot;&gt;Acer AspireRevo&lt;/a&gt;, which comes with a
320GB 2.5″ hard drive. This was good enough for 6 months, but in June it hit
75% capacity, so it was time to upgrade it. I got a 4TB hard drive and delayed
making the migration until this week. It wasn’t as smooth as I had hoped.&lt;/p&gt;

&lt;h2 id=&quot;moving-the-data&quot;&gt;Moving the data&lt;/h2&gt;

&lt;p&gt;The backup server only has one SATA port, so I couldn’t just add another disk,
I had to replace it. To do that, I used another server which had a single spare
SATA port and almost a terabyte of free space on its main disk. I didn’t want
to reinstall and configure the operating system on the new drive, so the plan
was to:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;install the 320GB disk on the temporary host;&lt;/li&gt;
  &lt;li&gt;copy the whole disk, byte by byte, to a file on the temporary host’s main disk;&lt;/li&gt;
  &lt;li&gt;shutdown the host, remove the 320GB disk and install the 4TB one;&lt;/li&gt;
  &lt;li&gt;copy the image file to the 4TB disk;&lt;/li&gt;
  &lt;li&gt;extend the partitions / filesystems on the 4TB disk;&lt;/li&gt;
  &lt;li&gt;shutdown the host, move the 4TB disk to the backup server, and hope that it worked.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I expected some issues on the partition/filesystem extending step, but the
original data would still live in both the original disk and in the temporary
file, so I had some room to make mistakes there.&lt;/p&gt;

&lt;p&gt;To move the data from the 320GB disk to the temporary image file and back to
the 4TB disk, I used &lt;code&gt;dd&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;c&quot;&gt;# move data from the 320GB disk to a temporary file&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;dd &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/dev/sdb &lt;span class=&quot;nv&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/srv/backups/backup-disk-image.img &lt;span class=&quot;nv&quot;&gt;BS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1M

&lt;span class=&quot;c&quot;&gt;# shutdown the host, swap disks, boot it back up&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# move data from the temporary file to the 4TB disk&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;dd &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/srv/backups/backup-disk-image.img &lt;span class=&quot;nv&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/dev/sdb &lt;span class=&quot;nv&quot;&gt;BS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1M
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The first &lt;code&gt;dd&lt;/code&gt; took a couple of hours, and it seemed to work without any read
or write errors. It was only when I tried copying things back that I started
getting &lt;strong&gt;read&lt;/strong&gt; errors. This means that the temporary host’s main disk is
probably not in the best condition. Oops!&lt;/p&gt;

&lt;p&gt;Fortunately that disk is split into two 500GB partitions, so I was able to copy
the data by storing the temporary file in another location. To gain confidence
that I wasn’t getting any corrupt data, I did a checksum on the original disk
and the temporary image file:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;md5sum /dev/sdb
md5sum /home/potato/backup-disk-image.img
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Data moved, it was time to resize the partitions and filesystems. This is where
I hit another issue: the old disk was using the MBR partitioning scheme, which
doesn’t support disks over 2TiB. I needed to change to the GPT scheme before
resizing things.&lt;/p&gt;

&lt;p&gt;I ran &lt;code&gt;fdisk&lt;/code&gt; to check the MBR partition scheme, and &lt;code&gt;gdisk&lt;/code&gt; to convert it to GPT:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;fdisk /dev/sdb
&lt;/span&gt;[...]
Device     Boot   Start       End   Sectors   Size Id Type
/dev/sda1  *       2048    999423    997376   487M 83 Linux
/dev/sda2       1001470 625141759 624140290 297.6G  5 Extended
/dev/sda5       1001472 625141759 624140288 297.6G 83 Linux

&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;gdisk /dev/sdb
&lt;/span&gt;[...]
Found invalid GPT and valid MBR; converting MBR to GPT format
in memory. THIS OPERATION IS POTENTIALLY DESTRUCTIVE! Exit by
typing &#39;q&#39; if you don&#39;t want to convert your MBR partitions
to GPT format!
[...]
Number  Start (sector)    End (sector)  Size       Code  Name
   1            2048          999423   487.0 MiB   8300  Linux filesystem
   5         1001472       625141759   297.6 GiB   8300  Linux filesystem

Command (? for help): w
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The conversion seemed to go without any issues, so I moved on to extending the
data partition and its filesystem. Since I’m using Debian’s encrypted LVM
setup, this has some extra steps:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;cryptsetup open /dev/sdb5 luks-backups
pvresize /dev/mapper/luks-backups
pvdisplay
lvscan
lvresize -l +100%FREE /dev/backups-vg/root
mount /dev/mapper/backups--vg-root /mnt/backups
e2fsck -f /dev/mapper/backups--vg-root
resize2fs /dev/mapper/backups--vg-root
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After this, I was able to mount the data partition and everything looked fine,
so I thought I was done. After resizing the partitions, I installed the 4TB
disk on the backup server, and tried to boot it. It didn’t work.&lt;/p&gt;

&lt;h2 id=&quot;fixing-grub-and-the-boot-partitions&quot;&gt;Fixing GRUB and the boot partitions&lt;/h2&gt;

&lt;p&gt;This is where I spent most of the time. I did a bunch of things wrong, and I’m
not even sure what all of them were, and how I fixed them. All these fixes were
done using the rescue mode in debian’s installer image loaded onto a USB stick.&lt;/p&gt;

&lt;p&gt;The backup server does not support UEFI; it only supports BIOS. When using a
BIOS/GPT configuration, &lt;a href=&quot;https://wiki.archlinux.org/title/GRUB#GUID_Partition_Table_(GPT)_specific_instructions&quot;&gt;you need an additional BIOS boot
partition&lt;/a&gt;. After some failed attempts, I ended up with the
following partition scheme:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;Number  Start (sector)    End (sector)  Size       Code  Name
   1            2048            6143   2.0 MiB     EF02  BIOS boot partition
   2            6144         1001471   486.0 MiB   8300  Linux filesystem
   5         1001472      7814035455   3.6 TiB     8300  Linux filesystem
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;sda1 is a filesystemless partition with the &lt;code&gt;core.img&lt;/code&gt; contents, sda2 is an
unencrypted ext2 &lt;code&gt;/boot&lt;/code&gt; partition, and sda5 is the LUKS2/LVM container, which
contains the rest of the operating system and user data.&lt;/p&gt;

&lt;p&gt;I chose 2MiB because at some point I tried 1 MiB but got a “No GRUB drive for
/dev/sda2” during &lt;code&gt;grub-install&lt;/code&gt;. Maybe it was something else that was screwed
up, I don’t know.&lt;/p&gt;

&lt;p&gt;In this process I ended up erasing &lt;code&gt;/boot&lt;/code&gt;, so I had to rebuild it from
scratch. I formatted &lt;code&gt;/dev/sda2&lt;/code&gt; using ext2 (for no good reason other than it
was what it was before) and mounted it on &lt;code&gt;/boot&lt;/code&gt;. Running &lt;code&gt;apt reinstall
linux-image-5.18.0-2-amd64&lt;/code&gt; got me the &lt;code&gt;config-*&lt;/code&gt;, &lt;code&gt;initrd-*&lt;/code&gt; and &lt;code&gt;vmlinuz-*&lt;/code&gt;
files back. Running &lt;code&gt;grub-install /dev/sda&lt;/code&gt; did whatever to needed to do to the
BIOS boot partition and the MBR sector (&lt;a href=&quot;https://en.wikipedia.org/wiki/GNU_GRUB#Startup_on_systems_using_BIOS_firmware&quot;&gt;GRUB’s wikipedia article&lt;/a&gt;
helped a lot in understanding what was going on).&lt;/p&gt;

&lt;p&gt;Even if I hadn’t destroyed the boot, grub needed to be updated because it had
some references to the old disk’s UUID. Not clue if a &lt;code&gt;update-grub&lt;/code&gt; would be
enough, or what.&lt;/p&gt;

&lt;p&gt;At this point I got past GRUB and into Debian, but it failed to boot. This was
an easy fix: I had to edit &lt;code&gt;/etc/fstab&lt;/code&gt; to update the &lt;code&gt;/boot&lt;/code&gt; partition’s UUID.&lt;/p&gt;

&lt;p&gt;Later I realized that the &lt;code&gt;/etc/fstab&lt;/code&gt; shenanigans caused a lot of confusion
during my attempts at fixing the problem. Debian’s installer automatically
mounted &lt;code&gt;sda5&lt;/code&gt; and asked if I wanted to mount the &lt;code&gt;/boot&lt;/code&gt; partition, to which I
said yes, but it didn’t actually mount anything; it  was using the old disk’s
UUID from &lt;code&gt;/etc/fstab&lt;/code&gt; instead of the actual partition. Trusting that it had
worked, I more than once ended up generating grub files on the wrong partition.
Always check &lt;code&gt;mount&lt;/code&gt;, I guess.&lt;/p&gt;

&lt;h2 id=&quot;done&quot;&gt;Done!&lt;/h2&gt;

&lt;p&gt;Finally, it booted. I still had to add the network interface to
&lt;code&gt;/etc/network/interfaces&lt;/code&gt;, I have no idea why it worked before, but things seem
fine. Also, the case no longer closes completely, as the new disk is way
thicker than the old one and there’s not enough clearance, but I don’t even
care anymore.&lt;/p&gt;

&lt;p&gt;The daily backups are now running again, I’ve checked their integrity using
&lt;code&gt;restic check&lt;/code&gt;, and there’s tons of free space. Hopefully I don’t have to mess
with this system again soon.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;


    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2022-07-12:/articles/status-update-2022-06-30.html</id>
    <title type="html">Status update, June 2022</title>
    <published>2022-07-12T00:00:00Z</published>
    <updated>2022-07-12T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/status-update-2022-06-30.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;Cyberscore ran out of space so I had to shuffle some things around. ANSOL is replacing their CiviCRM installation with a custom made solution.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;h2 id=&quot;personal-infrastructure&quot;&gt;Personal Infrastructure&lt;/h2&gt;

&lt;p&gt;My backup server (which stores backups for cyberscore.me.uk and other websites)
is at 73% of disk capacity. It’s has a single HDD of 300GB, so I’m replacing it
with a 4TB HDD. The server only has one disk bay, so replacing it will be a bit
troublesome, but I’ll need to get it done soon.&lt;/p&gt;

&lt;h2 id=&quot;cyberscore&quot;&gt;Cyberscore&lt;/h2&gt;

&lt;p&gt;I had to fix an outage caused by a corruption on the &lt;code&gt;games&lt;/code&gt; table. We were
adding a new column to the start of the table and somehow the data didn’t shift
correctly or something, corrupting practically everything. Thankfully this
table doesn’t get updates often (only when a new game is added to the website),
so restoring it from the daily backup wasn’t a big problem.&lt;/p&gt;

&lt;p&gt;A few days prior, we had merged some untested code that broke some things, so I
took the opportunity to fix those as well. I also removed a couple of concepts
that were no longer used (splits and DLC preferences) that resulted in the
removal of ~500 lines of code.&lt;/p&gt;

&lt;p&gt;Shortly after fixing the corruption, the disk ran out of space. Now that we
don’t scale down submission proofs, they’re taking a lot more disk space than
usual. I started by deleting some old local backups to clear up some room just
to make the website work again while I figured out the next step.&lt;/p&gt;

&lt;p&gt;We’re already storing some of the old proofs on an AWS S3 bucket, so it was
time to migrate some more. Uploading things took a while, because I took the
opportunity to rename the files to their SHA256 checksum instead of database
id. By making them content-addressable, I saved around 6GB of duplicate proofs
(sometimes a single screenshot acts as proof for a bunch of charts).&lt;/p&gt;

&lt;h2 id=&quot;ansol&quot;&gt;ANSOL&lt;/h2&gt;

&lt;p&gt;Internally, we use &lt;a href=&quot;https://civicrm.org/&quot;&gt;CiviCRM&lt;/a&gt; to keep track of
memberships, payments and payment reminders. CiviCRM is a very powerful tool,
but it hasn’t been working for us. In part, it’s due to the customization it
requires and the time we’d have to spend to learn how to use it effectively,
but it’s also because we don’t want to maintain the host platform – CiviCRM
needs to be applied to a CMS (Drupal, in our case).&lt;/p&gt;

&lt;p&gt;We’ve had new membership requests and due payments left without any feedback
for weeks because it’s too troublesome to register them. This is not
acceptable, so I’m working on a replacement. I’m not sure that this will fix
our underlying issue, but I have all the required functionality working so I’ll
probably deploy it this week so we can give it a go. It’s basically a
spreadsheet with email reminders and an audit log. What could go wrong?&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2022-06-09:/articles/status-update-2022-05-31.html</id>
    <title type="html">Status update, May 2022</title>
    <published>2022-06-09T00:00:00Z</published>
    <updated>2022-06-09T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/status-update-2022-05-31.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;This month I moved away from dokku to podman, set up IndieAuth on my domain, and fixed some bugs in Veloren.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;h2 id=&quot;personal-infrastructure&quot;&gt;Personal infrastructure&lt;/h2&gt;

&lt;p&gt;I started the month by moving away from PTISP to a slightly cheaper host with
IPv6 support. That particular server was hosting a bunch of
&lt;a href=&quot;https://dokku.com&quot;&gt;dokku&lt;/a&gt; web applications, most of which could be shut down.
The only one that survived was my &lt;a href=&quot;https://miniflux.app/&quot;&gt;Miniflux&lt;/a&gt;
installation. Instead of serving it through dokku, I’m now using
&lt;a href=&quot;https://podman.io/&quot;&gt;podman&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I’ve also decided, for some reason that I don’t remember, to enable
&lt;a href=&quot;https://indieauth.net/&quot;&gt;IndieAuth&lt;/a&gt; on my domain (as an identity provider).
I implemented the necessary endpoints in a new project in Rust: &lt;a href=&quot;https://github.com/hugopeixoto/iars&quot;&gt;https://github.com/hugopeixoto/iars&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;veloren&quot;&gt;Veloren&lt;/h2&gt;

&lt;p&gt;&lt;a href=&quot;https://veloren.net/&quot;&gt;Veloren&lt;/a&gt; is a multiplayer voxel RPG written in Rust,
fully open-source and licensed under GPL 3. I was giving it a try when I
noticed a weird NPC behavior. They would get stuck for no apparent reason in
certain positions, ending up in weird clusters:&lt;/p&gt;

&lt;iframe title=&quot;Veloren path finding bug&quot; src=&quot;https://viste.pt/videos/embed/a3fb1f86-b8fd-46c1-a935-2c7b6939a41f&quot; allowfullscreen=&quot;&quot; sandbox=&quot;allow-same-origin allow-scripts allow-popups&quot; width=&quot;560&quot; height=&quot;315&quot; frameborder=&quot;0&quot; style=&quot;margin: 2em auto; display: block&quot;&gt;&lt;/iframe&gt;

&lt;p&gt;Since the game development is community driven and open source, I tried to
contribute with some patches. Instead of starting with the NPC bug, I searched
the issue tracker for something that felt easier so I could test the waters. I
found one that required adding a feature in one of the shaders, and submitted a
MR: &lt;a href=&quot;https://gitlab.com/veloren/veloren/-/merge_requests/3390&quot;&gt;Split sky shader’s twilight into dawn and dusk&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;After that was done, I started tackling the NPC bug. I was able to find a
couple of bugs and fix them: &lt;a href=&quot;https://gitlab.com/veloren/veloren/-/merge_requests/3376&quot;&gt;Fix path finding
bugs&lt;/a&gt;. Even with
these fixes applied there are still some issues. I have prepared a fix or two
for some of those, but haven’t submitted MRs yet.&lt;/p&gt;

&lt;h2 id=&quot;ansol&quot;&gt;ANSOL&lt;/h2&gt;

&lt;p&gt;Right now, the only way we have for members to pay their membership fees is via
bank transfer. We’re working on adding a couple more payment methods, so I’ve
been exploring &lt;a href=&quot;https://ifthenpay.com/&quot;&gt;ifthenpay&lt;/a&gt;’s APIs and figuring out how
to integrate it with our systems.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2022-04-27:/articles/status-update-2022-04-27.html</id>
    <title type="html">Status update, April 2022</title>
    <published>2022-04-27T00:00:00Z</published>
    <updated>2022-04-27T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/status-update-2022-04-27.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;This month I did some random work for ANSOL and restart my project of tracking my Pokémon TCG collection.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;h2 id=&quot;ansol&quot;&gt;ANSOL&lt;/h2&gt;

&lt;p&gt;I wrote the &lt;a href=&quot;https://ansol.org/noticias/2022-04-07-newsletter-2022-1-trimestre/&quot;&gt;quarterly
newsletter&lt;/a&gt;
describing our activities during Q1. This week I also helped with translating
and publishing an open letter on the universal right to install any software on
any device. You can read the &lt;a href=&quot;https://fsfe.org/activities/upcyclingandroid/openletter.en.html&quot;&gt;full letter on FSFE’s
website&lt;/a&gt;, and
check &lt;a href=&quot;https://ansol.org/noticias/2022-04-27-carta-aberta-ecodesign/&quot;&gt;ANSOL’s statement on our
website&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&quot;pokmon-things&quot;&gt;Pokémon things&lt;/h2&gt;

&lt;p&gt;I restarted the idea of tracking my Pokémon TCG collection. A few months ago I
had built a command line tool for this, but I decided to upgrade it to a web
app since most of the time it’s helpful to see the card images. The main goal
of this project is to be able to quickly register which cards I have and to
keep it up to date.&lt;/p&gt;

&lt;p&gt;The way I decided to do this was to create “bags” of cards, representing
physical spaces where my cards are stored. I have binders, decks, and bulk
boxes.&lt;/p&gt;

&lt;p&gt;Each of these bag types has their own input method, optimized for data
insertion. For example, I use 3x3 binders for each set where cards are sorted
by number (with gaps for cards that I don’t have). To register each binder
page, I press the 1-9 keys on the numpad, each representing a binder page slot,
and use Enter to move to the next page. This lets me register a full binder in
a minute or so.&lt;/p&gt;

&lt;p&gt;I didn’t want to spend much time writing backend/frontend code, so I went with
&lt;a href=&quot;https://emberjs.com&quot;&gt;EmberJS&lt;/a&gt; for the frontend, using their
&lt;a href=&quot;https://jsonapi.org&quot;&gt;json:api&lt;/a&gt; adapter to talk to a Sinatra app that uses
&lt;a href=&quot;https://github.com/mwpastore/sinja&quot;&gt;Sinja&lt;/a&gt;, an extension that helps you
quickly build json:api services. Sinja doesn’t support the latest Ruby, so I
started a branch to fix this and other limitations:
&lt;a href=&quot;https://github.com/hugopeixoto/sinja/commits/fix/ruby-3-support&quot;&gt;https://github.com/hugopeixoto/sinja/commits/fix/ruby-3-support&lt;/a&gt;. The backend
stores things in &lt;a href=&quot;https://jsonlines.org/&quot;&gt;jsonl&lt;/a&gt; files because I didn’t bother
setting up a database and it was easier to manually tweak things like this.&lt;/p&gt;

&lt;p&gt;I also took some notes of the EmberJS first-user experience, and reported a
couple of issues:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/adopted-ember-addons/ember-keyboard/pull/626&quot;&gt;ember-keyboard isKey documentation bug&lt;/a&gt;;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/ember-learn/guides-source/pull/1802&quot;&gt;Fix Ember Data call out regarding store&lt;/a&gt;, submitted by locks.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The code is available on github:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Frontend: &lt;a href=&quot;https://github.com/hugopeixoto/pokemon-collection-tracker-frontend/&quot;&gt;https://github.com/hugopeixoto/pokemon-collection-tracker-frontend/&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;Backend: &lt;a href=&quot;https://github.com/hugopeixoto/pokemon-collection-tracker-backend/&quot;&gt;https://github.com/hugopeixoto/pokemon-collection-tracker-backend/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;other-stuff&quot;&gt;Other stuff&lt;/h2&gt;

&lt;p&gt;There wasn’t much going on this month, I had to spend some time doing freelance
work. The next project will be installing some zigbee power meter things around
the office to see how much energy the computers are consuming. I also want to
finally move away from PTISP to stop wasting money there.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2022-03-24:/articles/status-update-2022-03-24.html</id>
    <title type="html">Status update, March 2022</title>
    <published>2022-03-24T00:00:00Z</published>
    <updated>2022-03-24T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/status-update-2022-03-24.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;This month I joined the board of ANSOL, (re-)learned ansible and LXD, finished converting cyberscore’s codebase, and implemented OCR in Rust in the browser using WebAssembly.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;h2 id=&quot;ansol&quot;&gt;ANSOL&lt;/h2&gt;

&lt;p&gt;I have joined the board of &lt;a href=&quot;https://ansol.org&quot;&gt;ANSOL&lt;/a&gt; for the next two years.
For the first few months I’ll be trying to improve/simplify some of our
processes to speed up new memberships and free up some of our time to work on
actual issues.&lt;/p&gt;

&lt;p&gt;One of our infrastructure servers is setup using &lt;a href=&quot;https://www.ansible.com/&quot;&gt;ansible&lt;/a&gt; and &lt;a href=&quot;https://linuxcontainers.org/lxd/&quot;&gt;LXD
containers&lt;/a&gt;, so I’ve been re-learning the former and learning the latter.
&lt;a href=&quot;https://git.ansol.org/ansol/ansible&quot;&gt;Our setup is available in our code forge&lt;/a&gt;, even though it’s
missing licensing information.&lt;/p&gt;

&lt;p&gt;Initially, this required the ansible runner to have lxd installed, and I don’t
run Ubuntu, so I had to change that. There were some connection plugins that
worked with the server’s lxd via ssh, but they were outdated. I found that they
were initially forked from a project that was based on bsd jails which is still
maintained, so I took those two and combined them to make a working &lt;code&gt;sshlxd&lt;/code&gt;
connection plugin. You can find this plugin available under an MIT license:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://git.ansol.org/ansol/ansible/src/branch/master/connection_plugins/sshlxd.py&quot;&gt;https://git.ansol.org/ansol/ansible/src/branch/master/connection_plugins/sshlxd.py&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Infrastructure-wise, We’re also thinking of switching to a different platform
to manage membership subscriptions, payments, etc. We’re currently using
&lt;a href=&quot;https://civicrm.org/&quot;&gt;CiviCRM&lt;/a&gt;, and from what I understand it’s a bit complex
to use, causing unnecessary delays in processing membership requests and
renewals, so we’re looking into alternatives.&lt;/p&gt;

&lt;p&gt;Next week, on the 30th, we’ll be hosting an online discussion / meetup on the
topic of &lt;a href=&quot;https://www.documentfreedom.org/&quot;&gt;Document Freedom&lt;/a&gt;. We’ll have a chat on the usage of open
standards, the adoption of such standards by the Portuguese government, and
other related topics. More info will be available on our website:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://ansol.org/eventos&quot;&gt;https://ansol.org/eventos&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;cyberscore&quot;&gt;Cyberscore&lt;/h2&gt;

&lt;p&gt;The process of converting the codebase to use prepared statements is finally
finished! After ~2 years of working on this, it’s finally done. We’ve covered
most of the security holes in the application except for a couple of things:
lack of CSRF protection and trusting user input in a particular form. The CSRF
stuff is probably handled by &lt;code&gt;Same-Site: Lax&lt;/code&gt;, but I need to double check that
it does what I think it does, I haven’t really caught up with how that works.&lt;/p&gt;

&lt;p&gt;Once the trusting user input issue is fixed (I’m currently working on it) I’ll
be changing all the passwords, publishing the repository, and hoping for the
best.&lt;/p&gt;

&lt;p&gt;I was thinking of setting up a temporary &lt;a href=&quot;https://en.wikipedia.org/wiki/Contributor_License_Agreement&quot;&gt;CLA&lt;/a&gt; that would allow us to
close up the source code again in the first few months if something went wrong,
but I don’t think it would do us any good, since the codebase would already be
out there anyway.&lt;/p&gt;

&lt;p&gt;Another big thing I worked on this month was the “Auto-proofer” tool, which
takes player-submitted screenshots and automatically scans the scores contained
in the image, making it easier to bulk-submit scores and reduce typos. This is
limited to a handful of games and only works with full screenshots (not photos
or cropped versions), but it’s been used a lot already. The scanning
functionality is implemented in &lt;a href=&quot;https://hugopeixoto.net/articles/rust-wasm-ocr-experiments.html&quot;&gt;Rust on the browser using WASM, and I’ve
written an article detailing how that works&lt;/a&gt;. The repository with the
scanning code is available under the AGPL, so check it out as well:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://gitlab.com/cyberscore/auto-proofer&quot;&gt;https://gitlab.com/cyberscore/auto-proofer&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;We also added a new scoreboard this month, the &lt;a href=&quot;https://cyberscore.me.uk/scoreboards/incremental&quot;&gt;Experience board&lt;/a&gt;. It
tracks how hard you grind in certain games. Scores like “how many kilometers
did you walk in Pokémon Go?” are rewarded.&lt;/p&gt;

&lt;h2 id=&quot;other-stuff&quot;&gt;Other stuff&lt;/h2&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/alumniei/mentorados&quot;&gt;AlumniEI’s mentorship program&lt;/a&gt; hasn’t
had any progress in a while, so I suggested retiring it. The University of
Porto has released a platform that seems to include mentorship as one of its
goals, so it feels like a good time to shutdown this initiative.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;


    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2022-03-10:/articles/rust-wasm-ocr-experiments.html</id>
    <title type="html">Rust WebAssembly OCR experiments</title>
    <published>2022-03-10T00:00:00Z</published>
    <updated>2022-03-10T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/rust-wasm-ocr-experiments.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;After rewriting cyberscore, I wanted to submit some scores myself. Instead of doing it manually, I implemented a screenshot reader in rust directly integrated onto the website using WebAssembly. This reduced the number of mistakes people made while submitting these scores.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;

&lt;p&gt;After rewriting Cyberscore, I wanted to actually submit some scores
to the website. The latest game I’ve been playing is &lt;a href=&quot;https://en.wikipedia.org/wiki/Pok%C3%A9mon_Legends:_Arceus&quot;&gt;Pokémon Legends:
Arceus&lt;/a&gt;, which has around &lt;a href=&quot;https://cyberscore.me.uk/game/2874&quot;&gt;3000 score charts on Cyberscore&lt;/a&gt;. I
didn’t feel like submitting that many records manually, so I started working on
a tool to automate it instead.&lt;/p&gt;

&lt;p&gt;Most of these scores come from the pokédex. Each pokémon species has a pokédex
entry with two pages. The first page shows some generic information like name,
type, preferred foods, and also showing the minimum and maximum weights and
heights of every specimen you caught:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;stantler-info-page.jpg&quot; alt=&quot;Screenshot of Stantler&#39;s pokédex entry, on the general information page, showing a picture of the species, a weight range (116.7 lbs. - 189.8 lbs.), a height range (3&#39;10&amp;quot; - 5&#39;), preferred foods (Springy Mushrooms, Hearty Grains, and Plump Beans), and which items it carries (Pep-Up Plant and Vivichoke)&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The second page shows the research tasks associated with that species and the
research level you’ve reached:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;drifloon-researchs-page.jpg&quot; alt=&quot;Screenshot of Drifloon&#39;s pokédex entry, on the research tasks page, showing a table with 8 research tasks: Number caught (25), Number caught at night (25), Number defeated (48), Number you&#39;ve defeated with Ghost-type moves (25), Times you&#39;ve seen it use Confusion (88), Times you&#39;ve seen it use Hypnosis (40), Number you&#39;ve evolved (1), Investigated whether Drifloon truly does play with kids (1)&quot; /&gt;&lt;/p&gt;

&lt;p&gt;In these two screenshots alone, there are at least 12 scores that can be
submitted to Cyberscore: weight and height ranges (4), research level (1), and
research tasks (7, the last one is a game quest and doesn’t count). Cyberscore
also allows you to upload screenshots or videos as proof of your high scores,
so detecting the scores from the screenshots and automatically submitting both
sounded like a good idea.&lt;/p&gt;

&lt;p&gt;There’s already a &lt;a href=&quot;https://github.com/KYU49/PSnapOCR&quot;&gt;user-contributed tool for New Pokémon Snap&lt;/a&gt; that,
using Python and OpenCV, takes a bunch of screenshots and generates a CSV with
the scores. Lots of folks use it, but I wanted something integrated directly on
the website to avoid the step of having to install something locally; just
upload all the screenshots, confirm that the detection had no errors, and
you’re done.&lt;/p&gt;

&lt;p&gt;This post will go over two things: the process of extracting the scores from
the JPG in rust, and the process of embedding it in Cyberscore’s frontend.&lt;/p&gt;

&lt;p&gt;Link to the source code and a demo video at the end of the post.&lt;/p&gt;

&lt;h2 id=&quot;detecting-scores-from-screenshots&quot;&gt;Detecting scores from screenshots&lt;/h2&gt;

&lt;p&gt;Detecting scores was not that hard: since we’re handling game screenshots, the
information is always in the same spots and with little pixel variance. The
first step was to figure out what I had to detect. The first thing was to find
out which of the five pokemon in the list was the selected one and read its
pokédex number. Then, I had to know which pokédex page was being shown (there
are three possible pages) and read the right numbers depending on the page.
This gives us the following rectangles to work with:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;drifloon-researchs-page-highlighted.jpg&quot; alt=&quot;Screenshot of Drifloon&#39;s pokédex entry, on the research tasks page, with the pokédex number of all five visible Pokémon highlighted. The selected pokémon number has a white-ish background, while the other ones are different shades of brown. The research tasks scores are also highlighted.&quot; /&gt;&lt;/p&gt;

&lt;p&gt;To figure out which of the five pokémon species is selected, I calculated the
average color of the top rows of each of those five rectangles on the selection
list and found the one closest to white. I averaged each RGB channel
independently and calculated their distance to 255. I could probably have
calculated the average brightness and used that instead as well, there are many
ways to do this particular operation in this case, I just picked whatever
worked first.&lt;/p&gt;

&lt;p&gt;The next step was to detect the actual pokédex number. I started with the usual
thresholding operation, which looks like this:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;37-threshold.png&quot; alt=&quot;The rectangle of the above screenshot containing the digits &amp;quot;037&amp;quot;, next to a black and white version of it (threshold of 128)&quot; /&gt;&lt;/p&gt;

&lt;p&gt;To find the individual digits in the black and white version, I detected all
groups of connected pixels using a &lt;a href=&quot;https://en.wikipedia.org/wiki/Disjoint-set_data_structure&quot;&gt;Disjoint-set data structure&lt;/a&gt;. For
each digit, this would give me a set of pixels (with their positions
arbitrarily anchored of the top-left corner of its own bounding box). To detect
which digit each set represents, I started by grabbing a bunch of samples for
each digit from some screenshots and built a PNG with them:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;training-template.png&quot; alt=&quot;An image with white-ish background showing ten rows, one for each digit, each filled with 2 to 5 sample clippings of the respective digit&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Applying the same thresholding and connected pixels detection to this template,
I could find the one that more closely matched the digit being detected using
&lt;a href=&quot;https://en.wikipedia.org/wiki/Template_matching#Template-based_approach&quot;&gt;Template Matching&lt;/a&gt;. In short, this algorithm goes through each pixel
inside the bounding box of both the template and the digit, finds how many
pixels match, and returns the best candidate. Ordering the digits by
x-coordinate would give me &lt;code&gt;[0, 3, 7]&lt;/code&gt;, which is easily converted to &lt;code&gt;37&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;I applied the same technique to the other pokédex page. It needed some extra
code because sometimes the weights and heights only contain a single number
instead of a range, but using some regular expressions on the detected text
solved the problem.&lt;/p&gt;

&lt;p&gt;To tell which pokédex page is selected (general info or research tasks), I
detected where the &lt;code&gt;A&lt;/code&gt; in the top left tabs is located using template matching
in both possible locations.&lt;/p&gt;

&lt;p&gt;The end result of this process was a library with the following interface
(omitting a few attributes for clarity):&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;pub&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PokemonLegendsArceusOCR&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;impl&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PokemonLegendsArceusOCR&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;pub&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;DynamicImage&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;DynamicImage&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;DynamicImage&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;pub&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;selected_page&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;proof&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;DynamicImage&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Option&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PokedexPage&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;pub&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;research_tasks&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;proof&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;DynamicImage&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Option&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ResearchTaskProof&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;pub&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;info&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;proof&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;DynamicImage&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Option&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;InfoProof&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;pub&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;enum&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PokedexPage&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Info&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;ResearchTasks&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;pub&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ResearchTaskProof&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;pub&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;usize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;pub&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tasks&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;u32&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;pub&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;InfoProof&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;pub&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;usize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;pub&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;weight&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Weight&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;pub&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;height&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Height&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;pub&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Weight&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;pub&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;min&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;u32&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;pub&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;max&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;u32&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;pub&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Height&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;pub&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;min&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;u32&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;pub&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;max&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;u32&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;All those images in the constructor are the different classification templates
used in each function.&lt;/p&gt;

&lt;h2 id=&quot;compiling-it-to-webassembly&quot;&gt;Compiling it to WebAssembly&lt;/h2&gt;

&lt;p&gt;To get started, I followed &lt;a href=&quot;https://developer.mozilla.org/en-US/docs/WebAssembly/Rust_to_wasm&quot;&gt;MDN’s guide on “Compiling Rust to
WebAssembly”&lt;/a&gt; and installed &lt;code&gt;wasm-pack&lt;/code&gt;, and adapting &lt;code&gt;Cargo.toml&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-toml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;nn&quot;&gt;[lib]&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;crate-type&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;lib&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;cdylib&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# added cdylib&lt;/span&gt;

&lt;span class=&quot;nn&quot;&gt;[dependencies]&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;image&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;0.24.1&quot;&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# added these three libraries&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;wasm-bindgen&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;0.2&quot;&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;js-sys&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;0.3.56&quot;&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;console_error_panic_hook&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;0.1.7&quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;To get my library working in WebAssembly, I started by simplifying the API to a
single function that takes a array of bytes that represent the proof jpg and
returns whatever it detects. To make things easier, the training images were
embedded in the program using the &lt;code&gt;include_bytes!&lt;/code&gt; macro.&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;nd&quot;&gt;#[wasm_bindgen]&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;pub&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;ocr_pla_dex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;proof&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;u8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Proof&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;nd&quot;&gt;#[wasm_bindgen]&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;pub&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Proof&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nd&quot;&gt;#[wasm_bindgen(getter_with_clone)]&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;pub&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;research&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Option&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ResearchTaskProof&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;pub&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;info&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Option&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;InfoProof&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;nd&quot;&gt;#[wasm_bindgen]&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;pub&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ResearchTaskProof&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;pub&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;usize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;nd&quot;&gt;#[wasm_bindgen(getter_with_clone)]&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;pub&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tasks&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;u32&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Structs with &lt;code&gt;wasm_bindgen&lt;/code&gt; automatically generate getters and setters for
every public member, but for that to work those members must implement &lt;code&gt;Copy&lt;/code&gt;.
Since &lt;code&gt;Vec&lt;/code&gt; doesn’t implement that trait, I needed to use &lt;code&gt;getter_with_clone&lt;/code&gt;
clones the object instead. Thanks to its &lt;code&gt;Vec&lt;/code&gt; member, &lt;code&gt;ResearchTaskProof&lt;/code&gt; is
also not &lt;code&gt;Copy&lt;/code&gt;able, so I had to do the same to &lt;code&gt;pub research&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;With this, I was able to run &lt;code&gt;wasm-pack build --target web&lt;/code&gt; and get a bunch of
files in &lt;code&gt;pkg/&lt;/code&gt;, including &lt;code&gt;pla_ocr.js&lt;/code&gt; and &lt;code&gt;pla_ocr_bg.wasm&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-html highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;script &lt;/span&gt;&lt;span class=&quot;na&quot;&gt;type=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;module&quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;init&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;ocr_pla_dex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/js/ocr-pla/pla_ocr.js&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;nx&quot;&gt;init&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

  &lt;span class=&quot;nb&quot;&gt;window&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;ocr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;ocr_pla_dex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;/script&amp;gt;&lt;/span&gt;

&lt;span class=&quot;nt&quot;&gt;&amp;lt;script &lt;/span&gt;&lt;span class=&quot;na&quot;&gt;type=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;text/javascript&quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;document&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;querySelector&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;#proof-form&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;addEventListener&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&#39;&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;submit&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;ev&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;file&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;document&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;getElementById&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&#39;&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;proof-form-field&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;files&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;buff&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;await&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;arrayBuffer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;bytes&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Uint8Array&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;buff&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;result&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;window&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;ocr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;bytes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;});&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;/script&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The &lt;code&gt;wasm&lt;/code&gt; file is loaded by &lt;code&gt;pla_ocr.js&lt;/code&gt; using a relative URL, but it can be
passed to &lt;code&gt;init&lt;/code&gt; if the location is different.&lt;/p&gt;

&lt;p&gt;When I first ran the code in the browser, it didn’t work. I was getting a
“Unreachable code” exception in the console. With &lt;code&gt;console_error_panic_hook&lt;/code&gt;
enabled, I was able to see the actual exception: the &lt;code&gt;image&lt;/code&gt; crate was trying
to use threads to decode the screenshot jpeg. This feature seems to be enabled
by default, so I had to change &lt;code&gt;Cargo.toml&lt;/code&gt; to disable the default features and
only pull in the features I thought were necessary:&lt;/p&gt;

&lt;div class=&quot;language-toml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;nn&quot;&gt;[dependencies]&lt;/span&gt;
&lt;span class=&quot;nn&quot;&gt;image&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;py&quot;&gt;version&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;0.24.1&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;py&quot;&gt;default-features&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;py&quot;&gt;features&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;gif&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;jpeg&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;png&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;webp&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;farbfeld&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Doing this solved the problem, and things started working. After some tinkering
with Cyberscore’s code, I managed to fully integrate the proof OCR library into
the website and everything is working fine. Here’s a video of the final result:&lt;/p&gt;

&lt;video controls=&quot;&quot;&gt;
  &lt;source src=&quot;pla-ocr.mp4&quot; type=&quot;video/mp4&quot; /&gt;
&lt;/video&gt;

&lt;h2 id=&quot;conclusions&quot;&gt;Conclusions&lt;/h2&gt;

&lt;p&gt;The hardest part of this was probably all the extra javascript to match the OCR
results to cyberscore’s charts. There are some edge cases that I had to handle,
like not submitting scores that are zero, or not submitting scores that are
worse than what was previously submitted. The next step would be to find a way
to generalize this to support multiple games.&lt;/p&gt;

&lt;p&gt;Other players started using this tool and apart from making it way easier to
submit scores, it reduced the number of mistakes they made during data entry.&lt;/p&gt;

&lt;p&gt;The source code for the rust portion of this project is available at
&lt;a href=&quot;https://gitlab.com/cyberscore/auto-proofer&quot;&gt;https://gitlab.com/cyberscore/auto-proofer&lt;/a&gt;. The Javascript part is not
available, since Cyberscore is not free software yet, but the most relevant
bits are described above.&lt;/p&gt;

&lt;p&gt;If you’re interested in computer vision stuff, check out my &lt;a href=&quot;https://hugopeixoto.net/articles/rustconf2021-video-available.html&quot;&gt;Rustconf 2021 talk
on Identifying Pokémon Cards&lt;/a&gt;. It covers a very different use case
but it goes through some basics of image processing and common algorithms of
the field.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;


    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2022-02-15:/articles/status-update-2022-02-15.html</id>
    <title type="html">Status update, February 2022</title>
    <published>2022-02-15T00:00:00Z</published>
    <updated>2022-02-15T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/status-update-2022-02-15.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;Time for another monthly update. I’m moving these to the middle of the month.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;Time for another monthly update. I’m moving these to the middle of the month.&lt;/p&gt;

&lt;h2 id=&quot;ansol&quot;&gt;ANSOL&lt;/h2&gt;

&lt;p&gt;This was a busy month for &lt;a href=&quot;https://ansol.org&quot;&gt;ANSOL&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I took the lead in writing &lt;a href=&quot;https://ansol.org/noticias/2022-01-19-software-livre-nos-programas-eleitorais-2022/&quot;&gt;an analysis of the parties’ programmes for the 2022
Portuguese legislative election&lt;/a&gt;, focusing on free software and
digital rights issues. This got some attention and media coverage (&lt;a href=&quot;https://tek.sapo.pt/noticias/negocios/artigos/o-que-dizem-os-programas-dos-partidos-sobre-software-livre-e-direitos-digitais&quot;&gt;SAPO
Tek&lt;/a&gt;, &lt;a href=&quot;https://www.pcguia.pt/2022/01/software-open-source-nos-programas-dos-partidos-para-as-legislativas-2022-ansol-elogia-ideias-da-il-e-do-pan/&quot;&gt;PCGuia&lt;/a&gt;, and &lt;a href=&quot;https://www.tsf.pt/programa/mundo-digital/emissao/a-importancia-do-software-livre-nas-proximas-eleicoes-14527370.html&quot;&gt;TSF&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;I also worked on our &lt;a href=&quot;https://ansol.org/noticias/2022-02-14-eu-adoro-software-livre-2022/&quot;&gt;yearly “I love free software” message&lt;/a&gt;, making a
quick round-up of free software technologies that we used in the last year.&lt;/p&gt;

&lt;p&gt;We migrated our code forge from Phabricator to Gitea a couple of days ago, so I
spent some time configuring ANSOL’s account and mirroring some repositories.
You can check it out on &lt;a href=&quot;https://git.ansol.org&quot;&gt;https://git.ansol.org&lt;/a&gt;. We’re still using github and
gitlab as the main repositories, but that will probably change with time.&lt;/p&gt;

&lt;p&gt;Finally, I recovered our mastodon account
&lt;a href=&quot;https://floss.social/@ansol&quot;&gt;@ansol@floss.social&lt;/a&gt;. This was using an email
account that no longer exists, so I had to contact the administration team, but
then I couldn’t receive their email replies… it took some time, but they were
super helpful and we’re going to try to use it again now.&lt;/p&gt;

&lt;h2 id=&quot;cyberscore&quot;&gt;Cyberscore&lt;/h2&gt;

&lt;p&gt;I’ve been going through &lt;a href=&quot;https://cyberscore.me.uk&quot;&gt;Cyberscore&lt;/a&gt;’s codebase and converting it
file by file. On my last update, there were 12k lines of code to go through.
Today, that number is down to 1.5kloc! When this reaches zero, hopefully we’ll
be able to make the code public. I can’t wait to share with the world the
mini-framework I wrote.&lt;/p&gt;

&lt;p&gt;Our server ran out of space this month. Players submit image proofs of their
highscores and we store them all, so this tends to take up a lot of disk space.
We had some redundant local backups as a result of the april 2021 hack, so I
moved those off-site and deleted them. This gave us ~15gb of breathing room,
which should be enough for at least a few months. Another thing that’s taking
up a ton of space is &lt;code&gt;/var/lib/mysql&lt;/code&gt;: 26Gb. Our database isn’t that big, so
there’s something weird going on. I think I’ll need to tweak the binlog
expiration period.&lt;/p&gt;

&lt;h2 id=&quot;other-stuff&quot;&gt;Other stuff&lt;/h2&gt;

&lt;p&gt;I released a podcast episode this month: &lt;a href=&quot;https://conversas.porto.codes/episodes/nada-funciona-nunca&quot;&gt;Ep 40: Nada funciona
nunca&lt;/a&gt;. We have
another one in the editing queue, but I didn’t have much time this month.&lt;/p&gt;

&lt;p&gt;I virtually attended &lt;a href=&quot;https://fosdem.org&quot;&gt;FOSDEM&lt;/a&gt; and the &lt;a href=&quot;https://summit.openforumeurope.org/&quot;&gt;EU Open Source
Policy Summit&lt;/a&gt;. During FOSDEM I mostly
focused on the Matrix and Legal and Policy devrooms. Videos of both events are
available.&lt;/p&gt;

&lt;p&gt;I was trying to read &lt;a href=&quot;https://hermannschule.de/hermannpost.html&quot;&gt;this german page about how a school adopted and adapted a
matrix client to their needs&lt;/a&gt;, when
I decided to look for an alternative to google translate. I found something
that’s self-hostable, &lt;a href=&quot;https://libretranslate.com/&quot;&gt;LibreTranslate&lt;/a&gt;. I tried
self-hosting this on my PTisp VPS, and it was terribly slow. I tried again in a
5 USD digital ocean VPS, and it was way faster. I really need to switch to a
different provider. I started working on a &lt;a href=&quot;https://github.com/hugopeixoto/libretranslate-firefox&quot;&gt;browser extension for
firefox&lt;/a&gt; but with such a slow instance I was having a hard time
iterating, so I paused work on it until I get a better server.&lt;/p&gt;

&lt;p&gt;Finally, I tried to convince some folks to host their meetup on free software
solutions instead of zoom, but had some trouble finding a setup that felt good
enough to replace it. I tried jitsi, owncast, OBS, VDO.ninja, and BigBlueButton
in several combinations. I’ll need to give it another go.&lt;/p&gt;

&lt;h2 id=&quot;up-next&quot;&gt;Up next&lt;/h2&gt;

&lt;p&gt;I’ll be doing some consulting work for the next couple of weeks, working on
upgrading up some Terraform repositories and some postgres clusters.&lt;/p&gt;

&lt;p&gt;Other than that, I want to finish the cyberscore conversion. It’s so close! As
soon as I finish convering all the missing files, I still need to go through
every file again for a quick second pass, ensuring that we have the proper
authorization in each endpoint and double-checking for SQL injections. Then,
we’ll have to change all our server passwords (since some of them were commited
to the git repository when I started). Finally, we’ll have to pick a license
and release the software.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;


    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2022-01-07:/articles/status-update-2022-01-07.html</id>
    <title type="html">Status update for January 2022 (and the last two months)</title>
    <published>2022-01-07T00:00:00Z</published>
    <updated>2022-01-07T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/status-update-2022-01-07.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;Happy new year everyone! I skipped a couple of monthly updates, so this one will be a bit longer than usual. I was having trouble finding the motivation to keep writing these updates. Anyway, here’s what I’ve been doing for the past couple of months.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;Happy new year everyone! I skipped a couple of monthly updates, so this one
will be a bit longer than usual. I couldn’t find the motivation to keep writing
these updates since I felt like I had nothing to show, and I also felt like I
had the responsibility to spend more time working on the freelancing gig I had
taken.&lt;/p&gt;

&lt;p&gt;After the new year when I did the last major task that I was contracted to do,
everything unblocked. Go figure. Anyway, here’s what I’ve been doing for the
past couple of months.&lt;/p&gt;

&lt;h2 id=&quot;november&quot;&gt;November&lt;/h2&gt;

&lt;p&gt;The new &lt;a href=&quot;https://ansol.org&quot;&gt;ANSOL&lt;/a&gt; website was released. Converting the drupal
database to markdown wasn’t hard compared to rewriting the whole theme. I’m
still tweaking some things here and there, but it’s mostly functional.
The &lt;a href=&quot;https://gitlab.com/ansol/web-ansol.org&quot;&gt;website’s code is available on GitLab&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I accidentally sat on my phone with my keys in the back pocket and its screen
died. Instead of getting it fixed or buying a new one, I rolled back to my
previous Moto G3. I didn’t bother logging in to the play store, and I don’t
even have email access right now. Through F-Droid, I installed
&lt;a href=&quot;https://element.io/&quot;&gt;Element&lt;/a&gt;, Firefox and VLC. Since I’m practically at home
all the time it hasn’t made much of a difference, but I do miss not having a
couple of homebanking applications. Unfortunately those are all closed source.&lt;/p&gt;

&lt;p&gt;Completely unrelated, I spent most of the month going down a giant rabbit hole
of understanding android applications and how to reverse engineer their APIs. I
didn’t get very far in my initial goal, but I ended up writing a partial
&lt;a href=&quot;https://github.com/hugopeixoto/rjava/&quot;&gt;Dalvik interpreter/emulator in ruby&lt;/a&gt;.
This isn’t super useful, and my application was stuck in an infinite loop so
it’s definitely buggy, but it was kind of interesting to learn.&lt;/p&gt;

&lt;p&gt;We released three episodes of the &lt;a href=&quot;https://conversasemcodigo.pt&quot;&gt;Conversas em
Código&lt;/a&gt; podcast: &lt;a href=&quot;https://conversas.porto.codes/episodes/android-reversing&quot;&gt;one about reverse engineering
Android apps&lt;/a&gt;, &lt;a href=&quot;https://conversas.porto.codes/episodes/matrix-slack-e-outras-chatices&quot;&gt;one
about
Matrix&lt;/a&gt;,
&lt;a href=&quot;https://conversas.porto.codes/episodes/contribuicoes-open-source-e-peertube&quot;&gt;one about
PeerTube&lt;/a&gt;.
I still have one unreleased episode that will probably go out this month.&lt;/p&gt;

&lt;p&gt;I did some client work deploying a new version of a third party application,
where the old version was on a windows virtual machine. Thankfully I was able
to deploy the new version without touching the old one.&lt;/p&gt;

&lt;h2 id=&quot;december-tasks&quot;&gt;December tasks&lt;/h2&gt;

&lt;p&gt;During December I focused mostly on &lt;a href=&quot;https://cyberscore.me.uk&quot;&gt;Cyberscore&lt;/a&gt;. I’m
continuing to go through each php file in &lt;code&gt;public/&lt;/code&gt; and converting them to a
router based file in &lt;code&gt;src/&lt;/code&gt;, taking the time to go through the code and remove
any potential SQL and XSS injections. I covered roughly 7000 lines of code this
month, with 12000 lines to go. The low hanging fruit is mostly gone, so now I’m
focusing on large and complex files.&lt;/p&gt;

&lt;p&gt;I did some client work as well, upgrading some ruby applications, including
going from ruby 2.6 to 3.x, from ruby 5.x to 6.x, and bumping every gem.&lt;/p&gt;

&lt;p&gt;December is the month of &lt;a href=&quot;https://adventofcode.com/&quot;&gt;Advent of Code&lt;/a&gt;. I was way
from the computer at the start of the month but managed to catch up and do the
challenges daily until the 21st. I did the remaining four days on the last
hours of day 25. I went with rust again, and uploaded &lt;a href=&quot;https://github.com/hugopeixoto/aoc2021&quot;&gt;my solutions onto a git
repository&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&quot;january-things&quot;&gt;January things&lt;/h2&gt;

&lt;p&gt;The new year only started about a week ago, but I already got a bunch of stuff
done.&lt;/p&gt;

&lt;p&gt;I rewrote &lt;a href=&quot;https://github.com/hugopeixoto/untracked&quot;&gt;&lt;code&gt;untracked&lt;/code&gt;&lt;/a&gt; in rust. The
tool had a couple of bugs that I wanted fixed and I didn’t feel like dealing
with C. The codebase ended up practically the same size, but rust enums and
pattern matching made things a bit easier.&lt;/p&gt;

&lt;p&gt;I published &lt;a href=&quot;https://github.com/hugopeixoto/mknsd&quot;&gt;&lt;code&gt;mknsd&lt;/code&gt;&lt;/a&gt;, a tool to generate
&lt;code&gt;nsd&lt;/code&gt; configuration and zone files. It uses its own syntax to define zones,
since I don’t need all the bells and whistles of a regular zone file. This tool
was in my private &lt;code&gt;infrastructure.git&lt;/code&gt; repository, next to my actual zone
definitions, but extracting it allows me to publish it.&lt;/p&gt;

&lt;p&gt;I cleaned up the &lt;a href=&quot;https://github.com/hugopeixoto/static-websites&quot;&gt;&lt;code&gt;static-websites&lt;/code&gt;
tool&lt;/a&gt; output a bit. It now silences
each step’s output unless that step fails.&lt;/p&gt;

&lt;p&gt;I &lt;strong&gt;finally&lt;/strong&gt; automated the backup process for
&lt;a href=&quot;https://cyberscore.me.uk&quot;&gt;Cyberscore&lt;/a&gt;, &lt;a href=&quot;https://fzerocentral.org&quot;&gt;F-Zero
Central&lt;/a&gt;, &lt;a href=&quot;https://viste.pt&quot;&gt;viste.pt&lt;/a&gt; and my
&lt;a href=&quot;https://miniflux.app/&quot;&gt;miniflux&lt;/a&gt; installation. I was backing up some of those
manually once a month or so, and the other ones not at all. I’ve setup
&lt;a href=&quot;https://restic.net/&quot;&gt;&lt;code&gt;restic&lt;/code&gt;&lt;/a&gt; using an append only rest backend in a new
debian machine I setup in my bedroom. The next step is to create some redundancy
by shipping those snapshots somewhere else as well.&lt;/p&gt;

&lt;p&gt;I had an AWS account draining my wallet for no good reason, with an S3 bucket
(~80gb) and an old route53 zone for hugopeixoto.net (before I started
self-hosting my nameservers). The zone and the bucket are now gone. The only
resource left is a set of credentials for AWS SES that I use to send emails in
one of my projects, but that shouldn’t cost me any money, since the project is
practically dead.&lt;/p&gt;

&lt;p&gt;I bought &lt;a href=&quot;https://conversasemcodigo.pt&quot;&gt;conversasemcodigo.pt&lt;/a&gt; a couple of
months ago but never bothered to set it up. It’s now redirecting to
&lt;a href=&quot;https://conversas.porto.codes&quot;&gt;conversas.porto.codes&lt;/a&gt;. One day, maybe, I’ll
start self-hosting the podcast and ditch simplecast. I’ll need to figure out
how to analytics first.&lt;/p&gt;

&lt;p&gt;I did a small gig where I upgraded a Heroku application that was using a
deprecated stack (&lt;code&gt;heroku-16&lt;/code&gt; to &lt;code&gt;heroku-20&lt;/code&gt;). This required bumping node from
8 to 16, upgrading some packages and rewriting the integration with google
spreadsheets, as their V3 API was also shutdown in the meantime.&lt;/p&gt;

&lt;p&gt;Also did some client work upgrading a bunch of RDS databases from postgresql 9
to postgresql 13 using terraform.&lt;/p&gt;

&lt;p&gt;A friend kindly donated a bunch of hardware. I got an &lt;a href=&quot;https://en.wikipedia.org/wiki/Acer_AspireRevo&quot;&gt;Acer
AspireRevo&lt;/a&gt; that became my
backup server, and a couple of android smartphones that I’ll use to play with
installing either a free version of Android and/or a Linux distribution. Thank
you!&lt;/p&gt;

&lt;h2 id=&quot;up-next&quot;&gt;Up next&lt;/h2&gt;

&lt;p&gt;These next couple of months are going to be full of ANSOL tasks that need to be
done: we’re making some changes to the association rules to make them a bit
more lax and practical; we’re analysing the parties’ programmes for the &lt;a href=&quot;https://pt.wikipedia.org/wiki/Elei%C3%A7%C3%B5es_legislativas_portuguesas_de_2022&quot;&gt;2022
Portuguese legislative
election&lt;/a&gt;
to see how they relate to free software; and work on celebratory messages for a
couple of “International Days” related to free software. &lt;a href=&quot;https://ansol.org/inscricao/&quot;&gt;Help is
appreciated&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;In February I’ll be virtually attending &lt;a href=&quot;https://fosdem.org/&quot;&gt;FOSDEM&lt;/a&gt;!
I’m looking forward to attend, the whole matrix experience was interesting. It
was easier for me to socialize than when I attended in-person.&lt;/p&gt;

&lt;p&gt;I also want to at least convert a couple more Cyberscore modules this month.
There are still 12kloc to convert, and it would be nice if I could hit the
10kloc mark this month.&lt;/p&gt;

&lt;p&gt;I’d also like to setup some redundancy for the backup server. I already have a
machine in mind, I need to find out how to synchronize them. I’m thinking maybe
rsync+btrfs snapshots. Backups are done daily at a fixed time, so for most of
the day the backup repository will be stable.&lt;/p&gt;

&lt;p&gt;In the self-hosting experiments department, there are a bunch of things that
I’d like to play with: &lt;a href=&quot;https://jellyfin.org/&quot;&gt;give Jellyfin a try&lt;/a&gt;, replace my
AWS SES usage with something like &lt;a href=&quot;https://maddy.email/&quot;&gt;maddy&lt;/a&gt;, and find a
good email client. I’m also thinking of finding an alternative portuguese VPS
provider, since the one I’m using is too expensive for the specs and it doesn’t
support IPv6.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2021-11-02:/articles/status-update-2021-10-31.html</id>
    <title type="html">Status update, October 2021</title>
    <published>2021-11-02T00:00:00Z</published>
    <updated>2021-11-02T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/status-update-2021-10-31.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;I spent most of October focused on ANSOL projects. I also found some time to play around with PeerTube and setup an instance focused on portuguese content: &lt;a href=&quot;https://viste.pt&quot;&gt;https://viste.pt&lt;/a&gt;&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;I spent most of October focused on ANSOL projects. I also found some time to
play around with PeerTube and setup an instance focused on portuguese content:
&lt;a href=&quot;https://viste.pt&quot;&gt;https://viste.pt&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;october-accomplishments&quot;&gt;October accomplishments&lt;/h2&gt;

&lt;p&gt;I edited and published four episodes of &lt;a href=&quot;https://conversas.porto.codes&quot;&gt;Conversas em
Código&lt;/a&gt; this month (one per week). Let’s see if
I can keep up the pace during November.&lt;/p&gt;

&lt;p&gt;The D3 project was put on hold, thanks to an issue with a third party.&lt;/p&gt;

&lt;p&gt;I’m practically finished with &lt;a href=&quot;https://ansol.org&quot;&gt;ANSOL&lt;/a&gt;’s website rewrite. I started out with the
&lt;a href=&quot;https://themes.gohugo.io/themes/hugo-academic/&quot;&gt;Academic theme&lt;/a&gt; but tweaked it
up to a point where it’s basically its own theme right now. Now I need to get
this reviewed, migrate some content that was created on Drupal during October,
and ship it.&lt;/p&gt;

&lt;p&gt;Thanks to a Hacktoberfest event organized by &lt;a href=&quot;https://pedropintosilva.com/&quot;&gt;Pedro Pinto
Silva&lt;/a&gt;, I made &lt;a href=&quot;https://github.com/CollaboraOnline/online/pulls?q=author%3Ahugopeixoto&quot;&gt;a few
contributions&lt;/a&gt;
to &lt;a href=&quot;https://collaboraonline.github.io/&quot;&gt;Collabora Online&lt;/a&gt;. It was my first time
working with this codebase, but their “Easy Hacks” issues were a good starting
point. The team was super helpful and responsive.&lt;/p&gt;

&lt;p&gt;I edited and published &lt;a href=&quot;https://ansol.org/20anos&quot;&gt;ANSOL’s 20th year anniversary celebration
event&lt;/a&gt; presentations. We were having some trouble
uploading them to &lt;a href=&quot;https://archive.org&quot;&gt;archive.org&lt;/a&gt;, so I decided to setup a
personal &lt;a href=&quot;https://joinpeertube.org/&quot;&gt;PeerTube&lt;/a&gt; instance. The archive.org
problems were fixed, so we didn’t use this instance, but I decided to keep it
anyway. I’m planning on mirroring the videos from &lt;a href=&quot;https://porto.codes&quot;&gt;Porto
Codes&lt;/a&gt; and maybe even upload the audio from &lt;a href=&quot;https://conversas.porto.codes&quot;&gt;Conversas em
Código&lt;/a&gt;. I also contributed some pt-PT translations.&lt;/p&gt;

&lt;h2 id=&quot;vistept&quot;&gt;Viste.pt&lt;/h2&gt;

&lt;p&gt;The PeerTube instance is available at &lt;a href=&quot;https://viste.pt&quot;&gt;https://viste.pt&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I’m still not sure what I’ll do with this instance, but it’ll be focused on
portuguese content. So if you want to start publishing some videos and want to
avoid companies like YouTube, send me a message and we can discuss hosting them
here.&lt;/p&gt;

&lt;h2 id=&quot;november-plans&quot;&gt;November plans&lt;/h2&gt;

&lt;p&gt;I want to keep publishing weekly podcast episodes during November. I also want
to write a blog post other than the status update, since I kind of stopped
writing them.&lt;/p&gt;

&lt;p&gt;I’ll push to get ANSOL’s new website deployed and then focus on other projects.&lt;/p&gt;

&lt;p&gt;I’m thinking of recording a couple of introductory videos on
&lt;a href=&quot;https://matrix.org&quot;&gt;Matrix&lt;/a&gt; and other federated networks in Portuguese.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2021-10-28:/articles/conversas-em-codigo-episode-36.html</id>
    <title type="html">Conversas em Código Episode #36 released</title>
    <published>2021-10-28T00:00:00Z</published>
    <updated>2021-10-28T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/conversas-em-codigo-episode-36.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;I’ve published a new episode of Conversas em Código - &lt;a href=&quot;https://conversas.porto.codes/episodes/rails-rust-e-hacktoberfest&quot;&gt;Episode 36: Rails, Rust e Hacktoberfest&lt;/a&gt;&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;p&gt;I’ve published a new episode of Conversas em Código (in Portuguese):&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://conversas.porto.codes/episodes/rails-rust-e-hacktoberfest&quot;&gt;Episode 36: Rails, Rust e Hacktoberfest&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Neste episódio falamos de desenvolver APIs em Rails e ferramentas da linha de comandos em Rust. Tocamos ainda em C++ no âmbito do Hacktoberfest e algures pelo meio um dos anfitriões partilha a dor de copiar cartões microSD no macOS.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;See the full episode list here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://conversas.porto.codes&quot;&gt;https://conversas.porto.codes&lt;/a&gt;&lt;/p&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2021-10-20:/articles/conversas-em-codigo-episode-35.html</id>
    <title type="html">Conversas em Código Episode #35 released</title>
    <published>2021-10-20T00:00:00Z</published>
    <updated>2021-10-20T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/conversas-em-codigo-episode-35.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;I’ve published a new episode of Conversas em Código - &lt;a href=&quot;https://conversas.porto.codes/episodes/hedgedoc&quot;&gt;Episode 35: HedgeDoc&lt;/a&gt;&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;p&gt;I’ve published a new episode of Conversas em Código (in Portuguese):&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://conversas.porto.codes/episodes/hedgedoc&quot;&gt;Episode 35: HedgeDoc&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;HedgeDoc é um editor colaborativo de documentos em markdown. Discutimos a sua história confusa, algumas contribuições feitas e qual o futuro do projecto. Também falamos sobre as mudanças no TravisCI que levaram toda a gente a mudar para GitHub Actions.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;See the full episode list here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://conversas.porto.codes&quot;&gt;https://conversas.porto.codes&lt;/a&gt;&lt;/p&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2021-10-12:/articles/conversas-em-codigo-episode-34.html</id>
    <title type="html">Conversas em Código Episode #34 released</title>
    <published>2021-10-12T00:00:00Z</published>
    <updated>2021-10-12T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/conversas-em-codigo-episode-34.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;I’ve published a new episode of Conversas em Código - &lt;a href=&quot;https://conversas.porto.codes/episodes/por-as-contas-em-dia&quot;&gt;Episode 34: Pôr as contas em dia&lt;/a&gt;&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;p&gt;I’ve published a new episode of Conversas em Código (in Portuguese):&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://conversas.porto.codes/episodes/por-as-contas-em-dia&quot;&gt;Episode 34: Pôr as contas em dia&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Esta semana pomos as contas em dia: gestão de contas no Percy e como mitigar ataques de enumeração de contas. Falamos também da ferramenta de lançamento de novas versões de Ember.js.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;See the full episode list here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://conversas.porto.codes&quot;&gt;https://conversas.porto.codes&lt;/a&gt;&lt;/p&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2021-10-07:/articles/conversas-em-codigo-episode-33.html</id>
    <title type="html">Conversas em Código Episode #33 released</title>
    <published>2021-10-07T00:00:00Z</published>
    <updated>2021-10-07T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/conversas-em-codigo-episode-33.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;I’ve published a new episode of Conversas em Código - &lt;a href=&quot;https://conversas.porto.codes/episodes/trabalhos-com-sites-estaticos&quot;&gt;Episode 33: Trabalhos com Sites Estáticos&lt;/a&gt;&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;p&gt;I’ve published a new episode of Conversas em Código (in Portuguese):&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://conversas.porto.codes/episodes/trabalhos-com-sites-estaticos&quot;&gt;Episode 33: Trabalhos com Sites Estáticos&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Conversão de Drupal para Hugo, problemas com o Netlify, e uma visita
bastidores do lançamento de versões de Ember. Também falamos de algumas
novidades do Hacktoberfest e do processo de edição do podcast.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;See the full episode list here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://conversas.porto.codes&quot;&gt;https://conversas.porto.codes&lt;/a&gt;&lt;/p&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2021-09-30:/articles/status-update-2021-09-30.html</id>
    <title type="html">Status update, September 2021</title>
    <published>2021-09-30T00:00:00Z</published>
    <updated>2021-09-30T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/status-update-2021-09-30.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;September has been productive. I finished all but one of the tasks I had planned for this month and did some extra stuff. October is going to be overwhelming.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;September has been productive. I finished all but one of the tasks I had
planned for this month and did some extra stuff.&lt;/p&gt;

&lt;h2 id=&quot;september-accomplishments&quot;&gt;September accomplishments&lt;/h2&gt;

&lt;p&gt;Speak at &lt;a href=&quot;https://rustconf.com&quot;&gt;RustConf 2021&lt;/a&gt;. The video, slides, and code
&lt;a href=&quot;https://hugopeixoto.net/articles/rustconf2021-video-available.html&quot;&gt;are already available&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I fixed the &lt;a href=&quot;https://cyberscore.me.uk&quot;&gt;cyberscore&lt;/a&gt; bugs I mentioned last month. When using
the old layout, users change their own profile information, so I migrated
everyone to the new layout. Moderation tools like “Revert record” and “Reset
record status” were broken, so these were fixed as well. There were also some
pages that were broken when we migrated to MariaDB, thanks to queries where you
select columns that are not aggregate or functionally dependent of the group by
expressions.&lt;/p&gt;

&lt;p&gt;Password recovery is now available on &lt;a href=&quot;https://github.com/alumniei/mentorados&quot;&gt;AlumniEI’s mentorship
program&lt;/a&gt;. I also made an effort to prevent accidentally disclosing
if a user is registered on the website or not, including via timing attacks.
There’s some more information on this &lt;a href=&quot;https://github.com/alumniei/mentorados/pull/37&quot;&gt;in the pull request
review&lt;/a&gt;, but I might turn it into a short blog post. The
website’s portuguese translation now comforms to &lt;a href=&quot;https://pt.wikipedia.org/wiki/G%C3%AAnero_neutro&quot;&gt;gender neutral
rules&lt;/a&gt; instead of defaulting to male pronouns.&lt;/p&gt;

&lt;p&gt;I started working on migrating &lt;a href=&quot;https://ansol.org&quot;&gt;ANSOL&lt;/a&gt;’s website from Drupal 7 to
&lt;a href=&quot;https://gohugo.io&quot;&gt;Hugo&lt;/a&gt;. The content is all converted to markdown, now I need to work on
the website itself. I also designed the banner for their &lt;a href=&quot;https://ansol.org/20anos&quot;&gt;20 year
anniversary&lt;/a&gt; and did some other tasks related to that event.&lt;/p&gt;

&lt;p&gt;I didn’t find time to work on &lt;a href=&quot;https://direitosdigitais.pt&quot;&gt;D3&lt;/a&gt; or &lt;a href=&quot;https://fzerocentral.org&quot;&gt;F-Zero Central&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://conversas.porto.codes&quot;&gt;Conversas em código&lt;/a&gt; is back! &lt;a href=&quot;https://locks.wtf/&quot;&gt;locks&lt;/a&gt; and I released episodes this
month and we have a couple more in the queue. I also found two unreleased
episodes from late 2020, so I edited them and will publish them whenever we
need to fill in a gap. Let’s see if we can keep this up.&lt;/p&gt;

&lt;p&gt;I’ve been playing sokoban with my hard drives, moving stuff around so I could
full disk encrypt them all. The last disk should be done today, and then I can
focus on organizing this mess.&lt;/p&gt;

&lt;p&gt;My graphic design skills are practically non-existent and a lot of volunteer
based projects I’ve been working on lack someone in that department, so I
decided to read a bit about the subject. &lt;a href=&quot;http://thinkingwithtype.com/&quot;&gt;Thinking with type&lt;/a&gt; was sitting
in my shelf so I started there. I’d appreciate any suggestions on what to pick
up next.&lt;/p&gt;

&lt;h2 id=&quot;october-plans&quot;&gt;October plans&lt;/h2&gt;

&lt;p&gt;I’ll be spending approximately 20h/week on a freelancing gig for the following
three months. It’s going to be a cleanup job: upgrading some dependencies,
fixing infrastructure issues, bringing terraform up to code.&lt;/p&gt;

&lt;p&gt;I want to publish one podcast episode per week during October. It should be
doable, since we already have enough recorded material for that. I just need to
edit them.&lt;/p&gt;

&lt;p&gt;The unnamed D3 project needs to be tackled this month. I have been delaying
this for months now, and it’s a bit embarrassing. I think there’s a pending
Joomla upgrade that needs attending.&lt;/p&gt;

&lt;p&gt;I will focus on finishing ANSOL’s website rewrite. I’m not expecting to finish
the whole thing since there are design and copywriting issues that need to be
solved, but I want to get it into a state where could replace the current
website.&lt;/p&gt;

&lt;p&gt;There’s also the C++ presentation that I volunteered for. I still need to do
some research and prepare the actual presentation. I’m going to talk about
&lt;code&gt;std::ranges&lt;/code&gt;. There’s still no fixed date, but it will be in November,
somewhere in Porto.&lt;/p&gt;

&lt;p&gt;If there’s any time left, I want to tackle F-Zero Central. This has been pretty
low on my priority list, and if I don’t tackle it this month I’ll have to bump
its priority in November.&lt;/p&gt;

&lt;p&gt;Also, &lt;a href=&quot;https://hacktoberfest.digitalocean.com/&quot;&gt;Hacktoberfest&lt;/a&gt; is happening. I don’t think I’ll organize
anything this year, but I’ll probably join a local event. If you don’t know
which project to contribute to, &lt;a href=&quot;https://hugopeixoto.net/about.html&quot;&gt;talk to me&lt;/a&gt;! I can probably help you
find something.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;


    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2021-09-28:/articles/conversas-em-codigo-episode-32.html</id>
    <title type="html">Conversas em Código Episode #32 released</title>
    <published>2021-09-28T00:00:00Z</published>
    <updated>2021-09-28T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/conversas-em-codigo-episode-32.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;I’ve published a new episode of Conversas em Código - &lt;a href=&quot;https://conversas.porto.codes/episodes/outubro-e-software-livre&quot;&gt;Episode 32: Outubro e Software Livre&lt;/a&gt;&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;p&gt;I’ve published a new episode of Conversas em Código (in Portuguese):&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://conversas.porto.codes/episodes/outubro-e-software-livre&quot;&gt;Episode 32: Outubro e Software Livre&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Outubro está a chegar, e é mês de Software Livre. Neste episódio falamos do
Hacktoberfest e de alguns eventos e projectos da ANSOL.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;See the full episode list here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://conversas.porto.codes&quot;&gt;https://conversas.porto.codes&lt;/a&gt;&lt;/p&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2021-09-27:/articles/conversas-em-codigo-episode-31.html</id>
    <title type="html">Conversas em Código Episode #31 released</title>
    <published>2021-09-27T00:00:00Z</published>
    <updated>2021-09-27T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/conversas-em-codigo-episode-31.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;I’ve published a new episode of Conversas em Código - &lt;a href=&quot;https://conversas.porto.codes/episodes/participacao-na-rustconf-2021&quot;&gt;Episode 31: Participação na RustConf 2021&lt;/a&gt;&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;p&gt;I’ve published a new episode of Conversas em Código (in Portuguese):&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://conversas.porto.codes/episodes/participacao-na-rustconf-2021&quot;&gt;Episode 31: Participação na RustConf 2021&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Neste episódio falamos sobre a experiência do Peixoto em fazer uma
apresentação na RustConf 2021.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;See the full episode list here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://conversas.porto.codes&quot;&gt;https://conversas.porto.codes&lt;/a&gt;&lt;/p&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2021-09-20:/articles/rustconf2021-video-available.html</id>
    <title type="html">My talk at RustConf 2021 is now available</title>
    <published>2021-09-20T00:00:00Z</published>
    <updated>2021-09-20T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/rustconf2021-video-available.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;You can check it out on youtube. It’s a 14 minute video.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;p&gt;It’s 14 minutes long, and you can check it out on youtube:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://www.youtube.com/watch?v=BLy_YF4nmqQ&quot;&gt;Identifying Pokémon Cards&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Here are some related resources:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://hugopeixoto.net/talks/identifying-pokemon/slides.pdf&quot;&gt;slides.pdf&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://hugopeixoto.net/pokemon/detection/demo.mp4&quot;&gt;demo (no sound)&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/hugopeixoto/ptcg-detection/&quot;&gt;source code&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2021-09-06:/articles/status-update-2021-08-31.html</id>
    <title type="html">Status update, August 2021</title>
    <published>2021-09-06T00:00:00Z</published>
    <updated>2021-09-06T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/status-update-2021-08-31.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;August was about Pokémon projects all day, every day. September is going to be tough.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;This month I took a break from Cyberscore to work on other projects. I was all
in on Pokémon stuff. I also took a week of vacations, which is why this update
is a bit late.&lt;/p&gt;

&lt;h2 id=&quot;august-accomplishments&quot;&gt;August accomplishments&lt;/h2&gt;

&lt;p&gt;I worked on extracting the pokédex flavor texts from the 3DS game ROMs
(&lt;a href=&quot;https://github.com/hugopeixoto/ctr-rs&quot;&gt;https://github.com/hugopeixoto/ctr-rs&lt;/a&gt;) and wrote a &lt;a href=&quot;/articles/data-mining-3ds-pokemon-games.html&quot;&gt;blog post of the
process&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Before working on the pokédex extraction thing, I worked on a quick and dirty
tool to OCR the pokédex flavor entries from Pokémon cards, to help seed content
on &lt;a href=&quot;https://pkmncards.com&quot;&gt;https://pkmncards.com&lt;/a&gt;. This is available here:
&lt;a href=&quot;https://github.com/hugopeixoto/ptcg-ocr/&quot;&gt;https://github.com/hugopeixoto/ptcg-ocr/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I’ve also spent around a week’s worth of time polishing and rehearsing for &lt;a href=&quot;https://rustconf.com/schedule/identifying-pok-mon-cards&quot;&gt;my
talk for RustConf&lt;/a&gt;.
Initially I was going through the technical details of a bunch of algorithms,
but being limited to 15 minutes, I had to cut a lot and really focus on the
essentials. It was an interesting experiment, but it took forever. It’s the
first talk I’m giving outside of &lt;a href=&quot;https://porto.codes&quot;&gt;Porto codes&lt;/a&gt;, so that’s
going to be fun. I hope people like it.&lt;/p&gt;

&lt;h2 id=&quot;september-plans&quot;&gt;September plans&lt;/h2&gt;

&lt;p&gt;My to-do list for September is kind of huge, not sure how I’m going to fit
everything in.&lt;/p&gt;

&lt;p&gt;First, there’s the actual RustConf talk, scheduled for the 14th.&lt;/p&gt;

&lt;p&gt;There are a couple of &lt;a href=&quot;https://cyberscore.me.uk&quot;&gt;https://cyberscore.me.uk&lt;/a&gt; important bugs that need
fixing, and I’d like to add user registration to &lt;a href=&quot;https://fzerocentral.org&quot;&gt;https://fzerocentral.org&lt;/a&gt;, I
haven’t worked on it in a while.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://mentor.alumniei.pt&quot;&gt;AlumniEI’s Mentorship program&lt;/a&gt; is supposed to
launch this month, so I’ll need to spend some time on it.&lt;/p&gt;

&lt;p&gt;I also volunteered to work on a project for &lt;a href=&quot;https://direitosdigitais.pt&quot;&gt;D3&lt;/a&gt;
and a couple of &lt;a href=&quot;https://ansol.org&quot;&gt;ANSOL&lt;/a&gt; projects this month.&lt;/p&gt;

&lt;p&gt;I wanted to work on extracting the pokédex flavor texts from the Switch games
and add them to &lt;a href=&quot;https://veekun.com/dex&quot;&gt;Veekun&lt;/a&gt;, but I think it will have to
wait. I volunteered to do a C++ related talk in November, but I’ll probably
only start working on it in October.&lt;/p&gt;

&lt;p&gt;I’m getting stressed just looking at this list. I’ll probably start with
Cyberscore and the mentorship program, since they’re closed scope tasks and
kind of time critical, and then move to the D3 and ANSOL ones, since they’re
are a bit more squishy and lengthy. Not sure where I’m going to fit F-Zero
Central. Getting this blog post out of the way is already a great help
kickstarting things.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2021-08-18:/articles/data-mining-3ds-pokemon-games.html</id>
    <title type="html">Data-mining 3DS Pokémon games</title>
    <published>2021-08-18T00:00:00Z</published>
    <updated>2021-08-18T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/data-mining-3ds-pokemon-games.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;I’ve spent the last couple of weeks learning how to data mine Nintendo 3DS Pokémon games (as in “extract information from”, not “discover patterns from large amounts of data”). Let’s see how that works.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;I’ve spent the last couple of weeks learning how to data mine Nintendo 3DS
Pokémon games (data-mine as in “extract information from”, not “discover
patterns from large amounts of data”). I’m not even sure how to explain how I
got here, so I guess I’ll start from the beginning.&lt;/p&gt;

&lt;h2 id=&quot;pkmncards-and-ocr&quot;&gt;Pkmncards and OCR&lt;/h2&gt;

&lt;p&gt;Last month I worked on detecting pokémon TCG cards using rust (I’ll be speaking
about it at &lt;a href=&quot;https://rustconf.com&quot;&gt;rustconf 2021&lt;/a&gt;). I needed to grab a dataset
of all the cards for that, so I scraped &lt;a href=&quot;https://pkmncards.com&quot;&gt;PkmnCards&lt;/a&gt; and
started hanging out in their discord. This month a new TCG set comes out
(Evolving Skies), and they’ll need to upload the new cards. From what I
understand, most of the work is automated, scraped from the PTCGO client.&lt;/p&gt;

&lt;p&gt;There’s one part that is manual, though. Each Pokémon card has a small Pokédex
flavor text in the bottom-right corner (it has no effect on gameplay). This
text is not available as structured data on the PTCGO dump, it’s only present
in the card image. Luckily, the text always matches a pokédex entry for that
species in one of the main games. Take these two Pikachu cards: &lt;a href=&quot;https://pkmncards.com/card/pikachu-cosmic-eclipse-cec-66/&quot;&gt;Pikachu from
Cosmic Eclipse&lt;/a&gt; and &lt;a href=&quot;https://pkmncards.com/card/pikachu-crimson-invasion-cin-30/&quot;&gt;Pikachu from Crimson Invasion&lt;/a&gt;.
They read, respectively:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Its nature is to store up electricity. Forests where nests of Pikachu
live are dangerous, since the trees are so often struck by lightning.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;A plan was recently announced to gather many Pikachu and make an electric
power plant.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;The first one is the pokédex entry in Pokémon Ultra-Sun, while the second one
is from Pokémon Sun. Even though we don’t know which entry a card will have, we
do know what the possible entries are. Running an OCR program (&lt;code&gt;tesseract&lt;/code&gt;) on
that section of the card, after some preprocessing with &lt;code&gt;imagemagick&lt;/code&gt;, gives us
a pretty close approximation of the text, so we can take that and search the
closest match from a database of all known entries. I grabbed a pokédex entry
dataset from &lt;a href=&quot;https://veekun.com/dex&quot;&gt;Veekun&lt;/a&gt; and implemented a basic string
matcher:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;c1&quot;&gt;# find the entry that contains the most number of words of the OCR text.&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;find_match&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ocr_text&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;entries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;ocr_words&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ocr_text&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;split&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;sr&quot;&gt;/[.,\s]+/&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;entries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;max_by&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;entry&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;entry_words&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;entry&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;split&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;sr&quot;&gt;/[.,\s]+/&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;ocr_words&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;count&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;word&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;entry_words&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;include?&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;word&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I had to tweak the image preprocessing quite a bit. Tesseract works by first
transforming the image to binary (black and white), and different pokémon cards
have different background and foreground colors, so the quality of the
binarization varied wildly. By making the binarization in the preprocessing
step based on the palette of the card, the results improved a lot. The code for
this is available here: &lt;a href=&quot;https://github.com/hugopeixoto/ptcg-ocr/&quot;&gt;https://github.com/hugopeixoto/ptcg-ocr/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The whole process was working fine, except for Galarian and Alolan forms, which
seemed to match a random pokédex entry. That’s when I discovered that Veekun
doesn’t have pokédex entries for alternate forms. It only contains a single
entry per species/game pair. This is problem for other species like Castform,
Oricorio, Urshifu, etc, which also have multiple entries depending on their
form.&lt;/p&gt;

&lt;p&gt;Adding these entries to Veekun felt like a good contribution to make, so I
started looking into it. I’ve messed with their codebase in the past, but I
needed to get the information from somewhere. There are plenty of online
sources containing the pokédex entry information, but Veekun’s preferred source
is the games themselves, so I started looking into extracting data from ROMs.
Alternate form pokédex entries were introduced in generation 7 (Sun/Moon),
probably to deal with the addition of the Alolan forms, so that’s where I
started.&lt;/p&gt;

&lt;h2 id=&quot;data-mining-3ds-roms&quot;&gt;Data-mining 3DS roms&lt;/h2&gt;

&lt;p&gt;Going in, I knew nothing of how 3DS games are stored. Twenty years ago I
explored the contents of Red and Blue ROMs, so I have some idea of the efforts
and techniques involved, but the 3DS is a much more advanced system.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;Eevee, the creator of Veekun, has a great introductory post to data-mining
  pokémon games: &lt;a href=&quot;https://eev.ee/blog/2017/08/02/datamining-pokemon/&quot;&gt;https://eev.ee/blog/2017/08/02/datamining-pokemon/&lt;/a&gt;&lt;/p&gt;

  &lt;p&gt;If any of the techniques mentioned on the rest of this write-up feel
  overwhelming, her post has a section going over the basics, give it a read&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;If you jailbreak your 3DS, you can install software that lets you dump your
cartridge’s ROM. To guarantee that you dumped it properly, there is a
preservation project, &lt;a href=&quot;https://no-intro.org/&quot;&gt;No-Intro&lt;/a&gt;, that created a database of SHA
checksums of properly dumped games, so you can compare your hashes. Dumped ROMs
are encrypted using AES, with the keys being stored in the handheld’s operating
system. You can get these keys out of your 3DS and use them to decrypt the
ROMs. The checksums of the decrypted ROMs are also available on No-Intro, so
you can be double-sure that you have a good backup of the game.&lt;/p&gt;

&lt;p&gt;There are already a bunch of tools that let you inspect and extract the
contents of 3DS ROMs, but I wanted to implement something myself. I need all
the excuses I can get to practice my Rust skills. These tools, though, can be
useful as documentation. I found a wiki that documents most of the file formats
involved, but having more than one reference is always good.&lt;/p&gt;

&lt;p&gt;The main container format of the ROM is NCSD. It has a bunch of header info and
a set of 8 partitions. Each partition is in the NCCH format. The first tool I
built was to parse the NCSD header and extract each NCCH partition into its own
file.&lt;/p&gt;

&lt;p&gt;Each NCCH partition has a fixed number of sections, and the most interesting
ones are ExeFS and RomFS. ExeFS contains the game’s code, while RomFS is used
for file storage. The second tool I built extracted all of these sections.&lt;/p&gt;

&lt;p&gt;Assuming that the data I’m looking for is not hardcoded, I ignored ExeFS and
looked into the RomFS format. This format, IVFC, is a file system containing
arbitrarily nested directories and files. There is also a data structure with a
bunch of hashes which wasn’t completely documented. Since it didn’t affect the
ability to extract the directory structure, I ignored the hashes and wrote
another tool to extract the directory tree.&lt;/p&gt;

&lt;h2 id=&quot;data-mining-pokmon-sun&quot;&gt;Data-mining Pokémon Sun&lt;/h2&gt;

&lt;p&gt;Up until this point, I was able to find documentation on all these formats. Now
that I was looking at a particular game’s file system, I had to rely on
practically undocumented tools and forum posts to understand what was going on.&lt;/p&gt;

&lt;p&gt;Part of the filesystem has human readable names, but the most of the data is
inside a directory called &lt;code&gt;a&lt;/code&gt; whose structure look like this:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;find a -type f | sort
&lt;/span&gt;a/0/0/0
a/0/0/1
&lt;span class=&quot;c&quot;&gt;...
&lt;/span&gt;a/0/0/9
a/0/1/0
&lt;span class=&quot;c&quot;&gt;...
&lt;/span&gt;a/0/9/9
a/1/0/0
&lt;span class=&quot;c&quot;&gt;...
&lt;/span&gt;a/3/1/0
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Not having filenames makes it a bit harder to figure out what’s going on. The
size of each of those 311 files can go from a few bytes to hundreds of
megabytes. I started looking at the first 4 bytes of each file, looking for
&lt;a href=&quot;https://en.wikipedia.org/wiki/Magic_number_(programming)#Format_indicators&quot;&gt;magic numbers&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;All of them, turns out, are GARC files. GARC is yet another container format,
with one level of nesting. It has no filename information, so the extractor
tool I built, when applied to GARC file &lt;code&gt;a/0/0/0&lt;/code&gt;, generated filenames like
&lt;code&gt;a/0/0/0.0.0&lt;/code&gt;, &lt;code&gt;a/0/0/0.0.1&lt;/code&gt;, &lt;code&gt;a/0/0/0.1.0&lt;/code&gt;, etc. Some GARC files had only one
file, while others had thousands. None of them had more than one sub-entry,
though.&lt;/p&gt;

&lt;p&gt;While I couldn’t find any documentation for these files, there are some
projects that let you make modifications to your Pokémon ROMs, so I used their
source code to find the file that contained the pokédex text entries.&lt;/p&gt;

&lt;p&gt;Game text is stored in the subfiles of GARC file &lt;code&gt;a/0/3/2&lt;/code&gt;, in yet another
format, FATO. After implementing yet another parser, I was able to dump all of
the strings in every subfile of &lt;code&gt;a/0/3/2&lt;/code&gt;. Grepping for known pokédex entries,
I found that they are stored in subfiles &lt;code&gt;119.0&lt;/code&gt; and &lt;code&gt;120.0&lt;/code&gt; (for Sun and Moon
respectively, I’m assuming). Each file contains 1063 strings, where the first
803 have the dex entry of the respective national dex number (string #0 is a
dummy entry, and string #25 is Pikachu’s entry). From 804 onward, we have the
entries for the alternate forms, in no obvious order at first sight.&lt;/p&gt;

&lt;p&gt;At this point, this would be good enough for my initial purpose of using them
to OCR the TCG cards. But if I wanted to import these strings onto Veekun, I
would have to figure out how to match the extra entries to the forms. This is
where I had to do some research on my own, since I couldn’t find any
information about this.&lt;/p&gt;

&lt;p&gt;The other files inside &lt;code&gt;a/0/3/2&lt;/code&gt; all contain strings, so I couldn’t find
anything by searching nearby files. The next step was to think of other known
places where forms might be used. Base stats, for example, vary by form, and
they’re easy to find because they’re well known values. As expected, the ROM
hacking tool had mapped the files where base stats occur. Base stats are stored
in GARC &lt;code&gt;a/0/1/7&lt;/code&gt;, one pokémon per subfile. Those files have two other
interesting fields, &lt;code&gt;form_count&lt;/code&gt; and &lt;code&gt;form_stats_index&lt;/code&gt;. In Pikachu’s case, its
values are &lt;code&gt;7&lt;/code&gt; and &lt;code&gt;950&lt;/code&gt;. This means that Pikachu’s 6 alternate forms have
their base stats in subfiles &lt;code&gt;a/0/1/7.950.0&lt;/code&gt; to &lt;code&gt;a/0/1/7.955.0&lt;/code&gt;. At first I
thought that these indexes could match the pokedex text entries, but they
don’t. Some Pokémon, like Silvally, has 18 forms with pokédex text entries but
no alternate form stats. This led me to think that I would have to find a table
specifically for pokédex entries.&lt;/p&gt;

&lt;p&gt;I wasn’t sure what shape the data I was looking for had, and no clues where to
look, so I decided to search for something that I expected to be nearby. Since
it looked like this mapping was only used for pokédex related stuff, I assumed
it was near other pokédex data structures, so I started looking for those
instead.&lt;/p&gt;

&lt;h2 id=&quot;finding-pokdex-related-structures&quot;&gt;Finding Pokédex-related structures&lt;/h2&gt;

&lt;p&gt;Although each pokémon species has its global pokédex number (known as the
national dex), each game has its own regional pokédex, with a different
ordering and only a subset of species. Squirtle, for example, is #7 on the
national dex, but #232 on Johto’s regional dex, and not present at all on
Hoenn’s dex. If I look at a few consecutive entries in the Alolan dex and take
their national dex numbers, I will probably get a pretty distinct sequence of
numbers. I know that pokédex numbers are usually encoded in 16 bits using
little endian. So if I take the Alolan entries #13 to #20, I’d get the
following byte sequence:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;DE 02 # &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;yungoos    734
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;DF 02 # &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;gumshoos   735
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;13 00 # &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;rattata     20
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;14 00 # &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;raticate    21
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;0A 00 # &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;caterpie    10
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;0B 00 # &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;metapod     11
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;0C 00 # &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;butterfree  12
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;A5 00 # &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;ledyba     165
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This felt like a good byte sequence to search for. Since there could be other
information packed along the dex number, I built a tool to search for sequences
but allowing for evenly spaced gaps. After a few rounds of optimization, I
searched the whole &lt;code&gt;a/&lt;/code&gt; directory for matches, and it found two matches in a
single file: &lt;code&gt;a/1/5/2.0.0&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Why two matches? Well, Alola’s Pokédex has four smaller sub-pokédexes, one for
each island in the game (Melemele, Akala, Ula’ula, and Poni). While the
regional dex has 302 entries, each island’s dex has around 120 entries.
Melemele’s dex is practically the same as Alola’s, except for the 120th entry.
This led me to believe that those two matches were pointing to those two
pokédexes. I searched for sequences unique to the other island’s dexes and they
all matched exactly once in this file. With this information, and using my
sequence searching tool, I was able to find the starting offset of the five
pokédexes:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;0678 / 1656: Alolan dex
0cbc / 3260: Melemele dex
1300 / 4864: Akala dex
1944 / 6468: Ula&#39;ula dex
1f88 / 8072: Poni dex
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The distance between them is way more than ~240 bytes (120 entries of 2 bytes
each), so I needed to figure out what else was there. The dex numbers were
contiguous, with no extra bytes between them, so it was either extra
information, or other unrelated tables. Instead of trying to guess, it was time
to look at the first bytes of the file to see if I could extract any
information from them. Maybe I could figure out the header structure. These are
the first 0x50 bytes:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;00000000: 424c 0b00 3400 0000 7806 0000 bc0c 0000  BL..4...x.......
00000010: 0013 0000 4419 0000 881f 0000 cc25 0000  ....D........%..
00000020: 182e 0000 6436 0000 b03e 0000 fc46 0000  ....d6...&amp;gt;...F..
00000030: b885 0000 0100 0200 0300 0400 0500 0600  ................
00000040: 0700 0800 0900 0a00 0b00 0c00 0d00 0e00  ................
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I registered a few things while looking at this:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;I could see the starting offsets of the pokédexes (&lt;code&gt;0678&lt;/code&gt;, &lt;code&gt;0cbc&lt;/code&gt;, etc)&lt;/li&gt;
  &lt;li&gt;the first two bytes were valid ASCII, &lt;code&gt;BL&lt;/code&gt;, a potential magic number&lt;/li&gt;
  &lt;li&gt;From 0x34 onwards, there was an increasing sequence of two bytes each&lt;/li&gt;
  &lt;li&gt;0x34 was also on the first few bytes&lt;/li&gt;
  &lt;li&gt;the third byte, 0x0b, is a small number, probably a &lt;code&gt;count&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Using that information, the header can be interpreted like this:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;0000: 424c      # &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;magic number
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;0002: 0b00      # &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;number of tables
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;0004: 3400 0000 # &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;start of 1st table
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;0008: 7806 0000 # &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;start of 2nd table / end of 1st table
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;000c: bc0c 0000 # &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;...
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;0010: 0013 0000 # &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;...
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;0004: 4419 0000 # &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;...
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;0008: 881f 0000 # &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;...
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;000c: cc25 0000 # &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;...
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;0020: 182e 0000 # &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;...
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;0004: 6436 0000 # &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;...
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;0008: b03e 0000 # &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;...
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;000c: fc46 0000 # &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;start of 11th table / end of 10th table
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;0030: b885 0000 # &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;file size / end of 11th table
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;0034: 0100 ...  # &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;first table contents
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;With this potential header structure, I built a decoder tool that printed the
nth table of the file. Tables #2 - #6 store the five regional pokédexes, but I
still had to figure out what the extra bytes in each table represented.&lt;/p&gt;

&lt;p&gt;Looking at table #2, the Alolan pokédex, I started looking for patterns. I
noticed that it had 802 entries, and that after the 301st entry, the numbers
started at 1 and increased up until 721, with some gaps. I sorted the table
entries and discovered that each number appeared only once. This means that the
extra entries are the pokémon that are not present in this pokédex, ordered by
national pokédex number. I double checked the other four tables and the theory
was confirmed. I don’t know why they have that information there, but it’s not
what I was looking for anyway.&lt;/p&gt;

&lt;p&gt;Table #1 contains all numbers from 1 to 802 in increasing order. It probably
represents the national pokédex.&lt;/p&gt;

&lt;p&gt;Tables #7 - #10 all have 2124 bytes. If I assume that they’re also 16 bit
entries, that would give me 1062 entries per table, which is the number of
forms! The numbers on table #7 follow an interesting pattern: they’re all
unique, and the numbers from 0 to 802 are all there. There’s no 803 or 804,
though. The following numbers are 1027, 1030, 1033, 1039, and they go all the
way up to 27849. The numbers are too high to be indexes, but they’re all
unique. This makes me think that maybe the 16 bits might actually be two
separate fields. To represent 802 entries we’d need 10 bits, leaving six bits
for whatever the other field is. &lt;code&gt;1 &amp;lt;&amp;lt; 10&lt;/code&gt; is &lt;code&gt;1024&lt;/code&gt;, which kind of fits the
fact that the number following 802 is 1027. If we print the table numbers
sorted first by pokedex number and then by the 6 bit field, it looks something
like this:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;  0:00   1:00   2:00   3:00   3:01   4:00   5:00   6:00   6:01   6:02
  7:00   8:00   9:00   9:01  10:00  11:00  12:00  13:00  14:00  15:00
 15:01  16:00  17:00  18:00  18:01  19:00  19:01  20:00  20:01  20:02
 21:00  22:00  23:00  24:00  25:00  25:01  25:02  25:03  25:04  25:05
 25:06  26:00  26:01  27:00  27:01  28:00  28:01  29:00  30:00  31:00
 32:00  33:00  34:00  35:00  36:00  37:00  37:01  38:00  38:01  39:00
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The first thing that draws my attention is that pokédex number 25 has seven
entries. This matches the fact that Pikachu has seven forms. Another number
that has a lot of occurences is 201. Pokémon no. 201 is Unown, which has 28
forms. Venusaur (#3), Charizard (#6) and Blastoise (#9) all have alternate
forms. This means that this table is sorting every form, unsure by what field.
Let’s see who are the first entries:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;0: 321:00 - Wailord   (regular form)
1: 103:01 - Exeggutor (alternate form #1, assuming Alolan)
2: 384:01 - Rayquaza  (alternate form #1, assuming Mega)
3: 208:01 - Steelix   (same, Mega)
4: 382:01 - Kyogre    (same, Mega)
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now, Wailord is known for being a huge pokémon, and Alolan Exeggutor is kind of
a meme for being super tall. Could it be that this list is a ranking of pokémon
by height? Checking &lt;a href=&quot;https://bulbapedia.bulbagarden.net/wiki/List_of_Pokémon_by_height&quot;&gt;Bulbapedia’s list of pokémon by height&lt;/a&gt;, we
can see that Eternatus is the tallest pokémon, but Eternatus didn’t exist in
Sun/Moon. The next tallest Pokémon is… Wailord, followed by Alolan Exeggutor,
followed by Mega Rayquaza!&lt;/p&gt;

&lt;p&gt;Knowing what table #7 means, I quickly found the meaning of tables #8 - #10:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;table #7: pokémon ranked from tallest to shortest&lt;/li&gt;
  &lt;li&gt;table #8: pokémon ranked from shorted to tallest&lt;/li&gt;
  &lt;li&gt;table #9: pokémon ranked from heaviest to lightest&lt;/li&gt;
  &lt;li&gt;table #10: pokémon ranked from lightest to heaviest&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Knowing this, I loaded the game on my 3DS and checked the Pokédex
functionality. These four rankings match the sorting options available.&lt;/p&gt;

&lt;p&gt;The final table has 16060 bytes. This would be 8030 entries of 16 bits, which
seems like a lot. But wait.. 8030 looks like &lt;code&gt;803*10&lt;/code&gt;, and 803 is practically
the number of pokémon (802 + 1 dummy entry, maybe?). So maybe the entries in
this table have not 2 but 20 bytes each. Let’s assume that each entry has 10
fields of 16 bits each and print the first few entries, ignoring the first one
(since it’s all zeros and probably a dummy entry for padding). This is what we
get:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;   1     2     3     0     0     0     0     0     0     3
   1     2     3     0     0     0     0     0     0     3
   1     2     3     0     0     0     0     0     0     3
   4     5     6     0     0     0     0     0     0     3
   4     5     6     0     0     0     0     0     0     3
   4     5     6     0     0     0     0     0     0     3
   7     8     9     0     0     0     0     0     0     3
   7     8     9     0     0     0     0     0     0     3
   7     8     9     0     0     0     0     0     0     3
  10    11    12     0     0     0     0     0     0     3
  10    11    12     0     0     0     0     0     0     3
  10    11    12     0     0     0     0     0     0     3
  13    14    15     0     0     0     0     0     0     3
  13    14    15     0     0     0     0     0     0     3
  13    14    15     0     0     0     0     0     0     3
  16    17    18     0     0     0     0     0     0     3
  16    17    18     0     0     0     0     0     0     3
  16    17    18     0     0     0     0     0     0     3
  19    20     0     0     0     0     0     0     0     2
  19    20     0     0     0     0     0     0     0     2
  21    22     0     0     0     0     0     0     0     2
  21    22     0     0     0     0     0     0     0     2
  23    24     0     0     0     0     0     0     0     2
  23    24     0     0     0     0     0     0     0     2
 172    25    26     0     0     0     0     0     0     3
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Just by looking at the general shape of the table, it feels right. If we look
at entry #25, and assume that it represents Pikachu, we see 172, 25, and 26. 25
is Pikachu’s number, 26 is Raichu’s number, so that means that 172 is probably
Pichu! If we look at entries #1, #2, and #3, they’re all the same. This means
that each entry in this table represents the evolution line of the pokémon in
question. This would mean that the final number represents the number of
elements in the evolution line. I double checked and Eevee’s line has a value
of 9 and no zero entries.&lt;/p&gt;

&lt;p&gt;I’ve gone through all the contents of &lt;code&gt;a/1/5/2.0.0&lt;/code&gt;. On one side, it’s nice to
be able to figure out everything, but I didn’t find what I was looking for.&lt;/p&gt;

&lt;p&gt;There is another file belonging to the same GARC: &lt;code&gt;a/1/5/2.1.0&lt;/code&gt;. This file also
starts with &lt;code&gt;BL&lt;/code&gt;, and it follows the same header structure. I can see that it
has seven tables, so we just repeat the process again. Start by printing the
first table. Here are the first few entries:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;entries: 1064 / bytes: 2128
  0     0     0   804     0     0   805     0     0   807
  0     0     0     0     0   808     0     0   809   810
811     0     0     0     0   813   819   820   821     0
  0     0     0     0     0     0     0   822   823     0
  0     0     0     0     0     0     0     0     0     0
824   825   826   827     0     0     0     0     0     0
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The number of entries matches the number of forms. They are mostly zeros, but
the usual 3/6/9 entries are not. These match Venusaur/Charizard/Blastoise, all
of which have a Mega evolution alternate form. All non-zero numbers are between
than 804 and 1600. Seems good so far. The value on entry #26, Raichu, is 819. If
I check what is the 819th string on the &lt;code&gt;a/0/3/2.119.0&lt;/code&gt; file, I get:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;It only evolves to this form in the Alola region.\nAccording to researchers,
its diet is one of the\ncauses of this change.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;That’s is Alolan’s Raichu pokédex entry! I did the same thing for other entries
and they all match, so it seems like we have a winner. For species with multiple
forms, we have to follow them like a linked list:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;table[25]  =&amp;gt; 813
table[813] =&amp;gt; 814
table[814] =&amp;gt; 815
table[815] =&amp;gt; 816
table[816] =&amp;gt; 817
table[817] =&amp;gt; 818
table[818] =&amp;gt; 0
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Knowing this, I can map every (species number, form index) pair to the
respective pokédex entry. This gets me what I was looking for. I didn’t bother
to explore the other tables on this &lt;code&gt;BL&lt;/code&gt; file yet.&lt;/p&gt;

&lt;h2 id=&quot;next-steps&quot;&gt;Next steps&lt;/h2&gt;

&lt;p&gt;Now that I know where to get the information, I need to actually build a thing
to dump it from the ROM in a structured format. I’m having some trouble
figuring out the right API for this parsing library, since I don’t want to
create a ton of temporary files on the file system and don’t want to load more
than necessary onto memory.&lt;/p&gt;

&lt;p&gt;When that’s ready, I’ll need to repeat the process for Pokémon Ultra-Sun /
Ultra-Moon. I bought the game a couple of days ago, haven’t even started
playing it. The process should be similar: from what I understand, things
haven’t change that much between generations. I was able to use the same
parsers to extract information from Pokémon Y, the main difference is that the
files in the &lt;code&gt;a/&lt;/code&gt; directory get moved around.&lt;/p&gt;

&lt;p&gt;The final step would be to start working on Pokémon Sword and Shield, for the
Switch. From the little that I read about it, it should be similar, with the
exception that they started using real filenames instead of the &lt;code&gt;a/1/2/2&lt;/code&gt; mess.&lt;/p&gt;

&lt;h2 id=&quot;final-thoughts&quot;&gt;Final thoughts&lt;/h2&gt;

&lt;p&gt;I really enjoyed doing this. It’s super fun to figure these things out, looking
for patterns and playing with bits. Sometimes you get stuck, but going to sleep
and returning the following day helps. I had no idea what tables #7 - #10 were
until I started writing this blog post and decided to push it a bit further.&lt;/p&gt;

&lt;p&gt;I would’ve probably benefited from using some more advanced tools, like a
proper hex editor. It would be nice to visually mark the file sections that I
had already cracked. I kept opening &lt;code&gt;irb&lt;/code&gt; to make decimal to hexadecimal
conversions and vice versa, and looking up pokédex numbers on bulbapedia. The
sequence searcher tool that I built probably already exists. I also thought of
getting an emulator and running a ROM with some flipped bits to confirm my
findings, but I couldn’t bother.&lt;/p&gt;

&lt;p&gt;It bugs me that there’s no proper documentation of this information and that
you have to reverse engineer other people’s reverse engineering projects. I
kind of want to start a documentation project that describes the format of
every known file inside the RomFS of these games. I need to investigate how
people document this kind of things. Maybe I should set up a wiki.&lt;/p&gt;

&lt;p&gt;I’m also a bit clueless about the legality of all of this, to be honest. I own
every game that I mentioned here, but I didn’t name most projects I relied on
on purpose, to avoid shedding any unwanted light on them. You can easily find
them by searching for any file formats or keywords I used anyway.&lt;/p&gt;

&lt;p&gt;I’m not sure if any of this will end up on Veekun, or if it’ll be used by
PkmnCards, but I had fun working on it nonetheless.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;


    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2021-08-01:/articles/status-update-2021-07-31.html</id>
    <title type="html">Status update, July 2021</title>
    <published>2021-08-01T00:00:00Z</published>
    <updated>2021-08-01T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/status-update-2021-07-31.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;I spent most of July playing with computer vision stuff in rust, but also managed to get some work done on Cyberscore. I didn’t touch F-Zero Central this month.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;I spent most of July playing with computer vision stuff in rust, but also
managed to get some work done on Cyberscore. I didn’t touch F-Zero Central this
month.&lt;/p&gt;

&lt;h2 id=&quot;cyberscore&quot;&gt;Cyberscore&lt;/h2&gt;

&lt;p&gt;The biggest change this month on cyberscore is that we’re now email-capable
again! It took a while to get AWS SES to grant us production access, but it’s
working. It also meant I had to add composer to get the AWS SDK package
installed, so that’s progress. I also added &lt;code&gt;twig&lt;/code&gt; to render the email templates,
so maybe I’ll end up reusing it for the actual website page templates.&lt;/p&gt;

&lt;p&gt;The other significant thing I added was a JSON view to some pages. This was
requested by someone working on a Discord bot for New Pokémon Snap scores, and
it might see some changes in the future.&lt;/p&gt;

&lt;p&gt;Finally, I removed a bunch of explicitly unused code (&lt;code&gt;attic/&lt;/code&gt; directory):&lt;/p&gt;

&lt;p&gt;&lt;code&gt;
$ git diff master@{&quot;1 month ago&quot;} --shortstat
316 files changed, 4338 insertions(+), 40417 deletions(-)
&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;I’m currently working on understanding the details of every scoreboard, trying
to.. formalize its structure? The calculations related to each scoreboard are
spread over multiple files by funcionality instead of by scoreboard, making it
a bit hard to add new scoreboards.&lt;/p&gt;

&lt;h2 id=&quot;computer-vision-and-speaking-at-rustconf&quot;&gt;Computer vision and speaking at Rustconf&lt;/h2&gt;

&lt;p&gt;I mentioned a few months ago that I was digitizing my Pokémon TCG collection.
This month, I started playing around with the idea of automatically detecting
cards from a video stream to make the process easier.&lt;/p&gt;

&lt;p&gt;I built a toy project using rust, and I got accepted to talk about it at
&lt;a href=&quot;https://rustconf.com/schedule/identifying-pok-mon-cards&quot;&gt;RustConf 2021&lt;/a&gt;!
The conference will be on September 14th.&lt;/p&gt;

&lt;p&gt;The code is available on &lt;a href=&quot;https://github.com/hugopeixoto/ptcg-detection/&quot;&gt;my github
account&lt;/a&gt;, but it’s pretty
undocumented and experiment-y. I started by using a few crates with basic
algorithms but ended up writing them myself to tweak and adapt them.&lt;/p&gt;

&lt;p&gt;I didn’t bother to document anything yet, but I’ve uploaded some images of the
inner workings of the algorithm if you want to see some pretty pictures:
&lt;a href=&quot;https://hugopeixoto.net/pokemon/detection/&quot;&gt;https://hugopeixoto.net/pokemon/detection/&lt;/a&gt;&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2021-06-30:/articles/status-update-2021-06-30.html</id>
    <title type="html">Status update, June 2021</title>
    <published>2021-06-30T00:00:00Z</published>
    <updated>2021-06-30T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/status-update-2021-06-30.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;I got F-Zero Central working again, licensed its code under AGPL, and did some minor features on Cyberscore. Also, I’ve been playing Mindustry, you should give it a try.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;h2 id=&quot;f-zero-central&quot;&gt;F-Zero Central&lt;/h2&gt;

&lt;p&gt;After bringing the website back up, I worked on making it possible for existing
players to reset their passwords, logging in, and submitting new times.&lt;/p&gt;

&lt;p&gt;Time submission took a bit longer than I expected because we have a bunch of
tables that cache several scores and rankings that needed to be recalculated.
This used to be done as a cron job because it took too long to do inline, but I
was able to make it fast enough. It took me a while to understand what each
table represented and to figure out the formulas from the code and FAQ, but it
seems to be working.&lt;/p&gt;

&lt;p&gt;Part of the good news is, the code is now licensed under AGPL, and it’s
available here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/fzerocentral/fzerocentral&quot;&gt;https://github.com/fzerocentral/fzerocentral&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;cyberscore&quot;&gt;Cyberscore&lt;/h2&gt;

&lt;p&gt;The most visible thing I did this month was to rewrite the login, registration
and password recovery pages to be mobile friendly. Apart from that, I worked on
improving the way we do html escaping. Some old translation strings were being
stored in escaped form, and some functions like &lt;code&gt;GetGameName&lt;/code&gt; was also
returning an already escaped string. I normalized the database and moved all
escaping to the html templates. These were all detected thanks to an effort to
translate the website to japanese, given all the influx of New Pokémon Snap
submissions from japanese players.&lt;/p&gt;

&lt;p&gt;During fzero’s rewrite, I added a migration system. I want to port it to
cyberscore, we’ve been doing some changes to the database and it’s kind of
troublesome to keep everyone in sync without one.&lt;/p&gt;

&lt;h2 id=&quot;personal-infrastructure&quot;&gt;Personal infrastructure&lt;/h2&gt;

&lt;p&gt;I have a bunch of HDDs in my desktop that are not encrypted. I started moving
files around to get those disks empty so I can format them, but it’s taking
forever. When emptying one disk, I decided to create at least two copies on
different disks to improve my redundancy. This means I need to have a lot of
free space available to move everything around, so this doubles the time it
takes to empty a disk.&lt;/p&gt;

&lt;p&gt;Every time I make a new copy, I double check that everything was copied
successfully with a sha1sum:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;find . -type f -print0 |
  LC_ALL=C sort -z |
  xargs -0 sha1sum |
  tee ../shasums.txt |
  sha1sum
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I never detected any issues when copying files between two disks on the same
machine, but one of my larger disks is in another computer in the network, so
some of the files are being transfered via rsync. I transferred 2.4 TB in one go,
and the checksums didn’t match. There were differences in three files, of sizes
8 GB, 93 GB, and 256 GB.&lt;/p&gt;

&lt;p&gt;I was curious to know how many bits were corrupted, but I didn’t want to make a
trivial diff over the network, since it would require copying all those
gigabytes, so I ended up writing a rust cli tool that would find the
differences between the two using a merkle tree to detect where the errors
were. You can find the source code of &lt;code&gt;netdiff&lt;/code&gt; here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/hugopeixoto/netdiff/&quot;&gt;https://github.com/hugopeixoto/netdiff/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Using this tool, I found that the files had, respectively, 1 bit flip, 2 bit
flips, 4 bit flips. I could just flip those bits to fix the issue, but I’ll
rsync those files again instead.&lt;/p&gt;

&lt;h2 id=&quot;other-stuff&quot;&gt;Other stuff&lt;/h2&gt;

&lt;p&gt;I accidentally discovered &lt;a href=&quot;https://mindustrygame.github.io/&quot;&gt;Mindustry&lt;/a&gt; while
browsing F-Droid for games. It looks great, it’s GPLv3, and I already played it
for more hours than I should. I kind of want to play with setting up a
multiplayer server and playing it on the desktop instead, but it’s probably
better if it stays contained in my phone.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2021-06-01:/articles/status-update-2021-05-31.html</id>
    <title type="html">Status update, May 2021</title>
    <published>2021-06-01T00:00:00Z</published>
    <updated>2021-06-01T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/status-update-2021-05-31.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;Having finished moving, I was able to focus on my tech things again. I worked a lot on &lt;a href=&quot;https://cyberscore.me.uk&quot;&gt;Cyberscore&lt;/a&gt;, and I think I accidentally became part of the development team of &lt;a href=&quot;https://fzerocentral.org&quot;&gt;F-Zero Central&lt;/a&gt;.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;Having finished moving, I was able to focus on my tech things again. I worked a
lot on cyberscore, and I think I accidentally became part of the development
team of &lt;a href=&quot;https://fzerocentral.org&quot;&gt;F-Zero Central&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&quot;f-zero-central&quot;&gt;F-Zero Central&lt;/h2&gt;

&lt;p&gt;After last month’s hack, I started rewriting the website, decoupling the
scoreboards from the phpbb codebase. I wrote &lt;a href=&quot;/articles/tale-of-two-sites.html&quot;&gt;a blog post on the differences
between Cyberscore and F-Zero Central&lt;/a&gt; if
you’re looking for more information on that.&lt;/p&gt;

&lt;p&gt;For now, everything is read only and there’s no forum, but at least there’s
something online: &lt;a href=&quot;https://fzerocentral.org/&quot;&gt;F-Zero Central&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I’m currently working on adding login support. I’d like to enable submitting
scores ASAP to get people using the website again. Since this codebase was
written mostly from scratch, it can probably be open sourced without any fears
of leaking hardcoded passwords or exposing a bunch of vulnerabilities.&lt;/p&gt;

&lt;h2 id=&quot;cyberscore&quot;&gt;Cyberscore&lt;/h2&gt;

&lt;p&gt;After getting something online in FZC, I felt more comfortable working on
Cyberscore again. I rewrote some more pages and deleted a bunch of code:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;git diff master@{&quot;1 month ago&quot;} --shortstat
&lt;/span&gt; 134 files changed, 5403 insertions(+), 13021 deletions(-)
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Most of the deletions come from the rewritten comment system. It had 6 nested
loops with a bunch of duplicated markdown in each of them just so we could
render six levels of replies. Then, the whole thing was copy pasted around
everywhere we had comments (user profiles, news articles, blog posts, game
requests).&lt;/p&gt;

&lt;p&gt;I also deleted some developer tools like a builtin SQL explorer. It was useful
sometimes, but it was thanks to that that the whole database got deleted, the
last time. I don’t think these tools belong in a codebase in this state.&lt;/p&gt;

&lt;p&gt;I’ve also improved the mobile experience. The header and footer of every page
are now responsive, and the homepage was also redesigned.&lt;/p&gt;

&lt;p&gt;As for the plans to open source this codebase, I’m pretty confident that there
are a bunch of vulnerabilities on the website — SQL injection, mass
assignment-like problems, missing authorization checks, etc — that I was
trying to fix before releasing the code, but there’s still so much to go. I’ve
converted around 8k lines of code, but the &lt;code&gt;/public/&lt;/code&gt; directory still has 22k
lines that need converting.&lt;/p&gt;

&lt;h2 id=&quot;personal-infrastructure&quot;&gt;Personal infrastructure&lt;/h2&gt;

&lt;p&gt;Now that I’ve moved to a new apartment, I’ve started using my desktop computers
again. I don’t want to deal with wifi for these devices, so I needed to get
some ethernet cables. Instead of getting a bunch of different sized ones, I got
a 25 meter one and started crimping some custom cables.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/articles/crimping-cables.jpg&quot; alt=&quot;
Two pictures: First, a Cat6 cable without shielding on the tip, with the eight
colored wires spreading out. Second, the same cable with a connector head
installed
&quot; id=&quot;crimping&quot; /&gt;&lt;/p&gt;

&lt;p&gt;It was the first time I did this, so it took me a while to get used to it. I
used &lt;a href=&quot;https://manpages.debian.org/testing/iperf/iperf.1.en.html&quot;&gt;&lt;code&gt;iperf&lt;/code&gt;&lt;/a&gt; to make sure that the cable was working OK. Not sure what
else to test tbh, if the bandwidth is close to gigabit, I guess it’s fine?&lt;/p&gt;

&lt;p&gt;I’ve also installed a pair of &lt;a href=&quot;https://en.wikipedia.org/wiki/Disk_enclosure#Hard_drive_shucking&quot;&gt;shucked&lt;/a&gt; 12TB hard drives that I
bought a year ago (before the price hike, thankfully). The only disks that I
tended to encrypt were the main OS ones, not the extra ones where I keep random
files. I’m currently changing this and encrypting every hard disk I have. It’s
a whole process, because I have to move files around so I can scrub and
reformat every disk.&lt;/p&gt;

&lt;p&gt;Another thing I started doing was running &lt;a href=&quot;https://syncthing.net/&quot;&gt;syncthing&lt;/a&gt; on my phone
and on my desktop, so I could sync the pictures I take there automatically.
I’ve set the desktop folder to be receive only and to &lt;a href=&quot;https://docs.syncthing.net/advanced/folder-ignoredelete.html&quot;&gt;ignore
deletions&lt;/a&gt;, so I can free space from my phone knowing that I have
a copy of the pictures somewhere else.&lt;/p&gt;

&lt;p&gt;I have a second computer around that I used to use for backups, but it was
shutdown for a couple of years. I finally managed to turn it back on again and
update everything. I had to ship the debian GPG keys from my laptop there, it
was so old that the keys it had were expired. I’m looking into installing
&lt;a href=&quot;https://restic.net/&quot;&gt;restic&lt;/a&gt; on it so I can automate offsite backups of Cyberscore and
F-Zero Central.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;


    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2021-05-24:/articles/tale-of-two-sites.html</id>
    <title type="html">Tale of two sites</title>
    <published>2021-05-24T00:00:00Z</published>
    <updated>2021-05-24T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/tale-of-two-sites.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;Cyberscore and F-Zero central are two video game related websites that I help maintain. I used two different approaches when I started working on them, and in this post I’ll go through these methodologies.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;Last month, two video game related websites, &lt;a href=&quot;https://cyberscore.me.uk&quot;&gt;Cyberscore&lt;/a&gt; and
&lt;a href=&quot;https://fzerocentral.org&quot;&gt;F-Zero Central&lt;/a&gt;, were breached. &lt;a href=&quot;/articles/status-update-2021-04-30.html&quot;&gt;I wrote about it in last month’s
report&lt;/a&gt;. I’ve been helping out Cyberscore for a while now, and I
started helping the F-Zero Central staff since the hack.&lt;/p&gt;

&lt;p&gt;These two sites are kind of similar in functionality, but my approach when I
started working on them was quite different.&lt;/p&gt;

&lt;h2 id=&quot;cyberscore&quot;&gt;Cyberscore&lt;/h2&gt;

&lt;p&gt;Cyberscore is a frameworkless PHP website, of roughly 45k lines of code.
There’s also a Simple Machines forum installation, but the codebases are
independent, so we can upgrade the forum without breaking the main website’s
functionality. Cyberscore doesn’t use any templating engine, ORM or routing
library.&lt;/p&gt;

&lt;p&gt;When I started working on it, I started by making some small fixes to get the
website to a stable place. There were some cron jobs that were bringing the
website to a halt. When things started being stable, I started fixing bugs, but
more weird things kept popping up. At this point, the dev team discussed
rewriting the whole thing from scratch.&lt;/p&gt;

&lt;p&gt;I started a Laravel project but didn’t get very far. The website is just too
big to rewrite in one go. There’s no documentation except for some code
comments here and there, so it was hard to start building the data model to
cover the existing functionality. It would take months to get to a place where
we’d be able to deploy it, so I ditched the idea and started doing incremental
changes in the existing codebase instead.&lt;/p&gt;

&lt;p&gt;The first changes were on the directory structure. I moved every php file to
&lt;code&gt;/public/&lt;/code&gt; and pointed the http root to it instead of pointing to the root
repository, so we would stop exposing other files (like &lt;code&gt;/.git/&lt;/code&gt;) to the web.
Files that felt like experiments or files that were accidentally duplicated via
FTP were all moved to &lt;code&gt;/attic/&lt;/code&gt;, for later reference or deletion. Extracted
some configurations to a git ignored &lt;code&gt;/config.ini&lt;/code&gt; so that things like the
database password wouldn’t be tracked by git. Added a simple router so that the
new code could be extracted to &lt;code&gt;/src&lt;/code&gt; instead of &lt;code&gt;/public&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Then, I added a few helpers for things like accessing the database with
prepared statements, html helpers to generate forms, etc. Whenever I had to
touch a page to fix something, I’d rewrite it to make use of these helpers and
moved it to &lt;code&gt;/src/pages/&lt;/code&gt;, extracting the HTML part to &lt;code&gt;/src/templates/&lt;/code&gt;. I
still haven’t covered half the website, but this way I can track which files
have been converted to the new helpers.&lt;/p&gt;

&lt;p&gt;The hardest part has been dealing with the database. There are a bunch of
integer enums whose values aren’t documented anywhere, there’s no foreign key
enforcing so we have a ton of dangling references, there are many cache tables
and columns which are hard to identify, and sometimes sql and html escaping is
applied in the database instead of being applied when rendering. Sometimes I
have to spend hours going through the code, discord logs, and gitlab issues to
understand what’s up with the database.&lt;/p&gt;

&lt;p&gt;If I had gone the rewrite route, I’d have to do all of this work upfront, and I
would probably still be working on the rewrite right now. By working
incrementally, I can stop working on cyberscore any time and the community
still benefits from my work until then.&lt;/p&gt;

&lt;p&gt;Maybe when I’ve converted every page I can start working on adding proper
templates and an ORM. Then I can start thinking about converting it to a
Laravel project, but I’m still too far away from that to think about all the
steps.&lt;/p&gt;

&lt;h2 id=&quot;f-zero-central&quot;&gt;F-Zero Central&lt;/h2&gt;

&lt;p&gt;F-Zero Central is built on top of a quite old phpbb forum, with around 17k
lines of code added. The custom pages are heavily dependant on the forum
codebase, relying on it for html templates, sql queries, and user
authentication. I joined the project to help with the forum hack. The plan was
to upgrade phpbb from 2.x to 3.x, fix whatever would be broken, and be done
with it.&lt;/p&gt;

&lt;p&gt;Unfortunately, the migration wasn’t easy. There’s no upgrade button from the
2.x version. You have to setup a 3.x and import the data from the other
database. This part took me a while to get right, mostly due to &lt;code&gt;latin1&lt;/code&gt; vs
&lt;code&gt;utf8&lt;/code&gt; problems, and the presence of multiple users with the same username.
When I got that right, I could see the posts, but the new phpbb doesn’t support
HTML posts, which is what we were using, so every post was a bunch of HTML. I’d
have to find a way to convert it to bbcode, and some posts are not
representable in bbcode.&lt;/p&gt;

&lt;p&gt;The templates/styles structure also changed, so that’s another thing I’d have
to convert. Even if I left the forum using the default theme, our custom pages
rely on the templates, so I’d have to convert at least part of the styles to
get the website working. The phpbb functions used by the custom pages also
changed, so I’d have to rewrite every custom page to use the new functions.
Basically, I’d have to rewrite the custom pages anyway.&lt;/p&gt;

&lt;p&gt;By now, almost two weeks had passed since we took the website down, so I
decided to take a different approach. I wanted to get something working to
signal the community that we were working on it. Having a “we’re down” page for
months won’t do anyone any good.&lt;/p&gt;

&lt;p&gt;I installed &lt;a href=&quot;https://twig.symfony.com/&quot;&gt;&lt;code&gt;twig&lt;/code&gt;&lt;/a&gt;, which is what phpbb 2.x uses, and started rewriting
some pages from scratch. I focused on displaying existing scoreboard
information first, ignoring sign in and registrations. I copied over parts of
the templates but took the time to rewrite them to use css grids, background
gradients and radius borders instead of nesting tables and using images.&lt;/p&gt;

&lt;p&gt;Most pages I converted follow the same structure: read and sanitize query
params, make some SQL queries, transform and pass the data over to a template
and render it. Some of them also read data from XML files. These contain the
information of each game, things like cups and courses. Dealing with these
files was the weirdest thing I had to deal with while working on this project,
even using &lt;a href=&quot;https://www.php.net/manual/en/function.simplexml-load-file.php&quot;&gt;&lt;code&gt;simplexml_load_file&lt;/code&gt;&lt;/a&gt;. I copied over some
database handling functions from cyberscore, and since I didn’t have to deal
with authentication, I didn’t depend on any phpbb code.&lt;/p&gt;

&lt;p&gt;The end result doesn’t look exactly how it looked before, and it’s missing a
lot of information and details, but my priority was to get something live so
that the website didn’t look dead. It was way easier to rewrite the pages than
to deal with all the phpbb cruft. Now I can add things back slowly without the
pressure of losing community interest.&lt;/p&gt;

&lt;p&gt;I’m still not sure what I’m going to do with the forum, but at least folks can
view their record times and their scoreboard positions. I’m working on allowing
users to sign in and submit new records. I will probably end up converting the
XML files to either JSON or YAML.&lt;/p&gt;

&lt;h2 id=&quot;conclusions&quot;&gt;Conclusions&lt;/h2&gt;

&lt;p&gt;Rewriting a project from scratch, if you have to achieve feature parity to get
it live, doesn’t work for me. This is particularly true if you’re working on a
voluntary project like these two, where it’s usually hard to find motivation to
work and contributions are scarse.&lt;/p&gt;

&lt;p&gt;I have a preference for improving existing codebases instead of writing things
from scratch. I find it more interesting to move things around and trying to
understand how things work and what their intention was, rather than being
faced with a blank canvas, and having to make a bunch of boring decisions
upfront, like which framework to use, what CSS model, etc. But sometimes the
rewrite is the right option.&lt;/p&gt;

&lt;p&gt;I just take whichever approach gets me visible results faster, even if I have
to deal with non ideal codebases.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;


    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2021-05-05:/articles/status-update-2021-04-30.html</id>
    <title type="html">Status update, April 2021</title>
    <published>2021-05-05T00:00:00Z</published>
    <updated>2021-05-05T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/status-update-2021-04-30.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;April is over, and so are my current consulting gigs. I moved to a new apartment and had to deal with two security breaches.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;Most of my month was spent packing things and moving them to the new place.
Unfortunately, this was also the month where two websites that I help maintain
were hacked, so I had to deal with that.&lt;/p&gt;

&lt;h2 id=&quot;ink-upgradeability-gig&quot;&gt;ink! upgradeability gig&lt;/h2&gt;

&lt;p&gt;During the review process, it came up that the testing process should be
automated. I spent a couple of days working on this
(&lt;a href=&quot;https://github.com/trustfractal/ink-upgrade-template/pull/2&quot;&gt;https://github.com/trustfractal/ink-upgrade-template/pull/2&lt;/a&gt;) and afterwards
the project was accepted.&lt;/p&gt;

&lt;h2 id=&quot;alumniei-mentorados&quot;&gt;AlumniEI Mentorados&lt;/h2&gt;

&lt;p&gt;We had a pending PR to deal with dark/light/system theme toggling. The user
preferences were being persisted, but there was no effect on the CSS, so I
finished implementing it. I also implemented language detection based on
&lt;code&gt;Accept-Language&lt;/code&gt; (&lt;a href=&quot;https://github.com/alumniei/mentorados/pull/21&quot;&gt;https://github.com/alumniei/mentorados/pull/21&lt;/a&gt;).&lt;/p&gt;

&lt;h2 id=&quot;cyberscore&quot;&gt;Cyberscore&lt;/h2&gt;

&lt;p&gt;On April 24th, a group of people joined our discord and started bragging that the
website was now theirs. They had found a way to login as any user. Since no one
from the staff team was online at the time, they got no attention so they
started escalating the damage and eventually found a way to our builtin SQL
editor and dropped every database table.&lt;/p&gt;

&lt;p&gt;When I found this, the website was non-functional, so I shut down apache and
started looking for the vulnerability. Our logging capabilities are
non-existent, so I had to rely mostly on the discord chat and apache logs to
find what had happened. The attackers had used the live search to find a user
that they wanted to harass, so I was able to track their IP addresses and grab
their history of HTTP requests.&lt;/p&gt;

&lt;p&gt;From their request history, I was able to find a pattern in which the attackers
accessed the forgot password pages, went through all the steps, and ended up in
the &lt;code&gt;/user/:id&lt;/code&gt; page, with a different id every time. This pointed to the
vulnerability being in the “forgot password” functionality. Running the site
locally, I tried to recover the password of a random user, and one of the steps
is to either answer a secret question or enter a code that was sent to the
user’s email. I tried leaving that field blank, and the website let me proceed
to change the user’s password.&lt;/p&gt;

&lt;p&gt;Going through the code to find the problem, I found this (reformatted for clarity):&lt;/p&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$p_verification&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$vanswer&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$p_verification&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$_SESSION&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;authed&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;n&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;db_close&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;header&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Location: resetpass_2.php?err=wrong&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;exit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// proceed to the next step&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The surrounding &lt;code&gt;if&lt;/code&gt; statement is the cause of the vulnerability. Removing it
fixes the immediate problem. It had been there for years, it’s kind of
surprising that it had only been found now.&lt;/p&gt;

&lt;p&gt;I ended up rewriting the whole thing, only allowing recovery via email code
(and not via secret question), and fixed a few other vulnerabilities in the
process.&lt;/p&gt;

&lt;p&gt;Unfortunately, we don’t have automated backups, and the last backup I had made
was from the beginning of March, so we lost practically two months of data
(around 11k submissions).&lt;/p&gt;

&lt;p&gt;This was a very low effort exploit, dropping tables wasn’t that damaging. They
could’ve compromised the server, or deleted the image proofs, which were not
backed up at the time.&lt;/p&gt;

&lt;p&gt;My next step is to automate the backup process and probably remove the builtin
SQL editor. It’s handy for folks who are not used to dealing with SSH, but it
creates a huge hole in the website.&lt;/p&gt;

&lt;h2 id=&quot;f-zero-central&quot;&gt;F-Zero Central&lt;/h2&gt;

&lt;p&gt;&lt;a href=&quot;https://fzerocentral.org&quot;&gt;F-Zero Central&lt;/a&gt; is a community with leaderboards,
world record tracking and forums around the F-Zero games. I don’t maintain the
website, but I did help them migrate servers in the past with some ansible
automation. It’s a PHPBB installation with some extra pages and other tweaks.&lt;/p&gt;

&lt;p&gt;On April 18th, the website’s front page was replaced with one of those generic
“HaCkEd By &amp;lt;xxx&amp;gt;” messages. The PHPBB installation is super old (it’s still
running 2.x), so there are probably a lot of known exploits.&lt;/p&gt;

&lt;p&gt;I’m working on upgrading it to PHPBB 3.3. Not sure if we’ll restore the website
before the upgrade is complete, but this will probably take a while.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2021-04-06:/articles/status-update-2021-03-31.html</id>
    <title type="html">Status update, March 2021</title>
    <published>2021-04-06T00:00:00Z</published>
    <updated>2021-04-06T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/status-update-2021-03-31.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;March is done, and I’m almost finished with the consulting gigs I have planned.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;During March I finished and submitted the ink upgradeability project for
review, struggled with linux to play pokémon TCG online, and spent some time
looking for a new apartment.&lt;/p&gt;

&lt;h2 id=&quot;ink-upgradeability-gig&quot;&gt;ink! upgradeability gig&lt;/h2&gt;

&lt;p&gt;I’ve submitted the project for evaluation, and already got some requests for
change: &lt;a href=&quot;https://github.com/w3f/Grant-Milestone-Delivery/pull/126&quot;&gt;https://github.com/w3f/Grant-Milestone-Delivery/pull/126&lt;/a&gt;. I’ll be
working to close this during April.&lt;/p&gt;

&lt;h2 id=&quot;pokmon-tcg&quot;&gt;Pokémon TCG&lt;/h2&gt;

&lt;p&gt;I casually returned to the pokémon TCG world. There’s a digital version, so I
&lt;a href=&quot;https://hugopeixoto.net/articles/playing-ptcgo-using-wine-docker-wayland.html&quot;&gt;got it running on Debian&lt;/a&gt;. I also started to digitize my collection,
and made a website to check what I’m missing:
&lt;a href=&quot;https://hugopeixoto.net/pokemon/tcg/missing.html&quot;&gt;https://hugopeixoto.net/pokemon/tcg/missing.html&lt;/a&gt;. This is a generated static
website and a scraper to get all of the images and sets. My git repository
currently mixes both the code and the data, so I can’t publish it yet, but I’ll
try to split it soon.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;


    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2021-03-30:/articles/playing-ptcgo-using-wine-docker-wayland.html</id>
    <title type="html">Playing Pokémon TCG online using wine, docker, and wayland</title>
    <published>2021-03-30T00:00:00Z</published>
    <updated>2021-03-30T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/playing-ptcgo-using-wine-docker-wayland.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;I’ve recently restarted playing Pokémon TCG, and wanted to try the online version. Since there’s no Linux support, I had to try my luck with wine in a docker container. Had some issues getting it to work under wayland, but eventually managed to get everything working.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;Back in the early 2000s, I used to play &lt;a href=&quot;https://tcg.pokemon.com/en-us/&quot;&gt;Pokémon TCG&lt;/a&gt; (Base to Neo? I
don’t think there was any competitive play back then). I remember using a deck
built around a &lt;a href=&quot;https://bulbapedia.bulbagarden.net/wiki/Kabutops_(Neo_Discovery_6)&quot;&gt;neo discovery Kabutops&lt;/a&gt; that was wasn’t very good
but managed to win some games at the local league.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/articles/kabutops-nd6.jpg&quot; alt=&quot;
Kabutops from Neo Discovery. A stage 2 Pokémon, with 90 HP, with an attack
Hydrocutter: Flip a number of coins equal to the number of Energy cards
attached to Kabutops. This attack does 40 damage times the number of heads. You
can&#39;t flip more than 3 coins this way
&quot; id=&quot;kabutops&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I didn’t touch the TCG again until Sun &amp;amp; Moon came out (2017). I played at a
theme deck tournament for a couple of weeks and attended a prerelease event for
the Guardians Rising set, but I had no time or the motivation to participate in
competitive play, so I stopped playing again. This month a new set came out
(Battle Styles), and I conviced a friend to get a prerelease kit and play some
games with me. One thing led to another, and I started buying singles and
building a few casual decks.&lt;/p&gt;

&lt;p&gt;Thanks to the pandemic, most of the TCG events have been cancelled or moved
online. There’s an official client, &lt;a href=&quot;https://www.pokemon.com/us/pokemon-tcg/play-online/&quot;&gt;Pokémon TCG Online (ptcgo)&lt;/a&gt;,
available for windows, mac, ipad, and android tablets. Since I don’t have any
device running any of those systems, I decided to try my luck with wine.&lt;/p&gt;

&lt;p&gt;I had managed to get this to working with wine before, but I was using X
instead of wayland at the time, and this time I wanted to get it working in a
docker container so I could easily port this to another computer.&lt;/p&gt;

&lt;p&gt;I started all in, trying to get wine running under docker with wayland, but
things weren’t working and I was having trouble figuring out where the problems
where coming from, so I went back to basics and installed it in the host system
instead of docker, and using xwayland. Everything worked fine with the
exception of &lt;a href=&quot;https://appdb.winehq.org/objectManager.php?sClass=version&amp;amp;iId=30004&quot;&gt;some known bugs&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;After doing some research, I found that wine doesn’t support wayland, but folks
from Collabora [announced an experimental wayland driver][collabora] in
December, so I tried to make that work. Since I had to compile wine from
source, I tried to compile it without wayland support first just to make sure
that any problems that came up were from the wayland driver and not from me not
knowing how to compile wine.&lt;/p&gt;

&lt;p&gt;Wine has to be compiled twice: once for 64 bits support and once for 32 bits.
Without the 32 bit version, explorer.exe worked fine, but the pokémon installer
would hang waiting on a file descriptor for something. Once I had both versions
compiled, the installer booted successfully but failed to install. I ran it
again and changed the install path from &lt;code&gt;Pokémon&lt;/code&gt; to &lt;code&gt;Pokemon&lt;/code&gt; and it worked,
so I figured I was missing something related to character sets or locales. The
docker image I was using didn’t have locales configured, and setting that to
&lt;code&gt;en_US.UTF-8&lt;/code&gt; solved the problem.&lt;/p&gt;

&lt;p&gt;I had to tweak the user id and user groups to get video and audio working, but
I was able to get the game running. You can find the dockerfile here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://gist.github.com/hugopeixoto/c55eebafa7be705e25b85aafe7dde742&quot;&gt;https://gist.github.com/hugopeixoto/c55eebafa7be705e25b85aafe7dde742&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;And this is how I’m running it:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;docker run -it --rm \
  --device=/dev/snd:/dev/snd \
  --device=/dev/dri/card0:/dev/dri/card0 \
  --device=/dev/dri/renderD128:/dev/dri/renderD128 \
  -v /run/user/1000:/run/user/1000 \
  -v $(pwd):/hostdata \
  ptcgo
&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;wine start &quot;C:\users\hugopeixoto\Desktop/Pokémon Trading Card Game Online.lnk&quot;
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Those three device maps are needed to get audio and graphics working. The
&lt;code&gt;/run/user/&lt;/code&gt; volume can probably be restricted down to &lt;code&gt;wayland-0&lt;/code&gt; and
&lt;code&gt;pulse/&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Curiously, one of the known bugs (“Interface may become unresponsive when the
window lose and regain the focus”) doesn’t happen using wayland. The game
window doesn’t seem to be focused (the title bar is gray instead of blue), so
that’s probably related. The game does crash from time to time when searching
for a match in versus mode, which is kind of annoying, but it doesn’t happen
too often.&lt;/p&gt;

&lt;p&gt;There a few things I’d like to improve on my setup, I still feel some friction
when running the game.&lt;/p&gt;

&lt;p&gt;I can’t run the wine command as the docker entrypoint command because the &lt;code&gt;wine
start&lt;/code&gt; process launches a subprocess and exits, so the docker container would
terminate at launch. This means I have to launch it via the terminal and enter
the command manually, instead of running it via an application launcher. I
probably need a wrapper script to wait on a specific process.&lt;/p&gt;

&lt;p&gt;The game &lt;a href=&quot;https://bugs.winehq.org/show_bug.cgi?id=47441&quot;&gt;crashes when exiting&lt;/a&gt;, which is a bit more
annoying. I have to go to the terminal and terminate the container manually.
The game is written in Unity, and whenever it crashes it spawns a “Unity crash
handler” process, so I guess I could detect its presence on the wrapper script
and exit.&lt;/p&gt;

&lt;p&gt;I have my username and user id hardcoded in the dockerfile. I could probably
provide it in the &lt;code&gt;docker run&lt;/code&gt; command with the &lt;code&gt;--user&lt;/code&gt; flag.&lt;/p&gt;

&lt;p&gt;I installed the application during run time, not during build time, so the
docker image is not enough to run the game in another computer. I’m not sure if
the installer would work headlessly, but the main problem is that I don’t know
how to handle the &lt;a href=&quot;https://wiki.winehq.org/FAQ#Wineprefixes&quot;&gt;wine prefix&lt;/a&gt; directory. Most of the files are
probably static, but I need some persistence between calls to store login
credentials and cached content. I would need to understand which directories
have contents that would have to be persisted between game runs and only volume
mount them. There’s also the fact that the application auto updates itself, and
these updates wouldn’t be persisted. I would have to automate the download of
the installer to make the process easier.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;


    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2021-03-11:/articles/status-update-2021-02-28.html</id>
    <title type="html">Status update, February 2021</title>
    <published>2021-03-11T00:00:00Z</published>
    <updated>2021-03-11T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/status-update-2021-02-28.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;February is long gone, and I worked mostly on Cyberscore and some consulting gigs.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;Oof, this status update is a &lt;em&gt;bit&lt;/em&gt; late. Not sure why I’ve been postponing
writing it, but it’s probably because I spent most of the month doing
consulting work instead of open source stuff.&lt;/p&gt;

&lt;h2 id=&quot;cyberscore&quot;&gt;Cyberscore&lt;/h2&gt;

&lt;p&gt;Some of the issues on our gitlab project mentioned the notifications page:
missing pagination, overlapping buttons on mobile, notifications not firing on
certain conditions. I started tackling these and ended up rewriting the whole
page and system. This is what it looked like before:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/articles/cs-notifications-old.png&quot; alt=&quot;Screenshot of the old Cyberscore notification page, showing overlapping buttons&quot; /&gt;&lt;/p&gt;

&lt;p&gt;And this is the new notifications page:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/articles/cs-notifications.png&quot; alt=&quot;Screenshot of the new Cyberscore notification page, showing read/unread filters&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Besides the UI rewrite, I also changed the internals. The linked information
was stored in arbitrary fields like &lt;code&gt;chart_id&lt;/code&gt;, even if they were user ids or
game ids. This was confusing and prevented us from creating foreign keys, so I
added some more columns to the table.&lt;/p&gt;

&lt;p&gt;I also rewrote the game chart page. This page still requires some work, because
in some games it’s way too wide for mobile, but here’s an example of how it
looks like now:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://cyberscore.me.uk/chart/396221&quot;&gt;https://cyberscore.me.uk/chart/396221&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I also fixed a bunch of small bugs. The issue tracker is now under 100 issues!
We also closed a bunch of old features that we probably won’t tackle anytime
soon, so we’re down to 86 issues.&lt;/p&gt;

&lt;p&gt;I’m currently working on ensuring that the scoreboards are correctly
calculated. There were some bugs that causes scoreboards inconsistencies
between different pages.&lt;/p&gt;

&lt;p&gt;I also improved the time to rebuild the caches (again). I had worked on
optimizing the game scoreboard caches, but this time went even further. These
are the current times:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;13 minutes to rebuild every chart cache&lt;/li&gt;
  &lt;li&gt;5 minutes to rebuild every game scoreboard cache&lt;/li&gt;
  &lt;li&gt;10 seconds to rebuild every global scoreboard cache&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;This means we can do a full site rebuild in less than 20 minutes, while before
it took hours. I’ll probably issue a full rebuild this week, since there are
some charts that are probably using an old formula.&lt;/p&gt;

&lt;h2 id=&quot;hedgedoc&quot;&gt;HedgeDoc&lt;/h2&gt;

&lt;p&gt;I did some maintainer work on this, but nothing big. Mostly readme updates and
reviewing existing PRs:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/hedgedoc/container/pull/161&quot;&gt;https://github.com/hedgedoc/container/pull/161&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/hedgedoc/container/pull/159&quot;&gt;https://github.com/hedgedoc/container/pull/159&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;There’s currently some discussion going on regarding the structure of the
container repository, and whether or not it should be merged with the backend
repo:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/hedgedoc/container/issues/160&quot;&gt;https://github.com/hedgedoc/container/issues/160&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;tokenio-consulting-gig&quot;&gt;Token.io consulting gig&lt;/h2&gt;

&lt;p&gt;I had to spend some time in February fixing bugs and deploying this to
production. It’s now over.&lt;/p&gt;

&lt;h2 id=&quot;ink-upgradeability-gig&quot;&gt;ink! upgradeability gig&lt;/h2&gt;

&lt;p&gt;I started working on this during February. I wrote a small &lt;a href=&quot;/articles/setting-up-an-ink-development-environment.html&quot;&gt;post on my
experience setting up the development environment&lt;/a&gt;, and I have a
template kind of working at
&lt;a href=&quot;https://github.com/trustfractal/ink-upgrade-template&quot;&gt;https://github.com/trustfractal/ink-upgrade-template&lt;/a&gt;. This week I’ll start
cleaning it up, figure out how to handle authorization and write a post on how
to add upgradeability to your ink! contract, with all the caveats.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;


    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2021-02-18:/articles/setting-up-an-ink-development-environment.html</id>
    <title type="html">Setting up an ink! development environment</title>
    <published>2021-02-18T00:00:00Z</published>
    <updated>2021-02-18T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/setting-up-an-ink-development-environment.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;I’m working on bringing upgradeability to ink! smart contracts, so this post describes how I setup my ink! development environment.&lt;/p&gt;
]]>
    </summary>
    <content type="html">
      <![CDATA[
        <aside>
          This is a <code>[journal]</code> entry. It is longer than usual and
          more exploratory. It may have no proper conclusion.
        </aside>
      ]]>

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;I’m currently working on bringing upgradeability to &lt;a href=&quot;https://paritytech.github.io/ink/&quot;&gt;ink! smart
contracts&lt;/a&gt;, as part of &lt;a href=&quot;https://github.com/w3f/Open-Grants-Program/pull/238&quot;&gt;this grant proposal&lt;/a&gt;. This post will
contain the steps it took me to get things up and running.&lt;/p&gt;

&lt;p&gt;The first thing I did was to stop using &lt;a href=&quot;https://asdf-vm.com/&quot;&gt;asdf&lt;/a&gt; for rust. I enjoy using it
for things like ruby and nodejs, but using it for rust nightly has not been
great. Every time I want to bump to a more recent nightly version I end up
having to reinstall all of my rust tools. &lt;a href=&quot;https://rustup.rs/&quot;&gt;rustup&lt;/a&gt; is the recommended
tool anyway, so I decided to give it a try. The rustup installation is kind
enough to provide me information on which paths and environment variables it
uses, so I was able to configure those before proceeding.&lt;/p&gt;

&lt;p&gt;To setup an &lt;code&gt;ink!&lt;/code&gt; environment, I followed almost to the letter the setup in
their &lt;a href=&quot;https://substrate.dev/substrate-contracts-workshop/&quot;&gt;recommended tutorial&lt;/a&gt;. There is some nightly vs stable
confusion in the instructions. Since I don’t have the stable toolchain installed,
my installation commands were as follows:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;# &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;apt install clang libclang-dev libz-dev
&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;rustup component add rust-src --toolchain nightly
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;rustup target add wasm32-unknown-unknown --toolchain nightly
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;cargo install canvas-node --git https://github.com/paritytech/canvas-node.git --tag v0.1.4 --force --locked
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;cargo install cargo-contract --vers 0.8.0 --force --locked
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;cargo contract new flipper
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Later they suggest running &lt;code&gt;cargo +nightly test&lt;/code&gt;. Unsure why folks need to
specify &lt;code&gt;+nightly&lt;/code&gt; here, when the other cargo commands didn’t. I’m able to run
&lt;code&gt;cargo test&lt;/code&gt; without any issues.&lt;/p&gt;

&lt;p&gt;Running &lt;code&gt;cargo contract build&lt;/code&gt; outputs a couple of files to &lt;code&gt;target&lt;/code&gt;:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;code&gt;flipper.contract&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;&lt;code&gt;flipper.wasm&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;&lt;code&gt;metadata.json&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;After running the local node with &lt;code&gt;canvas --dev --tmp&lt;/code&gt;, I tried to access it
using &lt;a href=&quot;https://paritytech.github.io/canvas-ui&quot;&gt;https://paritytech.github.io/canvas-ui&lt;/a&gt;. It connects to a test node /
network by default, but changing it to &lt;code&gt;Local Node&lt;/code&gt; worked fine and I was able
to deploy and call functions on my contract.&lt;/p&gt;

&lt;p&gt;Deploying a contract is a two step operation:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Calling &lt;code&gt;put_code&lt;/code&gt; with the wasm blob&lt;/li&gt;
  &lt;li&gt;Calling &lt;code&gt;contract.instantiate&lt;/code&gt; with the code address&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;This was easier than I expected, although the &lt;code&gt;cargo install&lt;/code&gt; steps took
forever.&lt;/p&gt;

&lt;p&gt;Just like in ethereum, the way that calling contract functions works is by
sending a transaction with the deployed contract address and a payload. The
wasm blob will pick the right codepath based on data. For example, when I
called the &lt;code&gt;flip&lt;/code&gt; function on my contract, it sent the data &lt;code&gt;0xc096a5f3&lt;/code&gt;.
Looking at the contract metadata (&lt;code&gt;metadata.json&lt;/code&gt;), I can find that number
under the &lt;code&gt;spec.messages&lt;/code&gt; key:&lt;/p&gt;

&lt;div class=&quot;language-jsonc highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;c1&quot;&gt;// cat target/metadata.json  | jq &#39;.spec.messages[0]&#39;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;args&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[],&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;docs&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot; A message that can be called on instantiated contracts.&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot; This one flips the value of the stored `bool` from `true`&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot; to `false` and vice versa.&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;mutates&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;flip&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;payable&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;returnType&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;selector&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;0xc096a5f3&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Using the &lt;code&gt;canvas-ui&lt;/code&gt; thing, I can call methods either as RPC calls or as
transactions. The next step is to figure out how cross contract calls are made
and how storage is handled.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;


    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2021-02-04:/articles/status-update-2021-01-31.html</id>
    <title type="html">Status update, January 2021</title>
    <published>2021-02-04T00:00:00Z</published>
    <updated>2021-02-04T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/status-update-2021-01-31.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;Cyberscore, cyberscore, cyberscore. January was mostly Cyberscore.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;I spent the first half of the month deep in Cyberscore’s codebase. I also
started working on a couple of consulting gigs.&lt;/p&gt;

&lt;h2 id=&quot;cyberscore&quot;&gt;Cyberscore&lt;/h2&gt;

&lt;p&gt;Last month I started rewriting the pages that seem more problematic, either
code- or layout-wise. This month I split the user settings page from the user
profile page, changed both of their layouts to remove all those scrollbars, and
added proper navigation instead of relying on navigationless AJAX page loads.&lt;/p&gt;

&lt;p&gt;I also started tackling some issues from our tracker. One thing led to another,
and ended up rewriting some pages related to game rules. Game rules are things
like: “Only one controller is permitted”, or “No glitches allowed”. This system
was initially designed to only support one rule text per game level, and when
it was expanded to allow for multiple rule texts not every page was updated to
match that.&lt;/p&gt;

&lt;p&gt;A random bot found an SQL injection attack which brought the website down for a
few minutes, so I had to spend some time tracking it down and fixing the
vulnerability.&lt;/p&gt;

&lt;p&gt;I also did some long due system upgrades. The MySQL server package was in an
un-upgradeable state, because the &lt;code&gt;debian-sys-maint&lt;/code&gt; user had been dropped when
the database was first imported. This was preventing us from upgrading our
packages, so it was important to get that fixed.&lt;/p&gt;

&lt;p&gt;I wrote a blog post on some &lt;a href=&quot;/articles/more-mysql-and-php-findings.html&quot;&gt;php/mysql things I found interesting&lt;/a&gt;
while working on all of this. I wish I could migrate this to either mariadb or,
ideally, postgres, but this project has some queries that rely on weird
behavior and it doesn’t use any database abstraction layer, so that’s probably
going to take a while to happen.&lt;/p&gt;

&lt;h2 id=&quot;random-consulting-gig-1&quot;&gt;Random consulting gig 1&lt;/h2&gt;

&lt;p&gt;The first job, which is probably 90% done, required working on an integration
with &lt;a href=&quot;https://token.io/&quot;&gt;Token&lt;/a&gt;, an open-banking platform. Their docs are, frankly, quite
bad, so I kind of had to jump through some hoops to figure out what was going
on.&lt;/p&gt;

&lt;h2 id=&quot;random-consulting-gig-2&quot;&gt;Random consulting gig 2&lt;/h2&gt;

&lt;p&gt;The second gig consists of figuring out how to bring upgradeability to &lt;a href=&quot;https://substrate.dev/docs/en/knowledgebase/smart-contracts/overview&quot;&gt;ink!
smart contracts&lt;/a&gt;. This was submitted as &lt;a href=&quot;https://github.com/w3f/Open-Grants-Program/pull/238&quot;&gt;an application for the Web3
Foundation Open Grants Program&lt;/a&gt;, so let’s see if it moves forward.&lt;/p&gt;

&lt;p&gt;I was reading through Substrate’s documentation and submitted a few small
fixes:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/substrate-developer-hub/substrate-developer-hub.github.io/pull/828&quot;&gt;FRAME vs FREAME typo&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/substrate-developer-hub/substrate-developer-hub.github.io/pull/831&quot;&gt;Fix broken links related to upgrades&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/substrate-developer-hub/substrate-developer-hub.github.io/pull/832&quot;&gt;Add link to contracts pallet&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;If the proposal is approved, expect a blogpost or two on this topic while I
figure things out.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;


    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2021-01-14:/articles/more-mysql-and-php-findings.html</id>
    <title type="html">More PHP and MySQL findings</title>
    <published>2021-01-14T00:00:00Z</published>
    <updated>2021-01-14T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/more-mysql-and-php-findings.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;As I continue to work on &lt;a href=&quot;https://cyberscore.me.uk&quot;&gt;Cyberscore&lt;/a&gt;, I keep finding new quirks / features in PHP and MySQL.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;As I continue to work on &lt;a href=&quot;https://cyberscore.me.uk&quot;&gt;Cyberscore&lt;/a&gt;, I keep finding
new quirks / features in PHP and MySQL. All of the tests below are being run on
mysql 5.7, unless otherwise noted. This is the version that’s currently being
used by Cyberscore. Maybe one day I’ll be able to migrate this to a recent
MariaDB version.&lt;/p&gt;

&lt;h2 id=&quot;alternative-insert-syntax&quot;&gt;Alternative INSERT syntax&lt;/h2&gt;

&lt;p&gt;Apparently, &lt;a href=&quot;https://dev.mysql.com/doc/refman/8.0/en/insert.html&quot;&gt;mysql supports an alternative insert syntax&lt;/a&gt; that uses
an assignment list instead of value tuples:&lt;/p&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;c1&quot;&gt;-- standard syntax&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;INSERT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;INTO&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tablename&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;col1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;col2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;VALUES&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;val1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;val2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;-- alternative mysql syntax, not standard&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;INSERT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;INTO&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tablename&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;SET&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;col1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;val1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;col2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;val2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;character-set-handling&quot;&gt;Character set handling&lt;/h2&gt;

&lt;p&gt;I was having some trouble running cyberscore locally: a form with Japanese text
was being stored in the database as a bunch of question marks. The codebase
sets everything to UTF-8 by having the following in a startup file:&lt;/p&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;nb&quot;&gt;mb_http_input&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;UTF-8&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;mb_http_output&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;UTF-8&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;mb_internal_encoding&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;UTF-8&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;mb_regex_encoding&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;UTF-8&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;mb_language&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;uni&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;ob_start&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;mb_output_handler&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;nf&quot;&gt;db_query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;SET NAMES utf8&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;nf&quot;&gt;db_query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;SET CHARACTER SET utf8&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;nb&quot;&gt;define&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;CHARSET&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;UTF-8&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There are a some interesting things here. First, we’re executing both &lt;code&gt;SET
NAMES&lt;/code&gt; and &lt;code&gt;SET CHARACTER SET&lt;/code&gt;, which is redundant. Here’s what those two
statements do:&lt;/p&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;SET&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;NAMES&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;-- is equivalent to:&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;character_set_client&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;character_set_connection&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;character_set_results&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;SET&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CHARSET&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;-- results in:&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;character_set_client&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;character_set_connection&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;character_set_database&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;character_set_results&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Both statements set the same variables, so they override each other. We should
only be using one of those two statements. In production,
&lt;code&gt;character_set_database&lt;/code&gt; is set to &lt;code&gt;utf8&lt;/code&gt;, so there’s no difference between
them. On my development environment, even though the tables and columns are all
set to &lt;code&gt;utf8&lt;/code&gt;, the database itself is set to &lt;code&gt;latin1&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;This difference explains why I was getting encoding errors locally, but to
understand what’s going on here, we need to understand what each of those
settings does.&lt;/p&gt;

&lt;p&gt;The first one, &lt;code&gt;character_set_client&lt;/code&gt;, lets the server know what is the
character set of the strings being sent through the socket (after any TLS
processing is done). For example, if a client sends the query &lt;code&gt;select
&#39;pokémon&#39;&lt;/code&gt; in UTF-8, what’s actually being sent down the pipe are the following
bytes:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;12 00 00 00  03 73 65 6C   .....sel
65 63 74 20  39 70 6F 6B   ect &#39;pok
C3 A9 6D 6F  6E 39         ..mon&#39;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The first three bytes are the length of the payload (little endian) and the
fourth byte is the sequence number. The payload begins with a packet identifier
(0x03, in this case), and the query body follows. There’s no indication of
character set, and no null termination. The client lets the server know what
character set it is using during the &lt;a href=&quot;https://dev.mysql.com/doc/internals/en/connection-phase-packets.html#packet-Protocol::HandshakeResponse&quot;&gt;initial connection
handshake&lt;/a&gt;, but it can be changed mid-connection by setting
&lt;code&gt;character_set_client&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;character_set_connection&lt;/code&gt; is the character set of the representation by the
server of the statements sent from the client. For example, if the client sends
the query &lt;code&gt;SELECT HEX(&#39;pokémon&#39;)&lt;/code&gt; via a UTF-8 connection, it may be useful to
have the server interpret that string as being in another character set. Here’s
an example illustrating the difference:&lt;/p&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;SET&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;@@&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;character_set_connection&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;utf8&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;HEX&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;pokémon&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;                         &lt;span class=&quot;c1&quot;&gt;-- =&amp;gt; 706F6BC3A96D6F6E&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;HEX&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;CONVERT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;pokémon&#39;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;USING&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;latin1&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;-- =&amp;gt; 706F6BE96D6F6E&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;SET&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;@@&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;character_set_connection&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;latin1&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;HEX&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;pokémon&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;                         &lt;span class=&quot;c1&quot;&gt;-- =&amp;gt; 706F6BE96D6F6E&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The last command being executed, in my case, was &lt;code&gt;SET CHARACTER SET utf8&lt;/code&gt;. With
&lt;code&gt;character_set_database&lt;/code&gt; set to &lt;code&gt;latin1&lt;/code&gt;, all string literals were being
converted from &lt;code&gt;utf8&lt;/code&gt; to &lt;code&gt;latin1&lt;/code&gt;. Since japanese characters are not
representable in &lt;code&gt;latin1&lt;/code&gt;, they were converted to question marks:&lt;/p&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;SET&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;@@&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;character_set_connection&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;utf8&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;ポケットモンスター&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;-- =&amp;gt; ポケットモンスター&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;SET&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;@@&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;character_set_connection&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;latin1&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;ポケットモンスター&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;-- =&amp;gt; ?????????&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note that &lt;code&gt;INSERT&lt;/code&gt; statements convert any strings from their character set to
the character set of the column they’re being inserted into, so you don’t need
to worry with conversions:&lt;/p&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;TABLE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;encoding_tests&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;name&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;TEXT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CHARSET&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;utf8&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;COLLATE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;utf8_unicode_ci&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CHARSET&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;utf8&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;COLLATE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;utf8_unicode_ci&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;INSERT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;INTO&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;encoding_tests&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;VALUES&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;CONVERT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;pokémon&#39;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;USING&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;latin1&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;HEX&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;encoding_tests&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;-- =&amp;gt; 706F6BC3A96D6F6E&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You can also tell mysql to interpret a sequence of bytes with a given charset
by using &lt;a href=&quot;https://dev.mysql.com/doc/refman/8.0/en/charset-introducer.html&quot;&gt;character set introducers&lt;/a&gt;. I’m not sure what
you’d use this for, but I guess it could be used to transmit UTF-8 data over an
ASCII connection, even if you could use CONVERT and UNHEX to achieve the same effect:&lt;/p&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;c1&quot;&gt;-- connection using --default-character-set=ascii&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;INSERT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;INTO&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;encoding_tests&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;VALUES&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_utf8&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;706F6BC3A96D6F6E&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;HEX&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;encoding_tests&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;     &lt;span class=&quot;c1&quot;&gt;-- =&amp;gt; 706F6BC3A96D6F6E&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;name&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;encoding_tests&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;          &lt;span class=&quot;c1&quot;&gt;-- =&amp;gt; pok?mon&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CHARSET&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;encoding_tests&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;-- =&amp;gt; utf8&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;-- same as:&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;INSERT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;INTO&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;encoding_tests&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;VALUES&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;CONVERT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;UNHEX&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;706F6BC3A96D6F6E&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;USING&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;utf8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Maybe it is useful when you need to send queries with mixed encodings. This
sounds like it could go wrong in many ways, though.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;character_set_database&lt;/code&gt; is the character set used for the storage of new
tables unless it’s being explicitly set:&lt;/p&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;@@&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;character_set_database&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;       &lt;span class=&quot;c1&quot;&gt;-- =&amp;gt; latin1&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;TABLE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;encoding_tests&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;name&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;text&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;table_collation&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;information_schema&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tables&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;WHERE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;table_name&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;encoding_tests&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;-- =&amp;gt; latin1_swedish_ci&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;DROP&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;TABLE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;encoding_tests&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;TABLE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;encoding_tests&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;name&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;text&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;nb&quot;&gt;CHARACTER&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;SET&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;utf8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;table_collation&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;information_schema&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tables&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;WHERE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;table_name&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;encoding_tests&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;-- =&amp;gt; utf8_general_ci&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Finally, &lt;code&gt;character_set_results&lt;/code&gt; is the character set used by the server when
encoding &lt;a href=&quot;https://dev.mysql.com/doc/internals/en/com-query-response.html&quot;&gt;results and metadata being sent back to the
client&lt;/a&gt;. Column values stored in a different character set
will be converted before being sent through the pipe.&lt;/p&gt;

&lt;p&gt;Another thing I bumped into is the fact that MySQL has both a &lt;code&gt;utf8&lt;/code&gt; encoding
and a &lt;code&gt;utf8mb4&lt;/code&gt; encoding. All our tables and columns are using &lt;code&gt;utf8&lt;/code&gt;, which is
limited to codepoints that are encoded using a maximum of three bytes.
Codepoints that require four bytes are not supported. The &lt;code&gt;utf8mb4&lt;/code&gt; type is the
one to use if you want to support the full range.&lt;/p&gt;

&lt;p&gt;Finally, if you’re communicating with MySQL through PHP and you’re using
&lt;code&gt;mysql_real_escape_string&lt;/code&gt;, you shouldn’t send a &lt;code&gt;SET NAMES&lt;/code&gt; or &lt;code&gt;SET CHARACTER
SET&lt;/code&gt; query directly. Instead, use &lt;a href=&quot;https://www.php.net/manual/en/mysqli.set-charset.php&quot;&gt;&lt;code&gt;mysqli_set_character_set&lt;/code&gt; or your
extension’s equivalent&lt;/a&gt;. The escaping function does not
monitor every query being sent, and it does not query the server for the
currently set charset, so it won’t be aware of any changes caused by raw
queries, &lt;a href=&quot;https://www.php.net/manual/en/mysqlinfo.concepts.charset.php&quot;&gt;as noted by PHP’s documentation&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&quot;group-by-limitation&quot;&gt;GROUP BY limitation&lt;/h2&gt;

&lt;p&gt;Consider the following dataset, where we keep track of the date on which each
user joined the website. If we wanted a report on how many users joined each
month, we’d use a GROUP BY statement, grouping by year/month pairs.&lt;/p&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;users&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;----+----------+---------------------+&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;id&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;username&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;date_joined&lt;/span&gt;          &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;----+----------+---------------------+&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;  &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;squirtle&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2020&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;  &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;totodile&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2020&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;15&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;  &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mudkip&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2020&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;20&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;  &lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;piplup&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2021&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;01&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;05&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;  &lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;oshawott&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2021&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;01&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;----+----------+---------------------+&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;COUNT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;YEAR&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;date_joined&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;MONTH&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;date_joined&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;users&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;GROUP&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;BY&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;YEAR&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;date_joined&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;MONTH&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;date_joined&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;----------+-------------------+--------------------+&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;year&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;date_joined&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;month&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;date_joined&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;----------+-------------------+--------------------+&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;        &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;              &lt;span class=&quot;mi&quot;&gt;2020&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;                 &lt;span class=&quot;mi&quot;&gt;12&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;        &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;              &lt;span class=&quot;mi&quot;&gt;2021&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;                  &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;----------+-------------------+--------------------+&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The expressions in the group by statement act like a composite primary key of
the result set. Each column in the result set must either be part of the
primary key, functionally dependent on it, or an aggregate expression.&lt;/p&gt;

&lt;p&gt;In other words, this means that you can’t select columns whose value would be
ambiguous. Take the following query. It would have to return two rows, one for
each year (2020 and 2021). But for each row, there’s more than one username, so
MySQL wouldn’t know which one to pick:&lt;/p&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;COUNT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;YEAR&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;date_joined&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;username&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;users&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;GROUP&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;BY&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;YEAR&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;date_joined&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;-- ERROR 1055 (42000):&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;-- Expression #3 of SELECT list is not in GROUP BY clause and&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;-- contains nonaggregated column &#39;test.users.username&#39; which&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;-- is not functionally dependent on columns in GROUP BY clause;&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;-- this is incompatible with sql_mode=only_full_group_by&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;MySQL is able to detect some more advanced cases. For example, if you group by
a table’s primary key, you’re able to select any other column from that table,
since there won’t be more than one table row per result row:&lt;/p&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;username&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;users&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;GROUP&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;BY&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;----+----------+&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;id&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;username&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;----+----------+&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;  &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;squirtle&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;  &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;totodile&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;  &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mudkip&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;  &lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;piplup&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;  &lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;oshawott&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;----+----------+&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Given all of this, I would expect to be able to make the following query, since
the second column is functionally dependent on the &lt;code&gt;GROUP BY&lt;/code&gt; expressions, but
MySQL doesn’t agree:&lt;/p&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;COUNT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CONCAT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;YEAR&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;date_joined&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;-&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;MONTH&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;date_joined&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;users&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;GROUP&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;BY&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;YEAR&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;date_joined&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;MONTH&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;date_joined&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;-- ERROR 1055 (42000):&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;-- Expression #1 of SELECT list is not in GROUP BY clause and&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;--   contains nonaggregated column &#39;test.users.date_joined&#39; which&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;--   is not functionally dependent on columns in GROUP BY clause;&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;--   this is incompatible with sql_mode=only_full_group_by&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The second column depends on &lt;code&gt;YEAR(date_joined)&lt;/code&gt; and &lt;code&gt;MONTH(date_joined)&lt;/code&gt;, and
both expressions are in the &lt;code&gt;GROUP BY&lt;/code&gt; clause, so in theory this should work.
There’s no ambiguity here. Fortunately there are some ways to work around this:&lt;/p&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;COUNT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CONCAT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;YEAR&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;date_joined&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;-&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;MONTH&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;date_joined&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;users&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;GROUP&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;BY&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CONCAT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;YEAR&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;date_joined&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;-&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;MONTH&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;date_joined&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;-- or&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;COUNT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CONCAT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;YEAR&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;date_joined&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;-&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;MONTH&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;date_joined&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;AS&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;month_joined&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;users&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;GROUP&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;BY&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;month_joined&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I thought that this could have been fixed in a later version of MySQL, but the
result is the same. Both MariaDB and postgresql support this.&lt;/p&gt;

&lt;h2 id=&quot;php-null-coalescing-operator-isset-and-array-access-overloading&quot;&gt;PHP null coalescing operator, isset, and array access overloading&lt;/h2&gt;

&lt;p&gt;In PHP, you can make your classes support the subscript operator by
implementing the &lt;a href=&quot;https://www.php.net/manual/en/class.arrayaccess.php&quot;&gt;ArrayAccess interface&lt;/a&gt;. Here’s a simplified
example that caches translations stored in a database table:&lt;/p&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt;

&lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Translation&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;ArrayAccess&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$cache&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[];&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$locale&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;pt&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;offsetGet&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$offset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;array_key_exists&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$offset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cache&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cache&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$offset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cache&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$offset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
      &lt;span class=&quot;nf&quot;&gt;select&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;text&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;nf&quot;&gt;from&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;translations&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;nf&quot;&gt;where&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;key&#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$offset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;locale&#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;locale&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]);&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;offsetExists&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$offset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;offsetGet&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$offset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cache&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$offset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;offsetUnset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$offset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;cm&quot;&gt;/* noop */&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;offsetSet&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$offset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;cm&quot;&gt;/* noop */&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;$t&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Translation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;hello&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// =&amp;gt; &quot;Olá&quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Initially, we were only implementing &lt;code&gt;offsetGet&lt;/code&gt;, throwing an exception in the
other three methods. This was fine until I tried to use the &lt;a href=&quot;https://www.php.net/manual/en/language.operators.comparison.php#language.operators.comparison.coalesce&quot;&gt;null coalescing
operator&lt;/a&gt;, which raised an exception:&lt;/p&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;h1&amp;gt;&lt;/span&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;?=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;my_games_title&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;??&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;My games&#39;&lt;/span&gt; &lt;span class=&quot;cp&quot;&gt;?&amp;gt;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;/h1&amp;gt;&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;&amp;lt;!-- exception raised in Translation::offsetExists --&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I thought it would only check for &lt;code&gt;NULL&lt;/code&gt; values, but it seems that it actually
uses &lt;code&gt;isset&lt;/code&gt;. &lt;code&gt;isset&lt;/code&gt; doesn’t just check if the variable is set, but also
checks if it’s not null. Also, for expressions such as &lt;code&gt;isset($t[&#39;x&#39;])&lt;/code&gt;, it
returns whatever &lt;code&gt;offsetExists&lt;/code&gt; returns as a boolean:&lt;/p&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;my_games_title&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;??&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;My games&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// this is the same as&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;isset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;my_games_title&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;my_games_title&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;My games&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;$a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$b&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;isset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// =&amp;gt; false&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;isset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// =&amp;gt; true&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;isset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// =&amp;gt; false&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;isset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;hello&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]);&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// this is the same as&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bool&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;offsetExists&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;hello&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;While investigating this behavior, I discovered that PHP supports using the
&lt;a href=&quot;https://www.php.net/manual/en/language.operators.comparison.php#language.operators.comparison.ternary&quot;&gt;“ternary operator” (&lt;code&gt;?:&lt;/code&gt;)&lt;/a&gt; as… a binary operator,
which is similar to &lt;code&gt;??&lt;/code&gt; but using &lt;code&gt;!empty&lt;/code&gt; instead of &lt;code&gt;isset&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;my_games_title&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;?:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;My games&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// this is the same as&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;empty&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;my_games_title&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;my_games_title&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;My games&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;


    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2021-01-05:/articles/status-update-2020-12-31.html</id>
    <title type="html">Status update, December 2020</title>
    <published>2021-01-05T00:00:00Z</published>
    <updated>2021-01-05T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/status-update-2020-12-31.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;The last status update of 2020.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;2020 is over! It was a different year in many aspects. I started doing these
monthly updates when I stopped working full time, inspired by &lt;a href=&quot;https://drewdevault.com/2020/12/15/Status-update-December-2020.html&quot;&gt;Drew DeVault’s
status
updates&lt;/a&gt;.
It’s been a useful way of tracking the passing of time, it keeps me aware that
I should at least try to accomplish something each month, even if it’s working
on a useless personal project. Some months were more productive than others,
and that needs to be OK.&lt;/p&gt;

&lt;h2 id=&quot;advent-of-code&quot;&gt;Advent of Code&lt;/h2&gt;

&lt;p&gt;I spent most of the month obsessing over &lt;a href=&quot;https://adventofcode.com/&quot;&gt;Advent of
Code&lt;/a&gt;. Initially my goal was only to solve each
problem using rust on the day of release, but I ended up trying to optimize
them down to sub-millisecond. That wasn’t possible for every problem, but I did
manage to get there for most of them. My &lt;a href=&quot;https://github.com/hugopeixoto/aoc2020&quot;&gt;solutions are available on
github&lt;/a&gt;, and I wrote down some thoughts
over the weeks:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;/articles/advent-of-code-2020-week-1.html&quot;&gt;Advent of code 2020, week 1&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;/articles/advent-of-code-2020-week-2.html&quot;&gt;Advent of code 2020, week 2&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;/articles/advent-of-code-2020-week-3-4.html&quot;&gt;Advent of code 2020, week 3 and 4&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;cyberscore&quot;&gt;Cyberscore&lt;/h2&gt;

&lt;p&gt;I’m working on rewriting some of the pages. Instead of rewriting everything
from scratch, I’m going from page to page extracting helpers similar to the
ones available in rails, like &lt;code&gt;link_to&lt;/code&gt;, &lt;code&gt;url_for&lt;/code&gt;, &lt;code&gt;checkbox_field&lt;/code&gt;, etc.&lt;/p&gt;

&lt;p&gt;I’ve also redesigned some pages while doing it; for now these redesigned pages
are only available for logged in users that opt-in, but here’s a sample of the
redesigned home page:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/articles/cyberscore-mainpage-new.png&quot; alt=&quot;Screenshot of the Cyberscore homepage, redesigned to be
responsive&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The main difference is that the new version is a bit more responsive.&lt;/p&gt;

&lt;p&gt;I’m currently working on rewriting the user settings page, which implies
rendering forms, handling POST parameters and updating database records. I’m
also redesigning it, because this is how the current page looks like right now:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/articles/cyberscore-settings.png&quot; alt=&quot;Screenshot of the Cyberscore settings page, showing redesigned to be
responsive&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;random-consulting-gig&quot;&gt;Random consulting gig&lt;/h2&gt;

&lt;p&gt;I spent one day consulting, helping a company optimize their infrastructure and
making sure that each component can scale if necessary. We spent some time
optimizing the number of &lt;a href=&quot;https://docs.gunicorn.org/en/stable/settings.html#workers&quot;&gt;workers&lt;/a&gt; and
&lt;a href=&quot;https://docs.gunicorn.org/en/stable/settings.html#workers&quot;&gt;threads&lt;/a&gt; of &lt;code&gt;gunicorn&lt;/code&gt;. They were using the values suggested
by gunicorn’s documentation, &lt;code&gt;2-4 $(NUM_CORES)&lt;/code&gt; for both, which is a bit weird.
I don’t think you ever want a quadratic number of threads. We tested a few
different configurations and benchmarked it with &lt;a href=&quot;https://locust.io/&quot;&gt;Locust&lt;/a&gt;
to see what would be the optimal values for that particular project.&lt;/p&gt;

&lt;h2 id=&quot;whats-next&quot;&gt;What’s next&lt;/h2&gt;

&lt;p&gt;I have two podcast episodes to edit. I also need to finish some &lt;a href=&quot;https://github.com/alumniei/mentorados/&quot;&gt;AlumniEI
mentorados&lt;/a&gt; project tasks.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;


    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2020-12-27:/articles/advent-of-code-2020-week-3-4.html</id>
    <title type="html">Advent of code 2020, week 3 and 4</title>
    <published>2020-12-27T00:00:00Z</published>
    <updated>2020-12-27T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/advent-of-code-2020-week-3-4.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;I’ve been solving the advent of code problems. Here’s what’s up so far.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;&lt;a href=&quot;https://adventofcode.com&quot;&gt;Advent of code 2020&lt;/a&gt; is over. I solved every problem
using rust. I’ve published my solutions with benchmarks:
&lt;a href=&quot;https://github.com/hugopeixoto/aoc2020&quot;&gt;https://github.com/hugopeixoto/aoc2020&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Here are my personal stats:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;      -------Part 1--------   -------Part 2--------
Day       Time   Rank  Score       Time   Rank  Score
 25   16:07:07  10724      0   16:08:35   8001      0
 24   05:43:08   7036      0   06:06:22   5933      0
 23   10:55:04   9956      0   19:54:39   9020      0
 22   01:35:57   4756      0   02:13:51   3366      0

 21   06:38:31   6795      0   06:42:32   6487      0
 20   07:25:40   6174      0   08:45:53   2504      0
 19   00:31:32    641      0   01:22:30   1083      0
 18   00:53:33   2883      0   01:27:32   2880      0
 17   00:39:43   1662      0   00:47:24   1572      0
 16   00:11:37    597      0   00:57:35   1711      0
 15   05:00:28  13550      0   05:01:55  11579      0

 14   00:10:17    343      0   00:33:07    779      0
 13   02:25:27   9424      0   03:26:30   4825      0
 12   01:26:32   7219      0   01:39:25   5711      0
 11   01:13:35   5964      0   01:20:22   4033      0
 10   00:52:14   9128      0   01:01:41   3367      0
  9   00:22:35   5624      0   00:34:57   4854      0
  8   00:49:35   8777      0   00:56:21   6027      0

  7   00:17:27    801      0   00:30:15   1022      0
  6   00:08:04   2745      0   00:13:41   2145      0
  5   00:23:43   4339      0   00:28:12   3544      0
  4   00:20:52   4184      0   00:56:14   3896      0
  3   00:56:04   8977      0   01:04:08   8165      0
  2   00:07:32   1519      0   00:10:52   1224      0
  1   01:10:16   6419      0   01:16:28   6046      0
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here’s some remarks on days 15-25:&lt;/p&gt;

&lt;h2 id=&quot;day-15&quot;&gt;Day 15&lt;/h2&gt;

&lt;p&gt;This one is a variant of the &lt;a href=&quot;https://oeis.org/A181391&quot;&gt;Van Eck’s sequence&lt;/a&gt;. I
don’t think that we can do this sublinearly. I got this down to a memory read
and a memory write per iteration.&lt;/p&gt;

&lt;h2 id=&quot;day-16&quot;&gt;Day 16&lt;/h2&gt;

&lt;p&gt;I started by using a &lt;code&gt;Vec&amp;lt;HashSet&amp;lt;RuleId&amp;gt;&amp;gt;&lt;/code&gt; to keep track of which rules were
compatible with each ticket position. I switched to a &lt;code&gt;Vec&amp;lt;usize&amp;gt;&lt;/code&gt;, using the
&lt;code&gt;usize&lt;/code&gt;s as bitmasks to make things faster.&lt;/p&gt;

&lt;h2 id=&quot;day-17&quot;&gt;Day 17&lt;/h2&gt;

&lt;p&gt;Another game of life, but in 3 and 4 dimensions. Just like in day 11, I
allocated two boards and flipped between them instead of allocating a new one
per iteration:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;nd&quot;&gt;#![feature(destructuring_assignment)]&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;next4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;bool&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;bool&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;cm&quot;&gt;/* ... */&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;c&quot;&gt;// ...&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;c&quot;&gt;// ...&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;state&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.clone&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;state&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.clone&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;turns&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;next4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;width&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;height&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;depth&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;wefth&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;turns&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;day-18&quot;&gt;Day 18&lt;/h2&gt;

&lt;p&gt;For the initial rust implementation, I used the &lt;a href=&quot;https://en.wikipedia.org/wiki/Shunting-yard_algorithm&quot;&gt;Shunting-yard
algorithm&lt;/a&gt; to transform the expressions from infix to postfix
notation. Fortunately I ran into this algorithm a couple of months ago when
experimenting with &lt;a href=&quot;https://github.com/hugopeixoto/pokequiz&quot;&gt;https://github.com/hugopeixoto/pokequiz&lt;/a&gt;, so I knew what to
use.&lt;/p&gt;

&lt;p&gt;As an alternative implementation, I took advantage of ruby’s monkey patching
and eval mechanisms:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;(&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;File&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;inputs/day18.in&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;strip&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;)+(&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;)&quot;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Integer&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;other&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;self&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;other&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;nb&quot;&gt;puts&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;eval&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;*&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;-&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Integer&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;other&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;self&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;other&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;other&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;self&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;other&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;nb&quot;&gt;puts&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;eval&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;*&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;-&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;+&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;/&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;day-19&quot;&gt;Day 19&lt;/h2&gt;

&lt;p&gt;My implementation for this one is terrible and I want to figure out a better
way to do this. Instead of implementing a grammar matching algorithm, I used
string substitutions to turn the input into a regular expression, and then used
the regular expression to check if the messages were valid.&lt;/p&gt;

&lt;p&gt;For part 2, since the only two substitutions were &lt;code&gt;8: 42 | 42 8&lt;/code&gt;, which means
&lt;code&gt;42+&lt;/code&gt;, and &lt;code&gt;11: 42 31 | 42 11 31&lt;/code&gt;, which means &lt;code&gt;42{k}31{k}&lt;/code&gt;, and the root rule
is &lt;code&gt;0: 8 11&lt;/code&gt;, I compiled a few regexps and brute forced the length of the 8th
rule expansion and the value of &lt;code&gt;k&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;    &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;maxk&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;messagesstr&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.lines&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.max&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.unwrap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;re8&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;Regex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;nd&quot;&gt;format!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;^{}+$&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cache&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]))&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.unwrap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;regexps&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;..=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;maxk&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nn&quot;&gt;Regex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;nd&quot;&gt;format!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;^({}){{{}}}({}){{{}}}$&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cache&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cache&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;31&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.unwrap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.collect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;message&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;messagesstr&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.lines&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;&#39;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;message&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p8&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;message&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;re8&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.is_match&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;p8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p11&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;message&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;..=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;p11&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;re11&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;regexps&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
                    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;re11&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.is_match&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;p11&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
                        &lt;span class=&quot;n&quot;&gt;p2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
                        &lt;span class=&quot;k&quot;&gt;break&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;&#39;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
                    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
                &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
            &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This ends up compiling ~50 regular expressions, which takes some time (it takes
~500ms for the whole thing to run). Initially I was compiling the regular
expressions inside the loop, which takes even longer (around ~30 secs).&lt;/p&gt;

&lt;h2 id=&quot;day-20&quot;&gt;Day 20&lt;/h2&gt;

&lt;p&gt;The first part of this day is an edge matching puzzle, and it reminded me of
the &lt;a href=&quot;https://en.wikipedia.org/wiki/Eternity_II_puzzle&quot;&gt;Eternity II puzzle&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;For the second part, tile are &lt;code&gt;8x8&lt;/code&gt;, so they fit in a &lt;code&gt;u64&lt;/code&gt;. I used a bunch of
bit operations to deal with the rotations / flips:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;transpose8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;u64&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;u64&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0x00AA00AA00AA00AA&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;t&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;14&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0x0000CCCC0000CCCC&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;t&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;14&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0xF0F0F0F00F0F0F0F&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;28&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0xF0F0F0F0F0F0F0F0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;28&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0x0F0F0F0F0F0F0F0F&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;rotate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tile&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;u64&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rotation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;usize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;u64&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rotation&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tile&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;transpose8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tile&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.reverse_bits&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.swap_bytes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt;
      &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tile&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.reverse_bits&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt;
      &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;rotate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tile&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.reverse_bits&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt;
      &lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tile&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.reverse_bits&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.swap_bytes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt;
      &lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;rotate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;rotate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tile&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
      &lt;span class=&quot;mi&quot;&gt;6&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;rotate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;rotate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tile&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
      &lt;span class=&quot;mi&quot;&gt;7&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;rotate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;rotate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tile&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
      &lt;span class=&quot;mi&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nd&quot;&gt;panic!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Initially I was doing the 90° rotation (&lt;code&gt;rotation == 1&lt;/code&gt;) naively with maps and
folds, but I found &lt;a href=&quot;https://stackoverflow.com/a/6932331&quot;&gt;this implementation from Hacker’s
Delight&lt;/a&gt;. I adapted it to use &lt;code&gt;u64&lt;/code&gt;
instead of two &lt;code&gt;u32&lt;/code&gt; and ported it to rust and the total running time went down
~10µs.&lt;/p&gt;

&lt;p&gt;This was a nice exercise to learn about bit operations on numeric types in rust.&lt;/p&gt;

&lt;h2 id=&quot;day-21&quot;&gt;Day 21&lt;/h2&gt;

&lt;p&gt;I practically solved part 2 while solving part 1. In the initial
implementation, I was using &lt;code&gt;HashSet&lt;/code&gt;s and &lt;code&gt;HashMap&lt;/code&gt;s of &lt;code&gt;String&lt;/code&gt;s, so there
were a lot of &lt;code&gt;to_string()&lt;/code&gt; calls to deal with ownership issues. The optimized
solution used &lt;code&gt;&amp;amp;str&lt;/code&gt; instead. Every string slice was referencing the initial
&lt;code&gt;input: String&lt;/code&gt; parameter, so there were no string copies.&lt;/p&gt;

&lt;h2 id=&quot;day-22&quot;&gt;Day 22&lt;/h2&gt;

&lt;p&gt;I didn’t do anything special to optimize this, and it shows. The running time
is close to one second. I’m using VecDeques and pushing/popping elements, and
cloning them whenever I need to run a subgame.&lt;/p&gt;

&lt;p&gt;I spent some time thinking about how to optimize the state representation: it
could be stored as the permutation number plus two lengths, bringing it to
approximately &lt;code&gt;log2(factorial(50) * 50 * 50) ~= 226&lt;/code&gt; bits. It would be great if
I could do every operation directly on this representation, but I haven’t
managed to do that yet. I don’t think that rust has native 256 integers, so
I’ll have to deal with two 128 bit unsigned integers.&lt;/p&gt;

&lt;h2 id=&quot;day-23&quot;&gt;Day 23&lt;/h2&gt;

&lt;p&gt;I used a linked list backed by a single vector &lt;code&gt;ns: Vec&amp;lt;usize&amp;gt;&lt;/code&gt;, where &lt;code&gt;ns[i]&lt;/code&gt;
points to the element following &lt;code&gt;i&lt;/code&gt;. I think it’s impossible to solve
this without doing 10M iterations.&lt;/p&gt;

&lt;h2 id=&quot;day-24&quot;&gt;Day 24&lt;/h2&gt;

&lt;p&gt;Yet another game of life, but this time based on a hexagonal grid. I used
&lt;a href=&quot;https://www.redblobgames.com/grids/hexagons/#coordinates-axial&quot;&gt;axial
coordinates&lt;/a&gt; to
map it into a 2D space, and used the following neighbors:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;DELTAS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;i32&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;i32&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;  &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;     &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;  &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
       &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;  &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;  &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;day-25&quot;&gt;Day 25&lt;/h2&gt;

&lt;p&gt;This is a diffie hellman key exchange, with small key sizes. To get this under
a millisecond, I used the &lt;a href=&quot;https://en.wikipedia.org/wiki/Baby-step_giant-step&quot;&gt;Baby-step
giant-step&lt;/a&gt; algorithm to
crack the private key and an iterative &lt;a href=&quot;https://en.wikipedia.org/wiki/Exponentiation_by_squaring&quot;&gt;exponention by
squaring&lt;/a&gt; algorithm
to compute the encryption key.&lt;/p&gt;

&lt;h2 id=&quot;benchmark-results&quot;&gt;Benchmark results&lt;/h2&gt;

&lt;p&gt;I’m benchmarking the &lt;code&gt;main&lt;/code&gt; functions directly, including the input file I/O,
using &lt;code&gt;cargo bench&lt;/code&gt;. Previously, I was benchmarking these in my laptop, but I
started running this on my desktop, since it’s usually idle and the CPU is a
bit better (&lt;code&gt;i5-6200U @ 2.30GHz&lt;/code&gt; vs &lt;code&gt;i7-5820K CPU @ 3.30GHz&lt;/code&gt;). Here are the
current results:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_day01&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;        &lt;span class=&quot;mi&quot;&gt;15&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;994&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;246&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_day02&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;        &lt;span class=&quot;mi&quot;&gt;82&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;259&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;515&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_day03&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;        &lt;span class=&quot;mi&quot;&gt;21&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;439&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;411&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_day04&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;       &lt;span class=&quot;mi&quot;&gt;221&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;002&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;184&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_day05&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;        &lt;span class=&quot;mi&quot;&gt;82&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;721&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;241&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_day06&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;        &lt;span class=&quot;mi&quot;&gt;96&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;749&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;036&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_day07&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;       &lt;span class=&quot;mi&quot;&gt;552&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;138&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;44&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;540&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_day08&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;       &lt;span class=&quot;mi&quot;&gt;266&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;660&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;425&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_day09&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;        &lt;span class=&quot;mi&quot;&gt;98&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;035&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;408&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_day10&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;         &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;393&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;18&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_day11&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;     &lt;span class=&quot;mi&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;354&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;845&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;47&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;374&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_day12&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;        &lt;span class=&quot;mi&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;390&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;180&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_day13&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;         &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;821&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;21&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_day14&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;       &lt;span class=&quot;mi&quot;&gt;392&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;718&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;83&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;019&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_day15&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;   &lt;span class=&quot;mi&quot;&gt;414&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;424&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;116&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;444&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;111&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_day16&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;       &lt;span class=&quot;mi&quot;&gt;498&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;829&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;667&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_day17&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;    &lt;span class=&quot;mi&quot;&gt;13&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;511&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;301&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;118&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;371&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_day18&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;       &lt;span class=&quot;mi&quot;&gt;378&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;241&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;810&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_day19&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;   &lt;span class=&quot;mi&quot;&gt;441&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;570&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;670&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;892&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;836&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_day20&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;       &lt;span class=&quot;mi&quot;&gt;330&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;477&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;771&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_day21&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;       &lt;span class=&quot;mi&quot;&gt;319&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;326&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;778&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_day22&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;   &lt;span class=&quot;mi&quot;&gt;991&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;391&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;287&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;371&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;697&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_day23&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;   &lt;span class=&quot;mi&quot;&gt;324&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;300&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;525&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;250&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;144&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_day24&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;    &lt;span class=&quot;mi&quot;&gt;23&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;309&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;053&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;220&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;611&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_day25&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;       &lt;span class=&quot;mi&quot;&gt;316&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;581&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;405&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_all&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;214&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;272&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;195&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;27&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;137&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;664&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I ended up rewriting day 4 and day 7, removing the regular expressions and
using a manual parser instead. I also implemented a non-bruteforce approach for
day 14.&lt;/p&gt;

&lt;p&gt;Day 15 and 23 are probably impossible to get under a millisecond. They both
require tens of millions of iterations and at least one memory read and write
per iteration.&lt;/p&gt;

&lt;p&gt;Day 19 and 22 are the ones that I haven’t spent much time optimizing yet.&lt;/p&gt;

&lt;p&gt;There are three game of life implementations: day 11, day 17 and day 24.
They’re pretty close to be sub-millisecond, but I don’t know how to squeeze any
more performance out of them. I’ll probably need to find a way to parallelize
them, either by using bitsets or SIMD.&lt;/p&gt;

&lt;p&gt;My initial goal was to get every day below 1 millisecond, but since it’s
probably impossible, I’ll try to get &lt;code&gt;bench_all&lt;/code&gt; below 1 second. This should be
doable by optimizing days 19 and 22.&lt;/p&gt;

&lt;h2 id=&quot;conclusions&quot;&gt;Conclusions&lt;/h2&gt;

&lt;p&gt;Around day 3 or 4, using rust started feeling natural. It was interesting to
see the differences in performance between using &lt;code&gt;regexp&lt;/code&gt;, &lt;code&gt;scan_fmt&lt;/code&gt;,
string splits, and hand-rolled parsers.&lt;/p&gt;

&lt;p&gt;Algorithm-wise, days 10 and 13 were probably the hardest ones. Day 20 was the
one that required more twiddling.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;


    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2020-12-14:/articles/advent-of-code-2020-week-2.html</id>
    <title type="html">Advent of code 2020, week 2</title>
    <published>2020-12-14T00:00:00Z</published>
    <updated>2020-12-14T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/advent-of-code-2020-week-2.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;I’ve been solving the advent of code problems. Here’s what’s up so far.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;&lt;a href=&quot;https://adventofcode.com&quot;&gt;Advent of code 2020&lt;/a&gt; is ongoing. I’ve been solving
the problems daily using rust. So far so good. I have a private leaderboard
with a few folks, anyone is free to join, here’s the code: &lt;code&gt;9779-59e7cb46&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;I’m publishing my solutions here, with a delay of a day or two:
&lt;a href=&quot;https://github.com/hugopeixoto/aoc2020&quot;&gt;https://github.com/hugopeixoto/aoc2020&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Here are my personal stats so far:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;      -------Part 1--------   -------Part 2--------
Day       Time  Rank  Score       Time  Rank  Score
 14   00:10:17   343      0   00:33:07   779      0
 13   02:25:27  9424      0   03:26:30  4825      0
 12   01:26:32  7219      0   01:39:25  5711      0
 11   01:13:35  5964      0   01:20:22  4033      0
 10   00:52:14  9128      0   01:01:41  3367      0
  9   00:22:35  5624      0   00:34:57  4854      0
  8   00:49:35  8777      0   00:56:21  6027      0

  7   00:17:27   801      0   00:30:15  1022      0
  6   00:08:04  2745      0   00:13:41  2145      0
  5   00:23:43  4339      0   00:28:12  3544      0
  4   00:20:52  4184      0   00:56:14  3896      0
  3   00:56:04  8977      0   01:04:08  8165      0
  2   00:07:32  1519      0   00:10:52  1224      0
  1   01:10:16  6419      0   01:16:28  6046      0
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Day 9 and day 14 were the only ones where I was awake at release time, but I’m
still solving them same day, which was my main goal. This week had some harder
problems. Day 10 and 13 stumped some folks. Here’s what I found interesting so
far each day:&lt;/p&gt;

&lt;h2 id=&quot;day-8&quot;&gt;Day 8&lt;/h2&gt;

&lt;p&gt;I initially brute-forced part 2, but after submitting the solution I optimzed
it with a node marking depth first search. To make sure that it was indeed
faster, I started using &lt;code&gt;cargo bench&lt;/code&gt; to compare the running time of my
solutions.&lt;/p&gt;

&lt;p&gt;I tried using &lt;a href=&quot;https://crates.io/crates/scan_fmt/&quot;&gt;&lt;code&gt;scan_fmt&lt;/code&gt;&lt;/a&gt; instead of
regular expressions when parsing the input file.&lt;/p&gt;

&lt;h2 id=&quot;day-9&quot;&gt;Day 9&lt;/h2&gt;

&lt;p&gt;The first part was similar to the 2SUM problem but with a rolling window kind
of thing. I used &lt;code&gt;itertools::minmax&lt;/code&gt; in the second part. It’s a bit clunky,
though:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;MinMaxResult&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;MinMax&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;numbers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lower&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.iter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.minmax&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;nd&quot;&gt;println!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;{}&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;day-10&quot;&gt;Day 10&lt;/h2&gt;

&lt;p&gt;I solved part 2 using dynamic programming. At this point I started
preallocating vectors, and it would be nice to have something shorter than
this:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ways&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;u64&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;ways&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.resize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;numbers&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I could probably squeeze this to use constant memory with a small circular
buffer.&lt;/p&gt;

&lt;h2 id=&quot;day-11&quot;&gt;Day 11&lt;/h2&gt;

&lt;p&gt;This is a variation of game of life. Initially I had a function that received a
board state and returned the new game state, but I changed it to something
similar to the double buffering technique so that memory isn’t constantly being
allocated, using mutable references to mutable vectors and the
&lt;code&gt;destructuring_assignment&lt;/code&gt; nightly feature:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;nd&quot;&gt;#![feature(destructuring_assignment)]&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;next&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;bool&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;bool&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;neighbors&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;usize&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;thresh&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;usize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;bool&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;c&quot;&gt;// ...&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;compact_state&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.clone&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;compact_state&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.clone&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;next&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;neighbors&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;day-12&quot;&gt;Day 12&lt;/h2&gt;

&lt;p&gt;Just a bunch of &lt;code&gt;match&lt;/code&gt; statements, nothing particularly interesting.&lt;/p&gt;

&lt;h2 id=&quot;day-13&quot;&gt;Day 13&lt;/h2&gt;

&lt;p&gt;This one required some maths, so it took me about an hour to get the second
part solved. Nothing fancy on the rust side.&lt;/p&gt;

&lt;h2 id=&quot;day-14&quot;&gt;Day 14&lt;/h2&gt;

&lt;p&gt;I brute forced part 2, and I have no idea if there’s a smarter way. I learned a
bit about passing slices around:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;gen2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mask&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;addr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;u64&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;u64&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;results&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;u64&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mask&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;results&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.push&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;addr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mask&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;// ...&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;gen&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mask&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;addr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;u64&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;u64&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;r&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nd&quot;&gt;vec!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[];&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;gen2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mask&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;addr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;r&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;benchmark-results&quot;&gt;Benchmark results&lt;/h2&gt;

&lt;p&gt;I’m benchmarking the &lt;code&gt;main&lt;/code&gt; functions directly, including the input file I/O,
using &lt;code&gt;cargo bench&lt;/code&gt;. Here are the current results:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_day01&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;      &lt;span class=&quot;mi&quot;&gt;33&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;130&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;9&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;334&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_day02&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;     &lt;span class=&quot;mi&quot;&gt;106&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;041&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;45&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;522&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_day03&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;      &lt;span class=&quot;mi&quot;&gt;36&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;203&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;9&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;872&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_day04&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;   &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;602&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;220&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;214&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;088&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_day05&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;     &lt;span class=&quot;mi&quot;&gt;131&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;899&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;727&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_day06&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;     &lt;span class=&quot;mi&quot;&gt;618&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;439&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;244&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;812&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_day07&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;   &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;163&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;174&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;410&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;470&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_day08&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;     &lt;span class=&quot;mi&quot;&gt;321&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;834&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;51&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;744&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_day09&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;     &lt;span class=&quot;mi&quot;&gt;123&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;836&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;562&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_day10&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;       &lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;940&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;849&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_day11&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;   &lt;span class=&quot;mi&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;497&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;058&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;748&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;109&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_day12&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;      &lt;span class=&quot;mi&quot;&gt;22&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;708&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;289&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_day13&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;       &lt;span class=&quot;mi&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;517&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;562&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench_day14&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;   &lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;969&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;778&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+/-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;770&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;472&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I was trying to squeeze them to fit under a millisecond each, but I’m having
trouble with some of them. Day 4 and day 7 use regular expressions, and while I
could remove them, the code complexity would sky rocket. Day 11 is the game of
life variant, and I don’t see how I can improve it. I haven’t spent much time
optimizing day 14, but it would probably require a non bruteforce approach.&lt;/p&gt;

&lt;p&gt;I kind of went all-in on day 2, and parsed everything manually to avoid going
through each character in the input file more than once. I learned that I could
use a match statement like this:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;character&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;input&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.chars&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;character&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;state&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;&#39;\n&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;cm&quot;&gt;/* ... */&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;&#39;0&#39;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;..=&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;&#39;9&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;cm&quot;&gt;/* ... */&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;&#39;0&#39;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;..=&lt;/span&gt;&lt;span class=&quot;sc&quot;&gt;&#39;9&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;cm&quot;&gt;/* ... */&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;bonus---project-euler&quot;&gt;Bonus - Project euler&lt;/h2&gt;

&lt;p&gt;I got carried away and solved five more project euler problems: &lt;a href=&quot;https://projecteuler.net/problem=121&quot;&gt;121&lt;/a&gt;,
&lt;a href=&quot;https://projecteuler.net/problem=122&quot;&gt;122&lt;/a&gt;, &lt;a href=&quot;https://projecteuler.net/problem=123&quot;&gt;123&lt;/a&gt;, &lt;a href=&quot;https://projecteuler.net/problem=125&quot;&gt;125&lt;/a&gt;, and &lt;a href=&quot;https://projecteuler.net/problem=126&quot;&gt;126&lt;/a&gt;. I enjoyed solving 126
and 122. I got stuck on 127.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;


    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2020-12-07:/articles/advent-of-code-2020-week-1.html</id>
    <title type="html">Advent of code 2020, week 1</title>
    <published>2020-12-07T00:00:00Z</published>
    <updated>2020-12-07T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/advent-of-code-2020-week-1.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;I’ve been solving the advent of code problems. Here’s what’s up so far.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;&lt;a href=&quot;https://adventofcode.com&quot;&gt;Advent of code 2020&lt;/a&gt; is ongoing. I’ve been solving
the problems daily using rust. So far so good. I have a private leaderboard
with a few folks, anyone is free to join, here’s the code: &lt;code&gt;9779-59e7cb46&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;My schedule has been kind of compatible with the time of release, so I’ve been
able to start working on them almost immediately. So far I haven’t got any
points (rank &amp;lt;= 100), though. Here are my personal stats so far:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;      -------Part 1--------   -------Part 2--------
Day       Time  Rank  Score       Time  Rank  Score
  7   00:17:27   801      0   00:30:15  1022      0
  6   00:08:04  2745      0   00:13:41  2145      0
  5   00:23:43  4339      0   00:28:12  3544      0
  4   00:20:52  4184      0   00:56:14  3896      0
  3   00:56:04  8977      0   01:04:08  8165      0
  2   00:07:32  1519      0   00:10:52  1224      0
  1   01:10:16  6419      0   01:16:28  6046      0
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Days 1-6 were straightforward, while day 7 was a bit more involved. Last year I
wrote some tests. This year, I’m trying to get the solutions out of the door as
fast as I can, so there’s none of that. I’m mostly using &lt;code&gt;println!&lt;/code&gt;s.&lt;/p&gt;

&lt;p&gt;Here’s what I found interesting so far each day:&lt;/p&gt;

&lt;h2 id=&quot;day-1&quot;&gt;Day 1&lt;/h2&gt;

&lt;p&gt;I learned about using &lt;a href=&quot;https://doc.rust-lang.org/stable/std/keyword.break.html&quot;&gt;break with labels&lt;/a&gt;:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;nv&quot;&gt;&#39;part1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lines&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.iter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lines&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.iter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2020&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;nd&quot;&gt;println!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;{}&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;break&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;&#39;part1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;day-2&quot;&gt;Day 2&lt;/h2&gt;

&lt;p&gt;I tried to speedrun this one to see if I could get some leaderboard points, so
I did this in ruby instead, but it still took me 7 minutes to get the initial
solution. I rewrote it in rust afterwards. It was a good problem to exercise
using regular expressions.&lt;/p&gt;

&lt;h2 id=&quot;day-3&quot;&gt;Day 3&lt;/h2&gt;

&lt;p&gt;I read the whole input into a string and worked with it without any conversion.
So far I’ve been using a buffered reader to read lines.&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;fs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;read_to_string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;pub&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;area&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;read_to_string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;inputs/day3.in&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.unwrap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;day-4&quot;&gt;Day 4&lt;/h2&gt;

&lt;p&gt;I used a bunch of regular expressions, even for numeric range checking. Things
like this:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;hgt&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;Regex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;r&quot;^hgt:(1([5-8]\d|9[0-3])cm|(59|6\d|7[0-6])in)$&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.unwrap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It took me a while to get some of these right. Maybe I should have gone with
something simpler.&lt;/p&gt;

&lt;h2 id=&quot;day-5&quot;&gt;Day 5&lt;/h2&gt;

&lt;p&gt;This problem was basically implementing parsing numbers in base 2:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;nn&quot;&gt;i32&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;from_str_radix&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.replace&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;F&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;0&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.replace&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;B&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;1&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.replace&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;R&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;1&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.replace&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;L&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;0&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
  &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;For part two, I kind of missed ruby’s &lt;code&gt;Enumerable#each_cons&lt;/code&gt;. Thankfully, the
&lt;a href=&quot;https://docs.rs/itertools/0.9.0/itertools/index.html&quot;&gt;&lt;code&gt;itertools&lt;/code&gt;&lt;/a&gt; crate has
&lt;code&gt;tuple_windows&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;missing&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lines&lt;/span&gt;
  &lt;span class=&quot;nf&quot;&gt;.iter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
  &lt;span class=&quot;nf&quot;&gt;.tuple_windows&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
  &lt;span class=&quot;nf&quot;&gt;.filter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(|&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;prev&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;current&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;current&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;prev&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;nf&quot;&gt;.map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(|(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;current&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;current&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;nf&quot;&gt;.next&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
  &lt;span class=&quot;nf&quot;&gt;.unwrap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;day-6&quot;&gt;Day 6&lt;/h2&gt;

&lt;p&gt;This day I learned that &lt;code&gt;trim&lt;/code&gt; doesn’t return a copy of the string, but
something that references it. That means I can’t do something like this:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;cs&quot;&gt;# this doesn&#39;t work&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;text&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;read_to_string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;inputs/day6.in&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.unwrap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.trim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I would need to either call &lt;code&gt;to_string()&lt;/code&gt; on it, to make a copy, or to keep the
full text around:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;cs&quot;&gt;# either copy it&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;text&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;read_to_string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;inputs/day6.in&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.unwrap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.trim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.to_string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;cs&quot;&gt;# or keep it around&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;text&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;read_to_string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;inputs/day6.in&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.unwrap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;trimmed&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;text&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.trim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;day-7&quot;&gt;Day 7&lt;/h2&gt;

&lt;p&gt;This was the first problem this year that looked like a graph problem. I wrote
a couple of DFS-like functions. I expected to have some more trouble with
ownership of the arguments, but it was kind of easy. I used a bunch of
&lt;code&gt;std::collections::HashMap&lt;/code&gt;s.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2020-12-02:/articles/status-update-2020-11-30.html</id>
    <title type="html">Status update, November 2020</title>
    <published>2020-12-02T00:00:00Z</published>
    <updated>2020-12-02T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/status-update-2020-11-30.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;No more November. I didn’t blog as much this month, so this status update will be a bit longer than usual.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;No more November. I didn’t blog as much this month, so this status update will
be a bit longer than usual.&lt;/p&gt;

&lt;h2 id=&quot;d3---defesa-dos-direitos-digitais&quot;&gt;D3 - Defesa dos Direitos Digitais&lt;/h2&gt;

&lt;p&gt;I started the month doing some work for &lt;a href=&quot;https://direitosdigitais.pt&quot;&gt;D3&lt;/a&gt;. We use &lt;a href=&quot;https://hackmd.io&quot;&gt;HackMD&lt;/a&gt; a lot
to colaborate on writing articles and researching topics, and there was some
downtime. This made us consider self-hosting our own instance so we could have
some more control over our data. I configured a new VPS and set up an instance
for our members.&lt;/p&gt;

&lt;p&gt;I still need to figure out how to add authentication. I don’t want to have to
manually send out invitations to every member that joins. We have a bunch of
services that require member authentication, and it would be nice if we could
have a single set of credentials per member. I guess what I’m looking for is a
SAML/OpenID connect solution that I can self-host. Most of the things that I
found were a bit resource intensive, so I still haven’t found a solution. Maybe
I should implement one in rust :P&lt;/p&gt;

&lt;h2 id=&quot;hedgedoc&quot;&gt;HedgeDoc&lt;/h2&gt;

&lt;p&gt;While I was setting up HackMD for D3, I found out that there are multiple
versions/forks. TLDR:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;the project started as HackMD (MIT)&lt;/li&gt;
  &lt;li&gt;it split into HackMD EE (proprietary) and HackMD CE (AGPL)&lt;/li&gt;
  &lt;li&gt;HackMD CE was renamed to CodiMD&lt;/li&gt;
  &lt;li&gt;there was some governance and licensing discussion&lt;/li&gt;
  &lt;li&gt;part of the community forked CodiMD&lt;/li&gt;
  &lt;li&gt;the forked CodiMD was in the process of being renamed to HedgeDoc&lt;/li&gt;
  &lt;li&gt;HedgeDoc is being rewritten in nestjs+react&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Initially I had setup the original CodiMD, but as soon as I found out about the
fork, I switched to the forked version. I decided to help with the rename by
working on the &lt;a href=&quot;https://github.com/hedgedoc/container&quot;&gt;container&lt;/a&gt; repository: &lt;a href=&quot;https://github.com/hedgedoc/container/pull/119&quot;&gt;Rename HackMD and
CodiMD to HedgeDoc&lt;/a&gt;. Since
travis stopped offering an open source plan, I also helped them migrate from
travis-ci to Github Actions: &lt;a href=&quot;https://github.com/hedgedoc/container/pull/123&quot;&gt;Add github actions to build
containers&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I also started working on building nightly releases and improving the dockerfiles:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/hedgedoc/container/pull/127&quot;&gt;Publish nightly docker images&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/hedgedoc/container/pull/126&quot;&gt;Split dockerfiles into stages&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I had the opportunity to add a feature to a project that you can use to
generate docker tags based on the git tag being released: &lt;a href=&quot;https://github.com/crazy-max/ghaction-docker-meta/pull/15&quot;&gt;Add tag
flavor&lt;/a&gt;. I also
spent some time going through the open issues and PRs, closing the stale ones
that were mainly support requests and not bugs. Thanks to these contributions,
I’m now part of the HedgeDoc core team:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://hedgedoc.org/team/&quot;&gt;https://hedgedoc.org/team/&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;personal-infrastructure&quot;&gt;Personal infrastructure&lt;/h2&gt;

&lt;p&gt;I &lt;a href=&quot;/articles/self-hosting-nameservers.html&quot;&gt;migrated my nameservers from AWS Route53 to my own instances of of
nsd&lt;/a&gt;. I’m thinking of moving the lifeonmars zones to
these instances as well, since the websites are all hosted on my machines
anyway.&lt;/p&gt;

&lt;p&gt;I finally &lt;a href=&quot;/articles/brute-forcing-my-own-passphrase.html&quot;&gt;figured out the passphrase of an old ssh key&lt;/a&gt;. This
was pointless but rewarding, in a weird way. I should dedicate some time to
figure out what to do with &lt;code&gt;git.hugopeixoto.net&lt;/code&gt;. I need to either fix it or
redirect it to my github account or something.&lt;/p&gt;

&lt;p&gt;I was looking for a self-hosted solution to share a shopping list with my house
mates, and decided to try &lt;a href=&quot;https://etesync.com/&quot;&gt;EteSync&lt;/a&gt;, but the task
applications that support it didn’t work that great. I started writing a stupid
&lt;a href=&quot;https://github.com/hugopeixoto/lists-server&quot;&gt;server in rust using diesel&lt;/a&gt; but
didn’t get very far. I need to give etesync another go.&lt;/p&gt;

&lt;h2 id=&quot;cyberscore&quot;&gt;Cyberscore&lt;/h2&gt;

&lt;p&gt;Cyberscore is not open source yet, because there are hardcoded secrets in the
git repository and some trivial vulnerabilities that would be exposed that we
need to fix before releasing the code. This month I spent some time working in
that direction, by extracting the hardcoded secrets into a &lt;code&gt;config.ini&lt;/code&gt; file.&lt;/p&gt;

&lt;p&gt;I also changed the way we deploy things, so that root of the repository isn’t
apache’s DocumentRoot. This closed a vulnerability where the &lt;code&gt;.git&lt;/code&gt; directory
was accessible and browsable via the web. It also lets me add files to the
repository that I don’t necessarily want to end up being web served, like a
&lt;code&gt;README.md&lt;/code&gt;.&lt;/p&gt;

&lt;h2 id=&quot;alumniei-mentorados&quot;&gt;AlumniEI mentorados&lt;/h2&gt;

&lt;p&gt;I groomed the issues list added some setup instructions and contributing
guidelines. We decided to &lt;a href=&quot;https://github.com/alumniei/mentorados/pull/20&quot;&gt;license the code as AGPL&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&quot;conversas-em-cdigo-podcast&quot;&gt;Conversas em Código Podcast&lt;/h2&gt;

&lt;p&gt;I recorded two podcast episodes, one about hedgedoc and one about matrix. These
should be published during December.&lt;/p&gt;

&lt;h2 id=&quot;whats-next&quot;&gt;What’s next&lt;/h2&gt;

&lt;p&gt;It’s Advent of code time! I &lt;a href=&quot;/articles/advent-of-code-2019.html&quot;&gt;restarted my blog this year by writing about this
contest&lt;/a&gt;, and here we are again. If I can keep up with the daily
challenges, I’ll see if I can do a small write up every few days.&lt;/p&gt;

&lt;p&gt;I’ll probably have some work to do on HedgeDoc. I still have pending PRs, and
if the nestjs/react rewrite goes anywhere, the dockerfiles will need to be
rewritten to account for the repository split. I’d like to add multi-platform
support to our docker images. We’re only building amd64 images, and it would be
nice to be able to host this on raspberry pis, for example.&lt;/p&gt;

&lt;p&gt;I want to continue working a bit on Cyberscore. We talked about rewriting it
from scratch in Laravel or something, but for me that isn’t as appealing as
shaping the existing code into place.&lt;/p&gt;

&lt;p&gt;I have some issues assigned to me on mentorados that need to be finished by the
end of the year, so I’ll work on that.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;


    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2020-11-20:/articles/brute-forcing-my-own-passphrase.html</id>
    <title type="html">Brute forcing my own passphrase</title>
    <published>2020-11-20T00:00:00Z</published>
    <updated>2020-11-20T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/brute-forcing-my-own-passphrase.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;Six months ago, I found an ssh key whose passphrase I couldn’t remember. It’s been bothering me ever since. Today I thought of a potential candidate and added some brute force to the mix.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;Back in May, when I was &lt;a href=&quot;https://hugopeixoto.net/articles/2020-05-03.html#what-else-is-missing&quot;&gt;cleaning up the server that runs
&lt;code&gt;git.hugopeixoto.net&lt;/code&gt;&lt;/a&gt;, I found an ssh key whose passphrase I
couldn’t remember. It’s an old key that I created 10 years ago to use in my
employer’s laptop. I don’t work there anymore and I don’t actively use this
key, so it’s not like I lost access to anything. I have another user on this
server whose passphrase I remember. It still bothered me, though. When I first
found out about the missing passphrase, I made a list of potential passphrases
with variants for capitalization, punctuation and things like that, and tried
them all in a python script, but it got me nowhere.&lt;/p&gt;

&lt;p&gt;From time to time, I remember a potential passphrase and try it. Today, I
remembered a new one to try, so I added it to the list. I was feeling kind of
lazy and didn’t want to generate every possible combination of
punctuation/capitalization/etc, so I wrote an expansion function that works a
bit like bash’s &lt;code&gt;{a,b}&lt;/code&gt; syntax. The full script looks like this:&lt;/p&gt;

&lt;div class=&quot;language-python highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;expand&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]]&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;f&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;f&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&#39;{&#39;&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;append&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;elif&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;f&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&#39;}&#39;&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;][&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;split&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;,&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;append&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;][&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;f&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;rec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;current&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;results&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;part&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]:&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;rec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;current&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;part&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;results&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;results&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;append&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;current&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;results&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;rec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;results&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;results&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;expandall&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;strings&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;ret&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;strings&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;ret&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;expand&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ret&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# I used to have a manually generated list here
&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;passphrases&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;expandall&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;&quot;{f,F}irst template&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;&quot;s{e,E}cond template&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;passphrases&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;passphrase&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;passphrases&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;subprocess&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;&quot;ssh-keygen&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;-yf&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;/path/to/privatekey&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;-P&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;passphrase&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;]).&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;returncode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;passphrase&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;break&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I could probably use a &lt;code&gt;flatmap&lt;/code&gt; or a nested comprehension list in &lt;code&gt;expandall&lt;/code&gt;,
but I just wanted this to work. Using variable names like &lt;code&gt;f&lt;/code&gt; and &lt;code&gt;x&lt;/code&gt; is a good
indication that I was in “just write some code” mode. I don’t even know why I
fall back to python for these kinds of scripts, instead of going with ruby.
Maybe it’s because when I’m writing ruby I automatically go into “let’s write
this in a single chain of method calls” mode?&lt;/p&gt;

&lt;p&gt;Anyway, if you feed &lt;code&gt;expand&lt;/code&gt; something like &lt;code&gt;&quot;{w,W}hy{ ,}python{?,?!}&quot;&lt;/code&gt;, it
would generate a list of &lt;code&gt;2*2*2=8&lt;/code&gt; strings:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;code&gt;why python?&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;&lt;code&gt;why python?!&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;&lt;code&gt;whypython?&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;&lt;code&gt;whypython?!&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;&lt;code&gt;Why python?&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;&lt;code&gt;Why python?!&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;&lt;code&gt;Whypython?&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;&lt;code&gt;Whypython?!&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Nothing fancy, but it saves me some work. Before testing the new passphrase
candidate, I changed the existing list to use the expand function, to reduce
the file size and try some new combinations. The list had ~100 manual
passphrase variations, stemming from ~10 templates. After converting them to
use &lt;code&gt;expand&lt;/code&gt;, I ended up with ~1000 variations. These would take some time to
run, but why not? I launched the process and…&lt;/p&gt;

&lt;p&gt;It found the answer after ~50 attempts!&lt;/p&gt;

&lt;p&gt;It found the answer as it was iterating variations of the second passphrase
template, so I did know the passphrase… mostly. I tried connecting to the
server using that key, entered the passphrase, and it worked. It’s kind of
stupid but I was super excited when the script found the answer, even if it’s
useless. This problem lived in the back of my head for six months, and I was a
bit worried and frustrated by the fact that I had no idea what the passphrase
could be. I’m happy that I can take this out of my mind.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;


    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2020-11-16:/articles/self-hosting-nameservers.html</id>
    <title type="html">Self-hosting nameservers for my domains</title>
    <published>2020-11-16T00:00:00Z</published>
    <updated>2020-11-16T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/self-hosting-nameservers.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;In an attempt to self-host all the things, I decided to try self-hosting nameservers for my domains.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;

&lt;p&gt;In an attempt to self-host all the things, I decided to try self-hosting
nameservers for my domains. When I first bought my domains, I was using the
nameservers provided by the registrar. Eventually, I moved them to Route53 so
that I could manage the records in a git repository and apply them via
terraform. Now I just want to get rid of third-parties while still being able
to manage changes via CLI. By hosting my own nameservers, I can keep track of
the zone files in a git repository and rsync them or something to apply the
changes. I bought a new domain I was planning on acquiring anyway so I could
mess with nameservers without breaking any of my existing websites.&lt;/p&gt;

&lt;h2 id=&quot;choosing-the-software&quot;&gt;Choosing the software&lt;/h2&gt;

&lt;p&gt;I know I’ll need to run one authoritative nameserver (or two, if I care about
redundancy), hosting the DNS &lt;a href=&quot;https://tools.ietf.org/html/rfc2181#section-6&quot;&gt;zones&lt;/a&gt; for the domains I want to
manage. I once implemented a &lt;a href=&quot;https://github.com/hugopeixoto/dns&quot;&gt;toy nameserver&lt;/a&gt;, but it’s not exactly
production ready. Going in, I knew of a few options: &lt;a href=&quot;https://www.isc.org/bind/&quot;&gt;BIND&lt;/a&gt;,
&lt;a href=&quot;https://www.powerdns.com/&quot;&gt;PowerDNS&lt;/a&gt;, and &lt;a href=&quot;https://cr.yp.to/djbdns.html&quot;&gt;djbdns&lt;/a&gt;. After asking around, I found out
about &lt;a href=&quot;https://www.nlnetlabs.nl/documentation/nsd/&quot;&gt;NSD&lt;/a&gt; and &lt;a href=&quot;https://www.yadifa.eu/&quot;&gt;YADIFA&lt;/a&gt;. I decided to start with djbdns, whose
implementation is the smallest, at around 10k lines of code.&lt;/p&gt;

&lt;p&gt;I started by launching tinydns (the authoritative server in the djbdns package)
inside an &lt;a href=&quot;https://alpinelinux.org/&quot;&gt;Alpine Linux&lt;/a&gt; container. I installed the server via &lt;code&gt;apk add
djbdns&lt;/code&gt;, and created a data file with the following:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;.example.pt:127.0.0.1
=example.pt:127.0.0.2
=another.example.pt:127.0.0.3
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note that djbdns doesn’t use the common &lt;a href=&quot;https://en.wikipedia.org/wiki/Zone_file&quot;&gt;zone file format&lt;/a&gt;, which is
not trivial to parse, opting instead for a format that’s easily edited by
machines and &lt;a href=&quot;https://cr.yp.to/djbdns/tinydns-data.html&quot;&gt;“reasonably easy for humans to edit”&lt;/a&gt;. The first
character of each line indicates the type of resource that should be created.
Tinydns doesn’t use this file directly, though. You need to convert it using
&lt;code&gt;tinydns-data&lt;/code&gt;, which creates a &lt;code&gt;data.cdb&lt;/code&gt; file that’s optimized for serving
information. Here’s the list of commands I used to get tinydns running:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;container:/# &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;cat data
&lt;/span&gt;.example.pt:127.0.0.1
=example.pt:127.0.0.2
=another.example.pt:127.0.0.3
&lt;span class=&quot;gp&quot;&gt;container:/# &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;apk add djbdns
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;container:/# &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;tinydns-data
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;container:/# &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;mkdir /dns
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;container:/# &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;cp data.cdb /dns
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;container:/# &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;UID=0 GID=0 ROOT=/dns IP=0.0.0.0 tinydns
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I was running the docker container with a port map of 53 to 5300 so that I
could test the nameserver from my host without reserving my computer’s 53 port.
To see if things were working, I used &lt;code&gt;dig&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;laptop:~$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;dig +short example.pt @127.0.0.1 -p 5300
&lt;/span&gt;127.0.0.2
&lt;span class=&quot;gp&quot;&gt;laptop:~$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;dig +short another.example.pt @127.0.0.1 -p 5300
&lt;/span&gt;127.0.0.3
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This was all working fine, so I started converting my zone file to the djbdns
format, when I came across an IPv6 record. &lt;a href=&quot;https://wiki.alpinelinux.org/wiki/TinyDNS_Format&quot;&gt;Alpine’s wiki page on the tinydns
data format&lt;/a&gt; indicated that I should add a line starting
with &lt;code&gt;:&lt;/code&gt;. Other pages mentioned using &lt;code&gt;3&lt;/code&gt;. Neither of these worked, erroring
out with an unknown leading character error.&lt;/p&gt;

&lt;p&gt;Djbdns is not very typical. Its last release was in 2001, and features like
IPv6 and DNSSEC are not supported. These features are available through third
party patches. If we look at &lt;a href=&quot;https://git.alpinelinux.org/aports/tree/main/djbdns/APKBUILD&quot;&gt;Alpine Linux’s build of djbdns&lt;/a&gt;,
we’ll find that there are a bunch of patches listed:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;https://www.fefe.de/dns/djbdns-1.05-test25.diff.bz2&lt;/li&gt;
  &lt;li&gt;headtail.patch&lt;/li&gt;
  &lt;li&gt;dnsroots.patch&lt;/li&gt;
  &lt;li&gt;dnstracesort.patch&lt;/li&gt;
  &lt;li&gt;djbdns-1.05-jumbo-josb.patch&lt;/li&gt;
  &lt;li&gt;1.05-errno.patch&lt;/li&gt;
  &lt;li&gt;1.05-response.patch&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The first patch in the list is a &lt;a href=&quot;https://www.fefe.de/dns/&quot;&gt;well known IPv6 patch&lt;/a&gt;, although
it’s using an outdated version (25, from 2011, instead of 28, from 2016). The
&lt;code&gt;jumbo-josb&lt;/code&gt; patch seems to be a merged version of &lt;code&gt;jumbo-p13&lt;/code&gt; and a patch that
adds &lt;code&gt;SRV&lt;/code&gt; and &lt;code&gt;NAPTR&lt;/code&gt; support. &lt;code&gt;jumbo-p13&lt;/code&gt; is a &lt;a href=&quot;http://lkr.sourceforge.net/djbdns/mywork/jumbo/index.html&quot;&gt;collection of thirteen
patches&lt;/a&gt;, one of which also adds &lt;code&gt;SRV&lt;/code&gt; support. The other patches
don’t add any features and are mostly about fixing the build. I downloaded the
IPv6 and confirmed that it was adding &lt;code&gt;3&lt;/code&gt; and &lt;code&gt;6&lt;/code&gt; as leading character options,
so I started suspecting that something was wrong with their build.&lt;/p&gt;

&lt;p&gt;The first thing I noticed was that the patch was the only one that was being
downloaded instead of &lt;a href=&quot;https://git.alpinelinux.org/aports/tree/main/djbdns&quot;&gt;being commited to the repository&lt;/a&gt;. It
was also the only &lt;code&gt;.diff.bz2&lt;/code&gt; file, with all the other patches being &lt;code&gt;.patch&lt;/code&gt;
files. Checking the &lt;a href=&quot;https://git.alpinelinux.org/aports/log/main/djbdns/APKBUILD&quot;&gt;APKBUILD file history&lt;/a&gt;, I found the &lt;a href=&quot;https://git.alpinelinux.org/aports/commit/main/djbdns/APKBUILD?id=564452f0de9f0b04d025b3a06480896206d9e596&quot;&gt;commit
that added the IPv6 patch&lt;/a&gt;, and part of the diff was a bit
suspicious:&lt;/p&gt;

&lt;div class=&quot;language-diff highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gd&quot;&gt;-build() {
- cd &quot;$srcdir&quot;/$pkgname-$pkgver
- for i in ../*.patch; do
-   msg &quot;Applying $i...&quot;
-   patch -p1 &amp;lt; $i || return 1
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+_builddir=&quot;$srcdir&quot;/$pkgname-$pkgver
+prepare() {
+ cd &quot;$_builddir&quot;
+ for i in $source; do
+   case $i in
+   *.patch) msg $i; patch -p1 -i &quot;$srcdir&quot;/$i || return 1;;
+   *.diff.gz) msg $i; gunzip -c &quot;$srcdir&quot;/$i | patch -p1 || return 1;;
+   esac
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This commit added a &lt;code&gt;diff.bz2&lt;/code&gt; source, but the loop that applied the patches
was modified to handle &lt;code&gt;.diff.gz&lt;/code&gt; files. In a &lt;a href=&quot;https://git.alpinelinux.org/aports/commit/main/djbdns/APKBUILD?id=1db1917442cb087f602dc69b36d22b33b04c05ea&quot;&gt;later
commit&lt;/a&gt;, the loop was replaced with a call to
&lt;a href=&quot;https://git.alpinelinux.org/abuild/tree/abuild.in?id=8ceca11831a3990a14f92ab6aeb83a4b1d54be2b#n691&quot;&gt;&lt;code&gt;default_prepare&lt;/code&gt;&lt;/a&gt;, a function that handles &lt;code&gt;.patch&lt;/code&gt;,
&lt;code&gt;.patch.gz&lt;/code&gt;, and &lt;code&gt;.patch.xz&lt;/code&gt; files. So it seems like the patch has just sitting
there, never being applied.&lt;/p&gt;

&lt;p&gt;To double check that the patch was not being applied, I changed the APKBUILD
file to use a local copy of the patch instead of downloading the &lt;code&gt;.diff.bz2&lt;/code&gt;
file and tried to build the package. I suspected that the patch wouldn’t apply
cleanly, given that it’s a relatively large patch and it would probably
conflict with the jumbo patch. I installed the &lt;code&gt;abuild&lt;/code&gt; tool via &lt;code&gt;apk add
alpine-sdk&lt;/code&gt;, cloned the aports repository, changed the &lt;code&gt;main/djbdns/APKBUILD&lt;/code&gt; file,
and ran &lt;code&gt;abuild checksum &amp;amp;&amp;amp; abuild&lt;/code&gt;, and it failed almost immediately:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;container:/build/aports/main/djbdns$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;grep source APKBUILD -A3
&lt;/span&gt;source=&quot;https://cr.yp.to/djbdns/$pkgname-$pkgver.tar.gz
        djbdns-1.05-test25.patch
        headtail.patch
        dnsroots.patch
&lt;span class=&quot;gp&quot;&gt;container:/build/aports/main/djbdns$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;abuild checksum &amp;amp;&amp;amp; abuild
&lt;/span&gt;&amp;gt;&amp;gt;&amp;gt; djbdns: Fetching https://cr.yp.to/djbdns/djbdns-1.05.tar.gz
&amp;gt;&amp;gt;&amp;gt; djbdns: Updating the sha512sums in APKBUILD...
&amp;gt;&amp;gt;&amp;gt; djbdns: Building main/djbdns 1.05-r47 [...]
&amp;gt;&amp;gt;&amp;gt; [...]
&amp;gt;&amp;gt;&amp;gt; djbdns: Unpacking /var/cache/distfiles/djbdns-1.05.tar.gz...
&amp;gt;&amp;gt;&amp;gt; djbdns: djbdns-1.05-test25.patch
patching file FILES
patching file Makefile
patching file README.ipv6
[...]
&amp;gt;&amp;gt;&amp;gt; djbdns: headtail.patch
patching file Makefile
Hunk #2 FAILED at 205.
Hunk #3 succeeded at 495 (offset 46 lines).
Hunk #4 succeeded at 628 (offset 58 lines).
Hunk #5 succeeded at 816 (offset 58 lines).
Hunk #6 succeeded at 1004 (offset 103 lines).
1 out of 6 hunks FAILED -- saving rejects to file Makefile.rej
&amp;gt;&amp;gt;&amp;gt; ERROR: djbdns: prepare failed
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The build didn’t even had to get to the jumbo patch to hit a conflict. I tried
moving the patch around, which fixed the conflicts with the smaller patches,
but I found no way of avoiding conflicts with the jumbo one, and these are both
significant changes, so I opened an issue on alpine’s repository:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://gitlab.alpinelinux.org/alpine/aports/-/issues/12099&quot;&gt;djbdns: ipv6 patch not being applied&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;To be honest, I’d rather not deal with any of this. Managing third party
patches and ensuring that you’re not messing anything up when merging them
doesn’t sound very secure. Debian used to maintain a fork, &lt;a href=&quot;https://web.archive.org/web/20150919154039/https://packages.debian.org/unstable/dbndns&quot;&gt;dbndns&lt;/a&gt;,
with a few patches applied, but they ended up dropping it. I could spend some
time looking for a decently maintained fork, but I’d rather switch to another
nameserver.&lt;/p&gt;

&lt;p&gt;I switched to &lt;a href=&quot;https://www.nlnetlabs.nl/documentation/nsd/&quot;&gt;NSD&lt;/a&gt;, whose codebase is also on the small side when
compared to BIND. NSD uses standard zone files, so I started writing a zone
file for my domain:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;$ORIGIN example.pt.
$TTL 300
@ IN SOA a.ns root 1 7200 3600 1209600 3600
@ IN NS a.ns
@ IN NS b.ns
@ IN A 127.0.0.1
@ IN AAAA ::1

a.ns IN A 127.0.0.2
b.ns IN A 127.0.0.3
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I stored this in a &lt;code&gt;/zones/example.pt&lt;/code&gt; file, and edited the NSD config file to
read it:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;zone:
  name: example.pt.
  zonefile: /zones/example.pt
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;With &lt;code&gt;nsd -d&lt;/code&gt; running, I was able to query these names from my laptop,
including the IPv6 record:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;laptop:~$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;dig +short example.pt @127.0.0.1 -p 5300
&lt;/span&gt;127.0.0.1
&lt;span class=&quot;gp&quot;&gt;laptop:~$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;dig +short a.ns.example.pt @127.0.0.1 -p 5300
&lt;/span&gt;127.0.0.2
&lt;span class=&quot;gp&quot;&gt;laptop:~$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;dig +short b.ns.example.pt @127.0.0.1 -p 5300
&lt;/span&gt;127.0.0.3
&lt;span class=&quot;gp&quot;&gt;laptop:~$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;dig +short example.pt @127.0.0.1 -p 5300 AAAA
&lt;/span&gt;::1
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;With a zone working, I installed NSD in two of my servers. One of them is
running Debian 10, and I had no issues installing and configuring it. The other
server is running Ubuntu 18.04, and things were a bit harder. Apparently
&lt;code&gt;systemd-resolved&lt;/code&gt; binds port 53, so NSD wasn’t able to start. Since my
/etc/resolv.conf isn’t pointing to the systemd dns server, I disabled it by
setting &lt;code&gt;DNSStubListener=no&lt;/code&gt; in &lt;code&gt;/etc/systemd/resolved.conf&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Now that I had both nameservers working, I had to configure the domain to
actually use them.&lt;/p&gt;

&lt;h2 id=&quot;setting-dns-glue-records&quot;&gt;Setting DNS glue records&lt;/h2&gt;

&lt;p&gt;When you register a domain, you usually set its nameservers by going to the
registrar’s dashboard. They’ll probably default to the registrar’s nameservers,
and if you use route53, you’ll need to change them to something like
&lt;code&gt;ns-YYYY.awsdns-YY.{org,net,com,co.uk}.&lt;/code&gt;. These are stored as &lt;code&gt;NS&lt;/code&gt; entries in
the domain’s top level domain zone. In this case, I want to use my personal
nameservers, but I can’t just put the IP addresses in there; NS records require
a name.&lt;/p&gt;

&lt;p&gt;Since I’m only messing with one domain, my nameservers would have to have names
in the domain they’re managing: &lt;code&gt;a.ns.example.pt&lt;/code&gt; and &lt;code&gt;b.ns.example.pt&lt;/code&gt;, for
example. Setting these as NS records in the TLD zone wouldn’t be enough though,
as we’d be causing a chicken-and-egg problem. To resolve &lt;code&gt;example.pt&lt;/code&gt;, you’d
need to access &lt;code&gt;a.ns.example.pt&lt;/code&gt;, which lives inside the &lt;code&gt;example.pt&lt;/code&gt; zone.
You would have no IP addresses to query. This is where glue records come in.
Instead of just defining the NS record on the TLD, you’re also allowed to add
some A records for the names used in NS entries. These are returned as non
authoritative answers, in the additional section of the response, to help you
break the loop.&lt;/p&gt;

&lt;p&gt;The registrar that I’m using, &lt;a href=&quot;https://ptisp.pt/&quot;&gt;PTisp&lt;/a&gt;, doesn’t seem to expose the glue
records functionality to its clients. I found no way of setting the IP
addresses of my nameservers. I’ve contacted their support, which was a
frustrating experience:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;First, they told me I needed to go to dns.pt, the website of the TLD, and set
the glue records there, but only if I was the technical manager of the domain
(which I’m currently not, they are);&lt;/li&gt;
  &lt;li&gt;I replied asking if that meant that they have no way of letting customers set
the glue records, and if I had to take over the technical management of the
domain;&lt;/li&gt;
  &lt;li&gt;They replied saying that in the .pt TLD there’s no concept of glue records,
and that I could just go to the registrar’s DNS management tool and set two A
records;&lt;/li&gt;
  &lt;li&gt;I replied letting them know that there are plenty of portuguese domains with
glue records, and asking them to clarify what they meant by “setting two A
records”;&lt;/li&gt;
  &lt;li&gt;They replied saying that in .pt domains, I could just create two A records in
the registrar’s tool, and that they would automatically become glue records;&lt;/li&gt;
  &lt;li&gt;At this point I was like “whatever I’ll create the records”, which obviously
didn’t do anything in terms of glue records, and didn’t even set the NS
records at the TLD level. I reported all of that back to them;&lt;/li&gt;
  &lt;li&gt;They told me that now they could proceed with setting the glue records
manually, or that, alternatively, they could hand me the technical management
of the domain so I could do it myself.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;After this kind of useless round of interactions, I feel like I ended up where
I started, so I’m currently waiting for them to transfer management to my
account.&lt;/p&gt;

&lt;p&gt;I also found out that their VPS service doesn’t support IPv6, so one of my
nameservers will have to be IPv4 only, I guess. I’m starting to question if I
should start looking for an alternative provider.&lt;/p&gt;

&lt;h2 id=&quot;conclusions&quot;&gt;Conclusions&lt;/h2&gt;

&lt;p&gt;I started by experimenting with &lt;a href=&quot;https://cr.yp.to/djbdns.html&quot;&gt;djbdns&lt;/a&gt;, found a bug in the alpine
package, and ended up switching to &lt;a href=&quot;https://www.nlnetlabs.nl/documentation/nsd/&quot;&gt;NSD&lt;/a&gt; to avoid having to manage third
party patches. I tried to set up glue records and had an awkward interaction
with my registrar.&lt;/p&gt;

&lt;p&gt;I’m still waiting for my registrar to set up the glue records, but hopefully
that will be the last step. Meanwhile, I’ll start writing zone files for the
other domains. I’m hoping that by the end of the month I will no longer be
using Route53 for any of my personal domains. No more $0.50 per domain per
month for you, Amazon!&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;


    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2020-10-30:/articles/status-update-2020-10-30.html</id>
    <title type="html">Status update, October 2020</title>
    <published>2020-10-30T00:00:00Z</published>
    <updated>2020-10-30T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/status-update-2020-10-30.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;October is over, onto November.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;October is known for &lt;a href=&quot;https://hacktoberfest.digitalocean.com&quot;&gt;Hacktoberfest&lt;/a&gt;. Last year I organized a
couple of local events to promote contributions and help folks get motivated.
This year, I limited myself to attending a portuguese online event:
&lt;a href=&quot;https://interruptor.pt/artigos/interruptor-x-hacktoberfest&quot;&gt;Interruptor x Hacktoberfest&lt;/a&gt;. In the morning I
watched some talks, and during the afternoon we worked on a &lt;a href=&quot;https://github.com/InterruptorPt/ate-onde-chega-cultura&quot;&gt;project that
displays how cultural facilities are spread throughout the
country&lt;/a&gt;. My main contribution was a webpage that
uses leaflet to display data dynamically fetched from wikidata:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/InterruptorPt/ate-onde-chega-cultura/pull/30&quot;&gt;https://github.com/InterruptorPt/ate-onde-chega-cultura/pull/30&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I also built a dashboard to display how many hacktoberfest-qualifying
contributions each participant had made. With all the fuss this year of how
hacktoberfest was disregarding maintainers by making projects opt-out instead
of opt-in, I had to rewrite this when Hacktoberfest changed the rules. The
dashboard itself was hosted at &lt;code&gt;hacktoberfest.hugopeixoto.net&lt;/code&gt;, but since I’ll
probably tear it down now that the event is over, here’s the &lt;a href=&quot;https://web.archive.org/web/20201101174618/https://hacktoberfest.hugopeixoto.net/&quot;&gt;internet archive
link&lt;/a&gt;. The source code is available on my github
account:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/hugopeixoto/hacktoberfest-dashboard/&quot;&gt;https://github.com/hugopeixoto/hacktoberfest-dashboard/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;This dashboard was written in rails, and I was growing tired of following the
setup instructions described in &lt;a href=&quot;/articles/rewriting-a-small-rails-and-react-application.html&quot;&gt;a previous post&lt;/a&gt;, so I
built a rails template repository. that can be used whenever I need to start
another app from scratch. I wrote a &lt;a href=&quot;/articles/rails-template.html&quot;&gt;very short post about
it&lt;/a&gt;, but here’s the link to the repository:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/hugopeixoto/rails-template&quot;&gt;https://github.com/hugopeixoto/rails-template&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I edited and published the 30th episode of my podcast, &lt;a href=&quot;https://conversas.porto.codes&quot;&gt;Conversas em
Código&lt;/a&gt;:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;/articles/conversas-em-codigo-episode-30.html&quot;&gt;Conversas em Código #30: Lighthouse&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;In september, I had written a couple of posts about using Bevy for gamedev.
These posts were featured on the &lt;a href=&quot;https://rust-gamedev.github.io/posts/newsletter-014/#rust-gamedev-ecs-and-bevy&quot;&gt;This Month in Rust GameDev
newsletter&lt;/a&gt;. Having spent some time experimenting with
Rust for gamedev, this month I spent some time &lt;a href=&quot;/articles/making-a-website-with-rust.html&quot;&gt;experimenting with Rust for
webdev&lt;/a&gt;. I wrote a simple file sharing website, first using
&lt;a href=&quot;https://crates.io/crates/warp&quot;&gt;warp&lt;/a&gt;, then using &lt;a href=&quot;https://actix.rs/&quot;&gt;actix-web&lt;/a&gt;:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/hugopeixoto/imghost&quot;&gt;https://github.com/hugopeixoto/imghost&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;This was a relatively simple website, so I didn’t even bother with setting up a
database or using html templates.&lt;/p&gt;

&lt;p&gt;Another thing that happened this month was that Rocket.Chat announced that
&lt;a href=&quot;https://forums.rocket.chat/t/final-update-on-registration-requirement-to-utilize-push-gateway/8951&quot;&gt;they will be limiting the number of push notifications that self-hosted
instances could send through their gateway&lt;/a&gt;.
&lt;a href=&quot;https://direitosdigitais.pt/&quot;&gt;D3&lt;/a&gt; uses Rocket Chat, and we’re way over the 5k
limit, so I spent some time figuring out what we should do. I wrote a blog post
about an unrelated bug we found in their React frontend:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;/articles/fixing-a-bug-in-rocket-chat.html&quot;&gt;Fixing a bug in Rocket Chat&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;One alternative we considered was switching platforms. One thing led to another
and I spent a week learning about &lt;a href=&quot;https://matrix.org&quot;&gt;Matrix&lt;/a&gt;, the main
company behind it, the protocols, &lt;a href=&quot;https://matrix.org/docs/spec/proposals&quot;&gt;their processes&lt;/a&gt;, different
implementations and clients, and &lt;a href=&quot;https://twitter.com/whitequark/status/1321172527914323969&quot;&gt;how hard it is to use a search engine to find
anything related to it&lt;/a&gt;. I don’t think they’re ready to replace
our Rocket Chat instance, but I’ll keep an eye on them.&lt;/p&gt;

&lt;p&gt;In other random news, I finally took the time to stop using &lt;a href=&quot;https://theoldreader.com/&quot;&gt;The Old
Reader&lt;/a&gt; and started using a self hosted instance of
&lt;a href=&quot;https://miniflux.app/&quot;&gt;Miniflux&lt;/a&gt;. I was using their free tier, and I always
had the feeling that I would lose my unread count if I didn’t login in time, so
I decided to switch. Setting Miniflux in my dokku server was easy, since they
have instructions to get it deployed to Heroku. It’s also nice that it’s
written in Go: the app itself only consumes around 11 megabytes of RAM.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;


    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2020-10-29:/articles/fixing-a-bug-in-rocket-chat.html</id>
    <title type="html">Fixing a bug in Rocket Chat</title>
    <published>2020-10-29T00:00:00Z</published>
    <updated>2020-10-29T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/fixing-a-bug-in-rocket-chat.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;After upgrading a Rocket Chat instance, I ran into a bug that causes the frontend to crash when accessing the administration federation dashboard. In this post, I describe the process of finding the cause and fixing it.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;I’m a member of &lt;a href=&quot;https://direitosdigitais.pt/&quot;&gt;D3&lt;/a&gt;, a portuguese association focused on defending digital
rights. We use &lt;a href=&quot;https://rocket.chat/&quot;&gt;Rocket Chat&lt;/a&gt; as our main communication tool (think
Slack, but open source). Recently, Rocket.Chat announced that they’re limiting
the number of monthly mobile push notifications for self hosted instances.
Their new limit is 5000 notifications per month, and we’re way over that
number. September was a particularly active month for us, thanks to the
&lt;a href=&quot;https://edri.org/our-work/defesa-dos-direitos-digitais-opposes-portuguese-efforts-to-make-covid-app-mandatory/&quot;&gt;Stayaway Covid mess&lt;/a&gt;, and we almost hit 20k notifications.&lt;/p&gt;

&lt;p&gt;Side note: with Rocket Chat being open source software, the push notifications
limit may seem strange. This is because the official Android and iOS
applications are published by Rocket.Chat the company, and only they can send
push notifications through &lt;a href=&quot;https://en.wikipedia.org/wiki/Apple_Push_Notification_service&quot;&gt;APNS&lt;/a&gt;/&lt;a href=&quot;https://en.wikipedia.org/wiki/Firebase_Cloud_Messaging&quot;&gt;FCM&lt;/a&gt;. If self-hosters want to
reach users of the official apps, they need to use a gateway provided by the
company. If we wanted to self-host the push notification server to avoid
depending on their gateway, we’d have to publish our own mobile applications.
If you want more info on this, read &lt;a href=&quot;https://thomask.sdf.org/blog/2016/12/11/riots-magical-push-notifications-in-ios.html&quot;&gt;Thomas’s blog post&lt;/a&gt; or check
the &lt;a href=&quot;https://bubu1.eu/openpush/&quot;&gt;Open Push project&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Rocket.Chat announced some paid plans to raise the limit, but before
considering them, we decided to upgrade our instance (we were a bit behind) to
see if the latest version is smarter when deciding whether to send a push
notification. There &lt;a href=&quot;https://github.com/RocketChat/Rocket.Chat/pull/17357&quot;&gt;was a redesign of this logic in 3.2.0&lt;/a&gt;, but
I’m not sure if this will be enough to keep us under 5000 per month.&lt;/p&gt;

&lt;p&gt;Meanwhile, after the upgrade, we were checking if everything was working fine
and we found a bug in the administration panel, in the federation dashboard.
Accessing the dashboard causes the frontend to freeze and the backend logs to
be filled with &lt;code&gt;Error, too many requests&lt;/code&gt; exceptions. The logs pointed to a
problem in &lt;code&gt;federation:getOverviewData&lt;/code&gt; and &lt;code&gt;federation:getServers&lt;/code&gt; calls. A
quick search on github led me to this issue:
&lt;a href=&quot;https://github.com/RocketChat/Rocket.Chat/issues/19007&quot;&gt;https://github.com/RocketChat/Rocket.Chat/issues/19007&lt;/a&gt;. It seems that we’re
not the only ones to experience this problem. The comments were mostly “me too”
and stack traces, so it seemed like no one had started to debug the problem. I
could have just posted a comment saying we were experiencing the same issue,
but I decided to take a look at their codebase to try to add some more
information to the report.&lt;/p&gt;

&lt;p&gt;I had already git cloned &lt;a href=&quot;https://github.com/RocketChat/Rocket.Chat&quot;&gt;https://github.com/RocketChat/Rocket.Chat&lt;/a&gt; and looked
around a bit. It is a monorepo meteor application. I don’t know much about
meteor, but being a monorepo is great for code spelunking, as I didn’t have to
jump around between repositories.&lt;/p&gt;

&lt;p&gt;From the behavior we saw, I expected that the bug would be in the frontend.
Something like a misconfigured retry, perhaps. I started by searching for
&lt;code&gt;federation:getOverviewData&lt;/code&gt;. This looks like a meteor method call, so I was
expecting matches in both the server and the client:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;ack -l federation:getOverviewData
&lt;/span&gt;app/federation/server/methods/dashboard.js
client/admin/federationDashboard/OverviewSection.js
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The &lt;code&gt;client/../OverviewSection.ts&lt;/code&gt; file contains a react functional component,
&lt;code&gt;OverviewSection&lt;/code&gt;. It’s a small file, and here’s the part that’s relevant to
this bug hunt, reformatted for clarity:&lt;/p&gt;

&lt;div class=&quot;language-javascript highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;usePolledMethodData&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&#39;&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;../../contexts/ServerContext&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;kd&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;OverviewSection&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;overviewData&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;overviewStatus&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;usePolledMethodData&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&#39;&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;federation:getOverviewData&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;[],&lt;/span&gt;
    &lt;span class=&quot;mi&quot;&gt;10000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;// bunch of ifs and presentational components&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;code&gt;usePolledMethodData&lt;/code&gt; and its arguments are key here. This is using the &lt;code&gt;use*&lt;/code&gt;
prefix, a pattern usually reserved for React &lt;a href=&quot;https://reactjs.org/docs/hooks-intro.html&quot;&gt;hooks&lt;/a&gt;. Following
the trail of &lt;code&gt;usePolledMethodData&lt;/code&gt;, here is the relevant code from
&lt;code&gt;ServerContext.ts&lt;/code&gt; (adapted from &lt;a href=&quot;https://github.com/RocketChat/Rocket.Chat/blob/3.7.1/client/contexts/ServerContext.ts&quot;&gt;the 3.7.1 release&lt;/a&gt;):&lt;/p&gt;

&lt;div class=&quot;language-typescript highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;createContext&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;useCallback&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;useContext&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;useState&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;useEffect&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&#39;&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;react&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;ServerContext&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;createContext&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;({&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;callMethod&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;undefined&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// bunch of other stuff&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;});&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;useMethod&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;methodName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;callMethod&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;useContext&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;ServerContext&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;useCallback&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;(...&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;callMethod&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;methodName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;callMethod&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;methodName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;useMethodData&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;methodName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[])&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;getData&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;useMethod&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;methodName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;updateState&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;useState&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;
    &lt;span class=&quot;kc&quot;&gt;undefined&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;nx&quot;&gt;AsyncState&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;LOADING&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;]);&lt;/span&gt;

  &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;fetchData&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;useCallback&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nx&quot;&gt;updateState&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(([&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;AsyncState&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;LOADING&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]);&lt;/span&gt;

    &lt;span class=&quot;nx&quot;&gt;getData&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(...&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;then&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;nx&quot;&gt;updateState&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;AsyncState&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;DONE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]);&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}).&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;catch&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;nx&quot;&gt;updateState&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(([&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;AsyncState&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;ERROR&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]);&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;});&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;getData&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]);&lt;/span&gt;

  &lt;span class=&quot;nx&quot;&gt;useEffect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nx&quot;&gt;fetchData&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;fetchData&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]);&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;fetchData&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;usePolledMethodData&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;methodName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[],&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;intervalMs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;fetchData&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;useMethodData&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;methodName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

  &lt;span class=&quot;nx&quot;&gt;useEffect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;timer&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;setInterval&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;fetchData&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;intervalMs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;clearInterval&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;timer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;fetchData&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;intervalMs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]);&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;fetchData&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There are a few things that stand out. It’s using &lt;code&gt;setInterval&lt;/code&gt;, so maybe the
bug could be from setting the wrong number of milliseconds. There are many
&lt;code&gt;useEffect&lt;/code&gt;s and &lt;code&gt;useCallback&lt;/code&gt;s, so the bug could be in their dependencies. For
example, if &lt;code&gt;fetchData&lt;/code&gt; changes in every frame, a new timer is created in every
tick (with the previous one being cancelled). There doesn’t seem to be any
retry code. At first glance I didn’t notice anything wrong with &lt;code&gt;setInterval&lt;/code&gt;’s
parameters, so I was leaning towards the hook dependency hypothesis.&lt;/p&gt;

&lt;p&gt;This was everything that I could find without running the code, and I felt like
it was enough information to provide some value to the bug report, so &lt;a href=&quot;https://github.com/RocketChat/Rocket.Chat/issues/19007#issuecomment-717316714&quot;&gt;I posted
this suggestion in the github issue&lt;/a&gt;. I could’ve stopped
here, but I decided to try to find the actual issue and fix it.&lt;/p&gt;

&lt;p&gt;This is a meteor app, and their installation instructions is based on a &lt;code&gt;curl |
sh&lt;/code&gt; command, so I decided to write a Dockerfile to avoid installing it in my
system:&lt;/p&gt;

&lt;div class=&quot;language-dockerfile highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; debian&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;apt update
&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;apt &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;curl procps git vim
&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;curl https://install.meteor.com/ | sh
&lt;span class=&quot;k&quot;&gt;WORKDIR&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; /app&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;ENV&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; METEOR_ALLOW_SUPERUSER=true&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;meteor npm &lt;span class=&quot;nb&quot;&gt;install&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;docker build . -t rocket-chat
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;docker run --rm -it -v $PWD:/app -p3000:3000 rocket-chat:latest
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Once inside the container, I can run the app with &lt;code&gt;meteor npm start&lt;/code&gt;, and it
handles everything for me, including launching a mongodb server. Accessing
&lt;code&gt;http://localhost:3000&lt;/code&gt; lets me set up the Rocket Chat account and I’m in. This
whole process was way easier than what I was expecting. When I was &lt;a href=&quot;https://github.com/forem/forem/pull/10476&quot;&gt;fixing a
bug in forem&lt;/a&gt;, running things wasn’t this easy. Now that I had
Rocket Chat running, I could access the federation dashboard and reproduce the
issue.&lt;/p&gt;

&lt;p&gt;Usually I would try to reproduce this in a test, but this codebase doesn’t seem
to have any tests for their hooks. It would take me more time that what I
wanted to spend to learn how to test this properly, so I ended up changing the
code and reloading the browser. This was not ideal, since each reload would
almost crash my browser unless I was fast enough to hit the “pause” button on
the debugger before everything froze, but fortunately I only had to forcefully
stop firefox once.&lt;/p&gt;

&lt;p&gt;After some iterations of adding console logs and removing useEffect
dependencies to be sure, I tracked down the problem to the &lt;code&gt;useEffect&lt;/code&gt; function
in &lt;code&gt;useMethodData&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-typescript highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;createContext&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;useCallback&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;useContext&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;useEffect&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&#39;&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;react&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;ServerContext&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;createContext&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;({&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;callMethod&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;undefined&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// ...&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;});&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;useMethod&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;methodName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;callMethod&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;useContext&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;ServerContext&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;useCallback&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;cm&quot;&gt;/**/&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;callMethod&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;methodName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;useMethodData&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;methodName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[])&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;getData&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;useMethod&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;methodName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;fetchData&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;useCallback&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nx&quot;&gt;console&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;calling fetchData&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// ...&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;getData&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]);&lt;/span&gt;

  &lt;span class=&quot;nx&quot;&gt;useEffect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nx&quot;&gt;console&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;calling fetchData from useMethodData.useEffect&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;nx&quot;&gt;fetchData&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;fetchData&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]);&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// ...&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;usePolledMethodData&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;methodName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[],&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;intervalMs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;cm&quot;&gt;/**/&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;useMethodData&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;methodName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// ...&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;

&lt;span class=&quot;kd&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;OverviewSection&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;cm&quot;&gt;/**/&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;usePolledMethodData&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&#39;&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;federation:getOverviewData&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[],&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;10000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// ...&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Both &lt;code&gt;console.log&lt;/code&gt;s were being executed nonstop, without any delay. The
function passed to &lt;code&gt;useEffect&lt;/code&gt; is only executed when a dependency changes, so
this meant that &lt;code&gt;fetchData&lt;/code&gt; was changing. As fetchData is being memoized by
&lt;code&gt;useCallback&lt;/code&gt; and it was changing, then one of its dependencies was also
changing : either &lt;code&gt;getData&lt;/code&gt; or &lt;code&gt;args&lt;/code&gt;. Removing every dependency by replacing
both &lt;code&gt;[getData, args]&lt;/code&gt; and &lt;code&gt;[fetchData]&lt;/code&gt; with &lt;code&gt;[]&lt;/code&gt;, stopped the infinite http
request loop.&lt;/p&gt;

&lt;p&gt;After some more iterations of adding and removing dependencies, I narrowed down
the problematic dependency to &lt;code&gt;args&lt;/code&gt;. I wasn’t really expecting this; usually
it’s a function that’s not being properly memoized, and I was expecting it to
be &lt;code&gt;getData&lt;/code&gt;. &lt;code&gt;args&lt;/code&gt; was always being set to &lt;code&gt;[]&lt;/code&gt;, so I had little reason to
suspect it was the problem.&lt;/p&gt;

&lt;p&gt;To understand why &lt;code&gt;args&lt;/code&gt; was causing the bug, I checked what’s used by
&lt;code&gt;useEffect&lt;/code&gt; to check if dependencies change. It uses &lt;code&gt;Object.is&lt;/code&gt;. This is
similar but not exactly the same as &lt;code&gt;===&lt;/code&gt; (&lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/is#Description&quot;&gt;there are some differences when
handling signed zeros and &lt;code&gt;NaN&lt;/code&gt;s&lt;/a&gt;). The following snippet
illustrates the problem:&lt;/p&gt;

&lt;div class=&quot;language-typescript highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Object&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;is&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([],&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[])&lt;/span&gt;
&lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[];&lt;/span&gt;
&lt;span class=&quot;kc&quot;&gt;undefined&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Object&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;is&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This explains the problem. &lt;code&gt;OverviewSection&lt;/code&gt; is passing a literal &lt;code&gt;[]&lt;/code&gt; as
&lt;code&gt;args. Each call to &lt;/code&gt;[]&lt;code&gt; creates a new array, so &lt;/code&gt;OverviewSection&lt;code&gt; will never
pass the same array to &lt;/code&gt;usePolledMethodData&lt;code&gt;, causing &lt;/code&gt;fetchData&lt;code&gt; to be
recomputed every time, causing &lt;/code&gt;useEffect`’s body to run every time as well,
causing the bug.&lt;/p&gt;

&lt;p&gt;Now that the problem with the code has been identified, there are many ways to
fix it.&lt;/p&gt;

&lt;p&gt;We can use &lt;code&gt;[getData, ...args]&lt;/code&gt; instead of &lt;code&gt;[getData, args]&lt;/code&gt;. This will remove
the array from the equation, but may cause additional problems if any of the
arguments is an array or an object.&lt;/p&gt;

&lt;p&gt;We can memoize &lt;code&gt;[]&lt;/code&gt; in the caller, ensuring that we’re always passing the same
&lt;code&gt;[]&lt;/code&gt;. We can do this by using &lt;code&gt;useMemo(() =&amp;gt; [], [])&lt;/code&gt; instead of &lt;code&gt;[]&lt;/code&gt;. This has
the problem of not solving the issue for every caller of &lt;code&gt;useMethodData&lt;/code&gt;, so
the bug can reappear the next time someone tries to use this hook or when
existing code gets refactored, as tests don’t currently cover this part of the
codebase.&lt;/p&gt;

&lt;p&gt;We can use &lt;code&gt;[getData, JSON.stringify(args)]&lt;/code&gt;. Strings with the same contents
are considered the same when using &lt;code&gt;Object.is&lt;/code&gt;. This has the extra overhead of
having to create the json string, and &lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Errors/Cyclic_object_value&quot;&gt;can cause some issues if try to
serialize cyclic objects&lt;/a&gt;, but this will have to be serialized
to be sent to the meteor server (we’re in the context of a method call), so the
cycle problem doesn’t apply here.&lt;/p&gt;

&lt;p&gt;The third option seemed the best one, and I started writing the PR
description. One thing I like to include in the PR description is how the
bug appeared in the first place. Even without tests, this had to work at some
point; I don’t think someone would just push broken code from the start. My
guess was that there was some change (maybe a refactor, or a lint fix, or
something) unrelated to the feature itself and this page wasn’t checked. I
checked the git history of both &lt;code&gt;ServerContext.ts&lt;/code&gt; and &lt;code&gt;OverviewSection.js&lt;/code&gt; and
found a &lt;a href=&quot;https://github.com/RocketChat/Rocket.Chat/pull/18520/files#diff-f583b8823d768b595b4c2d5f3ea4b9498380a1802c96061bcebe5d5c3261f60b&quot;&gt;change in ServerContext&lt;/a&gt; that shows that the original
code was &lt;code&gt;[getData, ...args]&lt;/code&gt;, one of the solutions I mentioned. This PR is
mostly changing type stuff, so the author probably didn’t go through the
Federation dashboard page. At this point I had enough info to make a PR:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/RocketChat/Rocket.Chat/pull/19386&quot;&gt;https://github.com/RocketChat/Rocket.Chat/pull/19386&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Another thing that I &lt;strong&gt;should&lt;/strong&gt; have checked is that I was working on an up to
date branch. I noticed that I was working on an outdated commit when I saw the
“This branch is out-of-date with the base branch” message on github. I usually
clone the repository immediately before working on the bug I’m trying to fix so
this isn’t a problem, but I had cloned this repository a month ago to check how
hard it would be to &lt;a href=&quot;https://github.com/RocketChat/Rocket.Chat/issues/8005&quot;&gt;implement channel visibility based on
roles&lt;/a&gt;, and it didn’t register that this had been so long ago,
so I didn’t bother to git pull.&lt;/p&gt;

&lt;p&gt;When rebasing, I noticed that &lt;code&gt;OverviewSection.js&lt;/code&gt; had been changed… to use
&lt;code&gt;useMemo(() =&amp;gt; [], [])&lt;/code&gt;. This change was included in another &lt;a href=&quot;https://github.com/RocketChat/Rocket.Chat/pull/19202/commits/bea56626d0591c0e75b053a6e9271b77c4e929ca&quot;&gt;refactor
PR&lt;/a&gt;, which was merged 16 days ago. The latest release was 20 days
ago, so there’s no release that includes this fix yet. There are no references
to this PR in the original issue, so I didn’t expect the issue to already be
fixed. I should have double checked the branch I was working on.&lt;/p&gt;

&lt;p&gt;I think that &lt;code&gt;JSON.stringify&lt;/code&gt; on the function is a better solution than
&lt;code&gt;useMemo&lt;/code&gt; on the caller, so I updated my PR to remove the useMemo calls. Right
now, there are 230 pull requests open, so I’m not sure if this will be picked
up or not. At least I built up some extra knowledge on react hooks.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;


    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2020-10-24:/articles/rails-template.html</id>
    <title type="html">Rails template</title>
    <published>2020-10-24T00:00:00Z</published>
    <updated>2020-10-24T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/rails-template.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;I created a rails template to avoid having to go through the same setup steps over and over again: &lt;a href=&quot;https://github.com/hugopeixoto/rails-template&quot;&gt;https://github.com/hugopeixoto/rails-template&lt;/a&gt;&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;A few months ago, &lt;a href=&quot;https://hugopeixoto.net/articles/rewriting-a-small-rails-and-react-application.html&quot;&gt;I blogged about my process of setting up a new rails
app&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Since then, I’ve created three or four rails apps by following those steps.
This week I was following those steps manually yet again, so I decided to
automate it.&lt;/p&gt;

&lt;p&gt;I created a new rails app, followed those steps manually, and published the
resulting repository:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/hugopeixoto/rails-template&quot;&gt;https://github.com/hugopeixoto/rails-template&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Now whenever I want to create a new app, I can start from this repository.&lt;/p&gt;

&lt;p&gt;I created one commit per step, roughly, so it’s easier to understand what going
on. To avoid having the list of commits growing with time as gems get updated,
I will probably amend changes of making new commits.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;


    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2020-10-19:/articles/conversas-em-codigo-episode-30.html</id>
    <title type="html">Conversas em Código Episode #30 released</title>
    <published>2020-10-19T00:00:00Z</published>
    <updated>2020-10-19T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/conversas-em-codigo-episode-30.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;I’ve published a new episode of Conversas em Código - &lt;a href=&quot;https://conversas.porto.codes/episodes/google-lighthouse&quot;&gt;Episode 30: Google Lighthouse&lt;/a&gt;&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;p&gt;I’ve published a new episode of Conversas em Código (in Portuguese):&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://conversas.porto.codes/episodes/google-lighthouse&quot;&gt;Episode 30: Google Lighthouse&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Neste episódio falamos sobre o Google Lighthouse, uma ferramenta open source
para analisar a qualidade de páginas web.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;See the full episode list here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://conversas.porto.codes&quot;&gt;https://conversas.porto.codes&lt;/a&gt;&lt;/p&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2020-10-05:/articles/making-a-website-with-rust.html</id>
    <title type="html">Making a website with Rust</title>
    <published>2020-10-05T00:00:00Z</published>
    <updated>2020-10-05T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/making-a-website-with-rust.html"/>
    <summary type="html">
      <![CDATA[]]>
    </summary>
    <content type="html">
      <![CDATA[
        <aside>
          This is a <code>[journal]</code> entry. It is longer than usual and
          more exploratory. It may have no proper conclusion.
        </aside>
      ]]>

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;

&lt;p&gt;A couple of days ago, in a random chat, someone mentioned setting up a image
host on their servers. This led me to search for self hosted FOSS alternatives
to services like imgur. I found a few:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/andreimarcu/linx-server&quot;&gt;linx-server&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/HaschekSolutions/pictshare&quot;&gt;pictshare&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;They both look to have more than enough features. This should have been the end
of the story, but, well.&lt;/p&gt;

&lt;p&gt;I figured this would be a good example to try to build in Rust. I never built
anything web related in Rust, and this webapp would only have two pages: one
for uploading files and one for displaying an uploaded file.&lt;/p&gt;

&lt;p&gt;I started by going to &lt;a href=&quot;https://www.arewewebyet.org/&quot;&gt;Are we web yet&lt;/a&gt;. I think
that this website doesn’t get many updates, but it’s a good starting point.&lt;/p&gt;

&lt;p&gt;They present us with a list of web frameworks. I’ve heard of &lt;code&gt;actix-web&lt;/code&gt;,
&lt;code&gt;rocket&lt;/code&gt;, &lt;code&gt;gotham&lt;/code&gt;, and &lt;code&gt;warp&lt;/code&gt;. I decided to with &lt;code&gt;warp&lt;/code&gt;, with no real
reasoning behind it except the examples in their readme. Most of the news I’ve
been seeing regarding rust webdev are related to async I/O, which are probably
great news, but for me right now the performance doesn’t matter as much as the
ease of use.&lt;/p&gt;

&lt;p&gt;My goal was to build something with the following endpoints:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;code&gt;GET /&lt;/code&gt;: returns an HTML page with a form with a file field&lt;/li&gt;
  &lt;li&gt;&lt;code&gt;POST /file&lt;/code&gt;: receives an image, stores it, and redirects to the display page&lt;/li&gt;
  &lt;li&gt;&lt;code&gt;GET /image/&amp;lt;id&amp;gt;&lt;/code&gt;: returns an HTML page displaying the uploaded image&lt;/li&gt;
  &lt;li&gt;&lt;code&gt;GET /image/raw/&amp;lt;id&amp;gt;&lt;/code&gt;: returns the raw contents&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Since this is a simple app, I decided to go minimal, to minimize the framework
requirements. No database, files would be stored directly on disk. No html
templates, strings would be hardcoded. No asset management. No authentication,
no CORS.&lt;/p&gt;

&lt;h2 id=&quot;first-iteration&quot;&gt;First iteration&lt;/h2&gt;

&lt;p&gt;It took me a couple of hours to get it running. This is what my first iteration
looked like:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;futures&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;stream&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;TryStreamExt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;http&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Uri&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;fs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;File&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;io&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;prelude&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;warp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Buf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;warp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Filter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;index&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;impl&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;warp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Reply&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;nn&quot;&gt;warp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;html&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&amp;lt;html&amp;gt;form goes here &amp;lt;/html&amp;gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;upload&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;form&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;warp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;multipart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FormData&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Result&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;impl&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;warp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Reply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;warp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Rejection&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;warp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;multipart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Part&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;form&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.try_collect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;.await&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.map_err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(|&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;warp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;reject&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;reject&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;u128&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;rand&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;random&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;file&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;File&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;create&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nd&quot;&gt;format!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;public/{}&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.unwrap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.write_all&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;.await&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.unwrap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.unwrap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.bytes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.unwrap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

  &lt;span class=&quot;nf&quot;&gt;Ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;warp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;redirect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;redirect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;nd&quot;&gt;format!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;/image/{}&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.parse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Uri&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.unwrap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;show_html&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;impl&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;warp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Reply&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;nn&quot;&gt;warp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;html&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nd&quot;&gt;format!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&amp;lt;html&amp;gt;&amp;lt;img src=&#39;{}&#39;/&amp;gt;&amp;lt;/html&amp;gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;nd&quot;&gt;#[tokio::main]&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;index&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;warp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.and&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;warp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;index&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;upload&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;warp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;upload&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.and&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;warp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;multipart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;form&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.max_length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;100_000_000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.and_then&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;upload&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;show_html&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;warp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nd&quot;&gt;path!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;image&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.and&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;warp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;show_html&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;show_raw&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;warp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nd&quot;&gt;path!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;image&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;raw&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.and&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;warp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;fs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;dir&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;public&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;router&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;index&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.or&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;upload&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.or&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;show_html&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.or&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;show_raw&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

  &lt;span class=&quot;nn&quot;&gt;warp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;serve&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;router&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.run&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(([&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;127&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;3030&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;.await&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is very janky and full of &lt;code&gt;unwrap&lt;/code&gt;s, but I wanted to get something working
first. I got rid of most of them in the following iterations.&lt;/p&gt;

&lt;h2 id=&quot;multipart-handling&quot;&gt;Multipart handling&lt;/h2&gt;

&lt;p&gt;The main thing that tripped me was handling multiparts. &lt;code&gt;warp&lt;/code&gt; has &lt;a href=&quot;https://docs.rs/warp/0.2.5/warp/filters/multipart/index.html&quot;&gt;some
functionality to match multipart
requests&lt;/a&gt;, but
working with multipart content is not that easy. In this first attempt I’m not
even making sure that I’m looking at the right part.&lt;/p&gt;

&lt;p&gt;There’s a &lt;a href=&quot;https://crates.io/crates/multipart&quot;&gt;&lt;code&gt;multipart&lt;/code&gt;&lt;/a&gt; crate that creates
an abstraction layer for that, but it’s only for sync APIs. The async
(&lt;a href=&quot;https://github.com/abonander/multipart-async&quot;&gt;&lt;code&gt;multipart-async&lt;/code&gt;&lt;/a&gt;) version
hasn’t seen any releases yet.&lt;/p&gt;

&lt;p&gt;After a while I added support for &lt;code&gt;alt&lt;/code&gt; text for the images, which required
having another parameter in the POST payload. This required me to start
handling multipart forms properly. I created some methods to help with
extracting information from the &lt;code&gt;FormData&lt;/code&gt; object:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;readall&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;stream&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;impl&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;futures&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Stream&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Item&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Result&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;impl&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Buf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;warp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Result&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;u8&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;warp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;stream&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.try_fold&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nd&quot;&gt;vec!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[],&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;result&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;buf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;result&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.append&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;buf&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.bytes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.into&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;());&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;move&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;Ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;result&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;.await&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;parse_upload_multipart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;form&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;warp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;multipart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FormData&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Result&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;UploadForm&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Box&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dyn&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;form&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.try_collect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;.await&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get_part&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;str&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt;
      &lt;span class=&quot;nf&quot;&gt;.iter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
      &lt;span class=&quot;nf&quot;&gt;.position&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;part&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;part&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;nf&quot;&gt;.map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.swap_remove&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
      &lt;span class=&quot;nf&quot;&gt;.ok_or&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nd&quot;&gt;format!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;{} part not found&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;alt&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;get_part&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;alt&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;file&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;get_part&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;file&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;file_content_type&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.content_type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ct&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ct&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.to_string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;());&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;file_contents&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;readall&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.stream&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;.await&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;alt_text&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;readall&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;alt&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.stream&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;.await&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;nf&quot;&gt;Ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;UploadForm&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;alt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;from_utf8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;alt_text&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;file_contents&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;content_type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;file_content_type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I had to &lt;a href=&quot;https://doc.rust-lang.org/1.8.0/book/references-and-borrowing.html&quot;&gt;fight the borrow
checker&lt;/a&gt; a
bit to get &lt;code&gt;get_part&lt;/code&gt; working. Initially I was trying to use &lt;code&gt;find()&lt;/code&gt; instead
of &lt;code&gt;position()&lt;/code&gt;, but I wouldn’t be able to call it twice; I need to move the
element out of the vector, and that would mean that &lt;code&gt;parts&lt;/code&gt; would be moved
during the first call, which would make the second call uncompilable. Using
&lt;code&gt;position&lt;/code&gt; and &lt;code&gt;swap_remove&lt;/code&gt; lets me move the element out of the vector.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;readall&lt;/code&gt; was weird to figure out. I was following &lt;a href=&quot;https://blog.logrocket.com/file-upload-and-download-in-rust/&quot;&gt;LogRocket’s blog post on
file uploading&lt;/a&gt;.
I tried to simplify it but I don’t understand the &lt;code&gt;futures::Stream&lt;/code&gt; interface
that well, so I ended up leaving it as is.&lt;/p&gt;

&lt;p&gt;I thought about trying to avoid loading the whole &lt;code&gt;file_contents&lt;/code&gt; array onto
memory and rely on piping it directly to disk, but I will eventually need to
access the bytes to do mime type detection (maybe using
&lt;a href=&quot;https://github.com/flier/rust-mime-sniffer&quot;&gt;&lt;code&gt;mime_sniffer&lt;/code&gt;&lt;/a&gt;?). Also, since I’m
collecting the parts to be able to index them by name, the full payload must be
already read from the socket and in memory.&lt;/p&gt;

&lt;h2 id=&quot;serde&quot;&gt;Serde&lt;/h2&gt;

&lt;p&gt;To store the &lt;code&gt;alt&lt;/code&gt; text I decided to use a JSON file per file. I knew that
serializing things was done with &lt;a href=&quot;https://serde.rs/&quot;&gt;&lt;code&gt;serde&lt;/code&gt;&lt;/a&gt;, so I gave it a
try. Storing basic types was straightforward:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;nd&quot;&gt;#[derive(Serialize,&lt;/span&gt; &lt;span class=&quot;nd&quot;&gt;Deserialize)]&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Upload&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;alt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;content_type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Option&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;store_metadata&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;u128&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;metadata&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Upload&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;alt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;Dancing Ferris&quot;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.to_string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;content_type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;Some&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;image/png&quot;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.to_string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()),&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;metadata_file&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;File&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;create&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nd&quot;&gt;format!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;public/{}.json&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.unwrap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
  &lt;span class=&quot;nn&quot;&gt;serde_json&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;to_writer_pretty&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;metadata_file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.unwrap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I wanted to use &lt;code&gt;mime::Mime&lt;/code&gt; instead of a &lt;code&gt;String&lt;/code&gt; for the content type,
though. Since that type does not implement Serialize nor Deserialize, making it
work was a bit painful. I can’t implement a trait for a type when both of them
come from external crates. This is called the &lt;a href=&quot;https://doc.rust-lang.org/book/ch10-02-traits.html#implementing-a-trait-on-a-type&quot;&gt;orphan
rule&lt;/a&gt;.
Serde is aware of this limitation, and they have a &lt;a href=&quot;https://serde.rs/remote-derive.html&quot;&gt;page in their documentation
addressing this issue and how to work around it
&lt;/a&gt;. Unfortunately, since in this case the
type is wrapped in an &lt;code&gt;Option&lt;/code&gt;, none of their solutions applies.&lt;/p&gt;

&lt;p&gt;At first, I ignored this problem and used &lt;code&gt;Option&amp;lt;String&amp;gt;&lt;/code&gt;, but this feels like
one of those things that I will need to fully understand if I want to use rust
for webdev effectively, since there’s always a lot of serialization and
deserialization going on.&lt;/p&gt;

&lt;p&gt;After some experimentation, I was able to come up with two solutions. The first
one involves creating a proxy object, &lt;code&gt;UploadSerializable&lt;/code&gt;, that uses
&lt;code&gt;Option&amp;lt;String&amp;gt;&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;nd&quot;&gt;#[derive(Clone,&lt;/span&gt; &lt;span class=&quot;nd&quot;&gt;Serialize,&lt;/span&gt; &lt;span class=&quot;nd&quot;&gt;Deserialize)]&lt;/span&gt;
&lt;span class=&quot;nd&quot;&gt;#[serde(try_from&lt;/span&gt; &lt;span class=&quot;nd&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;UploadSerializable&quot;&lt;/span&gt;&lt;span class=&quot;nd&quot;&gt;)]&lt;/span&gt;
&lt;span class=&quot;nd&quot;&gt;#[serde(into&lt;/span&gt; &lt;span class=&quot;nd&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;UploadSerializable&quot;&lt;/span&gt;&lt;span class=&quot;nd&quot;&gt;)]&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Upload&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;alt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;content_type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Option&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;mime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Mime&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;nd&quot;&gt;#[derive(Serialize,&lt;/span&gt; &lt;span class=&quot;nd&quot;&gt;Deserialize)]&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;UploadSerializable&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;alt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;content_type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Option&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;impl&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;convert&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;TryFrom&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;UploadSerializable&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Upload&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Error&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;mime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FromStrError&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;try_from&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;UploadSerializable&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Result&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Upload&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;Self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;Ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Upload&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;alt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.alt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;content_type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.content_type&lt;/span&gt;
                         &lt;span class=&quot;nf&quot;&gt;.map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ct&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ct&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.parse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;mime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Mime&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
                         &lt;span class=&quot;nf&quot;&gt;.transpose&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;impl&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;convert&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;From&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Upload&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;UploadSerializable&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;from&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Upload&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;UploadSerializable&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;UploadSerializable&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;alt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.alt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;content_type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.content_type&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ct&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ct&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.to_string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()),&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is not ideal, because every time I change &lt;code&gt;Upload&lt;/code&gt; I need to adapt
&lt;code&gt;UploadSerializable&lt;/code&gt; and both trait implementations. I searched &lt;a href=&quot;https://serde.rs/attributes.html&quot;&gt;serde’s
attribute list&lt;/a&gt; to see if I could use
something else, and found &lt;code&gt;serialize_with&lt;/code&gt; and &lt;code&gt;deserialize_with&lt;/code&gt;. This led me
to the second solution:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;core&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;nd&quot;&gt;#[derive(Clone,&lt;/span&gt; &lt;span class=&quot;nd&quot;&gt;Serialize,&lt;/span&gt; &lt;span class=&quot;nd&quot;&gt;Deserialize)]&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Upload&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;alt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;nd&quot;&gt;#[serde(serialize_with&lt;/span&gt; &lt;span class=&quot;nd&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;optional_mime_serializer&quot;&lt;/span&gt;&lt;span class=&quot;nd&quot;&gt;)]&lt;/span&gt;
  &lt;span class=&quot;nd&quot;&gt;#[serde(deserialize_with&lt;/span&gt; &lt;span class=&quot;nd&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;optional_mime_deserializer&quot;&lt;/span&gt;&lt;span class=&quot;nd&quot;&gt;)]&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;content_type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Option&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;mime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Mime&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;optional_mime_serializer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;S&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;Option&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;mime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Mime&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;serializer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;S&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Result&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;S&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;Ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;S&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;where&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;S&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;serde&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Serializer&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.clone&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.to_string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.serialize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;serializer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;optional_mime_deserializer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;&#39;de&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;D&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;deserializer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;D&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Result&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;Option&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;mime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Mime&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;D&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;where&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;D&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;serde&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Deserializer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;&#39;de&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;OptionalMimeVisitor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;impl&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;&#39;de&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;serde&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;de&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Visitor&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;&#39;de&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;OptionalMimeVisitor&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Option&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;mime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Mime&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;expecting&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;formatter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Formatter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Result&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;formatter&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.write_str&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;an optional mime type&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;visit_some&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;D&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;deserializer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;D&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Result&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;Self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;D&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;where&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;D&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;serde&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Deserializer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;&#39;de&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;deserializer&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.deserialize_string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;OptionalMimeVisitor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;visit_str&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;E&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;str&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Result&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;Self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;E&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;where&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;E&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;serde&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;de&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Error&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;nf&quot;&gt;Some&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.parse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;mime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Mime&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
        &lt;span class=&quot;nf&quot;&gt;.transpose&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
        &lt;span class=&quot;nf&quot;&gt;.map_err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;serde&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;de&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;custom&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;visit_none&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;E&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Result&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;Self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;E&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;where&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;E&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;serde&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;de&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Error&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;nf&quot;&gt;Ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;None&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;deserializer&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.deserialize_option&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;OptionalMimeVisitor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The serializer looks ok, but the deserializer is kind of terrible. The only
lines that really matter are &lt;code&gt;v.parse::&amp;lt;mime::Mime&amp;gt;().transpose()&lt;/code&gt;. I wish I
didn’t have to write the rest of the boilerplate. Maybe there’s an easier way
to do this, somehow tell serde that whenever it sees a &lt;code&gt;mime::Mime&lt;/code&gt; in the
object tree it should use a given proxy object, but I didn’t find it.&lt;/p&gt;

&lt;p&gt;Now that I had mime types stored on disk, I could use them to render the HTML
according to the type of file we’re serving. With serde, reading the JSON file
was easy:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;show_html&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;impl&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;warp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Reply&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;upload&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Result&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Upload&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
    &lt;span class=&quot;nn&quot;&gt;serde_json&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;from_reader&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;File&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nd&quot;&gt;format!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;public/{}.json&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.unwrap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;());&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;upload&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;Ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;u&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ct&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;u&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.content_type&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.unwrap_or&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;image/png&quot;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.to_string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;());&lt;/span&gt;
      &lt;span class=&quot;c&quot;&gt;// render things based on ct&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;Err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;cm&quot;&gt;/* ... */&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I had some duplication here, since some of the document markup is the same
independently of the content type, but it was good enough, considering I didn’t
want to deal with templates.&lt;/p&gt;

&lt;h2 id=&quot;serving-files-from-disk-with-custom-headers&quot;&gt;Serving files from disk with custom headers&lt;/h2&gt;

&lt;p&gt;I also wanted to change &lt;code&gt;show_raw&lt;/code&gt; to send the stored Content-Type, instead of
it trying to infer from the filename extnsion (the default behaviour of
&lt;code&gt;warp::fs::dir&lt;/code&gt;). This is what I ended up with:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;to_rejection&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;E&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;E&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;warp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Rejection&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nn&quot;&gt;warp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;reject&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;reject&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;show_raw&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Result&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;impl&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;warp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Reply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;warp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Rejection&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;upload&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Upload&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;File&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nd&quot;&gt;format!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;public/{}.json&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.map_err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;to_rejection&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.and_then&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;serde_json&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;from_reader&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.map_err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;to_rejection&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ct&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;upload&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.content_type&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.unwrap_or&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;image/png&quot;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.to_string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;());&lt;/span&gt;

  &lt;span class=&quot;nn&quot;&gt;tokio&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;fs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;File&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nd&quot;&gt;format!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;public/{}&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;.await&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;nn&quot;&gt;tokio_util&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;codec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;FramedRead&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;nn&quot;&gt;tokio_util&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;codec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;BytesCodec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;hyper&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;Body&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;wrap_stream&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;body&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;nn&quot;&gt;warp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;http&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;Response&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;builder&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
        &lt;span class=&quot;nf&quot;&gt;.header&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Content-Type&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ct&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;nf&quot;&gt;.body&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;body&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.map_err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;to_rejection&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I’m being a bit lazy and returning a &lt;code&gt;warp::Rejection&lt;/code&gt; on every failure
scenario, which isn’t super correct. Rejections should be used to signal that
the route does not match the request. A JSON parse error should display an
error page, not move to the next route.&lt;/p&gt;

&lt;p&gt;Returning the body was a bit more complex that I would have liked. I had to
grab tools from &lt;code&gt;tokio::fs&lt;/code&gt;, &lt;code&gt;tokio_util::codec&lt;/code&gt;, &lt;code&gt;hyper&lt;/code&gt;, and &lt;code&gt;warp::http&lt;/code&gt;
(which is an alias to the &lt;code&gt;http&lt;/code&gt; crate). Ideally I would just have written:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;nn&quot;&gt;warp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nd&quot;&gt;format!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;public/{}&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
  &lt;span class=&quot;nf&quot;&gt;.with_header&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Content-Type&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ct&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There’s already a bunch of code in &lt;code&gt;warp::filters::fs::file&lt;/code&gt; to deal with
serving file contents, so maybe this is something that could be extracted.&lt;/p&gt;

&lt;h2 id=&quot;conclusions&quot;&gt;Conclusions&lt;/h2&gt;

&lt;p&gt;I want to try another framework (probably &lt;code&gt;actix-web&lt;/code&gt;) to see if the experience
is any different, or if the changes are mostly cosmetic. The &lt;code&gt;actix-web&lt;/code&gt;
repository contains a &lt;a href=&quot;https://github.com/actix/examples/blob/master/multipart/src/main.rs&quot;&gt;file upload
example&lt;/a&gt;,
so maybe I’ll give it a try.&lt;/p&gt;

&lt;p&gt;This experience is very different from using something like &lt;a href=&quot;https://rubyonrails.org/&quot;&gt;Ruby on
Rails&lt;/a&gt;. It feels closer to using something like
&lt;a href=&quot;https://expressjs.com/&quot;&gt;express&lt;/a&gt;. I’m feeling tempted to try to build
something that’s closer to rails, with batteries included. Having a project
blueprint that pulls in certain libraries by default and sets conventions on
where files should be located and having a &lt;a href=&quot;https://guides.rubyonrails.org/command_line.html#rails-generate&quot;&gt;generator
cli&lt;/a&gt; are
things that help you getting started.&lt;/p&gt;

&lt;p&gt;This also led me to the &lt;a href=&quot;https://github.com/rust-lang/arewewebyet&quot;&gt;AreWeWebYet
repository&lt;/a&gt;. I noticed that there are
a lot of outdated and duplicate issues, so I tried to help by reviewing some of
them.&lt;/p&gt;

&lt;p&gt;The git repository for the image host project is available on my github
account:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/hugopeixoto/imghost&quot;&gt;https://github.com/hugopeixoto/imghost&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I documented the features that I want to build next directly in the README. I
should probably create issues instead. It’s far from being “production ready”,
but it was a good starting point to get me into rust webdev.&lt;/p&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2020-09-30:/articles/status-update-2020-09-30.html</id>
    <title type="html">Status update, September 2020</title>
    <published>2020-09-30T00:00:00Z</published>
    <updated>2020-09-30T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/status-update-2020-09-30.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;Another month gone, another status update&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;Another month gone, another status update.&lt;/p&gt;

&lt;p&gt;My main focus this month was on reporting what I learned during the &lt;a href=&quot;https://itch.io/jam/games-made-quick-four-plus&quot;&gt;Games Made
Quick&lt;/a&gt; gamejam. This resulted
in a two-parter:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;/articles/rust-gamedev-ecs-bevy.html&quot;&gt;Rust, gamedev, ECS, and bevy - Part 1&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;/articles/rust-gamedev-ecs-bevy-p2.html&quot;&gt;Rust, gamedev, ECS, and bevy - Part 2&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;While working on those articles, I had to write some benchmarking code,
&lt;a href=&quot;https://github.com/hugopeixoto/tests/tree/master/ecs&quot;&gt;available on my tests
repository&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;These articles had rust code samples, so I bumped into some bugs in the rouge
syntax highlighting gem I’m using.&lt;/p&gt;

&lt;p&gt;There was &lt;a href=&quot;https://github.com/rouge-ruby/rouge/pull/452&quot;&gt;a PR from 2016&lt;/a&gt; that
fixed a lot of rust issues, but most of them were fixed in different pull
requests in the meantime. I tracked those down, figured out what issues were
still present in the main branch, and made a couple of small PRs to fix them:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/rouge-ruby/rouge/pull/1580&quot;&gt;Bugfix: Allow rust tuple indexing&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/rouge-ruby/rouge/pull/1581&quot;&gt;Bugfix: support rust float delimiters&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;These were merged fairly quickly, and the original PR was closed.&lt;/p&gt;

&lt;p&gt;When publishing those two articles, I explored the idea of syndicating my blog
posts to &lt;a href=&quot;https://dev.to/&quot;&gt;DEV.to&lt;/a&gt;. They can import content from an RSS feed as
draft posts, so I decided to give it a try. Unfortunately, &lt;a href=&quot;https://github.com/forem/forem/issues/8457&quot;&gt;this feature has
issues dealing with newlines&lt;/a&gt;.
There was some discussion on &lt;strong&gt;what&lt;/strong&gt; was happening, but not &lt;strong&gt;why&lt;/strong&gt;, so I
cloned the repository and started making some experiments.&lt;/p&gt;

&lt;p&gt;The issue comes from converting HTML to markdown, which is mostly handled by
the &lt;a href=&quot;https://github.com/xijo/reverse_markdown&quot;&gt;&lt;code&gt;reverse_markdown&lt;/code&gt; gem&lt;/a&gt;. Part of
the problem was in a monkey patched class that didn’t get any updates, so I
fixed that:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/forem/forem/pull/10476&quot;&gt;Fix newlines being chomped in RSS import&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;But the other part of the problem is upstream, and I don’t see how to easily
fix it. I reported my findings in this issue:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/xijo/reverse_markdown/issues/91&quot;&gt;Too much blankspace gets stripped&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I’m not sure if I will continue working on that issue, since I can’t find a
quick solution to the problem and it might require a significant overhaul.&lt;/p&gt;

&lt;p&gt;On another note, people are renaming their git branches from &lt;code&gt;master&lt;/code&gt; to &lt;code&gt;main&lt;/code&gt;
(I’ve migrated some of mine, and try to use &lt;code&gt;main&lt;/code&gt; in new repos). This change
inevitably leads to some things breaking. This happened with
&lt;a href=&quot;http://dokku.viewdocs.io/dokku&quot;&gt;Dokku&lt;/a&gt;’s documentation, so I made a PR to
fix it:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/dokku/dokku/pull/4136&quot;&gt;Update push command for sample app in docs&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Dokku itself doesn’t support &lt;code&gt;main&lt;/code&gt; by default, so maybe that’s something worth
exploring.&lt;/p&gt;

&lt;p&gt;This week I’ve been exploring rust in a web dev context. I’m working on a toy
project, &lt;a href=&quot;https://github.com/hugopeixoto/imghost&quot;&gt;imghost&lt;/a&gt;, to see how the
experience is like. I’ll probably report on this soon.&lt;/p&gt;

&lt;p&gt;I’ve been complaining about my laptop for months now. 8GB of ram is not enough
anymore, and when it starts swapping, everything halts. Some disk heavy
operations would also freeze the entire thing, so replaced the SSD to see if it
helps. Instead of cloning the disk, I decided to start from scratch.&lt;/p&gt;

&lt;p&gt;I recently changed my setup from using X11 to using Wayland (mostly to get
multi-monitor variable DPI support), so there were a lot of packages and
configs that I didn’t need anymore. I also decided to skip chromium and rely on
firefox exclusively.&lt;/p&gt;

&lt;p&gt;One of the advantages of starting from scratch is that I had to update my
&lt;a href=&quot;https://github.com/hugopeixoto/dotfiles/&quot;&gt;dotfiles repository&lt;/a&gt;. I also took
the opportunity to document (in my private notes.git) the installation process
and which packages I usually need. I’ll try to figure out the best way to make
this public.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2020-09-24:/articles/rust-gamedev-ecs-bevy-p2.html</id>
    <title type="html">Rust, gamedev, ECS, and bevy - Part 2</title>
    <published>2020-09-24T00:00:00Z</published>
    <updated>2020-09-24T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/rust-gamedev-ecs-bevy-p2.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;In &lt;a href=&quot;/articles/rust-gamedev-ecs-bevy.html&quot;&gt;Part 1&lt;/a&gt; of this series, I talked about what ECS is and what it’s good for. In this post, I’ll translate those concepts to &lt;a href=&quot;https://bevyengine.org&quot;&gt;bevy&lt;/a&gt;, with some code examples. I’ll finish with the issues I found in bevy and how ECS is kind of the opposite of how I’m used to thinking.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;

&lt;p&gt;In &lt;a href=&quot;/articles/rust-gamedev-ecs-bevy.html&quot;&gt;Part 1&lt;/a&gt; of this series, I talked
about what ECS is and what it’s good for. In this post, I’ll translate those
concepts to &lt;a href=&quot;https://bevyengine.org&quot;&gt;bevy&lt;/a&gt;, with some code examples. I’ll
finish with the issues I found in bevy and how ECS is kind of the opposite of
how I’m used to thinking.&lt;/p&gt;

&lt;p&gt;Bevy is a very recent ECS game engine: it was released on August 10.
There are many other rust ECS engines, like
&lt;a href=&quot;https://github.com/TomGillen/legion&quot;&gt;Legion&lt;/a&gt;,
&lt;a href=&quot;https://github.com/Ralith/hecs&quot;&gt;hecs&lt;/a&gt;,
&lt;a href=&quot;https://github.com/leudz/shipyard&quot;&gt;shipyard&lt;/a&gt;, and
&lt;a href=&quot;https://github.com/amethyst/specs&quot;&gt;Specs&lt;/a&gt; (which powers
&lt;a href=&quot;https://github.com/amethyst/amethyst&quot;&gt;Amethyst&lt;/a&gt;). Bevy seems to have &lt;a href=&quot;https://bevyengine.org/news/scaling-bevy/&quot;&gt;caught
people’s attention&lt;/a&gt;, and I’m not
really sure why, but I decided to try it because of its release timing and all
the hype it received.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;This post was written a couple of days after bevy 0.2.1 was released. If, by
  the time you’re reading this, new versions have been released, the code in
  here may no longer compile, but the basic principles should still apply.&lt;/p&gt;
&lt;/aside&gt;

&lt;h2 id=&quot;bevy-basics&quot;&gt;Bevy basics&lt;/h2&gt;

&lt;p&gt;Getting started was easy, thanks to &lt;a href=&quot;https://bevyengine.org/news/introducing-bevy/&quot;&gt;bevy’s introduction
post&lt;/a&gt;. Documentation is still a
bit lacking, but the introduction covers the most important of concepts, and
&lt;a href=&quot;https://discord.gg/gMUk5Ph&quot;&gt;their Discord&lt;/a&gt; was helpful when I needed to fill
in the gaps.&lt;/p&gt;

&lt;p&gt;To get started, here’s a basic bevy app, that prints &lt;code&gt;Hello&lt;/code&gt; and exits:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;bevy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;prelude&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;hello&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;nd&quot;&gt;println!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Hello&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;nn&quot;&gt;App&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;build&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.add_system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;hello&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.run&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;code&gt;App::build()&lt;/code&gt; returns a &lt;a href=&quot;https://en.wikipedia.org/wiki/Builder_pattern&quot;&gt;builder
object&lt;/a&gt; that lets you chain
methods to configure your application. The most common operation I find myself
using is &lt;code&gt;add_system&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;add_system&lt;/code&gt; registers the given
&lt;a href=&quot;https://docs.rs/bevy_ecs/0.2.1/bevy_ecs/trait.System.html&quot;&gt;&lt;code&gt;System&lt;/code&gt;&lt;/a&gt; and
calls its &lt;code&gt;run&lt;/code&gt; method in every game loop iteration.&lt;/p&gt;

&lt;p&gt;The most common way to create a system is by calling &lt;code&gt;system()&lt;/code&gt; on a rust
function. &lt;code&gt;system()&lt;/code&gt; comes from either the
&lt;a href=&quot;https://docs.rs/bevy/0.2.1/bevy/prelude/trait.IntoForEachSystem.html&quot;&gt;&lt;code&gt;IntoForEachSystem&lt;/code&gt;&lt;/a&gt;
trait or the
&lt;a href=&quot;https://docs.rs/bevy/0.2.1/bevy/prelude/trait.IntoQuerySystem.html&quot;&gt;&lt;code&gt;IntoQuerySystem&lt;/code&gt;&lt;/a&gt;
trait.&lt;/p&gt;

&lt;p&gt;Bevy implements these traits out of the box for some rust functions, based on
the function’s parameters. It &lt;a href=&quot;https://docs.rs/bevy_ecs/0.2.1/src/bevy_ecs/system/into_system.rs.html#143-218&quot;&gt;uses a bunch of macro
code&lt;/a&gt;
that uses the function’s parameter list to determine the system signature to
create a &lt;code&gt;run&lt;/code&gt; method that queries the list of entities that match that
signature.&lt;/p&gt;

&lt;p&gt;In this code example, the printing is done by a &lt;code&gt;system&lt;/code&gt;. In this case, the
function has no arguments, so there’s no component matching. Bevy will call
&lt;code&gt;hello&lt;/code&gt; once per game loop iteration. In this example it only runs once though,
because bevy defaults to using a scheduler that runs only once.&lt;/p&gt;

&lt;p&gt;If you want the application to run in a loop, with some initialization code
that should only run once, you can do the following:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;bevy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::{&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;prelude&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Duration&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;setup&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;nd&quot;&gt;println!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;setup&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;tick&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;nd&quot;&gt;println!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;tick&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;nn&quot;&gt;App&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;build&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.add_plugin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ScheduleRunnerPlugin&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;run_mode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;RunMode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Loop&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;wait&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;Some&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;Duration&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;from_secs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.add_startup_system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;setup&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.add_system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tick&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.run&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This application runs the &lt;code&gt;setup&lt;/code&gt; system once, because it’s added via
&lt;code&gt;add_startup_system&lt;/code&gt;, and it runs &lt;code&gt;tick&lt;/code&gt; once per game loop iteration, which in
this case runs once per second. Currently, &lt;a href=&quot;https://github.com/bevyengine/bevy/issues/125&quot;&gt;bevy only supports one global
scheduler&lt;/a&gt;, so you can’t easily
declare that you want one system to run at 16hz and another system at 60hz.
There are some workarounds for this, but nothing perfect.&lt;/p&gt;

&lt;h2 id=&quot;moving-and-bobbing-spheres&quot;&gt;Moving and bobbing spheres&lt;/h2&gt;

&lt;p&gt;In &lt;a href=&quot;/articles/rust-gamedev-ecs-bevy.html&quot;&gt;Part 1&lt;/a&gt;, I used an example with
spheres moving at a constant speed and spheres bobbing up and down. Let’s
implement those components, ignoring the drawing part for now:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;bevy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::{&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;prelude&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Duration&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;f32&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;consts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;TAU&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;f32&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;f32&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FixedSpeedMovement&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;dx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;f32&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;dy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;f32&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BobbingMovement&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;dy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;f32&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;amplitude&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;f32&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;period&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;f32&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;fixed_speed_movement_system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Mut&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;movement&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FixedSpeedMovement&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elapsed&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.016&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;movement&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.dx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elapsed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.y&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;movement&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.dy&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elapsed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;bobbing_movement_system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Mut&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;movement&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Mut&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;BobbingMovement&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elapsed&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.016&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;period&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;movement&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.period&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.y&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;movement&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.amplitude&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;movement&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.dy&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TAU&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;period&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.sin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;movement&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.dy&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;movement&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.dy&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elapsed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;period&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.y&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;movement&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.amplitude&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;movement&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.dy&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TAU&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;period&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.sin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;setup&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commands&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Commands&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;commands&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.spawn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;FixedSpeedMovement&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.2&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;commands&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.spawn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;BobbingMovement&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;amplitude&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;5.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;period&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;10.0&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;nd&quot;&gt;println!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;entity at {:.3}, {:.3}&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;nn&quot;&gt;App&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;build&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.add_plugin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ScheduleRunnerPlugin&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;run_mode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;RunMode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Loop&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;wait&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;Some&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;Duration&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;from_millis&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.add_startup_system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;setup&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.add_system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fixed_speed_movement_system&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.add_system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bobbing_movement_system&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.add_system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.run&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Apart from the missing &lt;code&gt;DrawableSphere&lt;/code&gt; component, this example looks very
similar to the one from Part 1. In bevy, components are just &lt;code&gt;struct&lt;/code&gt;s.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;Note: I also tweaked the &lt;code&gt;bobbing_movement_system&lt;/code&gt; function a bit, so that it
  doesn’t rely on the derivative anymore. It worked fine when elapsed time
  tends to zero, but it misbehaved when elapsed is large.&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;I changed the &lt;code&gt;setup&lt;/code&gt; signature to receive a &lt;code&gt;Commands&lt;/code&gt; object. This object
lets you schedule commands to be executed at the end of the game loop
iteration. I’m spawning a couple of entities in there, using
&lt;a href=&quot;https://docs.rs/bevy/0.2.1/bevy/prelude/struct.Commands.html#method.spawn&quot;&gt;&lt;code&gt;Commands#spawn&lt;/code&gt;&lt;/a&gt;.
&lt;code&gt;spawn&lt;/code&gt; schedules the creation of a new entity with the given components
attached. Technically it receives a bundle of components, so I’m passing a
tuple of components. Bevy implements the &lt;code&gt;Bundle&lt;/code&gt; trait for tuples out of the
box.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;fixed_speed_movement_system&lt;/code&gt;’s signature is made of two components: &lt;code&gt;Position&lt;/code&gt;
and &lt;code&gt;FixedSpeedMovement&lt;/code&gt;. This means that bevy will call this system for every
entity that has at least these two components. By wrapping &lt;code&gt;Position&lt;/code&gt; in a
&lt;code&gt;Mut&amp;lt;&amp;gt;&lt;/code&gt;, we’re letting bevy know that this system will modify this component,
so it should not run other systems that require the &lt;code&gt;Position&lt;/code&gt; component in
parallel.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;bobbing_movement_system&lt;/code&gt; is practically the same as
&lt;code&gt;fixed_speed_movement_system&lt;/code&gt;, but it also needs to mutate the
&lt;code&gt;BobbingMovement&lt;/code&gt; component to keep track of movement state.&lt;/p&gt;

&lt;p&gt;The &lt;code&gt;print&lt;/code&gt; system signature matches every entity with a &lt;code&gt;Position&lt;/code&gt; component
and prints its coordinates. This is a temporary substitute for the
&lt;code&gt;DrawableSphere&lt;/code&gt; system we had in Part 1.&lt;/p&gt;

&lt;p&gt;In &lt;code&gt;main&lt;/code&gt;, we’re adding all the systems. Running this will print something
like:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;entity at 0.002, 0.003
entity at 0.000, 0.050
entity at 0.003, 0.006
entity at 0.000, 0.101
entity at 0.005, 0.010
entity at 0.000, 0.151
entity at 0.006, 0.013
entity at 0.000, 0.201
[...]
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You’ll notice that I have &lt;code&gt;let elapsed = 0.016&lt;/code&gt; in the systems. This is not
ideal, since the time between system calls may vary a bit, and we want to avoid
drift. To figure out the actual elapsed time, bevy provides global resource
&lt;a href=&quot;https://docs.rs/bevy/0.2.1/bevy/prelude/struct.Time.html&quot;&gt;&lt;code&gt;Time&lt;/code&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&quot;global-resources&quot;&gt;Global resources&lt;/h2&gt;

&lt;p&gt;Global resources are objects that your systems can add to their signature and
that will persist global state, with the benefit of bevy being able to reason
about then when thinking of parallelization. Those resources are initialized in
&lt;code&gt;main&lt;/code&gt;, by calling &lt;code&gt;add_resource&lt;/code&gt; or &lt;code&gt;init_resource&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;fixed_speed_movement_system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Res&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Mut&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;movement&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FixedSpeedMovement&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elapsed&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.delta_seconds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;movement&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.dx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elapsed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.y&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;movement&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.dy&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elapsed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;bobbing_movement_system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Res&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Mut&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;movement&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Mut&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;BobbingMovement&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elapsed&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.delta_seconds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;period&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;movement&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.period&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.y&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;movement&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.amplitude&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;movement&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.dy&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TAU&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;period&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.sin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;movement&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.dy&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;movement&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.dy&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elapsed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;period&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.y&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;movement&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.amplitude&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;movement&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.dy&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TAU&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;period&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.sin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;time_system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ResMut&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.update&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;nn&quot;&gt;App&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;build&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;py&quot;&gt;.init_resource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.add_system_to_stage&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;stage&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FIRST&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time_system&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.add_plugin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ScheduleRunnerPlugin&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;run_mode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;RunMode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Loop&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;wait&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;Some&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;Duration&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;from_millis&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.add_startup_system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;setup&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.add_system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fixed_speed_movement_system&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.add_system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bobbing_movement_system&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.add_system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.run&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The systems that need to care about time now have a new parameter, &lt;code&gt;Res&amp;lt;Time&amp;gt;&lt;/code&gt;.
I’m adding the resource with &lt;code&gt;init_resource&lt;/code&gt; (it calls &lt;code&gt;Time::from_resource&lt;/code&gt;),
and I added a system to update the time resource: &lt;code&gt;time_system&lt;/code&gt;. I’m
registering this system with &lt;code&gt;add_system_to_stage(stage::FIRST, ...)&lt;/code&gt;, which
ensures that this system is called before any other.&lt;/p&gt;

&lt;p&gt;I did most of this work manually (&lt;code&gt;init_resource&lt;/code&gt;, creating the system, and
registering it), but bevy comes with default plugins that handle these things
for us.&lt;/p&gt;

&lt;h2 id=&quot;drawing-spheres&quot;&gt;Drawing spheres&lt;/h2&gt;

&lt;p&gt;We also want to draw the spheres. Bevy comes with a set of components to draw
3D scenes and meshes. Each 3D object has its own &lt;code&gt;Transform&lt;/code&gt; matrix,
independent of the &lt;code&gt;Position&lt;/code&gt; component. I will add a system that goes through
every entity with a position and sets its transform component to the right
translation matrix:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;drawing_system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;transform&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Mut&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Transform&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;transform&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;Transform&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;from_translation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;nn&quot;&gt;Vec3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;setup&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commands&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Commands&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;meshes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ResMut&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Assets&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Mesh&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;materials&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ResMut&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Assets&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;StandardMaterial&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;material&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;materials&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.add&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;Color&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;rgb&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;0.1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.into&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;());&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mesh&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;meshes&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.add&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;Mesh&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;from&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;nn&quot;&gt;shape&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Icosphere&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;subdivisions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;radius&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.5&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;commands&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.spawn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Camera3dComponents&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;transform&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;Transform&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;Mat4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;face_toward&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
        &lt;span class=&quot;nn&quot;&gt;Vec3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;40.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
        &lt;span class=&quot;nn&quot;&gt;Vec3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
        &lt;span class=&quot;nn&quot;&gt;Vec3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;Default&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;});&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;commands&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.spawn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;FixedSpeedMovement&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;2.0&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.with_bundle&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;PbrComponents&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mesh&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;material&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;Default&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;commands&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.spawn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;BobbingMovement&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;amplitude&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;5.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;period&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;2.0&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.with_bundle&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;PbrComponents&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mesh&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;material&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;Default&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;nn&quot;&gt;App&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;build&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.add_default_plugins&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.add_startup_system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;setup&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.add_system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fixed_speed_movement_system&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.add_system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bobbing_movement_system&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.add_system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;drawing_system&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.run&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The &lt;code&gt;setup&lt;/code&gt; system was changed to spawn a 3D Camera entity and to add the
&lt;a href=&quot;https://en.wikipedia.org/wiki/Physically_based_rendering&quot;&gt;PBR&lt;/a&gt; components to
the existing sphere entities.&lt;/p&gt;

&lt;p&gt;I didn’t have to change the &lt;code&gt;fixed_speed_movement_system&lt;/code&gt; and
&lt;code&gt;bobbing_movement_system&lt;/code&gt; functions. Drawing is decoupled from the position
update code.&lt;/p&gt;

&lt;p&gt;I added the &lt;code&gt;drawing&lt;/code&gt; system that copies the position values to the transform
component. I didn’t have to write the the actual drawing systems, bevy comes
with those out of the box. You just need to add the default plugins.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;add_default_plugins&lt;/code&gt; adds a bunch of default resources, components and systems
that handle windows, initialize global resources (like &lt;code&gt;Time&lt;/code&gt;), etc. This also
adds a loop scheduler, so we no longer need to add the &lt;code&gt;RunMode::Loop&lt;/code&gt;
scheduler manually.&lt;/p&gt;

&lt;p&gt;Running the code with these systems will open a window that looks like this:&lt;/p&gt;

&lt;video autoplay=&quot;&quot; loop=&quot;&quot; muted=&quot;&quot;&gt;
  &lt;source src=&quot;/articles/primest-drawing-spheres.webm&quot; /&gt;
&lt;/video&gt;

&lt;p&gt;Although it doesn’t look like it, these are 3D spheres. Adding a
&lt;a href=&quot;https://docs.rs/bevy/0.2.1/bevy/prelude/struct.LightComponents.html&quot;&gt;light&lt;/a&gt;
would make their depth a bit more noticeable:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;n&quot;&gt;commands&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.spawn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;LightComponents&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;transform&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;Transform&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;from_translation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;Vec3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;4.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;Default&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;});&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/articles/primest-spheres.png&quot; alt=&quot;Two blue spheres in a gray canvas, with noticeable shading&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;for-each-systems-vs-query-systems&quot;&gt;For each systems vs query systems&lt;/h2&gt;

&lt;p&gt;Up until now, I have been using what bevy calls “for each systems”. These
systems are called with a single entity that matches its signature. Bevy
provides an alternative, “query systems”, that receive an iterator to all the
entities that match the query. This is useful if you want to, for example, do
some calculations that aggregate values from several entities. Let’s create a
system that calculates a score based on the &lt;code&gt;x&lt;/code&gt; coordinate of every &lt;code&gt;Position&lt;/code&gt;
component:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;scoring_system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;positions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Query&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;score&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;positions&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.iter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;score&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;nd&quot;&gt;println!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;score: {}&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;score&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This will iterate through every &lt;code&gt;Position&lt;/code&gt; component. In this example, we can’t
mutate the position. If we wanted to do that, the query would be
&lt;code&gt;Query&amp;lt;Mut&amp;lt;Position&amp;gt;&amp;gt;&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Query systems can also match multiple components per entity. Let’s rewrite the
&lt;code&gt;drawing_system&lt;/code&gt; to a query system:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;drawing_system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;spheres&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Query&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Mut&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Transform&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;transform&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;spheres&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.iter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;transform&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;Transform&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;from_translation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
      &lt;span class=&quot;nn&quot;&gt;Vec3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;One limitation of the existing system traits is that you can’t mix these two in
the same system. Say that you would want to store the score in a component,
instead of just printing it out. You wouldn’t be able to write something like
this:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;c&quot;&gt;// You wouldn&#39;t be able to add this system to a bevy app&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;scoring_system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;score&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Mut&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Score&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;positions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Query&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;score&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;positions&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.iter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;score&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You would have to use two queries instead:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;scoring_system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;scores&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Query&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Mut&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Score&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;positions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Query&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;points&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;positions&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.iter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;points&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;score&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;scores&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.iter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;score&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;points&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In this example, since you’ll probably only have one &lt;code&gt;Score&lt;/code&gt; at any given time,
you’d probably be better served with a shared global resource:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;scoring_system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;score&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ResMut&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Score&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;positions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Query&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;score&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;positions&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.iter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;score&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;d-sprites&quot;&gt;2D sprites&lt;/h2&gt;

&lt;p&gt;I didn’t want to deal with 3D models, or complex physics, so I decided to go
with something 2D, Gameboy / Pokémon Red like, where movement is tile based. I
decided to go with the Gameboy screen size (160x144) and sprite size (16x16).&lt;/p&gt;

&lt;p&gt;Bevy comes with some components to draw Sprites. I started by making a couple
of sprites in &lt;a href=&quot;https://orama-interactive.itch.io/pixelorama&quot;&gt;Pixelorama&lt;/a&gt; and
draw them in a few hardcoded positions:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/articles/primest-base.png&quot; alt=&quot;Game screen with green background with a border of squares, with a green
humanoid avatar in the lower left corner&quot; /&gt;&lt;/p&gt;

&lt;p&gt;And here’s the code:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;bevy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;prelude&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;i32&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;i32&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;spawn_sprite&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;commands&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Commands&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;material&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Handle&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ColorMaterial&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Commands&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;commands&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.spawn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;SpriteComponents&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;material&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;Default&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.with&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;sprite_update&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;transform&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Mut&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Transform&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;transform&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;Transform&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;from_translation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;nn&quot;&gt;Vec3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.x&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;f32&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;4.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;16.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.y&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;f32&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;4.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;16.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;setup&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commands&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Commands&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;materials&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ResMut&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Assets&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ColorMaterial&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;asset_server&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Res&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;AssetServer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;block&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;materials&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.add&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;asset_server&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.load&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;block.png&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.unwrap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.into&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;());&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;player&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;materials&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.add&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;asset_server&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.load&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;player.png&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.unwrap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.into&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;());&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;commands&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.spawn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;Camera2dComponents&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;());&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;spawn_sprite&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commands&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;block&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;});&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;spawn_sprite&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commands&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;block&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;});&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;7&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;spawn_sprite&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commands&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;block&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;});&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;spawn_sprite&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commands&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;block&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;9&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;});&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;nf&quot;&gt;spawn_sprite&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commands&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;player&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;});&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;nn&quot;&gt;App&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;build&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.add_resource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;WindowDescriptor&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;width&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;160&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;height&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;144&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;vsync&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;resizable&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;Default&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.add_default_plugins&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.add_resource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;ClearColor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;Color&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;rgb&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;0.792&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.863&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.624&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)))&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.add_startup_system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;setup&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.add_system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sprite_update&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.run&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is very similar to the 3D example, but using sprites instead of meshes,
and &lt;code&gt;i32&lt;/code&gt; instead of &lt;code&gt;f32&lt;/code&gt; in &lt;code&gt;Position&lt;/code&gt;. I also extracted some code into
&lt;code&gt;spawn_sprite&lt;/code&gt; to make the example a bit shorter.&lt;/p&gt;

&lt;h2 id=&quot;user-input&quot;&gt;User input&lt;/h2&gt;

&lt;p&gt;The next step was to add some movement:&lt;/p&gt;

&lt;video autoplay=&quot;&quot; loop=&quot;&quot; muted=&quot;&quot;&gt;
  &lt;source src=&quot;/articles/primest-basic-movement-x2.webm&quot; /&gt;
&lt;/video&gt;

&lt;p&gt;I got here by tagging the player entity with a new component, and adding a
single system:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;nd&quot;&gt;#![feature(clamp)]&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PC&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;setup&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;c&quot;&gt;// [..]&lt;/span&gt;
  &lt;span class=&quot;nf&quot;&gt;spawn_sprite&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commands&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;player&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.with&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PC&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{});&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;pc_movement_system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;keyboard_input&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Res&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Input&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;KeyCode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;mi&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PC&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Mut&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;keyboard_input&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.pressed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;KeyCode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;W&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.y&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;keyboard_input&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.pressed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;KeyCode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;keyboard_input&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.pressed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;KeyCode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;S&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.y&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;keyboard_input&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.pressed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;KeyCode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;D&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.x&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.clamp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.y&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.y&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.clamp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;9&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;nn&quot;&gt;App&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;build&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;// ...&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.add_system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pc_movement_system&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;.run&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;For now, the &lt;code&gt;PC&lt;/code&gt; component is only used for filtering entities, so it’s not
even being used explicitly in &lt;code&gt;pc_movement_system&lt;/code&gt;, but it needs to be one of
the parameters. If we omitted this, the system would run once for every entity
with a Position component. This would cause the the walls to start moving.&lt;/p&gt;

&lt;p&gt;This is a very basic system, just to get things started. It has a lot of
limitations.&lt;/p&gt;

&lt;p&gt;First, there’s no sprite animation: the PC sprite jumps from one square to the
other. One way of solving this would be to add a component to the player that
keeps track of the animation duration. &lt;code&gt;sprite_update&lt;/code&gt; would have to be aware
of this component and update the sprite accordingly.&lt;/p&gt;

&lt;p&gt;Second, this system runs on every update tick, making movement speed a bit
erratic. It’s also hard to control player speed like this. If I had movement
animations, I would also have to consider &lt;a href=&quot;https://gamedev.stackexchange.com/questions/43708/fighting-game-and-input-buffering&quot;&gt;input
buffering&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Third, there’s no collision detection. I’m faking it by using
&lt;a href=&quot;https://doc.rust-lang.org/std/primitive.i32.html#method.clamp&quot;&gt;&lt;code&gt;clamp&lt;/code&gt;&lt;/a&gt; to
limit player movement. When I add more objects to the world, I will need to
have some collision detection. This could be naively implemented by adding a
query that iterates through all other Positioned entities and checks if any of
them are in the destination square. It wouldn’t be super efficient, though.
Ideally we’d have an auxiliar data structure that lets us know in constant time
if there’s an entity in a given position.&lt;/p&gt;

&lt;h2 id=&quot;bevy-drawbacks&quot;&gt;Bevy drawbacks&lt;/h2&gt;

&lt;p&gt;There was one thing that made getting started with bevy a bit hard. The error
messages that you get when your system signature doesn’t match any signatures
that implement &lt;code&gt;Into*System&lt;/code&gt; traits is not helpful.&lt;/p&gt;

&lt;p&gt;For example, if I try to add the broken &lt;code&gt;scoring_system&lt;/code&gt; function I mentioned
earlier to my app, I get the following error (formatted for readability):&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;error[E0599]: no method named `system` found for fn item
              `for&amp;lt;&#39;r, &#39;s, &#39;t0&amp;gt; fn(
                 bevy::prelude::Mut&amp;lt;&#39;r, Score&amp;gt;,
                 bevy::prelude::Query&amp;lt;&#39;s, &amp;amp;&#39;t0 Position&amp;gt;
               ) {scoring_system}` in the current scope
   --&amp;gt; src/main.rs:108:32
    |
108 |     .add_system(scoring_system.system())
    |                                ^^^^^^ method not found in
    |                                `for&amp;lt;&#39;r, &#39;s, &#39;t0&amp;gt; fn(
    |                                   bevy::prelude::Mut&amp;lt;&#39;r, Score&amp;gt;,
    |                                   bevy::prelude::Query&amp;lt;&#39;s, &amp;amp;&#39;t0 Position&amp;gt;
    |                                 ) {scoring_system}`
    |
    = note: `scoring_system` is a function, perhaps you wish to call it
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;code&gt;add_system&lt;/code&gt; takes a &lt;code&gt;bevy::prelude::System&lt;/code&gt;, so we need to call &lt;code&gt;system()&lt;/code&gt; on
the &lt;code&gt;fn&lt;/code&gt; to convert it. Since this function doesn’t match any of the functions
that have the trait implemented by default, we get a &lt;code&gt;method not found&lt;/code&gt; error,
which is not super useful.&lt;/p&gt;

&lt;p&gt;Even if &lt;code&gt;add_system&lt;/code&gt; did accept a &lt;code&gt;Into*System&lt;/code&gt; trait instead, I’m not sure if
the error would be that clear. I think this is a disadvantage of using function
signatures instead of something more structured.&lt;/p&gt;

&lt;p&gt;I eventually got used to it, and started associating “method not found” with “I
have a problem in my system signature”. I don’t know if there’s something that
can be done to improve error messages in this scenario without compromising the
simplicity of using functions.&lt;/p&gt;

&lt;h2 id=&quot;trouble-with-ecs&quot;&gt;Trouble with ECS&lt;/h2&gt;

&lt;p&gt;Before I start, I want to note that I had no prior experience with ECS, and
barely anything that counts as game development experience.&lt;/p&gt;

&lt;p&gt;My latest encounter with gamedevvy stuff was &lt;a href=&quot;https://2018.makeorbreak.io/#ai-competition&quot;&gt;Make or Break’s AI
competition&lt;/a&gt;. This work focuses a
lot on deterministic behavior and avoiding first player advantage. The &lt;a href=&quot;https://github.com/makeorbreak-io/ai-competition/blob/master/lib/games/splatoon/stepper.rb&quot;&gt;ruby
code is on github if you’re
curious&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The game I worked on is related to time travel, so I knew I would need to
record the world state to be able to move back and forth in time. The way I
usually approach this is by representing the game as a &lt;code&gt;next(State,
Vec&amp;lt;Action&amp;gt;) -&amp;gt; State&lt;/code&gt; function.&lt;/p&gt;

&lt;p&gt;Recording the actions would allow me to go back to any point in time by
replaying the states from the start of the game. I could also record the states
if I wanted to optimize things a bit. Things like UI, input buffering, and
animation would be left out of this mechanism.&lt;/p&gt;

&lt;p&gt;This &lt;code&gt;next&lt;/code&gt; pattern makes testing a bit more obvious, since you just have to
pass it a state and assert on the resulting state. On the other hand, building
a consistent state might be a bit harder, depending on the game complexity.&lt;/p&gt;

&lt;p&gt;Initially I tried to avoid using this pattern and going full ECS, but dealing
with recording actions or states from a list of Components, and figuring out
how to reset every component, proved too much for a starting game.&lt;/p&gt;

&lt;p&gt;I will probably revert to the &lt;code&gt;next&lt;/code&gt; pattern and limit the ECS to animations,
input handling, and menuing. It will reduce the performance benefits of using
ECS, but since this is a board game like structure (2D, discrete movement), I’m
not planning on having too many entities on the core gameplay. The visual
components will still benefit from ECS.&lt;/p&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;When writing the part 1 of this series, I wrote some benchmarks in C++ to
double check what I was saying. These are available on my &lt;a href=&quot;https://github.com/hugopeixoto/tests/tree/master/ecs&quot;&gt;tests
repository&lt;/a&gt;. The repo is
kind of a mess, but it was useful to get some idea of the benefits of each
step.&lt;/p&gt;

&lt;p&gt;I still haven’t got far with the game, since the game jam was only one week,
but I enjoyed working with bevy so far. Here’s a video of the latest version I
did, with a debug system that prints the keys that are being pressed,
spritesheets and movement animation:&lt;/p&gt;

&lt;video autoplay=&quot;&quot; loop=&quot;&quot; muted=&quot;&quot;&gt;
  &lt;source src=&quot;/articles/primest-latest.webm&quot; /&gt;
&lt;/video&gt;

&lt;p&gt;There is still a lot of change going on in the project, the APIs haven’t
stabilized yet, so every release has the potential to break something. They
haven’t invested much in documentation efforts to avoid having to rewrite
everything constantly.&lt;/p&gt;

&lt;p&gt;If you’re interested in learning more about bevy, there are &lt;a href=&quot;https://bevyengine.org/community/&quot;&gt;a bunch of
community channels you can join&lt;/a&gt;. I’ve asked
for help a couple of times in their discord server, and folks have been
helpful.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;
&lt;/aside&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2020-09-11:/articles/conversas-em-codigo-episode-29.html</id>
    <title type="html">Conversas em Código Episode #29 released</title>
    <published>2020-09-11T00:00:00Z</published>
    <updated>2020-09-11T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/conversas-em-codigo-episode-29.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;I’ve published a new episode of Conversas em Código - &lt;a href=&quot;https://conversas.porto.codes/episodes/cyberscore-reviver-um-projecto-lamp&quot;&gt;Episode 29: Cyberscore - Reviver um projecto LAMP&lt;/a&gt;&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;p&gt;I’ve published a new episode of Conversas em Código (in Portuguese):&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://conversas.porto.codes/episodes/cyberscore-reviver-um-projecto-lamp&quot;&gt;Episode 29: Cyberscore - Reviver um projecto LAMP&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Neste episódio falamos dos problemas que encontrámos num projecto em
PHP/MySQL com quase 20 anos.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;If you prefer an English written version, I’ve published an article on this
topic before: &lt;a href=&quot;/articles/knee-deep-in-a-lamp-project.html&quot;&gt;Knee deep in a LAMP
project&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;See the full episode list here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://conversas.porto.codes&quot;&gt;https://conversas.porto.codes&lt;/a&gt;&lt;/p&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2020-09-07:/articles/rust-gamedev-ecs-bevy.html</id>
    <title type="html">Rust, gamedev, ECS, and bevy - Part 1</title>
    <published>2020-09-07T00:00:00Z</published>
    <updated>2020-09-07T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/rust-gamedev-ecs-bevy.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;&lt;a href=&quot;https://bevyengine.org/&quot;&gt;Bevy&lt;/a&gt;, a game engine built in Rust, was released right before &lt;a href=&quot;https://itch.io/jam/games-made-quick-four-plus&quot;&gt;Games made quick&lt;/a&gt;, so I decided to give it a try. This series of posts documents my experiences with all Bevy, gamedev, ECS, and rust. This first post will contain a description of ECS and why it is relevant.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;I am accepting sponsors via github: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;

  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time.&lt;/p&gt;
&lt;/aside&gt;

&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;

&lt;p&gt;In mid august, &lt;a href=&quot;https://twitter.com/cart_cart&quot;&gt;Carter Anderson&lt;/a&gt; released
&lt;a href=&quot;https://bevyengine.org/&quot;&gt;bevy&lt;/a&gt;, an
&lt;a href=&quot;https://en.wikipedia.org/wiki/Entity_component_system&quot;&gt;Entity-Component-System&lt;/a&gt;
(ECS) game engine built in Rust.&lt;/p&gt;

&lt;p&gt;One week later, &lt;a href=&quot;https://gamesdonequick.com/&quot;&gt;SGDQ - Summer Games Done Quick&lt;/a&gt;
happened - a bi-yearly speedrunning marathon that lasts for a week, raising funds for
&lt;a href=&quot;https://en.wikipedia.org/wiki/M%C3%A9decins_Sans_Fronti%C3%A8res&quot;&gt;Médecins Sans Frontières&lt;/a&gt;.
To avoid spending 168 hours watching a twitch stream, &lt;a href=&quot;https://eev.ee/&quot;&gt;eevee&lt;/a&gt; started a game jam:
&lt;a href=&quot;https://itch.io/jam/games-made-quick-four-plus&quot;&gt;Games made quick&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I’ve tried to make some games before, but I never released anything. I struggle
a lot with the code architecture and end up obsessing about it instead of
trying to create a game.&lt;/p&gt;

&lt;p&gt;I decided to use the bevy release and games made quick as an excuse to practice
some more rust, and maybe even release something. Spoilers: I wasn’t able to
finish anything yet, but I did learn a bit about ECS in the process.&lt;/p&gt;

&lt;p&gt;In this post I’ll describe my vision of what ECS is, where it comes from, and
its benefits. In future posts, I will talk about my experience with bevy with
some code examples from my demo, and describe what my issues with ECS are, for
this particular game.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;Note: The examples follow the C++ syntax, but they’re mostly pseudocode. I
  tried to make it as close to the real thing as possible, but some shortcuts
  were taken to make things readable.&lt;/p&gt;
&lt;/aside&gt;

&lt;h2 id=&quot;entities-and-the-game-loop&quot;&gt;Entities and the game loop&lt;/h2&gt;

&lt;p&gt;ECS is a data-oriented software architecture commonly used in game development.
To describe what ECS brings to the table, I’d like to describe it in terms of
the differences to what is usually a more standard game architecture.&lt;/p&gt;

&lt;p&gt;I’ll start by describing game loops and entities, introduce &lt;strong&gt;Component-based&lt;/strong&gt;
architectures, and then move to &lt;strong&gt;Entity-Component-System&lt;/strong&gt; architectures.&lt;/p&gt;

&lt;p&gt;A common starting point is an architecture where your entities (players,
bullets, enemies, walls) are represented by objects whose &lt;code&gt;update&lt;/code&gt; function
will be called every game tick. In some engines, there’s a separate &lt;code&gt;draw&lt;/code&gt;
function that handles rendering, for entities that can be rendered.&lt;/p&gt;

&lt;p&gt;Throughout the post I’ll use an example where we have spheres traveling at a
constant speed and spheres that bob up and down. The code for these two
entities could look something like this:&lt;/p&gt;

&lt;div class=&quot;language-c++ highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;FixedSpeedSphere&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Entity&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;radius&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;slices&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;stacks&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;draw&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;glPushMatrix&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;glTranslatef&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;gluSphere&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;something&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;radius&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;slices&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;stacks&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;glPopMatrix&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;update&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;y&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dy&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;BobbingSphere&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Entity&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;amplitude&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;period&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;radius&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;slices&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;stacks&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;draw&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;glPushMatrix&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;glTranslatef&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;gluSphere&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;something&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;radius&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;slices&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;stacks&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;glPopMatrix&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;update&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;period&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;period&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;y&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;amplitude&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cos&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dy&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;period&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;M_PI&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;period&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;M_PI&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dy&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dy&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;period&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dy&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;period&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In this example, the &lt;code&gt;draw&lt;/code&gt; function draws a sphere, while the &lt;code&gt;update&lt;/code&gt;
function continuously updates the entity’s position.&lt;/p&gt;

&lt;p&gt;Usually your &lt;code&gt;update&lt;/code&gt; and &lt;code&gt;draw&lt;/code&gt; functions will contain code that will be
shared by many different entities. Most entities will have a position, for
example. Or maybe you have multiple projectiles that all move at a constant
speed. You could have a bobbing square instead of a bobbing sphere. This
creates the need to be able to reuse these behaviors in different entities.&lt;/p&gt;

&lt;h2 id=&quot;component-based-architecture&quot;&gt;Component-based architecture&lt;/h2&gt;

&lt;p&gt;Going the inheritance route to extract shared data and behaviors usually
doesn’t scale. This is where &lt;strong&gt;component-based architectures&lt;/strong&gt; come in: you use
composition instead, and your entities end up as nothing more than bags of
components:&lt;/p&gt;

&lt;div class=&quot;language-c++ highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Position&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Component&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;FixedSpeedMovement&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Component&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;update&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;auto&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;getComponent&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;y&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dy&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;BobbingMovement&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Component&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;amplitude&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;period&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;update&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;period&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;period&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;auto&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;getComponent&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;y&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;amplitude&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cos&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dy&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;period&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;M_PI&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;period&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;M_PI&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dy&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dy&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;period&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dy&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;period&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;DrawableSphere&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Component&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;radius&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;slices&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;stacks&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;draw&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;auto&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;getComponent&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;glPushMatrix&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;glTranslatef&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;gluSphere&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;something&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;radius&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;slices&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;stacks&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;glPopMatrix&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;Entity&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;buildFixedSpeedSphere&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;Entity&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;addComponent&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;addComponent&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FixedSpeedMovement&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;addComponent&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;DrawableSphere&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;Entity&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;buildBobbingSphere&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;Entity&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;addComponent&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;addComponent&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BobbingMovement&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;500&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;addComponent&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;DrawableSphere&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is the pattern you’ll see used in Unity, for example. Entities are
&lt;code&gt;GameObjects&lt;/code&gt;, and components are &lt;code&gt;MonoBehaviours&lt;/code&gt;. The entity builders could
be &lt;code&gt;Prefabs&lt;/code&gt;.&lt;/p&gt;

&lt;aside&gt;
  &lt;p&gt;Note: Godot uses a different approach, based on &lt;a href=&quot;https://docs.godotengine.org/en/stable/getting_started/step_by_step/scenes_and_nodes.html&quot;&gt;Scenes and
  nodes&lt;/a&gt;.
  There’s no one-to-one mapping of the entities and components concepts.
  Instead, each node has its &lt;code&gt;_process&lt;/code&gt; function and they can have several
  child nodes, whose &lt;code&gt;_process&lt;/code&gt; is also called automatically. These child nodes
  can have descendants of their own, forming a node tree. Although there are no
  explicit components in Godot, you could try to use this node hierarchy to
  achieve the same effect, but accessing component A’s data from component B
  won’t be straightforward, and I wouldn’t count on Godot being optimized for
  this use case.&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;The game loop will run &lt;code&gt;update&lt;/code&gt; on each entity, which will call &lt;code&gt;update&lt;/code&gt; on
every component that’s attached to it. Something like this:&lt;/p&gt;

&lt;div class=&quot;language-c++ highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Entity&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;update&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;auto&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;component&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;components&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;component&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;update&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;draw&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;auto&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;component&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;components&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;component&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;draw&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;// getComponent would need to be aware of the types in `components`.&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// It would probably require some runtime type introspection.&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;template&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;typename&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Component&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;Component&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;getComponent&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Component&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;components&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Component&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;virtual&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;update&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{};&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;virtual&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;draw&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{};&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Entity&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;entities&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;// Add some entities with buildFixedSpeedSphere and buildBobbingSphere&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;finished&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;timeSinceLastCall&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;auto&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;entity&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;entities&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;entity&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;update&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;auto&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;entity&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;entities&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;entity&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;draw&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The main problem with this architecture is that the performance is not that
good, especially when the number of entities and components is high.&lt;/p&gt;

&lt;p&gt;The &lt;code&gt;Entity::update&lt;/code&gt; method goes through every component, and it can’t know the
type of its elements at compile time, since it’s dynamic information: we can
add and remove components at will.&lt;/p&gt;

&lt;p&gt;When iterating through each entity’s component list, we won’t know the type of
the components being iterated until runtime. This means that the compiler must
generate instructions to check, at runtime, the type of the component so that
it knows which &lt;code&gt;update&lt;/code&gt; function to call. This is usually done via a &lt;a href=&quot;https://en.wikipedia.org/wiki/Virtual_method_table&quot;&gt;virtual
table&lt;/a&gt; (&lt;code&gt;vtable&lt;/code&gt;). This
&lt;code&gt;vtable&lt;/code&gt; lookup is costly: the CPU needs to do an extra table lookup to find
the address of the real function, and jump to that position.&lt;/p&gt;

&lt;p&gt;If the CPU keeps jumping from one component function to another unpredictably,
those jumps will not benefit from &lt;a href=&quot;https://en.wikipedia.org/wiki/Branch_predictor&quot;&gt;branch
prediction&lt;/a&gt;. Additionally, it
will potentially have to keep reloading the function instructions from a slower
&lt;a href=&quot;https://en.wikipedia.org/wiki/CPU_cache&quot;&gt;instruction cache&lt;/a&gt; (&lt;code&gt;icache&lt;/code&gt;) layer.&lt;/p&gt;

&lt;p&gt;Another potential issue with this approach is that it’s hard to figure out
which update calls can be done in parallel. Since every function has the same
signature (&lt;code&gt;void update(int)&lt;/code&gt;), there’s no easy way to know if they’re
accessing other components for the current entity, other entities, or other
resources in general.&lt;/p&gt;

&lt;p&gt;Another downside of this approach is data locality. Having a dynamically
allocated vector of component pointers in each game object, plus allocating
components using the system allocator may spread around the data required by
the &lt;code&gt;update&lt;/code&gt; function, which could cause continous data cache misses. This
could possibly be alleviated by using &lt;a href=&quot;https://en.wikipedia.org/wiki/Allocator_(C%2B%2B)&quot;&gt;custom
allocators&lt;/a&gt;, but we still
have some indirections to get to the actual data.&lt;/p&gt;

&lt;h2 id=&quot;entity-component-system-architecture&quot;&gt;Entity-Component-System architecture&lt;/h2&gt;

&lt;p&gt;ECS tries to solve these problem by breaking out of the OOP approach and
leaning towards a data oriented approach, by decoupling the component data from
the behavior. The data would live in the &lt;code&gt;Component&lt;/code&gt; concept while behavior
becomes a &lt;code&gt;System&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Our example could be rewritten into something like this:&lt;/p&gt;

&lt;div class=&quot;language-c++ highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;typedef&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;uint64_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Entity&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Position&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;FixedSpeedMovement&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;BobbingMovement&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;amplitude&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;period&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;DrawableSphere&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;radius&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;slices&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;stacks&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;

&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;FixedSpeedMovementSystem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FixedSpeedMovement&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;movement&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;movement&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;y&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;movement&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dy&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;BobbingMovementSystem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BobbingMovement&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;movement&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;period&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;movement&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;period&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;y&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;movement&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;amplitude&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cos&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;movement&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dy&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;period&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;M_PI&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;period&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;M_PI&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;movement&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dy&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;movement&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dy&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;period&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;movement&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dy&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;period&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;SphereDrawingSystem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;DrawableSphere&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sphere&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;glPushMatrix&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;glTranslatef&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;gluSphere&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;something&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sphere&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;radius&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sphere&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;slices&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sphere&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;stacks&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;glPopMatrix&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Superficially, this example doesn’t feel much different from the previous
versions. The big changes will be in the game loop, which will now do a lot
more work.&lt;/p&gt;

&lt;p&gt;While previously the game loop would only store a set of entities, now there’s
no longer an Entity object where component data can be stored. This means
that we need an alternative storage solution.&lt;/p&gt;

&lt;p&gt;There are several proposed storage mechanisms. One of the simplest solutions is
to keep an array per component with as many elements as there are entities.
This, paired with an array of bitmasks per entity to indicate which components
are attached, would lead to something like this:&lt;/p&gt;

&lt;div class=&quot;language-c++ highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;c1&quot;&gt;// Using a set of global variables for convenience.&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;entities&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FixedSpeedMovement&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fsm&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;BobbingMovement&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bm&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;DrawableSphere&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;kt&quot;&gt;size_t&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;buildFixedSpeedSphere&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mask&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;entities&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;push_back&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;// We push a new element to every component array&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// even if the entity does not require it.&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;push_back&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;({&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;});&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;fsm&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;push_back&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;({&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;});&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;bm&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;push_back&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;({&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;});&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;ds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;push_back&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;({&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;});&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;// The mask bits denote which components are&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// actually used by this entity. In this case,&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// we&#39;re enabling the Position, FixedSpeedMovement,&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// and DrawableSphere components.&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;mask&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mb&quot;&gt;0b1011&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;// The index is used as the entity id&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;entity&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;kt&quot;&gt;size_t&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;buildBobbingSphere&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mask&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;entities&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;push_back&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;// We push a new element to every component array&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// even if the entity does not require it.&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;push_back&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;({&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;});&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;fsm&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;push_back&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;({&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;});&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;bm&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;push_back&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;({&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;});&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;ds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;push_back&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;({&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;});&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;// Enable Position, BobbingMovement, and DrawableSphere.&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;mask&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mb&quot;&gt;0b1101&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;// The index is used as the entity id&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;entity&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// Add some entities with buildFixedSpeedSphere and buildBobbingSphere&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;finished&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;timeSinceLastCall&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;entities&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;// only run systems on entities that have the required components&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;entities&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;mb&quot;&gt;0b0011&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mb&quot;&gt;0b0011&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FixedSpeedMovementSystem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fsm&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]);&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;entities&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;mb&quot;&gt;0b0101&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mb&quot;&gt;0b0101&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BobbingMovementSystem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bm&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]);&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// some systems may need to run after every entity is updated&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;entities&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;entities&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;mb&quot;&gt;0b1000&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mb&quot;&gt;0b1000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SphereDrawingSystem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]);&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In this example, each mask would have up to four bits toggled: one per
component type. I’m arbitrarily picking &lt;code&gt;Position = 0b0001&lt;/code&gt;,
&lt;code&gt;FixedSpeedMovement = 0b0010&lt;/code&gt;, &lt;code&gt;BobbingMovement = 0b0100&lt;/code&gt;, and &lt;code&gt;DrawableSphere
= 0b100&lt;/code&gt;. An entity with every component would have a mask of &lt;code&gt;0b1111&lt;/code&gt;, while
an entity with no components would have a mask of &lt;code&gt;0b0000&lt;/code&gt;. Bobbing spheres
have the &lt;code&gt;Position&lt;/code&gt;, &lt;code&gt;BobbingMovement&lt;/code&gt;, and &lt;code&gt;DrawableSphere&lt;/code&gt; components, so
their mask is &lt;code&gt;0b1011&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Some definitions:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;entity archetype: its set of components: &lt;code&gt;archetype(BobbingSphere) = 0b1101&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;system signature: its set of components: &lt;code&gt;signature(FixedSpeedMovementSystem) = 0b0011&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;an entity matches a system if its archetype covers the system’s signature.&lt;/li&gt;
&lt;/ul&gt;

&lt;aside&gt;
  &lt;p&gt;Note: most of this code would be generated by the framework, so you wouldn’t have
  to manually think about it. I’m just writing it all out so that you have an
  idea of what’s going on.&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;This storage solution gets rid of virtual table lookups at the component level.
It also removes the indirections while accessing the component data: the
iteration index is the pointer.&lt;/p&gt;

&lt;p&gt;Memory wise, though, this storage solution isn’t optimal. It allocates
component space even if the entity doesn’t have that component. It also still
suffers from branch prediction failures: each iteration in the loop will test
if the entity archetype matches the signature of each system, and that’s not
something that’s easily predictable, since entities are added and removed
dynamically.&lt;/p&gt;

&lt;p&gt;Another storage approach that tries to get rid of branch mispredictions and
reduce the component waste is to have multiple buckets, where entities are
stored by archetype. It looks something like this:&lt;/p&gt;

&lt;div class=&quot;language-c++ highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tuple&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;entities&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;// I&#39;m listing all sixteen (2^4) buckets here, but the game engine would&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// only create a bucket when there is an entity that belongs to it,&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// otherwise you&#39;d end up with potentially millions of empty buckets.&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tuple&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;                                                          &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bucket0000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tuple&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt;                                                  &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bucket0001&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tuple&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;         &lt;span class=&quot;n&quot;&gt;FixedSpeedMovement&lt;/span&gt;                               &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bucket0010&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tuple&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FixedSpeedMovement&lt;/span&gt;                               &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bucket0011&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tuple&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;                            &lt;span class=&quot;n&quot;&gt;BobbingMovement&lt;/span&gt;               &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bucket0100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tuple&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;                   &lt;span class=&quot;n&quot;&gt;BobbingMovement&lt;/span&gt;               &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bucket0101&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tuple&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;         &lt;span class=&quot;n&quot;&gt;FixedSpeedMovement&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;BobbingMovement&lt;/span&gt;               &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bucket0110&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tuple&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FixedSpeedMovement&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;BobbingMovement&lt;/span&gt;               &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bucket0111&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tuple&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;                                            &lt;span class=&quot;n&quot;&gt;DrawableSphere&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bucket1000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tuple&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;                                   &lt;span class=&quot;n&quot;&gt;DrawableSphere&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bucket1001&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tuple&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;         &lt;span class=&quot;n&quot;&gt;FixedSpeedMovement&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;                &lt;span class=&quot;n&quot;&gt;DrawableSphere&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bucket1010&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tuple&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FixedSpeedMovement&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;                &lt;span class=&quot;n&quot;&gt;DrawableSphere&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bucket1011&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tuple&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;                            &lt;span class=&quot;n&quot;&gt;BobbingMovement&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;DrawableSphere&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bucket1100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tuple&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;                   &lt;span class=&quot;n&quot;&gt;BobbingMovement&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;DrawableSphere&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bucket1101&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tuple&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;         &lt;span class=&quot;n&quot;&gt;FixedSpeedMovement&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;BobbingMovement&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;DrawableSphere&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bucket1110&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tuple&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FixedSpeedMovement&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;BobbingMovement&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;DrawableSphere&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bucket1110&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;finished&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;timeSinceLastCall&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// Apply FixedSpeedMovementSystem by going through every bucket&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// with Position and FixedSpeedMovement (0b0011)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;auto&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bucket0011&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FixedSpeedMovementSystem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;auto&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bucket0111&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FixedSpeedMovementSystem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;auto&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bucket1011&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FixedSpeedMovementSystem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;auto&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bucket1111&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FixedSpeedMovementSystem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// Apply BobbingMovementSystem by going through every bucket&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// with Position and BobbingMovement (0b0101)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;auto&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bucket0101&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BobbingMovementSystem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;auto&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bucket0111&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BobbingMovementSystem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;auto&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bucket1101&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BobbingMovementSystem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;auto&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bucket1111&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BobbingMovementSystem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// Apply SphereDrawingSystem by going through every bucket&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// with DrawableSphere (0b1000)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;auto&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bucket1000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SphereDrawingSystem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;auto&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bucket1001&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SphereDrawingSystem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;auto&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bucket1010&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SphereDrawingSystem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;auto&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bucket1011&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SphereDrawingSystem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;auto&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bucket1100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SphereDrawingSystem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;auto&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bucket1101&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SphereDrawingSystem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;auto&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bucket1110&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SphereDrawingSystem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;auto&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bucket1111&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SphereDrawingSystem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;elapsedTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This solution reduces the number of branch mispredictions by grouping and
iterating similar entities together. The component memory waste is also solved.
The drawbacks are that you now need to track the bucket index of each entity,
and if you want to add or remove components from an existing entity, you’ll
have to move them to another bucket.&lt;/p&gt;

&lt;p&gt;In this example, each bucket is an array of structures (AoS), where each
structure has component members. Some ECS engines define that each bucket is a
structure of arrays (SoA) instead:&lt;/p&gt;

&lt;div class=&quot;language-c++ highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;  &lt;span class=&quot;c1&quot;&gt;// AoS vs SoA&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tuple&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;B&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;C&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;array_of_structs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;tuple&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;B&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;vector&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;C&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;struct_of_arrays&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The SoA approach gives you a different memory access pattern, useful if your
entities have many components and systems only care about one of two of them.
It prevents data that the system doesn’t care about from filling up your cache.&lt;/p&gt;

&lt;p&gt;ECS won’t solve data locality completely, and the optimal storage strategy will
depend on your specific use case: if you add and remove components from
entities frequently, if your entities mostly have the same set of components,
how many components each entity usually has, etc.&lt;/p&gt;

&lt;p&gt;Now that systems explicitly declare the components that they’re interested in,
via their function definition, you can reason about parallelization. If the
signatures of two systems don’t share any components, they can be run in
parallel. This assumes that your systems are not accessing / modifying global
shared state. If they are, you need to make those dependencies explicit, so
that the scheduler can reason about them as well. Bevy does this, and I’ll show
an example in later sections.&lt;/p&gt;

&lt;p&gt;You could take it further and consider the component’s mutability in each
system when thinking about paralellization: systems that only read data can be
run in parallel with other systems that also only read data, for example.&lt;/p&gt;

&lt;p&gt;If your systems need spawn new entities or add/remove components from existing
ones, you can queue those commands (using the &lt;a href=&quot;https://en.wikipedia.org/wiki/Command_pattern&quot;&gt;command
pattern&lt;/a&gt;) to be executed after
every system has run, so that you don’t interfere with the current loops.&lt;/p&gt;

&lt;p&gt;That last example seems a bit too much, but the game engine would handle the
bucketing and the loops. Your game loop would look something like this:&lt;/p&gt;

&lt;div class=&quot;language-c++ highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;GameEngine&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;engine&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;// Register systems&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;engine&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;addSystem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FixedSpeedMovementSystem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;engine&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;addSystem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;BobbingMovementSystem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;engine&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;addSystem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;SphereDrawingSystem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;// Add entities&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;engine&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;addEntity&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;FixedSpeedMovement&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.0&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;DrawableSphere&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;engine&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;addEntity&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Position&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;BobbingMovement&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;500&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;DrawableSphere&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;engine&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;This is my current understanding of what ECS is, and why it is relevant.&lt;/p&gt;

&lt;p&gt;There are more details that you need to consider, like when systems need to
access other entities other than the one being processed, how to handle global
resources, etc, but this covers the core of the architecture.&lt;/p&gt;

&lt;p&gt;Bevy implements most of these concepts. In the next post of this series, I will
document my process to get something working in Bevy.&lt;/p&gt;

&lt;p&gt;While researching the topic, I found some interesting references. If you’re
looking to learn more about this topic, these might be a good starting point.&lt;/p&gt;

&lt;p&gt;Video:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.youtube.com/watch?v=rX0ItVEVjHc&quot;&gt;CppCon 2014: Mike Acton “Data-Oriented Design and C++”&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.youtube.com/watch?v=NTWSeQtHZ9M&quot;&gt;CppCon 2015: Vittorio Romeo “Implementation of a component-based entity system in modern C++”&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.youtube.com/watch?v=2rW7ALyHaas&quot;&gt;Board To Bits Games: Entity Component System Overview in 7 Minutes&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Text:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://medium.com/@ajmmertens/building-an-ecs-2-archetypes-and-vectorization-fe21690805f9&quot;&gt;Sander Mertens: Building an ECS #2: Archetypes and Vectorization&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://community.amethyst.rs/t/archetypal-vs-grouped-ecs-architectures-my-take/1344&quot;&gt;Amethyst community: Archetypal vs Grouped ECS Architectures, my take&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.randygaul.net/2013/05/20/component-based-engine-design/&quot;&gt;Randy Gaul’s Game Programming Blog: Component Based Engine Design&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://godotengine.org/article/why-does-godot-use-servers-and-rids&quot;&gt;Godot Engine: Why does Godot use Servers and RIDs?&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://gamedev.stackexchange.com/questions/168654/concept-of-scene-in-godot-misunderstanding&quot;&gt;Stackoverflow: Concept of “scene” in Godot, misunderstanding&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;http://gameprogrammingpatterns.com/component.html&quot;&gt;Game Programming Patterns: Decoupling Patterns / Component&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2020-08-31:/articles/status-update-2020-08-31.html</id>
    <title type="html">Status update, August 2020</title>
    <published>2020-08-31T00:00:00Z</published>
    <updated>2020-08-31T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/status-update-2020-08-31.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;August is over, time for a new monthly update.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;I am accepting sponsors via github: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;

  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time.&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;August is over, time for a new monthly update.&lt;/p&gt;

&lt;p&gt;I started helping out with the &lt;a href=&quot;https://cyberscore.me.uk&quot;&gt;Cyberscore&lt;/a&gt; project.
The current version is not free software, but there are plans to open up
version 5. I &lt;a href=&quot;/articles/knee-deep-in-a-lamp-project.html&quot;&gt;wrote about some of the issues I
found&lt;/a&gt;, and recorded a podcast
episode on it as well. I’m currently editing the episode and it should go live
this week. I’m learning &lt;a href=&quot;https://laravel.com/&quot;&gt;Laravel&lt;/a&gt; to see if it’s a good
fit for the new version.&lt;/p&gt;

&lt;p&gt;I’ve also joined &lt;a href=&quot;https://ansol.org/&quot;&gt;ANSOL&lt;/a&gt; and made some contributions to
&lt;a href=&quot;https://github.com/marado/RNID&quot;&gt;https://github.com/marado/RNID&lt;/a&gt;, a project that monitors failures to comply
with the national open standards regulation. In the process &lt;a href=&quot;/articles/html-xml-utils-fix.html&quot;&gt;I found a bug and
submitted a fix to &lt;code&gt;html-xml-utils&lt;/code&gt;&lt;/a&gt;. The
fix was released in &lt;a href=&quot;https://www.w3.org/Tools/HTML-XML-utils/ChangeLog&quot;&gt;version
7.9&lt;/a&gt;. I’m trying to get it
packaged by Debian:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://salsa.debian.org/rnaundorf-guest/html-xml-utils/-/merge_requests/2&quot;&gt;https://salsa.debian.org/rnaundorf-guest/html-xml-utils/-/merge_requests/2&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;My contributions to ANSOL’s RNID project (mostly in portuguese):&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/marado/RNID/pull/65&quot;&gt;Don’t mark &lt;code&gt;alt=&quot;&quot;&lt;/code&gt; as an accessibility error&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/marado/RNID/pull/64&quot;&gt;Starts tracking accessmonitor.accessibilidade.pt&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/marado/RNID/pull/60&quot;&gt;Remove inventarios.pt&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/marado/RNID/pull/59&quot;&gt;Small typo fix&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/marado/RNID/pull/54&quot;&gt;Transcribe RNID legislation to markdown&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/marado/RNID/pull/53&quot;&gt;Another small typo fix&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I also started working on a way to reduce the repetition in these scripts and
make it easier to add new ones. No PR yet, but &lt;a href=&quot;https://github.com/hugopeixoto/RNID/tree/create-framework&quot;&gt;there’s a
branch&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The &lt;a href=&quot;http://veekun.com/&quot;&gt;veekun / pokedex&lt;/a&gt; project is starting to have some
activity again. The current version uses
&lt;a href=&quot;https://www.pylonsproject.org/&quot;&gt;pylons&lt;/a&gt; and it doesn’t support python 3, so
it’s being upgraded to &lt;a href=&quot;https://trypyramid.com/&quot;&gt;pyramid&lt;/a&gt;. I helped porting one
of the sections:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/magical/spline-pokedex/pull/1&quot;&gt;Add frontpage&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The pyramid version is live at &lt;a href=&quot;http://beta.veekun.com/&quot;&gt;http://beta.veekun.com/&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;During the week from 16 to 23 &lt;a href=&quot;https://gamesdonequick.com/&quot;&gt;Summer Games Done
Quick&lt;/a&gt; and &lt;a href=&quot;https://itch.io/jam/games-made-quick-four-plus&quot;&gt;Games Made
Quick&lt;/a&gt; happened and I spent
some time trying to build a game with &lt;a href=&quot;bevyengine.org/&quot;&gt;bevy&lt;/a&gt;, a rust ECS game
engine. I’m working on a blog post detailing what I learned and what I built.&lt;/p&gt;

&lt;p&gt;I randomly bumped into some warnings in the &lt;a href=&quot;https://github.com/microformats/microformats-ruby&quot;&gt;microformats
gem&lt;/a&gt; in ruby 2.7. I
submitted some fixes that were already merged:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/microformats/microformats-ruby/pull/114&quot;&gt;Fix ruby 2.7 warnings in open()&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/microformats/microformats-ruby/pull/115&quot;&gt;Update ruby versions&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I finally got around to finish automating the nginx configuration and
deployment of static websites on my server. I built a small tool:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/hugopeixoto/static-websites&quot;&gt;https://github.com/hugopeixoto/static-websites&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;It still needs some love if I want to make it usable by someone else, so I
documented those issues in the project’s readme.&lt;/p&gt;

&lt;p&gt;I also noticed I had broken
&lt;a href=&quot;https://github.com/lifeonmarspt/vasteroids&quot;&gt;vasteroids&lt;/a&gt; by upgrading aframe to
&lt;code&gt;1.0.0&lt;/code&gt;, a version that changed a lot of APIs. I spent some time fixing those
issues and the &lt;a href=&quot;https://vasteroids.lifeonmars.pt/&quot;&gt;live version&lt;/a&gt; should work
fine.&lt;/p&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2020-08-16:/articles/html-xml-utils-fix.html</id>
    <title type="html">HTML-XML-utils bug fix</title>
    <published>2020-08-16T00:00:00Z</published>
    <updated>2020-08-16T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/html-xml-utils-fix.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;While working on &lt;a href=&quot;https://github.com/marado/RNID&quot;&gt;https://github.com/marado/RNID&lt;/a&gt;, I hit a bug in &lt;code&gt;hxselect&lt;/code&gt;, a C tool from &lt;a href=&quot;https://www.w3.org/Tools/HTML-XML-utils/&quot;&gt;HTML-XML-utils&lt;/a&gt;. I found the bug, sent it upstream, and I’m now trying to get it packaged by Debian.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;p&gt;I’ve been working on &lt;a href=&quot;https://github.com/marado/RNID&quot;&gt;https://github.com/marado/RNID&lt;/a&gt;, a project that monitors
failures to comply with the national open standards regulation. It is basically
a set of bash scripts that check if there has been any updates to the websites
found in breach.&lt;/p&gt;

&lt;p&gt;One of the command line tools it uses is &lt;code&gt;hxselect&lt;/code&gt;, coming from the
&lt;a href=&quot;https://www.w3.org/Tools/HTML-XML-utils/&quot;&gt;HTML-XML-utils package&lt;/a&gt;. &lt;code&gt;hxselect&lt;/code&gt;
prints html elements that match a CSS selector. Here’s an example usage (&lt;code&gt;-s&lt;/code&gt;
specifies the separators between matches):&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;cat sample.html
&lt;/span&gt;&amp;lt;html&amp;gt;
  &amp;lt;body&amp;gt;
    &amp;lt;h1&amp;gt;Hello&amp;lt;/h1&amp;gt;
    &amp;lt;p&amp;gt;Lorem ipsum&amp;lt;/p&amp;gt;
    &amp;lt;ul&amp;gt;
      &amp;lt;li&amp;gt;first&amp;lt;/li&amp;gt;
      &amp;lt;li&amp;gt;second&amp;lt;/li&amp;gt;
    &amp;lt;/ul&amp;gt;
    &amp;lt;p&amp;gt;Dolor sit amet&amp;lt;/p&amp;gt;
  &amp;lt;/body&amp;gt;
&amp;lt;/html&amp;gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;cat sample.html | hxselect &#39;body &amp;gt; p&#39; -s &#39;\n&#39;
&lt;/span&gt;&amp;lt;p&amp;gt;Lorem ipsum&amp;lt;/p&amp;gt;
&amp;lt;p&amp;gt;Dolor sit amet&amp;lt;/p&amp;gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;One of the things that &lt;code&gt;marado/RNID&lt;/code&gt; checks for is &lt;a href=&quot;https://www.w3.org/TR/WCAG20/&quot;&gt;WCAG 2.0
AA&lt;/a&gt; compliance. Instead of doing a full
accessibility check, the scripts use some proxy checks, like checking for image
tags without or with empty &lt;code&gt;alt&lt;/code&gt; attributes.&lt;/p&gt;

&lt;p&gt;Although &lt;code&gt;hxselect&lt;/code&gt; is used throughout the project, the scripts are using &lt;code&gt;grep
&quot;alt=&#39;&#39;&quot;&lt;/code&gt; to check for empty &lt;code&gt;alt&lt;/code&gt; attributes. I decided to try to use
&lt;code&gt;hxselect&lt;/code&gt;, since we can filter elements by attribute values using CSS selectors:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;echo &quot;&amp;lt;img alt=&#39;&#39;&amp;gt;&quot; | hxselect -s &#39;\n&#39; &#39;img[alt=&quot;&quot;]&#39;
&lt;/span&gt;Segmentation fault
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Since I had installed this via apt, I found the upstream via &lt;code&gt;apt show
html-xml-utils&lt;/code&gt;, which pointed to &lt;a href=&quot;https://www.w3.org/Tools/HTML-XML-utils/&quot;&gt;https://www.w3.org/Tools/HTML-XML-utils/&lt;/a&gt;.
I downloaded the latest version to confirm that the bug hadn’t been fixed.&lt;/p&gt;

&lt;p&gt;There’s no git repository, so I downloaded the latest version, extracted it,
and iniitialized a local git repository and commited everything, mostly so I
could track what my changes. I &lt;a href=&quot;https://github.com/hugopeixoto/html-xml-utils&quot;&gt;pushed it to
github&lt;/a&gt; just to have a backup.&lt;/p&gt;

&lt;p&gt;Since I’m a &lt;a href=&quot;https://tenderlovemaking.com/2016/02/05/i-am-a-puts-debuggerer.html&quot;&gt;puts
debuggerer&lt;/a&gt;,
I started sprinkling &lt;code&gt;printf&lt;/code&gt; statements throughout the code, starting from
&lt;code&gt;main&lt;/code&gt;. Eventually I found that it crashed in a &lt;code&gt;*s == *t &amp;amp;&amp;amp; strcmp(s,t) == 0&lt;/code&gt;.
This suggested that the attribute value in the query, while empty, was being
set to &lt;code&gt;NULL&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;I tracked this down to &lt;code&gt;parse_selector&lt;/code&gt;. It only allocated the string when
visiting the first character in the value’s string. The main change ended up
being small:&lt;/p&gt;

&lt;div class=&quot;language-diff highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gh&quot;&gt;diff --git a/selector.c b/selector.c
index 25a5f7c..a068527 100644
&lt;/span&gt;&lt;span class=&quot;gd&quot;&gt;--- a/selector.c
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+++ b/selector.c
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;@@ -314,12 +314,20 @@&lt;/span&gt; EXPORT Selector parse_selector(const string selector, string *rest)
       else errexit(&quot;Expected string or name after \&quot;=\&quot; but found \&quot;%c\&quot;\n&quot;,*s);
       break;
     case DSTRING:                              /* Inside &quot;...&quot; */
&lt;span class=&quot;gd&quot;&gt;-      if (*s == &#39;&quot;&#39;) {s++; state = AFTER_VALUE;}
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+      if (*s == &#39;&quot;&#39;) {
+        s++;
+        if (!sel-&amp;gt;attribs-&amp;gt;value) sel-&amp;gt;attribs-&amp;gt;value = newstring(&quot;&quot;);
+        state = AFTER_VALUE;
+      }
&lt;/span&gt;       else if (*s == &#39;\\&#39;) parse_escape(&amp;amp;s, &amp;amp;sel-&amp;gt;attribs-&amp;gt;value);
       else {strappc(&amp;amp;sel-&amp;gt;attribs-&amp;gt;value, *s); s++;}
       break;
     case SSTRING:                              /* Inside &quot;...&quot; */
&lt;span class=&quot;gd&quot;&gt;-      if (*s == &#39;\&#39;&#39;) {s++; state = AFTER_VALUE;}
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+      if (*s == &#39;\&#39;&#39;) {
+        s++;
+        if (!sel-&amp;gt;attribs-&amp;gt;value) sel-&amp;gt;attribs-&amp;gt;value = newstring(&quot;&quot;);
+        state = AFTER_VALUE;
+      }
&lt;/span&gt;       else if (*s == &#39;\\&#39;) parse_escape(&amp;amp;s, &amp;amp;sel-&amp;gt;attribs-&amp;gt;value);
       else {strappc(&amp;amp;sel-&amp;gt;attribs-&amp;gt;value, *s); s++;}
       break;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This initializes the string if it hadn’t been initialized when the end quote
marker is detected. I added a unit test and struggled a bit with &lt;code&gt;autotools&lt;/code&gt; to
see it working.&lt;/p&gt;

&lt;p&gt;Once it was working, I had to figure out how to send it upstream. I checked
&lt;a href=&quot;https://www.w3.org/Tools/HTML-XML-utils/ChangeLog&quot;&gt;the changelog&lt;/a&gt;, and got an
email address. I generated a patch via &lt;code&gt;git format-patch&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;git format-patch HEAD~
&lt;/span&gt;0001-Fix-segfault-when-querying-for-empty-attributes.patch
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;A few hours after I emailed the patch, the author released a new version (7.9).&lt;/p&gt;

&lt;p&gt;The next step is to get it packaged for Debian. Going to
&lt;a href=&quot;https://tracker.debian.org/pkg/html-xml-utils&quot;&gt;https://tracker.debian.org/pkg/html-xml-utils&lt;/a&gt; pointed me to a &lt;a href=&quot;https://salsa.debian.org/rnaundorf-guest/html-xml-utils&quot;&gt;Salsa
repository&lt;/a&gt;. I made a
merge request that refreshes the upstream source code from 7.7 to 7.9:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://salsa.debian.org/rnaundorf-guest/html-xml-utils/-/merge_requests/2&quot;&gt;https://salsa.debian.org/rnaundorf-guest/html-xml-utils/-/merge_requests/2&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It’s still pending review, and I’ll need to work on a merge request to the
actual &lt;code&gt;debian&lt;/code&gt; files. This is the first time I’m involved with the release of
a Debian package, so I’m not sure how long this process is going to take.&lt;/p&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2020-08-08:/articles/knee-deep-in-a-lamp-project.html</id>
    <title type="html">Knee deep in a LAMP project</title>
    <published>2020-08-08T00:00:00Z</published>
    <updated>2020-08-08T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/knee-deep-in-a-lamp-project.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;I’ve been lending a hand with the development of Cyberscore. It’s a video game records community with almost 20 years of existence. I have a friend that sometimes helps out with maintenance, and they were having some issues so I decided to help out as well.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;I am accepting sponsors via github: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;

  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time.&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;I’ve been lending a hand with the development of
&lt;a href=&quot;https://www.cyberscore.me.uk/&quot;&gt;Cyberscore&lt;/a&gt;. It’s a video game records
community with almost 20 years of existence. I have a friend that sometimes
helps out with maintenance, and they were having some issues so I decided to
help out as well.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://www.cyberscore.me.uk/history.php&quot;&gt;The site history&lt;/a&gt; tells us that the
current version started development in 2007. This was when frameworks like
&lt;a href=&quot;https://rubyonrails.org&quot;&gt;Rails&lt;/a&gt;, &lt;a href=&quot;https://cakephp.org/&quot;&gt;CakePHP&lt;/a&gt; and
&lt;a href=&quot;https://www.djangoproject.com/&quot;&gt;Django&lt;/a&gt; were starting to gain traction.&lt;/p&gt;

&lt;p&gt;This codebase doesn’t use any frameworks, though. It’s what I’d call
&lt;a href=&quot;https://en.wikipedia.org/wiki/LAMP_%28software_bundle%29&quot;&gt;LAMP&lt;/a&gt;-style.&lt;/p&gt;

&lt;h2 id=&quot;lamp-style-php&quot;&gt;LAMP-style PHP&lt;/h2&gt;

&lt;p&gt;In this style, you put your PHP files in the directory that’s being served by
&lt;code&gt;apache2&lt;/code&gt;, and access them directly from the browser: Access
&lt;code&gt;https://example.com/hello.php&lt;/code&gt; and it would serve the file
&lt;code&gt;/var/www/html/hello.php&lt;/code&gt;, preprocessed by
&lt;a href=&quot;https://www.php.net/manual/en/install.unix.debian.php&quot;&gt;mod_php&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The router was the file system, sometimes enhanced by an &lt;a href=&quot;https://en.wikipedia.org/wiki/.htaccess&quot;&gt;&lt;code&gt;.htaccess&lt;/code&gt;
file&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;It was common for people to accidentally misconfigure apache and end up serving
the source code instead of the processed result. This was particularly
dangerous because you’d have the database password or other credentials
hardcoded into the source.&lt;/p&gt;

&lt;p&gt;It was also common to suffer from SQL injections. SQL queries were built by
concatenating strings and user input, and user input was not always escaped.&lt;/p&gt;

&lt;p&gt;The way files were laid out lended itself to a specific pattern. A typical PHP
page would look like this:&lt;/p&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;require_once&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;db.php&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;cp&quot;&gt;?&amp;gt;&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;require_once&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;header.php&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;cp&quot;&gt;?&amp;gt;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;h1&amp;gt;&lt;/span&gt;Welcome to my blog&lt;span class=&quot;nt&quot;&gt;&amp;lt;/h1&amp;gt;&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;$posts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;db_query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;SELECT * FROM posts ORDER BY published_date&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$post&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;mysqli_fetch_assoc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$posts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;?&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;&amp;lt;h2&amp;gt;&lt;/span&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$post&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;title&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt; &lt;span class=&quot;cp&quot;&gt;?&amp;gt;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;/h2&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;&amp;lt;p&amp;gt;&lt;/span&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;nl2br&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$post&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;body&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]);&lt;/span&gt; &lt;span class=&quot;cp&quot;&gt;?&amp;gt;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;/p&amp;gt;&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;cp&quot;&gt;?&amp;gt;&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;require_once&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;footer.php&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;cp&quot;&gt;?&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This makes it very easy to use. Shared hosts were very popular, everything
configured for you. You’d just need to open up a php file and start writing
code. On the other hand, SQL, PHP, and HTML were tightly linked. This could
become a maintenance nightmare if you weren’t disciplined.&lt;/p&gt;

&lt;p&gt;One thing that was great about PHP is that each function (see
&lt;a href=&quot;https://www.php.net/manual/en/function.array-map.php&quot;&gt;array_map&lt;/a&gt;, for example)
had plenty of examples and use cases, along with user contributed notes.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://eev.ee/blog/2012/04/09/php-a-fractal-of-bad-design/&quot;&gt;PHP had plenty of
criticism&lt;/a&gt;, but it
was super easy to get a website working.&lt;/p&gt;

&lt;p&gt;MySQL was always included in the bundle, coupled with
&lt;a href=&quot;https://www.phpmyadmin.net/&quot;&gt;phpMyAdmin&lt;/a&gt;. The web admin allows you to query
the database, create or change tables with a few clicks.&lt;/p&gt;

&lt;p&gt;There were two MySQL common storage engines: MyISAM (the default) and InnoDB. MyISAM
does not support transactions nor foreign keys, but since it was the default,
it’s what everyone used. The default
&lt;a href=&quot;https://en.wikipedia.org/wiki/Collation&quot;&gt;collation&lt;/a&gt; was also a weird one:
&lt;code&gt;latin1_swedish_ci&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;I recently found out that MySQL has an option that you can disable called
&lt;a href=&quot;https://dev.mysql.com/doc/refman/8.0/en/sql-mode.html#sql-mode-strict&quot;&gt;strict
mode&lt;/a&gt;.
If you disable it, tables with non-NULL columns with no default value stop
requiring that you specify their values when inserting rows. They also stop
requiring that you pass valid values. Instead of erroring out, MySQL picks a
value for you (usually the zero value for that type).&lt;/p&gt;

&lt;p&gt;Not having strict mode can cause some surprises. Here’s are some SQL queries
that got me confused me for a while:&lt;/p&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;games&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;where&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;date_published&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;is&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;mi&quot;&gt;2214&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;games&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;where&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;date_published&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;is&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;not&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;mi&quot;&gt;2511&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;games&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;mi&quot;&gt;2511&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Most values in this table are considered both null &lt;strong&gt;and&lt;/strong&gt; not null. Turns out
this happens when you have the datetime &lt;code&gt;0000-00-00 00:00:00&lt;/code&gt;, which is not a
valid date, but allowed when strict mode is disabled. This is documented in
&lt;a href=&quot;https://bugs.mysql.com/bug.php?id=940&quot;&gt;this bug&lt;/a&gt; and the &lt;a href=&quot;https://dev.mysql.com/doc/refman/8.0/en/comparison-operators.html&quot;&gt;IS NULL operator
documentation&lt;/a&gt;:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;For DATE and DATETIME columns that are declared as NOT NULL, you can find the
special date ‘0000-00-00’ by using a statement like this:&lt;/p&gt;

  &lt;p&gt;&lt;code&gt;SELECT * FROM tbl_name WHERE date_column IS NULL&lt;/code&gt;&lt;/p&gt;

  &lt;p&gt;This is needed to get some ODBC applications to work because ODBC does not
support a ‘0000-00-00’ date value.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;One thing that for me marks the difference between mysql and postgresql is the
handling of selected columns in queries with group by statements.&lt;/p&gt;

&lt;p&gt;I just hit this when trying to get the game that has the most record submissions.&lt;/p&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;c1&quot;&gt;-- mysql happily picks an arbitrary game_id&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;game_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;records&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;desc&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;limit&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1440821&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;-- pgsql complains that I can&#39;t just use game_id&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;game_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;records&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;desc&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;limit&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;ERROR&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;  &lt;span class=&quot;k&quot;&gt;column&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;&quot;records.game_id&quot;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;must&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;appear&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;the&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;GROUP&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;BY&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;clause&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;or&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;be&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;used&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;an&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;aggregate&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;-- the query that I actually wanted to write&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;game_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;records&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;group&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;game_id&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;desc&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;limit&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
 &lt;span class=&quot;mi&quot;&gt;23&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;62421&lt;/span&gt;
&lt;span class=&quot;mi&quot;&gt;390&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;37054&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In MySQL, you can select columns that were not in the GROUP BY clause without
any aggregate functions. When I first started using postgresql I used to
complain that it didn’t behave like mysql, but they eventually added support
for selecting functionally dependent columns, which is what you usually want.&lt;/p&gt;

&lt;p&gt;Selecting functionally dependent columns means that you can group by a table
primary key and select the other columns from that table, since they’re
guaranteed to be unique. The first query would work in postgresql, while the
second wouldn’t:&lt;/p&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;c1&quot;&gt;-- games.game_name is functionally dependent on games.game_id&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;games&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;game_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;games&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;game_name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;total_records&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;records&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;join&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;games&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;using&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;game_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;group&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;games&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;game_id&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;-- records.user_id is not functionally dependent on games.game_id&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;games&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;game_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;records&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;total_records&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;records&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;join&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;games&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;using&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;game_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;group&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;BY&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;games&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;game_id&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;cyberscore&quot;&gt;Cyberscore&lt;/h2&gt;

&lt;p&gt;The website relies on cached score and ranking calculations whose rebuild
process is queued whenever someone submits a new record. The whole thing stops
responding for a few minutes at a time, and sometimes the server even reboots.
The maintainers were delaying those cronjobs to try to alleviate the problem,
but it kept happening.&lt;/p&gt;

&lt;p&gt;We started by adding a swap file to reduce errors caused by RAM usage bursts.&lt;/p&gt;

&lt;p&gt;Next, I started investigating their cron jobs. Most of these were introduced
when running the calculations inline became too costly, and they were usually
written under pressure because the cost of running them inline brought the
website down.&lt;/p&gt;

&lt;p&gt;I started with one that rebuilds the scoreboards for a given game. There are
some complex calculations going on, but rebuilding the scoreboards for &lt;a href=&quot;https://www.cyberscore.me.uk/game/23&quot;&gt;Super
Smash Bros. Melee&lt;/a&gt; was taking ~10 minutes
on my laptop.&lt;/p&gt;

&lt;p&gt;To profile this, I wrote a helper function:&lt;/p&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;wikilog&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$message&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// every query goes through a db_query function that&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// tracks total number of queries done so far.&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;global&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$db_num_queries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$previous&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$previous_db_queries&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$previous&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$previous&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;hrtime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$previous_db_queries&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$previous_db_queries&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$db_num_queries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;$now&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;hrtime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;$delta&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$now&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$previous&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;$previous&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$now&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;nv&quot;&gt;$delta_queries&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$db_num_queries&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$previous_db_queries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;$previous_db_queries&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$db_num_queries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;nv&quot;&gt;$secs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;intdiv&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$delta&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1000000000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;$msecs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;intdiv&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$delta&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1000000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;[&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$delta_queries&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; sql][&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$secs&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$msecs&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;ms] &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$message&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;nb&quot;&gt;flush&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
  &lt;span class=&quot;nb&quot;&gt;ob_flush&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This function prints the time ellapsed and number of queries between two
consecutive calls. It has a very specific name because I want to be able to get
rid of them at commit time, and it also helps navigating between them.&lt;/p&gt;

&lt;p&gt;Placing one call at the start of the file and one at the end reported that this
script made a whopping &lt;em&gt;160 thousand&lt;/em&gt; queries.&lt;/p&gt;

&lt;p&gt;Given that the game has ~60k records submitted from ~600 different users, we
probably have a N+1 problem.&lt;/p&gt;

&lt;p&gt;The first thing I did was clean up the indentation of the file. There was a mix
of tabs and spaces, SQL queries were not split across several lines, and the
brace style was inconsistent. Not only did it make editing easier, it also
forced me to read through the code and understand what was going on, and how
some pieces of code were more or less copy-pasted in several places.&lt;/p&gt;

&lt;p&gt;I kept sprinkling &lt;code&gt;wikilog&lt;/code&gt;s through the code and changed the code to improve
these numbers. Most of the problems came from this kind of pattern:&lt;/p&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;foo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$game_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;$users&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;db_query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;
    SELECT user_id, SUM(some_fields)
    FROM records
    WHERE game_id = &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$game_id&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;
    GROUP BY user_id
  &quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$user&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;mysqli_fetch_assoc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$users&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$total_users&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;db_query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;
      SELECT COUNT(DISTINCT user_id)
      FROM records
      WHERE game_id = &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$game_id&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;
    &quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;nv&quot;&gt;$score&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;foo_score&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$game_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$total_users&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;nf&quot;&gt;db_query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;
      INSERT INTO foo_cache (user_id, score)
      VALUES (&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;user_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;, &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$total_users&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;)
    &quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note that the &lt;code&gt;$total_users&lt;/code&gt; query doesn’t depend on &lt;code&gt;$user&lt;/code&gt; at all, so it can
be moved to before the user loop. Sometimes the queries used &lt;code&gt;$user&lt;/code&gt;, but they
could be folded onto the &lt;code&gt;$users&lt;/code&gt; query through joins or extra selections.&lt;/p&gt;

&lt;p&gt;I also built an &lt;code&gt;insert_all&lt;/code&gt; function to mass insert the cached values. This
requires more memory, since we’d be keeping everything in an array and
stringify it into a single query. The number of iterations is under 1000,
though, so the extra memory usage doesn’t cause any problems.&lt;/p&gt;

&lt;p&gt;The final result looked a bit like this:&lt;/p&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;foo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$game_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;$users&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;db_query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;
    SELECT user_id, SUM(some_fields)
    FROM records
    WHERE game_id = &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$game_id&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;
    GROUP BY user_id
  &quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

  &lt;span class=&quot;nv&quot;&gt;$total_users&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;db_query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;
    SELECT COUNT(DISTINCT user_id)
    FROM records
    WHERE game_id = &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$game_id&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;
  &quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

  &lt;span class=&quot;nv&quot;&gt;$records&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[];&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$user&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;mysqli_fetch_assoc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$users&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$score&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;foo_score&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$game_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$total_users&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;nv&quot;&gt;$records&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;array&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;user_id&#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;user_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;score&#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$total_users&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;nf&quot;&gt;insert_all&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;foo_cache&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$records&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The constant queries weren’t always obvious. Sometimes they’d be in functions
that were written to be used elsewhere, so it’s expected that they decided to
reuse them, not considering this cost.&lt;/p&gt;

&lt;p&gt;Right now, this example is taking ~35 seconds to run, and it makes 1400
queries. It still sounds like a lot, but since this is running in a cron job,
it’s acceptable. The missing N+1 situation would require a monster query and it
would probably kill the readability of the thing, so I opted for moving to
other sections to optimize.&lt;/p&gt;

&lt;p&gt;Here’s another example where rewriting the function helped me understand what
was going on and detect a bug:&lt;/p&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$p_function&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;TransferModifiers&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$modifiers&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;db_query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;SELECT * FROM levels JOIN level_modifiers USING level_id&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;while&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;db_get_result&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$modifiers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nf&quot;&gt;db_query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;DELETE FROM chart_modifiers WHERE level_id = &#39;&quot;&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;level_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&#39;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

        &lt;span class=&quot;nv&quot;&gt;$m&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;db_query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;SELECT * FROM level_modifiers WHERE level_id = &#39;&quot;&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;level_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&#39;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$chart_type&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;db_extract&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;SELECT ranked FROM levels WHERE level_id = &#39;&quot;&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;level_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&#39;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$game_id&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;db_extract&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;SELECT game_id FROM levels WHERE level_id = &#39;&quot;&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;level_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&#39;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart_type&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$r&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;AddModifier&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;level_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$game_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;chart_flag&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart_type&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$r&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;AddModifier&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;level_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$game_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;chart_flag&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;user_challenge&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$r&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;AddModifier&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;level_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$game_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;chart_flag&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;unranked&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$r&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;AddModifier&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;level_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$game_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;chart_flag&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;region_differences&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$r&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;AddModifier&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;level_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$game_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;csp_modifier&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//Regional Differences&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;device_differences&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$r&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;AddModifier&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;level_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$game_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;csp_modifier&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//Device Differences&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;big_regional&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$r&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;AddModifier&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;level_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$game_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;csp_modifier&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//Regional Differences (significant)&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;big_device&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$r&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;AddModifier&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;level_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$game_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;csp_modifier&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//Device Differences (significant)&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;patience_chart&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$r&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;AddModifier&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;level_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$game_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;csp_modifier&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//Patience Chart&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;computer_generation&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$r&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;AddModifier&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;level_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$game_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;csp_modifier&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//Computer Generated Chart&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;earnable_upgrades_mtx&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$r&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;AddModifier&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;level_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$game_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;csp_modifier&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//Earnable Premium Upgrades&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;unearnable_upgrades_mtx&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$r&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;AddModifier&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;level_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$game_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;csp_modifier&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//Non-Earnable Premium Upgrades&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;premium_dlc&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$r&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;AddModifier&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;level_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$game_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;csp_modifier&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;9&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//Premium DLC&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$cs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;WriteNote&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;Modifiers Rebuild&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$redirect&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;/mod_scripts/rebuild_center.php&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This was on the top level of a file, not in a function. Note the mixed
indentation (those are spaces and tabs). The first step was to extract the meat
of the code into a function, so that I could easily call it from a custom
script.&lt;/p&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TransferModifiers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;global&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$r&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;$modifiers&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;db_query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;SELECT * FROM levels JOIN level_modifiers USING level_id&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;while&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;db_get_result&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$modifiers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;db_query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;DELETE FROM chart_modifiers WHERE level_id = &#39;&quot;&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;level_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&#39;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;nv&quot;&gt;$m&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;db_query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;SELECT * FROM level_modifiers WHERE level_id = &#39;&quot;&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;level_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&#39;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$chart_type&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;db_extract&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;SELECT ranked FROM levels WHERE level_id = &#39;&quot;&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;level_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&#39;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$game_id&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;db_extract&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;SELECT game_id FROM levels WHERE level_id = &#39;&quot;&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;level_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&#39;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart_type&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$r&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;AddModifier&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;level_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$game_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;chart_flag&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart_type&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$r&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;AddModifier&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;level_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$game_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;chart_flag&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;user_challenge&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$r&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;AddModifier&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;level_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$game_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;chart_flag&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;unranked&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$r&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;AddModifier&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;level_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$game_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;chart_flag&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;region_differences&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$r&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;AddModifier&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;level_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$game_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;csp_modifier&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//Regional Differences&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;device_differences&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$r&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;AddModifier&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;level_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$game_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;csp_modifier&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//Device Differences&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;big_regional&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$r&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;AddModifier&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;level_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$game_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;csp_modifier&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//Regional Differences (significant)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;big_device&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$r&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;AddModifier&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;level_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$game_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;csp_modifier&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//Device Differences (significant)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;patience_chart&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$r&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;AddModifier&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;level_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$game_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;csp_modifier&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//Patience Chart&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;computer_generation&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$r&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;AddModifier&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;level_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$game_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;csp_modifier&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//Computer Generated Chart&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;earnable_upgrades_mtx&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$r&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;AddModifier&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;level_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$game_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;csp_modifier&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//Earnable Premium Upgrades&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;unearnable_upgrades_mtx&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$r&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;AddModifier&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;level_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$game_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;csp_modifier&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//Non-Earnable Premium Upgrades&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;premium_dlc&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$r&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;AddModifier&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;level_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$game_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;csp_modifier&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;9&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//Premium DLC&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You can see that the &lt;code&gt;$m&lt;/code&gt;, &lt;code&gt;$chart_type&lt;/code&gt;, and &lt;code&gt;$game_id&lt;/code&gt; queries are all
redundant. Those fields were already selected in &lt;code&gt;$modifiers&lt;/code&gt;, so they could be
removed and replaced with references to &lt;code&gt;$chart&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;The if statements also felt a bit noisy. There’s a lot of repetition of
&lt;code&gt;$r-&amp;gt;addModifier($chart[&#39;level_id&#39;], $game_id&#39;, X, Y)&lt;/code&gt;. It makes it hard to see
what’s important.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;AddModifier&lt;/code&gt; makes an &lt;code&gt;INSERT&lt;/code&gt; query, so I also decided to replace them with
&lt;code&gt;insert_all&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;The &lt;code&gt;DELETE&lt;/code&gt; query was also inside the loop, so I moved it out. In this case, I
decided it would be OK to delete every record, since there’s a 1-1 mapping
between &lt;code&gt;chart_modifiers&lt;/code&gt; and &lt;code&gt;level_modifiers&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;This is the result:&lt;/p&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TransferModifiers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;global&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$r&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;$level_modifiers&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;db_query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;SELECT * FROM levels JOIN level_modifiers USING level_id&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;nf&quot;&gt;db_query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;DELETE FROM chart_modifiers&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

  &lt;span class=&quot;nv&quot;&gt;$modifiers&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[];&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$m&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;db_get_result&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$level_modifiers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$csp_modifiers&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[];&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$chart_modifiers&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[];&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;ranked&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;         &lt;span class=&quot;nv&quot;&gt;$chart_modifiers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;ranked&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;         &lt;span class=&quot;nv&quot;&gt;$chart_modifiers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;user_challenge&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$chart_modifiers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;unranked&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;       &lt;span class=&quot;nv&quot;&gt;$chart_modifiers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;region_differences&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;      &lt;span class=&quot;nv&quot;&gt;$csp_modifiers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//Regional Differences&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;device_differences&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;      &lt;span class=&quot;nv&quot;&gt;$csp_modifiers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//Device Differences&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;big_regional&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;            &lt;span class=&quot;nv&quot;&gt;$csp_modifiers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//Regional Differences (significant)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;big_device&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;              &lt;span class=&quot;nv&quot;&gt;$csp_modifiers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//Device Differences (significant)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;patience_chart&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;          &lt;span class=&quot;nv&quot;&gt;$csp_modifiers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//Patience Chart&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;computer_generation&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;     &lt;span class=&quot;nv&quot;&gt;$csp_modifiers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//Computer Generated Chart&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;earnable_upgrades_mtx&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;   &lt;span class=&quot;nv&quot;&gt;$csp_modifiers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//Earnable Premium Upgrades&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;unearnable_upgrades_mtx&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$csp_modifiers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//Non-Earnable Premium Upgrades&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;premium_dlc&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;             &lt;span class=&quot;nv&quot;&gt;$csp_modifiers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;9&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//Premium DLC&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;foreach&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$chart_modifiers&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$modifier&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;nv&quot;&gt;$modifiers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;array&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
        &lt;span class=&quot;s1&quot;&gt;&#39;game_id&#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;game_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
        &lt;span class=&quot;s1&quot;&gt;&#39;level_id&#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;level_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
        &lt;span class=&quot;s1&quot;&gt;&#39;type&#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;chart_flag&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;s1&quot;&gt;&#39;value&#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$modifier&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;foreach&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$csp_modifiers&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$modifier&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;nv&quot;&gt;$modifiers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;array&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
        &lt;span class=&quot;s1&quot;&gt;&#39;game_id&#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;game_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
        &lt;span class=&quot;s1&quot;&gt;&#39;level_id&#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;level_id&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
        &lt;span class=&quot;s1&quot;&gt;&#39;type&#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;csp_modifier&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;s1&quot;&gt;&#39;value&#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$modifier&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;nf&quot;&gt;insert_all&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;chart_modifiers&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$modifiers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The function became a bit longer, as a consequence of inlining and batching
&lt;code&gt;AddModifier&lt;/code&gt;. It could make sense to make some extra changes to avoid that
repetition.&lt;/p&gt;

&lt;p&gt;Once thing I noticed after this change is that the &lt;code&gt;chart_modifiers&lt;/code&gt; values are
&lt;code&gt;1, 2, 4, 2&lt;/code&gt;. Two modifiers with the same value seemed odd, and indeed it
should have been &lt;code&gt;3&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Now I’m focusing on improving page loads. &lt;a href=&quot;https://www.cyberscore.me.uk/games.php?site_id=all&quot;&gt;The full game
list&lt;/a&gt; had a stray query
inside the games loop, for example.&lt;/p&gt;

&lt;p&gt;Using the &lt;code&gt;wikilog&lt;/code&gt; function here would sometimes screw up the page layout, so
I started using an adapted version that would capture all the debug messages
and print them at the end of the page:&lt;/p&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;nv&quot;&gt;$wikilog_messages&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;array&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;delayed_wikilog&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;global&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$wikilog_messages&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&amp;lt;div style=&#39;background-color: white&#39;&amp;gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;foreach&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$wikilog_messages&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$message&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&amp;lt;p&amp;gt;[&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$message&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;sql&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; sql][&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$message&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;time&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;] &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$message&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;message&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&amp;lt;/p&amp;gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&amp;lt;/div&amp;gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;wikilog_register&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$message&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;global&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$db_num_queries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;global&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$wikilog_messages&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$previous&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$previous_db_queries&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$previous&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$previous&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;hrtime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$previous_db_queries&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$previous_db_queries&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$db_num_queries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;$now&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;hrtime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;$delta&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$now&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$previous&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;$previous&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$now&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;nv&quot;&gt;$delta_queries&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$db_num_queries&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$previous_db_queries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;$previous_db_queries&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$db_num_queries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;nv&quot;&gt;$secs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;intdiv&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$delta&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1000000000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;$msecs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;intdiv&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$delta&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1000000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;nv&quot;&gt;$wikilog_messages&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;array&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;sql&#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$delta_queries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;time&#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$secs&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$msecs&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;ms&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;message&#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$message&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;My current task is optimizing the view_records.php page (which I’m not linking
to avoid encouraging people from visiting it until it’s fixed), and while it
doesn’t have many queries, it’s calling
&lt;a href=&quot;https://www.php.net/manual/en/function.get-headers.php&quot;&gt;get_headers&lt;/a&gt;, which
makes an HTTP request, once per record. Fixing this is probably going to be a
bit more involved.&lt;/p&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;I’m having fun. I haven’t touched a codebase using this style in a long time,
and there’s a lot of low hanging fruit.&lt;/p&gt;

&lt;p&gt;It’s impressive that the Cyberscore community has kept this platform going for
so many years, as a hobby project.&lt;/p&gt;

&lt;p&gt;I’m trying to keep a balance between optimizing things and keeping code
accessible. I’d like to eventually turn MySQL’s strict mode back on, and maybe
add a migration tool (someone recommended &lt;a href=&quot;https://phinx.org/&quot;&gt;Phinx&lt;/a&gt;) at least
to keep track of indexes.&lt;/p&gt;

&lt;p&gt;But before I do any of that, I want to spend some more time optimizing the
existing pages. Let’s see if I can get anything done before this year’s
&lt;a href=&quot;https://gamesdonequick.com/&quot;&gt;SGDQ&lt;/a&gt;.&lt;/p&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2020-08-01:/articles/status-update-2020-08.html</id>
    <title type="html">Status update, July 2020</title>
    <published>2020-08-01T00:00:00Z</published>
    <updated>2020-08-01T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/status-update-2020-08.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;Time for a new monthly update.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;aside&gt;
  &lt;p&gt;I am accepting sponsors via github: &lt;a href=&quot;https://github.com/sponsors/hugopeixoto&quot;&gt;https://github.com/sponsors/hugopeixoto&lt;/a&gt;&lt;/p&gt;

  &lt;p&gt;If you enjoy my work, consider sponsoring me so I can keep on doing this full
  time.&lt;/p&gt;
&lt;/aside&gt;

&lt;p&gt;Time for a new monthly update.&lt;/p&gt;

&lt;p&gt;After &lt;a href=&quot;/articles/portuguese-vps-providers.html&quot;&gt;some tribulations&lt;/a&gt;, I decided
on a local VPS provider for the Mentorados project. I used
&lt;a href=&quot;https://github.com/dokku/dokku/&quot;&gt;dokku&lt;/a&gt; to create a space where the rails
application could be easily deployed. I ended up diving into their codebase and
making a few contributions:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/progrium/viewdocs/pull/5://github.com/progrium/viewdocs/pull/57&quot;&gt;viewdocs: Add tests to the frontmatter support feature&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/dokku/dokku/pull/4055&quot;&gt;dokku: Delete dokkurc recursively during uninstall&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/dokku/dokku/pull/4057&quot;&gt;dokku: Install sudo when installing from source&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/dokku/dokku/pull/4058&quot;&gt;dokku: Ensure web installer creates files with correct permissions&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/dokku/dokku/pull/4062&quot;&gt;dokku: Rewrite upgrade instructions&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/dokku/dokku/issues/1558#issuecomment-659149054&quot;&gt;dokku: documenting behavior of VHOST and HOSTNAME&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I have a few more dokku related contributions in the works / pending review:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/progrium/viewdocs/pull/56&quot;&gt;viewdocs: Enable path based routing&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/dokku/dokku/pull/4080&quot;&gt;dokku: Stop using VHOST when listing app domains and urls&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/dokku/dokku/pull/4079&quot;&gt;dokku: Remove web installer&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I edited and published two episodes of the podcast &lt;a href=&quot;https://conversas.porto.codes&quot;&gt;Conversas em Código (portuguese)&lt;/a&gt;:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://conversas.porto.codes/episodes/aventuras-no-typescript&quot;&gt;Aventuras no TypeScript (portuguese)&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://conversas.porto.codes/episodes/enferrujados&quot;&gt;Enferrujados (portuguese)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I looked for free software self hosted alternatives to
&lt;a href=&quot;https://simplecast.fm&quot;&gt;simplecast.fm&lt;/a&gt;. Handling analytics seems to be the
biggest challenge. They work by tracking the audio file HTTP requests. There’s
a &lt;a href=&quot;https://www.iab.com/guidelines/podcast-measurement-guidelines/&quot;&gt;set of
guidelines&lt;/a&gt; by
the &lt;a href=&quot;https://en.wikipedia.org/wiki/Interactive_Advertising_Bureau&quot;&gt;Interactive Advertising
Bureau&lt;/a&gt;. This
might be relevant if we ever decide to take on sponsors.&lt;/p&gt;

&lt;p&gt;I didn’t migrate anything yet, but I did end up doing a couple of minor
contributions related to this:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/backtracks/open-podcast-analytics/pull/3&quot;&gt;open-podcast-analytics: Fix markdown typo&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://gitlab.com/ubuntu-pt/open-edu/-/issues/13&quot;&gt;adistancia.ansol.org: Add podcast publishing platforms (portuguese)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I went through my pending pull requests to try to push them forward. I rewrote
a rails PR from 2016:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/rails/rails/pull/39827&quot;&gt;rails: Add config.action_dispatch.cookies_default_options&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I’m not sure how or if I’ll get that merged.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/articles/2020-05-03.html&quot;&gt;Back in may&lt;/a&gt;, I started working on cleaning up my web server. I took inventory of what’s hosted there. Now, I started working on automating the nginx configurations and static website builds:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/hugopeixoto/static-websites&quot;&gt;https://github.com/hugopeixoto/static-websites&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;One of the websites I’m hosting is
&lt;a href=&quot;https://vasteroids.lifeonmars.pt&quot;&gt;vasteroids&lt;/a&gt;. I noticed that the build was
taking too long, so I decided to update its dependencies. This caused a
dependency vulnerability warning coming from &lt;code&gt;debug&lt;/code&gt;, which I traced to A-Frame
using an outdated fork. I updated the fork, let’s see if it gets traction:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/aframevr/aframe/issues/4612&quot;&gt;aframe: Security vulnerability in ‘debug’ dependency&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Back in 2016, &lt;a href=&quot;https://github.com/AGWA/git-crypt/pull/162&quot;&gt;I submitted a fix to
git-crypt&lt;/a&gt;. I got some feedback
this week, and I’m testing the new solution by the author.&lt;/p&gt;

&lt;p&gt;I spent some time working with &lt;a href=&quot;https://direitosdigitais.pt&quot;&gt;D3&lt;/a&gt; to find and
organize some information regarding contact tracing applications. I’m also
contributing to the &lt;a href=&quot;https://www.mydatadoneright.eu/&quot;&gt;My data done right&lt;/a&gt;
project, but there’s still not much to see.&lt;/p&gt;

&lt;p&gt;I migrated all of the &lt;a href=&quot;https://makeorbreak.io&quot;&gt;Make or Break&lt;/a&gt; websites to my
webserver. We have an API in elixir, so we were using a Digital Ocean droplet
to host everything. Since we don’t need the backend until we start accepting
registrations for the next edition, I saved some money by destroying the
droplet and using my own webserver to host the static websites.&lt;/p&gt;

&lt;p&gt;I’ve been working on the &lt;a href=&quot;https://www.cyberscore.me.uk/&quot;&gt;Cyberscore&lt;/a&gt; codebase,
trying to optimize some background processes. I’ve reduced the running time
from 10 minutes to 30 seconds, but ensuring that nothing’s broken is taking its
time.&lt;/p&gt;

&lt;p&gt;I had to do some admin work for &lt;a href=&quot;https://lifeonmars.pt&quot;&gt;Life on Mars&lt;/a&gt;. I’ve
resumed the use of &lt;a href=&quot;https://plaintextaccounting.org/&quot;&gt;plain text accounting&lt;/a&gt; to
keep track of things.&lt;/p&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2020-07-29:/articles/conversas-em-codigo-episode-28.html</id>
    <title type="html">Conversas em Código Episode #28 released</title>
    <published>2020-07-29T00:00:00Z</published>
    <updated>2020-07-29T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/conversas-em-codigo-episode-28.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;I’ve published a new episode of Conversas em Código - &lt;a href=&quot;https://conversas.porto.codes/episodes/enferrujados&quot;&gt;Episode 28: Enferrujados&lt;/a&gt;&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;p&gt;I’ve published a new episode of Conversas em Código (in portuguese):&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://conversas.porto.codes/episodes/enferrujados&quot;&gt;Episode 28: Enferrujados&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Projectos aleatórios em Rust? Temos muitos. Neste episódio falamos um bocado
de ferramentas que fizemos nesta linguagem que mal conhecemos.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;See the full episode list here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://conversas.porto.codes&quot;&gt;https://conversas.porto.codes&lt;/a&gt;&lt;/p&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2020-07-14:/articles/recompiling-firefox-to-change-some-keyboard-shortcuts.html</id>
    <title type="html">Recompiling firefox to change some keyboard shortcuts</title>
    <published>2020-07-14T00:00:00Z</published>
    <updated>2020-07-14T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/recompiling-firefox-to-change-some-keyboard-shortcuts.html"/>
    <summary type="html">
      <![CDATA[]]>
    </summary>
    <content type="html">

      &lt;p&gt;I’m trying to migrate from &lt;a href=&quot;https://www.chromium.org/&quot;&gt;Chromium&lt;/a&gt; to
&lt;a href=&quot;https://mozilla.org/firefox/new&quot;&gt;Firefox&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;One of the things that caught me by surprise is that the keyboard shortcuts to
select the n-th tab are different. In chromium, they’re &lt;code&gt;Ctrl+1&lt;/code&gt; through
&lt;code&gt;Ctrl+9&lt;/code&gt;, while in firefox they’re &lt;code&gt;Alt+1&lt;/code&gt; through &lt;code&gt;Alt+9&lt;/code&gt;. These shortcuts
conflict with the ones I’m using in &lt;a href=&quot;https://swaywm.org/&quot;&gt;sway&lt;/a&gt;, where they’re
used to navigate between workspaces.&lt;/p&gt;

&lt;p&gt;This is not fixable via a setting change, so I decided to build a custom
version of firefox. Since I’m using debian, this should be straightforward:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;sudo apt build-dep firefox    # install build dependencies
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;apt source firefox            # download source package
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;cd firefox-78.0.2/
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;make-necessary-changes-to-files
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;dpkg-source --commit          # create a patch file and changes version
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;dpkg-buildpackage -us -uc     # build the deb files
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I was having some trouble finding what changes to make, though, and firefox’s
codebase is not exactly small. &lt;a href=&quot;https://github.com/XAMPPRocky/tokei&quot;&gt;tokei&lt;/a&gt;
reports ~200k files and ~27M lines of code. &lt;code&gt;ack&lt;/code&gt;ing didn’t help much, so I
cloned the source repository to see if I could find something through the
commit messages. Firefox uses mercurial, but there’s an official git mirror:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Mozilla/Git&quot;&gt;https://developer.mozilla.org/en-US/docs/Mozilla/Git&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;The current official git mirror of the Firefox code base (also known as
“gecko” or “mozilla-central”) can be found at
&lt;a href=&quot;https://github.com/mozilla/gecko-dev&quot;&gt;https://github.com/mozilla/gecko-dev&lt;/a&gt;.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;After some tries, I found this:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;git log --grep &quot;Ctrl+9&quot;
&lt;/span&gt;commit 032ccdebf21b0e8493a28c4bee3ed759f87c5a40
Author: steffen.wilberg%web.de &amp;lt;steffen.wilberg%web.de&amp;gt;
Date:   Wed Jun 7 21:40:07 2006 +0000

    Bug 340553: Document that Ctrl+9 focuses last tab. p=zeniko@gmail.com, r=me

commit ce743abf4705fdbbf7695be3b929506f5563d183
Author: gavin%gavinsharp.com &amp;lt;gavin%gavinsharp.com&amp;gt;
Date:   Tue Jun 6 16:28:09 2006 +0000

    Bug 338348: Make Ctrl+9 select the last tab instead of the ninth tab, patch
    by Simon Bünzli &amp;lt;zeniko@gmail.com&amp;gt;, r=mconnor
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The second commit was a good starting point. The code had changed a lot since
that commit in 2006, but I was able to track it down by looking to the files
history with a combination of &lt;code&gt;git log -p &amp;lt;filename&amp;gt;&lt;/code&gt; and &lt;code&gt;git show &amp;lt;commit-sha&amp;gt;&lt;/code&gt;.
I ended up doing the following change:&lt;/p&gt;

&lt;div class=&quot;language-diff highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gd&quot;&gt;--- firefox-78.0.2.orig/browser/base/content/browser-sets.inc
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+++ firefox-78.0.2/browser/base/content/browser-sets.inc
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;@@ -315,11 +315,7 @@&lt;/span&gt;
     &amp;lt;key id=&quot;key_undoCloseTab&quot; command=&quot;History:UndoCloseTab&quot; data-l10n-id=&quot;tab-new-shortcut&quot; modifiers=&quot;accel,shift&quot;/&amp;gt;
     &amp;lt;key id=&quot;key_undoCloseWindow&quot; command=&quot;History:UndoCloseWindow&quot; data-l10n-id=&quot;window-new-shortcut&quot; modifiers=&quot;accel,shift&quot;/&amp;gt;

-#ifdef XP_GNOME
&lt;span class=&quot;gd&quot;&gt;-#define NUM_SELECT_TAB_MODIFIER alt
-#else
&lt;/span&gt; #define NUM_SELECT_TAB_MODIFIER accel
&lt;span class=&quot;gd&quot;&gt;-#endif
&lt;/span&gt;
 #expand    &amp;lt;key id=&quot;key_selectTab1&quot; oncommand=&quot;gBrowser.selectTabAtIndex(0, event);&quot; key=&quot;1&quot; modifiers=&quot;__NUM_SELECT_TAB_MODIFIER__&quot;/&amp;gt;
 #expand    &amp;lt;key id=&quot;key_selectTab2&quot; oncommand=&quot;gBrowser.selectTabAtIndex(1, event);&quot; key=&quot;2&quot; modifiers=&quot;__NUM_SELECT_TAB_MODIFIER__&quot;/&amp;gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;By removing the &lt;code&gt;ifdef&lt;/code&gt;, it now always uses &lt;code&gt;accel&lt;/code&gt;. It took roughly one hour
to compile and it generated a bunch of deb files:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;ls -1 *.deb
&lt;/span&gt;firefox-dbgsym_78.0.2-1.1_amd64.deb
firefox-l10n-ach_78.0.2-1.1_all.deb
firefox-l10n-af_78.0.2-1.1_all.deb
[...]
firefox-l10n-zh-cn_78.0.2-1.1_all.deb
firefox-l10n-zh-tw_78.0.2-1.1_all.deb
firefox_78.0.2-1.1_amd64.deb
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I installed the last one via &lt;code&gt;dpkg -i firefox_78.0.2-1.1_amd64.deb&lt;/code&gt;, restarted
firefox, and it works!&lt;/p&gt;

&lt;p&gt;Not sure how I’ll keep recompiling firefox every time there’s a new firefox
version. This doesn’t seem like something that would be accepted upstream. I
didn’t see any keyboard shortcuts on that file whose modifiers depend on a
configuration setting.&lt;/p&gt;

&lt;p&gt;It would probably have been easier to install &lt;a href=&quot;https://addons.mozilla.org/en-US/firefox/addon/ctrl-number-to-switch-tabs/&quot;&gt;an extension for
this&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Here are some firefox bug reports and commits related to this keyboard shortcut
that I found along the way:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;(2002) &lt;a href=&quot;https://github.com/mozilla/gecko-dev/commit/470789b11c912c021a9813c5f298e7129eac0f45&quot;&gt;Adding support for ALT+n to select the nth tab.&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;(2002) &lt;a href=&quot;https://github.com/mozilla/gecko-dev/commit/e770181c662ca0f9c0fec7820ac160938c4eb8a7&quot;&gt;make ctrl+num switch to tabs instead of alt+num&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;(2004) &lt;a href=&quot;https://bugzilla.mozilla.org/show_bug.cgi?id=256635&quot;&gt;[Linux] N-th tab shortcuts should use Alt-1 to Alt-9 rather than Ctrl-1 to Ctrl-9&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;(2006) &lt;a href=&quot;https://bugzilla.mozilla.org/show_bug.cgi?id=338348&quot;&gt;Ctrl+9 to select last tab instead of ninth tab, ala IE 7&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;(2007) &lt;a href=&quot;https://bugzilla.mozilla.org/show_bug.cgi?id=366084&quot;&gt;Numeric accesskeys still conflicting with tab switching&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2020-07-11:/articles/2020-07-11.html</id>
    <title type="html">Analysis paralysis, yak shaving, and all that</title>
    <published>2020-07-11T00:00:00Z</published>
    <updated>2020-07-11T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/2020-07-11.html"/>
    <summary type="html">
      <![CDATA[]]>
    </summary>
    <content type="html">
      <![CDATA[
        <aside>
          This is a <code>[journal]</code> entry. It is longer than usual and
          more exploratory. It may have no proper conclusion.
        </aside>
      ]]>

      &lt;p&gt;I’m working on deploying
&lt;a href=&quot;https://mentor.alumniei.pt&quot;&gt;https://mentor.alumniei.pt&lt;/a&gt;, and I &lt;a href=&quot;/articles/portuguese-vps-providers.html&quot;&gt;decided to
host it on a national VPS&lt;/a&gt;. It took me
around a month from deciding to look for portuguese providers to actually
pressing the “buy” button.&lt;/p&gt;

&lt;p&gt;Now that I have access to the VPS, I need to configure it to host a rails
application. I knew that I didn’t want to configure a systemd service manually.
I knew I wanted something docker based. I had heard of
&lt;a href=&quot;http://dokku.viewdocs.io/dokku/&quot;&gt;dokku&lt;/a&gt;, so I decided to give it a go. It was
easy enough to get it working, with the postgresql and letsencrypt plugins.&lt;/p&gt;

&lt;p&gt;But during the installation process, I ran into a small issue: running &lt;code&gt;dokku
domains:set-global&lt;/code&gt; would yield “permission denied” accessing an arbitrary
file. The file was root owned, instead of dokku owned. a &lt;code&gt;chown&lt;/code&gt; solved the
problem and I moved on. But now I have this thing in my brain constantly
nagging me, telling me I should make a fresh installation in another server to
see if I can reproduce the problem, find the bug and fix it. I didn’t do this
yet, since I’m trying to focus on actually delivering the project, but I wasn’t
completely successful at preventing myself from being distracted by this&lt;/p&gt;

&lt;p&gt;A couple of days ago, I noticed that their documentation,
&lt;a href=&quot;http://dokku.viewdocs.io/dokku&quot;&gt;dokku.viewdocs.io/dokku&lt;/a&gt;, is not served via
HTTPS. I never heard of viewdocs before, so I decided to investigate. I found a
&lt;a href=&quot;https://github.com/progrium/viewdocs/issues/54&quot;&gt;recent issue mentioning the lack of
SSL&lt;/a&gt;. It seems like they’re
hosting viewdocs on heroku, and since the project uses subdomains, it would
require a wildcard SSL certificate. I searched a bit and found that this isn’t
supported by heroku, reported it in the issue, and the issue was closed.&lt;/p&gt;

&lt;p&gt;While I could have left it at that, it was still bothering me. So while I was
drafting this article, I came up with an alternative solution and &lt;a href=&quot;https://github.com/progrium/viewdocs/issues/55&quot;&gt;suggested it
in a new issue&lt;/a&gt;. This was
prompted by the fact that I used
&lt;a href=&quot;https://github.com/gjtorikian/html-proofer&quot;&gt;&lt;code&gt;html-proofer&lt;/code&gt;&lt;/a&gt; to ensure that
every link still works and uses https, so now every time that I paste a link
onto an blog post article my brain automatically runs &lt;code&gt;html-proofer&lt;/code&gt;. I don’t
even have it set up on CI or anything. I just have the gem installed.&lt;/p&gt;

&lt;p&gt;I’m not sure if viewdocs will ever add SSL support, but now every time that I
check dokku’s documentation this will be in the background, nagging me.&lt;/p&gt;

&lt;p&gt;Back to the application deployment process. To get something running, I had to
install the &lt;a href=&quot;https://github.com/dokku/dokku-postgres&quot;&gt;postgresql plugin&lt;/a&gt;.
Setting up SSL was easy enough with the &lt;a href=&quot;https://github.com/dokku/dokku-letsencrypt&quot;&gt;letsencrypt
plugin&lt;/a&gt;. But that’s not all that
the application needs. It needs to send email (for registration confirmation,
invitations, and password recovery) and it needs a storage solution for profile
pictures.&lt;/p&gt;

&lt;p&gt;To handle file storage I could easily use an S3 bucket, since &lt;a href=&quot;https://edgeguides.rubyonrails.org/active_storage_overview.html#s3-service-amazon-s3-and-s3-compatible-apis&quot;&gt;activestorage
supports
it&lt;/a&gt;.
But I am going through the trouble of finding a national VPS, doesn’t using S3
kind of defeat the purpose? I have more than enough disk space for a handful of
profile pictures, and students are probably located in Portugal, so I don’t
need any CDNs. I thought about setting up a volume for persistent storage, but
it would be a manual process, and I wanted a solution that I could use in other
self-hosted projects without much hassle. I remembered that
&lt;a href=&quot;https://min.io/&quot;&gt;min.io&lt;/a&gt; is a thing, but there’s no dokku plugin. So I started
digging through dokku’s documentation on how to create a plugin.&lt;/p&gt;

&lt;p&gt;I noticed that postgres and redis both use a concept named “services”,
represented by ~160 lines of almost identical code in their &lt;code&gt;functions&lt;/code&gt; file. I
started thinking about how I could extract this into a dokku concept, and went
through their issues to see if I could find something like that. I found
nothing. implementing min.io as a dokku plugin is probably going to be messy,
because it would also need its own domain and a letsencrypt certificate, and it
would just be a mess. I still haven’t decided how I’m going to tackle this, but
it’s probably going to be with a volume.&lt;/p&gt;

&lt;p&gt;On the email side, my immediate reaction was that I couldn’t possibly self-host
email. Everyone knows that’s impossible. &lt;a href=&quot;https://www.youtube.com/watch?v=ta1vNlEgg7Q&quot;&gt;Porto codes even hosted a
presentation about it&lt;/a&gt;. SES is
easy enough to configure. But it requires AWS credentials, do I really want to
put personal AWS credentials on this server, and deal with their JSON policies?
This friction was enough to get me to entertain the idea of self-hosting. I
requested (and was granted) a PTR record on the VPS’s IP address. I started
looking for &lt;code&gt;postfix&lt;/code&gt; docker images, and if I could architect this as a dokku
plugin as well. Would I be able to run a single postfix instance that would
serve every dokku app? How does postfix handle multiple domains, how can I
restrict them to certain users? Should I start with another domain, to avoid
tainting the alumniei.pt domain?&lt;/p&gt;

&lt;p&gt;Meanwhile, there’s another project I was thinking of moving here: &lt;a href=&quot;https://makeorbreak.io&quot;&gt;Make or
Break&lt;/a&gt;. It has an elixir backend and a react frontend.
A few months ago I &lt;a href=&quot;/articles/2020-05-21.html&quot;&gt;started writing a Dockerfile for the
backend&lt;/a&gt;, but never got around to finish it.
Recently, we decided to shut down the backend for a while, since we won’t be
holding another event soon, and we want to save some money by shutting down the
servers. This would mean moving half a dozen static websites somewhere else. I
offered to host them in one of my servers.&lt;/p&gt;

&lt;p&gt;This got me thinking if there’s a self hosted netlify solution as well that
could co-exist with dokku in this server. I could use dokku with the &lt;a href=&quot;https://github.com/dokku/buildpack-nginx&quot;&gt;nginx
buildpack&lt;/a&gt;, but compiling and running
an nginx container per static website feels wasteful. I spent some time
searching, but no luck. I don’t even have a good idea of what a good
alternative would be. I have a bunch of &lt;a href=&quot;/articles/2020-05-03.html&quot;&gt;static websites deployed on
hugopeixoto.net&lt;/a&gt;, but they’re all configured
manually. Every time I want to add a new one, I have to &lt;code&gt;mkdir
/srv/web/domainname&lt;/code&gt;, run &lt;code&gt;letsencrypt certonly --webroot yadda yadda&lt;/code&gt;, ignore
the fact that this OS is so old that it still uses &lt;code&gt;letsencrypt&lt;/code&gt; instead of
&lt;code&gt;certbot&lt;/code&gt;, copy and edit something to &lt;code&gt;/etc/nginx/sites-available/domainname&lt;/code&gt;,
symlink it to &lt;code&gt;sites-enabled&lt;/code&gt;, and &lt;code&gt;service reload nginx&lt;/code&gt;. Maybe I’ll write a
&lt;code&gt;create-website&lt;/code&gt; bash script that handles most of this for me and suppress the
stressful feeling that I’m moving more websites onto a half assed setup.&lt;/p&gt;

&lt;p&gt;Dokku’s documentation states, somewhere, that it might not play well with other
software that manages docker images. This could compromise my plans of having a
netlify-like thing running, and even of having a postfix image running. Is
dokku designed to work with non-web applications? How does dokku work? I didn’t
search for long, but I couldn’t find an architecture diagram or something that
explains what’s happening in the background. I expect that they have an nginx
container that serves as a reverse proxy for installed apps. I know that
plugins like postgres work via docker as well. Maybe I could help them with
some documentation contributions.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://dokku.viewdocs.io/dokku/deployment/application-deployment/&quot;&gt;One of dokku’s getting started
pages&lt;/a&gt;
mentions something in Vagrantfile. This note confused me for a bit. Does dokku
use Vagrant under the hood? I didn’t change any Vagrantfiles, am I doing it
wrong? Maybe by changing the way it is phrased, this confusion could be
prevented. So now I have this task on the back of my head as well.&lt;/p&gt;

&lt;p&gt;I also have this &lt;a href=&quot;https://github.com/veekun/pokedex&quot;&gt;pokedex project&lt;/a&gt; tab open.
My alpha sapphire save is in japanese, and I wanted to easily check what the
english name of a move is, given its japanese name. First, I started crawling
bulbapedia. Then I found this project, and started writing a command to list
the learnset of a pokemon in a given game edition.&lt;/p&gt;

&lt;p&gt;Then I noticed the readme (&lt;code&gt;The project is not dead, but it is languishing&lt;/code&gt;)
and the number of issues (115). There isn’t any Let’s go Pikachu and Eevee data
yet. It’s also missing Sword and Shield. So I tried to understand what’s their
favorite source of data, and it’s game dumps with manual fixes. So now I’m
looking at how to extract data from pokemon games, and also thinking of how to
handle changelogs, things that change from one generation to another. I joined
their IRC channel and offered my help for any low hanging fruit tasks.&lt;/p&gt;

&lt;p&gt;I think I can detect these rabbit holes, but it’s not easy to get out of them.
When it’s just one thing or two, it doesn’t bother me as much, but when every
task unfolds into an attention grabbing black hole, I can’t get much done. It
doesn’t help that every task that I try to tackle reminds me of another
underlying problem that’s still not solved.&lt;/p&gt;

&lt;p&gt;I’m not very good at note taking and organizing my time. Maybe this is what
todo lists are for. This post was an attempt at getting all of these items out
of my system, to see if I can focus on finishing something.&lt;/p&gt;

&lt;p&gt;I’ll try to focus on getting &lt;a href=&quot;https://mentor.alumniei.pt&quot;&gt;mentor.alumniei.pt&lt;/a&gt;
out of the door, even it if requires using SES during the first months. Moving
the Make or Break websites is not a priority, we can pay for the servers for
another month if necessary.&lt;/p&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2020-07-08:/articles/portuguese-vps-providers.html</id>
    <title type="html">An encounter with portuguese VPS providers</title>
    <published>2020-07-08T00:00:00Z</published>
    <updated>2020-07-08T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/portuguese-vps-providers.html"/>
    <summary type="html">
      <![CDATA[]]>
    </summary>
    <content type="html">

      &lt;p&gt;I’m working on a few portuguese projects
(&lt;a href=&quot;http://mentor.alumniei.pt/&quot;&gt;Mentorados&lt;/a&gt;, &lt;a href=&quot;https://makeorbreak.io/&quot;&gt;Make or
Break&lt;/a&gt;, &lt;a href=&quot;https://porto.codes&quot;&gt;Porto Codes&lt;/a&gt;, &lt;a href=&quot;https://conversas.porto.codes/&quot;&gt;Conversas
em Código&lt;/a&gt;). Most of these require some sort of
web hosting.&lt;/p&gt;

&lt;p&gt;I wondered if I could find a portuguese VPS provider to host all of these. This
way, data would be kept in national datacenters. Also, I kind of wanted to see
what national offers exist. I asked around and decided to try
&lt;a href=&quot;dominios.pt&quot;&gt;dominios.pt&lt;/a&gt; and &lt;a href=&quot;ptisp.pt&quot;&gt;PTisp&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I initially wanted to go with PTisp, but they are kind of expensive: 4GB
ram/2vCPU/100GB disk for €28/month. dominios.pt was half the price for similar
specs: 4GB ram/2vCPU/40GB disk for €12/month. Contrast with Digital Ocean: 4GB
ram/2vCPU/80GB disk for ~€18.&lt;/p&gt;

&lt;p&gt;This turned out to be a weirder day than I was expecting.&lt;/p&gt;

&lt;h2 id=&quot;dominiospt&quot;&gt;dominios.pt&lt;/h2&gt;

&lt;p&gt;When ordering from dominios.pt, I got to pick an operating system. CentOS was
the default option, but I changed to Debian 10 buster. I also had to specify
the hostname.&lt;/p&gt;

&lt;p&gt;Mainstream providers like Digital Ocean or AWS usually take a couple of minutes
to get your instance running. After 10 minutes, the service status was still
showing as “pending”. Taking this long, I started assuming that the
provisioning would be done manually, and might not be ready for a couple of
hours.&lt;/p&gt;

&lt;p&gt;After an hour or so, I returned to the dashboard and noticed that it had
changed to “active”, but I hadn’t received any emails yet with login
credentials. The dashboard listed the instance as running, but it showed the
attribute “CD/DVD Disc Image File” as “CentOS 7 X86 64 Minimal 1611” (instead
of debian).&lt;/p&gt;

&lt;p&gt;There was also a &lt;a href=&quot;https://github.com/novnc/noVNC&quot;&gt;web console thing&lt;/a&gt; to connect
to the instance. I tried it, and was greeted with CentOS install screen. I
changed the disk image to “Debian 10 buster” and restarted the system. Debian’s
install screen showed up.&lt;/p&gt;

&lt;p&gt;At this point I wondered why they’d bother to ask for an operating system and a
hostname if they were going to hand me a clean VPS. I understand that some
folks might want to install things manually, but handing users an empty VM with
no instructions isn’t the best experience.&lt;/p&gt;

&lt;p&gt;Most of the steps in debian installation were straightforward, but it was
unable to automatically configure the network via DHCP. I had to set it up
manually. The IP, mask, and gateway were available in the dashboard, so this
was easy to find. They didn’t mention any DNS servers, though. I accepted the
default value and continued the installation. Why would they leave the OS
installation to the user and not even have DHCP configured? This was all weird.&lt;/p&gt;

&lt;p&gt;Turns out that the DNS setting didn’t work. When trying to connect to an apt
mirror, it failed. I assumed it was because the DNS server didn’t exist, so I
went back and changed it to google’s DNS to see if it worked.&lt;/p&gt;

&lt;p&gt;When I got back to the apt mirror step, the VM restarted. Thinking that I may
have accidentally rebooted it, I went through the process again. Setting up
passwords, partitions, network, etc. Then, it rebooted again. I started
suspecting that something was going on. I connected to the VNC again and
waited. That’s when someone else started going through the installation
process!&lt;/p&gt;

&lt;p&gt;I saw them setting up the network manually (and using google’s DNS resolver),
setting up partitions manually, setting the hostname, setting the root password
to something kind of short (8 characters?), creating a non root user, and
installing ssh. They also decided to install a graphical environment and a
print server.&lt;/p&gt;

&lt;p&gt;A few minutes after finishing the installation, I got an email from them saying
that my server was ready. It included the server’s IP address and the
credentials for the non-root account. They didn’t send the root password,
though.&lt;/p&gt;

&lt;p&gt;I kind of expected that the initial provisioning of the VPS would be manual,
but I didn’t expect them to set up the OS manually. Why don’t they use a preset
image? Wouldn’t it be faster for everyone?&lt;/p&gt;

&lt;p&gt;I’m aware that &lt;a href=&quot;https://fsfe.org/activities/nocloud/nocloud.en.html&quot;&gt;the cloud is someone else’s
computer&lt;/a&gt;, but watching
someone else connecting via VNC and setting it up for you kind of puts that
right in your face. This completely undermines any trust I had in them to hold
my data. I’m not planning on keeping this server.&lt;/p&gt;

&lt;h2 id=&quot;ptisp&quot;&gt;PTisp&lt;/h2&gt;

&lt;p&gt;After the dominios.pt madness, I decided to try PTisp, even with pricing in
mind. They also asked me for the operating system and hostname. It defaulted to
CentOS, but I changed it to Debian.&lt;/p&gt;

&lt;p&gt;Right after payment, I got an email with access information. It seems that
PTisp doesn’t set things up manually. The email didn’t look right, though. It
contained the following:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;Interface Internet - eth0: 
=============================
IP/Host:
Endereços IP Secundários:  
Hostname: [REDACTED]

SSH v2:
=============================
IP/Host:
Login: hugo.peixoto@gmail.com
Password: [REDACTED]
Porta: 22
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note the lack of IP/Host in the first two sections. Also, what’s up with the
ssh login being my email address?&lt;/p&gt;

&lt;p&gt;I got the IP address from their dashboard and tried connecting via SSH. Using
the provided username didn’t work, which was not very surprising. Changing the
username to &lt;code&gt;root&lt;/code&gt; worked, though. There were some hiccups, but it seemed way
better than the experience with dominios.pt.&lt;/p&gt;

&lt;p&gt;I connected via ssh, and tried updating the package repository:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;[root@hostname ~]# &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;apt update
&lt;/span&gt;-bash: apt: command not found
&lt;span class=&quot;gp&quot;&gt;[root@hostname ~]# &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;apt-get update
&lt;/span&gt;-bash: apt-get: command not found
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is weird, why isn’t &lt;code&gt;apt&lt;/code&gt; installed?&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;[root@hostname ~]# &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;cat /etc/centos-release
&lt;/span&gt;CentOS Linux release 7.8.2003 (Core)
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;They installed CentOS.&lt;/p&gt;

&lt;p&gt;Their dashboard allows me to reinstall the operating system, so I installed
Debian 10. After logging in, I tried to update the package repository, and was
noticed something weird:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@hostname:~# &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;apt update
&lt;/span&gt;Hit:1 http://security.debian.org/debian-security buster/updates InRelease
Hit:2 http://mirror.yandex.ru/debian buster InRelease
Reading package lists... Done
Building dependency tree
Reading state information... Done
79 packages can be upgraded. Run &#39;apt list --upgradable&#39; to see them.

&lt;span class=&quot;gp&quot;&gt;root@hostname:~# &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;cat /etc/apt/sources.list
&lt;/span&gt;deb http://mirror.yandex.ru/debian buster main contrib
deb-src http://mirror.yandex.ru/debian buster main contrib

deb http://security.debian.org/debian-security buster/updates main contrib
deb-src http://security.debian.org/debian-security buster/updates main contrib
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Why would they use &lt;code&gt;mirror.yandex.ru&lt;/code&gt;? It’s not listed on the &lt;a href=&quot;https://www.debian.org/mirror/list&quot;&gt;authoritative
list of debian mirrors&lt;/a&gt;, and this list
contains a &lt;a href=&quot;http://mirrors.ptisp.pt/debian/&quot;&gt;portuguese mirror hosted by
PTisp&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;After a chat with their support team, they told me that the images they use
come bundled with the panel software. They’re using &lt;a href=&quot;https://www.ispsystem.com/software/vmmanager&quot;&gt;VMmanager from
ISPsystem&lt;/a&gt;. ISPsystem is based in
Russia, which explains their mirror choice. PTisp lets me mount an iso image,
so I could install debian from scratch if I wanted, so I guess this is fine?&lt;/p&gt;

&lt;h2 id=&quot;conclusions&quot;&gt;Conclusions&lt;/h2&gt;

&lt;p&gt;I’m not planning on keeping the dominios.pt server. Their system doesn’t feel
very mature.&lt;/p&gt;

&lt;p&gt;I may keep the PTisp server. They have prebuilt images, and don’t require
manual intervention. I reported the issues I found and got an answer within a
few minutes.&lt;/p&gt;

&lt;p&gt;Reading about ISPsystem left me wondering if there’s any portuguese provider
that relies purely on free software. I’ll have to look it up.&lt;/p&gt;

&lt;p&gt;The next thing I want to do is install &lt;a href=&quot;https://github.com/dokku/dokku&quot;&gt;dokku&lt;/a&gt;
and see if I can deploy some web apps.&lt;/p&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2020-07-01:/articles/status-update-2020-07.html</id>
    <title type="html">Status update, June 2020</title>
    <published>2020-07-01T00:00:00Z</published>
    <updated>2020-07-01T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/status-update-2020-07.html"/>
    <summary type="html">
      <![CDATA[]]>
    </summary>
    <content type="html">

      &lt;p&gt;It’s now been one month since I &lt;a href=&quot;/articles/next-steps.html&quot;&gt;left my job&lt;/a&gt;. I
decided to start doing status updates, at least once a month.&lt;/p&gt;

&lt;p&gt;I brought my personal email inbox down to zero. While at it, &lt;a href=&quot;/articles/backing-up-gmail-with-rust.html&quot;&gt;I wrote a rust
cli tool to back up all of the messages I
received&lt;/a&gt;. The next step is to add
an incremental backup option. I played around with email parsing to get some
statistics out of it. I would like to get this to a state where I could have it
running in a cron job.&lt;/p&gt;

&lt;p&gt;On the topic of email, I created a trial account with &lt;a href=&quot;https://hey.com/&quot;&gt;Hey&lt;/a&gt;,
an email provider and client. I don’t think it’s for me, since they don’t
support custom domains and don’t expose emails via IMAP, forcing me into using
their proprietary client. I found &lt;a href=&quot;https://drewdevault.com/2020/06/19/Mail-service-provider-recommendations.html&quot;&gt;email service provider recommendations by
Drew
DeVault&lt;/a&gt;
that might be useful when picking an alternative to gmail.&lt;/p&gt;

&lt;p&gt;I started using &lt;a href=&quot;https://theoldreader.com&quot;&gt;The Old Reader&lt;/a&gt; again. Most of my
old subscriptions are either gone or not receiving updates. I added a few
personal blogs, some webcomics, and &lt;a href=&quot;https://rubyflow.com&quot;&gt;RubyFlow&lt;/a&gt;. I
subscribe to &lt;a href=&quot;https://news.ycombinator.com/&quot;&gt;Hacker News&lt;/a&gt;, which turned out not
to be great. There are more than 100 entries per day, and I skim through them,
reading only a dozen or so per day. I’ll start tagging the articles I open to
see if there’s a pattern. I may replace it with &lt;a href=&quot;https://lobste.rs&quot;&gt;lobste.rs&lt;/a&gt;,
and &lt;a href=&quot;https://tilde.news/&quot;&gt;tilde.news&lt;/a&gt; which have considerably less traffic.&lt;/p&gt;

&lt;p&gt;I have been collecting some resources on self hosting a RSS reader. One feature
I think I’d appreciate is to remove duplicates (so I could subscribe to
multiple from aggregators), and be able to transform some feeds (so I could
preload some webcomics). I’d also like to publish a feed of favorited articles.&lt;/p&gt;

&lt;p&gt;I am &lt;a href=&quot;/articles/rewriting-a-small-rails-and-react-application.html&quot;&gt;rewriting the web platform that runs my college’s alumni mentorship
program&lt;/a&gt;. The
previous version was powered by a rails API and a react frontend, and I’m
rewriting it into a rails only application. I am looking for portuguese hosting
solutions, and expect to have this live by early next week.&lt;/p&gt;

&lt;p&gt;I have two episodes of &lt;a href=&quot;https://conversas.porto.codes&quot;&gt;Conversas em Código&lt;/a&gt; in
the pipeline. One of them is practically done and I intend to publish it this
week.&lt;/p&gt;

&lt;p&gt;To edit the episode, I rewrote the &lt;a href=&quot;https://github.com/hugopeixoto/wedit&quot;&gt;command line audio editing
tool&lt;/a&gt; I built a few years ago. I want to
write about how the new version of the tool works. It’s written in C, but I am
thinking about porting it to rust. This tool is mainly an excuse for me to
learn about audio. I want to implement a frequency filter, so the next step
there is to learn how to convert the PCM stream from time domain to frequency
domain.&lt;/p&gt;

&lt;p&gt;Lua 5.4 was released, so &lt;a href=&quot;https://github.com/whitequark/rlua&quot;&gt;RLua&lt;/a&gt; needs to be
updated. &lt;a href=&quot;https://github.com/whitequark/rlua/pull/10&quot;&gt;I accidentally started this task last
year&lt;/a&gt;, unaware that I was using a
beta version. I can finish this now.&lt;/p&gt;

&lt;p&gt;That’s all for June. Let’s see how July goes.&lt;/p&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2020-06-16:/articles/rewriting-a-small-rails-and-react-application.html</id>
    <title type="html">Rewriting a small rails &amp; react application</title>
    <published>2020-06-16T00:00:00Z</published>
    <updated>2020-06-16T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/rewriting-a-small-rails-and-react-application.html"/>
    <summary type="html">
      <![CDATA[]]>
    </summary>
    <content type="html">

      &lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;

&lt;p&gt;In 2017, Life on Mars helped build &lt;a href=&quot;http://mentor.alumniei.pt/&quot;&gt;http://mentor.alumniei.pt/&lt;/a&gt;. It’s a portal
where college students can contact alumni (mentors) when they’re facing career,
academic, or personal issues. We built the platform, contacted some alumni
members, but never got around to publish it. There’s some talk of reviving the
project, so I decided to spend some time refreshing the code base and improving
things that, in retrospective, are off.&lt;/p&gt;

&lt;p&gt;Here are some of the things that I think we should fix, even before logging in
to the platform or checking out the code:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;The website in english. We have translations set up, but they’re not
deployed. We have some static-ish content, like preset tag names, in database
tables, and those are not translatable.&lt;/li&gt;
  &lt;li&gt;The color scheme was not picked with accessibility in mind. The contrast on
some of the text is very low. We should do some accessibility studies.&lt;/li&gt;
  &lt;li&gt;We don’t have &lt;code&gt;https&lt;/code&gt;. I’m not even sure how this happened. We should enable
it.&lt;/li&gt;
  &lt;li&gt;We didn’t plan for any abuse or moderation. Mentor/student communication
happens outside the platform, so on one hand this increases their privacy but
also exposes both parties. Mentors have their information available for
anyone with a &lt;code&gt;@fe.up.pt&lt;/code&gt; email address, which may be used for stalking or
other bad behavior. We should review this with these misuse cases in mind.&lt;/li&gt;
  &lt;li&gt;There’s no privacy policy. Similar to the point above.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;On the code side of things, the project has two components: a &lt;a href=&quot;https://github.com/lifeonmarspt/mentorados-backend&quot;&gt;rails api only
backend&lt;/a&gt; and a &lt;a href=&quot;https://github.com/lifeonmarspt/mentorados-frontend&quot;&gt;react
frontend&lt;/a&gt;. These are both
deployed to Heroku as separate apps. Since we’re currently serving this from
free apps, the cold start time isn’t the best.&lt;/p&gt;

&lt;p&gt;The project is not very big. You can log in as either a student or an mentor.
Mentors can edit their profile, and students can view and filter mentors.
There’s no communication inside the website itself. Mentors specify their
preferred communication methods. There are some admin use cases as well.&lt;/p&gt;

&lt;p&gt;Across both projects, this has 1200 lines of ruby, 3000 lines of jsx and 500
lines of scss.&lt;/p&gt;

&lt;p&gt;I’m usually on board with this backend/frontend split, but in a single-ish
person team, with a project this small, I will be better served by a rails
monolith. I’m also not a big fan of requiring javascript to use the platform.&lt;/p&gt;

&lt;p&gt;Before I do any of the improvements I mentioned, I’ll start by putting this all
in a single codebase, without any javascript.&lt;/p&gt;

&lt;p&gt;In this post, I will set up a rails application from scratch, with my personal
flavor of gems and modifications. Then I’ll go through the process of adding
the registration flow.&lt;/p&gt;

&lt;h2 id=&quot;setting-up-a-new-rails-project&quot;&gt;Setting up a new rails project&lt;/h2&gt;

&lt;p&gt;I’ll be using ruby 2.7.0 in this project. I’m not sure if this is going to
work. I had some issues with rails spewing out a bunch of warnings before, but
maybe it’s already fixed. I manage my ruby installations with
&lt;a href=&quot;https://asdf-vm.com/&quot;&gt;asdf&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Usually, you’re told to install rails globally so that you can run &lt;code&gt;rails new&lt;/code&gt;.
I avoid that by creating an initial Gemfile with just the following:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;n&quot;&gt;source&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;https://rubygems.org&quot;&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;gem&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;rails&quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Rails has recently added a &lt;code&gt;rails new --minimal&lt;/code&gt; option to disable things like
&lt;code&gt;spring&lt;/code&gt;, &lt;code&gt;actiontext&lt;/code&gt;, and other gems. This feature is not released yet, so I
created an app with a lot of options to disable things I don’t like or use.&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;bundle exec rails new \
  --skip-action-cable \
  --skip-action-mailbox \
  --skip-spring \
  --skip-turbolinks \
  --skip-webpack-install \
  --database=postgresql \
  .
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I’m removing &lt;code&gt;spring&lt;/code&gt; because I don’t trust it. Bootsnap seems to work fine,
though. &lt;code&gt;ActionMailbox&lt;/code&gt; handles incoming email messages, which I won’t need
here. &lt;code&gt;ActionCable&lt;/code&gt; won’t be needed either. I’m going with a no javascript
approach at first, so I’m also skipping turbolinks and webpack.&lt;/p&gt;

&lt;p&gt;Running this will cause rails to ask to overwrite &lt;code&gt;Gemfile&lt;/code&gt;, which is something
I want. This is enough to get the app started, but I do some changes to the
Gemfile before moving on.&lt;/p&gt;

&lt;p&gt;I remove gems I don’t need. In this case, I removed &lt;code&gt;webpacker&lt;/code&gt;, &lt;code&gt;jbuilder&lt;/code&gt;,
and &lt;code&gt;webdriver&lt;/code&gt; related gems.&lt;/p&gt;

&lt;p&gt;I remove most comments. They don’t serve me any purpose after an initial scan.&lt;/p&gt;

&lt;p&gt;I remove version restrictions for most gems. I rely on dependabot to create PRs
for the upgrades instead of doing them manually, and I want to keep up with
major version releases.&lt;/p&gt;

&lt;p&gt;I sort gems in each group alphabetically. It makes the decision of where to put
new gems easy. Also, rubocop-rails enforces this by default.&lt;/p&gt;

&lt;p&gt;The next step is adding some gems that I know I will use. Here’s a list:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/bkeepers/dotenv&quot;&gt;&lt;code&gt;dotenv-rails&lt;/code&gt;&lt;/a&gt;, to load &lt;code&gt;.env&lt;/code&gt; files
onto &lt;code&gt;ENV&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/thoughtbot/factory_bot_rails&quot;&gt;&lt;code&gt;factory_bot_rails&lt;/code&gt;&lt;/a&gt;, to
replace fixtures in rails tests&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/faker-ruby/faker&quot;&gt;&lt;code&gt;faker&lt;/code&gt;&lt;/a&gt;, to generate fake data, mostly
in tests&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/varvet/pundit&quot;&gt;&lt;code&gt;pundit&lt;/code&gt;&lt;/a&gt;, to build the authorization system&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/rubocop-hq/rubocop&quot;&gt;&lt;code&gt;rubocop&lt;/code&gt;&lt;/a&gt;, a ruby linter&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/rubocop-hq/rubocop-rails&quot;&gt;&lt;code&gt;rubocop-rails&lt;/code&gt;&lt;/a&gt;, rails
specific rules&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/rubocop-hq/rubocop-rails&quot;&gt;&lt;code&gt;rubocop-performance&lt;/code&gt;&lt;/a&gt;,
performance specific rules&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Most of these gems are useful in development or test environments. &lt;code&gt;pundit&lt;/code&gt; is
the only one that will run in production. I probably will need some extra gems
as I add more code, but I’ll figure those out along the way.&lt;/p&gt;

&lt;p&gt;Before continuing, I need to tweak &lt;code&gt;.rubocop.yml&lt;/code&gt; and fix &lt;code&gt;rubocop&lt;/code&gt; warnings.
Rails does not generate a rubocop compatible project, so there’s some work to do.
This is what my &lt;code&gt;.rubocop.yml&lt;/code&gt; looks like:&lt;/p&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;c1&quot;&gt;# I need to enable the extra plugins&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;rubocop-performance&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;rubocop-rails&lt;/span&gt;

&lt;span class=&quot;na&quot;&gt;AllCops&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# I&#39;m excluding rails generated files to make&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# rails version upgrades easier.&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;Exclude&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;db/**/*&quot;&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;bin/*&quot;&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;config.ru&quot;&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;config/**/*&quot;&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;Rakefile&quot;&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;vendor/**/*&quot;&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# New cops that show up in new rubocop versions&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# should be enabled by default to avoid polutting&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# this config file.&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;NewCops&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;enable&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# I have become a trailing comma person&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;Style/TrailingCommaInArrayLiteral&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;EnforcedStyleForMultiline&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;comma&lt;/span&gt;

&lt;span class=&quot;s&quot;&gt;Style/TrailingCommaInHashLiteral&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;EnforcedStyleForMultiline&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;comma&lt;/span&gt;

&lt;span class=&quot;s&quot;&gt;Style/TrailingCommaInArguments&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;EnforcedStyleForMultiline&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;comma&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# I don&#39;t want to be forced to write documentation for every class/module&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;Style/Documentation&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;Enabled&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;false&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The next step is to configure a database. I already have dotenv installed, so I
need to:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;add &lt;code&gt;DATABASE_URL=postgres://localhost/mentorados_development&lt;/code&gt; to &lt;code&gt;.env.development.local&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;add &lt;code&gt;DATABASE_URL=postgres://localhost/mentorados_test&lt;/code&gt; to &lt;code&gt;.env.test.local&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;run &lt;code&gt;git rm config/database.yml&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;add &lt;code&gt;/.env*.local&lt;/code&gt; to &lt;code&gt;.gitignore&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;run &lt;code&gt;bin/rails db:create&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;run &lt;code&gt;RAILS_ENV=test bin/rails db:create&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Another thing that I also need to configure is the application timezone. This
application is aimed at a portuguese university, but I like having everything
in UTC and dealing with conversion at display time, if needed. I’ll add this
initializer:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;c1&quot;&gt;# config/initializers/timezone.rb&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;Rails&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;application&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;time_zone&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;UTC&#39;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;Rails&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;application&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;active_record&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;default_timezone&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:utc&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Running rails with &lt;code&gt;bundle exec rails server&lt;/code&gt; now displays the “Yay! You’re on
Rails!” page. I’m ready to start adding functionality.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/articles/yay-rails.png&quot; alt=&quot;Rails default index page, showing Rails and Ruby versions&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;adding-user-registration---database&quot;&gt;Adding user registration - Database&lt;/h2&gt;

&lt;p&gt;Before starting to create tables, I need to enable the &lt;code&gt;uuid&lt;/code&gt; extension and use
it as the default primary key type:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;c1&quot;&gt;# db/migrate/20200608144955_enable_extension_uuid.rb&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;EnableExtensionUuid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ActiveRecord&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Migration&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;6.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;change&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;enable_extension&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;pgcrypto&#39;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# config/initializers/generators.rb&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;Rails&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;application&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;generators&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;g&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;g&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;orm&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:active_record&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;primary_key_type: :uuid&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The extension lets me use the &lt;code&gt;uuid&lt;/code&gt; data type and the &lt;code&gt;gen_random_uuid()&lt;/code&gt;
function. The generator configuration makes it that &lt;code&gt;bin/rails g migration&lt;/code&gt;
generates code with &lt;code&gt;uuid&lt;/code&gt; primary keys.&lt;/p&gt;

&lt;p&gt;I want to keep the database close to what we had in the API only version. The
main entity here is &lt;code&gt;user&lt;/code&gt;, which represents both students and mentors. Most of
the attributes are for mentor accounts. The only information we store on
students are the email address and password digest. I could split this up into
a &lt;code&gt;users&lt;/code&gt; table, for login information, and a &lt;code&gt;mentors&lt;/code&gt; table, for mentor
profiles, but the tradeoff isn’t worthwhile. It introduces complexity and the
only gains are that it becomes clearer which attribute is for mentors and which
attributes are for every user. This is what the old &lt;code&gt;users&lt;/code&gt; table looked like:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;n&quot;&gt;create_table&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;users&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;id: :uuid&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;email&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;null: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;false&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;password_digest&quot;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;blocked&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;default: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;false&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;admin&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;default: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;null: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;false&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;mentor&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;default: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;null: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;false&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;active&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;default: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;false&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;text&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;name&quot;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;text&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;bio&quot;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;text&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;picture_url&quot;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;text&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;picture&quot;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;integer&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;year_in&quot;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;integer&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;year_out&quot;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;text&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;links&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;default: &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[],&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;array: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;text&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;location&quot;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;datetime&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;created_at&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;null: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;false&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;datetime&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;updated_at&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;null: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;false&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;index&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;email&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;name: &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;index_users_on_email&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;unique: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The fields &lt;code&gt;email&lt;/code&gt;, &lt;code&gt;password_digest&lt;/code&gt;, and &lt;code&gt;blocked&lt;/code&gt; are account related
fields. &lt;code&gt;admin&lt;/code&gt; and &lt;code&gt;mentor&lt;/code&gt; are role fields. &lt;code&gt;created_at&lt;/code&gt; and &lt;code&gt;updated_at&lt;/code&gt; are
standard rails fields, for auditing purposes. The other fields are mentor
profile fields. If I decided to split this into two tables, it would look
something like this:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;n&quot;&gt;create_table&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;users&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;id: :uuid&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;email&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;null: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;false&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;password_digest&quot;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;blocked&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;default: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;false&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;admin&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;default: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;null: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;false&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;timestamps&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;index&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;email&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;name: &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;index_users_on_email&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;unique: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;create_table&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;mentors&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;id: :uuid&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;references&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;type: :uuid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;null: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
               &lt;span class=&quot;ss&quot;&gt;foreign_key: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;index: &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;unique: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;active&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;default: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;false&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;text&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;name&quot;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;text&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;bio&quot;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;text&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;picture_url&quot;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;text&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;picture&quot;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;integer&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;year_in&quot;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;integer&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;year_out&quot;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;text&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;links&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;default: &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[],&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;array: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;text&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;location&quot;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;timestamps&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Maybe in a future iteration this separation will be worthwhile, but not for
now. I might want to have admins review changes to mentor profiles before they
go live, as a moderation step. If I do it, the split might make sense then.&lt;/p&gt;

&lt;p&gt;I changed the migration to set the email uniqueness constraint to
&lt;code&gt;lower(email)&lt;/code&gt; instead of just &lt;code&gt;email&lt;/code&gt; to avoid having multiple users with the
same email in different cases. This is not in the standard, but most email
providers treat their addresses as case insensitive.&lt;/p&gt;

&lt;h2 id=&quot;adding-user-registration---routes&quot;&gt;Adding user registration - Routes&lt;/h2&gt;

&lt;p&gt;Now that I have the database set up, I’ll create the model, routes, and
controllers. This is where you might use something like
&lt;a href=&quot;https://github.com/heartcombo/devise&quot;&gt;&lt;code&gt;devise&lt;/code&gt;&lt;/a&gt; or
&lt;a href=&quot;https://github.com/thoughtbot/clearance&quot;&gt;&lt;code&gt;clearance&lt;/code&gt;&lt;/a&gt;. I’m going with using
rails’s &lt;a href=&quot;https://guides.rubyonrails.org/active_model_basics.html#securepassword&quot;&gt;&lt;code&gt;has_secure_password&lt;/code&gt;
feature&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I will have four routes related to registrations:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;code&gt;GET /registrations/new&lt;/code&gt; displays the registration form. I may alias it to &lt;code&gt;GET /register&lt;/code&gt;.&lt;/li&gt;
  &lt;li&gt;&lt;code&gt;POST /registrations&lt;/code&gt; registers a new user and sends a confirmation email&lt;/li&gt;
  &lt;li&gt;&lt;code&gt;GET /registration/:id&lt;/code&gt;, linked in the email, displays a confirmation form&lt;/li&gt;
  &lt;li&gt;&lt;code&gt;POST /registrations/:id/confirm&lt;/code&gt; confirms the registration&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;This is what the routes for these endpoints look like:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;no&quot;&gt;Rails&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;application&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;routes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;draw&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;resources&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:registrations&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;only: &lt;/span&gt;&lt;span class=&quot;sx&quot;&gt;%i[create new show]&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;member&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;post&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:confirm&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;bin/rails routes
&lt;/span&gt;              Prefix Verb URI Pattern                           Controller#Action
confirm_registration POST /registrations/:id/confirm(.:format)  registrations#confirm
       registrations POST /registrations(.:format)              registrations#create
    new_registration GET  /registrations/new(.:format)          registrations#new
        registration GET  /registrations/:id(.:format)          registrations#show
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I will need a registration ID and a way to track which users are confirmed. The
ID should not be guessable, as the purpose of this is to only allow the email
account owner to confirm the registration. I can either create a
&lt;code&gt;registrations&lt;/code&gt; table, with a &lt;code&gt;confirmed_at&lt;/code&gt; field, or add &lt;code&gt;registration_id&lt;/code&gt;
and &lt;code&gt;confirmed_at&lt;/code&gt; to the users table.&lt;/p&gt;

&lt;p&gt;I’m going with the second approach. Since there’s only one registration per
account, I don’t think I’m losing anything. When I start working on the
password recovery flow, I might have a separate table, so that we can keep
track of every password recovery ever, for auditability.&lt;/p&gt;

&lt;p&gt;Calling the new field &lt;code&gt;registration_id&lt;/code&gt; could be misleading, because it looks
like a foreign key. I am aware of this and will proceed anyway. This is the
migration:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;AddRegistrationIdAndConfirmedAtToUsers&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ActiveRecord&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Migration&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;6.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;change&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;change_table&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:users&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;datetime&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:confirmed_at&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;uuid&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:registration_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
             &lt;span class=&quot;ss&quot;&gt;null: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
             &lt;span class=&quot;ss&quot;&gt;unique: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
             &lt;span class=&quot;ss&quot;&gt;default: &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;gen_random_uuid()&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;adding-user-registration---model&quot;&gt;Adding user registration - Model&lt;/h2&gt;

&lt;p&gt;The &lt;code&gt;User&lt;/code&gt; model will have some validations, and I’m also adding some scopes
and accessors that I will need soon:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;User&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ApplicationRecord&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;scope&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:confirmed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;where&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;not&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;confirmed_at: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;scope&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:confirmation_pending&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;where&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;confirmed_at: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;scope&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:student&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;where&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;mentor: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;scope&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:mentor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;where&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;mentor: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;validates&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:email&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;presence: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;uniqueness: &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;case_sensitive: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;validate&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:validate_feup_email&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;on: :create&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;if: &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;student?&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;after_create&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:reload&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;has_secure_password&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;confirmed?&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;confirmed_at&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;nil?&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;student?&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mentor&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;mentor?&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;mentor&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;confirm!&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;update&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;confirmed_at: &lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;current&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;kp&quot;&gt;private&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;validate_feup_email&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;email&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;split&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;@&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;last&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;fe.up.pt&#39;&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;errors&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;add&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:email&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:feup_address_required&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I’m using a symbol &lt;code&gt;:feup_address_required&lt;/code&gt; in &lt;code&gt;errors.add&lt;/code&gt; to be able to
translate it.&lt;/p&gt;

&lt;p&gt;Another gotcha here is that since the &lt;code&gt;registration_id&lt;/code&gt; column has a database
default, &lt;code&gt;User#create&lt;/code&gt; does not return a model with that column value. To
ensure it always gets loaded, there’s a &lt;code&gt;after_create :reload&lt;/code&gt; hook. This, by
itself, may be enough reason to create defaults in rails instead of in
postgresql until this gets solved. Here’s the link to the issue:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/rails/rails/issues/34237&quot;&gt;https://github.com/rails/rails/issues/34237&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It looks like it might be a good candidate for a pull request.&lt;/p&gt;

&lt;p&gt;This model has a lot of code. Usually I would move on to work on the
controllers, but since there’s already some logic in here, I’ll add some tests
first.&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;c1&quot;&gt;# test/test_helper.rb&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;ENV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;RAILS_ENV&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;test&#39;&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;require_relative&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;../config/environment&#39;&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;require&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;rails/test_help&#39;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;module&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;ActiveSupport&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;TestCase&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;parallelize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;workers: :number_of_processors&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;kp&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;FactoryBot&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Syntax&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Methods&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# cat test/factories/users.rb&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;FactoryBot&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;factory&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:user&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;password&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Faker&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Internet&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;password&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;trait&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:student&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;mentor&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;email&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Faker&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Internet&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;email&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;domain: &lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;fe.up.pt&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;trait&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:mentor&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;mentor&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;email&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Faker&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Internet&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;email&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# test/models/user_test.rb&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;require&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;test_helper&#39;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;UserTest&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ActiveSupport&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;TestCase&lt;/span&gt;
  &lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;students with fe.up.pt email addresses are allowed&#39;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;assert&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;build&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:student&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;email: &lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;student@fe.up.pt&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;valid?&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;assert&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;build&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:student&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;email: &lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;STUDENT@FE.UP.PT&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;valid?&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;students without an fe.up.pt email address are not allowed&#39;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;assert_not&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;build&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:student&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;email: &lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;student@example.org&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;valid?&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;mentors without an fe.up.pt email address are allowed&#39;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;assert&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;build&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:mentor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;email: &lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;mentor@example.org&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;valid?&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;confirm! confirms user&#39;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;user&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;create&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:student&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;confirm!&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;assert&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;confirmed?&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;assert_not_nil&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;confirmed_at&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;two users with the same email address in different cases are not allowed&#39;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;user&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;create&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:student&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;assert_not&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;build&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:student&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;email: &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;email&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;upcase&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;valid?&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;user creation includes registration_id&#39;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;user&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;create&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:student&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;assert_not_nil&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;registration_id&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;adding-user-registration---controller&quot;&gt;Adding user registration - Controller&lt;/h2&gt;

&lt;p&gt;Now that the model is done, I can add the four routes code. This is where most
of the action is happening. In a large application, I would probably bother
with having some of this code in an &lt;code&gt;app/services/&lt;/code&gt; structure, but this is
simple enough that creating those will only cause more confusion when reading.&lt;/p&gt;

&lt;p&gt;For now, I won’t be sending the actual confirmation email.&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;RegistrationsController&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ApplicationController&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;confirm&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;registrations&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;find_by!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;registration_id: &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;params&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;confirm!&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;redirect_to&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;/&#39;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;rescue&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ActiveRecord&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;RecordNotFound&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;render&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:not_found&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;status: :not_found&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;create&lt;/span&gt;
    &lt;span class=&quot;vi&quot;&gt;@user&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;registrations&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;create&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;create_params&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;vi&quot;&gt;@user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;valid?&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;render&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;status: :created&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;render&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;status: :bad_request&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;
    &lt;span class=&quot;vi&quot;&gt;@user&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;registrations&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;show&lt;/span&gt;
    &lt;span class=&quot;vi&quot;&gt;@user&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;registrations&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;find_by!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;registration_id: &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;params&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;rescue&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ActiveRecord&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;RecordNotFound&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;render&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:not_found&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;status: :not_found&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;kp&quot;&gt;private&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;registrations&lt;/span&gt;
    &lt;span class=&quot;no&quot;&gt;User&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;student&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;confirmation_pending&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;create_params&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;params&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;permit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:email&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:password&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The downsides of not creating a database table for registrations are showing
already. I’m using &lt;code&gt;User.student.confirmation_pending&lt;/code&gt; everywhere, so I aliased
it to &lt;code&gt;registrations&lt;/code&gt; to make the code a bit DRYer, but it returns a &lt;code&gt;User&lt;/code&gt;
relation, so that might be a bit confusing. I also had to fight with form
building, particularly in &lt;code&gt;show.html.erb&lt;/code&gt;, to make things work:&lt;/p&gt;

&lt;div class=&quot;language-erb highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;h1&amp;gt;&lt;/span&gt;Confirm your account&lt;span class=&quot;nt&quot;&gt;&amp;lt;/h1&amp;gt;&lt;/span&gt;

&lt;span class=&quot;cp&quot;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;form_with&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;url: &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;confirm_registration_path&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;registration_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;method: :post&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;cp&quot;&gt;%&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;cp&quot;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;submit&lt;/span&gt; &lt;span class=&quot;cp&quot;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;&amp;lt;%&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt; &lt;span class=&quot;cp&quot;&gt;%&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If I had created the extra model, the &lt;code&gt;confirm&lt;/code&gt; route would be a &lt;code&gt;PATCH&lt;/code&gt;
instead, and the view would be a bit simpler:&lt;/p&gt;

&lt;div class=&quot;language-erb highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;h1&amp;gt;&lt;/span&gt;Confirm your account&lt;span class=&quot;nt&quot;&gt;&amp;lt;/h1&amp;gt;&lt;/span&gt;

&lt;span class=&quot;cp&quot;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;form_with&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;model: &lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@registration&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;url: &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;confirm_registration_path&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@registration&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;cp&quot;&gt;%&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;cp&quot;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;submit&lt;/span&gt; &lt;span class=&quot;cp&quot;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;&amp;lt;%&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt; &lt;span class=&quot;cp&quot;&gt;%&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;adding-user-registration---email-setup&quot;&gt;Adding user registration - email setup&lt;/h2&gt;

&lt;p&gt;To send registration confirmations, I need an email provider. Recently, I’ve
used both &lt;a href=&quot;https://sendgrid.com/pricing/&quot;&gt;Sendgrid&lt;/a&gt; and &lt;a href=&quot;https://aws.amazon.com/ses/pricing/&quot;&gt;Amazon
SES&lt;/a&gt;. Sendgrid has a free tier option,
while SES costs $0.10 per 1000 emails unless you’re sending emails from an EC2
instance, in which case you have 62k free emails per month. They’re both easy
to set up. Since I already have a personal AWS account, I’ll go with that.&lt;/p&gt;

&lt;p&gt;To use SES in rails, the easiest way is to use the &lt;a href=&quot;https://github.com/aws/aws-sdk-rails&quot;&gt;&lt;code&gt;aws-sdk-rails&lt;/code&gt;
gem&lt;/a&gt; and configure rails action mailer to
use it:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;c1&quot;&gt;# Gemfile&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;gem&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;aws-sdk-rails&#39;&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# config/initializers/mailer.rb&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Rails&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;test?&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;false&lt;/span&gt;
  &lt;span class=&quot;no&quot;&gt;Rails&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;application&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;action_mailer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;delivery_method&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:ses&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This gem needs an AWS access key to work, unless you’re running this in an EC2
instance. I have an &lt;code&gt;~/.aws/credentials&lt;/code&gt; file set up, but it has multiple
profiles without any defaults, so that I avoid using the wrong account. To
explicitly set the profile, I need to set the &lt;code&gt;AWS_PROFILE&lt;/code&gt; environment
variable. The gem also needs to know which aws region it should use, so I’ll
add these two variables to &lt;code&gt;.env.development.local&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-env&quot;&gt;AWS_PROFILE=hugopeixoto
AWS_REGION=eu-central-1
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The last SES setup step I need to do is to validate a few email addresses so
that I can send and receive emails while testing. To use this in production, I
will validate the sender domain, but for development, having a few validated
addresses is enough.&lt;/p&gt;

&lt;p&gt;I’m setting things up in &lt;code&gt;eu-central-1&lt;/code&gt;, so I need to go to the following URL
and verify some addresses:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://eu-central-1.console.aws.amazon.com/ses/home?region=eu-central-1#verified-senders-email&quot;&gt;https://eu-central-1.console.aws.amazon.com/ses/home?region=eu-central-1#verified-senders-email&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I validated my two &lt;code&gt;@fe.up.pt&lt;/code&gt; addresses and a &lt;code&gt;@gmail.com&lt;/code&gt; one that I’ll be
using as the sender.&lt;/p&gt;

&lt;p&gt;The emails I’m going to send will have some links pointing back to the
application, so the mailer needs to be aware of which domain I’m using. I
configured this by adding a new environment variable:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-env&quot;&gt;BASE_URL=http://localhost:3000
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And I used this variable in the mailer initializer:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;c1&quot;&gt;# config/initializers/mailer.rb&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Rails&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;test?&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;false&lt;/span&gt;
  &lt;span class=&quot;no&quot;&gt;Rails&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;application&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;action_mailer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;delivery_method&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:ses&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;no&quot;&gt;Rails&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;application&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;action_mailer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;default_url_options&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;host: &lt;/span&gt;&lt;span class=&quot;no&quot;&gt;ENV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;fetch&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;BASE_URL&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I also need to specify what address will be sending the emails, so I added
another environment variable, &lt;code&gt;EMAIL_SENDER_ADDRESS&lt;/code&gt;, to
&lt;code&gt;.env.development.local&lt;/code&gt;, and configured it globally in
&lt;code&gt;app/mailers/application_mailer.rb&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;c1&quot;&gt;# frozen_string_literal: true&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;ApplicationMailer&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ActionMailer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Base&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;default&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;from: &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ENV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;fetch&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;EMAIL_SENDER_ADDRESS&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;layout&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;mailer&#39;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;adding-user-registration---email-sending&quot;&gt;Adding user registration - email sending&lt;/h2&gt;

&lt;p&gt;Now that everything’s configured, I need a mailer. Mailers are similar to
controllers, where their actions represent messages.&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;bin/rails generate mailer registrations
&lt;/span&gt;    create  app/mailers/registrations_mailer.rb
    invoke  erb
    create    app/views/registrations_mailer
    invoke  test_unit
    create    test/mailers/registrations_mailer_test.rb
    create    test/mailers/previews/registrations_mailer_preview.rb
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I could have created the message directly using &lt;code&gt;generate mailer registrations
confirmation&lt;/code&gt;. It creates the action stub automatically, with two placeholder
templates (text and html). I’m going to override those (including the
filenames), so I skipped that. This is what my mailer looks like:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;RegistrationsMailer&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ApplicationMailer&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;confirmation&lt;/span&gt;
    &lt;span class=&quot;vi&quot;&gt;@user&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;params&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;vi&quot;&gt;@base_url&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ENV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;fetch&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;BASE_URL&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;vi&quot;&gt;@confirmation_url&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;registration_url&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;registration_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;mail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;to: &lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;email&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;subject: &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;default_i18n_subject&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I’m passing a &lt;code&gt;User&lt;/code&gt; object directly via &lt;code&gt;params[:user]&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Before, I used to serialize the &lt;code&gt;id&lt;/code&gt; and fetching the model explicitly. I used
to do this because email sending is something that you usually don’t do
synchronously, but instead goes through a queueing mechanism like
&lt;a href=&quot;https://sidekiq.org/&quot;&gt;Sidekiq&lt;/a&gt; or
&lt;a href=&quot;https://github.com/phstc/shoryuken&quot;&gt;Shoryuken&lt;/a&gt;. When using a queue, you
probably don’t want to serialize the full &lt;code&gt;User&lt;/code&gt; object and send it over. It
may be stale by the time it is processed, you’ll be potentially storing
sensitive information in the queue, and you’ll have to deal with object
marshalling. Turns out my rails knowledge was super outdated, and &lt;code&gt;ActiveJob&lt;/code&gt;
uses &lt;a href=&quot;https://github.com/rails/globalid&quot;&gt;&lt;code&gt;globalid&lt;/code&gt;&lt;/a&gt;, which serializes
&lt;code&gt;ActiveRecord&lt;/code&gt; into URLs:&lt;/p&gt;

&lt;div class=&quot;language-irb highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;irb(main):002:0&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;no&quot;&gt;User&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;first&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;to_global_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;to_s&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;gid://mentorados/User/4c29d8db-11f3-400a-a4e7-59bbda8a71bf&quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This means that I no longer have to pass &lt;code&gt;id&lt;/code&gt;s manually.&lt;/p&gt;

&lt;p&gt;I’m also using &lt;code&gt;subject: default_i18n_subject&lt;/code&gt; in the &lt;code&gt;#mail&lt;/code&gt; call.
&lt;code&gt;default_i18n_subject&lt;/code&gt; infers a translation key based on the mailer class and
the method name. In this case, it is
&lt;code&gt;registrations_mailer.confirmation.subject&lt;/code&gt;. Using &lt;code&gt;default_i18n_subject&lt;/code&gt; is
the default, so I could omit the &lt;code&gt;subject&lt;/code&gt; parameter, but I want to be sure
that anyone looking at this knows what’s going on.&lt;/p&gt;

&lt;p&gt;Now I need to write the email body template. I want these to be translatable,
and I don’t want to deal with creating arbitrary translation keys for each
paragraph (like &lt;code&gt;body_1&lt;/code&gt;, &lt;code&gt;body_2&lt;/code&gt;, etc) nor deal with interpolation
shenanigans. To avoid this, I will create a template per language, with the
locale in the filename. These are the contents of
&lt;code&gt;app/views/registrations_mailer/confirmation.en.text.erb&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-erb highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;We&#39;re sending someone registered this email address in &lt;span class=&quot;cp&quot;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&quot;vi&quot;&gt;@base_url&lt;/span&gt; &lt;span class=&quot;cp&quot;&gt;%&amp;gt;&lt;/span&gt;.

Before proceeding, we need you to confirm your email address:

&lt;span class=&quot;cp&quot;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&quot;vi&quot;&gt;@confirmation_url&lt;/span&gt; &lt;span class=&quot;cp&quot;&gt;%&amp;gt;&lt;/span&gt;

If you need any help or run into any issues:

mentor@alumniei.pt
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The portuguese version goes in the file
&lt;code&gt;app/views/registrations_mailer/confirmation.pt.text.erb&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Rendering a different template based on the locale is handled by &lt;code&gt;ActionView&lt;/code&gt;,
so this works for mailer templates and controller templates.&lt;/p&gt;

&lt;p&gt;Now that the mailer is done, I need to trigger the delivery of the email.
I’ll change the registrations controller directly:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;c1&quot;&gt;# app/controllers/registrations_controller.rb&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;RegistrationsController&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ApplicationController&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;create&lt;/span&gt;
    &lt;span class=&quot;no&quot;&gt;User&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;transaction&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
      &lt;span class=&quot;vi&quot;&gt;@user&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;User&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;student&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;confirmation_pending&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;create&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;create_params&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

      &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;vi&quot;&gt;@user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;valid?&lt;/span&gt;
        &lt;span class=&quot;no&quot;&gt;RegistrationsMailer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;with&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;user: &lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;confirmation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;deliver_now!&lt;/span&gt;

        &lt;span class=&quot;n&quot;&gt;render&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;status: :created&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;render&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;status: :bad_request&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is a basic approach for a basic project. It is sending the email messages
synchronously, inside a database transaction. This is not the best approach,
but given the low volume we’re expecting, it’s good enough. The database
transaction is there to avoid creating a user record if the email message
sending fails.&lt;/p&gt;

&lt;p&gt;In some projects, at this point I’d consider extracting the registration logic
into its own class / method / service. Something redundant, like
&lt;code&gt;app/services/registrations.rb&lt;/code&gt; with a &lt;code&gt;Registrations::create&lt;/code&gt; method. I’m not
having any of that in this project unless the controller gets really messy.&lt;/p&gt;

&lt;h2 id=&quot;wrapping-up&quot;&gt;Wrapping up&lt;/h2&gt;

&lt;p&gt;I have a base rails project with my personal tweaks.&lt;/p&gt;

&lt;p&gt;I learned about &lt;code&gt;globalid&lt;/code&gt;, and how it interacts with &lt;code&gt;ActiveJob&lt;/code&gt; and
&lt;code&gt;ActionMailer&lt;/code&gt;. This has been around since rails 4.2, which is probably a
lesson in refreshing your knowledge and questioning your assumptions from time
to time. The only reason I noticed that this was a thing was that I was reading
through &lt;a href=&quot;https://guides.rubyonrails.org/action_mailer_basics.html&quot;&gt;Action Mailer Basics
guide&lt;/a&gt; and noticed
that they’re using &lt;code&gt;params[:user]&lt;/code&gt; instead of &lt;code&gt;params[:id]&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;I learned a few new rails conventions for email translations: using
&lt;code&gt;default_i18n_subject&lt;/code&gt; and adding the locale to the view filename.&lt;/p&gt;

&lt;p&gt;I ran into a limitation when using database defaults and had to work around it
by adding a &lt;code&gt;after_create :reload&lt;/code&gt; workaround. I usually have rails handle the
default value generation, and I guess this is a good reason to keep doing that.
Fixing this limitation may be a good candidate for a code contribution.&lt;/p&gt;

&lt;p&gt;I’m using this application to experiment with a “back to basics” approach.
After many years of working with API only microservices and javascript
applications, relearning the basics of an html serving rails application feels
kind of new.&lt;/p&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2020-06-03:/articles/backing-up-gmail-with-rust.html</id>
    <title type="html">Backing up my gmail account with rust</title>
    <published>2020-06-03T00:00:00Z</published>
    <updated>2020-06-03T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/backing-up-gmail-with-rust.html"/>
    <summary type="html">
      <![CDATA[]]>
    </summary>
    <content type="html">

      &lt;p&gt;I have been using a gmail account as my primary email address since 2004. I
don’t usually delete things, so I have thousands of emails in there. Depending
on google to maintain this for me, without any backups, is kind of scary, but I
have been putting off backing these up for a while now.&lt;/p&gt;

&lt;p&gt;I’m aware that there’s a data export functionality. You should probably use
that. A few years ago, that didn’t work that great. It failed creating full
exports, and I had to resort to filter them by year to be able to successfully
export them and download them. I hope this is fixed by now.&lt;/p&gt;

&lt;p&gt;In 2014, I tried using &lt;a href=&quot;http://www.offlineimap.org/&quot;&gt;offlineimap&lt;/a&gt;. I don’t
remember what went wrong there, but I do remember that it took forever and
failed a lot. It seems that it is being replaced with
&lt;a href=&quot;http://imapfw.offlineimap.org/&quot;&gt;imapfw&lt;/a&gt;, but it isn’t ready yet.&lt;/p&gt;

&lt;p&gt;This week I was cleaning up my inbox, and noticed that I get a lot of emails
per day. I wanted to get an idea of what kind of emails I get, do some basic
analysis.&lt;/p&gt;

&lt;p&gt;Since I have found myself with a lot of free time lately, I decided to create a
rust tool to back up the emails via IMAP. This would provide me with a local
backup and allow me to have a local copy I can easily analyze.&lt;/p&gt;

&lt;h2 id=&quot;getting-my-feet-wet&quot;&gt;Getting my feet wet&lt;/h2&gt;

&lt;p&gt;There’s an &lt;a href=&quot;https://crates.io/crates/imap&quot;&gt;imap crate&lt;/a&gt;. I’ll be using that. To
connect to your gmail account, you need to enable IMAP access in your settings.
I also needed to create an “App password (by going to
&lt;a href=&quot;https://myaccount.google.com/apppasswords&quot;&gt;https://myaccount.google.com/apppasswords&lt;/a&gt;). Not sure if this is the safest
thing to do.&lt;/p&gt;

&lt;p&gt;Using the example in the imap crate readme, I was able to view the first
message I have in my account.&lt;/p&gt;

&lt;p&gt;Before starting to implement the backup process, I decided to get an overview
of what I was getting into. I wanted to check how many emails I would have to
backup, and, while I’m at it, how are they spread across the years.&lt;/p&gt;

&lt;p&gt;This is what I ended up with:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;extern&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;crate&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;imap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;extern&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;crate&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;native_tls&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;extern&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;crate&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;chrono&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ImapSession&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;imap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Session&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;native_tls&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;TlsStream&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;net&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;TcpStream&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;DateTime&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;chrono&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;DateTime&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;chrono&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;offset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FixedOffset&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;message_date&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;u64&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;imap_session&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ImapSession&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Option&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;DateTime&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;Ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;messages&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;imap_session&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.fetch&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.to_string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;INTERNALDATE&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;Some&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;message&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;messages&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.first&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;message&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.internal_date&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;nb&quot;&gt;None&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tls&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;native_tls&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;TlsConnector&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;builder&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.build&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.unwrap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;client&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;imap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;connect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;imap.gmail.com&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;993&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;&quot;imap.gmail.com&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tls&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.unwrap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;username&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;var&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;USERNAME&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.unwrap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;password&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;var&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;PASSWORD&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.unwrap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;imap_session&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;client&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.login&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;username&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;password&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.unwrap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;imap_session&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.select&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;[Gmail]/All Mail&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.unwrap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;idx&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;..&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
       &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;msg&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;idx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;idx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1000&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;

       &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;Some&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;date&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;message_date&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;msg&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;imap_session&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
           &lt;span class=&quot;nd&quot;&gt;println!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;{} {}&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;msg&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;date&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.to_rfc3339&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;());&lt;/span&gt;
       &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
           &lt;span class=&quot;k&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
       &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This grabs each thousandth message and prints the message date. Running it as:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;hugopeixoto@laptop:mail-tools export USERNAME=email
hugopeixoto@laptop:mail-tools export PASSWORD=password
hugopeixoto@laptop:mail-tools cargo run | tee stats.txt
1 2004-09-03T21:53:26+00:00
1000 2007-09-18T14:08:24+00:00
2000 2007-12-20T17:48:38+00:00
3000 2008-02-27T01:40:51+00:00
4000 2008-04-07T22:45:39+00:00
[...]
144000 2019-11-25T22:05:33+00:00
145000 2020-01-20T20:00:24+00:00
146000 2020-03-09T12:39:42+00:00
147000 2020-04-21T17:31:33+00:00
148000 2020-05-21T11:10:44+00:00
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I would usually plot these with gnuplot, but decided to try
&lt;a href=&quot;https://www.r-project.org/&quot;&gt;R&lt;/a&gt; instead:&lt;/p&gt;

&lt;div class=&quot;language-R highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;n&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ggplot2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;read.table&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;stats.txt&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;col.names&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;count&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;date&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;colClasses&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;numeric&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;POSIXct&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ggplot&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;aes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;date&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;geom_line&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/articles/time-to-email-count.png&quot; alt=&quot;Email count growing with time&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I have roughly 150000 emails in need of backup, and it seems that the new
emails rate is decreasing.&lt;/p&gt;

&lt;p&gt;To calculate the exact number of messages, I wrote an &lt;a href=&quot;https://en.wikipedia.org/wiki/Exponential_search&quot;&gt;exponential
search&lt;/a&gt; function:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;highest_message_number&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;imap_session&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ImapSession&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;u64&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lower&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;upper&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;..&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;idx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2u64&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.pow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;Some&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;date&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;message_date&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;idx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;imap_session&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;lower&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;idx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;upper&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;idx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;break&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lower&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;upper&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;middle&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lower&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;upper&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;Some&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;date&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;message_date&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;middle&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;imap_session&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;lower&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;middle&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;upper&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;middle&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;lower&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This starts by exponentially increasing the message index to determine a lower
and upper bound. &lt;code&gt;lower&lt;/code&gt; will always refer to an existing message index, while
&lt;code&gt;upper&lt;/code&gt; will always point to a non existing message index. The second step is
to run a binary search.&lt;/p&gt;

&lt;p&gt;Now that I have the exact number of messages that need to be backed up, I
should store them.&lt;/p&gt;

&lt;h2 id=&quot;fetching-message-contents-via-imap&quot;&gt;Fetching message contents via IMAP&lt;/h2&gt;

&lt;p&gt;Ideally, what would end up being backed up is what you see when, in gmail, you
“Show original message”. Every header and body part. You can specify which
fields are fetched in the second argument of &lt;code&gt;fetch&lt;/code&gt;. Using &lt;code&gt;RFC822&lt;/code&gt; fetches
the entire message, including headers.&lt;/p&gt;

&lt;p&gt;You can also fetch more than one message per &lt;code&gt;fetch&lt;/code&gt; by specifying a range in
the first argument. I wrapped this in a &lt;code&gt;messages&lt;/code&gt; function:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;extern&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;crate&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;imap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;extern&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;crate&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;native_tls&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;extern&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;crate&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;chrono&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ImapSession&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;imap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Session&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;native_tls&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;TlsStream&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;net&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;TcpStream&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;nd&quot;&gt;#[derive(Debug)]&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Message&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;uid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;imap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;types&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Uid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;body&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;u8&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;messages&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;from&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;u64&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;to&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;u64&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;imap_session&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ImapSession&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Message&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;result&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;imap_session&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.fetch&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nd&quot;&gt;format!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;{}:{}&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;from&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;to&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;(UID RFC822)&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;Ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;messages&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;result&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;messages&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.iter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;message&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;Message&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;uid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;message&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.uid&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.unwrap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;body&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;message&lt;/span&gt;
                  &lt;span class=&quot;nf&quot;&gt;.body&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
                  &lt;span class=&quot;nf&quot;&gt;.map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.into_iter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(|&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.collect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
                  &lt;span class=&quot;nf&quot;&gt;.unwrap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt;
            &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.collect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;nd&quot;&gt;vec!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is significantly faster than fetching messages one by one. Comparing the
batched versus the one by one method:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;// ...&lt;/span&gt;

    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;now&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;Instant&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;now&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
        &lt;span class=&quot;nd&quot;&gt;println!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;one by one&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

        &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;101&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;nd&quot;&gt;println!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;{:?}&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;messages&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;imap_session&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.first&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.unwrap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.uid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

        &lt;span class=&quot;nd&quot;&gt;println!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;{}&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;now&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.elapsed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.as_secs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;());&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;now&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;Instant&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;now&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
        &lt;span class=&quot;nd&quot;&gt;println!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;batched&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

        &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;message&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;messages&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;101&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;imap_session&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.into_iter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;nd&quot;&gt;println!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;{:?}&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;message&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.uid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

        &lt;span class=&quot;nd&quot;&gt;println!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;{}&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;now&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.elapsed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.as_secs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;());&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;hugopeixoto@laptop:~/w/p/mail-tools cargo build --release
hugopeixoto@laptop:~/w/p/mail-tools ./target/release/mail-tools
batched
[...]
11
one by one
[...]
37
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In this scenario, batching was 3 times faster. These results are not super
precise, the time to fetch a single message varies a lot, but I don’t see why
batching would be worse.&lt;/p&gt;

&lt;h2 id=&quot;storing-rfc822-messages&quot;&gt;Storing RFC822 messages&lt;/h2&gt;

&lt;p&gt;With the body and message unique identifier loaded, the next step is to store
it in the file system:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;pub&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;message_store&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;message&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Message&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Result&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Box&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dyn&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;file&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;fs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;File&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;create&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nd&quot;&gt;format!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;messages/{:07}.txt&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;message&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.uid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.write_all&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;message&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.body&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;nf&quot;&gt;Ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(())&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;pub&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;messages_store_from&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;base&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;u64&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;imap_session&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ImapSession&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;max&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;highest_message_number&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;imap_session&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;nd&quot;&gt;println!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Going up to {}&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;max&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;step&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;500&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;..&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lower&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;base&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;step&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;upper&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;base&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;step&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lower&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;max&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

        &lt;span class=&quot;nd&quot;&gt;println!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;batching {}:{}&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lower&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;upper&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;message&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;messages&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lower&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;upper&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;imap_session&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.into_iter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;nf&quot;&gt;message_store&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;message&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.unwrap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This stores one email per file, in the &lt;code&gt;messages/&lt;/code&gt; directory, in the format
specified by &lt;a href=&quot;https://tools.ietf.org/html/rfc5322&quot;&gt;RFC5322&lt;/a&gt; (which supersedes
&lt;a href=&quot;https://tools.ietf.org/html/rfc2822&quot;&gt;RFC2822&lt;/a&gt; and
&lt;a href=&quot;https://tools.ietf.org/html/rfc822&quot;&gt;RFC822&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;The &lt;code&gt;base&lt;/code&gt; parameter will allow me to resume downloading if anything fails, or
to fetch new emails incrementally. I increased the batch size from 100 to 500.&lt;/p&gt;

&lt;p&gt;This is good enough for a first prototype. If I wanted to turn this into a
library, I would create a message iterator with built in batching.&lt;/p&gt;

&lt;p&gt;This took ~35 minutes to download 100k messages, and ~60 minutes to download
everything. I ended up with &lt;code&gt;9.6G&lt;/code&gt; of messages.&lt;/p&gt;

&lt;p&gt;I could try to paralelize these requests with multiple IMAP sessions. Using 10
workers could improve the running time to 5 minutes, assuming there are no
server side bottleneck. According to &lt;a href=&quot;https://support.google.com/mail/answer/7126229&quot;&gt;GMail’s support
page&lt;/a&gt;, “You can only use 15
IMAP connections per account”. They don’t mention any other limits.&lt;/p&gt;

&lt;h2 id=&quot;email-analysis&quot;&gt;Email analysis&lt;/h2&gt;

&lt;p&gt;Reading 9.6G spread across 150k files in a single run is not going to be fast.
I used &lt;a href=&quot;https://crates.io/crates/mailparse&quot;&gt;&lt;code&gt;mailparse&lt;/code&gt;&lt;/a&gt;, and it takes ~70
seconds to read every file and pass them through the &lt;code&gt;parse_mail&lt;/code&gt; function.&lt;/p&gt;

&lt;p&gt;During parsing, I found two malformed emails coming from Yahoo, when they were
handling the Delicious data migration. There was no empty line between the
headers and the body.&lt;/p&gt;

&lt;p&gt;I tried fetching the date of each email, using &lt;code&gt;mailparse::dateparse&lt;/code&gt;, but I
hit some malformed headers as well. Here are the malformed ones I found:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;code&gt;Date: Sat, 19 Feb 2005 05:59:26 Pacific Standard Time&lt;/code&gt;: uses named timezone instead of offset&lt;/li&gt;
  &lt;li&gt;&lt;code&gt;Date: Fri 06-Nov-2009 07:47 +0100&lt;/code&gt;: uses dashes as separators&lt;/li&gt;
  &lt;li&gt;&lt;code&gt;Date: Fri, 18 Dec 2009 13:15:52 --0800&lt;/code&gt;: double minus sign&lt;/li&gt;
  &lt;li&gt;&lt;code&gt;Date: Dom, 1 Dez 2013 13:36:43 -000&lt;/code&gt;: portuguese weekdays and months&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I solved these with a bunch of string &lt;code&gt;replace&lt;/code&gt; function calls. Using
&lt;a href=&quot;https://crates.io/crates/itertools&quot;&gt;&lt;code&gt;itertools&lt;/code&gt;&lt;/a&gt; and
&lt;a href=&quot;https://crates.io/crates/chrono&quot;&gt;&lt;code&gt;chrono&lt;/code&gt;&lt;/a&gt;, I calculated the maximum number of
emails per day:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;extern&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;crate&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;chrono&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;itertools&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Itertools&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;io&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;chrono&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;DateTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;NaiveDateTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Utc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;io&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;prelude&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;mailparse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;entries&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;fs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;read_dir&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;messages&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;nf&quot;&gt;.unwrap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
        &lt;span class=&quot;nf&quot;&gt;.map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;res&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;res&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.path&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()))&lt;/span&gt;
        &lt;span class=&quot;py&quot;&gt;.collect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Result&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;io&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
        &lt;span class=&quot;nf&quot;&gt;.unwrap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;entries&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.sort&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dates&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;entries&lt;/span&gt;
        &lt;span class=&quot;nf&quot;&gt;.iter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
        &lt;span class=&quot;nf&quot;&gt;.map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;file&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;fs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;File&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.unwrap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;contents&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;u8&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.read_to_end&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;contents&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.unwrap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

            &lt;span class=&quot;n&quot;&gt;contents&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
        &lt;span class=&quot;nf&quot;&gt;.map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;contents&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;nf&quot;&gt;parse_headers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;contents&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
                &lt;span class=&quot;nf&quot;&gt;.unwrap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
                &lt;span class=&quot;mi&quot;&gt;.0&lt;/span&gt;
                &lt;span class=&quot;nf&quot;&gt;.get_first_value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Date&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
                &lt;span class=&quot;nf&quot;&gt;.unwrap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
                &lt;span class=&quot;nf&quot;&gt;.replace&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Pacific Standard Time&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;PST&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
                &lt;span class=&quot;nf&quot;&gt;.replace&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot; --&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot; -&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
                &lt;span class=&quot;nf&quot;&gt;.replace&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;-Nov-&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot; Nov &quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
                &lt;span class=&quot;nf&quot;&gt;.replace&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Dom&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;Sun&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.replace&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Dez&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;Dec&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
        &lt;span class=&quot;nf&quot;&gt;.map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;date&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;dateparse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;date&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.unwrap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
        &lt;span class=&quot;nf&quot;&gt;.map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;NaiveDateTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;from_timestamp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
        &lt;span class=&quot;nf&quot;&gt;.map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;datetime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;DateTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Utc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;from_utc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;datetime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Utc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.date&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
        &lt;span class=&quot;nf&quot;&gt;.group_by&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(|&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;date&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;date&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;nf&quot;&gt;.into_iter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
        &lt;span class=&quot;nf&quot;&gt;.map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(|(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;date&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
        &lt;span class=&quot;nf&quot;&gt;.max&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

    &lt;span class=&quot;nd&quot;&gt;println!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;{}&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;entries&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;());&lt;/span&gt;
    &lt;span class=&quot;nd&quot;&gt;println!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;{:?}&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dates&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This takes too long to process, so I may decide I want to store both the
original message and a pre-processed index somewhere. I could create a &lt;code&gt;mbox&lt;/code&gt;
file per year, for example, or store them in a sqlite database.&lt;/p&gt;

&lt;h2 id=&quot;conclusions&quot;&gt;Conclusions&lt;/h2&gt;

&lt;p&gt;Thanks to the &lt;code&gt;imap&lt;/code&gt; crate, I was able to quickly download every email from my
gmail account. With &lt;code&gt;mailparse&lt;/code&gt;, I can run some analytics on my emails. I also
have the ability to add some automation, like turning newsletters to RSS feeds,
or register invoices in &lt;a href=&quot;https://plaintextaccounting.org/&quot;&gt;ledger&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I’ve published these tools under an MIT license. You can check it out at:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/hugopeixoto/mail-tools&quot;&gt;https://github.com/hugopeixoto/mail-tools&lt;/a&gt;&lt;/p&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2020-05-30:/articles/next-steps.html</id>
    <title type="html">Next steps</title>
    <published>2020-05-30T00:00:00Z</published>
    <updated>2020-05-30T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/next-steps.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;I’m no longer working for &lt;a href=&quot;https://company.fractal.id/&quot;&gt;Fractal&lt;/a&gt;. &lt;a href=&quot;https://lifeonmars.pt&quot;&gt;Life on Mars&lt;/a&gt; is also on its way out. This means that I am, excluding some administration/cleanup tasks, free. My plan for June (and probably July) is to have little to no plan. No failure conditions. I want to relax for a bit, do some cleanup, focus on some on other things that were lower priority.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;p&gt;I’m no longer working for &lt;a href=&quot;https://company.fractal.id/&quot;&gt;Fractal&lt;/a&gt;. &lt;a href=&quot;https://lifeonmars.pt&quot;&gt;Life on
Mars&lt;/a&gt; is also on its way out. This means that I am,
excluding some administration/cleanup tasks, free.&lt;/p&gt;

&lt;p&gt;My plan for June (and probably July) is to have little to no plan. No failure
conditions. I want to relax for a bit, do some cleanup, focus on some  on other
things that were lower priority. Here are some digital related things I’d like
to do, in no particular order.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Clean up my email inbox&lt;/strong&gt;. It’s currently at 300+ entries, and it’s mostly:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;newsletters I barely read (ruby/db/go weekly, inside security);&lt;/li&gt;
  &lt;li&gt;mailing lists;&lt;/li&gt;
  &lt;li&gt;notifications from github, twist, etc;&lt;/li&gt;
  &lt;li&gt;wrong recipient;&lt;/li&gt;
  &lt;li&gt;marketing emails.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;If there are any important emails in there, I haven’t seen them. I need to go
on an unsubscribing spree. I’d like to start using my own domain, to have
provider portability instead of depending on gmail, but that feels like a
bigger endeavor.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Start using RSS again&lt;/strong&gt;. I used google reader a lot. I signed up for
&lt;a href=&quot;https://theoldreader.com/&quot;&gt;theoldreader&lt;/a&gt; and imported my subscriptions there,
but barely touched it again. Most of the blogs I used to follow are no longer
updated. I’ve recently started reading webcomics again, and RSS is probably the
sanest way of keeping track of it. I want to look at self hosting options.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Finish editing Porto codes videos&lt;/strong&gt;. We’ve &lt;a href=&quot;https://www.youtube.com/channel/UC1zSOKJl5DhQmlxtEfPGrvw/videos&quot;&gt;published 13 videos so
far&lt;/a&gt;, but
there are still a few missing. I’m currently distanced from my editing machine,
so that’s going to be a bit hard, but I need to solve that problem.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Set up a bookmarking / read later system&lt;/strong&gt;. I have a bunch of tabs open for
later. Unfortunately, my laptop is super unstable and crashes a lot, and
sometimes chromium won’t remember open tabs. Ideally, this would plug into the
RSS feed.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Get a new laptop or reconfigure this one&lt;/strong&gt;. I configured the laptop on
2015-12-26, and I had some issues with the graphics drivers and built a custom
kernel to be able to use the newest releases. Running &lt;code&gt;yarn build&lt;/code&gt; in some
projects brings my machine to a halt, probably due to only having 8gb of ram
and a few chromium profiles open. My X11 configuration stopped working a few
months ago, pushing me to finally switch to &lt;a href=&quot;https://swaywm.org/&quot;&gt;sway&lt;/a&gt;,
because I needed it working quickly and didn’t have time to debug what was
happening. I recently noticed that the lower left part of the screen is full of
dead pixels.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Remove authenticator codes from my old phone&lt;/strong&gt;. I changed from a MotoG3 to a
Nokia 6.1 a couple of years ago, but I never bothered to migrate all of the
TOTP keys to the new one. I need to do that, because I want to explore
alternatives to Google Android and I would need to wipe my MotoG3 for that.&lt;/p&gt;

&lt;p&gt;I should also do something about sorting out my digital home (terabytes of
files), but I’ve been trying to do that for literally years and it is not
getting any easier with the passing of the years.&lt;/p&gt;

&lt;p&gt;Eventually I will need to start thinking about what’s next, professionally. I
may do some small freelance gigs meanwhile. I’m open to suggestions :p&lt;/p&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2020-05-21:/articles/2020-05-21.html</id>
    <title type="html">Fixing someone else&#39;s elixir project</title>
    <published>2020-05-21T00:00:00Z</published>
    <updated>2020-05-21T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/2020-05-21.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;I needed to make an phoenix/elixir project deployable. The project was from 2017, and not much care was given to make sure it was up to date. The deployment story was messy and not ideal.&lt;/p&gt;
]]>
    </summary>
    <content type="html">
      <![CDATA[
        <aside>
          This is a <code>[journal]</code> entry. It is longer than usual and
          more exploratory. It may have no proper conclusion.
        </aside>
      ]]>

      &lt;p&gt;&lt;a href=&quot;https://makeorbreak.io&quot;&gt;Make or break&lt;/a&gt;’s website is powered by an API server
written in &lt;a href=&quot;https://elixir-lang.org/&quot;&gt;Elixir&lt;/a&gt;, using
&lt;a href=&quot;https://www.phoenixframework.org/&quot;&gt;Phoenix&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The technology choice here was probably based on “let’s try something new”, so
it’s understandable if the project structure feels awkward.&lt;/p&gt;

&lt;p&gt;I barely touched this code, but I remember that deploying it has always been
kind of messy. It took ~15 minutes to build and deploy a new version. It
started by using &lt;a href=&quot;https://github.com/hashrocket/gatling&quot;&gt;Gatling&lt;/a&gt;, which seems
to create Distillery releases (I don’t know what this means).&lt;/p&gt;

&lt;p&gt;At some point, we changed to &lt;a href=&quot;https://github.com/edeliver/edeliver&quot;&gt;edeliver&lt;/a&gt;,
and started using incremental builds to save some time.&lt;/p&gt;

&lt;p&gt;This is all deployed to a VPS somewhere, manually managed. No Heroku, no
docker, no CI. I have no idea why this is currently so hard/weird to deploy,
but my goal is to make this deployable via docker and have its build time be
reasonable, given the size of the codebase.&lt;/p&gt;

&lt;p&gt;This is the repository I’m going to be looking at:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/makeorbreak-io/api&quot;&gt;https://github.com/makeorbreak-io/api&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;exploring-the-codebase&quot;&gt;Exploring the codebase&lt;/h2&gt;

&lt;p&gt;I have looked at the elixir syntax and did some basic changes to the project.
I’ve interviewed someone on &lt;a href=&quot;https://conversas.simplecast.com/episodes/ep-12-elixir&quot;&gt;an episode of Conversas em
código&lt;/a&gt;. That’s as far
as my knowledge goes. I don’t know how the tooling works, or the runtime, or
what the interpreter vs compiler expectations are.&lt;/p&gt;

&lt;p&gt;The first thing I did was read the README. Things I noticed:&lt;/p&gt;

&lt;p&gt;It talks about &lt;code&gt;mix&lt;/code&gt;: &lt;code&gt;mix deps.get&lt;/code&gt;, &lt;code&gt;mix ecto.create&lt;/code&gt;, etc. I take it that
&lt;code&gt;mix&lt;/code&gt; is the &lt;code&gt;npm/yarn/cargo/bundler+rake&lt;/code&gt; of this language.&lt;/p&gt;

&lt;p&gt;It mentions &lt;code&gt;edeliver&lt;/code&gt;: &lt;code&gt;edeliver build&lt;/code&gt;, &lt;code&gt;release&lt;/code&gt;, &lt;code&gt;restart&lt;/code&gt;, &lt;code&gt;migrate&lt;/code&gt;. This
is executed directly on the server, from what I understand. It also mentions
something about preserving dependency built files. I suppose this is trying to
cache dependencies to make things faster.&lt;/p&gt;

&lt;p&gt;It mentions systemd. This means there’s probably a service file somewhere under
&lt;code&gt;/etc/systemd/system/&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;It lists a set of environment variables. This is good, because it’s an
indicator that the configuration is done the way I do it in other languages, so
there will be some familiarity here.&lt;/p&gt;

&lt;h2 id=&quot;environment-variables&quot;&gt;Environment variables&lt;/h2&gt;

&lt;p&gt;There’s a list of environment variables in the README, but these are usually
outdated. Let’s see if that’s the case here.&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/m/api$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;ack System\.get_env -h |
&lt;/span&gt;&amp;gt; grep -v &#39;^#&#39; |
&amp;gt; sed -e &#39;s/.*System.get_env(&quot;\([^&quot;]*\)&quot;).*/\1/&#39; |
&amp;gt; sort -u
AI_CALLBACK_URL
AI_SERVER_HOST
AI_SERVER_TOKEN
DATABASE_URL
DB_URL
GITHUB_TOKEN
HOST
MAILGUN_API_DOMAIN
MAILGUN_API_KEY
POOL_SIZE
PORT
SECRET_KEY_BASE
SLACK_TOKEN
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The project references both a &lt;code&gt;DB_URL&lt;/code&gt; and a &lt;code&gt;DATABASE_URL&lt;/code&gt;. This feels
accidental. I’ve created an issue and a PR to normalize it:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/makeorbreak-io/api/issues/9&quot;&gt;https://github.com/makeorbreak-io/api/issues/9&lt;/a&gt;
&lt;a href=&quot;https://github.com/makeorbreak-io/api/pull/10&quot;&gt;https://github.com/makeorbreak-io/api/pull/10&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The other environment variables all seem to match. The readme said something else of note:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Use your preferred method to add the following variables to your environment.
You can find an example env file you can source in &lt;code&gt;share/env/env&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;This means that this is not using &lt;code&gt;dotenv&lt;/code&gt;, or anything similar, to manage
environment variables while in development. Is there a dotenv package for
elixir?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/avdi/dotenv_elixir&quot;&gt;https://github.com/avdi/dotenv_elixir&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;WARNING: This isn’t the Elixir way.&lt;/p&gt;

  &lt;p&gt;Elixir has an excellent configuration system and this dotenv implementation
has a serious limitation in that it isn’t available at compile time. It fits
very poorly into a typical deployment setup using exrm or similar.
Configuration management should be built around Elixir’s existing
configuration system, and the limitations of this package make it inadequate
for most users.&lt;/p&gt;

  &lt;p&gt;A good example is Phoenix which generates a project where the production
config imports the “secrets” from a file stored outside of version control.
Even if you’re using this for development, the same approach could be taken.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;This is kind of odd, but it matches the &lt;code&gt;config/&lt;/code&gt; directory of the project:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/m/api$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;tree config/
&lt;/span&gt;config/
├── config.exs
├── dev.exs
├── prod.exs
├── prod.secret.exs
└── test.exs

0 directories, 5 files
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There’s a &lt;code&gt;.exs&lt;/code&gt; file per environment, with different configs:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/m/api$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;ack DATABASE_URL
&lt;/span&gt;config/test.exs
7:  url: &quot;#{System.get_env(&quot;DATABASE_URL&quot;)}-test&quot;

config/prod.secret.exs
8:  System.get_env(&quot;DATABASE_URL&quot;) ||
10:    environment variable DATABASE_URL is missing.

lib/api/repo.ex
8:  DATABASE_URL environment variable.
11:    {:ok, Keyword.put(opts, :url, System.get_env(&quot;DATABASE_URL&quot;))}
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So, production uses &lt;code&gt;DATABASE_URL&lt;/code&gt;, test uses &lt;code&gt;DATABASE_URL&lt;/code&gt; concatenated with
&lt;code&gt;-test&lt;/code&gt;. What does dev use? There’s no match in &lt;code&gt;config/dev.exs&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;What is that last match, &lt;code&gt;lib/api/repo.ex&lt;/code&gt;?&lt;/p&gt;

&lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;defmodule&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Api&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Repo&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;kn&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Ecto&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Repo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;ss&quot;&gt;otp_app:&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:api&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;ss&quot;&gt;adapter:&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Ecto&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Adapters&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Postgres&lt;/span&gt;

  &lt;span class=&quot;nv&quot;&gt;@doc&lt;/span&gt; &lt;span class=&quot;sd&quot;&gt;&quot;&quot;&quot;
  Dynamically loads the repository url from the
  DATABASE_URL environment variable.
  &quot;&quot;&quot;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;init&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;opts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Keyword&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;put&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;opts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:url&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;System&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;get_env&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;DATABASE_URL&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))}&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Let’s confront it with &lt;code&gt;config/test.exs&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;kn&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Mix&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Config&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# Configure your database&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;config&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:api&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Api&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Repo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;ss&quot;&gt;pool:&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Ecto&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Adapters&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;SQL&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Sandbox&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;ss&quot;&gt;adapter:&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Ecto&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Adapters&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Postgres&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;ss&quot;&gt;url:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;System&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;get_env&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;DATABASE_URL&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;-test&quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So, there’s a module &lt;code&gt;Api.Repo&lt;/code&gt; which has an initializer that takes &lt;code&gt;opts&lt;/code&gt; and
returns &lt;code&gt;{:ok, modified_opts}&lt;/code&gt;. What does &lt;code&gt;config&lt;/code&gt; in &lt;code&gt;test.exs&lt;/code&gt; do? I would
assume that it prepares the &lt;code&gt;opts&lt;/code&gt; that will be passed to the &lt;code&gt;init&lt;/code&gt; function.
Since &lt;code&gt;Keyword.put&lt;/code&gt; overrides the &lt;code&gt;:url&lt;/code&gt; key in &lt;code&gt;opts&lt;/code&gt;, that would mean that
setting &lt;code&gt;url:&lt;/code&gt; in &lt;code&gt;test.exs&lt;/code&gt; is useless.&lt;/p&gt;

&lt;p&gt;With some help from &lt;a href=&quot;https://twitter.com/arturferreira&quot;&gt;Artur Ferreira&lt;/a&gt;, I
found out that this apparently was a bug in the phoenix generator:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/phoenixframework/phoenix/pull/2650&quot;&gt;https://github.com/phoenixframework/phoenix/pull/2650&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;With the previous code, even if we were populating the url: param in the
dev.exs file we would have errors being thrown as the DATABASE_URL would be
empty and would also empty the param for ecto thus creating an error.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;So this means that running tests in this project will accidentally use the same
database that is used in development mode. I suspect that they don’t run tests
that often.&lt;/p&gt;

&lt;p&gt;So, all environments use &lt;code&gt;DATABASE_URL&lt;/code&gt;, and every &lt;code&gt;:url&lt;/code&gt; in the config files
is irrelevant. Before moving on, let me read the &lt;code&gt;config&lt;/code&gt; documentation, just
so that I understand how it works underneath.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://hexdocs.pm/mix/Mix.Config.html&quot;&gt;https://hexdocs.pm/mix/Mix.Config.html&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;This module is deprecated. Use Config and Config.Reader instead.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Oh, cool. Well, this doesn’t point to an upgrade guide or anything like that,
so I searched the web for how to migrate, and ended up here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://elixir-lang.org/blog/2019/06/24/elixir-v1-9-0-released/&quot;&gt;https://elixir-lang.org/blog/2019/06/24/elixir-v1-9-0-released/&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;The main feature in Elixir v1.9 is the addition of releases. A release is a
self-contained directory that consists of your application code, all of its
dependencies, plus the whole Erlang Virtual Machine (VM) and runtime.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Although unrelated, this may be useful when I’m building the docker image.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;We also use the work on releases to streamline Elixir’s configuration API. A
new Config module has been added to Elixir. The previous configuration API,
Mix.Config, was part of the Mix build tool. However, since releases provide
runtime configuration and Mix is not included in releases, we ported the
Mix.Config API to Elixir. In other words, use Mix.Config has been
soft-deprecated in favor of import Config.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Ah, this explains it. Now if only they linked to an upgrade guide. Some more
searching led me here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://hexdocs.pm/elixir/master/Config.html&quot;&gt;https://hexdocs.pm/elixir/master/Config.html&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Config&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;config&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:some_app&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;ss&quot;&gt;key1:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;value1&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;ss&quot;&gt;key2:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;value2&quot;&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;import_config&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Mix&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;.exs&quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;Migrating from use Mix.Config&lt;/p&gt;

  &lt;p&gt;The Config module in Elixir was introduced in v1.9 as a replacement to
Mix.Config, which was specific to Mix and has been deprecated.&lt;/p&gt;

  &lt;p&gt;You can leverage Config instead of Mix.Config in two steps. The first step is
to replace use Mix.Config at the top of your config files by import Config.&lt;/p&gt;

  &lt;p&gt;The second is to make sure your import_config/1 calls do not have a wildcard
character. If so, you need to perform the wildcard lookup manually.&lt;/p&gt;

  &lt;p&gt;If you are using releases, see mix release, there is another configuration
file called config/releases.exs. While config/config.exs and friends
mentioned in the previous section are executed whenever you run a Mix
command, including when you assemble a release, config/releases.exs is
executed every time your production system boots. Since Mix is not available
in a production system, config/releases.exs must not use any of the functions
from Mix.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Well, it doesn’t look that different from &lt;code&gt;Mix.Config&lt;/code&gt;. I’ll make a PR changing
this. While I’m at it, I’ll remove the &lt;code&gt;config/prod.secret.exs&lt;/code&gt; file as well,
since we’re not storing secrets directly in config files, so the split  between
&lt;code&gt;prod.exs&lt;/code&gt; and &lt;code&gt;prod.secret.exs&lt;/code&gt; is kind of useless. The &lt;code&gt;secret.exs&lt;/code&gt; file is
commited to the repository, so even if it had any secrets, they wouldn’t be
very secrety. We also had &lt;code&gt;config/prod.secret.exs&lt;/code&gt; in &lt;code&gt;gitgnore&lt;/code&gt;. Removing that
as well.&lt;/p&gt;

&lt;p&gt;While doing this, I saw this comment:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;Using releases (Elixir v1.9+)&lt;/strong&gt;&lt;/p&gt;

  &lt;p&gt;If you are doing OTP releases, you need to instruct Phoenix
to start each relevant endpoint:&lt;/p&gt;

  &lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;config :api, ApiWeb.Endpoint, server: true
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;  &lt;/div&gt;

  &lt;p&gt;Then you can assemble a release by calling &lt;code&gt;mix release&lt;/code&gt;.
See &lt;code&gt;mix help release&lt;/code&gt; for more information.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;This might be relevant later on.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/makeorbreak-io/api/pull/11&quot;&gt;https://github.com/makeorbreak-io/api/pull/11&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Now, what does &lt;code&gt;config&lt;/code&gt; do?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/elixir-lang/elixir/blob/50995e66404fee889846db7343705f881b2a3f25/lib/elixir/lib/config.ex#L132&quot;&gt;https://github.com/elixir-lang/elixir/blob/50995e66404fee889846db7343705f881b2a3f25/lib/elixir/lib/config.ex#L132&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It seems to call &lt;code&gt;put_config&lt;/code&gt;, which calls &lt;code&gt;Process.put&lt;/code&gt;. Who reads this?&lt;/p&gt;

&lt;p&gt;So it seems that &lt;code&gt;init&lt;/code&gt; method in our &lt;code&gt;lib/api/repo.ex&lt;/code&gt; is called by ecto:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/elixir-ecto/ecto/blob/v3.4.4/lib/ecto/repo.ex#L381&quot;&gt;https://github.com/elixir-ecto/ecto/blob/v3.4.4/lib/ecto/repo.ex#L381&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Also from that file:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;In case the URL needs to be dynamically configured, for example by reading a
system environment variable, such can be done via the
&lt;code&gt;c:init/2&lt;/code&gt; repository callback:&lt;/p&gt;

  &lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;def init(_type, config) do
  {:ok, Keyword.put(config, :url, System.get_env(&quot;DATABASE_URL&quot;))}
end
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;  &lt;/div&gt;
&lt;/blockquote&gt;

&lt;p&gt;This is the code we saw earlier. Does this mean that using System.get_env in
&lt;code&gt;config/*.exs&lt;/code&gt; files will behave differently? To be determined.&lt;/p&gt;

&lt;p&gt;Ecto fetches the config using:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;Ecto.Repo.Supervisor.runtime_config(:runtime, __MODULE__, @otp_app, [])
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;which calls:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;config = Application.get_env(otp_app, repo, [])
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I am not sure how &lt;code&gt;Process.put&lt;/code&gt; and &lt;code&gt;Application.get_env&lt;/code&gt; relate. Looking at
the &lt;code&gt;Application&lt;/code&gt; documentation, it seems that Mix handles passing things to
the application when it starts one.&lt;/p&gt;

&lt;p&gt;I think that I have a good enough understanding of how environment variables
get passed to applications. I also know that I’ll need to change this if I try
to mess with &lt;code&gt;Releases&lt;/code&gt;, so I will get back to this later.&lt;/p&gt;

&lt;p&gt;Time to try to get a basic Dockerfile running.&lt;/p&gt;

&lt;h2 id=&quot;dockerfile&quot;&gt;Dockerfile&lt;/h2&gt;

&lt;p&gt;Like in other languages, I know that I don’t want to download every dependency
if I don’t add new ones, so I’ll start with this:&lt;/p&gt;

&lt;div class=&quot;language-docker highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; elixir&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;ADD&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; mix.exs mix.lock /app/&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;WORKDIR&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; /app&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;mix deps.get
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This does not work:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/m/api$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;docker build .
&lt;/span&gt;[...]
Could not find Hex, which is needed to build dependency :absinthe
Shall I install Hex? (if running non-interactively, use &quot;mix local.hex --force&quot;) [Yn]
** (Mix) Could not find an SCM for dependency :absinthe from Api.MixProject
The command &#39;/bin/sh -c mix deps.get&#39; returned a non-zero code: 1
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://hex.pm/&quot;&gt;Hex&lt;/a&gt; is the package manager, so &lt;code&gt;mix&lt;/code&gt; is not enough. Let’s
add their suggestion to the Dockerfile:&lt;/p&gt;

&lt;div class=&quot;language-docker highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; elixir&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;ADD&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; mix.exs mix.lock /app/&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;WORKDIR&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; /app&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;mix local.hex &lt;span class=&quot;nt&quot;&gt;--force&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;mix deps.get
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;“Successfully built”. So, usually, now I would add the rest of the code and
compile it. Let’s try that:&lt;/p&gt;

&lt;div class=&quot;language-docker highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; elixir&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;ADD&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; mix.exs mix.lock /app/&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;WORKDIR&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; /app&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;mix local.hex &lt;span class=&quot;nt&quot;&gt;--force&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;mix deps.get

&lt;span class=&quot;k&quot;&gt;ADD&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; . /app/&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;mix compile
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Another error:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;Could not find &quot;rebar3&quot;, which is needed to build dependency :parse_trans
I can install a local copy which is just used by Mix
Shall I install rebar3? (if running non-interactively, use &quot;mix local.rebar --force&quot;) [Yn]
** (Mix) Could not find &quot;rebar3&quot; to compile dependency :parse_trans, please ensure &quot;rebar3&quot; is available
The command &#39;/bin/sh -c mix compile&#39; returned a non-zero code: 1
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Rebar seems to be a tool to “create, develop and release Erlang libraries”, as
opposed to Elixir, I guess. Let’s add that as well:&lt;/p&gt;

&lt;div class=&quot;language-docker highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; elixir&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;ADD&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; mix.exs mix.lock /app/&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;WORKDIR&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; /app&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;mix local.hex &lt;span class=&quot;nt&quot;&gt;--force&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;mix rebar.hex &lt;span class=&quot;nt&quot;&gt;--force&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;mix deps.get

&lt;span class=&quot;k&quot;&gt;ADD&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; . /app/&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;mix compile
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This worked, but it compiled all the dependencies in the &lt;code&gt;mix compile&lt;/code&gt; step,
which seems kind of wasteful. Reading through &lt;code&gt;mix&lt;/code&gt; docs, there is a &lt;code&gt;mix
deps.compile&lt;/code&gt; task, so let’s try that before adding the full app:&lt;/p&gt;

&lt;div class=&quot;language-docker highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; elixir&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;ADD&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; mix.exs mix.lock /app/&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;WORKDIR&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; /app&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;mix local.hex &lt;span class=&quot;nt&quot;&gt;--force&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;mix rebar.hex &lt;span class=&quot;nt&quot;&gt;--force&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;mix deps.get
&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;mix deps.compile

&lt;span class=&quot;k&quot;&gt;ADD&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; . /app/&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;mix compile
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;OK, this seems to work. Here’s the time each step takes:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/m/api$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;docker build --no-cache . | grep --line-buffered &#39;Step\|Success&#39; | ts -i
&lt;/span&gt;00:00:00 Step 1/9 : FROM elixir
00:00:00 Step 2/9 : ADD mix.exs mix.lock /app/
00:00:01 Step 3/9 : WORKDIR /app
00:00:00 Step 4/9 : RUN mix local.hex --force
00:00:03 Step 5/9 : RUN mix local.rebar --force
00:00:05 Step 6/9 : RUN mix deps.get
00:00:06 Step 7/9 : RUN mix deps.compile
00:02:10 Step 8/9 : ADD . /app/
00:00:01 Step 9/9 : RUN mix compile
00:00:11 Successfully built b32f0c99fcaf
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We can see that the step that takes the longest is &lt;code&gt;mix deps.compile&lt;/code&gt;, and
we’re able to run it based on &lt;code&gt;mix.exs&lt;/code&gt; and &lt;code&gt;mix.lock&lt;/code&gt; only, which is great.&lt;/p&gt;

&lt;p&gt;Now, I can run the server directly with &lt;code&gt;mix phx.server&lt;/code&gt;. This won’t be making
use of the releases feature, but we’ll get there as soon as this is running.&lt;/p&gt;

&lt;p&gt;I added &lt;code&gt;CMD mix phx.server&lt;/code&gt; to the docker file and tried running it:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/m/api$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;docker run -it mob-api
&lt;/span&gt;[error] GenServer #PID&amp;lt;0.383.0&amp;gt; terminating
** (RuntimeError) connect raised KeyError exception: key :database not found.
The exception details are hidden, as they may contain sensitive data such as
database credentials. You may set :show_sensitive_data_on_connection_error to
true when starting your connection if you wish to see all of the details
    (elixir 1.10.3) lib/keyword.ex:399: Keyword.fetch!/2
    (postgrex 0.15.3) lib/postgrex/protocol.ex:92: Postgrex.Protocol.connect/1
    (db_connection 2.2.1) lib/db_connection/connection.ex:69: DBConnection.Connection.connect/2
    (connection 1.0.4) lib/connection.ex:622: Connection.enter_connect/5
    (stdlib 3.12.1) proc_lib.erl:249: :proc_lib.init_p_do_apply/3
Last message: nil
State: Postgrex.Protocol
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This makes sense, since I didn’t set any environment variables. I’ll use
&lt;code&gt;--env&lt;/code&gt; to pass a file with the DATABASE_URL var:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/m/api$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;cat dockerenv
&lt;/span&gt;DATABASE_URL=postgres://mob:secretpassword@172.17.0.1/mob-api

&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/m/api$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;createuser mob -P
&lt;/span&gt;Enter password for new role:
Enter it again:

&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/m/api$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;docker run --env-file dockerenv -it mob-api
&lt;/span&gt;[info] Running ApiWeb.Endpoint with cowboy 2.7.0 at 0.0.0.0:4000 (http)
[info] Access ApiWeb.Endpoint at http://localhost:4000
^C
BREAK: (a)bort (A)bort with dump (c)ontinue (p)roc info (i)nfo
       (l)oaded (v)ersion (k)ill (D)b-tables (d)istribution
^Chugopeixoto@laptop:~/w/m/api$
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I guess it’s running. If I bind the port, I can then use curl to access it:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/m/api$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;docker run -p 4000:4000 --env-file dockerenv -it mob-api
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;# &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;[in another terminal]
&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/m/api$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;curl -I localhost:4000
&lt;/span&gt;HTTP/1.1 404 Not Found
cache-control: max-age=0, private, must-revalidate
content-length: 50348
content-type: text/html; charset=utf-8
date: Fri, 22 May 2020 13:46:45 GMT
server: Cowboy
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It’s running. One thing that this is not doing is running database migrations.
I’ll leave that for last. Let’s look at the releases feature.&lt;/p&gt;

&lt;h2 id=&quot;elixir-releases&quot;&gt;Elixir releases&lt;/h2&gt;

&lt;p&gt;Going back to the &lt;a href=&quot;https://elixir-lang.org/blog/2019/06/24/elixir-v1-9-0-released/&quot;&gt;“Elixir v1.9 released”
post&lt;/a&gt;:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Once a release is assembled, it can be packaged and deployed to a target as
long as the target runs on the same operating system (OS) distribution and
version as the machine running the mix release command&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;So there’s a &lt;code&gt;mix release&lt;/code&gt; command.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;A release does not require the source code to be included in your production
artifacts. All of the code is precompiled and packaged. Releases do not even
require Erlang or Elixir in your servers, as they include the Erlang VM and
its runtime by default.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;This means I’ll probably end up using docker multi-stage builds to optimize the
final image.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;You can start a new project and assemble a release for it in three easy steps:&lt;/p&gt;

  &lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;mix new my_app
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;cd my_app
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;MIX_ENV=prod mix release
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;  &lt;/div&gt;

  &lt;p&gt;A release will be assembled in _build/prod/rel/my_app.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Let’s give this a try. I know that I’ll need to do something to the
configuration files. I’m also not sure how this will interact with the other
commands I currently have in the Dockerfile, but we’ll find out. I’ll start by
adding the &lt;code&gt;mix release&lt;/code&gt; command right after &lt;code&gt;mix compile&lt;/code&gt;. Hopefully it is
able to reuse some of the work done there.&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/m/api$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;cat Dockerfile
&lt;/span&gt;FROM elixir

ADD mix.exs mix.lock /app/

WORKDIR /app

RUN mix local.hex --force
RUN mix local.rebar --force
RUN mix deps.get
RUN mix deps.compile

ADD . /app/
RUN mix compile
ENV MIX_ENV=prod
RUN mix release

CMD mix phx.server

&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/m/api$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;docker build . -t mob-api
&lt;/span&gt;[...]
Step 11/12 : RUN mix release
 ---&amp;gt; Running in 0359472a81da
** (RuntimeError) environment variable DATABASE_URL is missing.
For example: ecto://USER:PASS@HOST/DATABASE

    (stdlib 3.12.1) erl_eval.erl:680: :erl_eval.do_apply/6
    (stdlib 3.12.1) erl_eval.erl:449: :erl_eval.expr/5
    (elixir 1.10.3) lib/code.ex:341: Code.eval_string_with_error_handling/3
    (stdlib 3.12.1) erl_eval.erl:680: :erl_eval.do_apply/6
    (stdlib 3.12.1) erl_eval.erl:126: :erl_eval.exprs/5
The command &#39;/bin/sh -c mix release&#39; returned a non-zero code: 1
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I don’t want to pass the configuration at build time, so I’ll read a bit on the
&lt;code&gt;config/releases.exs&lt;/code&gt; thing:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://hexdocs.pm/phoenix/releases.html&quot;&gt;https://hexdocs.pm/phoenix/releases.html&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;You may have noticed that, in order to assemble our release, we had to set
both SECRET_KEY_BASE and DATABASE_URL. That’s because config/config.exs,
config/prod.exs, and friends are executed when the release is assembled (or
more generally speaking, whenever you run a mix command).&lt;/p&gt;

  &lt;p&gt;However, in many cases, we don’t want to set the values for SECRET_KEY_BASE
and DATABASE_URL when assembling the release but only when starting the
system in production&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Checks out. So how do we solve this?&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Luckily, for such use cases, mix release provides runtime configuration,
which we can enable in three steps:&lt;/p&gt;

  &lt;ul&gt;
    &lt;li&gt;Rename config/prod.secret.exs to config/releases.exs&lt;/li&gt;
    &lt;li&gt;Change use Mix.Config inside the new config/releases.exs file to import
Config (if you want, you can replace all uses of use Mix.Config by import
Config, as the latter replaces the former)&lt;/li&gt;
    &lt;li&gt;Change config/prod.exs to no longer call import_config “prod.secret.exs” at the bottom&lt;/li&gt;
  &lt;/ul&gt;
&lt;/blockquote&gt;

&lt;p&gt;OK, I’ve done the second step (using &lt;code&gt;import Config&lt;/code&gt;). Unfortunately, I did
merge &lt;code&gt;prod.secret.exs&lt;/code&gt; with &lt;code&gt;prod.exs&lt;/code&gt;. The way I’m interpreting those
instructions is that we would end up in a place where running this through mix
with MIX_ENV=prod would no longer work, since it would lack secrets. If this is
correct, this means that what this is doing, in practice, is making production
only runnable through release. This means I can rename config/prod.exs&lt;code&gt; to
&lt;/code&gt;config/releases.exs&lt;code&gt;. Let&#39;s try that. I need a stub file because we&#39;re
loading &lt;/code&gt;config/#{Mix.env}.exs&lt;code&gt; in &lt;/code&gt;config/config.exs`.&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/m/api$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;git mv config/prod.exs config/releases.exs
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/m/api$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;touch config/prod.exs
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/m/api$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;docker build . -t mob-api
&lt;/span&gt;[... nothing new in steps 1 through 10 ...]
Step 11/12 : RUN mix release
 ---&amp;gt; Running in 6cea5ec75e0c
 ==&amp;gt; markus
 Compiling 3 files (.ex)
 Generated markus app
 ===&amp;gt; Compiling parse_trans
 ===&amp;gt; Compiling mimerl
 ==&amp;gt; connection
 Compiling 1 file (.ex)
 Generated connection app
 ===&amp;gt; Compiling metrics
 ===&amp;gt; Compiling unicode_util_compat
 ===&amp;gt; Compiling idna
[... more dependency compiling ...]

Generated api app
* assembling api-0.1.0 on MIX_ENV=prod
* using config/releases.exs to configure the release at runtime
* skipping elixir.bat for windows (bin/elixir.bat not found in the Elixir installation)
* skipping iex.bat for windows (bin/iex.bat not found in the Elixir installation)

Release created at _build/prod/rel/api!

&lt;span class=&quot;gp&quot;&gt;    # &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;To start your system
&lt;/span&gt;    _build/prod/rel/api/bin/api start

Once the release is running:

&lt;span class=&quot;gp&quot;&gt;    # &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;To connect to it remotely
&lt;/span&gt;    _build/prod/rel/api/bin/api remote

&lt;span class=&quot;gp&quot;&gt;    # &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;To stop it gracefully (you may also send SIGINT/SIGTERM)
&lt;/span&gt;    _build/prod/rel/api/bin/api stop

To list all commands:

    _build/prod/rel/api/bin/api

Removing intermediate container 6cea5ec75e0c
 ---&amp;gt; 2f944ef18ac1
Step 12/12 : CMD mix phx.server
 ---&amp;gt; Running in 00da122127e9
Removing intermediate container 00da122127e9
 ---&amp;gt; 1b3ae8ad66eb
Successfully built 1b3ae8ad66eb
Successfully tagged mob-api:latest
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Successfully built. On one hand, great, it worked. On the other hand, it
recompiled everything, ignoring the previous &lt;code&gt;mix deps.compile&lt;/code&gt; command. Maybe
it is caused by me setting &lt;code&gt;MIX_ENV=prod&lt;/code&gt; so late in the process. Let me try to
move it to the beginning of the file and try again:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/m/api$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;cat Dockerfile
&lt;/span&gt;FROM elixir

ENV MIX_ENV=prod

ADD mix.exs mix.lock /app/

WORKDIR /app

RUN mix local.hex --force
RUN mix local.rebar --force
RUN mix deps.get
RUN mix deps.compile

ADD . /app/
RUN mix compile
RUN mix release

CMD mix phx.server
&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/m/api$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;docker build . -t mob-api
&lt;/span&gt;[...]
Step 11/12 : RUN mix release
 ---&amp;gt; Running in 41d5c65d4ec2
* assembling api-0.1.0 on MIX_ENV=prod
* using config/releases.exs to configure the release at runtime
* skipping elixir.bat for windows (bin/elixir.bat not found in the Elixir installation)
* skipping iex.bat for windows (bin/iex.bat not found in the Elixir installation)

Release created at _build/prod/rel/api!

&lt;span class=&quot;gp&quot;&gt;    # &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;To start your system
&lt;/span&gt;    _build/prod/rel/api/bin/api start

Once the release is running:

&lt;span class=&quot;gp&quot;&gt;    # &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;To connect to it remotely
&lt;/span&gt;    _build/prod/rel/api/bin/api remote

&lt;span class=&quot;gp&quot;&gt;    # &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;To stop it gracefully (you may also send SIGINT/SIGTERM)
&lt;/span&gt;    _build/prod/rel/api/bin/api stop

To list all commands:

    _build/prod/rel/api/bin/api

Removing intermediate container 41d5c65d4ec2
 ---&amp;gt; 47a7a3b3b36e
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That was it. The docs say that we need to copy the &lt;code&gt;_build/prod/rel/my_app&lt;/code&gt;
directory. Let’s take a look at what’s there.&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/m/api$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;docker run --entrypoint bash -it mob-api
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;root@4c3117a8256d:/app# &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;du -sh _build/prod/rel/api
&lt;/span&gt;44M     _build/prod/rel/api
&lt;span class=&quot;gp&quot;&gt;root@4c3117a8256d:/app# &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;find _build/prod/rel/api -type f | wc -l
&lt;/span&gt;1846
&lt;span class=&quot;gp&quot;&gt;root@4c3117a8256d:/app# &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;find _build/prod/rel/api -name &quot;*.beam&quot; | wc -l
&lt;/span&gt;1561
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Small size, but a ton of beam files. I still need to change the &lt;code&gt;CMD&lt;/code&gt; from &lt;code&gt;mix
phx.server&lt;/code&gt; to &lt;code&gt;_build/prod/rel/my_app/bin/my_app&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Phoenix does have a section on containers, which is quite similar to what I’m
doing:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://hexdocs.pm/phoenix/releases.html#containers&quot;&gt;https://hexdocs.pm/phoenix/releases.html#containers&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I don’t need the asset pipeline part, since I’m dealing with an API only web
service. The rest looks quite similar. I’ll adapt my Dockerfile to use
multi-stage builds, like they do. I also need to create a .dockerignore file,
because I’m tired of recompiling the app every time I change the dockerfile.&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/m/api$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;cat .dockerignore
&lt;/span&gt;Dockerfile
.git
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-docker highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; elixir AS build&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;ENV&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; MIX_ENV=prod&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;ADD&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; mix.exs mix.lock /app/&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;WORKDIR&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; /app&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;mix local.hex &lt;span class=&quot;nt&quot;&gt;--force&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;mix local.rebar &lt;span class=&quot;nt&quot;&gt;--force&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;mix deps.get
&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;mix deps.compile

&lt;span class=&quot;k&quot;&gt;ADD&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; . /app/&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;mix compile
&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;mix release

&lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; alpine:3.9 AS app&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;apk add &lt;span class=&quot;nt&quot;&gt;--no-cache&lt;/span&gt; openssl ncurses-libs

&lt;span class=&quot;k&quot;&gt;WORKDIR&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; /app&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;chown &lt;/span&gt;nobody:nobody /app
&lt;span class=&quot;k&quot;&gt;USER&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; nobody:nobody&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;ENV&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; HOME=/app&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;COPY&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; --from=build --chown=nobody:nobody /app/_build/prod/rel/api ./&lt;/span&gt;


&lt;span class=&quot;k&quot;&gt;CMD&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; bin/api start&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/m/api$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;docker run --env-file dockerenv -it mob-api
&lt;/span&gt;/app/releases/0.1.0/../../erts-10.7.2/bin/erl: exec: line 12: /app/erts-10.7.2/bin/erlexec: not found
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Well, this didn’t work. What am I missing? The file erlexec does exist. This
type of errors is usually caused by the executable trying to load a dynamic
library and not being able to find it. Let’s see what it is.&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/m/api$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;docker run --entrypoint sh -it mob-api
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;/app $ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;ldd /app/erts-10.7.2/bin/erlexec
&lt;/span&gt;      /lib64/ld-linux-x86-64.so.2 (0x7fcf8239b000)
      libm.so.6 =&amp;gt; /lib64/ld-linux-x86-64.so.2 (0x7fcf8239b000)
      libc.so.6 =&amp;gt; /lib64/ld-linux-x86-64.so.2 (0x7fcf8239b000)
&lt;span class=&quot;gp&quot;&gt;/app $ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;ls -1 /
&lt;/span&gt;app
bin
dev
etc
home
lib
media
mnt
opt
proc
root
run
sbin
srv
sys
tmp
usr
var
&lt;span class=&quot;gp&quot;&gt;/app $ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;ls /lib64
&lt;/span&gt;ls: /lib64: No such file or directory
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Well, derp. This is probably because I’m using alpine for the app image and a
generic elixir one for the build image. I should be using an &lt;code&gt;elixir:*-alpine&lt;/code&gt;
image. Let’s change the first line to &lt;code&gt;FROM elixir:alpine AS build&lt;/code&gt; and try
again. I’ll also need to add &lt;code&gt;build-base&lt;/code&gt;, since some dependencies need to
compile things.&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/m/api$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;docker build . -t mob-api | grep --line-buffered &#39;Step\|Success&#39; | ts -i
&lt;/span&gt;00:00:00 Step 1/20 : FROM elixir:alpine AS build
00:00:00 Step 2/20 : RUN apk add --no-cache build-base
00:00:20 Step 3/20 : ENV MIX_ENV=prod
00:00:01 Step 4/20 : ADD mix.exs mix.lock /app/
00:00:00 Step 5/20 : WORKDIR /app
00:00:01 Step 6/20 : RUN mix local.hex --force
00:00:04 Step 7/20 : RUN mix local.rebar --force
00:00:04 Step 8/20 : RUN mix deps.get
00:00:07 Step 9/20 : RUN mix deps.compile
00:02:13 Step 10/20 : ADD . /app/
00:00:00 Step 11/20 : RUN mix compile
00:00:08 Step 12/20 : RUN mix release
00:00:06 Step 13/20 : FROM alpine:3.9 AS app
00:00:00 Step 14/20 : RUN apk add --no-cache openssl ncurses-libs
00:00:00 Step 15/20 : WORKDIR /app
00:00:00 Step 16/20 : RUN chown nobody:nobody /app
00:00:00 Step 17/20 : USER nobody:nobody
00:00:00 Step 18/20 : ENV HOME=/app
00:00:00 Step 19/20 : COPY --from=build --chown=nobody:nobody /app/_build/prod/rel/api ./
00:00:03 Step 20/20 : CMD bin/api start
00:00:00 Successfully built 2bceb3b1061b
00:00:00 Successfully tagged mob-api:latest

&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/m/api$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;docker run --env-file dockerenv -it mob-api
&lt;/span&gt;warning: found Jason in your application configuration
for Phoenix JSON encoding, but failed to load the library.

(module Jason is not available).

Ensure Jason exists in your deps in mix.exs,
and you have configured Phoenix to use it for JSON encoding by
verifying the following exists in your config/config.exs:

    config :phoenix, :json_library, Jason

[...]

15:00:41.699 [info] Application api exited:
  Api.Application.start(:normal, []) returned an error:
  shutdown: failed to start child: Api.Repo
** (EXIT) an exception was raised:
** (UndefinedFunctionError) function Ecto.Adapters.Postgres.init/1 is undefined
   (module Ecto.Adapters.Postgres is not available)

&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Huh. We have a warning and an error. I think that they could both have the same
underlying cause (&lt;code&gt;module Jason/Ecto.Adapters.Postgres is not available&lt;/code&gt;).&lt;/p&gt;

&lt;p&gt;&lt;code&gt;mix.exs&lt;/code&gt; has both a list of &lt;code&gt;deps&lt;/code&gt; and a &lt;code&gt;def application&lt;/code&gt;. If I add &lt;code&gt;:jason&lt;/code&gt;
and &lt;code&gt;:ecto_sql&lt;/code&gt; to the applications list, these errors go away. I am getting
other similar errors, though, so I need to continue adding things until it
works, I suppose.&lt;/p&gt;

&lt;p&gt;OK, that worked. Now it’s complaining that there’s no manifest file:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;17:27:31.332 [error] Could not find static manifest at
&quot;/app/lib/api-0.1.0/priv/static/cache_manifest.json&quot;. Run &quot;mix phx.digest&quot;
after building your static files or remove the configuration from
&quot;config/prod.exs&quot;.
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I don’t need this, because there are no static files, so I’ll remove whatever
entry they’re mentioning.&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/m/api$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;docker run -p 4000:4000 --env-file dockerenv -it mob-api
&lt;/span&gt;17:32:12.194 [info] Running ApiWeb.Endpoint with cowboy 2.7.0 at :::4000 (http)
17:32:12.195 [info] Access ApiWeb.Endpoint at http://localhost
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;OK, it boots! Does it work, though? Let’s do a curl.&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/m/api$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;curl -I localhost:4000
&lt;/span&gt;HTTP/1.1 500 Internal Server Error
content-length: 0
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Oh no. This is the error that I’m getting:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;** (UndefinedFunctionError) function ApiWeb.ErrorView.render/2 is undefined
   (module ApiWeb.ErrorView is not available)
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;From the phoenix docs:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://hexdocs.pm/phoenix/custom_error_pages.html&quot;&gt;https://hexdocs.pm/phoenix/custom_error_pages.html&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Phoenix has a view called the ErrorView which lives in
lib/hello_web/views/error_view.ex. The purpose of the ErrorView is to handle
errors in a general way, from one centralized location.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;So I should have a &lt;code&gt;lib/api_web/views/error_view.ex&lt;/code&gt; file. Let’s confirm:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/m/api$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;ls -1 lib/api_web/views/
&lt;/span&gt;attendance_view.ex
email_view.ex
error_helpers.ex
layout_view.ex
membership_view.ex
pressentation_view.ex
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There’s a &lt;code&gt;error_helpers.ex&lt;/code&gt;, but no &lt;code&gt;error_view.ex&lt;/code&gt;. All of the other files
end in &lt;code&gt;_view.ex&lt;/code&gt;, though. Could this have been a migration error? I’ll create
the file according to the sample on phoenix docs and try again.&lt;/p&gt;

&lt;p&gt;I added this:&lt;/p&gt;

&lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;defmodule&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ApiWeb&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;ErrorView&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;kn&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ApiWeb&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:view&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;template_not_found&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;template&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_assigns&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;no&quot;&gt;Phoenix&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Controller&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;status_message_from_template&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;template&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And now I do get a 400:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/m/api$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;curl -I localhost:4000
&lt;/span&gt;HTTP/1.1 404 Not Found
cache-control: max-age=0, private, must-revalidate
content-length: 14
content-type: text/html; charset=utf-8
date: Fri, 22 May 2020 18:27:27 GMT
server: Cowboy
x-request-id: FhFtDYZfPjAzAswAAALB
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Out of curiosity, I decided to check what our live website currently responds:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/m/api$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;curl -I https://api.makeorbreak.io
&lt;/span&gt;HTTP/1.1 500 Internal Server Error
Server: nginx
Date: Fri, 22 May 2020 18:38:54 GMT
Content-Length: 0
Connection: keep-alive
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So this wasn’t a new error, I just didn’t expect this to blow up when hitting a
non-existing route.&lt;/p&gt;

&lt;p&gt;Before moving on, I’d like to check why this is responding with &lt;code&gt;text/html&lt;/code&gt;
instead of &lt;code&gt;application/json&lt;/code&gt;. I’m guessing that the app was not generated with
&lt;code&gt;--no-html&lt;/code&gt; and all of that. Let’s see what I can find:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/m/api$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;ack -w html config/ lib/api_web
&lt;/span&gt;config/config.exs
28:  render_errors: [view: ApiWeb.ErrorView, accepts: ~w(html json)],

config/releases.exs
&lt;span class=&quot;gp&quot;&gt;36:# &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;options, see https://hexdocs.pm/plug/Plug.SSL.html#configure/1
&lt;/span&gt;
lib/api_web/templates/layout/email.html.eex
1:&amp;lt;!doctype html&amp;gt;
2:&amp;lt;html&amp;gt;
9:    html, body {
146:&amp;lt;/html&amp;gt;

lib/api_web/router.ex
8:    plug :accepts, [&quot;html&quot;]
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Let’s start by removing the &lt;code&gt;html&lt;/code&gt; entry from &lt;code&gt;render_errors&lt;/code&gt;. It worked:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/m/api$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;curl -I localhost:4000
&lt;/span&gt;HTTP/1.1 404 Not Found
cache-control: max-age=0, private, must-revalidate
content-length: 21
content-type: application/json; charset=utf-8
date: Fri, 22 May 2020 18:50:29 GMT
server: Cowboy
x-request-id: FhFuTznvV3eEIWIAAAFD
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now it would be nice to test an endpoint that does something, and that
preferably touches the database.&lt;/p&gt;

&lt;h2 id=&quot;database-and-graphql&quot;&gt;Database and GraphQL&lt;/h2&gt;

&lt;p&gt;This project has &lt;code&gt;graphiql&lt;/code&gt; installed, so I tried to access
&lt;code&gt;http://localhost:4000/graphiql&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;UndefinedFunctionError{
  arity: 2,
  function: :put_options,
  message: nil,
  module: Absinthe.Plug,
  reason: nil
}
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I had to add &lt;code&gt;:absinthe_plug&lt;/code&gt; to the list of applications in &lt;code&gt;mix.exs&lt;/code&gt;. Afterwards, I got:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;%ArgumentError{
  message: &quot;The supplied schema: Api.GraphQL.Schema is not a valid Absinthe Schema&quot;
}
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Could this be because the database is empty? Let me set up the migrate script
that their documentation mentions.&lt;/p&gt;

&lt;p&gt;I created the &lt;code&gt;lib/api/release.ex&lt;/code&gt; module, and added an &lt;code&gt;entrypoint.sh&lt;/code&gt; file with the following:&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;c&quot;&gt;#!/usr/bin/env sh&lt;/span&gt;

bin/api &lt;span class=&quot;nb&quot;&gt;eval&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;Api.Release.migrate&quot;&lt;/span&gt;
bin/api start
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Running this, I get:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;** (Postgrex.Error) ERROR 42501 (insufficient_privilege)
   permission denied for table schema_migrations
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Well, I obviously didn’t setup this properly. I created the user but didn’t
give the appropriate grants.&lt;/p&gt;

&lt;p&gt;I ended up dropping the database and creating it as owned by the user &lt;code&gt;mob&lt;/code&gt;. I
also made the user a super user, since some of the migrations need to install
extensions. Yay for that. These are the commands I used:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/m/api$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;createdb -O mob mob-api
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/m/api$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;psql
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto=# &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;alter user mob with superuser;
&lt;/span&gt;ALTER ROLE
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This was enough to get the migrations to run without errors, but I’m still
getting the same error. I looked at the code that produces the error message
&lt;code&gt;The supplied schema: Api.GraphQL.Schema is not a valid Absinthe Schema&lt;/code&gt;, and
it looks something like this:&lt;/p&gt;

&lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;  &lt;span class=&quot;k&quot;&gt;defp&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get_schema&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;opts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;default&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Application&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;get_env&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:absinthe&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:schema&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;schema&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Keyword&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;opts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:schema&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
      &lt;span class=&quot;no&quot;&gt;Absinthe&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Schema&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;types&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;schema&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;rescue&lt;/span&gt;
      &lt;span class=&quot;no&quot;&gt;UndefinedFunctionError&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;raise&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ArgumentError&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
              &lt;span class=&quot;s2&quot;&gt;&quot;The supplied schema: &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;inspect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;schema&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; is not a valid Absinthe Schema&quot;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;schema&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So there’s an &lt;code&gt;UndefinedFunctionError&lt;/code&gt; being thrown, and absinthe hides it
under an &lt;code&gt;ArgumentError&lt;/code&gt;. I was getting those undefined errors when modules
were missing from the application list, so maybe I’m still missing an entry
there. I’ll take a look at the deps and at the applications being loaded to see
if there’s something obvious missing.&lt;/p&gt;

&lt;p&gt;It worked. I added &lt;code&gt;:absinthe&lt;/code&gt; and &lt;code&gt;:absinthe_ecto&lt;/code&gt; and it started working.
Good thing I looked at the code, it helped me find that exception swallowing
pattern:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/absinthe-graphql/absinthe_plug/blob/6696af35dcce5f47c3647744924fcb132b9b6231/lib/absinthe/plug.ex#L233&quot;&gt;https://github.com/absinthe-graphql/absinthe_plug/blob/6696af35dcce5f47c3647744924fcb132b9b6231/lib/absinthe/plug.ex#L233&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I can now see Graph&lt;em&gt;i&lt;/em&gt;QL on &lt;code&gt;http://localhost:4000/graphiql&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;I added some dummy editions to the &lt;code&gt;editions&lt;/code&gt; table:&lt;/p&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;INSERT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;INTO&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;editions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;VALUES&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;uuid_generate_v4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;2018&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;uuid_generate_v4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;2019&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And tried reading them with the query:&lt;/p&gt;

&lt;div class=&quot;language-graphql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bots&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Executing this only displayed an empty string in the results pane, but I did get an exception in the console:&lt;/p&gt;

&lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;p&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;FunctionClauseError&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;ss&quot;&gt;args:&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;ss&quot;&gt;arity:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;ss&quot;&gt;clauses:&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;ss&quot;&gt;function:&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:call&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;ss&quot;&gt;kind:&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;ss&quot;&gt;module:&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Api&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;GraphQL&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Middleware&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;RequireAdmin&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This query requires an admin API token, but I’m wondering why it blows up with
a &lt;code&gt;500&lt;/code&gt; instead of returning a proper error. To check if I will be fixing
something that was already broken, I’ll run this query against production:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;curl https://api.makeorbreak.io/graphql \
&amp;gt; -X POST \
&amp;gt; -H &quot;Content-Type: application/json&quot; \
&amp;gt; -d &#39;{&quot;query&quot;:&quot;{ bots { id } }&quot;}&#39; | jq
&lt;/span&gt;{
  &quot;errors&quot;: [
    {
      &quot;path&quot;: [
        &quot;bots&quot;
      ],
      &quot;message&quot;: &quot;using this field requires authentication&quot;,
      &quot;locations&quot;: [
        {
          &quot;line&quot;: 1,
          &quot;column&quot;: 0
        }
      ]
    }
  ],
  &quot;data&quot;: {
    &quot;bots&quot;: null
  }
}
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This seems to be returning a sane response (for a graphql response, anyway),
returning &lt;code&gt;200 OK&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;So this might mean that the &lt;code&gt;RequireAdmin&lt;/code&gt; module needs updating. Let’s look at
&lt;code&gt;RequireAdmin&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;defmodule&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;RequireAdmin&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;@behaviour&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Absinthe&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Middleware&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(%{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;context:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;%{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;current_user:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;User&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;role:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;admin&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}}}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;resolution&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;resolution&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(%{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;context:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;%{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;current_user:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;User&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;role:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;participant&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}}}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;resolution&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;resolution&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;|&amp;gt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Resolution&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;put_result&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;({&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;%{&lt;/span&gt;
      &lt;span class=&quot;ss&quot;&gt;message:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;you do not have permission to access this field&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}})&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(%{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;context:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;%{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;current_user:&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;resolution&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;resolution&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;|&amp;gt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Resolution&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;put_result&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;({&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;%{&lt;/span&gt;
      &lt;span class=&quot;ss&quot;&gt;message:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;using this field requires authentication&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}})&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is implementing an &lt;code&gt;Absinthe.Middleware&lt;/code&gt;. What seems to be happening is
that there’s no matching &lt;code&gt;call&lt;/code&gt; signature. Looking for the place where the
&lt;code&gt;current_user&lt;/code&gt; is injected in the context, I found this:&lt;/p&gt;

&lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;defmodule&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Api&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;GraphQL&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;GuardianContext&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;@behaviour&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Plug&lt;/span&gt;

  &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Plug&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Conn&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;init&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;opts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;opts&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;context&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;build_context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;no&quot;&gt;Absinthe&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Plug&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;put_options&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;context:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;nv&quot;&gt;@doc&lt;/span&gt; &lt;span class=&quot;sd&quot;&gt;&quot;&quot;&quot;
  Return the current user context based on the authorization header
  &quot;&quot;&quot;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;build_context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;with&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Bearer &quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;token&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get_req_header&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;authorization&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
         &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;current_user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_claims&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ApiWeb&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Guardian&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;resource_from_token&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;token&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;%{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;current_user:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;current_user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;%{}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I suspect that we used to return &lt;code&gt;%{current_user: nil}&lt;/code&gt;. Checking the old code:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/makeorbreak-io/mob-api/blob/master/lib/api/graphql/plugs.ex#L16&quot;&gt;https://github.com/makeorbreak-io/mob-api/blob/master/lib/api/graphql/plugs.ex#L16&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_opts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;|&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;put_private&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;ss&quot;&gt;:absinthe&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;%{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;context:&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;%{&lt;/span&gt;
        &lt;span class=&quot;ss&quot;&gt;current_user:&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;GuardianPlug&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;current_resource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This confirms my suspicion. I changed the &lt;code&gt;else&lt;/code&gt; clause to &lt;code&gt;_ -&amp;gt;
%{current_user: nil}&lt;/code&gt; and the &lt;code&gt;500&lt;/code&gt; is gone. Here’s the pull request:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/makeorbreak-io/api/pull/12&quot;&gt;https://github.com/makeorbreak-io/api/pull/12&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Now let’s try to get authenticated.&lt;/p&gt;

&lt;h2 id=&quot;registering-an-account-mutations-and-email-sending&quot;&gt;Registering an account: mutations and email sending&lt;/h2&gt;

&lt;p&gt;There’s a something related to registering users in
&lt;code&gt;Api.GraphQL.Mutations.Session&lt;/code&gt;, a field &lt;code&gt;:register&lt;/code&gt;. I suppose I need to use
this to register an account. This is what I tried:&lt;/p&gt;

&lt;div class=&quot;language-graphql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;mutation&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;register&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;email&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;hugo.peixoto@gmail.com&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;password&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;secret&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And I got this:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;** (UndefinedFunctionError) function Argon2.hash_pwd_salt/1 is undefined
   (module Argon2 is not available)
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Another application missing. Why is this missing so many applications? Why
doesn’t this happen in development mode? After adding argon2, I got the same
error for &lt;code&gt;:premailex&lt;/code&gt;. After adding those, I got this:&lt;/p&gt;

&lt;div class=&quot;language-json highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;data&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;register&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;errors&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;exception&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;code&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;unknown_reason&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;param&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;email&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;locations&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
          &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;column&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
          &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;line&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;message&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;unknown_reason&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;path&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;register&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And no stacktrace to help. I’m guessing this might be related to the lack of
email provider configuration. We have this set to use Mailgun in production and
&lt;code&gt;Bamboo.LocalAdapter&lt;/code&gt; in development. I’ll temporarily set the production
adapter to &lt;code&gt;LocalAdapter&lt;/code&gt; as well, just to see if it works.&lt;/p&gt;

&lt;p&gt;Turns out the error was much simpler: I had already registered that account
before. Maybe I double clicked or something, not sure. After truncating the
users table, I’m getting this error:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;** (MatchError) no match of right hand side value: {:error, :secret_not_found}
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This was because &lt;code&gt;SECRET_KEY_BASE&lt;/code&gt; was being set in &lt;code&gt;config/config.exs&lt;/code&gt;, which
is evaluated at build time instead of runtime, leading the value to be &lt;code&gt;nil&lt;/code&gt;. I
moved it to &lt;code&gt;config/release.exs&lt;/code&gt; and it worked.&lt;/p&gt;

&lt;p&gt;I was able to go to &lt;code&gt;http://localhost:4000/sent_emails&lt;/code&gt; and see a preview of
the email that would have been sent.&lt;/p&gt;

&lt;p&gt;I’ll stop for now.&lt;/p&gt;

&lt;h2 id=&quot;summary&quot;&gt;Summary&lt;/h2&gt;

&lt;p&gt;I needed to make an phoenix/elixir project deployable. The project was from
2017, and not much care was given to make sure it was up to date. The
deployment story was messy and not ideal.&lt;/p&gt;

&lt;p&gt;I’ve set up a docker image and used the Elixir Releases feature to create a
standalone compiled version of the app. There were some issues with the
configuration files, and some issues with missing dependent applications.&lt;/p&gt;

&lt;p&gt;I still need to do some config tweaking, but other than that, the docker image
is ready to go. I’ll be able to set up a staging environment, which was my main
goal.&lt;/p&gt;

&lt;p&gt;I checked how much memory the docker container was taking, to have a rough idea
of the requirements for this:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/m/mob-api$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;docker stats upbeat_dewdney --no-stream --format=&quot;{{.MemUsage}}&quot;
&lt;/span&gt;96.5MiB / 7.709GiB
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;code&gt;~100MiB&lt;/code&gt;, this gives me a round number to work with. I had one of these
running for a day, and it reported &lt;code&gt;22MiB&lt;/code&gt;, probably because most of it got
paged out. Not sure what &lt;code&gt;docker stats&lt;/code&gt; reports, but that’s for another day.&lt;/p&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2020-05-21:/articles/asdf-presentation.html</id>
    <title type="html">Video presentation on asdf</title>
    <published>2020-05-21T00:00:00Z</published>
    <updated>2020-05-21T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/asdf-presentation.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;I did a lightning talk about asdf, at Porto Codes&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;p&gt;I did a lighting presentation on &lt;a href=&quot;https://asdf-vm.com&quot;&gt;asdf&lt;/a&gt;, at Porto Codes.
The recording is now available on youtube (in portuguese):&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://www.youtube.com/watch?v=RaMRU4MVm5g&quot;&gt;https://www.youtube.com/watch?v=RaMRU4MVm5g&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;asdf-vm is a CLI tool that can manage multiple language runtime versions on a
per-project basis. It is like gvm, nvm, rbenv &amp;amp; pyenv (and more) all in one!
Simply install your language’s plugin!&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;You should also check out the other talks published by Porto codes:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://twitter.com/portocodes&quot;&gt;https://twitter.com/portocodes&lt;/a&gt;&lt;/p&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2020-05-17:/articles/2020-05-17.html</id>
    <title type="html">Fixing ruby 2.7 warnings in third party gems</title>
    <published>2020-05-17T00:00:00Z</published>
    <updated>2020-05-17T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/2020-05-17.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;I use a lot of third party gems, and not all of them have been fixed to support ruby 2.7. In this post I go through the process of fixing warnings in one of those gems, aws-sdk-s3.&lt;/p&gt;
]]>
    </summary>
    <content type="html">
      <![CDATA[
        <aside>
          This is a <code>[journal]</code> entry. It is longer than usual and
          more exploratory. It may have no proper conclusion.
        </aside>
      ]]>

      &lt;p&gt;I’m working on a &lt;a href=&quot;https://makeorbreak.io&quot;&gt;Make or Break&lt;/a&gt; project, and it depends on some gems:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;n&quot;&gt;gem&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;activesupport&quot;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;gem&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;aws-sdk-s3&quot;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;gem&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;aws-sdk-sqs&quot;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;gem&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;dotenv&quot;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;gem&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;foreman&quot;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;gem&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;httparty&quot;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;gem&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;minitest&quot;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;gem&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;rack-test&quot;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;gem&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;rake&quot;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;gem&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;rlua&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;git: &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;https://github.com/whitequark/rlua&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;branch: &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;master&quot;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;gem&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;sinatra&quot;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;gem&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;zeitwerk&quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I was using ruby 2.6 at the time, but since 2.7 is out, I bumped it.
This led to some warnings when running tests:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;[...]/aws-sdk-s3-1.64.0/lib/aws-sdk-s3/plugins/expect_100_continue.rb:16: warning: `if&#39; at the end of line without an expression
[...]/aws-sdk-s3-1.64.0/lib/aws-sdk-s3/plugins/http_200_errors.rb:30: warning: character class has duplicated range: /&amp;lt;[\w_]/

[...]/aws-sdk-s3-1.64.0/lib/aws-sdk-s3/resource.rb:75: warning: assigned but unused variable - resp
[...]/aws-sdk-s3-1.64.0/lib/aws-sdk-s3/bucket.rb:523: warning: assigned but unused variable - resp
[...]/aws-sdk-s3-1.64.0/lib/aws-sdk-s3/multipart_upload.rb:277: warning: assigned but unused variable - resp

[...]/aws-sdk-s3-1.64.0/lib/aws-sdk-s3/customizations/bucket.rb:9: warning: method redefined; discarding old initialize
[...]/aws-sdk-s3-1.64.0/lib/aws-sdk-s3/bucket.rb:20: warning: previous definition of initialize was here

[...]/aws-sdk-s3-1.64.0/lib/aws-sdk-s3/customizations/object.rb:62: warning: method redefined; discarding old copy_from
[...]/aws-sdk-s3-1.64.0/lib/aws-sdk-s3/object.rb:662: warning: previous definition of copy_from was here

[...]/aws-sdk-s3-1.64.0/lib/aws-sdk-s3/customizations/object_summary.rb:11: warning: method redefined; discarding old copy_from
[...]/aws-sdk-s3-1.64.0/lib/aws-sdk-s3/object_summary.rb:413: warning: previous definition of copy_from was here
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;aws-sdk-ruby-warnings&quot;&gt;aws-sdk-ruby warnings&lt;/h2&gt;

&lt;h3 id=&quot;small-manual-fixes&quot;&gt;Small manual fixes&lt;/h3&gt;

&lt;p&gt;I checked the first file, to see if this was something hard to fix:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;http_request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;body&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;http_request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;body&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;size&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;http_request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;headers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;expect&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;100-continue&#39;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;vi&quot;&gt;@handler&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It seems like this one is easy. There are some “unused variable” warnings and
“duplicated range” that should be easy to fix as well.&lt;/p&gt;

&lt;p&gt;Before starting to mess with code, I checked the project’s master branch,
issues and pull requests to see if someone had already mentioned or fixed some
of these. I found nothing.&lt;/p&gt;

&lt;p&gt;The first error was an easy fix. I changed that if statement to:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;http_request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;body&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;http_request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;body&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;size&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;http_request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;headers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;expect&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;100-continue&#39;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;vi&quot;&gt;@handler&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The second error was complaining that &lt;code&gt;[\w_]&lt;/code&gt; was redundant. &lt;code&gt;\w&lt;/code&gt; is equivalent
to &lt;code&gt;[a-zA-Z0-9_]&lt;/code&gt;, so the underscore is already included. We can change this as well:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;c1&quot;&gt;# from&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;xml&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;match&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;sr&quot;&gt;/&amp;lt;[\w_]/&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# to&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;xml&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;match&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;sr&quot;&gt;/&amp;lt;\w/&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The following three warnings were all the same: &lt;code&gt;assigned but unused variable -
resp&lt;/code&gt;. These came from code like this:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;create_bucket&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;options&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{})&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;resp&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;vi&quot;&gt;@client&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;create_bucket&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;options&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;no&quot;&gt;Bucket&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;ss&quot;&gt;name: &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;options&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:bucket&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
    &lt;span class=&quot;ss&quot;&gt;client: &lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@client&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I just removed the &lt;code&gt;resp&lt;/code&gt;. Maybe here they’ll want to do something with &lt;code&gt;resp&lt;/code&gt;,
but if I end up creating a pull request, they’ll let me know.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Note: I’m about to find out that I shouldn’t be editing these files, and
&lt;code&gt;resp&lt;/code&gt; will start to make sense.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;The following three warnings (six lines) are probably going to be a bit harder
to fix. Let’s look at the first one:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;[...]/aws-sdk-s3-1.64.0/lib/aws-sdk-s3/customizations/bucket.rb:9: warning: method redefined; discarding old initialize
[...]/aws-sdk-s3-1.64.0/lib/aws-sdk-s3/bucket.rb:20: warning: previous definition of initialize was here
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;From just looking at the errors, it seems like &lt;code&gt;bucket.rb&lt;/code&gt; is defining an
initializer and there’s an override, through a &lt;code&gt;customizations&lt;/code&gt; mechanism. This
might be because there’s some code generation going on. Not sure.&lt;/p&gt;

&lt;p&gt;Yep. I was manually editing files that are automatically generated. Checking
the header of &lt;code&gt;aws-sdk-s3-1.64.0/lib/aws-sdk-s3/resource.rb&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;c1&quot;&gt;# WARNING ABOUT GENERATED CODE&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;#&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# This file is generated. See the contributing guide for more information:&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# https://github.com/aws/aws-sdk-ruby/blob/master/CONTRIBUTING.md&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;#&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# WARNING ABOUT GENERATED CODE&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This explains a lot. So, most of the files here are generated by generic build
tools, and their behavior gets overriden by the &lt;code&gt;customizations/&lt;/code&gt; directory.&lt;/p&gt;

&lt;p&gt;This explains why the &lt;code&gt;resp&lt;/code&gt; variable was being set. It was potentially
generated by code that did not know in advance if the response was going to be
used or not.&lt;/p&gt;

&lt;h3 id=&quot;unused-variables-in-code-generator&quot;&gt;Unused variables in code generator&lt;/h3&gt;

&lt;p&gt;Let’s check the code generator. First, let’s see if I can find any information
on how to run it.&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/c/aws-sdk-ruby$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;ack build_tools --ignore-file=is:CHANGELOG.md
&lt;/span&gt;tasks/test.rake
24:  sh(&#39;bundle exec rspec build_tools/aws-sdk-code-generator/spec&#39;)

CONTRIBUTING.md
13:* Errors in the code generators. These are defined in [build_tools](https://github.com/aws/aws-sdk-ruby/blob/master/build_tools).

Rakefile
5:$:.unshift(&quot;#{$REPO_ROOT}/build_tools&quot;)
6:$:.unshift(&quot;#{$REPO_ROOT}/build_tools/aws-sdk-code-generator/lib&quot;)
12:require &#39;build_tools&#39;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So there may be a rake task that handles this.&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/c/aws-sdk-ruby$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;rake -T
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;rake build            # &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;Generates the code for every service
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;rake build:aws-sdk-*  # &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;Generates the code for one service, e.g
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;rake gems             # &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;Builds service gems
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;rake test             # &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;Runs unit and integration tests after rebuilding gems
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;rake test:features    # &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;Executes integration tests
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;rake test:spec        # &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;Execute spec tests
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;rake test:spec:*      # &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;Executes specs for a single gem, e.g
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;rake test:spec:each   # &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;Executes every spec file, one at a time
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Let me try running the build task for &lt;code&gt;aws-sdk-s3&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/c/aws-sdk-ruby$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;bundle
&lt;/span&gt;[snip]
&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/c/aws-sdk-ruby$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;bundle exec rake build:aws-sdk-s3
&lt;/span&gt;replace gems/aws-sdk-s3/aws-sdk-s3.gemspec
replace gems/aws-sdk-s3/features/env.rb
skip gems/aws-sdk-s3/features/step_definitions.rb
replace gems/aws-sdk-s3/spec/spec_helper.rb
replace gems/aws-sdk-s3/features/smoke.feature
replace gems/aws-sdk-s3/features/smoke_step_definitions.rb
skip gems/aws-sdk-s3/VERSION
replace gems/aws-sdk-s3/lib/aws-sdk-s3.rb
skip gems/aws-sdk-s3/lib/aws-sdk-s3/customizations.rb
replace gems/aws-sdk-s3/lib/aws-sdk-s3/types.rb
replace gems/aws-sdk-s3/lib/aws-sdk-s3/event_streams.rb
replace gems/aws-sdk-s3/lib/aws-sdk-s3/client_api.rb
replace gems/aws-sdk-s3/lib/aws-sdk-s3/client.rb
replace gems/aws-sdk-s3/lib/aws-sdk-s3/errors.rb
replace gems/aws-sdk-s3/lib/aws-sdk-s3/waiters.rb
replace gems/aws-sdk-s3/lib/aws-sdk-s3/resource.rb
replace gems/aws-sdk-s3/lib/aws-sdk-s3/bucket.rb
replace gems/aws-sdk-s3/lib/aws-sdk-s3/bucket_acl.rb
replace gems/aws-sdk-s3/lib/aws-sdk-s3/bucket_cors.rb
replace gems/aws-sdk-s3/lib/aws-sdk-s3/bucket_lifecycle.rb
replace gems/aws-sdk-s3/lib/aws-sdk-s3/bucket_lifecycle_configuration.rb
replace gems/aws-sdk-s3/lib/aws-sdk-s3/bucket_logging.rb
replace gems/aws-sdk-s3/lib/aws-sdk-s3/bucket_notification.rb
replace gems/aws-sdk-s3/lib/aws-sdk-s3/bucket_policy.rb
replace gems/aws-sdk-s3/lib/aws-sdk-s3/bucket_request_payment.rb
replace gems/aws-sdk-s3/lib/aws-sdk-s3/bucket_tagging.rb
replace gems/aws-sdk-s3/lib/aws-sdk-s3/bucket_versioning.rb
replace gems/aws-sdk-s3/lib/aws-sdk-s3/bucket_website.rb
replace gems/aws-sdk-s3/lib/aws-sdk-s3/multipart_upload.rb
replace gems/aws-sdk-s3/lib/aws-sdk-s3/multipart_upload_part.rb
replace gems/aws-sdk-s3/lib/aws-sdk-s3/object.rb
replace gems/aws-sdk-s3/lib/aws-sdk-s3/object_acl.rb
replace gems/aws-sdk-s3/lib/aws-sdk-s3/object_summary.rb
replace gems/aws-sdk-s3/lib/aws-sdk-s3/object_version.rb
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Running this did undo my changes to &lt;code&gt;resource.rb&lt;/code&gt;, &lt;code&gt;bucket.rb&lt;/code&gt;, and
&lt;code&gt;multipart_upload.rb&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;After grepping for “resp =” and “@client” inside &lt;code&gt;build_tools&lt;/code&gt;, I found
&lt;code&gt;AwsSdkCodeGenerator::ResourceClientRequest&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;c1&quot;&gt;# @option options [required, Hash] :request&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# @option options [Boolean] :resp (false)&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# @option options [Boolean] :merge (true)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;build&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;options&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;request&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;options&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;fetch&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;merge&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;options&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;fetch&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:merge&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;streaming&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;options&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;fetch&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:streaming&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;params&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ResourceClientRequestParams&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;params: &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;params&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;request_options&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;params&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;merge&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;assignment&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;options&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;@client.&quot;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;operation_name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;arguments&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;merge&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;params&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;streaming&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;join&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;assignment&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;options&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;options&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;fetch&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:resp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;s1&quot;&gt;&#39;resp = &#39;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
    &lt;span class=&quot;s1&quot;&gt;&#39;&#39;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It seems like this could be related to the code I’m looking for. It’s building
a resource request, with an optional &lt;code&gt;resp = &lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Looking around for what might be passing this option, I found this:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/c/aws-sdk-ruby$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;ack &#39;resp:&#39;
&lt;/span&gt;build_tools/aws-sdk-code-generator/lib/aws-sdk-code-generator/resource_action_code.rb
31:      ResourceClientRequest.build(request: @request, resp: true, streaming: @streaming)
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;module&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;AwsSdkCodeGenerator&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;ResourceActionCode&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;initialize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;options&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;action&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;options&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;fetch&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:action&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;vi&quot;&gt;@request&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;action&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;fetch&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;request&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;vi&quot;&gt;@resource&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;action&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;fetch&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;resource&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;vi&quot;&gt;@streaming&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;options&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;fetch&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:streaming&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;build&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;batch_action?&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;batch = []&#39;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;client_request&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ResourceBatchBuilder&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;resource: &lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@resource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;build&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;resource_type&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;::Collection.new([batch], size: batch.size)&quot;&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;elsif&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;resource_action?&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;client_request&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ResourceBuilder&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;resource: &lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@resource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;request_made: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;build&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;client_request&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;resp.data&#39;&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;join&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;rstrip&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

    &lt;span class=&quot;kp&quot;&gt;private&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;client_request&lt;/span&gt;
      &lt;span class=&quot;no&quot;&gt;ResourceClientRequest&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;build&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;request: &lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;resp: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;streaming: &lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@streaming&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# ...&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Let me check if this is the code I’m supposed to be looking at. I’m going to
add a random &lt;code&gt;part&lt;/code&gt; and see what happens when I run the rake task again.&lt;/p&gt;

&lt;p&gt;It worked. I changed this:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;c1&quot;&gt;# from&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;elsif&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;resource_action?&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;client_request&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ResourceBuilder&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;resource: &lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@resource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;request_made: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;build&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# to&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;elsif&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;resource_action?&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;client_request&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ResourceBuilder&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;resource: &lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@resource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;request_made: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;build&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;hello&quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And now &lt;code&gt;bucket.rb:523&lt;/code&gt; looks like this:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;put_object&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;options&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{})&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;options&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;options&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;merge&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;bucket: &lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;resp&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;vi&quot;&gt;@client&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;put_object&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;options&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;no&quot;&gt;Object&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;ss&quot;&gt;bucket_name: &lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;ss&quot;&gt;key: &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;options&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
    &lt;span class=&quot;ss&quot;&gt;client: &lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@client&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;hello&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So this means that &lt;code&gt;client_request&lt;/code&gt; generates &lt;code&gt;resp =
@client.put_object(options)&lt;/code&gt; and &lt;code&gt;ResourceBuilder.new.build&lt;/code&gt; generates the
&lt;code&gt;Object.new&lt;/code&gt; statement.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;client_request&lt;/code&gt; is used in all three branches: batch, resource, and other. I
checked a batch example (&lt;code&gt;multipart.rb#parts&lt;/code&gt;) and it does use &lt;code&gt;resp&lt;/code&gt;. the
&lt;code&gt;else&lt;/code&gt; clause also uses &lt;code&gt;resp&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Maybe &lt;code&gt;resp: true&lt;/code&gt; should not be set in the &lt;code&gt;resource_action?&lt;/code&gt; clause. Let m e
check the &lt;code&gt;ResourceBuilder&lt;/code&gt; code to see if it can potentially generate any code
using &lt;code&gt;resp&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Checked
&lt;code&gt;build_tools/aws-sdk-code-generator/lib/aws-sdk-code-generator/resource_builder.rb&lt;/code&gt;,
and I saw no references to &lt;code&gt;resp&lt;/code&gt;. Let’s try this. I’ll make the following
change:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;c1&quot;&gt;# from&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;build&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;batch_action?&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;batch = []&#39;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;client_request&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ResourceBatchBuilder&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;resource: &lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@resource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;build&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;resource_type&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;::Collection.new([batch], size: batch.size)&quot;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;elsif&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;resource_action?&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;client_request&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ResourceBuilder&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;resource: &lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@resource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;request_made: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;build&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;client_request&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;resp.data&#39;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;join&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;rstrip&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;kp&quot;&gt;private&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;client_request&lt;/span&gt;
  &lt;span class=&quot;no&quot;&gt;ResourceClientRequest&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;build&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;request: &lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;resp: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;streaming: &lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@streaming&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# to&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;build&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;batch_action?&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;batch = []&#39;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;client_request&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ResourceBatchBuilder&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;resource: &lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@resource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;build&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;resource_type&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;::Collection.new([batch], size: batch.size)&quot;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;elsif&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;resource_action?&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;client_request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ResourceBuilder&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;resource: &lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@resource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;request_made: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;build&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;client_request&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;resp.data&#39;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;join&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;rstrip&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;kp&quot;&gt;private&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;client_request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;resp&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;no&quot;&gt;ResourceClientRequest&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;build&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;request: &lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;resp: &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;resp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;streaming: &lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@streaming&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Running the rake task again and going a &lt;code&gt;git diff&lt;/code&gt; showed me that it removed
&lt;strong&gt;five&lt;/strong&gt; &lt;code&gt;resp&lt;/code&gt;s, when it should only have removed three. Oops.&lt;/p&gt;

&lt;p&gt;The two extra ones where in &lt;code&gt;object.rb&lt;/code&gt; and &lt;code&gt;object_summary.rb&lt;/code&gt;, both in the
method &lt;code&gt;initiate_multipart_upload&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;initiate_multipart_upload&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;options&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{})&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;options&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;options&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;merge&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;ss&quot;&gt;bucket: &lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@bucket_name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;ss&quot;&gt;key: &lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@key&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;vi&quot;&gt;@client&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;create_multipart_upload&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;options&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;no&quot;&gt;MultipartUpload&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;ss&quot;&gt;bucket_name: &lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@bucket_name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;ss&quot;&gt;object_key: &lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;ss&quot;&gt;id: &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;resp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;upload_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;ss&quot;&gt;client: &lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@client&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Where did that come from? Maybe I didn’t check &lt;code&gt;resource_builder.rb&lt;/code&gt;
thoroughly. Let me look again:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;module&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;AwsSdkCodeGenerator&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;ResourceBuilder&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# @option options [required, Hash] :resource&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# @option options [required, Boolean] :request_made&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;initialize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;options&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{})&lt;/span&gt;
      &lt;span class=&quot;vi&quot;&gt;@resource&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;options&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;fetch&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:resource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;vi&quot;&gt;@request_made&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;options&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;fetch&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:request_made&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;build&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;resource_class&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;.new(&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;constructor_options&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;)&quot;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

    &lt;span class=&quot;kp&quot;&gt;private&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;resource_class&lt;/span&gt;
      &lt;span class=&quot;vi&quot;&gt;@resource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;type&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;constructor_options&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;options&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;options&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;update&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;identifiers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;options&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;data_path&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;vi&quot;&gt;@resource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;path&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;options&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:client&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;@client&quot;&lt;/span&gt;
      &lt;span class=&quot;no&quot;&gt;HashFormatter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;wrap&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;options&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;identifiers&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@resource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;identifiers&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;inject&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;({})&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;hash&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;identifier&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ResourceValueSource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;identifier&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;to_s&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;hash&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Underscore&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;underscore&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;identifier&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;target&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;to_sym&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;hash&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;data_path&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;vi&quot;&gt;@request_made&lt;/span&gt;
        &lt;span class=&quot;no&quot;&gt;ResourceValueSource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;source&#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;response&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;path&#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;vi&quot;&gt;@resource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;path&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
        &lt;span class=&quot;no&quot;&gt;ResourceValueSource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;source&#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;data&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;path&#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;vi&quot;&gt;@resource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;path&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So we have an &lt;code&gt;id&lt;/code&gt; option in the constructor, which seems to be generated from
&lt;code&gt;constructor_options&lt;/code&gt;. The &lt;code&gt;id&lt;/code&gt; option probably comes from the &lt;code&gt;identifiers&lt;/code&gt;
method, which is generated based on &lt;code&gt;@resource[&#39;identifiers&#39;]&lt;/code&gt;. Does
&lt;code&gt;ResourceValueSource.new(identifier).to_s&lt;/code&gt; always generate something based on
&lt;code&gt;resp&lt;/code&gt;?&lt;/p&gt;

&lt;p&gt;Looking at
&lt;code&gt;build_tools/aws-sdk-code-generator/lib/aws-sdk-code-generator/resource_value_source.rb&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;This class inherits from &lt;code&gt;String&lt;/code&gt;, which sounds super fun. It references
&lt;code&gt;resp.data&lt;/code&gt; in the &lt;code&gt;param_response&lt;/code&gt; method, which seems to be called when the
passed &lt;code&gt;identifier&lt;/code&gt; has &lt;code&gt;&quot;source&quot; =&amp;gt; &quot;response&quot;&lt;/code&gt;. Let’s use this knowledge to
change the way we call &lt;code&gt;client_request&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;build&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;batch_action?&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;batch = []&#39;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;client_request&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ResourceBatchBuilder&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;resource: &lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@resource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;build&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;resource_type&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;::Collection.new([batch], size: batch.size)&quot;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;elsif&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;resource_action?&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;client_request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@resource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;identifiers&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;any?&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;source&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;response&#39;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ResourceBuilder&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;resource: &lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@resource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;request_made: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;build&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;client_request&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;resp.data&#39;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;join&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;rstrip&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Running the rake task again restored those two stray &lt;code&gt;resp = &lt;/code&gt; removals. I am
only running this for &lt;code&gt;aws-sdk-s3&lt;/code&gt;, I’m not sure if this won’t remove any
&lt;code&gt;resp&lt;/code&gt;s in other gems. Let me try with &lt;code&gt;sqs&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/c/aws-sdk-ruby$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;bundle exec rake build:aws-sdk-sqs
&lt;/span&gt;[...]
&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/c/aws-sdk-ruby$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;git diff gems/aws-sdk-sqs/
&lt;/span&gt;hugopeixoto@laptop:~/w/c/aws-sdk-ruby$
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This produced no changes. I’ll take this as a good sign. Let’s run the full thing:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/c/aws-sdk-ruby$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;bundle exec rake build
&lt;/span&gt;[...]
[... taking a while ...]
&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/c/aws-sdk-ruby$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;git status -s
&lt;/span&gt;M build_tools/aws-sdk-code-generator/lib/aws-sdk-code-generator/resource_action_code.rb
M gems/aws-sdk-autoscaling/lib/aws-sdk-autoscaling/auto_scaling_group.rb
M gems/aws-sdk-autoscaling/lib/aws-sdk-autoscaling/resource.rb
M gems/aws-sdk-cloudformation/lib/aws-sdk-cloudformation/resource.rb
M gems/aws-sdk-cloudwatch/lib/aws-sdk-cloudwatch/metric.rb
M gems/aws-sdk-dynamodb/lib/aws-sdk-dynamodb/table.rb
M gems/aws-sdk-ec2/lib/aws-sdk-ec2/resource.rb
M gems/aws-sdk-ec2/lib/aws-sdk-ec2/route_table.rb
M gems/aws-sdk-glacier/lib/aws-sdk-glacier/account.rb
M gems/aws-sdk-glacier/lib/aws-sdk-glacier/resource.rb
M gems/aws-sdk-iam/lib/aws-sdk-iam/group.rb
M gems/aws-sdk-iam/lib/aws-sdk-iam/resource.rb
M gems/aws-sdk-iam/lib/aws-sdk-iam/server_certificate.rb
M gems/aws-sdk-iam/lib/aws-sdk-iam/user.rb
M gems/aws-sdk-rds/lib/aws-sdk-rds/resource.rb
M gems/aws-sdk-s3/aws-sdk-s3.gemspec
M gems/aws-sdk-s3/lib/aws-sdk-s3/bucket.rb
M gems/aws-sdk-s3/lib/aws-sdk-s3/multipart_upload.rb
M gems/aws-sdk-s3/lib/aws-sdk-s3/plugins/expect_100_continue.rb
M gems/aws-sdk-s3/lib/aws-sdk-s3/plugins/http_200_errors.rb
M gems/aws-sdk-s3/lib/aws-sdk-s3/resource.rb
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Let’s see if everything is correct.&lt;/p&gt;

&lt;p&gt;It isn’t. It removed some &lt;code&gt;data&lt;/code&gt; entries that are still being used. For example:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/c/aws-sdk-ruby$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;git diff -U5 gems/aws-sdk-dynamodb/lib/aws-sdk-dynamodb/table.rb
&lt;/span&gt;diff --git a/gems/aws-sdk-dynamodb/lib/aws-sdk-dynamodb/table.rb b/gems/aws-sdk-dynamodb/lib/aws-sdk-dynamodb/table.rb
index be9d4a8cf..8dacfa214 100644
--- a/gems/aws-sdk-dynamodb/lib/aws-sdk-dynamodb/table.rb
+++ b/gems/aws-sdk-dynamodb/lib/aws-sdk-dynamodb/table.rb
@@ -1883,11 +1883,11 @@ module Aws::DynamoDB
&lt;span class=&quot;c&quot;&gt;     #
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;     # &lt;/span&gt;&lt;span class=&quot;w&quot;&gt;  &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;[1]: https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/globaltables.V2.html
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;     # &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;@return [Table]
&lt;/span&gt;     def update(options = {})
       options = options.merge(table_name: @name)
-      resp = @client.update_table(options)
+      @client.update_table(options)
       Table.new(
         name: @name,
         data: resp.data.table_description,
         client: @client
       )
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I fixed the identifiers conditional, but the &lt;code&gt;data&lt;/code&gt; key also uses it. This is
easier to fix, since I now understand how &lt;code&gt;ResourceValueSource&lt;/code&gt; works, and I
know where &lt;code&gt;data:&lt;/code&gt; comes from:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;c1&quot;&gt;# resource_builder.rb:&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;constructor_options&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;options&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;options&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;update&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;identifiers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;options&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;data_path&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;vi&quot;&gt;@resource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;path&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;options&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:client&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;@client&quot;&lt;/span&gt;
  &lt;span class=&quot;no&quot;&gt;HashFormatter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;wrap&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;options&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# ...&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;data_path&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;vi&quot;&gt;@request_made&lt;/span&gt;
    &lt;span class=&quot;no&quot;&gt;ResourceValueSource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;source&#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;response&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;path&#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;vi&quot;&gt;@resource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;path&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
    &lt;span class=&quot;no&quot;&gt;ResourceValueSource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;source&#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;data&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;path&#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;vi&quot;&gt;@resource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;path&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So I’ll tweak the boolean a bit more:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;build&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;batch_action?&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;batch = []&#39;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;client_request&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ResourceBatchBuilder&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;resource: &lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@resource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;build&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;resource_type&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;::Collection.new([batch], size: batch.size)&quot;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;elsif&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;resource_action?&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;client_request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
      &lt;span class=&quot;vi&quot;&gt;@resource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;identifiers&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;any?&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;source&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;response&#39;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;vi&quot;&gt;@resource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;path&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ResourceBuilder&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;resource: &lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@resource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;request_made: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;build&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;client_request&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;resp.data&#39;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;parts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;join&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;rstrip&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Running the full rake task again:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/c/aws-sdk-ruby$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;git status -s
&lt;/span&gt;M build_tools/aws-sdk-code-generator/lib/aws-sdk-code-generator/resource_action_code.rb
M gems/aws-sdk-autoscaling/lib/aws-sdk-autoscaling/auto_scaling_group.rb
M gems/aws-sdk-autoscaling/lib/aws-sdk-autoscaling/resource.rb
M gems/aws-sdk-cloudformation/lib/aws-sdk-cloudformation/resource.rb
M gems/aws-sdk-cloudwatch/lib/aws-sdk-cloudwatch/metric.rb
M gems/aws-sdk-ec2/lib/aws-sdk-ec2/resource.rb
M gems/aws-sdk-ec2/lib/aws-sdk-ec2/route_table.rb
M gems/aws-sdk-glacier/lib/aws-sdk-glacier/account.rb
M gems/aws-sdk-glacier/lib/aws-sdk-glacier/resource.rb
M gems/aws-sdk-iam/lib/aws-sdk-iam/group.rb
M gems/aws-sdk-iam/lib/aws-sdk-iam/resource.rb
M gems/aws-sdk-iam/lib/aws-sdk-iam/server_certificate.rb
M gems/aws-sdk-iam/lib/aws-sdk-iam/user.rb
M gems/aws-sdk-s3/aws-sdk-s3.gemspec
M gems/aws-sdk-s3/lib/aws-sdk-s3/bucket.rb
M gems/aws-sdk-s3/lib/aws-sdk-s3/multipart_upload.rb
M gems/aws-sdk-s3/lib/aws-sdk-s3/plugins/expect_100_continue.rb
M gems/aws-sdk-s3/lib/aws-sdk-s3/plugins/http_200_errors.rb
M gems/aws-sdk-s3/lib/aws-sdk-s3/resource.rb
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Some of the changed files were restored, and I didn’t see anything weird when
looking through &lt;code&gt;git diff -U5&lt;/code&gt;. Looks good.&lt;/p&gt;

&lt;h3 id=&quot;redefinition-warnings-in-generated-code-overrides&quot;&gt;Redefinition warnings in generated code overrides&lt;/h3&gt;

&lt;p&gt;The three warnings left point to the &lt;code&gt;customizations&lt;/code&gt; directory redefining
methods created by the code generator:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;[...]/aws-sdk-s3-1.64.0/lib/aws-sdk-s3/customizations/bucket.rb:9: warning: method redefined; discarding old initialize
[...]/aws-sdk-s3-1.64.0/lib/aws-sdk-s3/bucket.rb:20: warning: previous definition of initialize was here

[...]/aws-sdk-s3-1.64.0/lib/aws-sdk-s3/customizations/object.rb:62: warning: method redefined; discarding old copy_from
[...]/aws-sdk-s3-1.64.0/lib/aws-sdk-s3/object.rb:662: warning: previous definition of copy_from was here

[...]/aws-sdk-s3-1.64.0/lib/aws-sdk-s3/customizations/object_summary.rb:11: warning: method redefined; discarding old copy_from
[...]/aws-sdk-s3-1.64.0/lib/aws-sdk-s3/object_summary.rb:413: warning: previous definition of copy_from was here
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I’m guessing this &lt;code&gt;customizations&lt;/code&gt; mechanism works by reopening the class, and
it’s being required after the generated code is required. Let’s see how the
mechanism works, in the &lt;code&gt;bucket.rb&lt;/code&gt; case:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;c1&quot;&gt;# gems/aws-sdk-s3/lib/aws-sdk-s3.rb`&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# [...]&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;require_relative&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;aws-sdk-s3/bucket&#39;&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# [... more requires ...]&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;require_relative&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;aws-sdk-s3/customizations&#39;&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;require_relative&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;aws-sdk-s3/event_streams&#39;&lt;/span&gt;


&lt;span class=&quot;c1&quot;&gt;# gems/aws-sdk-s3/lib/aws-sdk-s3/customizations.rb&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# [...]&lt;/span&gt;

&lt;span class=&quot;nb&quot;&gt;require&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;aws-sdk-s3/customizations/bucket&#39;&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;require&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;aws-sdk-s3/customizations/object&#39;&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;require&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;aws-sdk-s3/customizations/object_summary&#39;&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;require&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;aws-sdk-s3/customizations/multipart_upload&#39;&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;require&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;aws-sdk-s3/customizations/types/list_object_versions_output&#39;&lt;/span&gt;


&lt;span class=&quot;c1&quot;&gt;# gems/aws-sdk-s3/lib/aws-sdk-s3/customizations/bucket.rb`&lt;/span&gt;

&lt;span class=&quot;nb&quot;&gt;require&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;uri&#39;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;module&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;Aws&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;module&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;S3&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Bucket&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;# Save the old initialize method so that we can call &#39;super&#39;.&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;old_initialize&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;instance_method&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:initialize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;# Define a new initialize method that extracts out a bucket ARN.&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;define_method&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:initialize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;old_initialize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;bind&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;bucket_name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;region&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;arn&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Plugins&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;BucketARN&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;resolve_arn!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
          &lt;span class=&quot;nb&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
          &lt;span class=&quot;n&quot;&gt;client&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;region&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
          &lt;span class=&quot;n&quot;&gt;client&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;s3_use_arn_region&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;vi&quot;&gt;@name&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bucket_name&lt;/span&gt;
        &lt;span class=&quot;vi&quot;&gt;@client&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;region&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;region&lt;/span&gt;
        &lt;span class=&quot;vi&quot;&gt;@arn&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;arn&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

      &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So &lt;code&gt;aws-sdk-s3&lt;/code&gt; starts by loading the generated class, &lt;code&gt;aws-sdk-s3/bucket.rb&lt;/code&gt;
and then loads its customization, which calls &lt;code&gt;define_method(:initialize)&lt;/code&gt;,
with &lt;code&gt;initialize&lt;/code&gt; already defined. It does grab the previously existing method
in &lt;code&gt;old_initialize = instance_method(:initialize)&lt;/code&gt; so that it can call it in
the redefinition.&lt;/p&gt;

&lt;p&gt;I searched if there is a &lt;code&gt;redefine_method&lt;/code&gt; I could use, and rails does have a
helper method for this:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;redefine_method&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;method&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;block&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;visibility&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;method_visibility&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;method&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;silence_redefinition_of_method&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;method&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;define_method&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;method&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;block&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;nb&quot;&gt;send&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;visibility&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;method&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;silence_redefinition_of_method&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;method&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;method_defined?&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;method&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;private_method_defined?&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;method&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# This suppresses the &quot;method redefined&quot; warning; the self-alias&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# looks odd, but means we don&#39;t need to generate a unique name&lt;/span&gt;
    &lt;span class=&quot;kp&quot;&gt;alias_method&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;method&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;method&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So calling &lt;code&gt;alias_method :initialize, :initialize&lt;/code&gt; before the &lt;code&gt;define_method&lt;/code&gt;
call should silence the warning. That’s kind of weird.&lt;/p&gt;

&lt;p&gt;What’s another way of doing this? I could use &lt;code&gt;prepend&lt;/code&gt;, but I bet that the
project needs to support older versions. &lt;code&gt;prepend&lt;/code&gt; came out in &lt;code&gt;2.0.0&lt;/code&gt;. That’s
quite old. Let’s check &lt;code&gt;.travis.yml&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;na&quot;&gt;rvm&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;1.9.3&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;2.0.0&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2.1&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2.2&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2.3&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2.4&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2.5&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2.6&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2.7&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;jruby-1.7.27&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;jruby&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Of course they need to support &lt;code&gt;1.9.3&lt;/code&gt;. I’ll add the &lt;code&gt;alias_method&lt;/code&gt; trick and
see if it works.&lt;/p&gt;

&lt;h3 id=&quot;ensuring-everything-is-fine&quot;&gt;Ensuring everything is fine&lt;/h3&gt;

&lt;p&gt;Before I make the pull request, I want to make sure that the warnings go away,
and I probably want to run the test suite (although I might let travis handle
that part). I’ll run the &lt;code&gt;build&lt;/code&gt; task again, and change my project to use this
version instead of the &lt;code&gt;rubygems.org&lt;/code&gt; version:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;n&quot;&gt;hugopeixoto&lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@laptop&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:~&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ai&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;competition&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;$&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;git&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;diff&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gems&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;rb&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;diff&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;git&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gems&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;rb&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gems&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;rb&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;index&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ad8d16&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dc69e9e&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;100644&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;---&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gems&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;rb&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;+++&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gems&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;rb&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;@@&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;7&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;7&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;@@&lt;/span&gt;
 &lt;span class=&quot;n&quot;&gt;source&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;https://rubygems.org&quot;&lt;/span&gt;

 &lt;span class=&quot;n&quot;&gt;gem&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;activesupport&quot;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gem&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;aws-sdk-s3&quot;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gem&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;aws-sdk-s3&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;path: &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/home/hugopeixoto/work/contrib/aws-sdk-ruby/gems/aws-sdk-s3&quot;&lt;/span&gt;
 &lt;span class=&quot;n&quot;&gt;gem&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;aws-sdk-sqs&quot;&lt;/span&gt;
 &lt;span class=&quot;n&quot;&gt;gem&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;byebug&quot;&lt;/span&gt;
 &lt;span class=&quot;n&quot;&gt;gem&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;dotenv&quot;&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;hugopeixoto&lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@laptop&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:~&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ai&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;competition&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;$&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bundle&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;update&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;Fetching&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;https&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:/&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;github&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;com&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;whitequark&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rlua&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;Fetching&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gem&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;metadata&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;https&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:/&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rubygems&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;org&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/...........&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;Resolving&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dependencies&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;Bundler&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;could&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;not&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;find&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;compatible&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;versions&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gem&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;aws-sdk-core&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;no&quot;&gt;In&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gems&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;rb&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;aws&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sdk&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;s3&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;was&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;resolved&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;to&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.64&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;which&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;depends&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;on&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;aws&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sdk&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;core&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;~&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;3.96&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;aws&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sdk&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sqs&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;was&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;resolved&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;to&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.25&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;which&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;depends&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;on&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;aws&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sdk&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;core&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;~&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;3.71&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;no&quot;&gt;Could&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;not&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;find&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gem&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;aws-sdk-core (~&amp;gt; 3, &amp;gt;= 3.96.1)&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;which&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;is&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;required&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gem&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;aws-sdk-s3&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;any&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;of&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;the&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sources&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Well, that was unexpected. It seems that by running the generator on
aws-sdk-s3, I bumped the &lt;code&gt;aws-sdk-core&lt;/code&gt; version to an unreleased version:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;n&quot;&gt;hugopeixoto&lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@laptop&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:~&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;aws&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sdk&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ruby&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;$&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;git&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;diff&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gems&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;aws&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sdk&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;s3&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;aws&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sdk&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;s3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;gemspec&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;diff&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;git&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gems&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;aws&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sdk&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;s3&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;aws&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sdk&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;s3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;gemspec&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gems&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;aws&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sdk&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;s3&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;aws&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sdk&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;s3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;gemspec&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;index&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cd7652f65&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fa34b5130&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;100644&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;---&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gems&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;aws&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sdk&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;s3&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;aws&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sdk&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;s3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;gemspec&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;+++&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gems&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;aws&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sdk&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;s3&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;aws&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sdk&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;s3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;gemspec&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;@@&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;25&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;6&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;25&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;6&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;@@&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Gem&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Specification&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;

   &lt;span class=&quot;n&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;add_dependency&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;aws-sdk-kms&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;~&amp;gt; 1&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
   &lt;span class=&quot;n&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;add_dependency&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;aws-sigv4&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;~&amp;gt; 1.1&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;add_dependency&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;aws-sdk-core&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;~&amp;gt; 3&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;&amp;gt;= 3.83.0&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;add_dependency&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;aws-sdk-core&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;~&amp;gt; 3&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;&amp;gt;= 3.96.1&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

 &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I am assuming that using &lt;code&gt;3.96.0&lt;/code&gt; or &lt;code&gt;3.96.1&lt;/code&gt; won’t make that much of a
difference for the things I changed, so I changed the gemspec manually to &lt;code&gt;.0&lt;/code&gt;
and I was able to run the tests:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/m/ai-competition$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;bundle exec rake
&lt;/span&gt;Run options: --seed 19466

&lt;span class=&quot;gp&quot;&gt;# &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;Running:
&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;..................................
&lt;/span&gt;
Finished in 0.477091s, 71.2653 runs/s, 222.1800 assertions/s.

34 runs, 106 assertions, 0 failures, 0 errors, 0 skips
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Looks clean. I’ll run the full build one last time, to make sure that there are
no manual files changed, and make a pull request.&lt;/p&gt;

&lt;p&gt;I decided to run the tests, and got a failure:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;ensure&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;no&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;hard&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;coded&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;region&lt;/span&gt; &lt;span class=&quot;sr&quot;&gt;/home/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;hugopeixoto&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;work&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;contrib&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;aws&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sdk&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ruby&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gems&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;aws&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sdk&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;s3&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lib&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;aws&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sdk&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;s3&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;customizations&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bucket&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;rb&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;has&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;no&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;hard&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;coded&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;region&lt;/span&gt;
   &lt;span class=&quot;no&quot;&gt;Failure&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;expect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;val&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;not_to&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;match&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;sr&quot;&gt;/(us|eu|ap|sa|ca)-[a-zA-Z]+-\d+/&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

     &lt;span class=&quot;n&quot;&gt;expected&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;        if (client.config.region == &#39;us-east-1&#39;) &amp;amp;&amp;amp;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;not&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;to&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;sr&quot;&gt;/(us|eu|ap|sa|ca)-[a-zA-Z]+-\d+/&lt;/span&gt;
     &lt;span class=&quot;no&quot;&gt;Diff&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
     &lt;span class=&quot;err&quot;&gt;@@&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;@@&lt;/span&gt;
     &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;sr&quot;&gt;/(us|eu|ap|sa|ca)-[a-zA-Z]+-\d+/&lt;/span&gt;
     &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;client&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;region&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;us-east-1&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt;

   &lt;span class=&quot;c1&quot;&gt;# ./build_tools/spec/region_spec.rb:48:in `block (5 levels) in &amp;lt;top (required)&amp;gt;&#39;&lt;/span&gt;
   &lt;span class=&quot;c1&quot;&gt;# ./build_tools/spec/region_spec.rb:38:in `each&#39;&lt;/span&gt;
   &lt;span class=&quot;c1&quot;&gt;# ./build_tools/spec/region_spec.rb:38:in `each_with_index&#39;&lt;/span&gt;
   &lt;span class=&quot;c1&quot;&gt;# ./build_tools/spec/region_spec.rb:38:in `block (4 levels) in &amp;lt;top (required)&amp;gt;&#39;&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Checking &lt;code&gt;build_tools/spec/region_spec.rb&lt;/code&gt;, there’s a list of file/line pairs
that can contain a hardcoded region. Since I changed that file, I need to
adjust the line number.&lt;/p&gt;

&lt;p&gt;Adjusting the line number made the basic test suite pass, but I had a bunch of
cucumber errors, and it was taking forever. I’ll let travis handle this.&lt;/p&gt;

&lt;p&gt;Here’s the pull request:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/aws/aws-sdk-ruby/pull/2308&quot;&gt;https://github.com/aws/aws-sdk-ruby/pull/2308&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;sinatra&quot;&gt;Sinatra&lt;/h2&gt;

&lt;p&gt;I had warnings in sinatra as well:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@zephos:~/w/m/ai-competition$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;bundle exec bin/web
&lt;/span&gt;/home/hugopeixoto/work/contrib/asdf/installs/ruby/2.7.0/lib/ruby/gems/2.7.0/gems/sinatra-2.0.8.1/lib/sinatra/base.rb:1526: warning: Using the last argument as keyword parameters is deprecated; maybe ** should be added to the call
/home/hugopeixoto/work/contrib/asdf/installs/ruby/2.7.0/lib/ruby/gems/2.7.0/gems/rack-2.2.2/lib/rack/handler/webrick.rb:26: warning: The called method `run&#39; is defined here
[2020-05-17 19:52:27] INFO  WEBrick 1.6.0
[2020-05-17 19:52:27] INFO  ruby 2.7.0 (2019-12-25) [x86_64-linux]
== Sinatra (v2.0.8.1) has taken the stage on 4567 for development with backup from WEBrick
[2020-05-17 19:52:27] INFO  WEBrick::HTTPServer#start: pid=1278442 port=4567
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Looking through the github issues, these seem to have been addressed already,
but not released:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/sinatra/sinatra/issues/1590&quot;&gt;https://github.com/sinatra/sinatra/issues/1590&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;summary&quot;&gt;Summary&lt;/h2&gt;

&lt;p&gt;I upgraded a personal project to ruby 2.7, and got some warnings in a third
party gem: &lt;code&gt;aws-sdk-s3&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Some of those warnings came from generated code, but it was still fixable.&lt;/p&gt;

&lt;p&gt;I’m not sure if they’ll accept my PR, but there’s no reason not to do it.
If you’re not sure you’re doing things right, they’ll let you know.&lt;/p&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2020-05-08:/articles/2020-05-08.html</id>
    <title type="html">Building an android app with free software only</title>
    <published>2020-05-08T00:00:00Z</published>
    <updated>2020-05-08T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/2020-05-08.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;I built a couple of personal android applications a few years ago. One of them is an overlay thing for pokemon go and the other one is an image uploader for &lt;code&gt;dl.hugopeixoto.net&lt;/code&gt;, my personal image hosting service. I would like to be able to build them without having to accept EULAs.&lt;/p&gt;
]]>
    </summary>
    <content type="html">
      <![CDATA[
        <aside>
          This is a <code>[journal]</code> entry. It is longer than usual and
          more exploratory. It may have no proper conclusion.
        </aside>
      ]]>

      &lt;p&gt;I built a couple of personal android applications a few years ago. One of them
is an overlay thing for pokemon go and the other one is an image uploader for
&lt;code&gt;dl.hugopeixoto.net&lt;/code&gt;, my personal image hosting service. I would like to be
able to build them without having to accept EULAs.&lt;/p&gt;

&lt;h2 id=&quot;current-state&quot;&gt;Current state&lt;/h2&gt;

&lt;p&gt;I have a half-uncommited private repository for my image uploader app. I don’t
remember why I didn’t publish this. Probably because I wanted to clean the
repository before publishing it, classic mistake.&lt;/p&gt;

&lt;p&gt;The app has two parts (from what I recall):&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;a settings screen, which allows you to configure the server access&lt;/li&gt;
  &lt;li&gt;a “share” screen, accessible through the standard share buttons, that uploads
the image to the server and places the resulting URL in the clipboard&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Let’s look at the tree of this directory to see what’s up:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/p/http-share-android$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;tree -L 3
&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;.
&lt;/span&gt;├── android.iml
├── app
│   ├── app.iml
│   ├── build
│   │   ├── generated
│   │   ├── intermediates
│   │   ├── outputs
│   │   ├── retrolambda
│   │   └── tmp
│   ├── build.gradle
│   └── src
│       └── main
├── app-signed.apk
├── build
│   ├── generated
│   │   └── mockable-android-23.jar
│   └── intermediates
│       ├── dex-cache
│       └── lint-cache
├── build.gradle
├── gradle
│   └── wrapper
│       ├── gradle-wrapper.jar
│       └── gradle-wrapper.properties
├── gradlew
├── gradlew.bat
├── local.properties
└── settings.gradle
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;code&gt;/build/&lt;/code&gt; and &lt;code&gt;/app/build/&lt;/code&gt;, that sounds promising. I must have been in the
process of messing with the build process. I’ll remove both these directories.&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/p/http-share-android$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;tree -I &quot;drawable-*|mipmap-*&quot;
&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;.
&lt;/span&gt;├── android.iml
├── app
│   ├── app.iml
│   ├── build.gradle
│   └── src
│       └── main
│           ├── AndroidManifest.xml
│           ├── java
│           │   └── net
│           │       └── hugopeixoto
│           │           └── customsharing
│           │               ├── AppCompatPreferenceActivity.java
│           │               ├── RxUtils.java
│           │               ├── SettingsActivity.java
│           │               ├── UploadActivity.java
│           │               └── Uploader.java
│           └── res
│               ├── layout
│               │   ├── activity_main.xml
│               │   └── content_main.xml
│               ├── values
│               │   ├── colors.xml
│               │   ├── dimens.xml
│               │   ├── strings.xml
│               │   └── styles.xml
│               ├── values-v21
│               │   └── styles.xml
│               ├── values-w820dp
│               │   └── dimens.xml
│               └── xml
│                   └── preferences.xml
├── app-signed.apk
├── build.gradle
├── gradle
│   └── wrapper
│       ├── gradle-wrapper.jar
│       └── gradle-wrapper.properties
├── gradlew
├── gradlew.bat
├── local.properties
└── settings.gradle

15 directories, 26 files
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I ignored &lt;code&gt;app/src/res/{drawable,mipmap}-*&lt;/code&gt; because it contains a bunch of
icons in different resolutions that I don’t want to think about just yet.&lt;/p&gt;

&lt;p&gt;So, what have we got?&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;code&gt;*.iml&lt;/code&gt; files are android studio project files&lt;/li&gt;
  &lt;li&gt;&lt;code&gt;app-signed.apk&lt;/code&gt; is the result of a previous build&lt;/li&gt;
  &lt;li&gt;tons of &lt;a href=&quot;https://en.wikipedia.org/wiki/Gradle&quot;&gt;gradle&lt;/a&gt; files, a build tool&lt;/li&gt;
  &lt;li&gt;&lt;code&gt;AndroidManifest.xml&lt;/code&gt;, which describes the permissions, activities, and intents of this app&lt;/li&gt;
  &lt;li&gt;source code in &lt;code&gt;app/src/main/java/net/hugopeixoto/customsharing/&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;layouts in &lt;code&gt;app/src/main/res/layout/&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;preferences in &lt;code&gt;app/src/main/res/xml/preferences.xml&lt;/code&gt;, referenced in the code&lt;/li&gt;
  &lt;li&gt;application texts in &lt;code&gt;app/src/main/res/values/strings.xml&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;some extra xml files with.. stuff&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Looking at the source files:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/p/http-share-android$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;tree app/src/main/java/net/hugopeixoto/customsharing/
&lt;/span&gt;app/src/main/java/net/hugopeixoto/customsharing/
├── AppCompatPreferenceActivity.java
├── RxUtils.java
├── SettingsActivity.java
├── UploadActivity.java
└── Uploader.java

0 directories, 5 files
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I see the three activity files, &lt;code&gt;AppCompatPreferenceActivity&lt;/code&gt;,
&lt;code&gt;SettingsActivity&lt;/code&gt; and &lt;code&gt;UploadActivity&lt;/code&gt;. The last two match the parts I
mentioned at the beginning. &lt;code&gt;SettingsActivity&lt;/code&gt; inherits from
&lt;code&gt;AppCompatPreferenceActivity&lt;/code&gt;, so it could be related to some android
compatibility wrapper.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;RxUtils&lt;/code&gt; contains a single static method, but it lets me know that I’m using
some functional library. I recall playing around with lambdas, and having to
use a transpiler of sorts to get it to work. &lt;em&gt;Retrolambda&lt;/em&gt;. Since I don’t
really care about compatibility with old devices for my personal apps, maybe I
don’t need to use this anymore.&lt;/p&gt;

&lt;p&gt;I should have left myself a README with instructions. I remember that whenever
I had to build this, I had to run some commands. One for building, one for
signing. I don’t have those written anywhere, except in my bash history. I’ll
go fetch them.&lt;/p&gt;

&lt;p&gt;Found this:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;gradle assembleRelease
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;jarsigner -sigalg SHA1withRSA -digestalg SHA1 -keystore my.keystore ./app/build/outputs/apk/app-release-unsigned.apk app
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;http-share httpshare.apk ./app/build/outputs/apk/app-release-unsigned.apk
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The first command builds the &lt;code&gt;apk&lt;/code&gt;, the second one signs it, and the fourth one
uploads the signed version to a web server, using
&lt;a href=&quot;https://github.com/hugopeixoto/http-share-cli&quot;&gt;http-share-cli&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I know that I wanted to build this from a docker image, instead of relying on
having everything installed on the OS. I also remember that that didn’t work
properly with openjdk, so I stopped there. I still have a &lt;code&gt;Dockerfile&lt;/code&gt;
somewhere.&lt;/p&gt;

&lt;div class=&quot;language-dockerfile highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; debian&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#alpine:3.6&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;apt update
&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;apt &lt;span class=&quot;nb&quot;&gt;install&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; openjdk-8-jdk unzip  wget
&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;wget https://dl.google.com/android/repository/sdk-tools-linux-3859397.zip &lt;span class=&quot;nt&quot;&gt;-O&lt;/span&gt; android.zip &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;mkdir &lt;/span&gt;android &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; unzip android.zip &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; android/ &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;rm&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-r&lt;/span&gt; android.zip
&lt;span class=&quot;c&quot;&gt;#RUN echo y | android/tools/android update sdk --no-ui -a --filter tools,platform-tools,extra-android-m2repository,extra-android-support,extra-google-google_play_services,extra-google-m2repository,android-23,build-tools-25.0.2,build-tools-23.0.1,build-tools-25.0.0&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#ENV PATH ${PATH}:/android/tools/:/android/tools/bin/:/android/platform-tools/&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This looks very much like work in progress. I’ll start over.&lt;/p&gt;

&lt;h2 id=&quot;f-droid&quot;&gt;F-droid&lt;/h2&gt;

&lt;p&gt;I use &lt;a href=&quot;https://f-droid.org/&quot;&gt;F-droid&lt;/a&gt;. They’re focused on free software, and
they build everything from source. It might be a good starting point.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Sidenote: I saw a talk about &lt;a href=&quot;https://bubu1.eu/openpush/&quot;&gt;OpenPush&lt;/a&gt; in
FOSDEM, I need to see if there are any news&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;The following page contains some interesting notes:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://f-droid.org/en/2020/04/29/big-website-update.html&quot;&gt;https://f-droid.org/en/2020/04/29/big-website-update.html&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;all APK files must be signed to be installable on Android&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;it is not possible to upgrade it in place to a new version signed with a
different key without first uninstalling the original. This may present an
inconvenience to users, as the process of uninstalling loses any data
associated with the previous installation.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;Run &lt;code&gt;fdroid build&lt;/code&gt; to build any applications that are not already built.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;There seems to be a &lt;code&gt;fdroid&lt;/code&gt; cli that handles building&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;More about &lt;code&gt;fdroid build&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Yes please.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;To build a single version of a single application, you could run the following:
&lt;code&gt;fdroid build org.fdroid.fdroid:16&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;Another option for using &lt;code&gt;fdroid build&lt;/code&gt; is to use a metadata file that is
included in the app’s source itself, rather than in a &lt;code&gt;metadata/&lt;/code&gt; folder with
lots of other apps. The &lt;code&gt;.fdroid.yml&lt;/code&gt; metadata file should be in the root of
your source repo.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Now, how does this &lt;code&gt;fdroid build&lt;/code&gt; work, exactly, and how do I get my app
compiled using this? Let’s see if the FAQ helps.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://f-droid.org/en/docs/FAQ_-_App_Developers/&quot;&gt;https://f-droid.org/en/docs/FAQ_-_App_Developers/&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;The quickest way to get an app included is to make a merge request to
fdroiddata, following &lt;a href=&quot;https://gitlab.com/fdroid/fdroiddata/blob/master/CONTRIBUTING.md#merge-requests&quot;&gt;these instructions&lt;/a&gt;.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;We also support reproducible builds, so we can build a version from source
and check against your official release. If they match (ignoring the
signature) we can then publish your official APK with your signature used.
This is a tedious task, since we have to standardize on the build parameters
and tools, but it should be worth it in the long run. We also try to verify
our own builds and get a lot of binary differences, see our verification
server results. However, things will improve over time.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Reproducible builds is an interesting topic, but I’m probably not going to
tackle this right now.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Which build system to use?&lt;/p&gt;

  &lt;p&gt;We have good support for “ant” and “gradle” based builds, while “maven” was
only used for a short period of time and for dependencies. For other build
systems, you might have to provide us some detailed information on how to
handle that, so we can setup the app correctly or maybe even incorporate them
into our server tools.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;So this means that I’ll probably continue to keep using &lt;code&gt;gradle&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Let’s look at the
&lt;a href=&quot;https://gitlab.com/fdroid/fdroiddata/blob/master/CONTRIBUTING.md#merge-requests&quot;&gt;&lt;code&gt;CONTRIBUTING.md&lt;/code&gt;&lt;/a&gt;,
referenced above.&lt;/p&gt;

&lt;p&gt;OK, this seems to describe how to create the metadata file.&lt;/p&gt;

&lt;p&gt;I also found a docker image for the fdroid server:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://gitlab.com/fdroid/docker-executable-fdroidserver&quot;&gt;https://gitlab.com/fdroid/docker-executable-fdroidserver&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;But it mentions that:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;It does not include a full Android SDK, so if you want to use the full
Android SDK with this image, you’ll need to mount your own local copy.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;This smells of licensing issues. Let’s look for other docs that might point out
to how this whole thing works.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://f-droid.org/en/docs/Installing_the_Server_and_Repo_Tools&quot;&gt;https://f-droid.org/en/docs/Installing_the_Server_and_Repo_Tools&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Proprietary, Non-Free libraries&lt;/p&gt;

  &lt;p&gt;The Android SDK is made available by Google under a proprietary license.
Within that, the essential build tools, SDK platforms, support library and
some other components are under the Apache license and source code is
provided.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;So, the Android SDK is proprietary? How can this be, if AOSP is free? Doesn’t
make much sense. Let me explore this a bit.&lt;/p&gt;

&lt;h2 id=&quot;android-sdk-licensing&quot;&gt;Android SDK licensing&lt;/h2&gt;

&lt;p&gt;There’s a debian package package called &lt;code&gt;android-sdk&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@hylia:/m/h/h/hugopeixoto$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;apt show android-sdk
&lt;/span&gt;Package: android-sdk
Version: 25.0.0+12
Priority: optional
Section: metapackages
Source: android-sdk-meta
Maintainer: Android Tools Maintainers &amp;lt;android-tools-devel@lists.alioth.debian.org&amp;gt;
Installed-Size: 30.7 kB
Depends: android-sdk-build-tools, android-sdk-common (&amp;gt;= 25.0.0+12), android-sdk-platform-tools (&amp;gt;= 20), proguard-cli
Recommends: gradle, default-jdk-headless
Suggests: android-sdk-platform-23, maven, proguard-gui
Download-Size: 4824 B
APT-Sources: http://deb.debian.org/debian testing/main amd64 Packages
Description: Software development kit for Android platform
 The Android SDK includes a variety of tools that help you develop mobile
 applications for the Android platform. The tools are classified into 3 groups:
 SDK Tools, Platform-tools and Build-tools.
&lt;span class=&quot;c&quot;&gt; .
&lt;/span&gt; SDK Tools are platform independent and are required no matter which Android
 platform you are developing on. It is the base toolset of Android SDK.
&lt;span class=&quot;c&quot;&gt; .
&lt;/span&gt; This metapackage pulls the entire Android SDK.
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So this in debian, in the main section, so how could this be proprietary? It
could just be a downloader for the proprietary binaries, but then it would have
to be in &lt;code&gt;contrib&lt;/code&gt;, not in &lt;code&gt;main&lt;/code&gt;. Let me check Debian’s wiki:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://wiki.debian.org/AndroidTools&quot;&gt;https://wiki.debian.org/AndroidTools&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Sidenote: the wiki page points to
&lt;a href=&quot;https://guardianproject.info/2015/04/30/getting-android-tools-into-debian/&quot;&gt;https://guardianproject.info/2015/04/30/getting-android-tools-into-debian/&lt;/a&gt;,
which seems to be an interesting read.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;The binaries for the Android SDK downloadable from Google have a proprietary
license but the source code is free software so Debian is packaging it. Not
all Android SDK packages can be installed from Debian, some never will be in
Debian because they are too specific to Android. Sylvain Beucler’s &lt;a href=&quot;http://android-rebuilds.beuc.net/About/&quot;&gt;libre
Android rebuilds&lt;/a&gt; and/or Google’s
non-free binaries can also be used with the Debian Android SDK.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;OK, so the &lt;em&gt;binaries&lt;/em&gt; are proprietary, but the source is not. This makes some
sense. So going back to the fdroid quote:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;The Android SDK is made available by Google under a proprietary license.
Within that, the essential build tools, SDK platforms, support library and
some other components are under the Apache license and source code is
provided.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;When they say that the SDK is &lt;em&gt;made available under a proprietary license&lt;/em&gt;,
that means the binaries. Makes sense, since they follow up with “x, y, z are
under the Apache license”. So that is just weird phrasing / lack of reading.&lt;/p&gt;

&lt;p&gt;So this means that ideally, I’d be installing these from source, and not using
Google’s binaries.&lt;/p&gt;

&lt;p&gt;This also means that there are some packages that are installable via google’s
android sdk thingy that are proprietary. This includes Google services. No
surprises here, this is something I was aware of.&lt;/p&gt;

&lt;p&gt;Let me check that &lt;a href=&quot;http://android-rebuilds.beuc.net/About/&quot;&gt;Sylvain Beucler’s libre Android
rebuilds about page&lt;/a&gt; page.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Android Studio, which includes the SDK and NDK, is supposed to be freely
licensed (mainly Apache 2.0) but the official binaries aren’t.&lt;/p&gt;

  &lt;p&gt;On download, we are requested to accept conditions such as:&lt;/p&gt;

  &lt;p&gt;“3.2 You may not use this SDK to develop applications for other platforms
(including non-compatible implementations of Android) or to develop another
SDK.”&lt;/p&gt;

  &lt;p&gt;“4.2 You agree to use the SDK and write applications only for purposes that
are permitted by (a) the License Agreement and (b) any applicable law,
regulation or [etc.]”&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;This is all great.&lt;/p&gt;

&lt;p&gt;I also saw some references to &lt;a href=&quot;https://microg.org/&quot;&gt;micro-g&lt;/a&gt; while searching.
It’s a free implementation of some google libraries that are widely used. Let
me just browse a list or something to get acquainted with it, in case I need
it:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Service Core (GmsCore) is a library app, providing the functionality required
to run apps that use Google Play Services or Google Maps Android API (v2).&lt;/p&gt;

  &lt;p&gt;Services Framework Proxy (GsfProxy) is a small helper utility to allow apps
developed for Google Cloud to Device Messaging (C2DM) to use the compatible
Google Cloud Messaging service included with GmsCore.&lt;/p&gt;

  &lt;p&gt;Unified Network Location Provider (UnifiedNlp) is a library that provides
Wi-Fi- and Cell-tower-based geolocation to applications that use Google’s
network location provider. It is included in GmsCore but can also run
independently on most Android systems.&lt;/p&gt;

  &lt;p&gt;[some deprecated maps api replacement]&lt;/p&gt;

  &lt;p&gt;Store (Phonesky) is a frontend application providing access to the Google
Play Store to download and update applications. Development is in early stage
and there is no usable application yet.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;OK, so they’re basically free implementations of interfaces to proprietary
services. I don’t see myself needing these for now, but the UnifiedNlp might be
useful in the future. I may be using Google Play Services accidentally, so this
is good to know.&lt;/p&gt;

&lt;p&gt;I hope I’m not accidentally using any proprietary libraries, but the compat
libraries might fall into that category.&lt;/p&gt;

&lt;p&gt;So, back to building an application. If debian packages &lt;code&gt;android-sdk&lt;/code&gt;, let’s
try to build a docker file using those.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Sidenote: I randomly learned that the F-Droid client started out as a fork of
&lt;a href=&quot;https://en.wikipedia.org/wiki/Aptoide&quot;&gt;Aptoide&lt;/a&gt;.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;debian-based-dockerfile-for-android-builds&quot;&gt;Debian based Dockerfile for android builds&lt;/h2&gt;

&lt;p&gt;I don’t even know where to start. Let’s go back to the Debian wiki page:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://wiki.debian.org/AndroidTools&quot;&gt;https://wiki.debian.org/AndroidTools&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;There are many advantages to having the SDK and tools in Debian, rather than
relying only on the Google distributions:&lt;/p&gt;

  &lt;ul&gt;
    &lt;li&gt;easy install and update channel that all Debian users already know&lt;/li&gt;
    &lt;li&gt;automatic trustworthy downloads, no need to verify hash sums&lt;/li&gt;
    &lt;li&gt;eliminate need for insecure wrapper scripts, like ./gradlew&lt;/li&gt;
    &lt;li&gt;trivial install for specific tools, like adb, fastboot, etc.&lt;/li&gt;
  &lt;/ul&gt;
&lt;/blockquote&gt;

&lt;p&gt;Point 1, 2, and 3 sound great. I kinda dislike having random &lt;code&gt;gradlew&lt;/code&gt; files in
my repository.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;If you’re just starting out with building apps, we suggest that you first
read the &lt;a href=&quot;https://wiki.debian.org/AndroidTools/IntroBuildingApps&quot;&gt;Introduction to build packages with Debian’s Android
SDK&lt;/a&gt;.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;The linked page also contains a walkthrough. Might come in handy.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Currently there is only the target platform of API Level 23 packaged, so only
apps targeted at android-23 can be built with only Debian packages. We will
add more API platform packages via backports afterwards. Only Build-Tools
24.0.0 is available, so in order to use the SDK, build scripts need to be
modified. Beware that the Lint in this version of Gradle Android Plugin is
still problematic, so running the :lint tasks might not work.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;This is going to be interesting. Let me check what version I was using.&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/p/http-share-android$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;grep &#39;android {&#39; app/build.gradle -A2
&lt;/span&gt;android {
    compileSdkVersion 23
    buildToolsVersion &quot;23.0.1&quot;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Two 23s. That means I’ll probably have to change &lt;code&gt;buildTools&lt;/code&gt; to 24. This is,
assuming that the wiki information is still up to date. Let’s double check.&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/p/http-share-android$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;apt search -q --names-only android-sdk-platform
&lt;/span&gt;Sorting...
Full Text Search...
android-sdk-platform-23/testing,unstable 6.0.1+r72-5 all
  Android SDK Platform for API Level 23 (6.0 Marshmallow)

android-sdk-platform-tools/testing,unstable 27.0.0+12 amd64
  Tools for interacting with an Android platform

android-sdk-platform-tools-common/testing,unstable,now 27.0.0+12 all [installed,automatic]
  Tools for interacting with an Android platform - Common files
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Confirmed, 23. the &lt;code&gt;-tools&lt;/code&gt; packages mention a version 27, though. Let me check
what are the most recent versions in upstream.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://developer.android.com/studio/releases/platforms&quot;&gt;https://developer.android.com/studio/releases/platforms&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;

  &lt;p&gt;Android 10 (API level 29)
…
Android 8.1 (API level 27)
…
Android 6.0 (API level 23)&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;So this is kind of lagging behind. I have no idea what any of these mean, and
from &lt;a href=&quot;https://wiki.debian.org/AndroidTools#Android.27s_upstream_version_names&quot;&gt;https://wiki.debian.org/AndroidTools#Android.27s_upstream_version_names&lt;/a&gt;,
it seems to be a bit crazy to begin with. I’ll get back to it later.&lt;/p&gt;

&lt;p&gt;Let’s start writing the Dockerfile.&lt;/p&gt;

&lt;p&gt;First hiccup: I had to use &lt;code&gt;debian:sid&lt;/code&gt;. This is what I have so far:&lt;/p&gt;

&lt;div class=&quot;language-dockerfile highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; debian:sid&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;apt update
&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;apt &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;android-sdk android-sdk-platform-23 git libgradle-android-plugin-java

&lt;span class=&quot;k&quot;&gt;ADD&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; . /app&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;WORKDIR&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; /app&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;CMD&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; bash&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I’m using &lt;code&gt;CMD bash&lt;/code&gt; because I’ll be exploring things through bash before fully
automating this.&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;docker build . -t http-share-android &amp;amp;&amp;amp; docker run -ti http-share-android
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Running &lt;code&gt;gradle build&lt;/code&gt; downloaded a bunch of POM files and then it complained about
mismatched &lt;code&gt;gradle&lt;/code&gt; versions:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Gradle version 2.10 is required. Current version is 4.4.1. If using the
gradle wrapper, try editing the distributionUrl in
/root/.gradle/daemon/4.4.1/gradle/wrapper/gradle-wrapper.properties to
gradle-2.10-all.zip&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;This is because I need to adapt &lt;code&gt;build.gradle&lt;/code&gt; to use the debian packages
instead of the android ones. I’m having some trouble getting that to work.
Instructions may be out of date. There is an &lt;code&gt;android-sdk-helper&lt;/code&gt; package that
patches existing gradle files, but I rather write them manually for now to
understand what’s going on.&lt;/p&gt;

&lt;p&gt;They’re telling me to change &lt;code&gt;build.gradle&lt;/code&gt; to include:&lt;/p&gt;

&lt;div class=&quot;language-gradle highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;buildscript&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;repositories&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;maven&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;url&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;file:///usr/share/maven-repo&#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;dependencies&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;compile&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;com.android.tools.build:gradle:debian&#39;&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But the compile line doesn’t… compile. Where is this &lt;code&gt;compile&lt;/code&gt; thing defined?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://stackoverflow.com/questions/34286407/gradle-what-is-the-difference-between-classpath-and-compile-dependencies&quot;&gt;https://stackoverflow.com/questions/34286407/gradle-what-is-the-difference-between-classpath-and-compile-dependencies&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;I’m going to guess that you’re referencing compile and classpath within the
dependencies {} block. If that is so, those are dependency Configurations.&lt;/p&gt;

  &lt;p&gt;The compile configuration is created by the Java plugin. The classpath
configuration is commonly seen in the buildSrc {} block where one needs to
declare dependencies for the build.gradle, itself (for plugins, perhaps).&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Checking gradle docs:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://docs.gradle.org/current/userguide/java_library_plugin.html#sec:java_library_configurations_graph&quot;&gt;https://docs.gradle.org/current/userguide/java_library_plugin.html#sec:java_library_configurations_graph&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I see a &lt;code&gt;compileClasspath&lt;/code&gt; and &lt;code&gt;compileOnly&lt;/code&gt;, but no &lt;code&gt;compile&lt;/code&gt;. This may have
changed in gradle. Let me check versions.&lt;/p&gt;

&lt;p&gt;Debian has &lt;code&gt;4.4.1&lt;/code&gt; while the latest gradle is… &lt;code&gt;6.x&lt;/code&gt;. &lt;code&gt;4.4.1&lt;/code&gt; is from 2017,
ouch. Let me check debian’s tracker to see if there’s anything that points to a
new version being worked on:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://tracker.debian.org/pkg/gradle&quot;&gt;https://tracker.debian.org/pkg/gradle&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Checking all bugs associated with this package, here’s a relevant one:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=933264&quot;&gt;https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=933264&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;[29 Jul 2019] Newer version of Gradle requires Kotlin, which is being worked
on right now. See https://java-team.pages.debian.net/gsoc-kotlin-blog&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;So gradle is stuck on 4.4.1 because it depends on Kotlin, and Kotlin is still
not packaged in Debian. And one of the reasons kotlin is not packaged, I bet,
is because it requires a more recent version of gradle.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Downgrade the build from gradle 5.1 to gradle 4.4.1 which is the version
available in Debian Sid.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;I knew it. I wanted to eventually move the apps from kotlin to java, but I
guess that’s going to have to wait.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;I have finished downgrading the project to be buildable using gradle 4.4.1.
The project still needed a part of gradle 4.8 that I have successfully
patched into sid gradle. here is the link to the changes that I have made.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;So, Debian’s &lt;code&gt;gradle 4.4.1&lt;/code&gt; contains some features of &lt;code&gt;4.8&lt;/code&gt;. The docs for &lt;code&gt;4.8&lt;/code&gt;
are still available on &lt;code&gt;gradle.org&lt;/code&gt;, so let’s check that.&lt;/p&gt;

&lt;p&gt;No &lt;code&gt;compile&lt;/code&gt; there. Maybe they meant &lt;code&gt;classpath&lt;/code&gt;. Let me try that, and let me
change the build tools version to 27 while I’m at it.&lt;/p&gt;

&lt;p&gt;I got some other errors:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;java.lang.ClassNotFoundException: org.debian.gradle.plugin.MavenResolverHook&lt;/p&gt;

  &lt;p&gt;java.io.FileNotFoundException: /root/.android/analytics.settings (No such file or directory)&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;These errors didn’t seem to stop the compilation from going. It then failed with&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;The SDK directory ‘/home/hugopeixoto/work/contrib/android-sdk’ does not exist.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;This is my old android sdk path. I probably have to change something to the
debian one. Changed &lt;code&gt;local.properties&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-ini highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;py&quot;&gt;sdk.dir&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/usr/lib/android-sdk&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Still getting a ton of exceptions, but it’s moving still along… and it failed
after 33 seconds:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;* What went wrong:
A problem occurred configuring project &#39;:app&#39;.
&amp;gt; java.lang.NullPointerException (no error message)
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I created an empty &lt;code&gt;analytics.settings&lt;/code&gt; file just to get those warnings out of
the way, but the NPE persists. Running it again with &lt;code&gt;--stacktrace&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;org.gradle.api.ProjectConfigurationException: A problem occurred configuring project &#39;:app&#39;.
  at org.gradle.configuration.project.LifecycleProjectEvaluator.addConfigurationFailure(LifecycleProjectEvaluator.java:94)
&lt;span class=&quot;c&quot;&gt;  ...
&lt;/span&gt;Caused by: java.lang.NullPointerException
  at com.android.repository.impl.meta.SchemaModuleUtil.marshal(SchemaModuleUtil.java:270)
  at com.android.repository.impl.manager.LocalRepoLoaderImpl.writePackage(LocalRepoLoaderImpl.java:285)
  at com.android.repository.impl.manager.LocalRepoLoaderImpl.parsePackages(LocalRepoLoaderImpl.java:178)
  at com.android.repository.impl.manager.LocalRepoLoaderImpl.getPackages(LocalRepoLoaderImpl.java:154)
  at com.android.repository.impl.manager.RepoManagerImpl$LoadTask.run(RepoManagerImpl.java:653)
  at com.android.repository.api.RepoManager$DummyProgressRunner.runSyncWithProgress(RepoManager.java:398)
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ah, this is a bit more helpful. Let me quickly search for the source:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/gradle/gradle/blob/v4.4.1/subprojects/core/src/main/java/org/gradle/configuration/project/LifecycleProjectEvaluator.java&quot;&gt;https://github.com/gradle/gradle/blob/v4.4.1/subprojects/core/src/main/java/org/gradle/configuration/project/LifecycleProjectEvaluator.java&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/JetBrains/adt-tools-base/blob/master/repository/src/main/java/com/android/repository/impl/meta/SchemaModuleUtil.java&quot;&gt;https://github.com/JetBrains/adt-tools-base/blob/master/repository/src/main/java/com/android/repository/impl/meta/SchemaModuleUtil.java&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;And some stack overflow links that I found along the way:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://stackoverflow.com/questions/30643802/what-is-jaxbcontext-newinstancestring-contextpath&quot;&gt;https://stackoverflow.com/questions/30643802/what-is-jaxbcontext-newinstancestring-contextpath&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://stackoverflow.com/questions/43574426/how-to-resolve-java-lang-noclassdeffounderror-javax-xml-bind-jaxbexception-in-j&quot;&gt;https://stackoverflow.com/questions/43574426/how-to-resolve-java-lang-noclassdeffounderror-javax-xml-bind-jaxbexception-in-j&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;OK, the source isn’t being that helpful. Let me try to delete most of the
contents in &lt;code&gt;app/build.gradle&lt;/code&gt; to see if it changes something. This is the
current state:&lt;/p&gt;

&lt;div class=&quot;language-gradle highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;n&quot;&gt;plugins&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;id&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;me.tatarka.retrolambda&quot;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;version&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;3.2.5&quot;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;apply&lt;/span&gt; &lt;span class=&quot;nl&quot;&gt;plugin:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;com.android.application&#39;&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;android&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;compileSdkVersion&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;23&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;buildToolsVersion&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;27.0.1&quot;&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;defaultConfig&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;applicationId&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;net.hugopeixoto.customsharing&quot;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;minSdkVersion&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;15&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;targetSdkVersion&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;23&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;versionCode&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;versionName&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;1.0&quot;&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;buildTypes&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;release&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;minifyEnabled&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;compileOptions&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;sourceCompatibility&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;JavaVersion&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;VERSION_1_8&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;targetCompatibility&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;JavaVersion&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;VERSION_1_8&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;


&lt;span class=&quot;k&quot;&gt;dependencies&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;compile&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;fileTree&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;dir:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;libs&#39;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nl&quot;&gt;include:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;*.jar&#39;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;])&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;testCompile&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;junit:junit:4.12&#39;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;compile&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;com.android.support:appcompat-v7:23.1.1&#39;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;compile&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;com.android.support:design:23.1.1&#39;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;compile&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;com.squareup.okhttp3:okhttp:3.1.2&#39;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;compile&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;com.google.code.gson:gson:2.2.+&#39;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;compile&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;com.google.guava:guava:12.0&#39;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;compile&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;com.android.support:support-v4:23.1.1&#39;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;compile&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;io.reactivex:rxandroid:1.2.0&#39;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;compile&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;io.reactivex:rxjava:1.1.5&#39;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I can get different errors if I delete the &lt;code&gt;android&lt;/code&gt; section. It starts
complaining about the lack of &lt;code&gt;buildToolsVersion&lt;/code&gt;, but if I just add that line,
it NPEs again.&lt;/p&gt;

&lt;p&gt;Could this be related to the java version I’m running?&lt;/p&gt;

&lt;p&gt;Let me find a sample app. I was looking through the bugs on &lt;code&gt;android-sdk-meta&lt;/code&gt;,
and came across this:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=854483&quot;&gt;https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=854483&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;I tested it using &lt;a href=&quot;https://gitlab.com/cde/AndroidHelloWorld&quot;&gt;https://gitlab.com/cde/AndroidHelloWorld&lt;/a&gt;, as seamlik
proposed in #debian-mobile.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Let me clone this and try to build it.&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/p/http-share-android$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;git clone https://gitlab.com/cde/AndroidHelloWorld
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/p/http-share-android$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;docker build . -t http-share-android &amp;amp;&amp;amp; docker run -ti http-share-android
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;root@56951ec38e98:/app# &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;cd AndroidHelloWorld/
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;root@56951ec38e98:/app/AndroidHelloWorld# &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;gradle build
&lt;/span&gt;&amp;gt; Gradle version 2.10 is required. Current version is 4.4.1. If using the
&amp;gt; gradle wrapper, try editing the distributionUrl in
&amp;gt; /root/.gradle/daemon/4.4.1/gradle/wrapper/gradle-wrapper.properties to
&amp;gt; gradle-2.10-all.zip
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Derp. After adapting &lt;code&gt;build.gradle&lt;/code&gt; according to the debian instructions, I got
the same NPE error. Let me try the &lt;code&gt;android-sdk-helper&lt;/code&gt; package.&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@56951ec38e98:/app/AndroidHelloWorld# &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;apt install android-sdk-helper
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;root@56951ec38e98:/app/AndroidHelloWorld# &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;gradle build --init-script /usr/share/android-sdk-helper/init.gradle
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It was unable to detect &lt;code&gt;ANDROID_HOME&lt;/code&gt;, so I set it through &lt;code&gt;sdk.dir&lt;/code&gt; in
&lt;code&gt;local.properties&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;cp ../local.properties .
&lt;span class=&quot;gp&quot;&gt;root@56951ec38e98:/app/AndroidHelloWorld# &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;gradle build --init-script /usr/share/android-sdk-helper/init.gradle
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Same NPE as before. So it seems that I’m not doing anything wrong when editing
&lt;code&gt;build.gradle&lt;/code&gt;. I could try to build these dependencies with some extra debug
statements.&lt;/p&gt;

&lt;h2 id=&quot;trying-to-build-android-platform-tools-base&quot;&gt;Trying to build &lt;code&gt;android-platform-tools-base&lt;/code&gt;&lt;/h2&gt;

&lt;p&gt;After looking through the wrong package, I ran the following commands:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/contrib$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;apt source libgradle-android-plugin-java
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/contrib$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;cd android-platform-tools-base-2.2.2/
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/c/android-platform-tools-base-2.2.2$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;ack SchemaModuleUtil
&lt;/span&gt;repository/src/main/java/com/android/repository/impl/manager/LocalRepoLoaderImpl.java
31:import com.android.repository.impl.meta.SchemaModuleUtil;
285:            SchemaModuleUtil.marshal(factory.generateRepository(repo),
311:            repo = (Repository) SchemaModuleUtil.unmarshal(mFop.newFileInputStream(packageXml),
[...]
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I got a bunch of matches, but the first one matches the stacktrace and line
number, so it sounds like a good starting point. Cross-referencing that with
the
&lt;a href=&quot;https://github.com/JetBrains/adt-tools-base/blob/master/repository/src/main/java/com/android/repository/impl/meta/SchemaModuleUtil.java&quot;&gt;JetBrains&lt;/a&gt;
link.&lt;/p&gt;

&lt;p&gt;Can I build this? I don’t remember anything of building debian packages.
Running &lt;code&gt;dpkg-buildpackage -us -uc&lt;/code&gt; tells me I need a lot of build
dependencies. There’s an &lt;code&gt;apt build-dep&lt;/code&gt; command.&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@laptop:~# &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;apt build-dep android-platform-tools-base
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/c/android-platform-tools-base-2.2.2$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;dpkg-buildpackage -us -uc
&lt;/span&gt;[...]
org.gradle.api.tasks.TaskExecutionException: Execution failed for task &#39;:base:common:compileJava&#39;.
[...]
Caused by: org.gradle.api.internal.tasks.compile.CompilationFailedException: Compilation failed; see the compiler error output for details.
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Great. I joined #debian-mobile to see if I can get some help while I try to fix
this.&lt;/p&gt;

&lt;p&gt;Looking through the output of &lt;code&gt;dpkg-buildpackage -us -uc&lt;/code&gt;, I found this error:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;[...]/common/src/main/java/com/android/xml/AndroidXPathFactory.java:40:
error: AndroidNamespaceContext is not abstract and does not override abstract method getPrefixes(String) in NamespaceContext
    private static class AndroidNamespaceContext implements NamespaceContext {
                   ^
[...]/common/src/main/java/com/android/xml/AndroidXPathFactory.java:84:
error: getPrefixes(String) in AndroidNamespaceContext cannot implement getPrefixes(String) in NamespaceContext
        public Iterator&amp;lt;?&amp;gt; getPrefixes(String namespaceURI) {
                           ^
  return type Iterator&amp;lt;?&amp;gt; is not compatible with Iterator&amp;lt;String&amp;gt;
[...]/common/src/main/java/com/android/xml/AndroidXPathFactory.java:83:
error: method does not override or implement a method from a supertype
        @Override
        ^
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So it seems like the inheritance thing is mismatching on the return type. Let
me swap &lt;code&gt;Iterator&amp;lt;?&amp;gt;&lt;/code&gt; with &lt;code&gt;Iterator&amp;lt;String&amp;gt;&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;OK, this unblocked the compilation, but now I’m getting a ton of errors. Some examples:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;[...]/repository/src/main/java/com/android/repository/api/RepoPackage.java:28:
error: package javax.xml.bind.annotation does not exist
import javax.xml.bind.annotation.XmlTransient;
                                ^
[...]/repository/src/main/java/com/android/repository/api/RepoPackage.java:34:
error: cannot find symbol
@XmlTransient
 ^
  symbol: class XmlTransient
[...]/repository/src/main/java/com/android/repository/impl/meta/TypeDetails.java:21:
error: package javax.xml.bind does not exist
import javax.xml.bind.JAXBElement;
                     ^
[...]/repository/src/main/java/com/android/repository/impl/meta/TypeDetails.java:22:
error: package javax.xml.bind.annotation does not exist
import javax.xml.bind.annotation.XmlTransient;
                                ^
[...]/repository/src/main/java/com/android/repository/impl/meta/TypeDetails.java:35:
error: cannot find symbol
@XmlTransient
 ^
  symbol: class XmlTransient
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is ringing bells. Earlier, I saw this stackoverflow question:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://stackoverflow.com/questions/43574426/how-to-resolve-java-lang-noclassdeffounderror-javax-xml-bind-jaxbexception-in-j&quot;&gt;https://stackoverflow.com/questions/43574426/how-to-resolve-java-lang-noclassdeffounderror-javax-xml-bind-jaxbexception-in-j&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;The JAXB APIs are considered to be Java EE APIs and therefore are no longer
contained on the default classpath in Java SE 9. In Java 11, they are
completely removed from the JDK.&lt;/p&gt;

  &lt;p&gt;The extra Java EE APIs are provided in the following modules:&lt;/p&gt;

  &lt;ul&gt;
    &lt;li&gt;java.activation&lt;/li&gt;
    &lt;li&gt;java.corba&lt;/li&gt;
    &lt;li&gt;java.transaction&lt;/li&gt;
    &lt;li&gt;java.xml.bind  « This one contains the JAXB APIs&lt;/li&gt;
    &lt;li&gt;java.xml.ws&lt;/li&gt;
    &lt;li&gt;java.xml.ws.annotation&lt;/li&gt;
  &lt;/ul&gt;
&lt;/blockquote&gt;

&lt;p&gt;So there’s &lt;code&gt;java.xml.bind&lt;/code&gt;, which was completely removed in Java 11. This is
another indicator that I should probably be compiling this with an older
version of java. Let me find any other evidence that point to the usage of a
specific java version.&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/c/android-platform-tools-base-2.2.2$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;ack -i &quot;java 11&quot;
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/c/android-platform-tools-base-2.2.2$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;ack -i &quot;java 10&quot;
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/c/android-platform-tools-base-2.2.2$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;ack -i &quot;openjdk&quot;
&lt;/span&gt;debian/additionalSrc/intellij-community/platform/util/src/com/intellij/Patches.java
75:   * https://bugs.openjdk.java.net/browse/JDK-8020443
89:   * See https://bugs.openjdk.java.net/browse/JDK-7179799.
95:   * See http://bugs.openjdk.java.net/browse/JDK-8007219
122:   * See &amp;lt;a href=&quot;https://bugs.openjdk.java.net/browse/JDK-8042123&quot;&amp;gt;JDK-8042123&amp;lt;/a&amp;gt;
129:   * Corresponding JDK request for enhancement - &amp;lt;a href=&quot;https://bugs.openjdk.java.net/browse/JDK-8139151&quot;&amp;gt;JDK-8139151&amp;lt;/a&amp;gt;.
135:   * The issue was fixed in JDK 1.8.0_60 as part of &amp;lt;a href=&quot;https://bugs.openjdk.java.net/browse/JDK-8064833&quot;&amp;gt;JDK-8064833&amp;lt;/a&amp;gt;.
146:   * See https://bugs.openjdk.java.net/browse/JDK-8004103.
&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/c/android-platform-tools-base-2.2.2$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;ack -i &quot;java 8&quot;
&lt;/span&gt;[~20 matches, including:]

debian/changelog
19:    * Depends on JDK8 since the code uses Java 8 Streams and lambda.

.idea/inspectionProfiles/Java_8.xml
3:    &amp;lt;option name=&quot;myName&quot; value=&quot;Java 8&quot; /&amp;gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Searching for &lt;code&gt;1_8&lt;/code&gt; also yields a bunch of matches.&lt;/p&gt;

&lt;p&gt;The stackoverflow answer also mentions this:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;For Gradle or Android Studio developer: (JDK 9 and beyond)&lt;/p&gt;

  &lt;p&gt;Add the following dependencies to your build.gradle file:&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;language-gradle highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;dependencies&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// JAX-B dependencies for JDK 9+&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;implementation&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;jakarta.xml.bind:jakarta.xml.bind-api:2.3.2&quot;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;implementation&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;org.glassfish.jaxb:jaxb-runtime:2.3.2&quot;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now I have two choices. Either try to make this work using &lt;code&gt;openjdk11&lt;/code&gt;, or try
to use &lt;code&gt;openjdk8&lt;/code&gt;. Let’s try to downgrade to &lt;code&gt;openjdk8&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@laptop:~# &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;apt purge openjdk-11-{jre,jdk-headless,jre-headless}
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;root@laptop:~# &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;apt install openjdk-8-{jre,jdk,jdk-headless,jre-headless}
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;root@laptop:~# &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;apt build-dep android-platform-tools-base
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I’m going in circles here. &lt;code&gt;build-dep&lt;/code&gt; is reinstalling &lt;code&gt;openjdk11&lt;/code&gt;. I’ll use
the &lt;code&gt;update-alternatives&lt;/code&gt; command to set &lt;code&gt;8&lt;/code&gt; as the default.&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@laptop:~# &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;update-alternatives --config java
&lt;/span&gt;There are 2 choices for the alternative java (providing /usr/bin/java).

  Selection    Path                                            Priority   Status
------------------------------------------------------------
* 0            /usr/lib/jvm/java-11-openjdk-amd64/bin/java      1111      auto mode
  1            /usr/lib/jvm/java-11-openjdk-amd64/bin/java      1111      manual mode
  2            /usr/lib/jvm/java-8-openjdk-amd64/jre/bin/java   1081      manual mode

Press &amp;lt;enter&amp;gt; to keep the current choice[*], or type selection number: 2
update-alternatives: using /usr/lib/jvm/java-8-openjdk-amd64/jre/bin/java to provide /usr/bin/java (java) in manual mode
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Is this good enough to change something? Who knows. Trying to build again.&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;error: package javax.xml.bind.annotation does not exist
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I guess it isn’t. I also tried &lt;code&gt;update-alternatives --config javac&lt;/code&gt;, no difference.&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@laptop:~# &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;update-alternatives --get-selections | grep 11-openjdk | wc -l
&lt;/span&gt;32
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This doesn’t seem like a good way forward. Purging openjdk-8 and going the
other route.&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@laptop:~# &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;apt purge openjdk-8-{jdk,jre,jdk-headless,jre-headless}
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/c/android-platform-tools-base-2.2.2$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;java --version
&lt;/span&gt;openjdk 11.0.7 2020-04-14
OpenJDK Runtime Environment (build 11.0.7+10-post-Debian-3)
OpenJDK 64-Bit Server VM (build 11.0.7+10-post-Debian-3, mixed mode, sharing)
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;OK, so what’s up with this &lt;code&gt;implementation&lt;/code&gt; gradle thing? Where does it go? Do I need to install any packages?
Let me see what’s in my system:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/c/android-platform-tools-base-2.2.2$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;dpkg -l | grep jaxb
&lt;/span&gt;ii  libjaxb-api-java                        2.3.1-1                         all          Java Architecture for XML Binding API

&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/c/android-platform-tools-base-2.2.2$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;dpkg-query -L libjaxb-api-java
&lt;/span&gt;/.
/usr
/usr/share
/usr/share/doc
/usr/share/doc/libjaxb-api-java
/usr/share/doc/libjaxb-api-java/changelog.Debian.gz
/usr/share/doc/libjaxb-api-java/copyright
/usr/share/java
/usr/share/java/jaxb-api.jar
/usr/share/maven-repo
/usr/share/maven-repo/javax
/usr/share/maven-repo/javax/xml
/usr/share/maven-repo/javax/xml/bind
/usr/share/maven-repo/javax/xml/bind/jaxb-api
/usr/share/maven-repo/javax/xml/bind/jaxb-api/2.3.1
/usr/share/maven-repo/javax/xml/bind/jaxb-api/2.3.1/jaxb-api-2.3.1.pom
/usr/share/maven-repo/javax/xml/bind/jaxb-api/debian
/usr/share/maven-repo/javax/xml/bind/jaxb-api/debian/jaxb-api-debian.pom
/usr/share/maven-repo/javax/xml/bind/jaxb-api-parent
/usr/share/maven-repo/javax/xml/bind/jaxb-api-parent/2.3.1
/usr/share/maven-repo/javax/xml/bind/jaxb-api-parent/2.3.1/jaxb-api-parent-2.3.1.pom
/usr/share/maven-repo/javax/xml/bind/jaxb-api-parent/debian
/usr/share/maven-repo/javax/xml/bind/jaxb-api-parent/debian/jaxb-api-parent-debian.pom
/usr/share/java/jaxb-api-2.3.1.jar
/usr/share/maven-repo/javax/xml/bind/jaxb-api/2.3.1/jaxb-api-2.3.1.jar
/usr/share/maven-repo/javax/xml/bind/jaxb-api/debian/jaxb-api-debian.jar
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So there’s a few &lt;code&gt;javax/xml/bind/&lt;/code&gt; files. Why is this not picking them up? Do I
need the &lt;code&gt;maven { url &#39;file:///usr/share/maven-repo&#39; }&lt;/code&gt; thing here as well? Searching a bit more.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://tracker.debian.org/pkg/android-platform-tools-base&quot;&gt;https://tracker.debian.org/pkg/android-platform-tools-base&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://bugs.debian.org/cgi-bin/pkgreport.cgi?repeatmerged=no&amp;amp;src=android-platform-tools-base&quot;&gt;https://bugs.debian.org/cgi-bin/pkgreport.cgi?repeatmerged=no&amp;amp;src=android-platform-tools-base&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=894284&quot;&gt;https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=894284&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This bug seems similar to the one I’m having.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;The javax.xml.bind errors can be simply fixed by adding a dependency on
jaxb-api:
[adding “compile ‘javax.xml.bind:jaxb-api:debian’” to repository/build.gradle]&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Cool, this seems simple.&lt;/p&gt;

&lt;blockquote&gt;

  &lt;p&gt;There is another error with Java 10 caused by a change in the return type of
javax.xml.namespace.NamespaceContext.getPrefixes(). It’s easily fixed with:
[…]&lt;/p&gt;

&lt;/blockquote&gt;

&lt;p&gt;Hey, there’s the &lt;code&gt;getPrefixes&lt;/code&gt; bug I fixed.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Unfortunately there is another issue with SignedJarBuilder:
[…]&lt;/p&gt;

  &lt;p&gt;Once kotlin is in Debian, then we can use newer upstream versions, which
support the latest JDK.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;So it seems that I’ve hit the kotlin hole again. Fixing the &lt;code&gt;javax.xml.bind&lt;/code&gt;
does hit the SignedJarBuilder issue they mention:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;[...]/sdklib/src/main/java/com/android/sdklib/internal/build/SignedJarBuilder.java:22: error: cannot find symbol
import sun.misc.BASE64Encoder;
               ^
  symbol:   class BASE64Encoder
  location: package sun.misc
[...]/sdklib/src/main/java/com/android/sdklib/internal/build/SignedJarBuilder.java:23: error: package sun.security.pkcs is not visible
import sun.security.pkcs.ContentInfo;
                   ^
  (package sun.security.pkcs is declared in module java.base, which does not export it to the unnamed module)
[...]/sdklib/src/main/java/com/android/sdklib/internal/build/SignedJarBuilder.java:26: error: package sun.security.x509 is not visible
import sun.security.x509.AlgorithmId;
                   ^
  (package sun.security.x509 is declared in module java.base, which does not export it to the unnamed module)
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I can try to replace &lt;code&gt;BASE64Encoder&lt;/code&gt; with &lt;code&gt;java.util.Base64&lt;/code&gt;. I should be
tracking these changes in git or something. Getting the Base64 thing to compile
was straightforward. Unsure what to do with the &lt;code&gt;sun.security.*&lt;/code&gt; packages.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;SignedJarBuilder&lt;/code&gt; is deprecated. Maybe I can just remove its implementation
and side step the errors completely? This is going to be great. Removing this
probably means that I will be unable to generate signed APKs, but if I can live
with that for now.&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;Compiling with JDK Java compiler API.
[...]/sdk-common/src/main/java/com/android/ide/common/vectordrawable/VdPreview.java:23:
error: package com.sun.org.apache.xml.internal.serialize is not visible
import com.sun.org.apache.xml.internal.serialize.OutputFormat;
                                      ^
  (package com.sun.org.apache.xml.internal.serialize is declared in module java.xml, which does not export it)
[...]/sdk-common/src/main/java/com/android/ide/common/vectordrawable/VdPreview.java:24:
error: package com.sun.org.apache.xml.internal.serialize is not visible
import com.sun.org.apache.xml.internal.serialize.XMLSerializer;
                                      ^
  (package com.sun.org.apache.xml.internal.serialize is declared in module java.xml, which does not export it)
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is not getting me anywhere. I’m just removing code that doesn’t compile.
I’m pretending to port android-platform-tools base to openjdk11, this can’t be
easy or a quick way to get this done. Let’s backtrack a bit.&lt;/p&gt;

&lt;p&gt;When I started setting up the Dockerfile, I had to use &lt;code&gt;sid&lt;/code&gt; because
&lt;code&gt;libgradle-android-plugin-java&lt;/code&gt; was not available in &lt;code&gt;testing&lt;/code&gt;. But it is
available in another release: &lt;code&gt;stretch&lt;/code&gt;. Let’s try using that instead.&lt;/p&gt;

&lt;h2 id=&quot;dockerfile-using-debianstretch&quot;&gt;Dockerfile using &lt;code&gt;debian:stretch&lt;/code&gt;&lt;/h2&gt;

&lt;p&gt;It seems that &lt;code&gt;android-sdk-helper&lt;/code&gt; was not available in stretch, so I’ll need to patch &lt;code&gt;build.gradle&lt;/code&gt; manually.&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@781970948c66:/app/AndroidHelloWorld# &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;git diff
&lt;/span&gt;diff --git a/build.gradle b/build.gradle
index c3ec2c3..54c4f60 100644
--- a/build.gradle
+++ b/build.gradle
@@ -1,10 +1,11 @@
 buildscript {
     repositories {
         mavenCentral()
+        maven { url &#39;file:///usr/share/maven-repo&#39; }
     }

     dependencies {
-        classpath &#39;com.android.tools.build:gradle:2.1.2&#39;
+        classpath &#39;com.android.tools.build:gradle:debian&#39;
     }
 }

@@ -12,7 +13,7 @@ apply plugin: &#39;com.android.application&#39;

 android {
     compileSdkVersion 23
-    buildToolsVersion &quot;23.0.2&quot;
+    buildToolsVersion &quot;24.0.0&quot;

     lintOptions {
         abortOnError false
&lt;span class=&quot;gp&quot;&gt;root@781970948c66:/app/AndroidHelloWorld# &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;tail -n1 local.properties
&lt;/span&gt;sdk.dir=/usr/lib/android-sdk
&lt;span class=&quot;gp&quot;&gt;root@781970948c66:/app/AndroidHelloWorld# &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;gradle build
&lt;/span&gt;[...]
ECJ compiler crashed
java.lang.RuntimeException: ECJ module temporarily disabled!
[...]
[repeat ECJ exception a few more times]
[...]


BUILD SUCCESSFUL

Total time: 9.303 secs
&lt;span class=&quot;gp&quot;&gt;root@781970948c66:/app/AndroidHelloWorld# &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;find . -name &quot;*.apk&quot;
&lt;/span&gt;./build/outputs/apk/AndroidHelloWorld-release-unsigned.apk
./build/outputs/apk/AndroidHelloWorld-debug.apk
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Well, at least I got something working. Kind of sad that kotlin doesn’t work
and that I need to use stretch. Here’s the current &lt;code&gt;Dockerfile&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-dockerfile highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; debian:stretch&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;apt update
&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;apt &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;android-sdk android-sdk-platform-23 git libgradle-android-plugin-java
&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;apt &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;vim

&lt;span class=&quot;k&quot;&gt;ADD&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; . /app&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;WORKDIR&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; /app&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;mkdir&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; /root/.android/
&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;touch&lt;/span&gt; /root/.android/analytics.settings

&lt;span class=&quot;k&quot;&gt;CMD&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; bash&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Let’s go back to my app. Same thing, setting &lt;code&gt;buildToolsVersion &quot;24.0.0&quot;&lt;/code&gt; and running &lt;code&gt;gradle build&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&amp;gt; You have not accepted the license agreements of the following SDK components:
  [Android Support Repository].
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ah, here we go. I have these two dependencies:&lt;/p&gt;

&lt;div class=&quot;language-gradle highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;n&quot;&gt;compile&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;com.android.support:appcompat-v7:23.1.1&#39;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;compile&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;com.android.support:design:23.1.1&#39;&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And &lt;code&gt;Android Support Library&lt;/code&gt; (&lt;code&gt;com.android.support&lt;/code&gt;) is in the “Needs doing /
low hanging fruit” section of Debian’s wiki page. And I seem to be using it:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/p/http-share-android$ &lt;/span&gt;&lt;span class=&quot;gs&quot;&gt;ack android\.support app/src/main/java/net/hugopeixoto/
&lt;/span&gt;app/src/main/java/net/hugopeixoto/customsharing/UploadActivity.java
19:import android.support.design.widget.FloatingActionButton;
20:import android.support.v4.app.NotificationCompat;
21:import android.support.v7.app.AppCompatActivity;

app/src/main/java/net/hugopeixoto/customsharing/AppCompatPreferenceActivity.java
6:import android.support.annotation.LayoutRes;
7:import android.support.annotation.Nullable;
8:import android.support.v7.app.ActionBar;
9:import android.support.v7.app.AppCompatDelegate;
10:import android.support.v7.widget.Toolbar;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I guess I could try to build this from source, or even package it. But that’s
going to be for another time.&lt;/p&gt;

&lt;h2 id=&quot;conclusions&quot;&gt;Conclusions&lt;/h2&gt;

&lt;p&gt;To build an android application, you need (maybe you don’t?) the Android SDK.
Google distributes Android SDK binaries, but you need to accept an EULA to use
these. The source code is free, though.&lt;/p&gt;

&lt;p&gt;Debian builds &lt;code&gt;android-sdk&lt;/code&gt; packages. This sidesteps the need for accepting
EULAs, along with some other advantages, &lt;a href=&quot;https://wiki.debian.org/AndroidTools#Joining_the_Android_Tools_Team&quot;&gt;listed in their
wiki&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Recent versions of android-sdk depend on Kotlin, and &lt;a href=&quot;https://wiki.debian.org/AndroidTools/Kotlin&quot;&gt;Debian does not package
kotlin yet&lt;/a&gt;. Until this dependency
is solved, the only versions that are available in Debian are in Debian
stretch, since it is based openjdk8. Debian Sid, for example, is based on
&lt;code&gt;openjdk11&lt;/code&gt;, so things don’t work that well.&lt;/p&gt;

&lt;p&gt;Even though I was able to compile a sample app in &lt;code&gt;debian:stretch&lt;/code&gt;, I can’t
build my application, as it depends on &lt;code&gt;com.android.support&lt;/code&gt;, which isn’t
packaged yet.&lt;/p&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2020-05-06:/articles/2020-05-06.html</id>
    <title type="html">File sizes and disk usage</title>
    <published>2020-05-06T00:00:00Z</published>
    <updated>2020-05-06T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/2020-05-06.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;I was backing up my old phone through MTP and went down a filesystem and disk rabbit hole.&lt;/p&gt;
]]>
    </summary>
    <content type="html">
      <![CDATA[
        <aside>
          This is a <code>[journal]</code> entry. It is longer than usual and
          more exploratory. It may have no proper conclusion.
        </aside>
      ]]>

      &lt;p&gt;I was backing up my old phone, running android, so I could flash a new OS. I
deleted most of the stuff via the phone itself, but then I wanted to back up
some files.&lt;/p&gt;

&lt;h2 id=&quot;mtp-fuse-and-filesystem-syscalls&quot;&gt;MTP, FUSE, and filesystem syscalls&lt;/h2&gt;

&lt;p&gt;I connected it via usb to the laptop, and use &lt;code&gt;jmtpfs&lt;/code&gt; to mount the thing:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@laptop:/#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;jmtpfs /mnt/external
&lt;span class=&quot;go&quot;&gt;Device 0 (VID=22b8 and PID=2e82) is a Motorola Moto G (ID2).
Android device detected, assigning default bug flags
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;root@laptop:/#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;ls&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lah&lt;/span&gt; /mnt/external/
&lt;span class=&quot;go&quot;&gt;total 4.0K
drwxr-xr-x  3 root root    0 Jan  1  1970  .
drwxr-xr-x  6 root root 4.0K Jun 16  2017  ..
drwxr-xr-x 16 root root    0 Jul 19  2018 &#39;Internal storage&#39;
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;Sidenote: 1 Jan 1970, nice.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Then I wanted to know how much space I would need in my laptop to back up that
directory. Usually I &lt;code&gt;du -sh .&lt;/code&gt;, but I had a vague memory of that not working
in these partitions. I tried it anyway:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@laptop:/m/e/Internal storage#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;du&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-sh&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;0       .
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Why?&lt;/p&gt;

&lt;p&gt;I know that I have files in here that take up disk space, but even &lt;code&gt;du&lt;/code&gt;ing them
directly doesn’t work:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@laptop:/m/e/Internal storage#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;ls&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lh&lt;/span&gt; Download/.com.google.Chrome.X6yFrG
&lt;span class=&quot;go&quot;&gt;-rw-r--r-- 1 root root 125K Jul  3  2016 Download/.com.google.Chrome.X6yFrG

&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;root@laptop:/m/e/Internal storage#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;du&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-h&lt;/span&gt; Download/.com.google.Chrome.X6yFrG
&lt;span class=&quot;go&quot;&gt;0       Download/.com.google.Chrome.X6yFrG
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I wonder if &lt;code&gt;du&lt;/code&gt; uses a different syscall? or maybe it looks at other
properties? Let’s see what happens with strace.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@laptop:/m/e/Internal storage#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;strace &lt;span class=&quot;nb&quot;&gt;du&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-h&lt;/span&gt; Download/.com.google.Chrome.X6yFrG  &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /dev/null
&lt;span class=&quot;go&quot;&gt;execve(&quot;/usr/bin/du&quot;, [&quot;du&quot;, &quot;-h&quot;, &quot;Download/.com.google.Chrome.X6yF&quot;...], 0x7fff26d27750 /* 22 vars */) = 0
brk(NULL)                               = 0x5611069c6000
access(&quot;/etc/ld.so.preload&quot;, R_OK)      = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, &quot;/etc/ld.so.cache&quot;, O_RDONLY|O_CLOEXEC) = 3
fstat(3, {st_mode=S_IFREG|0644, st_size=112615, ...}) = 0
mmap(NULL, 112615, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7f7cd07db000
close(3)                                = 0
openat(AT_FDCWD, &quot;/lib/x86_64-linux-gnu/libc.so.6&quot;, O_RDONLY|O_CLOEXEC) = 3
read(3, &quot;\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0&amp;gt;\0\1\0\0\0 o\2\0\0\0\0\0&quot;..., 832) = 832
fstat(3, {st_mode=S_IFREG|0755, st_size=1831600, ...}) = 0
mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f7cd07d9000
mmap(NULL, 1844568, PROT_READ, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7f7cd0616000
mmap(0x7f7cd063b000, 1351680, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x25000) = 0x7f7cd063b000
mmap(0x7f7cd0785000, 303104, PROT_READ, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x16f000) = 0x7f7cd0785000
mmap(0x7f7cd07cf000, 24576, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x1b8000) = 0x7f7cd07cf000
mmap(0x7f7cd07d5000, 13656, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x7f7cd07d5000
close(3)                                = 0
arch_prctl(ARCH_SET_FS, 0x7f7cd07da580) = 0
mprotect(0x7f7cd07cf000, 12288, PROT_READ) = 0
mprotect(0x5611055bd000, 4096, PROT_READ) = 0
mprotect(0x7f7cd081f000, 4096, PROT_READ) = 0
munmap(0x7f7cd07db000, 112615)          = 0
brk(NULL)                               = 0x5611069c6000
brk(0x5611069e7000)                     = 0x5611069e7000
openat(AT_FDCWD, &quot;/usr/lib/locale/locale-archive&quot;, O_RDONLY|O_CLOEXEC) = 3
fstat(3, {st_mode=S_IFREG|0644, st_size=3044032, ...}) = 0
mmap(NULL, 3044032, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7f7cd032e000
close(3)                                = 0
newfstatat(AT_FDCWD, &quot;Download/.com.google.Chrome.X6yFrG&quot;, {st_mode=S_IFREG|0644, st_size=127410, ...}, AT_SYMLINK_NOFOLLOW) = 0
fstat(1, {st_mode=S_IFCHR|0666, st_rdev=makedev(0x1, 0x3), ...}) = 0
ioctl(1, TCGETS, 0x7ffef972ddd0)        = -1 ENOTTY (Inappropriate ioctl for device)
write(1, &quot;0\tDownload/.com.google.Chrome.X6&quot;..., 37) = 37
close(1)                                = 0
close(2)                                = 0
exit_group(0)                           = ?
+++ exited with 0 +++
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So du uses &lt;code&gt;newfstatat&lt;/code&gt;, which, according to &lt;code&gt;man stat&lt;/code&gt;:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;The underlying system call employed by the glibc fstatat() wrapper
function is actually called fstatat64() or, on some architectures,
newfstatat().&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;What does &lt;code&gt;ls&lt;/code&gt; use?&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@laptop:/m/e/Internal storage#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;strace &lt;span class=&quot;nb&quot;&gt;ls&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lh&lt;/span&gt; Download/.com.google.Chrome.X6yFrG 2&amp;gt;&amp;amp;1  &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /dev/null | &lt;span class=&quot;nb&quot;&gt;wc&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-l&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;193
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Uff, this is a bit long. Let me filter it down:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@laptop:/m/e/Internal storage#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;strace &lt;span class=&quot;nb&quot;&gt;ls&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lh&lt;/span&gt; Download/.com.google.Chrome.X6yFrG 2&amp;gt;&amp;amp;1 &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /dev/null | &lt;span class=&quot;nb&quot;&gt;grep &lt;/span&gt;Download/
&lt;span class=&quot;go&quot;&gt;execve(&quot;/bin/ls&quot;, [&quot;ls&quot;, &quot;-lh&quot;, &quot;Download/.com.google.Chrome.X6yF&quot;...], 0x7fff2c1c8b90 /* 22 vars */) = 0
lstat(&quot;Download/.com.google.Chrome.X6yFrG&quot;, {st_mode=S_IFREG|0644, st_size=127410, ...}) = 0
lgetxattr(&quot;Download/.com.google.Chrome.X6yFrG&quot;, &quot;security.selinux&quot;, 0x5630117d9f60, 255) = -1 EOPNOTSUPP (Operation not supported)
getxattr(&quot;Download/.com.google.Chrome.X6yFrG&quot;, &quot;system.posix_acl_access&quot;, NULL, 0) = -1 EOPNOTSUPP (Operation not supported)
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Seems to use &lt;code&gt;lstat&lt;/code&gt;. Hm, let’s take a look at them side by side:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;go&quot;&gt;newfstatat(AT_FDCWD, &quot;Download/.com.google.Chrome.X6yFrG&quot;, {st_mode=S_IFREG|0644, st_size=127410, ...}, AT_SYMLINK_NOFOLLOW) = 0
lstat(&quot;Download/.com.google.Chrome.X6yFrG&quot;, {st_mode=S_IFREG|0644, st_size=127410, ...}) = 0
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;They both have &lt;code&gt;st_size=127410&lt;/code&gt;, so it doesn’t seem to be a difference in
syscall behavior. &lt;code&gt;du&lt;/code&gt; may be looking at another property of that structure. My
hypothesis is that it has something to do with blocks vs bytes. I’d like to
print the full structure filled by that syscall, does strace have an option for
that? Maybe &lt;code&gt;stat&lt;/code&gt; print something useful?&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@laptop:/m/e/Internal storage#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;stat &lt;/span&gt;Download/.com.google.Chrome.X6yFrG
&lt;span class=&quot;go&quot;&gt;  File: Download/.com.google.Chrome.X6yFrG
  Size: 127410          Blocks: 0          IO Block: 4096   regular file
Device: 34h/52d Inode: 31          Links: 1
Access: (0644/-rw-r--r--)  Uid: (    0/    root)   Gid: (    0/    root)
Access: 1970-01-01 01:00:00.000000000 +0100
Modify: 2016-07-03 16:33:05.000000000 +0100
Change: 1970-01-01 01:00:00.000000000 +0100
 Birth: -
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ah, &lt;code&gt;Size=127410&lt;/code&gt; and &lt;code&gt;Blocks=0&lt;/code&gt;. This could be it. Let me try with a non &lt;code&gt;/mnt/external&lt;/code&gt; file.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@laptop:/m/e/Internal storage#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;ls&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-l&lt;/span&gt; ~/.bashrc
&lt;span class=&quot;go&quot;&gt;-rw-r--r-- 1 root root 646 Aug  1  2016 /root/.bashrc

&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;root@laptop:/m/e/Internal storage#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;du&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-h&lt;/span&gt; ~/.bashrc
&lt;span class=&quot;go&quot;&gt;4.0K    /root/.bashrc

&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;root@laptop:/m/e/Internal storage#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;stat&lt;/span&gt; ~/.bashrc
&lt;span class=&quot;go&quot;&gt;  File: /root/.bashrc
  Size: 646             Blocks: 8          IO Block: 4096   regular file
Device: fe01h/65025d    Inode: 3670019     Links: 1
Access: (0644/-rw-r--r--)  Uid: (    0/    root)   Gid: (    0/    root)
Access: 2020-05-06 14:47:33.290946241 +0100
Modify: 2016-08-01 16:51:58.622367982 +0100
Change: 2016-08-01 16:51:58.622367982 +0100
 Birth: -
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So we’ve got &lt;code&gt;646&lt;/code&gt; from &lt;code&gt;ls&lt;/code&gt;, which matches stat’s &lt;code&gt;Size&lt;/code&gt;. &lt;code&gt;du&lt;/code&gt; prints &lt;code&gt;4.0K&lt;/code&gt;,
which.. could be &lt;code&gt;512*8&lt;/code&gt;, I guess. Let me read &lt;code&gt;man du&lt;/code&gt;.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Display values are in units of the first available SIZE from –block-size, and
the DU_BLOCK_SIZE, BLOCK_SIZE and BLOCKSIZE environment variables.  Otherwise,
units default to 1024  bytes  (or  512  if POSIXLY_CORRECT is set).&lt;/p&gt;

  &lt;p&gt;The SIZE argument is an integer and optional unit (example: 10K is 10*1024).
Units are K,M,G,T,P,E,Z,Y (powers of 1024) or KB,MB,… (powers of 1000).&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Meh, this is confusing. Let me check the source of &lt;code&gt;du&lt;/code&gt;. Gnu coreutils has a github mirror:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/coreutils/coreutils/blob/master/src/du.c&quot;&gt;https://github.com/coreutils/coreutils/blob/master/src/du.c&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;1kloc, not bad. I wish I could look at a musl equivalent of coreutils.&lt;/p&gt;

&lt;div class=&quot;language-c highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;cm&quot;&gt;/* If true, rather than using the disk usage of each file,
   use the apparent size (a la stat.st_size).  */&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bool&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;apparent_size&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I saw something related to “apparent size” in &lt;code&gt;man du&lt;/code&gt;, so I’m guessing that if I
use that flag I’ll probably get &lt;code&gt;du&lt;/code&gt; to print the same as &lt;code&gt;ls&lt;/code&gt;, but I want to
figure out what it prints by default first. Where is this boolean used?&lt;/p&gt;

&lt;div class=&quot;language-c highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;  &lt;span class=&quot;n&quot;&gt;duinfo_set&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dui&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
              &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;apparent_size&lt;/span&gt;
               &lt;span class=&quot;o&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;MAX&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sb&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;st_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
               &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;uintmax_t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ST_NBLOCKS&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sb&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ST_NBLOCKSIZE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
              &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;time_type&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time_mtime&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get_stat_mtime&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sb&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
               &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time_type&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time_atime&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get_stat_atime&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sb&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
               &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get_stat_ctime&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sb&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)));&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;OK, so we have &lt;code&gt;st_size&lt;/code&gt; for apparent size, and &lt;code&gt;ST_NBLOCKS(*sb) *
ST_NBLOCKSIZE&lt;/code&gt; by default. Googling for &lt;code&gt;ST_NBLOCKS&lt;/code&gt; got me a stackoverflow Q&amp;amp;A:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://unix.stackexchange.com/questions/521151/why-is-st-blocks-always-reported-in-512-byte-blocks&quot;&gt;https://unix.stackexchange.com/questions/521151/why-is-st-blocks-always-reported-in-512-byte-blocks&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Why is st_blocks always reported in 512-byte blocks?
I was debugging a fuse filesystem that was reporting wrong sizes for du. It
turned out that it was putting st_size / st_blksize [*] into st_blocks of the
stat structure. The Linux manual page for stat(2) says:&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;This seems to be a common problem.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;The size of a block is implementation-specific. On Linux it’s always 512
bytes, for historical reasons; in particular, it used to be the typical size
of a disk sector.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;So this seems to match what I thought, it’s &lt;code&gt;8*512&lt;/code&gt;. Out of curiosity, let me
try to find &lt;code&gt;ST_NBLOCKSIZE&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Found something similar:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;ack S_BLKSIZE /usr/include/
&lt;span class=&quot;go&quot;&gt;/usr/include/x86_64-linux-gnu/sys/stat.h
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;199:#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;define S_BLKSIZE  512     /&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; Block size &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;st_blocks&lt;span class=&quot;s1&quot;&gt;&#39;.  */
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;From the internets, &lt;code&gt;ST_NBLOCKSIZE&lt;/code&gt; seems to be &lt;code&gt;#define&lt;/code&gt;d as &lt;code&gt;S_BLKSIZE&lt;/code&gt;, so
this is probably it.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/rofl0r/gnulib/blob/master/lib/stat-size.h#L105&quot;&gt;https://github.com/rofl0r/gnulib/blob/master/lib/stat-size.h#L105&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;And ST_NBLOCKS is defined as:&lt;/p&gt;

&lt;div class=&quot;language-c highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;cp&quot;&gt;#    define ST_NBLOCKS(statbuf) \
  (S_ISREG ((statbuf).st_mode) || S_ISDIR ((statbuf).st_mode) \
     ? (statbuf).st_blocks * ST_BLKSIZE (statbuf) / ST_NBLOCKSIZE : 0)
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And &lt;code&gt;ST_BLKSIZE&lt;/code&gt; (not to be confused with (&lt;code&gt;S_BLKSIZE&lt;/code&gt;) is, most of the times,
&lt;code&gt;st_blksize&lt;/code&gt;. So &lt;code&gt;du&lt;/code&gt; calculates disk usage as:&lt;/p&gt;

&lt;div class=&quot;language-c highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;n&quot;&gt;ST_NBLOCKS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sb&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ST_NBLOCKSIZE&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sb&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;st_blocks&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ST_BLKSIZE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sb&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ST_NBLOCKSIZE&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ST_NBLOCKSIZE&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;sb&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;st_blocks&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sb&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;st_blksize&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;S_BLKSIZE&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;S_BLKSIZE&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;sb&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;st_blocks&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sb&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;st_blksize&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;512&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;512&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;sb&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;st_blocks&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sb&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;st_blksize&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;Sidenote: st_blksize is a multiple of 512, that’s why we’re able to simplify
it by removing / 512 * 512.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;So through a bunch of indirections, this ends up returning file system
information directly.&lt;/p&gt;

&lt;p&gt;Let me try the &lt;code&gt;POSIXLY_CORRECT&lt;/code&gt; thing:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;du history&lt;/span&gt;/bash
&lt;span class=&quot;go&quot;&gt;4992    history/bash
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;POSIXLY_CORRECT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1 &lt;span class=&quot;nb&quot;&gt;du history&lt;/span&gt;/bash
&lt;span class=&quot;go&quot;&gt;9984    history/bash
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;OK, that checks out. The number of blocks doubles, because it uses 512 instead
of 1024.&lt;/p&gt;

&lt;p&gt;Back to the apparent size thing:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@laptop:/m/e/Internal storage#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;du&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-h&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--apparent-size&lt;/span&gt; Download/.com.google.Chrome.X6yFrG
&lt;span class=&quot;go&quot;&gt;125K    Download/.com.google.Chrome.X6yFrG
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;root@laptop:/m/e/Internal storage#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;du&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--apparent-size&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-sh&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;805M    .
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Seems OK. Now, why does &lt;code&gt;stat&lt;/code&gt; return &lt;code&gt;Blocks=0&lt;/code&gt;? This should be related to &lt;code&gt;jmtpfs&lt;/code&gt;. &lt;code&gt;man jmtpfs&lt;/code&gt;:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;jmtpfs is a FUSE and libmtp based filesystem for accessing MTP (Media Transfer
Protocol) devices. It was specifically designed for exchaning files between
Linux (and Mac OS X) systems and newer An‐ droid devices that support MTP but
not USB Mass Storage.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;So, my current guess is that &lt;code&gt;libmtp&lt;/code&gt; does not return filesystem related stuff
and the FUSE part defaults to zero. Checking this by downloading the source for
&lt;code&gt;jmtpfs&lt;/code&gt; and grepping for &lt;code&gt;st_blocks&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/contrib$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;apt &lt;span class=&quot;nb&quot;&gt;source &lt;/span&gt;jmtpfs
&lt;span class=&quot;go&quot;&gt;Reading package lists... Done
NOTICE: &#39;jmtpfs&#39; packaging is maintained in the &#39;Git&#39; version control system at:
git://anonscm.debian.org/collab-maint/jmtpfs.git
Please use:
git clone git://anonscm.debian.org/collab-maint/jmtpfs.git
to retrieve the latest (possibly unreleased) updates to the package.
Need to get 148 kB of source archives.
Get:1 http://ftp.pt.debian.org/debian testing/main jmtpfs 0.5-2 (dsc) [1,874 B]
Get:2 http://ftp.pt.debian.org/debian testing/main jmtpfs 0.5-2 (tar) [143 kB]
Get:3 http://ftp.pt.debian.org/debian testing/main jmtpfs 0.5-2 (diff) [3,321 B]
Fetched 148 kB in 0s (473 kB/s)
dpkg-source: info: extracting jmtpfs in jmtpfs-0.5
dpkg-source: info: unpacking jmtpfs_0.5.orig.tar.gz
dpkg-source: info: unpacking jmtpfs_0.5-2.debian.tar.gz
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/contrib$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;ack st_nblocks jmtpfs-0.5/src/
&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/contrib$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;No luck on the first try. I’ll browse the source a bit. Oh, maybe I didn’t
found any matches because it isn’t set at all.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;ack block jmtpfs-0.5/
&lt;span class=&quot;go&quot;&gt;jmtpfs-0.5/src/MtpNode.cpp
131:    stat-&amp;gt;f_bsize = 512;  // We have to pick some block size, so why not 512?
132:    stat-&amp;gt;f_blocks = storageInfo.maxCapacity / stat-&amp;gt;f_bsize;

jmtpfs-0.5/src/MtpRoot.cpp
111:    stat-&amp;gt;f_bsize = 512;  // We have to pick some block size, so why not 512?
112:    stat-&amp;gt;f_blocks = totalSize / stat-&amp;gt;f_bsize;
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Hm, &lt;code&gt;f_blocks&lt;/code&gt;? What’s the difference between an &lt;code&gt;f_*&lt;/code&gt; and a &lt;code&gt;st_*&lt;/code&gt;?&lt;/p&gt;

&lt;p&gt;So, this uses &lt;code&gt;struct statvfs&lt;/code&gt;. I guess that’s what FUSE should use. But it
seems to be setting &lt;code&gt;f_blocks&lt;/code&gt; to &lt;code&gt;512&lt;/code&gt;, so something is up.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/c/j/src$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;ack st_size
&lt;span class=&quot;go&quot;&gt;MtpFile.cpp
55:             info.st_size = localFile-&amp;gt;getSize();
58:             info.st_size = md.self.filesize;
103:    if (info.st_size == length)
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;OK, so we do have a &lt;code&gt;st_size&lt;/code&gt; being set. And no &lt;code&gt;st_blocks&lt;/code&gt;. What’s MTP anyway?
Does it report blocks? (probably not)&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Media_Transfer_Protocol&quot;&gt;https://en.wikipedia.org/wiki/Media_Transfer_Protocol&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;The Media Transfer Protocol (MTP) is an extension to the Picture Transfer
Protocol (PTP) communications protocol that allows media files to be
transferred atomically to and from portable devices.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;…&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;MTP is a key part of WMDRM10-PD,[1] a digital rights management (DRM) service
for the Windows Media platform.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;…&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;In 2011, it became the standard method to transfer files from/to Android&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;…&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;The USB Implementers Forum device working group standardised MTP as a
full-fledged Universal Serial Bus (USB) device class in May 2008.[4] Since
then MTP is an official extension to PTP and shares the same class code.[5]&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Cool?&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Comparison with USB Mass Storage&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Ah, this sounds promising.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;File oriented instead of block oriented protocol
By not exposing the filesystem and metadata index, the integrity of these is
in full control of the device.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Well, there you go.&lt;/p&gt;

&lt;p&gt;None of my devices support USB Mass Storage. And from this SO answer:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://android.stackexchange.com/questions/190138/how-to-use-usb-mass-storage-mode-on-android-4-3&quot;&gt;https://android.stackexchange.com/questions/190138/how-to-use-usb-mass-storage-mode-on-android-4-3&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;If device implementations have a USB port with USB peripheral mode support,
they:&lt;/p&gt;

  &lt;p&gt;MAY use USB mass storage, but SHOULD use Media Transfer Protocol to
satisfy this requirement.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;It seems like this is by design.&lt;/p&gt;

&lt;p&gt;Now, back to &lt;code&gt;strace&lt;/code&gt;. Is there a way to print the full structure? &lt;code&gt;man
strace&lt;/code&gt;, &lt;code&gt;--no-abbrev&lt;/code&gt; seems like a good candidate:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;go&quot;&gt;--no-abbrev

Print unabbreviated versions of environment, stat, termios, etc. calls.  These
structures are very common in calls and so the default behavior displays a
reasonable subset of structure members.  Use this option to get all of the gory
details.
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Let’s give it a go:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@laptop:/m/e/Internal storage#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;strace &lt;span class=&quot;nt&quot;&gt;--no-abbrev&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;du&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-h&lt;/span&gt; Download/.com.google.Chrome.X6yFrG 2&amp;gt;&amp;amp;1 &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /dev/null | &lt;span class=&quot;nb&quot;&gt;grep &lt;/span&gt;newfstata
&lt;span class=&quot;go&quot;&gt;newfstatat(AT_FDCWD, &quot;Download/.com.google.Chrome.X6yFrG&quot;, {
  st_dev=makedev(0, 0x34),
  st_ino=4,
  st_mode=S_IFREG|0644,
  st_nlink=1,
  st_uid=0,
  st_gid=0,
  st_blksize=4096,
  st_blocks=0,
  st_size=127410,
  st_atime=0,
  st_atime_nsec=0,
  st_mtime=1467559985 /* 2016-07-03T16:33:05+0100 */,
  st_mtime_nsec=0,
  st_ctime=0,
  st_ctime_nsec=0
}, AT_SYMLINK_NOFOLLOW) = 0
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There is it (indented for readability). &lt;code&gt;strace -v&lt;/code&gt; seems to do the same. Not
only the blocks are zero, but there are some timestamp related fields also at
zero. Here’s the same for a non MTP file:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@laptop:/m/e/Internal storage#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;strace &lt;span class=&quot;nt&quot;&gt;-v&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;du&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-h&lt;/span&gt; ~/.bashrc 2&amp;gt;&amp;amp;1 &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /dev/null | &lt;span class=&quot;nb&quot;&gt;grep &lt;/span&gt;newfstata
&lt;span class=&quot;go&quot;&gt;newfstatat(AT_FDCWD, &quot;/root/.bashrc&quot;, {
  st_dev=makedev(0xfe, 0x1),
  st_ino=3670019,
  st_mode=S_IFREG|0644,
  st_nlink=1,
  st_uid=0,
  st_gid=0,
  st_blksize=4096,
  st_blocks=8,
  st_size=646,
  st_atime=1588772853 /* 2020-05-06T14:47:33.290946241+0100 */,
  st_atime_nsec=290946241,
  st_mtime=1470066718 /* 2016-08-01T16:51:58.622367982+0100 */,
  st_mtime_nsec=622367982,
  st_ctime=1470066718 /* 2016-08-01T16:51:58.622367982+0100 */,
  st_ctime_nsec=622367982
}, AT_SYMLINK_NOFOLLOW) = 0
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Curious that there’s a &lt;code&gt;st_blksize&lt;/code&gt; that is not related to &lt;code&gt;st_blocks&lt;/code&gt;. As
explained in one of the above stackoverflow links:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;It indicates the preferred size for I/O, i.e. the amount of data that should
be transferred in one operation for optimal results (ignoring other layers in
the I/O stack).&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;I wonder what the purpose of &lt;code&gt;st_blocks&lt;/code&gt; is. It can’t be just &lt;code&gt;st_size / 512&lt;/code&gt;.
That would be kind of pointless, right?&lt;/p&gt;

&lt;p&gt;Found a thread from 1992, but it doesn’t help much.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://groups.google.com/forum/#!topic/comp.unix.programmer/7saTJ9gRBEM&quot;&gt;https://groups.google.com/forum/#!topic/comp.unix.programmer/7saTJ9gRBEM&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This could be related to sparse files.&lt;/p&gt;

&lt;h2 id=&quot;ext4-and-sparse-files&quot;&gt;ext4 and sparse files&lt;/h2&gt;

&lt;p&gt;Let me look that up and try some cli shenanigans. From the Arch wiki:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://wiki.archlinux.org/index.php/sparse_file&quot;&gt;https://wiki.archlinux.org/index.php/sparse_file&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Creating sparse files
The truncate utility can create sparse files. This command creates a 512 MiB sparse file:&lt;/p&gt;

  &lt;p&gt;$ truncate -s 512M file.img&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/c/j/src$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;truncate&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-s&lt;/span&gt; 512M file.img
&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/c/j/src$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;du&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-sh&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--apparent-size&lt;/span&gt; file.img
&lt;span class=&quot;go&quot;&gt;512M    file.img
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/c/j/src$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;du&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-sh&lt;/span&gt; file.img
&lt;span class=&quot;go&quot;&gt;0       file.img
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/c/j/src$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;stat &lt;/span&gt;file.img
&lt;span class=&quot;go&quot;&gt;  File: file.img
  Size: 536870912       Blocks: 0          IO Block: 4096   regular file
Device: fe01h/65025d    Inode: 2904608     Links: 1
Access: (0644/-rw-r--r--)  Uid: ( 1000/hugopeixoto)   Gid: ( 1000/hugopeixoto)
Access: 2020-05-06 17:11:22.171650277 +0100
Modify: 2020-05-06 17:11:22.171650277 +0100
Change: 2020-05-06 17:11:22.171650277 +0100
 Birth: -
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Hm, so the size is indeed different from &lt;code&gt;Blocks * 512&lt;/code&gt;. This feels like
filesystem specific stuff. I can now either:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;look through ext4’s source code&lt;/li&gt;
  &lt;li&gt;or look for a tool that prints fs data and metadata&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I have the file’s inode thanks to &lt;code&gt;stat&lt;/code&gt;: 2904608. I’m using ext4, so I can use
the &lt;code&gt;debugfs&lt;/code&gt; tool, from &lt;code&gt;apt install e2progs&lt;/code&gt;. This allows me to run different
debug commands.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@laptop:/#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;debugfs &lt;span class=&quot;nt&quot;&gt;-R&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;imap &amp;lt;2904608&amp;gt;&#39;&lt;/span&gt; /dev/mapper/laptop--vg-root
&lt;span class=&quot;go&quot;&gt;debugfs 1.45.6 (20-Mar-2020)
Inode 2904608 is part of block group 354
        located at block 11535681, offset 0x0f00
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Can I read this block? I need the block size, to know where to seek, and the
inode size, to know how much to read.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@laptop:/#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;debugfs &lt;span class=&quot;nt&quot;&gt;-R&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;stats&#39;&lt;/span&gt; /dev/mapper/laptop--vg-root | &lt;span class=&quot;nb&quot;&gt;grep &lt;/span&gt;size | &lt;span class=&quot;nb&quot;&gt;head&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-n9&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;debugfs 1.45.6 (20-Mar-2020)
Filesystem features:      has_journal ext_attr resize_inode dir_index filetype needs_recovery extent flex_bg sparse_super large_file huge_file uninit_bg dir_nlink extra_isize
Block size:               4096
Fragment size:            4096
Flex block group size:    16
Inode size:               256
Required extra isize:     28
Desired extra isize:      28
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So.. I should seek to 11535681&lt;em&gt;4096+0x0f00 and read 256 bytes? 0xf00 is
15&lt;/em&gt;256=3840, so that’s inside the 4096 limit. It’s the last inode in this
block, apparently. It’s kind of a large number, though. Tried reading this with &lt;code&gt;dd&lt;/code&gt;, didn’t work.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@laptop:/#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;dd &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/dev/mapper/laptop--vg-root &lt;span class=&quot;nv&quot;&gt;bs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1 &lt;span class=&quot;nv&quot;&gt;seek&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;47250153216 &lt;span class=&quot;nv&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;256
&lt;span class=&quot;go&quot;&gt;dd: &#39;standard output&#39;: cannot seek: Illegal seek
0+0 records in
0+0 records out
0 bytes copied, 0.000325579 s, 0.0 kB/s
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I hope I don’t accidentally my main partition. This could have to do with the
fact that I’m using an LVM encrypted volume. Maybe seeks are not allowed.&lt;/p&gt;

&lt;p&gt;Crap. I should use &lt;code&gt;skip&lt;/code&gt; when reading, not &lt;code&gt;seek&lt;/code&gt;. &lt;code&gt;seek&lt;/code&gt; is for writing. I
hope I didn’t jumble anything.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@laptop:/#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;dd &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/dev/mapper/laptop--vg-root &lt;span class=&quot;nv&quot;&gt;bs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1 &lt;span class=&quot;nv&quot;&gt;skip&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;47250153216 &lt;span class=&quot;nv&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;256 | xxd
&lt;span class=&quot;go&quot;&gt;256+0 records in
256+0 records out
256 bytes copied, 0.00061617 s, 415 kB/s
00000000: a481 e803 0000 0020 aae1 b25e aae1 b25e  ....... ...^...^
00000010: aae1 b25e 0000 0000 e803 0100 0000 0000  ...^............
00000020: 0000 0800 0100 0000 0af3 0000 0400 0000  ................
00000030: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000040: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000050: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000060: 0000 0000 64e2 2b6f 0000 0000 0000 0000  ....d.+o........
00000070: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000080: 2000 0000 94b3 ec28 94b3 ec28 94b3 ec28   ......(...(...(
00000090: aae1 b25e 94b3 ec28 0000 0000 0000 0000  ...^...(........
000000a0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000000b0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000000c0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000000d0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000000e0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000000f0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So this is my inode. Cool. Let me try to write a single byte at pos=0 in the
sparse file and try again (checking if the inode changes before running &lt;code&gt;dd&lt;/code&gt; again).&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/c/j/src$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-n&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;*&quot;&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;dd &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;file.img &lt;span class=&quot;nv&quot;&gt;bs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1 &lt;span class=&quot;nv&quot;&gt;seek&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0 &lt;span class=&quot;nv&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1
&lt;span class=&quot;go&quot;&gt;1+0 records in
1+0 records out
1 byte copied, 0.000335263 s, 3.0 kB/s

&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/c/j/src$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;stat &lt;/span&gt;file.img | &lt;span class=&quot;nb&quot;&gt;grep &lt;/span&gt;Inode
&lt;span class=&quot;go&quot;&gt;Device: fe01h/65025d    Inode: 2904608     Links: 1

&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;root@laptop:/#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;dd &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/dev/mapper/laptop--vg-root &lt;span class=&quot;nv&quot;&gt;bs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1 &lt;span class=&quot;nv&quot;&gt;skip&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;47250153216 &lt;span class=&quot;nv&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;256 | xxd
&lt;span class=&quot;go&quot;&gt;256+0 records in
256+0 records out
256 bytes copied, 0.00263862 s, 97.0 kB/s
00000000: a481 e803 0100 0000 aae1 b25e e7f9 b25e  ...........^...^
00000010: e7f9 b25e 0000 0000 e803 0100 0800 0000  ...^............
00000020: 0000 0800 0100 0000 0af3 0100 0400 0000  ................
00000030: 0000 0000 0000 0000 0100 0000 bc6d 5a00  .............mZ.
00000040: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000050: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000060: 0000 0000 64e2 2b6f 0000 0000 0000 0000  ....d.+o........
00000070: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000080: 2000 0000 00b1 c3df 00b1 c3df 94b3 ec28   ..............(
00000090: aae1 b25e 94b3 ec28 0000 0000 0000 0000  ...^...(........
000000a0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000000b0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000000c0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000000d0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000000e0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000000f0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;OK, inode stayed the same. I don’t see the &lt;code&gt;*&lt;/code&gt; in here, which makes sense. File
contents are not inlined.&lt;/p&gt;

&lt;p&gt;What’s the difference between these two? I need to know what these fields mean
first.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://ext4.wiki.kernel.org/index.php/Ext4_Disk_Layout#Inode_Table&quot;&gt;https://ext4.wiki.kernel.org/index.php/Ext4_Disk_Layout#Inode_Table&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Let’s see if I can decode the timestamps.&lt;/p&gt;

&lt;p&gt;Access time, offset 0x8, size=0x4&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;sudo dd &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;status&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;none &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/dev/mapper/laptop--vg-root &lt;span class=&quot;nv&quot;&gt;bs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1 &lt;span class=&quot;nv&quot;&gt;skip&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;47250153216 &lt;span class=&quot;nv&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;256 |
&lt;span class=&quot;go&quot;&gt;&amp;gt; ruby -e &quot;puts Time.at(STDIN.read[0x8...(0x8+4)].unpack(&#39;V&#39;)[0])&quot;
2020-05-06 17:11:22 +0100
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;Sidenote: &lt;a href=&quot;https://ruby-doc.org/core-2.7.1/String.html#method-i-unpack&quot;&gt;https://ruby-doc.org/core-2.7.1/String.html#method-i-unpack&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Looks sane. OK, now that I know I’m reading the right thing, let’s see what
else is in this table.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;| 0x1C | __le32 | i_blocks_lo	| Lower 32-bits of “block” count. If the huge_file
feature flag is not set on the filesystem, the file consumes i_blocks_lo
512-byte blocks on disk.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;sudo dd &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;status&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;none &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/dev/mapper/laptop--vg-root &lt;span class=&quot;nv&quot;&gt;bs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1 &lt;span class=&quot;nv&quot;&gt;skip&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;47250153216 &lt;span class=&quot;nv&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;256 |
&lt;span class=&quot;go&quot;&gt;&amp;gt; ruby -e &quot;puts STDIN.read[0x1C...(0x1C+4)].unpack(&#39;V&#39;)&quot;
8
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So this is currently taking 8 blocks? What does &lt;code&gt;stat&lt;/code&gt; say again?&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/c/j/src$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;stat &lt;/span&gt;file.img | &lt;span class=&quot;nb&quot;&gt;grep &lt;/span&gt;Blocks
&lt;span class=&quot;go&quot;&gt;  Size: 1               Blocks: 8          IO Block: 4096   regular file
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;OK, so &lt;code&gt;stat&lt;/code&gt; reads what’s in this table. The 512 thing is referenced in the
ext4 docs again.&lt;/p&gt;

&lt;p&gt;What if I now write a byte to the end of the file? What changes?&lt;/p&gt;

&lt;p&gt;Oh no, I just noticed that when I wrote to the first byte, I lost the
sparseness of the file:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/c/j/src$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;du&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--apparent-size&lt;/span&gt; file.img
&lt;span class=&quot;go&quot;&gt;1       file.img
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That’s fine. The inode exploration still stands. I should have used &lt;code&gt;conv=notrunc&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-n&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;*&quot;&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;dd &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;file.img &lt;span class=&quot;nv&quot;&gt;bs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1 &lt;span class=&quot;nv&quot;&gt;seek&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0 &lt;span class=&quot;nv&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1 &lt;span class=&quot;nv&quot;&gt;conv&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;sparse &lt;span class=&quot;nv&quot;&gt;conv&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;notrunc
&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;stat &lt;/span&gt;file.img
&lt;span class=&quot;go&quot;&gt;  File: file.img
  Size: 536870912       Blocks: 8          IO Block: 4096   regular file
Device: fe01h/65025d    Inode: 2901111     Links: 1
Access: (0644/-rw-r--r--)  Uid: ( 1000/hugopeixoto)   Gid: ( 1000/hugopeixoto)
Access: 2020-05-06 20:40:26.700433373 +0100
Modify: 2020-05-06 20:40:29.600453655 +0100
Change: 2020-05-06 20:40:29.600453655 +0100
 Birth: -
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;OK, ready to go. New offsets: &lt;code&gt;inode=2901111, offset=47249257984&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;Writing last byte:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-n&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;*&quot;&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;dd &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;file.img &lt;span class=&quot;nv&quot;&gt;bs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1 &lt;span class=&quot;nv&quot;&gt;seek&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;536870911 &lt;span class=&quot;nv&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1 &lt;span class=&quot;nv&quot;&gt;conv&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;notrunc
&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;stat &lt;/span&gt;file.img
&lt;span class=&quot;go&quot;&gt;  File: file.img
  Size: 536870912       Blocks: 16         IO Block: 4096   regular file
Device: fe01h/65025d    Inode: 2901111     Links: 1
Access: (0644/-rw-r--r--)  Uid: ( 1000/hugopeixoto)   Gid: ( 1000/hugopeixoto)
Access: 2020-05-06 20:40:26.700433373 +0100
Modify: 2020-05-06 20:43:57.649962142 +0100
Change: 2020-05-06 20:43:57.649962142 +0100
 Birth: -
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;du&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-h&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--apparent-size&lt;/span&gt; file.img
&lt;span class=&quot;go&quot;&gt;512M    file.img
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;du&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-h&lt;/span&gt; file.img
&lt;span class=&quot;go&quot;&gt;8.0K    file.img
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Size stays at 512M, but disk usage is low. How does the file system handle this? Let’s take a look at the inode entry again (since I had to recreate the file anyway):&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;sudo dd &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;status&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;none &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/dev/mapper/laptop--vg-root &lt;span class=&quot;nv&quot;&gt;bs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1 &lt;span class=&quot;nv&quot;&gt;skip&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;47249257984 &lt;span class=&quot;nv&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;256 | xxd
&lt;span class=&quot;go&quot;&gt;00000000: a481 e803 0000 0020 aa12 b35e 7d13 b35e  ....... ...^}..^
00000010: 7d13 b35e 0000 0000 e803 0100 1000 0000  }..^............
00000020: 0000 0800 0100 0000 0af3 0200 0400 0000  ................
00000030: 0000 0000 0000 0000 0100 0000 0038 ab02  .............8..
00000040: ffff 0100 0100 0000 0000 ad02 0000 0000  ................
00000050: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000060: 0000 0000 fc40 b686 0000 0000 0000 0000  .....@..........
00000070: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000080: 2000 0000 788a f69a 788a f69a 740f ffa6   ...x...x...t...
00000090: aa12 b35e 740f ffa6 0000 0000 0000 0000  ...^t...........
000000a0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000000b0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000000c0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000000d0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000000e0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000000f0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There’s a flags field, let’s see what’s up there. Also, I need an alias to get the block info.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;alias &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;getblock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;sudo dd status=none if=/dev/mapper/laptop--vg-root bs=1 skip=47249257984 count=256&quot;&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;getblock | ruby &lt;span class=&quot;nt&quot;&gt;-e&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;puts STDIN.read[0x20..(0x20+4)].unpack(&#39;V&#39;)[0].to_s(16)&quot;&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;80000
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;code&gt;0x80000&lt;/code&gt; means that the inode uses extents:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;In ext4, the file to logical block map has been replaced with an extent tree.
Under the old scheme, allocating a contiguous run of 1,000 blocks requires an
indirect block to map all 1,000 entries; with extents, the mapping is reduced
to a single struct ext4_extent with ee_len = 1000.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;So, what I’m getting from this is that file contents are in blocks, and there’s
a map somewhere to point file block 1 to disk block X, file block 2 to disk
block Y, etc. Before there had to be an entry for every file block. Now, if
contiguous file blocks are in contiguous disk blocks, this can be compressed
using extents. Let’s see where we can find that information for &lt;code&gt;file.img&lt;/code&gt;. Where do we start?&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;| 0x28 | 60 bytes | i_block[EXT4_N_BLOCKS=15] | Block map or extent tree. See
the section “The Contents of inode.i_block”.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;getblock | ruby &lt;span class=&quot;nt&quot;&gt;-e&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;puts STDIN.read[0x28..(0x28+60)]&quot;&lt;/span&gt; | xxd
&lt;span class=&quot;go&quot;&gt;00000000: 0af3 0200 0400 0000 0000 0000 0000 0000  ................
00000010: 0100 0000 0038 ab02 ffff 0100 0100 0000  .....8..........
00000020: 0000 ad02 0000 0000 0000 0000 0000 0000  ................
00000030: 0000 0000 0000 0000 0000 0000 fc0a       ..............
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There’s a &lt;code&gt;0af3&lt;/code&gt;, which matches the documentation (considering endianess):&lt;/p&gt;

&lt;blockquote&gt;
  &lt;table&gt;
    &lt;tbody&gt;
      &lt;tr&gt;
        &lt;td&gt;0x0&lt;/td&gt;
        &lt;td&gt;__le16&lt;/td&gt;
        &lt;td&gt;eh_magic&lt;/td&gt;
        &lt;td&gt;Magic number, 0xF30A.&lt;/td&gt;
      &lt;/tr&gt;
    &lt;/tbody&gt;
  &lt;/table&gt;
&lt;/blockquote&gt;

&lt;p&gt;Let’s extract the full header:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;getblock | ruby &lt;span class=&quot;nt&quot;&gt;-e&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;puts STDIN.read[0x28..(0x28+60)].unpack(&#39;H4vvvV&#39;)&quot;&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;0af3
2
4
0
0
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Magic number, check. 2 entries, maximum of 4, depth level 0. The depth level is important:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Depth of this extent node in the extent tree. 0 = this extent node points to data blocks&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;So, this could be 2 entries pointing to one datablock each. One for the
beginning of the sparse file and one for the end of the sparse file, maybe? If
each data block is 4096 bytes, that would be 8k disk usage. These two entries
point directly to data blocks, so they’re of the type &lt;code&gt;struct ext4_extent&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;go&quot;&gt;| 0x0 | __le32 | ee_block    | First file block number that this extent covers.
| 0x4 | __le16 | ee_len      | Number of blocks covered by extent. [...]
| 0x6 | __le16 | ee_start_hi | Upper 16-bits of the block number to which this extent points.
| 0x8 | __le32 | ee_start_lo | Lower 32-bits of the block number to which this extent points.
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Let’s get their info:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;getblock | ruby &lt;span class=&quot;nt&quot;&gt;-e&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;puts STDIN.read[0x28..(0x28+60)][0xC...(0xC+12)].unpack(&#39;VvvV&#39;)&quot;&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;0
1
0
44775424
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;getblock | ruby &lt;span class=&quot;nt&quot;&gt;-e&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;puts STDIN.read[0x28..(0x28+60)][0xC+12...(0xC+12+12)].unpack(&#39;VvvV&#39;)&quot;&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;131071
1
0
44892160
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So the first extent points to the first &lt;em&gt;file&lt;/em&gt; block, and it matches the &lt;em&gt;disk&lt;/em&gt;
block 44775424. The second extent points to the &lt;em&gt;file&lt;/em&gt; block 131071, and it
matches the &lt;em&gt;disk&lt;/em&gt; block 44892160. Cute!&lt;/p&gt;

&lt;p&gt;Let’s try to read the data blocks:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;sudo dd &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;status&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;none &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/dev/mapper/laptop--vg-root &lt;span class=&quot;nv&quot;&gt;bs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;4096 &lt;span class=&quot;nv&quot;&gt;skip&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;44775424 &lt;span class=&quot;nv&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1 | xxd | &lt;span class=&quot;nb&quot;&gt;head&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-n3&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;00000000: 2a00 0000 0000 0000 0000 0000 0000 0000  *...............
00000010: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000020: 0000 0000 0000 0000 0000 0000 0000 0000  ................
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;sudo dd &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;status&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;none &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/dev/mapper/laptop--vg-root &lt;span class=&quot;nv&quot;&gt;bs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;4096 &lt;span class=&quot;nv&quot;&gt;skip&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;44892160 &lt;span class=&quot;nv&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1 | xxd | &lt;span class=&quot;nb&quot;&gt;tail&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-n3&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;00000fd0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000fe0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000ff0: 0000 0000 0000 0000 0000 0000 0000 002a  ...............*
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There are my asterisks. Notice head vs tail.&lt;/p&gt;

&lt;p&gt;Back to the 512 byte block size. What’s up with that? Apparently, according to
the internet, it matches the physical sector size of older hard drives.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;https://askubuntu.com/questions/1144535/is-the-default-512-byte-physical-sector-size-appropriate-for-ssd-disks-under-lin&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Nowadays disks use 4096 byte blocks, but to keep everything compatible, we
still use 512?&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;stat&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; /dev/nvme0
&lt;span class=&quot;go&quot;&gt;  File: &quot;/dev/nvme0&quot;
    ID: 0        Namelen: 255     Type: tmpfs
Block size: 4096       Fundamental block size: 4096
Blocks: Total: 996251     Free: 996251     Available: 996251
Inodes: Total: 996251     Free: 995747

&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;fdisk &lt;span class=&quot;nt&quot;&gt;-l&lt;/span&gt; /dev/nvme0n1p3
&lt;span class=&quot;go&quot;&gt;Disk /dev/nvme0n1p3: 237.75 GiB, 255266390016 bytes, 498567168 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So &lt;code&gt;stat&lt;/code&gt;ting the disk reports a bunch of block sizes = 4096. It matches the IO
blocks that show up when &lt;code&gt;stat&lt;/code&gt;ting a file. &lt;code&gt;fdisk&lt;/code&gt;ing the partition, though,
displays &lt;code&gt;512&lt;/code&gt; all over the place.&lt;/p&gt;

&lt;p&gt;I wonder what kind of syscalls, or metadata, all of these come from.&lt;/p&gt;

&lt;h2 id=&quot;fdisk-units-sector-sizes-and-io-sizes&quot;&gt;fdisk: units, sector sizes and I/O sizes&lt;/h2&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@laptop:~#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;strace &lt;span class=&quot;nt&quot;&gt;-v&lt;/span&gt; fdisk &lt;span class=&quot;nt&quot;&gt;-l&lt;/span&gt; /dev/nvme0n1 2&amp;gt;&amp;amp;1 &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;/dev/null| &lt;span class=&quot;nb&quot;&gt;grep &lt;/span&gt;512
&lt;span class=&quot;go&quot;&gt;ioctl(3, BLKIOMIN, [512])               = 0
ioctl(3, BLKIOOPT, [512])               = 0
ioctl(3, BLKPBSZGET, [512])             = 0
ioctl(3, BLKSSZGET, [512])              = 0
ioctl(3, BLKSSZGET, [512])              = 0
read(3, &quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;..., 512) = 512
read(3, &quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;..., 512) = 512
lseek(3, 512, SEEK_SET)                 = 512
read(3, &quot;EFI PART\0\0\1\0\\\0\0\0\300W\215\226\0\0\0\0\1\0\0\0\0\0\0\0&quot;..., 512) = 512
read(3, &quot;EFI PART\0\0\1\0\\\0\0\0\16\372\2731\0\0\0\0\2572\317\35\0\0\0\0&quot;..., 512) = 512
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;code&gt;BLKIOMIN&lt;/code&gt; and &lt;code&gt;BLKIOOPT&lt;/code&gt; are probably &lt;code&gt;I/O size (minimum/optimal)&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;code&gt;BLKSSZGET&lt;/code&gt; and &lt;code&gt;BLKPBSZGET&lt;/code&gt; are &lt;code&gt;Sector size (logical/physical)&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;Unsure about that &lt;code&gt;Units: sector of 1 * 512&lt;/code&gt;.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Sidenote: I just learned of &lt;code&gt;strace -s N&lt;/code&gt;, which increases the default string
size before it gets ellipsed.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;I’ll check &lt;code&gt;fdisk&lt;/code&gt;’s source, with every value being 512 it’s a bit hard to
understand where &lt;code&gt;Units&lt;/code&gt; comes from.&lt;/p&gt;

&lt;p&gt;From a random mirror:&lt;/p&gt;

&lt;p&gt;https://github.com/karelzak/util-linux/blob/master/disk-utils/fdisk-list.c#L76&lt;/p&gt;

&lt;div class=&quot;language-c highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;n&quot;&gt;fdisk_info&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cxt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Units: %s of %d * %ld = %ld bytes&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;fdisk_get_unit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cxt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FDISK_PLURAL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;fdisk_get_units_per_sector&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cxt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;fdisk_get_sector_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cxt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;fdisk_get_units_per_sector&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cxt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;fdisk_get_sector_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cxt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;fdisk_info&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cxt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Sector size (logical/physical): %lu bytes / %lu bytes&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;fdisk_get_sector_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cxt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;fdisk_get_physector_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cxt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;fdisk_info&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cxt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;I/O size (minimum/optimal): %lu bytes / %lu bytes&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;fdisk_get_minimal_iosize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cxt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;fdisk_get_optimal_iosize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cxt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It seems to use &lt;code&gt;sector_size&lt;/code&gt; (&lt;code&gt;ioctl BLKSSZGET&lt;/code&gt;) in &lt;code&gt;Units&lt;/code&gt; as well. Trying to
figure out where the actual &lt;code&gt;ioctl&lt;/code&gt; is called. Currently going through
&lt;code&gt;topology.c&lt;/code&gt; and &lt;code&gt;topology/ioctl.c&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Tracing it to &lt;code&gt;probe.c:blkid_probe_get_sectorsize&lt;/code&gt;. Onto
&lt;code&gt;lib/blkdev.c:blkdev_get_sector_size&lt;/code&gt;, and here it is. Unsure why this is so
different from the other three, which are defined in &lt;code&gt;topology/ioctl.c&lt;/code&gt;. Saving
syscalls, maybe.&lt;/p&gt;

&lt;h2 id=&quot;nvme-device-drivers&quot;&gt;NVME device drivers&lt;/h2&gt;

&lt;p&gt;&lt;code&gt;ioctl&lt;/code&gt; calls are usually handled by the device driver. I suppose my SSD
requires a device driver, but I have no idea what it is.&lt;/p&gt;

&lt;p&gt;https://unix.stackexchange.com/questions/248494/how-to-find-the-driver-module-associated-with-sata-device-on-linux&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Use &lt;code&gt;udevadm info&lt;/code&gt; as described in the other answer to the link you mentioned&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;I know that &lt;code&gt;udev&lt;/code&gt; handles devices and hotplug, so I guess it makes sense that
it can list the device drivers.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@laptop:~#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;udevadm info &lt;span class=&quot;nt&quot;&gt;-a&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-n&lt;/span&gt; /dev/nvme0 | egrep looking&lt;span class=&quot;se&quot;&gt;\|&lt;/span&gt;DRIVER
&lt;span class=&quot;go&quot;&gt;  looking at device &#39;/devices/pci0000:00/0000:00:1d.0/0000:3c:00.0/nvme/nvme0&#39;:
    DRIVER==&quot;&quot;
  looking at parent device &#39;/devices/pci0000:00/0000:00:1d.0/0000:3c:00.0&#39;:
    DRIVERS==&quot;nvme&quot;
  looking at parent device &#39;/devices/pci0000:00/0000:00:1d.0&#39;:
    DRIVERS==&quot;pcieport&quot;
  looking at parent device &#39;/devices/pci0000:00&#39;:
    DRIVERS==&quot;&quot;
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I suppose that the relevant part is the &lt;code&gt;nvme&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;https://github.com/torvalds/linux/tree/master/drivers/nvme&lt;/p&gt;

&lt;p&gt;A &lt;code&gt;host&lt;/code&gt; and a &lt;code&gt;target&lt;/code&gt; directory. What are those? They both seem small. Can I
shallowly clone this directory? I don’t want to clone the full kernel tree.
Meh, maybe it’s fast. Trying to shallow clone.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/contrib$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;git clone https://github.com/torvalds/linux &lt;span class=&quot;nt&quot;&gt;--depth&lt;/span&gt; 1 &lt;span class=&quot;nt&quot;&gt;--no-checkout&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;Cloning into &#39;linux&#39;...
remote: Enumerating objects: 72113, done.
remote: Counting objects: 100% (72113/72113), done.
remote: Compressing objects: 100% (67592/67592), done.
remote: Total 72113 (delta 5341), reused 24234 (delta 3791), pack-reused 0
Receiving objects: 100% (72113/72113), 190.56 MiB | 6.87 MiB/s, done.
Resolving deltas: 100% (5341/5341), done.
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/c/linux$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;git checkout master
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;A minute or so, not bad. Found this:&lt;/p&gt;

&lt;div class=&quot;language-c highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;c1&quot;&gt;// in block/ioctl.c:&lt;/span&gt;
&lt;span class=&quot;cm&quot;&gt;/*
 * Common commands that are handled the same way on native and compat
 * user space. Note the separate arg/argp parameters that are needed
 * to deal with the compat_ptr() conversion.
 */&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;blkdev_common_ioctl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;block_device&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bdev&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fmode_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cmd&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;arg&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;__user&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;argp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;max_sectors&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;switch&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cmd&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// [...]&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BLKSSZGET&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;cm&quot;&gt;/* get block device logical block size */&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;put_int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;argp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bdev_logical_block_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bdev&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// [...]&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And that leads to:&lt;/p&gt;

&lt;div class=&quot;language-c highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;c1&quot;&gt;// in include/linux/blkdev.h&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;inline&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;queue_logical_block_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;request_queue&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;q&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;retval&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;512&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;q&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;q&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;limits&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;logical_block_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;retval&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;q&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;limits&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;logical_block_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;retval&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;inline&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;bdev_logical_block_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;block_device&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bdev&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;queue_logical_block_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bdev_get_queue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bdev&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There’s a hardcoded 512 again. Does anyone set &lt;code&gt;limits.logical_block_size&lt;/code&gt;?&lt;/p&gt;

&lt;div class=&quot;language-c highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;c1&quot;&gt;// in block/blk-settings.c&lt;/span&gt;

&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;blk_set_default_limits&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;queue_limits&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// [...]&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;lim&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;logical_block_size&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lim&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;physical_block_size&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lim&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;io_min&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;512&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;// [...]&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// [...]&lt;/span&gt;

&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;blk_queue_logical_block_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;request_queue&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;q&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;q&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;limits&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;logical_block_size&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;q&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;limits&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;physical_block_size&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;q&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;limits&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;physical_block_size&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;q&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;limits&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;io_min&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;q&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;limits&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;physical_block_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;q&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;limits&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;io_min&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;q&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;limits&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;physical_block_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// [...]&lt;/span&gt;

&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;blk_stack_limits&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;queue_limits&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;queue_limits&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sector_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// [...]&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;logical_block_size&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;max&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;logical_block_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;logical_block_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// [...]&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Another default, a setter, and something about “stacked drivers like MD and
DM”. The NVME driver has a few calls to the setter:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/c/l/d/nvme$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;ack blk_queue_logical_block_size
&lt;span class=&quot;go&quot;&gt;host/multipath.c
383:    blk_queue_logical_block_size(q, 512);

host/core.c
1843:   blk_queue_logical_block_size(disk-&amp;gt;queue, bs);
3594:   blk_queue_logical_block_size(ns-&amp;gt;queue, 1 &amp;lt;&amp;lt; ns-&amp;gt;lba_shift);
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Let’s see what’s up in &lt;code&gt;core.c&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-c highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;nvme_update_disk_info&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gendisk&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;disk&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nvme_ns&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nvme_id_ns&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// [...]&lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;short&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lba_shift&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// [...]&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lba_shift&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PAGE_SHIFT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;cm&quot;&gt;/* unsupported block size, set capacity to 0 later */&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;bs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;9&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// [...]&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;blk_queue_logical_block_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;disk&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;queue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// [...]&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;


&lt;span class=&quot;c1&quot;&gt;// [...]&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;nvme_alloc_ns&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nvme_ctrl&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ctrl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nsid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// [...]&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lba_shift&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;9&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;cm&quot;&gt;/* set to a default value for 512 until disk is validated */&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;blk_queue_logical_block_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;queue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lba_shift&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// [...]&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So, apart from another pair of 512s, it may be the result of reading from &lt;code&gt;ns-&amp;gt;lba_shift&lt;/code&gt;.
What’s LBA?&lt;/p&gt;

&lt;p&gt;https://en.wikipedia.org/wiki/Logical_block_addressing&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Logical block addressing (LBA) is a common scheme used for specifying the
location of blocks of data stored on computer storage devices, generally
secondary storage systems such as hard disk drives.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;code&gt;ns-&amp;gt;lba_shift&lt;/code&gt; seems to be nvme specific, because &lt;code&gt;ns&lt;/code&gt; is &lt;code&gt;struct nvme_ns *&lt;/code&gt;,
so I searched only in &lt;code&gt;drivers/nvme&lt;/code&gt;. Got this:&lt;/p&gt;

&lt;div class=&quot;language-c highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;__nvme_revalidate_disk&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gendisk&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;disk&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nvme_id_ns&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nvme_ns&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;disk&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;private_data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;cm&quot;&gt;/*
   * If identify namespace failed, use default 512 byte block size so
   * block layer can use before failing read/write for 0 capacity.
   */&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lba_shift&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lbaf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;flbas&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;NVME_NS_FLBAS_LBA_MASK&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lba_shift&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lba_shift&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;9&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There are two setters of &lt;code&gt;lbaf&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-c highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;c1&quot;&gt;// target/admin-cmd.c&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nlbaf&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lbaf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ds&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;blksize_shift&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// host/lightnvm.c&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;nvme_nvm_set_addr_20&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;geo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;addrf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lbaf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;code&gt;lightnvm&lt;/code&gt; is a different driver, so I’m ignoring that. &lt;code&gt;target/admin-cmd&lt;/code&gt;
seems to refer to &lt;code&gt;Admin commands&lt;/code&gt;. SSDs have two command queues:&lt;/p&gt;

&lt;p&gt;https://metebalci.com/blog/a-quick-tour-of-nvm-express-nvme/&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Admin Commands are sent to Admin Submission and Completion Queue (there is
only one of this pair with identifier=0).&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;I/O Commands (called NVM Commands) are sent to I/O Submission and Completion
Queues. I/O Command Queues has to be explicitly managed (created / deleted
etc.)&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;So, where does &lt;code&gt;ns-&amp;gt;blksize_shift&lt;/code&gt; come from?&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/c/l/d/nvme$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;ack &lt;span class=&quot;s1&quot;&gt;&#39;blksize_shift =&#39;&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;target/io-cmd-bdev.c
66:     ns-&amp;gt;blksize_shift = blksize_bits(bdev_logical_block_size(ns-&amp;gt;bdev));

target/io-cmd-file.c
56:     ns-&amp;gt;blksize_shift = min_t(u8,
78:     ns-&amp;gt;blksize_shift = 0;
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I’m guessing that I care about io-cmd-bdev, since this is not related to a
specific file, but to the block device.&lt;/p&gt;

&lt;p&gt;Wait.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;bdev_logical_block_size&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;I’ve seen that before.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;code&gt;bdev_logical_block_size&lt;/code&gt; calls &lt;code&gt;queue_logical_block_size&lt;/code&gt;,&lt;/li&gt;
  &lt;li&gt;which reads &lt;code&gt;limits.logical_block_size&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;which is set by &lt;code&gt;blk_queue_logical_block_size&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;which is called with &lt;code&gt;ns-&amp;gt;lba_shift&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;which is set to &lt;code&gt;id-&amp;gt;lbaf[0].ds&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;which is set to &lt;code&gt;ns-&amp;gt;blksize_shift&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;which is initialized to &lt;code&gt;bdev_logical_block_size&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I may haved missed something. Apart from a bunch of 512 escape hatches, I don’t
think this fetches any value from anywhere. I guess it could be manually set,
or somehow overriden? I’m not sure.&lt;/p&gt;

&lt;p&gt;I’ll move on to &lt;code&gt;stat&lt;/code&gt; and come back to this later.&lt;/p&gt;

&lt;h2 id=&quot;stat-block-sizes-and-fundamental-block-sizes&quot;&gt;stat: block sizes and fundamental block sizes&lt;/h2&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@laptop:/#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;strace &lt;span class=&quot;nt&quot;&gt;-s&lt;/span&gt; 1024 &lt;span class=&quot;nt&quot;&gt;-v&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;stat&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; /dev/nvme0 2&amp;gt;&amp;amp;1 &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;/dev/null | &lt;span class=&quot;nb&quot;&gt;tail&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-n2&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;statfs(&quot;/dev/nvme0&quot;, {
  f_type=TMPFS_MAGIC,
  f_bsize=4096,
  f_blocks=996251,
  f_bfree=996251,
  f_bavail=996251,
  f_files=996251,
  f_ffree=995765,
  f_fsid={val=[0,
  0]},
  f_namelen=255,
  f_frsize=4096,
  f_flags=ST_VALID|ST_NOSUID|ST_NOEXEC|ST_RELATIME
}) = 0
write(1,
  &quot;  File: \&quot;/dev/nvme0\&quot;\n&quot;
  &quot;    ID: 0        Namelen: 255     Type: tmpfs\n&quot;
  &quot;Block size: 4096       Fundamental block size: 4096\n&quot;
  &quot;Blocks: Total: 996251     Free: 996251     Available: 996251\n&quot;
  &quot;Inodes: Total: 996251     Free: 995765\n&quot;,
  219) = 219

&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This seems to match the information I obtained with &lt;code&gt;debufs&lt;/code&gt; earlier:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@laptop:/#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;debugfs &lt;span class=&quot;nt&quot;&gt;-R&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;stats&#39;&lt;/span&gt; /dev/mapper/laptop--vg-root | &lt;span class=&quot;nb&quot;&gt;grep &lt;/span&gt;size | &lt;span class=&quot;nb&quot;&gt;head&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-n9&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;debugfs 1.45.6 (20-Mar-2020)
Filesystem features:      has_journal ext_attr resize_inode dir_index filetype needs_recovery extent flex_bg sparse_super large_file huge_file uninit_bg dir_nlink extra_isize
Block size:               4096
Fragment size:            4096
Flex block group size:    16
Inode size:               256
Required extra isize:     28
Desired extra isize:      28
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Looking at the source of &lt;code&gt;tune2fs&lt;/code&gt;, which prints basically the same info as the
&lt;code&gt;debugfs stats&lt;/code&gt; command, we have:&lt;/p&gt;

&lt;div class=&quot;language-c highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;  &lt;span class=&quot;n&quot;&gt;fprintf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;   &lt;span class=&quot;s&quot;&gt;&quot;Block size:               %u&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;EXT2_BLOCK_SIZE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sb&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;  &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ext2fs_has_feature_bigalloc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sb&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;fprintf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;Cluster size:             %u&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;EXT2_CLUSTER_SIZE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sb&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;fprintf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;Fragment size:            %u&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;EXT2_CLUSTER_SIZE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sb&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And according to the ext4 kernel wiki:&lt;/p&gt;

&lt;p&gt;https://ext4.wiki.kernel.org/index.php/Ext4_Disk_Layout#Bigalloc&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;At the moment, the default size of a block is 4KiB, which is a commonly
supported page size on most MMU-capable hardware. This is fortunate, as ext4
code is not prepared to handle the case where the block size exceeds the page
size. However, for a filesystem of mostly huge files, it is desirable to be
able to allocate disk blocks in units of multiple blocks to reduce both
fragmentation and metadata overhead. The bigalloc feature provides exactly this
ability. The administrator can set a block cluster size at mkfs time (which is
stored in the s_log_cluster_size field in the superblock); from then on, the
block bitmaps track clusters, not individual blocks.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;From the Blocks section:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;You may experience mounting problems if block size is greater than page size
(i.e. 64KiB blocks on a i386 which only has 4KiB memory pages).&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;So this explains the difference between blocks and fragments. Ext4 doesn’t
support fragments, but it supports clusters, which sound like the opposite, in
a way.&lt;/p&gt;

&lt;h2 id=&quot;fdisk-attempt-number-two&quot;&gt;fdisk attempt number two&lt;/h2&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;fdisk &lt;span class=&quot;nt&quot;&gt;-l&lt;/span&gt; /dev/nvme0n1p3
&lt;span class=&quot;go&quot;&gt;Disk /dev/nvme0n1p3: 237.75 GiB, 255266390016 bytes, 498567168 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is, in retrospective, completely unrelated to whatever &lt;code&gt;du&lt;/code&gt; is doing. But
let’s investigate a bit anyway.&lt;/p&gt;

&lt;p&gt;OK, so when tools are writing files, specially if it’s a lot of data, they need
to decide how much to write in each syscall. &lt;code&gt;dd&lt;/code&gt;, for example, allows you to
specify &lt;code&gt;obs&lt;/code&gt; (&lt;code&gt;output_blocksize&lt;/code&gt;). Here’s a blog post on this:&lt;/p&gt;

&lt;p&gt;http://blog.tdg5.com/tuning-dd-block-size/&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Sidetrack: I ended up doing a pull request to fix a small markup bug, yay
static sites! https://github.com/tdg5/blog/pull/8&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;I would assume that it would default to I/O size (optimal), and apparently it
does default to 512, but I think this is hardcoded separately, not really
bothering to do the &lt;code&gt;BLKIOOPT ioctl&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Since &lt;code&gt;fdisk&lt;/code&gt; is reporting &lt;code&gt;512&lt;/code&gt; here, and I’m pretty sure doing a &lt;code&gt;dd obs=64K&lt;/code&gt;
would be faster, maybe &lt;code&gt;dd&lt;/code&gt; doesn’t bother because the right value is not being
reported anyway.&lt;/p&gt;

&lt;p&gt;I’ll check my other disks:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@desktop:~#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;disk &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt; /sys/block/&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;sd&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;,nvme&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;&amp;gt; echo &quot;$&lt;/span&gt;disk &lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$disk&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;/queue/&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;logical_block_size,physical_block_size,minimum_io_size,optimal_io_size&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; |
&lt;span class=&quot;gp&quot;&gt;&amp;gt;               tr $&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;\n&#39;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39; &#39;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;;
&lt;/span&gt;&lt;span class=&quot;go&quot;&gt;&amp;gt; done |
&amp;gt; column -te
/sys/block/sda      512  4096  4096  0
/sys/block/sdb      512  4096  4096  0
/sys/block/sdc      512  4096  4096  0
/sys/block/sdd      512  4096  4096  0
/sys/block/nvme0n1  512  512   512   512
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So maybe the SSD is indeed faster with 512 blocks? Let me just disprove that.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@desktop:~$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;512&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;dd &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/dev/zero &lt;span class=&quot;nv&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;zero.img &lt;span class=&quot;s2&quot;&gt;&quot;bs=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$X&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;$((&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1024&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1024&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1024&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$X&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;))&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;2097152+0 records in
2097152+0 records out
1073741824 bytes (1.1 GB, 1.0 GiB) copied, 3.11537 s, 345 MB/s
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@desktop:~$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;rm &lt;/span&gt;zero.img
&lt;span class=&quot;gp&quot;&gt;hugopeixoto@desktop:~$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;4096&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;dd &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/dev/zero &lt;span class=&quot;nv&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;zero.img &lt;span class=&quot;s2&quot;&gt;&quot;bs=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$X&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;$((&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1024&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1024&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1024&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$X&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;))&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;262144+0 records in
262144+0 records out
1073741824 bytes (1.1 GB, 1.0 GiB) copied, 0.658087 s, 1.6 GB/s
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@desktop:~$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;rm &lt;/span&gt;zero.img
&lt;span class=&quot;gp&quot;&gt;hugopeixoto@desktop:~$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;65536&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;dd &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/dev/zero &lt;span class=&quot;nv&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;zero.img &lt;span class=&quot;s2&quot;&gt;&quot;bs=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$X&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;$((&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1024&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1024&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1024&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$X&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;))&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;16384+0 records in
16384+0 records out
1073741824 bytes (1.1 GB, 1.0 GiB) copied, 0.497855 s, 2.2 GB/s
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I tried this a couple of times, because sometimes things get cached (and I
should use sync), and 512 was always way slower than 4096 or 65536. From 64k
up, it stays at 2.2GB/s, until it starts to go down again at &lt;code&gt;bs=8M&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;So why is the SSD reporting 512? Maybe it’s to be compatible with older
systems, who knows. The SATA ones report &lt;code&gt;0&lt;/code&gt;, and &lt;code&gt;fdisk&lt;/code&gt; defaults to &lt;code&gt;4096&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;https://superuser.com/questions/451883/can-i-change-my-ssd-sector-size&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;The 512B sector size reported by the SSD is only for compatibility purposes.
Internally data is stored on 8kiB+ NAND pages. The SSD controller keeps track
of the mapping from 512B to pages internally in the FTL (Flash Translation
Layer).&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;The “Sector Size” is a fake number reported by the SSD controller so that
legacy SATA controllers will play nicely with your SSD.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;OK, so it seems that this is it. I don’t think there’s any way to get the real
value for this.&lt;/p&gt;

&lt;p&gt;Since this is read by &lt;code&gt;fdisk&lt;/code&gt;, I assume it’s important information to create
disk partitions, to make sure they’re aligned. Sounds like an adventure for
another day.&lt;/p&gt;

&lt;h2 id=&quot;summary&quot;&gt;Summary&lt;/h2&gt;

&lt;p&gt;&lt;code&gt;du&lt;/code&gt; reports both apparent (byte) size and real (block) size. It takes the
filesystem’s reported block count and block size and normalizes it to 512 byte
blocks. Then, to decide what to output, it converts it again to a block size
specified by the user, using a command line argument, the &lt;code&gt;DU_BLOCK_SIZE&lt;/code&gt; env
variable, or even &lt;code&gt;POSIXLY_CORRECT&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;jmtpfs&lt;/code&gt; does not support reporting blocks, because &lt;code&gt;MTP&lt;/code&gt; hides fs details by
design. It always sets &lt;code&gt;st_blocks=0&lt;/code&gt;, which makes &lt;code&gt;du&lt;/code&gt; unable to report disk
usage in blocks.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;ext4&lt;/code&gt; uses block sizes of &lt;code&gt;4096&lt;/code&gt;. It can be set at &lt;code&gt;mkfs&lt;/code&gt; time, but it
shouldn’t exceed the computer’s page size. It doesn’t support fragments, but it
supports &lt;code&gt;bigalloc&lt;/code&gt; mode (Clusters), which is kind of the same thing but in the
opposite direction. Fragments allow for less block waste when you have many
small files, and clusters allow for less block waste when you have many big
files. It also supports sparse files, and has an block mapping optimization
called &lt;code&gt;extent&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;fdisk&lt;/code&gt;: SSDs report block sizes of 512, to be compatible with legacy
controllers. This information may also be used by disk partitioners, although I
didn’t explore that.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;smartphone&lt;/code&gt;: I still need to back up the contents.&lt;/p&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2020-05-03:/articles/2020-05-03.html</id>
    <title type="html">Fixing hugopeixoto.net</title>
    <published>2020-05-03T00:00:00Z</published>
    <updated>2020-05-03T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/2020-05-03.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;Today’s goal is to automate everything that’s running on the server hosting hugopeixoto.net.&lt;/p&gt;
]]>
    </summary>
    <content type="html">
      <![CDATA[
        <aside>
          This is a <code>[journal]</code> entry. It is longer than usual and
          more exploratory. It may have no proper conclusion.
        </aside>
      ]]>

      &lt;p&gt;Today’s goal is to automate everything that’s running on the server hosting
hugopeixoto.net.&lt;/p&gt;

&lt;p&gt;I forgot to update the credit card number on my digital ocean account and
almost lost the server. This is not the first time something like this happens,
so I want to work towards reducing the anxiety from not having the servers
under control.&lt;/p&gt;

&lt;h2 id=&quot;overview&quot;&gt;Overview&lt;/h2&gt;

&lt;p&gt;I know I have a few website domains pointing to it:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;hugopeixoto.net: my homepage;&lt;/li&gt;
  &lt;li&gt;git.hugopeixoto.net: self hosted git server;&lt;/li&gt;
  &lt;li&gt;invite.porto.codes: slack invite page;&lt;/li&gt;
  &lt;li&gt;invite.pokegopt.com: slack invite page;&lt;/li&gt;
  &lt;li&gt;slack.ptgamedev.hugopeixoto.net: slack invite page;&lt;/li&gt;
  &lt;li&gt;media.porto.codes: a place where I used to store &lt;a href=&quot;https://porto.codes&quot;&gt;https://porto.codes&lt;/a&gt; media
files;&lt;/li&gt;
  &lt;li&gt;traduz.debian.hugopeixoto.net: an old experiment to help translate debian
packages to portuguese;&lt;/li&gt;
  &lt;li&gt;recipes.hugopeixoto.net: a diary of recipes I cooked, in case I want to
repeat them.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I will decommission some of these.&lt;/p&gt;

&lt;p&gt;The only file in &lt;code&gt;/root/&lt;/code&gt;, apart from random dot files, is &lt;code&gt;colorcheck.sh&lt;/code&gt;.
That script is already versioned in
&lt;a href=&quot;https://github.com/hugopeixoto/dotfiles/blob/master/bin/colorcheck&quot;&gt;https://github.com/hugopeixoto/dotfiles/blob/master/bin/colorcheck&lt;/a&gt;, so this
seems clean.&lt;/p&gt;

&lt;h2 id=&quot;hugopeixotonet&quot;&gt;hugopeixoto.net&lt;/h2&gt;

&lt;p&gt;This is being served of &lt;code&gt;/srv/www/hugopeixoto.net/public&lt;/code&gt;. Most of its content
comes from compiling &lt;a href=&quot;https://github.com/hugopeixoto/hugopeixoto.net&quot;&gt;https://github.com/hugopeixoto/hugopeixoto.net&lt;/a&gt;, but I
know I also use it as a temporary sharing place for random files. Let’s see how
much do I have in unversioned content here:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@server:/srv/www/hugopeixoto.net#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;du&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-sh&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;269M    .

&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/p/hugopeixoto.net$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;du&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-sh&lt;/span&gt; build/
&lt;span class=&quot;go&quot;&gt;568K    build/
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So, ~270 megabytes of unversioned stuff. I think it’s mostly previews of the
porto codes talks I was editing.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Sidenote: I should apt upgrade while I’m here. I need to set up automatic
upgrades on this thing. I’ll need to reboot when I’m done.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;I can delete these preview files. I have the original stuff, I don’t need
these. Some of them are accidentally sped up, which is kind of funny, but I
probably won’t look at this again.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@server:/srv/www/hugopeixoto.net/public#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;du&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-sh&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;9.4M     .
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Better. Let’s look at what’s left:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@server:/srv/www/hugopeixoto.net/public#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;du&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-sh&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;sort&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-h&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;4.0K    2020-05-03.txt
4.0K    about.html
4.0K    articles.html
4.0K    contact.html
4.0K    index.html
4.0K    rouge.css
4.0K    site.css
4.0K    wat.html
8.0K    favicon.ico
136K    articles.xml
160K    articles
200K    talks
480K    images
640K    mob
7.7M    screenshots
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;code&gt;2020-05-03.txt&lt;/code&gt; is this file, which I’m hosting here temporarily. It’s already
version controlled, so no problem there. &lt;code&gt;wat.html&lt;/code&gt; was a way to get some
javascript online to test some properties on different mobile browsers.
Trashed.&lt;/p&gt;

&lt;p&gt;I’m left with &lt;code&gt;mob/&lt;/code&gt;, &lt;code&gt;talks/&lt;/code&gt;, and &lt;code&gt;screenshots/&lt;/code&gt;. The first one contains a
asciinema of something I was working on, related to makeorbreak.io. I have the
.cast file backed up on my &lt;code&gt;work/makeorbreak.io/&lt;/code&gt; directory, and whomever
needed to see this has already done so. Trashing it as well. &lt;code&gt;screenshots/&lt;/code&gt; is
a workaround while I don’t re-setup my image sharing service. These are all
trash. Removing them. &lt;code&gt;talks/&lt;/code&gt; contains the slides of a presentation I worked
on last week. I shared these with some folks, so I want to keep this for now.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Sidenote: I used to have a talks/index.html with links to the slides of my talks,
but it must have been on the previous host. I need to restore that.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@server:/srv/www/hugopeixoto.net/public#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;du&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-sh&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;4.0K    2020-05-03.txt
4.0K    about.html
160K    articles
4.0K    articles.html
136K    articles.xml
4.0K    contact.html
8.0K    favicon.ico
480K    images
4.0K    index.html
4.0K    rouge.css
4.0K    site.css
200K    talks
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;du&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-sh&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--exclude&lt;/span&gt; talks
&lt;span class=&quot;go&quot;&gt;816K    .
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Still a bit over the &lt;code&gt;568K&lt;/code&gt;. Turns out I have a &lt;code&gt;images/&lt;/code&gt; directory inside the
&lt;code&gt;images/&lt;/code&gt; directory, due to a bug in my homepage’s build system. Removing it.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@server:/srv/www/hugopeixoto.net/public#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;du&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-sh&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--exclude&lt;/span&gt; talks &lt;span class=&quot;nt&quot;&gt;--exclude&lt;/span&gt; 2020-05-03.txt
&lt;span class=&quot;go&quot;&gt;572K    .
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Close enough. The difference is probably related to block sizes. Let’s be sure:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@laptop:~/w/p/h/build$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;find &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-type&lt;/span&gt; f &lt;span class=&quot;nt&quot;&gt;-not&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-path&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;./talks/*&quot;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-not&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-path&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;./2020-05-03.txt&quot;&lt;/span&gt; | xargs &lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;wc&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-c&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;514351
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;root@server:/srv/www/hugopeixoto.net/public#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;find &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-type&lt;/span&gt; f &lt;span class=&quot;nt&quot;&gt;-not&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-path&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;./talks/*&quot;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-not&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-path&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;./2020-05-03.txt&quot;&lt;/span&gt; | xargs &lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;wc&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-c&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;517351
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Confirmed. There was no relevant content that needed to be backed up in this
directory, yay!&lt;/p&gt;

&lt;p&gt;Let’s continue exploring &lt;code&gt;/srv/www/&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@server:/srv/www#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;du&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-sh&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;16K     default
36K     git.hugopeixoto.net
788K    hugopeixoto.net
12G     media.porto.codes
256K    recipes.hugopeixoto.net
6.0M    slack.hugopeixoto.net
20M     traduz.debian.hugopeixoto.net
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I’m using &lt;code&gt;default/&lt;/code&gt; to handle let’s encrypt certificate confirmations.
&lt;code&gt;git.hugopeixoto.net&lt;/code&gt; has some &lt;code&gt;cgit&lt;/code&gt; files. I remember something about &lt;code&gt;cgit&lt;/code&gt;
having a vulnerability. Let’s look that up.&lt;/p&gt;

&lt;h2 id=&quot;githugopeixotonet&quot;&gt;git.hugopeixoto.net&lt;/h2&gt;

&lt;p&gt;OK, it seems like there was a directory traversal bug in 2018:
&lt;a href=&quot;https://www.cvedetails.com/cve/CVE-2018-14912/&quot;&gt;https://www.cvedetails.com/cve/CVE-2018-14912/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;My cgit version seems to be from 2015. Uff. There are three more
vulnerabilities in 2016. I don’t even know how I got this configured. There
seems to be no cgit source in &lt;code&gt;/srv/&lt;/code&gt;, nor in &lt;code&gt;/home/git/&lt;/code&gt;. I must have
compiled it on my desktop or laptop and rsynced the binary there. Searching.
I usually keep third party software sources in &lt;code&gt;$HOME/work/contrib/&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Confirmed. Found it on an old hard drive that held my desktop’s installation:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@desktop:/m/h/h/h/w/c/cgit$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;git log &lt;span class=&quot;nt&quot;&gt;-n&lt;/span&gt; 1
&lt;span class=&quot;go&quot;&gt;commit 2eb41c4665ad6866c8893668263c401d7b0ffc5d (HEAD -&amp;gt; master, origin/master, origin/HEAD)
Author: Christian Hesse &amp;lt;mail@eworm.de&amp;gt;
Date:   Thu May 14 13:47:28 2015 +0200

    git: update to v2.4.1

    Update to git version v2.4.1, no changes required.

    Signed-off-by: Christian Hesse &amp;lt;mail@eworm.de&amp;gt;
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Quite old. Good thing it’s not running. I have a systemd service description
for cgit in &lt;code&gt;/lib/systemd/system/cgit.service&lt;/code&gt;, but it doesn’t start
automatically. I am tempted to start it temporarily just to see if that’s
enough to bring it back up. Yep, it worked. I brought it back down again,
though.&lt;/p&gt;

&lt;p&gt;Do I want to keep this? My goal with cgit was to keep a copy of my git
repositories outside of github, and to have a place where to keep private
repositories (back when github was only for public stuff). Do I still care
about that? I had gitolite set up to allow a couple of friends to collaborate
with me, but I think that if I were to do this today, we’d all be using github.&lt;/p&gt;

&lt;p&gt;What are the downsides of maintaining this? It’s another piece of software to
update. What if I try an alternative to &lt;code&gt;cgit&lt;/code&gt;? I know that there is a tool
that generates a static website, instead of serving it live. Found it:&lt;/p&gt;

&lt;p&gt;Stagit: &lt;a href=&quot;https://git.codemadness.org/stagit/&quot;&gt;https://git.codemadness.org/stagit/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;On one hand, serving this as static files sounds tempting and easier to
maintain. On the other hand, I’ll lose a bunch of features. But I don’t really
use this at all, so does it matter?&lt;/p&gt;

&lt;p&gt;Let’s see if cgit is in the repositories.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@server:/srv/www#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;apt search cgit
&lt;span class=&quot;go&quot;&gt;Sorting... Done
Full Text Search... Done
cgit/xenial 0.11.2.git2.3.2-1.1 amd64
  hyperfast web frontend for git repositories written in C

ticgit/xenial,xenial 1.0.2.17-2build1 all
  ticketing system built on Git

ticgitweb/xenial,xenial 1.0.2.17-2build1 all
  web interface to ticgit
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Seems like it. I’ll remove my custom built version and install this one. Moving
to stagit would require some time to set it up and some decision paralysis
would surely pop up.&lt;/p&gt;

&lt;p&gt;Hm, &lt;code&gt;/home/cgit/&lt;/code&gt; has a &lt;code&gt;.well-known/&lt;/code&gt; directory. Is &lt;code&gt;/srv/www/&lt;/code&gt; a symlink to &lt;code&gt;/home/cgit/&lt;/code&gt;?&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@server:/srv/www#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;ls&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lah&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;total 36K
drwxr-xr-x 9 root       root       4.0K Apr 30 17:38 .
drwxr-xr-x 3 root       root       4.0K Feb 20  2016 ..
drwxr-xr-x 3 root       root       4.0K Dec 28  2016 default
drwxr-xr-x 3 root       root       4.0K Sep 17  2016 git.hugopeixoto.net
drwxr-xr-x 4 git        git        4.0K Nov 15 11:24 hugopeixoto.net
drwxr-xr-x 7 portocodes portocodes 4.0K Apr 19  2017 media.porto.codes
drwxr-xr-x 3 root       root       4.0K Apr 30 17:38 recipes.hugopeixoto.net
drwxr-xr-x 4 root       root       4.0K Sep 17  2016 slack.hugopeixoto.net
drwxr-xr-x 5 root       root       4.0K May 14  2016 traduz.debian.hugopeixoto.net
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Wat. Why is hugopeixoto.net owned by the git user? Anyway, git.hugopeixoto.net
does not seem to be a symlink. Let me check if the directory is referenced
somewhere in &lt;code&gt;/etc/&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@server:/srv/www#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;fgrep &lt;span class=&quot;nt&quot;&gt;-r&lt;/span&gt; /home/cgit /etc/
&lt;span class=&quot;gp&quot;&gt;root@server:/srv/www#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;fgrep &lt;span class=&quot;nt&quot;&gt;-r&lt;/span&gt; cgit /etc/
&lt;span class=&quot;go&quot;&gt;/etc/apache2/conf-available/cgit.conf:ScriptAlias /cgit/ &quot;/usr/lib/cgit/cgit.cgi/&quot;
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;/etc/apache2/conf-available/cgit.conf:RedirectMatch ^/cgit$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;/cgit/
&lt;span class=&quot;go&quot;&gt;/etc/apache2/conf-available/cgit.conf:Alias /cgit-css &quot;/usr/share/cgit/&quot;
/etc/apache2/conf-available/cgit.conf:&amp;lt;Directory &quot;/usr/lib/cgit/&quot;&amp;gt;
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;/etc/nginx/sites-available/git.hugopeixoto.net:         try_files $&lt;/span&gt;uri @cgit&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;/etc/nginx/sites-available/git.hugopeixoto.net: location @cgit {
/etc/nginx/sites-available/git.hugopeixoto.net:                 fastcgi_param SCRIPT_FILENAME /home/git/cgit/cgit;
/etc/init/cgit.conf:env CGIT_CONFIG=/home/git/cgit/cgitrc
/etc/init/cgit.conf:exec /usr/sbin/fcgiwrap -s tcp:127.0.0.1:3001 -p /home/git/cgit/cgit
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;/etc/cgitrc:#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;cgit config
&lt;span class=&quot;gp&quot;&gt;/etc/cgitrc:#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;see cgitrc&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;5&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;details
&lt;span class=&quot;go&quot;&gt;/etc/cgitrc:css=/cgit-css/cgit.css
/etc/cgitrc:logo=/cgit-css/cgit.png
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Huh, do I have both &lt;code&gt;nginx&lt;/code&gt; and &lt;code&gt;apache2&lt;/code&gt; installed?&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@server:/srv/www#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;dpkg &lt;span class=&quot;nt&quot;&gt;-l&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;grep &lt;/span&gt;apache
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;OK, it’s not installed. It was just &lt;code&gt;cgit&lt;/code&gt; that placed a config there, in case
I ever install it. Thanks, I guess. Not sure if I can remove
&lt;code&gt;/etc/init/cgit.conf&lt;/code&gt;. That’s a file I wrote, and there doesn’t seem to be
anything set up by default by the &lt;code&gt;cgit&lt;/code&gt; package. I’m guessing they’re
expecting me to use it with apache and let it manage the process instead of
having a standalone fcgi service. That’s fine. Let me update the config to point to the newly installed files:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;diff /etc/init/cgit.conf.old /etc/init/cgit.conf
&lt;span class=&quot;go&quot;&gt;10c10
&amp;lt; env CGIT_CONFIG=/home/git/cgit/cgitrc
---
&amp;gt; env CGIT_CONFIG=/etc/cgitrc
12c12
&amp;lt; exec /usr/sbin/fcgiwrap -s tcp:127.0.0.1:3001 -p /home/git/cgit/cgit
---
&amp;gt; exec /usr/sbin/fcgiwrap -s tcp:127.0.0.1:3001 -p /usr/lib/cgit/cgit.cgi
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I should also check the &lt;code&gt;cgitrc&lt;/code&gt; file.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;diff /home/git/cgit/cgitrc /etc/cgitrc
&lt;span class=&quot;go&quot;&gt;1,2c1,3
&amp;lt; css=/cgit.css
&amp;lt; logo=/cgit.png
---
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;&amp;gt; #&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;&amp;gt; #&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;cgit config
&lt;span class=&quot;gp&quot;&gt;&amp;gt; #&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;see cgitrc&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;5&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;details
&lt;span class=&quot;go&quot;&gt;4c5,6
&amp;lt; robots=noindex, nofollow
---
&amp;gt; css=/cgit-css/cgit.css
&amp;gt; logo=/cgit-css/cgit.png
6,20d7
&amp;lt; virtual-root=/
&amp;lt;
&amp;lt; root-title=git repositories
&amp;lt; root-desc=
&amp;lt;
&amp;lt; remove-suffix=1
&amp;lt; enable-index-owner=0
&amp;lt; enable-git-config=1
&amp;lt; readme=:README
&amp;lt; about-filter=/home/git/cgit/txt2html.sh
&amp;lt;
&amp;lt; project-list=/home/git/projects.list
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;&amp;lt; clone-url=git://git.hugopeixoto.net/$&lt;/span&gt;CGIT_REPO_URL https://git.hugopeixoto.net/&lt;span class=&quot;nv&quot;&gt;$CGIT_REPO_URL&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;&amp;lt;
&amp;lt; scan-path=/home/git/repositories/
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So I had a bunch of configs. I need to tweak this, then.&lt;/p&gt;

&lt;p&gt;OK, that didn’t work. I copied most of the old config onto the new path,
reloaded the systemd configuration with &lt;code&gt;systemd daemon-reload&lt;/code&gt;, and started
it, but the logs tell me that it “failed to bind: address already in use”.&lt;/p&gt;

&lt;p&gt;Running &lt;code&gt;lsof -i&lt;/code&gt; and &lt;code&gt;netstat -ln&lt;/code&gt; doesn’t seemto show aything bound to 3001. There is this, though:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;go&quot;&gt;unix  2      [ ACC ]     STREAM     LISTENING     10571    /run/fcgiwrap.socket
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Could it be related?&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@server:/srv/www#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;lsof | &lt;span class=&quot;nb&quot;&gt;grep &lt;/span&gt;fcgiwrap
&lt;span class=&quot;go&quot;&gt;systemd       1                   root   29u     unix 0xffff88001b815880      0t0      10571 /run/fcgiwrap.socket type=STREAM
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;No clue what’s going on. Why is this bound to PID 1? OK, I’m rebooting this.&lt;/p&gt;

&lt;p&gt;Rebooted, I can still get in. The lsof thing is still there. Maybe it’s
unrelated. Running &lt;code&gt;service cgit start&lt;/code&gt; starts cgit from the old &lt;code&gt;/home/&lt;/code&gt; path.
Am I editing the wrong service definition?&lt;/p&gt;

&lt;p&gt;There’s still a reference to the old filename in
&lt;code&gt;/etc/nginx/sites-available/git.hugopeixoto.net&lt;/code&gt;. Is this related somehow? I
don’t think it is, because of this:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@server:~#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;ps aux | &lt;span class=&quot;nb&quot;&gt;grep &lt;/span&gt;cgit
&lt;span class=&quot;go&quot;&gt;root      1130  0.0  1.2  54164  6304 pts/0    T    12:38   0:00 vim /etc/init/cgit.conf
root      1323  0.0  0.1  14216   976 pts/0    S+   12:42   0:00 grep --color=auto cgit
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;root@server:~#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;service cgit start
&lt;span class=&quot;gp&quot;&gt;root@server:~#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;ps aux | &lt;span class=&quot;nb&quot;&gt;grep &lt;/span&gt;cgit
&lt;span class=&quot;go&quot;&gt;root      1130  0.0  1.2  54164  6304 pts/0    T    12:38   0:00 vim /etc/init/cgit.conf
git       1354  0.0  0.1  25248   948 ?        Ss   12:42   0:00 /usr/sbin/fcgiwrap -s tcp:127.0.0.1:3001 -p /home/git/cgit/cgit
root      1356  0.0  0.1  14216   976 pts/0    S+   12:42   0:00 grep --color=auto cgit
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The line looks like what was stored in &lt;code&gt;/etc/init/cgit.conf&lt;/code&gt;. Is it storing a cached version somewhere? Am I misremembering how to reload systemd definitions?&lt;/p&gt;

&lt;p&gt;From &lt;a href=&quot;https://serverfault.com/questions/700862/do-systemd-unit-files-have-to-be-reloaded-when-modified&quot;&gt;https://serverfault.com/questions/700862/do-systemd-unit-files-have-to-be-reloaded-when-modified&lt;/a&gt;:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;After you make changes to your unit file, you should run systemctl daemon-reload […].&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;This is what I remembered, but it doesn’t seem to work. I replaced the exec
line with &lt;code&gt;exec yes&lt;/code&gt; and it still shows up the fcgiwrap thing. Let’s try to see
what systemd thinks it knows (&lt;a href=&quot;https://linuxhint.com/list_service_systemd/&quot;&gt;https://linuxhint.com/list_service_systemd/&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;OK, got it. &lt;code&gt;/lib/systemd/system/cgit.service&lt;/code&gt;. This contains outdated
information. Am I supposed to edit this file directly? I don’t think so. Should
this be a symlink to &lt;code&gt;/etc/init/cgit.conf&lt;/code&gt;? Nginx does not seem to be a
symlink, for example. Checking my history:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@server:~#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;history&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;grep &lt;/span&gt;lib/systemd
&lt;span class=&quot;go&quot;&gt; 927  vim /etc/init/slackin.conf /lib/systemd/system/slackin.service
 928  vim /etc/init/slackin.conf /lib/systemd/system/slackin.service -p
1065  vim  -p /lib/systemd/system/slackin.service traduz.conf /lib/systemd/system/traduz.service
1067  vim  -p /lib/systemd/system/slackin.service cgit.conf /lib/systemd/system/cgit.service
1084  cat /lib/systemd/system/cgit.service
1085  cat /lib/systemd/system/slackin.service
1779  vim /lib/systemd/system/cgit.service
1898  ls /lib/systemd/
1899  ls /lib/systemd/system
1901  ls /lib/systemd/system/cgit
1902  ls /lib/systemd/system/cgit.service
1903  ls -lah /lib/systemd/system/cgit.service
1904  vim /lib/systemd/system/cgit.service
1905  history | grep lib/systemd
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Well this is suspicious. I created those files manually, for some reason. Why
did I have /etc/init/cgit.conf? Was this from when I used upstart? Googling
again.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://unix.stackexchange.com/questions/206315/whats-the-difference-between-usr-lib-systemd-system-and-etc-systemd-system&quot;&gt;https://unix.stackexchange.com/questions/206315/whats-the-difference-between-usr-lib-systemd-system-and-etc-systemd-system&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;go&quot;&gt;│/etc/systemd/system │ Local configuration         │
├────────────────────┼─────────────────────────────┤
│/run/systemd/system │ Runtime units               │
├────────────────────┼─────────────────────────────┤
│/lib/systemd/system │ Units of installed packages │
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So, to start with, I should have probably have added this to
/etc/systemd/system/, not /lib/systemd/system/&lt;code&gt;. But what&#39;s up with
&lt;/code&gt;/etc/init/`?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://wiki.ubuntu.com/SystemdForUpstartUsers&quot;&gt;https://wiki.ubuntu.com/SystemdForUpstartUsers&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Example Upstart Service
/etc/init/foo.conf:
[..]&lt;/p&gt;

  &lt;p&gt;Example Systemd service
/lib/systemd/system/foo.service:
[…]&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;This confirms it. Moving slackin and cgit to &lt;code&gt;/etc/systemd/system/&lt;/code&gt; and
removing those copies in /etc/init/.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@server:~#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;ps aux | &lt;span class=&quot;nb&quot;&gt;grep &lt;/span&gt;cgit
&lt;span class=&quot;go&quot;&gt;git       2395  0.0  0.1  25248   948 ?        Ss   13:02   0:00 /usr/sbin/fcgiwrap -s tcp:127.0.0.1:3001 -p /usr/lib/cgit/cgit.cgi
root      2426  0.0  0.1  14216   980 pts/0    S+   13:03   0:00 grep --color=auto cgit
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now that the right service is running, checking git.hugopeixoto.net and…&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;go&quot;&gt;403 forbidden
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;Sidenote: I noticed that this file, served on hugopeixoto.net, is not
rendering utf-8 properly. Let me configure nginx to set the default encoding
to utf-8. Sprinkled &lt;code&gt;charset UTF-8;&lt;/code&gt; in every server block under
/etc/nginx/sites-enabled and we’re good to go.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;18:14. Taking a longer break.
19:37. Back for a short period of time.&lt;/p&gt;

&lt;p&gt;Oh, I had something referencing &lt;code&gt;/home/git/cgit&lt;/code&gt; in nginx. Let me quickly fix
that. It worked.&lt;/p&gt;

&lt;p&gt;Now I’m missing CSS and the logo. This will be tweaking /etc/cgitrc and
potentially change nginx to serve some files from cgit’s installation.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@server:~#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;find /usr/ &lt;span class=&quot;nt&quot;&gt;-name&lt;/span&gt; cgit.css
&lt;span class=&quot;go&quot;&gt;/usr/share/cgit/cgit.css
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;root@server:~#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;ls&lt;/span&gt; /usr/share/cgit/
&lt;span class=&quot;go&quot;&gt;cgit.css  cgit.png  favicon.ico  robots.txt
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I can point nginx directly to &lt;code&gt;/usr/share/cgit/&lt;/code&gt; and add my logo there. I don’t
like overriding something in &lt;code&gt;/usr/&lt;/code&gt;, though. Does nginx support multiple
roots? I can always use &lt;code&gt;try_files&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;So, the &lt;code&gt;&amp;lt;img&amp;gt;&lt;/code&gt; tag currently points to &lt;code&gt;https://git.hugopeixoto.net/cgit-css/cgit.png&lt;/code&gt;.
This matches the &lt;code&gt;/etc/gitrc&lt;/code&gt; &lt;code&gt;css=css/cgit.css&lt;/code&gt; config. I’m just copying over
the files I need into my &lt;code&gt;/srv/www/git.hugopeixoto.net/public/&lt;/code&gt; directory and be
done with it.&lt;/p&gt;

&lt;p&gt;I’m definitely creating either a docker image or a git repository to store
these configs, logos and css. The font seems a bit small by default, so I will
probably have to tweak that as well.&lt;/p&gt;

&lt;p&gt;Making a git repo now. I had a repo for the gitolite stuff, should I use the
same? Maybe I’ll unify these in the future, but I’m starting with separate ones
for now.&lt;/p&gt;

&lt;p&gt;How do I add a new repo to this, again? Checking a clone of a repo I know it’s
there, on an old drive.&lt;/p&gt;

&lt;p&gt;Cool, it tries to connect with an old SSH key, and I don’t remember the
passphrase. Trying a few. No luck so far. I could replace it with a fresh key,
but I’m going to obsess over not knowing this passphrase. It’s not on my
password manager.&lt;/p&gt;

&lt;p&gt;22:20 I’ll continue tomorrow.
00:05 Back, still trying to remember it.&lt;/p&gt;

&lt;p&gt;Trying to see if I accidentally typed it in bash, where I can find it in
bash_history.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;ssh git.hugopeixoto.net -lroot
ssh-add ~/.ssh/ndrive_rsa&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Right, thanks :x I’m just looking at my keyboard trying to conjure the
passphrase out of thin air. Attempting to brute force a couple of attempts, and
logging every attempt so that I don’t try them all again tomorrow.&lt;/p&gt;

&lt;p&gt;I got nothing. Moving on, let’s try again tomorrow.&lt;/p&gt;

&lt;p&gt;Going back to git.hugopeixoto.net, it’s now up again. It seems that
repositories are in /home/git/repositories. What else lives in this home
directory that can be deleted?&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@server:/home/git#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;ls&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;bin  cgit  gitolite  hpeixoto.pub  projects.list  repositories
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There’s the &lt;code&gt;hpeixoto.pub&lt;/code&gt; again. This is yet another copy of the pubkey whose
private key I can’t unlock. Teasing me. It seems that I used this to initialize gitolite:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;go&quot;&gt;.bash_history:cat authorized_keys &amp;gt; hpeixoto.pub
.bash_history:gitolite setup hpeixoto.pub
.bash_history:gitolite setup -pk hpeixoto.pub
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I can probably remove this. I have tons of copies of this pubkey, and I
shouldn’t be using it anyway.&lt;/p&gt;

&lt;p&gt;Removing cgit, since it’s the previous instalation location.&lt;/p&gt;

&lt;p&gt;I can probablyremove projects.list. It’s a file that lists a couple of
repositories. Oops, I renamed it. It’s used by cgit to know which projects are
public, apparently. Confirmed,it’s on cgitrc:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;go&quot;&gt;project-list=/home/git/projects.list
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Do I have to add an entry here every time? This sounds boring. This file is
probably handled by gitolite. Let me check the gitolite-admin repo. Ah, from
the gitolite documentation, this file is automatically written with a list of
repositories that have a gitweb configuration set.&lt;/p&gt;

&lt;p&gt;Sounds dangerous. Nevertheless, this file doesn’t need to be backed up or removed.
That leaves &lt;code&gt;bin/&lt;/code&gt; and &lt;code&gt;gitolite/&lt;/code&gt;, both related to gitolite’s installation.&lt;/p&gt;

&lt;p&gt;I feel like I’m done with the git part. The only thing left is to unlock that
cursed key.&lt;/p&gt;

&lt;p&gt;What else is on &lt;code&gt;/srv/www/&lt;/code&gt;?&lt;/p&gt;

&lt;h2 id=&quot;mediaportocodes&quot;&gt;media.porto.codes&lt;/h2&gt;

&lt;p&gt;This is and old staging area for both porto codes and conversas em código
recordings. I probably backed them all up to S3. I have a copy on my desktop.
Let’s see if I can match every file.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@server:/srv/www/media.porto.codes#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;du&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-sh&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;12G     .
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;root@server:/srv/www/media.porto.codes#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;ls&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;backups  incoming  podcast  poop  talks
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;Sidenote: &lt;code&gt;backups&lt;/code&gt;, my favourite directory name. i must have hundreds of
directories with this name, all nested inside each other.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@desktop:/m/d/porto.codes$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;du&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-sh&lt;/span&gt; podcast/media.porto.codes&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;9.2G    podcast/media.porto.codes
6.4G    podcast/media.porto.codes.2
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Well, this is a start. I know that I already messed with the meetup recordings
structure, so that part won’t be as easy to match. Let’s start with the podcast
material, then.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@desktop:/m/d/p/podcast$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;ls &lt;/span&gt;media.porto.codes&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;media.porto.codes:
podcast

media.porto.codes.2:
backups  incoming  podcast  poop
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is looking good. 4 out of 5.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@server:/srv/www/media.porto.codes#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;du&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-s&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;711936  backups
2910212 incoming
2634880 podcast
387312  poop
5578096 talks
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@desktop:/m/d/p/p/media.porto.codes.2$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;du&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-s&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;711900  backups
2910160 incoming
2634460 podcast
387272  poop
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Directory sizes are practically the same.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;go&quot;&gt;irb(main):001:0&amp;gt; server = [711936, 2910212, 2634880, 387312]
irb(main):002:0&amp;gt; desktop = [711900, 2910160, 2634460, 387272]
irb(main):004:0&amp;gt; server.zip(desktop).map{|a,b|a-b}
=&amp;gt; [36, 52, 420, 40]
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Last time I had to mess with sort using the system’s locale to determine order, so here I’m setting &lt;code&gt;LC_ALL=C&lt;/code&gt; to use byte order in both computers.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@desktop:/m/d/p/p/media.porto.codes.2$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;find &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-type&lt;/span&gt; f | &lt;span class=&quot;nv&quot;&gt;LC_ALL&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;C &lt;span class=&quot;nb&quot;&gt;sort&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;sha256sum&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;6f7739ceae6bc2825ea8ae99867749d85f7b35a9fce8f04e43fbb92df146be88  -
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;root@server:/srv/www/media.porto.codes#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;find &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-type&lt;/span&gt; f &lt;span class=&quot;nt&quot;&gt;-not&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-path&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;./talks/*&quot;&lt;/span&gt; | &lt;span class=&quot;nv&quot;&gt;LC_ALL&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;C &lt;span class=&quot;nb&quot;&gt;sort&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;sha256sum&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;6f7739ceae6bc2825ea8ae99867749d85f7b35a9fce8f04e43fbb92df146be88  -
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Same thing. So I can delete everything from the server, except &lt;code&gt;talks/&lt;/code&gt;, as
it’s already backed up. I hate this part, where I delete important things from
places.&lt;/p&gt;

&lt;p&gt;Done. Now what’s up with &lt;code&gt;talks/&lt;/code&gt;? &lt;code&gt;ls&lt;/code&gt; shows me a dozen or so files. This
should be quick. They look like old files, 2016 and older. Let’s &lt;code&gt;sha256sum&lt;/code&gt;
and search for their counterparts in my desktop.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@server:/srv/www/media.porto.codes/talks#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;sha256sum&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;6222a940edcdd62f690749fe4c6e123d73a62246ace4f04a5979ef91a74e021a  2016-02-17 20-21-04.flv
2c6c1a17fd5fbc31340b7a996efba1f2e944f52d2a3c27b07254b59331c0de56  2016-02-17 21-00-54.flv
f9f76c500dcc45ef9c325894019211ca69d599e0ec7a5a863d8c75dc89c6d947  2016-03-cascalheira-phoenix.flv
aeb2c842e0ae320ae289af82255a35b9c25279e79532b75787541bac4378da26  2016-04-20 20-28-12.flv
9504c6d990b8fd8052b3dc5f74fdc3b1e9559a779703d330ea56ed498d0824c9  a11y-zamith.mov
6d86f51186825bbb500046a7f35173370bf4348406a5f779d17074d53d578677  ApeyEye.flv
62b343ab4d89ee11b469a16f5a27101fd05f86420711e2469fe32f7c5be08b4a  camel-presentation.mov
e233065903a1b171d5bc9234d06a8799eab1960b39944f4187110f08765b60d7  ismael_elixir.mov
14796679bba88b405e7283f8823d98e78d5656c469d55456dec02925fda0de7e  MeetupPolymerSW.mov
e8b95230b7edb9cde8a4d2c9caa7616b5e6a07f73523db1f2bab18e6cc4bf339  portorb.mov
2ae553a0590a852613b1f16b114012dd0be87dbc24311a6e85f9f5f59b8367f8  React in Rails.pdf
40fe5cac24d4e3763aedaa2daded9c305cc3a8a0294e28a7a56a551d5eb19498  react_on_rails_17_02_2016.mov
5dc86e87eb8fa844f94fda4bd09efd364cde499d02efa5a8ab99209701bc8486  ruby-meetup_presentation-recording_maria-monteiro.mov
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I recognize most of these. Running something similar on the desktop:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@desktop:/m/d/p/meetup$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;find 201&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;5,6&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-type&lt;/span&gt; f &lt;span class=&quot;nt&quot;&gt;-print0&lt;/span&gt; | xargs &lt;span class=&quot;nt&quot;&gt;-0&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-n1&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sha256sum&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;6d86f51186825bbb500046a7f35173370bf4348406a5f779d17074d53d578677  2015/2015-06-18/ApeyEye.flv
14796679bba88b405e7283f8823d98e78d5656c469d55456dec02925fda0de7e  2015/2015-06-18/MeetupPolymerSW.mov
9504c6d990b8fd8052b3dc5f74fdc3b1e9559a779703d330ea56ed498d0824c9  2015/2015-06-18/a11y-zamith.mov
e233065903a1b171d5bc9234d06a8799eab1960b39944f4187110f08765b60d7  2015/2015-05-28/ismael_elixir.mov
&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;...
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I already see some matches. I’ll store the desktop hashes in a file and search
for the server’s hashes in there, one by one, manually. If everything has a
match, I’ll delete the whole server directory.&lt;/p&gt;

&lt;p&gt;Got a match for every file. That was quick. Deleting
&lt;code&gt;/srv/www/media.porto.codes/&lt;/code&gt;. Checking for hidden files before pressing the
trigger. I’ll also remove any nginx entries for this domain. I’ll need to
remove it from the DNS as well, but that can wait.&lt;/p&gt;

&lt;p&gt;What’s left?&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;root@server:/srv/www#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;du&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-sh&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;16K     default
36K     git.hugopeixoto.net
800K    hugopeixoto.net
256K    recipes.hugopeixoto.net
6.0M    slack.hugopeixoto.net
20M     traduz.debian.hugopeixoto.net
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I set up &lt;code&gt;recipes&lt;/code&gt; yesterday, so that’s pretty clean. Slackin seems to be
working OK, so I’ll just remove pokegopt’s entry, since that doesn’t exist
anymore. I should keep a copy of the settings file somewhere. Done.&lt;/p&gt;

&lt;p&gt;Does &lt;code&gt;traduz&lt;/code&gt; even work?&lt;/p&gt;

&lt;h2 id=&quot;traduzdebianhugopeixotonet&quot;&gt;traduz.debian.hugopeixoto.net&lt;/h2&gt;

&lt;p&gt;This seems to be a single binary server, so it’s probably a go rewrite of my
original rails implementation.&lt;/p&gt;

&lt;p&gt;When I access &lt;a href=&quot;https://traduz.debian.hugopeixoto.net/&quot;&gt;https://traduz.debian.hugopeixoto.net/&lt;/a&gt;, I can see the search
bar, but searching does nothing. The endpoint is returning 502. I also see some
react warnings. Cool.&lt;/p&gt;

&lt;p&gt;Is there a systemd or upstart unit for this? Let’s find out, now that I know
where to look.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /lib/systemd/system/traduz.service
&lt;span class=&quot;go&quot;&gt;[Unit]
Description=Debian Traduz server

[Service]
Type=simple
User=root
Group=root
WorkingDirectory=/srv/www/traduz.debian.hugopeixoto.net
ExecStart=/srv/www/traduz.debian.hugopeixoto.net/server
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /etc/init/traduz.conf
&lt;span class=&quot;go&quot;&gt;description &quot;debian-traduz webservice&quot;

start on (local-filesystems and runlevel [2345])
stop on runlevel [06]

setuid root
setgid root

chdir /srv/www/traduz.debian.hugopeixoto.net

exec ./server
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here we go again. I’ll move the system one to the proper directory on &lt;code&gt;/etc/&lt;/code&gt;.
A &lt;code&gt;daemon-reload&lt;/code&gt; and &lt;code&gt;traduz start&lt;/code&gt; after, it seems to work!&lt;/p&gt;

&lt;p&gt;This is similar to what linguee does, but specific to debian package
translations. Also, older than linguee. :P&lt;/p&gt;

&lt;p&gt;There’s a &lt;code&gt;config/settings.json&lt;/code&gt; file, which was a very common pattern in my
webservers ~5 years ago. The &lt;code&gt;public/&lt;/code&gt; directory contains html and js, and the
&lt;code&gt;files/&lt;/code&gt; directory contains the translation files.&lt;/p&gt;

&lt;p&gt;I have no idea how the &lt;code&gt;files/&lt;/code&gt; directory got here. Let’s see if I have any
records of it in the desktop.&lt;/p&gt;

&lt;p&gt;Found this in a random bash_history file:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;go&quot;&gt;rsync -r files root@git.hugopeixoto.net:/srv/www/traduz.debian.hugopeixoto.net/
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So this means I have a script to fetch these and I just sync them manually to
the server. There’s a &lt;code&gt;fetcher/&lt;/code&gt; directory here:
&lt;a href=&quot;https://github.com/hugopeixoto/debian-traduz&quot;&gt;https://github.com/hugopeixoto/debian-traduz&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I consider this backed up. So this means I’m done with /srv/www/.&lt;/p&gt;

&lt;h2 id=&quot;what-else-is-missing&quot;&gt;what else is missing?&lt;/h2&gt;

&lt;p&gt;No postgresql installed, no random files in user homes. I think the only thing
left is to decide what to do with the git server. I could also make sure that I
have copies of every repository that’s hosted here.&lt;/p&gt;

&lt;p&gt;This last part bothers me a lot. I always feel like I don’t have a complete
mind map of all the stuff I created, and it never feels organized. Part of this
is what led me to create the &lt;code&gt;untracked&lt;/code&gt; tool:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/hugopeixoto/untracked&quot;&gt;https://github.com/hugopeixoto/untracked&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Sidenote: Maybe this is a good project to rewrite in rust. And I should
really add some tests. I remember breaking this with every change. Part of
the problem is that I have some idea of what it should do, but I never
formalized it.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Do I want to move every service to a docker container? It kind of makes me sad,
but dealing with this /lib/ /etc/init/ systemd shenanigans kind of make me want
to do it.&lt;/p&gt;

&lt;p&gt;I should have a private repository, or something, that allows me to easily
upload something to hugopeixoto.net for sharing. I do that a lot, just by
&lt;code&gt;rsync&lt;/code&gt;ing random stuff, and I lose track of what’s there fast.&lt;/p&gt;

&lt;p&gt;There’s also dl.hugopeixoto.net, my self-hosted version of cloudapp, which I’d
like to revive. But then I’d need to rebuild the android app, and having to
touch the android tooling makes me anxious. Last time I touched android stuff,
I tried to build an app inside a docker image, using only free software, but I
hit some issues with openjdk.&lt;/p&gt;

&lt;p&gt;So, this is what’s currently running on this server:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;go&quot;&gt;hugopeixoto.net                  https://github.com/hugopeixoto/hugopeixoto.net
hugopeixoto.net/talks            ~/work/personal/talks
hugopeixoto.net/2020-04-03.txt   ~/notes/journal/2020-05-03.txt
git.hugopeixoto.net              ~/work/personal/gitolite-admin + ~/work/personal/cgit
invite.porto.codes               https://github.com/hugopeixoto/slackin
slack.ptgamedev.hugopeixoto.net  https://github.com/hugopeixoto/slackin
traduz.debian.hugopeixoto.net    https://github.com/hugopeixoto/traduz-debian
recipes.hugopeixoto.net          ~/work/personal/recipes
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;What tasks are left?&lt;/p&gt;

&lt;h2 id=&quot;endless-todo-material&quot;&gt;endless todo material&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;hugopeixoto.net/talks: automate the deployment and merge it with previous
content&lt;/li&gt;
  &lt;li&gt;figure out what to do with this (and future) journal entries, are they blog
post entries?&lt;/li&gt;
  &lt;li&gt;recipes.hugopeixoto.net: automate the deployment&lt;/li&gt;
  &lt;li&gt;replace invite.porto.codes with a slack invite link (they support those now)&lt;/li&gt;
  &lt;li&gt;check if the ptgamedev slack is dead and remove
slack.ptgamedev.hugopeixoto.net&lt;/li&gt;
  &lt;li&gt;check if debian translations are still fetchable by the current script or if
there’s an easier way&lt;/li&gt;
  &lt;li&gt;get a cron job going that updates debian translations&lt;/li&gt;
  &lt;li&gt;reconfigure dl.hugopeixoto.net, even if just to have a separate directory
where to upload random files&lt;/li&gt;
  &lt;li&gt;figure out what to do with git.hugopeixoto.net&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Looking at this list, it looks like I didn’t do much today. Weird.&lt;/p&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2020-04-28:/articles/bash-presentation.html</id>
    <title type="html">Bash presentation</title>
    <published>2020-04-28T00:00:00Z</published>
    <updated>2020-04-28T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/bash-presentation.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;I did a presentation on Bash and Linux process related topics for an company internal thing. Here are the slides.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;p&gt;I did a presentation on Bash and Linux process related topics for an company
internal thing.&lt;/p&gt;

&lt;p&gt;There’s no A/V recording, but I went a bit text heavy on the slides, so I’m
making them available here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://hugopeixoto.net/talks/bash/presentation.html&quot;&gt;https://hugopeixoto.net/talks/bash/presentation.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Use tab to navigate (I’m using &lt;code&gt;tabindex&lt;/code&gt; shenanigans to make that work), or
just scroll down.&lt;/p&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2020-01-04:/articles/advent-of-code-2019.html</id>
    <title type="html">Advent of code 2019</title>
    <published>2020-01-04T00:00:00Z</published>
    <updated>2020-01-04T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/advent-of-code-2019.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;&lt;a href=&quot;https://adventofcode.com&quot;&gt;Advent of Code&lt;/a&gt; is an anual programming contest made of 25 programming puzzles, unlocked from the 1st to the 25th of December. It started in 2015, and I try to participate each year.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;p&gt;&lt;a href=&quot;https://adventofcode.com&quot;&gt;Advent of Code&lt;/a&gt; is an anual programming contest made
of 25 programming puzzles, unlocked from the 1st to the 25th of December. It
started in 2015, and I try to participate each year.&lt;/p&gt;

&lt;h2 id=&quot;my-history-with-this-contest&quot;&gt;My history with this contest&lt;/h2&gt;

&lt;p&gt;When it first came out, &lt;a href=&quot;/articles/first-impressions-of-haskell.html&quot;&gt;I was still into programming
contests&lt;/a&gt;, and I managed to finish
22 puzzles. I used C++, because that’s my default language for these type of
challenges.&lt;/p&gt;

&lt;p&gt;2017 and 2016 were not so great. I managed to solve roughly 10 problems each
year before getting distracted with something else. Mid 2016 I switched jobs
and started working mainly in ruby, so this was the language I used in these
two editions.&lt;/p&gt;

&lt;p&gt;I didn’t even participate in 2018.&lt;/p&gt;

&lt;p&gt;This year, although I still mostly work with ruby (and that’s definitely one of
my favorite languages), I decided to try something different. I started solving
these in &lt;a href=&quot;https://www.rust-lang.org/&quot;&gt;Rust&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I managed to do the first two days on the day they were released, but then
didn’t manage to have the time to pick it up again until the 8th. By the 21st,
I had finished day 13. This is where I would probably quit, based on the
previous year’s pattern. Instead, I decided to push through, and by the 30th, I
had finished day 21. I managed to find some headspace to work on the following
problems, and by January 3rd I submitted the 25th problem. Success!&lt;/p&gt;

&lt;p&gt;During the first years, I had other folks that would participate, so there was
an extra bit of motivation to get them done on the day, and we could celebrate
advancing together. I lost touch with some of them, and they probably stopped
participating as well.&lt;/p&gt;

&lt;p&gt;Now that I managed to finish one edition, I’m kind of feeling the urge to go
and work on the previous editions. Or to participate in
&lt;a href=&quot;https://onlinejudge.org/&quot;&gt;UVA&lt;/a&gt;. Or &lt;a href=&quot;https://projecteuler.net/&quot;&gt;Project Euler&lt;/a&gt;.
My original goal in Project Euler was to raise my &lt;a href=&quot;https://projecteuler.net/location=Portugal&quot;&gt;ranking among Portugal
users&lt;/a&gt;. Most top accounts haven’t
submitted anything in a while, so maybe it’s easy to get a top20 position.&lt;/p&gt;

&lt;h2 id=&quot;takeaways-from-using-rust-in-aoc-2019&quot;&gt;Takeaways from using rust in AoC 2019&lt;/h2&gt;

&lt;p&gt;The first problem was easy. Take in a bunch of numbers, multiply them by a
constant, and sum the results. Lucky me, because I had to get used to Rust.
Parsing the input files was the hardest part. I had to read a set of numbers,
one per line, from a file. In ruby, I would do something like:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;no&quot;&gt;ARGF&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;readlines&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:to_i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In rust, I had to deal with some extra stuff:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;io&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::{&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BufRead&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;modules&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;io&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;BufReader&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;io&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;stdin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
        &lt;span class=&quot;nf&quot;&gt;.lines&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
        &lt;span class=&quot;nf&quot;&gt;.filter_map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;Result&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;nf&quot;&gt;.map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;line&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;line&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;.parse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;i32&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
        &lt;span class=&quot;nf&quot;&gt;.filter_map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;Result&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;py&quot;&gt;.collect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

    &lt;span class=&quot;c&quot;&gt;// ..&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As soon as I got the input in a vector, solving the actual problem was easy.
One cool thing is that unit tests go directly inside the file, and &lt;code&gt;cargo&lt;/code&gt; has
the runner built in, so there was no extra setup:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;fuel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mass&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;i32&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;i32&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mass&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.max&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;nd&quot;&gt;#[cfg(test)]&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mod&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tests&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;super&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;nd&quot;&gt;#[test]&lt;/span&gt;
     &lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;test_fuel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Result&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
         &lt;span class=&quot;nd&quot;&gt;assert_eq!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;fuel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
         &lt;span class=&quot;nd&quot;&gt;assert_eq!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;fuel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
         &lt;span class=&quot;nd&quot;&gt;assert_eq!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;fuel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;14&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
         &lt;span class=&quot;nd&quot;&gt;assert_eq!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;654&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;fuel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1969&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
         &lt;span class=&quot;nd&quot;&gt;assert_eq!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;33583&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;fuel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;100756&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;

         &lt;span class=&quot;nf&quot;&gt;Ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(())&lt;/span&gt;
     &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;c&quot;&gt;// ...&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Running &lt;code&gt;cargo test&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;gp&quot;&gt;hugopeixoto@zephos$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;cargo &lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;   Compiling adventofcode2019 v1.0.0 (challenges/adventofcode/2019)
    Finished test [unoptimized + debuginfo] target(s) in 0.39s
     Running target/debug/deps/day1-b04522aba678e51a

running 1 test
test tests::test_fuel ... ok

test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;One thing I noted was that I ended up having a single test per function, with
multiple test cases in it. I guess this is a consequence of the type of
problems I was solving and the fact that each puzzle was single file.&lt;/p&gt;

&lt;p&gt;On the first few days I was actively avoiding calls to &lt;code&gt;unwrap()&lt;/code&gt;, considering
them bad practice. After a while, I stopped pretending this was a critical
project and embraced the unwraps, effectively using them as asserts.&lt;/p&gt;

&lt;p&gt;One of the puzzles was a maze, where the starting point was marked by a
character &lt;code&gt;A&lt;/code&gt;. &lt;code&gt;fn starting_point(&amp;amp;self) -&amp;gt; (i32, i32)&lt;/code&gt; function would call
&lt;code&gt;find(|p, c| c == &#39;A&#39;).unwrap()&lt;/code&gt;. I could have made it return an &lt;code&gt;Option&amp;lt;(i32,
i32)&amp;gt;&lt;/code&gt;, but in this context, that would just be noisy. Having it explode and
looking at the stacktrace was more helpful than writing code to propagate and
handle Nones.&lt;/p&gt;

&lt;p&gt;Another issue I had was with passing strings around, specially during parsing.
This was a common pattern in my implementations:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;parse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;usize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;usize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;source&lt;/span&gt;
        &lt;span class=&quot;nf&quot;&gt;.lines&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
        &lt;span class=&quot;nf&quot;&gt;.enumerate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
        &lt;span class=&quot;nf&quot;&gt;.flat_map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(|(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.chars&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.enumerate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;move&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;|(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)|&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)))&lt;/span&gt;
        &lt;span class=&quot;nf&quot;&gt;.filter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(|&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;&#39;#&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;nf&quot;&gt;.map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(|(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)|&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
        &lt;span class=&quot;py&quot;&gt;.collect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;nd&quot;&gt;#[cfg(test)]&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;mod&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tests&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;super&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;nd&quot;&gt;#[test]&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;test_parse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Result&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nd&quot;&gt;assert_eq!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
            &lt;span class=&quot;nf&quot;&gt;parse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;.#..#&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;.....&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;#####&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;....#&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;...##&quot;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.to_string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()),&lt;/span&gt;
            &lt;span class=&quot;nd&quot;&gt;vec!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;
                &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
                &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
                &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
                &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
            &lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

        &lt;span class=&quot;nf&quot;&gt;Ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(())&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
     &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;buffer&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
     &lt;span class=&quot;nn&quot;&gt;io&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;stdin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.read_to_string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;buffer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.unwrap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

     &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;asteroids&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;parse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;buffer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When writing the tests, I had to constantly use the &lt;code&gt;&amp;amp;&quot;...&quot;.to_string()&lt;/code&gt;
pattern. Maybe I should have used &lt;code&gt;parse(source: &amp;amp;str)&lt;/code&gt; instead. I still
haven’t grokked the differences, and how they convert from one to the other.&lt;/p&gt;

&lt;p&gt;Similarly, I kept adding and removing &lt;code&gt;&amp;amp;&lt;/code&gt;s whenever I did maps and filters on
iterators, and switching between &lt;code&gt;iter()&lt;/code&gt; and &lt;code&gt;into_iter()&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;I used &lt;code&gt;collect::&amp;lt;Vec&amp;lt;_&amp;gt;&amp;gt;()&lt;/code&gt; excessively to avoid dealing with passing
Iterators around. I spent some time refactoring some of the solutions, but they
still have a long way to go. I wanted to return iterators to avoid excessive
copying, but couldn’t get the return types right.&lt;/p&gt;

&lt;p&gt;There seems to be an &lt;a href=&quot;https://doc.rust-lang.org/rust-by-example/trait/impl_trait.html&quot;&gt;&lt;code&gt;impl Trait&lt;/code&gt;
feature&lt;/a&gt; that
makes this possible. The &lt;code&gt;parse&lt;/code&gt; function above would become:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;parse&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;&#39;a&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;&#39;a&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;impl&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Iterator&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Item&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;usize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;usize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;&#39;a&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;source&lt;/span&gt;
        &lt;span class=&quot;nf&quot;&gt;.lines&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
        &lt;span class=&quot;nf&quot;&gt;.enumerate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
        &lt;span class=&quot;nf&quot;&gt;.flat_map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(|(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.chars&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.enumerate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;move&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;|(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)|&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)))&lt;/span&gt;
        &lt;span class=&quot;nf&quot;&gt;.filter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(|&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;&#39;#&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;nf&quot;&gt;.map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(|(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)|&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;// note the lack of collect here&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;// this would also work:&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;// fn parse(source: &amp;amp;String) -&amp;gt; impl Iterator&amp;lt;Item=(usize, usize)&amp;gt; + &#39;_ {&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I also had some hard times dealing with &lt;code&gt;flat_map&lt;/code&gt;. Since it returns an &lt;code&gt;impl
Iterator&lt;/code&gt; that might outlive the scope of the &lt;code&gt;flat_map&lt;/code&gt; closure, I had some
issues with lifetimes. I ended up almost never using it. Note the &lt;code&gt;move&lt;/code&gt; in the
example above, to deal with &lt;code&gt;y&lt;/code&gt; being borrowed into the inner closure that
outlives the outer closure.&lt;/p&gt;

&lt;p&gt;I missed some features that come with other programming language’s standard library.
These were the extra crates I ended up importing:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://docs.rs/regex&quot;&gt;regex&lt;/a&gt;: regular expression engine&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://docs.rs/itertools&quot;&gt;itertools&lt;/a&gt;: for &lt;code&gt;iproduct!&lt;/code&gt;, available in ruby as
&lt;a href=&quot;https://ruby-doc.org/core-2.7.0/Array.html#method-i-product&quot;&gt;&lt;code&gt;Array#product&lt;/code&gt;&lt;/a&gt;.
I would probably not require this if I didn’t derp as much as I did with
&lt;code&gt;flat_map&lt;/code&gt;.&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://docs.rs/gcd&quot;&gt;gcd&lt;/a&gt;: available in ruby as
&lt;a href=&quot;https://ruby-doc.org/core-2.7.0/Integer.html#method-i-gcd&quot;&gt;&lt;code&gt;Integer#gcd&lt;/code&gt;&lt;/a&gt;. I
ended up writing a custom version, because I needed the extended algorithm
instead of the basic one.&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://docs.rs/num-rational&quot;&gt;num-rational&lt;/a&gt;: available in ruby as
&lt;a href=&quot;https://ruby-doc.org/core-2.7.0/Rational.html&quot;&gt;&lt;code&gt;Rational&lt;/code&gt;&lt;/a&gt;. I needed this
because &lt;code&gt;f32&lt;/code&gt; are only partially comparable in Rust and I wanted to avoid
dealing with &lt;code&gt;partial_cmp&lt;/code&gt;, and with floating point imprecisions in general.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Additionally, I copied over an implementation of &lt;code&gt;next_permutation&lt;/code&gt;, available
in C++ as
&lt;a href=&quot;https://en.cppreference.com/w/cpp/algorithm/next_permutation&quot;&gt;&lt;code&gt;std::next_permutation&lt;/code&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&quot;puzzles-overview&quot;&gt;Puzzles overview&lt;/h2&gt;

&lt;p&gt;The puzzles alternated between two categories. &lt;code&gt;intcode&lt;/code&gt; related problems and
miscellaneous problems. &lt;code&gt;intcode&lt;/code&gt; problems started by requiring the
implementation of a virtual machine that deals with &lt;code&gt;i64&lt;/code&gt; and has a limited
number of instructions. The later &lt;code&gt;intcode&lt;/code&gt; problems used provided &lt;code&gt;intcode&lt;/code&gt;
programs as black boxes.&lt;/p&gt;

&lt;p&gt;The miscellaneous problems required some knowledge of modular arithmetic
properties, graph algorithms (common ancestors, shortest paths), and one
problem, 16 part 2, that seemed related to
&lt;a href=&quot;https://en.wikipedia.org/wiki/Fast_Fourier_transform&quot;&gt;FFT&lt;/a&gt; but I could quite
figure out the relationship. I will probably review this one, as well as puzzle
22 (the modular arithmetic one).&lt;/p&gt;

&lt;h2 id=&quot;conclusions&quot;&gt;Conclusions&lt;/h2&gt;

&lt;p&gt;I’m super happy that I finished this, and that I got to do it in a new
language. I kind of miss playing around in C++, template shenanigans included,
and rust is kind of close to it.&lt;/p&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2019-11-01:/articles/blockstack.html</id>
    <title type="html">Blockstack portuguese meetup</title>
    <published>2019-11-01T00:00:00Z</published>
    <updated>2019-11-01T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/blockstack.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;I went to a blockstack meetup last week. I heard about it thanks to Tiago Alves, who built a couple of apps on top of it. It has &lt;code&gt;block&lt;/code&gt; in the name, uses &lt;code&gt;decentralized&lt;/code&gt; a lot in its description, so I binned it under “blockchain” stuff and didn’t pay much attention to it.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;p&gt;I went to a blockstack meetup last week. I heard about it thanks to Tiago
Alves, who built a couple of apps on top of it. It has &lt;code&gt;block&lt;/code&gt; in the name,
uses &lt;code&gt;decentralized&lt;/code&gt; a lot in its description, so I binned it under
“blockchain” stuff and didn’t pay much attention to it.&lt;/p&gt;

&lt;p&gt;The meetup started with a brief description of what blockstack is, followed by
a showcase of apps using blockstack built by local folks.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://envelop.app/&quot;&gt;Envelop&lt;/a&gt;, a very simple free file-sharing app&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://blockvault.site/&quot;&gt;Blockvault&lt;/a&gt;, a decentralized password manager for
teams&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://lannister.capital/&quot;&gt;Lannister&lt;/a&gt;, a wealth manager and financial
planner&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://recall.photos/&quot;&gt;Recall&lt;/a&gt;, an end-to-end encrypted and open-source
photo vault app&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;app-mining&quot;&gt;App mining&lt;/h2&gt;

&lt;p&gt;Before I go into further details, one thing that was mentioned is that there is
a bounty of $200k per month given to the “best apps built on Blockstack”. I’m
guessing this money comes from the &lt;a href=&quot;https://venturebeat.com/2017/12/04/blockstack-raises-52-million-to-build-a-parallel-internet-where-you-own-all-your-data/&quot;&gt;$75 million they
raised&lt;/a&gt;.
These rewards are paid in BTC and STX (Stacks tokens). App mining, despite its
name, is not a decentralized process similar to block mining. There are select
reviewers assigned by Blockstack that rank existing apps according to &lt;a href=&quot;https://app.co/mining#how-are-apps-ranked&quot;&gt;certain
criteria&lt;/a&gt;. Blockstack will be
phasing out BTC in favor of STX.&lt;/p&gt;

&lt;p&gt;This felt like the biggest incentive for people to build apps. Not sure what to
think of this.&lt;/p&gt;

&lt;h2 id=&quot;blockstack-architecture&quot;&gt;Blockstack architecture&lt;/h2&gt;

&lt;p&gt;They mentioned that blockstack is composed by a bunch of different services,
and that their goal is not to push everything into a blockchain - only the
necessary / critical information. The first app we saw on the meetup is a file
hosting service, similar to firefox send. These files don’t get stored in a
blockchain, for example.&lt;/p&gt;

&lt;p&gt;The services that I remember hearing about are Blockstack auth, Gaia, and
something about smart contracts that isn’t quite ready yet. Probably related to
the STX tokens? Most projects seemed to rely on Auth and Gaia exclusively.&lt;/p&gt;

&lt;h2 id=&quot;blockstack-auth&quot;&gt;Blockstack auth&lt;/h2&gt;

&lt;p&gt;&lt;a href=&quot;https://docs.blockstack.org/develop/overview_auth.html&quot;&gt;Blockstack auth&lt;/a&gt; seems
to be a decentralized protocol to register accounts and a way for apps to have
access to account information. Something like namecoin (for unique user
identification) meets OAuth. Apparently, they did use namecoin at some point in
the past, but have &lt;a href=&quot;https://docs.blockstack.org/core/naming/comparison.html#blockstack-vs-namecoin&quot;&gt;now migrated to storing this on the Bitcoin
chain&lt;/a&gt;.
Block heights from &lt;a href=&quot;https://explorer.blockstack.org&quot;&gt;their explorer&lt;/a&gt; seem to
match bitcoin block heights.&lt;/p&gt;

&lt;p&gt;When an app asks for authorization, it can specify some scopes, just like
OAuth. Not many scopes are available right now. Only &lt;code&gt;store_write&lt;/code&gt;,
&lt;code&gt;publish_data&lt;/code&gt;, and &lt;code&gt;email&lt;/code&gt;. This protocol seems to use JWT, with the &lt;code&gt;ES256K&lt;/code&gt;
algorithm. This doesn’t seem to be in standard JWT libraries, so Blockstack
provides ruby and javascript libraries that implement this algorithm.&lt;/p&gt;

&lt;p&gt;The &lt;code&gt;store_write&lt;/code&gt; scope grants the app access to an app specific storage
bucket. Storage is implemented by the Gaia protocol/service.&lt;/p&gt;

&lt;h2 id=&quot;blockstack-gaia&quot;&gt;Blockstack Gaia&lt;/h2&gt;

&lt;p&gt;&lt;a href=&quot;https://docs.blockstack.org/storage/overview.html&quot;&gt;Blockstack Gaia&lt;/a&gt;, the
storage service, seems to be independent of blockchain usage. You can host it
anywhere, it is HTTP based, and URLs are in the format
&lt;code&gt;https://&amp;lt;domain&amp;gt;/&amp;lt;prefix&amp;gt;/store/&amp;lt;address&amp;gt;/&amp;lt;filename&amp;gt;&lt;/code&gt;. There is no read access
control. If you know the URL, you can access the file. Writing to files
requires that you have a token signed by the private key corresponding to
&lt;code&gt;&amp;lt;address&amp;gt;&lt;/code&gt; ( with a challenge which seems to be static per server).&lt;/p&gt;

&lt;p&gt;Sharing a storage namespace between multiple users doesn’t seem to be super
easy (Blockvault is trying to implement this to share password vaults). I found
something regarding &lt;a href=&quot;https://github.com/blockstack/gaia/issues/142&quot;&gt;scoping support in authentication
tokens&lt;/a&gt;, but the README doesn’t
mention this.&lt;/p&gt;

&lt;p&gt;Gaia doesn’t provide any guarantee of availability / resilience. It’s a simple
read/write protocol on top of HTTP. You host it on your own infrastructure.
They provide backend drivers for AWS S3 and Azure Blob Storage, but have
documented the driver API. You can also host them in your own hard drives.&lt;/p&gt;

&lt;p&gt;Any encryption should be done by the writer, and it’s not enforced by the
servers.&lt;/p&gt;

&lt;h2 id=&quot;integration&quot;&gt;Integration&lt;/h2&gt;

&lt;p&gt;Most of the developers that presented their apps mentioned that it was super
easy to integrate blockstack into their apps. There are iOS, Android, and
javascript SDKs which do most of the heavy lifting (including encrypting files
before uploading). They seemed to be mostly focused on design and user
experience. They all seemed to have the same grievances with some of Gaia
limitations.&lt;/p&gt;

&lt;p&gt;Blockstack offers gaia storage to everyone, with some limits (20 writes per
second, max 5mb per file). Due to this limitation, Envelop.app splits files
into chunks of 5mb. This makes their app available to anyone using blockstack’s
storage. Having the default storage option limited to 5mb means that apps must
use these limits, even if users have their own storage with higher limits. From
what I could gather, Gaia does not expose these limits in their discovery
endpoints, so developers can’t optimize for this.&lt;/p&gt;

&lt;h2 id=&quot;thoughts&quot;&gt;Thoughts&lt;/h2&gt;

&lt;p&gt;I registered an identity and, four hours later, it showed up in their block
explorer, under “Subdomain registration”. Since Blockstack is sponsoring the
name registrations (if they’re stored in the bitcoin chain, there’s a cost to
it), they’re probably batching registrations. My identity is
&lt;code&gt;hugopeixoto.id.blockstack&lt;/code&gt;. Note that this is a subdomain of &lt;code&gt;id.blockstack&lt;/code&gt;,
which I assume is a top level name controlled by Blockstack, the company.&lt;/p&gt;

&lt;p&gt;Gaia feels more like a fediverse/indieweb/self-hosting project. If there was no
free hosting by blockstack, I’m not sure so many would use this. I wonder if
there are any gaia service providers.&lt;/p&gt;

&lt;p&gt;Registration taking forever doesn’t seem very good for Blockstack auth. After
talking with some of the app developers, I felt like this is something that
could be replaced with a &lt;a href=&quot;https://indieauth.com/&quot;&gt;IndieAuth&lt;/a&gt; protocol. This
would mean using DNS instead of &lt;abbr title=&quot;Blockstack Naming Service&quot;&gt;BNS&lt;/abbr&gt;. In IndieAuth, you own your own domain and use it to log
in. You could also use a subdomain from an identity provider you trust (in the
same way that Blockstack controls &lt;code&gt;id.blockstack&lt;/code&gt;). Although I guess that in
blockstack’s scenario, transferring a subdomain could mean that it becomes self
sovereign. &lt;a href=&quot;https://docs.blockstack.org/core/naming/namespaces.html&quot;&gt;Apparently BNS subdomains are not stored
on-chain&lt;/a&gt;, so I’m not
sure how that works.&lt;/p&gt;

&lt;p&gt;Most apps presented during the meetup are open source. It could be worthwhile
to port the blockstack SDK to an IndieAuth implementation.&lt;/p&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2015-08-29:/articles/rails-and-postgresql-prepared-statements-leak.html</id>
    <title type="html">Rails and PostgreSQL prepared statements leak</title>
    <published>2015-08-29T00:00:00Z</published>
    <updated>2015-08-29T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/rails-and-postgresql-prepared-statements-leak.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;Postgres database memory usage went crazy due to a prepared statement “leak” in the code of a ruby on rails application. By adding a debug endpoint that lists every prepared statement of the current connection, I was able to figure out the source of the issue and fix it.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;p&gt;At work, we have several services running on rails backed by a postgres
database. One day, after a few changes, we noticed that postgresql memory usage
kept growing up to the point where the server restarted due to out of memory
issues.&lt;/p&gt;

&lt;p&gt;After a bit of debugging and &lt;a href=&quot;https://github.com/rails/rails/issues/14645&quot;&gt;searching through rails github
issues&lt;/a&gt;, I noticed that the number
of prepared statements created by each rails database connection was increasing
with time, until it reached the pool size limit (&lt;a href=&quot;https://github.com/rails/rails/blob/master/activerecord/lib/active_record/connection_adapters/postgresql_adapter.rb#L258&quot;&gt;which defaults to
1000&lt;/a&gt;).
This meant that a method was probably generating a prepared statement with
hardcoded values in the query, instead of using a bind parameter.&lt;/p&gt;

&lt;p&gt;To find out which section of the code was to blame, I added a debug endpoint to
our service that returned the list of prepared statements for the current
connection:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;module&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;DebugPreparedStatements&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;count&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;all&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;count&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;all&lt;/span&gt;
    &lt;span class=&quot;no&quot;&gt;ActiveRecord&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Base&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;connection&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;execute&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;select * from pg_prepared_statements&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;map&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;ss&quot;&gt;name: &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
          &lt;span class=&quot;ss&quot;&gt;statement: &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;statement&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
          &lt;span class=&quot;ss&quot;&gt;created_at: &lt;/span&gt;&lt;span class=&quot;no&quot;&gt;DateTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;parse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;prepare_time&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;DebugController&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ApplicationController&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;prepared_statements&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;render&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;json: &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;data: &lt;/span&gt;&lt;span class=&quot;no&quot;&gt;DebugPreparedStatements&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;all&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I deployed this to a staging environment with a single unicorn worker and
started making requests. It was important to either use a single worker or
configure the database connection pool size to one. Otherwise, the call to
&lt;em&gt;&lt;code&gt;/debug/prepared_statements&lt;/code&gt;&lt;/em&gt; would return inconsistent results, as each
connection has its own set of prepared statements.&lt;/p&gt;

&lt;p&gt;After a while, a pattern started to emerge. Each call to &lt;em&gt;&lt;code&gt;/api/products/:id&lt;/code&gt;&lt;/em&gt;
with a different id would generate a new prepared statement. After going
through roughly 1000 different ids, the number of prepared statements stopped
growing, as expected.&lt;/p&gt;

&lt;p&gt;Being able to see the actual prepared statement helped to detect which method
was causing this. It turned out that we were using string interpolation to
create a join statement with a subquery, and that subquery had the product id
in it. Due to the string interpolation, the id was being hardcoded into the
prepared statement. The offending code looked something like this:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;c1&quot;&gt;# `files` is an ActiveRecord::Relation object with bind parameters&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;foo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;files&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;maximals&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;files&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;group&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;...&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;select&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;...&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;ids&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;files&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;joins&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;NATURAL JOIN (&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;maximals&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;to_sql&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;) x&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;# ...&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After fixing this issue with some Arel magic, the number of prepared statements
would not grow above 30, which is a much more reasonable number.&lt;/p&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2015-05-10:/articles/first-impressions-of-haskell.html</id>
    <title type="html">First impressions of Haskell</title>
    <published>2015-05-10T00:00:00Z</published>
    <updated>2015-05-10T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/first-impressions-of-haskell.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;A couple of weeks ago, HackerRank sponsored a functional programming contest. 48 hours to solve seven problems in a functional language. This was the perfect opportunity to try out Haskell.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;p&gt;I usually enjoy trying out new languages, but it’s not always easy to find an
excuse to do so. If I have the time, I usually do a &lt;a href=&quot;https://github.com/hugopeixoto/mergesort&quot;&gt;mergesort
example&lt;/a&gt;. This forces me to go
through the setup phase (getting a compiler, creating a hello world) and try
some basic things like lists and recursion, but it’s definitely not enough.&lt;/p&gt;

&lt;p&gt;Fortunately, I’m a fan of programming competitions such as &lt;a href=&quot;https://codingcompetitions.withgoogle.com/codejam&quot;&gt;Google Code
Jam&lt;/a&gt;, &lt;a href=&quot;https://projecteuler.net&quot;&gt;Project
Euler&lt;/a&gt;, and recently
&lt;a href=&quot;https://hackerrank.com&quot;&gt;HackerRank&lt;/a&gt;. A couple of weeks ago, HackerRank
sponsored a functional programming contest. 48 hours to solve seven problems in
a functional language. This was the perfect opportunity to try out Haskell.&lt;/p&gt;

&lt;p&gt;Having previously played around a bit with it, I had expected to bump into some
problems.&lt;/p&gt;

&lt;h2 id=&quot;dealing-with-io&quot;&gt;Dealing with I/O&lt;/h2&gt;

&lt;p&gt;There’s the meme that as I/O is implemented using monads, it is pretty
complicated. Fortunately, these competition problems have very limited I/O.
Usually one just reads the problem parameters, and outputs the result. I did
not set out to fully understand
&lt;a href=&quot;https://wiki.haskell.org/Monad_tutorials_timeline&quot;&gt;monads&lt;/a&gt; during the contest,
but it still took me a while to manage reading lines of integers, apply some
function to them and print the results one in each line. This happened because
I wanted to write the code in a way such that each line would be read,
transformed and printed before the next line would be read (to avoid pulling
everything into memory). Something like:&lt;/p&gt;

&lt;div class=&quot;language-terminal?prompt=$ ,# &amp;amp;output=plaintext&amp;amp;output.token=Text&amp;amp;lang=plaintext&amp;amp;lang.token=Generic.Strong highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;while line = getNextLine
  result = solve line
  print line
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Eventually some random stackoverflow answer explained that functions like
&lt;code&gt;getContents&lt;/code&gt; are processed in a lazy way, which means that it will read bytes
as you require them. So something like the following would read, process and
write a line at a time:&lt;/p&gt;

&lt;div class=&quot;language-haskell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;n&quot;&gt;solve&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;show&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;length&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;main&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;queries&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;getContents&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;putStr&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;unlines&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;map&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;solve&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lines&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;queries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)))&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Another issue with I/O that came up was debugging. During these contests, part
of the challenge is figuring out patterns for given inputs, so it usually helps
to print intermediate values along the way. It’s impossible to place &lt;code&gt;putStr&lt;/code&gt;
instructions throughout the code without changing everything, due to their
monadic nature.&lt;/p&gt;

&lt;p&gt;Apparently, Haskell developers thought about this, and introduced the
&lt;code&gt;Debug.Trace.trace&lt;/code&gt; function which is a workaround using unsafe I/O operations.
It is designed for debugging purposes only. So the previous example could be
modified as follows:&lt;/p&gt;

&lt;div class=&quot;language-haskell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;kr&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;Debug.Trace&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;solve&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;trace&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;$&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;show&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;length&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This would print each line before printing the operation result, without the
need to sprinkle everything with &lt;code&gt;IO&lt;/code&gt;.&lt;/p&gt;

&lt;h2 id=&quot;memoization-and-random-access&quot;&gt;Memoization and random access&lt;/h2&gt;

&lt;p&gt;Programming contests usually require some form of &lt;a href=&quot;http://en.wikipedia.org/wiki/Dynamic_programming&quot;&gt;dynamic
programming&lt;/a&gt; approach. To put
it simply, this means to solve a problem of size N by combining the solutions
to the subproblems of size less than N. These subproblem solutions are usually
cached, to avoid redundant computation.&lt;/p&gt;

&lt;p&gt;A typical problem is calculating the Nth term of the fibonacci sequence.
Without any kind of caching, the naive implementation would be exponential in
time, as many subproblems would be solved multiple times:&lt;/p&gt;

&lt;div class=&quot;language-haskell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;n&quot;&gt;fib&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;fib&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;fib&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fib&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fib&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;-- this would expand as follows:&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;-- fib 4 = fib 3 + fib 2&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;--       = (fib 1 + fib 2) + fib 2&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;--       = (1 + fib 2) + fib 2&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;--       = (1 + (fib 0 + fib 1)) + fib 2&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;--       = (1 + (0 + fib 1)) + fib 2&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;--       = (1 + (0 + 1)) + fib 2&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;--       = (1 + (0 + 1)) + (fib 0 + fib 1)&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;--       = (1 + (0 + 1)) + (0 + fib 1)&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;--       = (1 + (0 + 1)) + (0 + 1)&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;--       = 3&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In C++, the dynamic programming approach could be implemented as follows:&lt;/p&gt;

&lt;div class=&quot;language-c++ highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;MAX_N&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fib&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;MAX_N&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;

&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;prepare&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;fib&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;fib&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;MAX_N&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;fib&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fib&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fib&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;prepare&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;cout&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fib&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;endl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In Haskell, the usual precomputed approach goes something like:&lt;/p&gt;

&lt;div class=&quot;language-haskell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;n&quot;&gt;fib&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cached&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!!&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;
  &lt;span class=&quot;kr&quot;&gt;where&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cached&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;zipWith&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cached&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tail&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cached&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;main&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;putStr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;$&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;show&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;$&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fib&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In this implementation, each fibonacci result is cached after being (itself or
a higher number) requested for the first time. There’s just one small detail
that, performance wise, might make a difference. The C++ sample uses an array,
whose indexing operation runs in constant time, while the Haskell version uses
a list, increasing the indexing running time to linear.&lt;/p&gt;

&lt;p&gt;It took me a while to solve the indexing problem, but I finally did it by
creating an array. This allows us to calculate the ith value by refering to
values which were previously calculated:&lt;/p&gt;

&lt;div class=&quot;language-haskell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;kr&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;Data.Array&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;maxn&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;100&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;fib&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cached&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;
  &lt;span class=&quot;kr&quot;&gt;where&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cached&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fromList&lt;/span&gt;
                   &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;maxn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
                   &lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;
                    &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cached&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cached&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;maxn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]])&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;main&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;putStr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;$&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;show&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;$&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fib&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Using an array guarantees constant time indexing, just like the C++ version.
The potential drawbacks of this solution are that it is no longer lazy, and the
bounds must be specified.&lt;/p&gt;

&lt;h2 id=&quot;immutability-vs-standard-algorithms&quot;&gt;Immutability vs standard algorithms&lt;/h2&gt;

&lt;p&gt;Just like the previous example, most algorithms are implemented with mutability
in mind. Take for example a depth first search. It requires some way of
tracking which nodes are already visited, to avoid looping forever. Since nodes
are usually numbered from 1 to &lt;code&gt;N&lt;/code&gt;, or 1 to &lt;code&gt;N-1&lt;/code&gt;, we can implement it with a
boolean array which is updated every time the search visits a node:&lt;/p&gt;

&lt;div class=&quot;language-python highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;dfs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;g&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;visited&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;False&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;g&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;ordered&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;dfs_aux&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;not&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;visited&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]:&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;visited&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;bp&quot;&gt;True&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;ordered&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;append&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

      &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;w&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;g&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]:&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;dfs_aux&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;v&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;g&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)):&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;dfs_aux&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ordered&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;graph&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[],&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]]&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;join&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;str&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dfs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;graph&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))))&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This implementation has a running time of &lt;code&gt;O(|V|+|E|)&lt;/code&gt;, which is as good as it
gets. It depends on the mutation of two variables: &lt;code&gt;visited&lt;/code&gt; and &lt;code&gt;ordered&lt;/code&gt;.
To write this in Haskell we’d need to get rid of those two states.&lt;/p&gt;

&lt;p&gt;Removing the mutation of &lt;code&gt;ordered&lt;/code&gt; without compromising the time complexity is
simple. Removing the mutation of &lt;code&gt;visited&lt;/code&gt;, however, is not trivial. If linear
time is not a requirement, a possible implementation would be to use a &lt;code&gt;Set&lt;/code&gt;
instead of a mutable array (a little more verbose than needed for clarity):&lt;/p&gt;

&lt;div class=&quot;language-haskell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;kr&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;Data.Array&lt;/span&gt;
&lt;span class=&quot;kr&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;qualified&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;Data.Set&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Set&lt;/span&gt;

&lt;span class=&quot;kr&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;Graph&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;Array&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;Int&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;kr&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;VisitedSet&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;Set&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;Int&lt;/span&gt;
&lt;span class=&quot;kr&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;State&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;VisitedSet&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;dfs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;::&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;Graph&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;dfs&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;g&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
  &lt;span class=&quot;kr&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kr&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;result&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;foldl&lt;/span&gt;
                      &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dfs&#39;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;g&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
                      &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;Set&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;empty&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
                      &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;indices&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;g&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reverse&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;result&lt;/span&gt;

  &lt;span class=&quot;kr&quot;&gt;where&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;dfs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;::&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;Graph&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;State&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;Int&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;State&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;dfs&#39;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;g&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;state&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;visited&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;result&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;Set&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;member&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;v&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;visited&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;state&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;otherwise&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;foldl&lt;/span&gt;
                      &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dfs&#39;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;g&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
                      &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;Set&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;v&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;visited&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;result&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
                      &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;g&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;graph&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;listArray&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;main&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;putStr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;$&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;unlines&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;map&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;show&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dfs&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;graph&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This would bring the complexity up to &lt;code&gt;O((|V| + |E|) log |V|)&lt;/code&gt;, as each
iteration would require a search and insertion into the set. Note: In order to
make the &lt;code&gt;result&lt;/code&gt; construction constant time, I had to prepend the nodes as
nodes where found. This caused the final list to be reversed, which is why
there is a &lt;code&gt;reverse&lt;/code&gt; call right before returning the ordered nodes.&lt;/p&gt;

&lt;p&gt;After some research, I found a paper titled &lt;em&gt;&lt;a href=&quot;http://www.researchgate.net/publication/2252048_Structuring_Depth-First_Search_Algorithms_in_Haskell&quot;&gt;Structuring Depth-First Search
Algorithms in
Haskell&lt;/a&gt;&lt;/em&gt;.
It describes an approach to the DFS algorithm in linear time using the ST
monad. This monad allows us to emulate an imperative style of programming, in a
contained way (without leaking the state to the caller). Instead of
implementing their technique of generating infinite trees and pruning them with
the ST monad, I opted for rewriting the code above with the ST monad instead:&lt;/p&gt;

&lt;div class=&quot;language-haskell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;kr&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;Data.Array&lt;/span&gt;
&lt;span class=&quot;kr&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;Data.Foldable&lt;/span&gt;
&lt;span class=&quot;kr&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;Data.Array.ST&lt;/span&gt;
&lt;span class=&quot;kr&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;Control.Monad.ST&lt;/span&gt;

&lt;span class=&quot;kr&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;Graph&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;Array&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;Int&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;kr&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;VisitedSet&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;s&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;STArray&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;s&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;Int&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;Bool&lt;/span&gt;
&lt;span class=&quot;kr&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;State&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;s&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;VisitedSet&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;dfs2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;::&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;Graph&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;dfs2&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;g&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;runST&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;newArray&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bounds&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;g&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;False&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;visited&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;foldlM&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dfs&#39;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;g&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;visited&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;indices&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;g&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kr&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;result&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;$&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reverse&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;result&lt;/span&gt;

  &lt;span class=&quot;kr&quot;&gt;where&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;dfs&#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;::&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;Graph&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;State&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;s&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;Int&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;ST&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;s&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;State&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;dfs&#39;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;g&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;state&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;visited&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;result&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;v&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;readArray&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;visited&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;v&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;is_visited&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;
          &lt;span class=&quot;kr&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;is_visited&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;of&lt;/span&gt;
            &lt;span class=&quot;kt&quot;&gt;True&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;state&lt;/span&gt;
            &lt;span class=&quot;kt&quot;&gt;False&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;writeArray&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;visited&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;v&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;True&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;
                       &lt;span class=&quot;n&quot;&gt;foldlM&lt;/span&gt;
                         &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dfs&#39;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;g&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
                         &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;visited&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;result&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
                         &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;g&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;graph&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;listArray&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;main&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;putStr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;$&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;unlines&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;map&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;show&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dfs2&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;graph&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note: I avoided Haskell’s &lt;code&gt;do&lt;/code&gt; notation on purpose. I am still trying to grok
monads, and I feel that the raw syntax helps.&lt;/p&gt;

&lt;p&gt;The resulting overall shape of the code is the same as the suboptimal one, but
its use of monads makes it non trivial for someone who has not played with them
for a while.&lt;/p&gt;

&lt;p&gt;There are probably libraries that implement these algorithms in an efficient
way, but my goal (in the context of programming competitions) is usually to
learn how they work and how to implement them.&lt;/p&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;Using Haskell in a programming competition was an interesting challenge.&lt;/p&gt;

&lt;p&gt;It felt limiting not being able to implement the algorithms in the way that I
usually do. During the contest I was not able to figure out how to use the
monad techniques I presented above, so some of my solutions were sub optimal.
In the end it didn’t make much difference, but it still felt uncomfortable.&lt;/p&gt;

&lt;p&gt;On the other hand, it was great to try out something different and have to
figure out how to do things that I always took for granted. I really liked lazy
evaluation as well. First, once I got used to it, the I/O handling code became
way simpler. Second, I started using infinite lists to avoid having to think
about limits and edge cases.&lt;/p&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2015-01-31:/articles/web-services-in-go.html</id>
    <title type="html">Web services in go</title>
    <published>2015-01-31T00:00:00Z</published>
    <updated>2015-01-31T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/web-services-in-go.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;I’ve been writing quite a few different web services in my current job. I’m going to talk a bit about my experience writing go web services.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;p&gt;I’ve been writing quite a few different web services in my current job.
Initially, they were all written in rails. As we shift towards a microservices
/ services oriented / whatchamacallit architecture, I’ve started experimenting
with other languages.&lt;/p&gt;

&lt;p&gt;Right now we have about 12 services, half of which are ruby (rails or sinatra),
with the other half being written in go. I’m going to talk a bit about my
experience writing go web services.&lt;/p&gt;

&lt;h2 id=&quot;configuration&quot;&gt;Configuration&lt;/h2&gt;

&lt;p&gt;In our rails applications, we have our configurations in yaml files, in the
&lt;code&gt;config&lt;/code&gt; directory. Database credentials live in &lt;code&gt;config/database.yml&lt;/code&gt;, mailer
options in the &lt;code&gt;config/mailer.yml&lt;/code&gt;, and so forth. These do not live in the code
repository, but instead are created the first time each service is deployed to
a server.&lt;/p&gt;

&lt;p&gt;To maintain some consistency between services, I would like to have something
similar across web services. However, the previous approach posed some
problems.&lt;/p&gt;

&lt;p&gt;First, go does not have a yaml parser implementation right of the bat, as will
probably be the case for most languages. There are some packages for it
(&lt;a href=&quot;https://github.com/go-yaml/yaml&quot;&gt;go-yaml&lt;/a&gt;,
&lt;a href=&quot;https://github.com/kylelemons/go-gypsy&quot;&gt;go-gypsy&lt;/a&gt;), but looking for the right
implementation every time we try a new language seems more trouble than it is
worth. JSON, on the other hand, is widely supported. Rust, nodejs, go, and PHP
all have native json capabilities, and none of them has yaml support.&lt;/p&gt;

&lt;p&gt;Second, having everything in its own file makes it a bit harder to deploy.
Ideally, I’d like to have some sort of central configuration system, like
&lt;a href=&quot;https://github.com/coreos/etcd&quot;&gt;etcd&lt;/a&gt;, from which each service fetches its
configuration periodically, or with some kind of notification system. In this
kind of setup, it makes little sense having configuration spread over multiple
files. Instead, I opted for a single file, &lt;code&gt;config/settings.json&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Eventually, I’d like to replace rails configuration yaml files with a single
json file as well.&lt;/p&gt;

&lt;h2 id=&quot;deployment&quot;&gt;Deployment&lt;/h2&gt;

&lt;p&gt;The first question here was deciding wether we should compile the binaries on
the server or on the development machine. There are a couple of drawbacks to
each approach.&lt;/p&gt;

&lt;p&gt;Compiling on the server requires a go compiler on every server, with the code
being compiled once per server.&lt;/p&gt;

&lt;p&gt;Compiling on the development machine would require a cross compilation
toolchain, since our development machines are all macs and the servers are all
running linux.&lt;/p&gt;

&lt;p&gt;I opted for the first option. It seemed less troublesome at the time, and it
kind of matches our ruby deployments, as in ruby the full source code gets
deployed to the server.&lt;/p&gt;

&lt;p&gt;We try to make deployment as homogeneous as possible, so we turned to
capistrano as our deployment tool. It’s our tool of choice when deploying ruby
services, so we saw no reason to use anything else.&lt;/p&gt;

&lt;p&gt;Here’s a sample deploy.rb file:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;n&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:application&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;binfo&#39;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:repo_url&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;company.com:web/binfo.git&#39;&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:deploy_to&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;/path/to/app&#39;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:scm&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:git&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:ssh_options&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;forward_agent: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:default_env&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;path: &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/usr/local/go/bin:$PATH&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:linked_files&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;sx&quot;&gt;%w{ config/settings.json }&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:service&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;service nlife-binfo&#39;&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;namespace&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:go&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;desc&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;Build go application&#39;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;task&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:build&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;on&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;roles&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:app&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;in: :sequence&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;wait: &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;within&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;release_path&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;with&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;gopath: &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;release_path&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
          &lt;span class=&quot;n&quot;&gt;execute&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:sh&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;build.sh&#39;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;namespace&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:deploy&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;desc&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;Restart application&#39;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;task&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:restart&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;on&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;roles&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:app&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;in: :sequence&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;wait: &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fetch&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:service&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:restart&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;after&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:publishing&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:restart&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;after&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:finishing&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;deploy:cleanup&#39;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;after&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:updated&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;go:build&#39;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You’ll notice that I’m using &lt;code&gt;service nlife-binfo restart&lt;/code&gt; to restart the
webservice.  Usually we deploy services to ubuntu, so we use upstart scripts to
manage the service lifetime.&lt;/p&gt;

&lt;p&gt;Upstart scripts are relatively simple (although this will probably have to be
migrated to systemd once it replaces upstart, but that should take a while).
Here’s a sample script:&lt;/p&gt;

&lt;div class=&quot;language-upstart highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;description&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;nlife binfo service&quot;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;start&lt;/span&gt; on (local-filesystems and runlevel [2345])
&lt;span class=&quot;k&quot;&gt;stop&lt;/span&gt; on runlevel [06]

&lt;span class=&quot;k&quot;&gt;setuid&lt;/span&gt; binfo-runner
&lt;span class=&quot;k&quot;&gt;setgid&lt;/span&gt; binfo-runner

&lt;span class=&quot;k&quot;&gt;chdir&lt;/span&gt; /path/to/app/current

&lt;span class=&quot;k&quot;&gt;exec&lt;/span&gt; bin/binfo
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In the future, I’d like to give &lt;a href=&quot;https://github.com/rcrowley/goagain&quot;&gt;goagain&lt;/a&gt;
a try. Its goal is to avoid downtime while the service is reloading.  It
requires rewriting most of the http server code, or combining it with
&lt;a href=&quot;https://github.com/braintree/manners&quot;&gt;manners&lt;/a&gt;. This work has been done by
other developers, in &lt;a href=&quot;https://github.com/cupcake/mannersagain&quot;&gt;mannersagain&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;With this in play, the capistrano recipe would need to be changed to reload the
service instead of restarting it, and no requests would be dropped.&lt;/p&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2011-03-24:/articles/openid-the-comeback.html</id>
    <title type="html">OpenID - The comeback</title>
    <published>2011-03-24T00:00:00Z</published>
    <updated>2011-03-24T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/openid-the-comeback.html"/>
    <summary type="html">
      <![CDATA[]]>
    </summary>
    <content type="html">

      &lt;p&gt;In the past, I wrote (with a friend of mine) a simple PHP OpenID provider. We
used &lt;a href=&quot;http://getdorm.com/&quot;&gt;dorm&lt;/a&gt;, and no extra framework whatsoever.&lt;/p&gt;

&lt;p&gt;It is now a messy pile of code.&lt;/p&gt;

&lt;p&gt;As such, we are rewriting it in a random Ruby web framework. So that we learn
something in the process, we’ll be using the following set of technologies:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;http://sinatrarb.com/&quot;&gt;Sinatra&lt;/a&gt; as the framework,&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;http://datamapper.org/&quot;&gt;DataMapper&lt;/a&gt; as the ORM and&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;http://slim-lang.com/&quot;&gt;Slim&lt;/a&gt; as the templating language.&lt;/li&gt;
&lt;/ul&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2009-09-13:/articles/ubuntu-rvm-and-contributing-to-rails.html</id>
    <title type="html">Ubuntu, rvm and contributing to rails</title>
    <published>2009-09-13T00:00:00Z</published>
    <updated>2009-09-13T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/ubuntu-rvm-and-contributing-to-rails.html"/>
    <summary type="html">
      <![CDATA[]]>
    </summary>
    <content type="html">

      &lt;p&gt;I wanted to write a couple of patches for the rails gem, so I needed to clone
the rails repository and install all the gem dependencies with bundler.
Unfortunately, my bundler installation doesn’t work very well, as I screwed
something up when installing several versions of ruby. So I decided to create a
virtual machine with &lt;em&gt;Ubuntu&lt;/em&gt; and install everything with &lt;em&gt;rvm&lt;/em&gt;. I’ll describe
all the steps I took after the VM installation. I used Ubuntu 10.04.1 LTS, so
your mileage may vary.&lt;/p&gt;

&lt;h2 id=&quot;initial-setup&quot;&gt;Initial setup&lt;/h2&gt;

&lt;p&gt;I started by installing the ssh server. This step is completely unrelated to
the ruby business, but it allowed me to connect to the server from my laptop&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;hugopeixoto@ruby&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;aptitude &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;ssh
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then, I installed a couple of packages that rvm will need.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;bash (it was obviously already installed),&lt;/li&gt;
  &lt;li&gt;curl and&lt;/li&gt;
  &lt;li&gt;git-core.&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;hugopeixoto@ruby&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;aptitude &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;bash curl git-core
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;rvm-installation&quot;&gt;rvm installation&lt;/h2&gt;

&lt;p&gt;To install rvm, I decided to go with a system-wide installation. This makes the
rubies available to all the users instead of just the one used in the
installation process. To do this, I just needed to execute their system-wide
installation script.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;hugopeixoto@ruby&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;su -
root@ruby# bash &amp;lt; &amp;lt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; curl &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; http://bit.ly/rvm-install-system-wide &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now that it is installed, there were a couple of extra steps I had to take to
be able to install the rubies. First, there are some required packages so that
the rubies can be installed from source. Additionally, rvm must be loaded when
your shell launches so that you can use the rvm commands. The two following
commands were ran as root:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;hugopeixoto@ruby&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;su -
root@ruby# aptitude &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;build-essential bison openssl &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
           libreadline6 libreadline6-dev curl git-core zlib1g &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
           zlib1g-dev libssl-dev libyaml-dev libsqlite3-0 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
           libsqlite3-dev sqlite3 libxml2-dev libxslt-dev &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
           autoconf libc6-dev
root@ruby# &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;[[ -s &quot;/usr/local/lib/rvm&quot; ]] &amp;amp;&amp;amp; source &quot;/usr/local/lib/rvm&quot;&#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /etc/profile.d/rvm.sh
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After doing that, you are ready to install any version of ruby and using it.
For example, say you want to have ruby 1.8.7, 1.9.1 and 1.9.2 and that you want
to use, for now, 1.9.1. Just type:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;root@ruby# rvm &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;1.8.7
root@ruby# rvm &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;1.9.1
root@ruby# rvm &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;1.9.2
root@ruby# rvm 1.9.1
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And you’re done. If you want to install rails, now, just type:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;root@ruby# gem &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;rails
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;contributing-to-rails&quot;&gt;Contributing to rails&lt;/h2&gt;

&lt;p&gt;In order to make modifications to the rails source code and run the tests, you
want to check out the lastest version of rails. This can be pulled from their
git repository:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;hugopeixoto@ruby&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;git clone git@github.com:rails/rails.git
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You also need to install additional gems and system libraries. All the gems
required to test rails can be installed using the bundler gem:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;hugopeixoto@ruby&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;gem &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;bundler
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You can decide if you want to test mysql and postgresql. If you don’t, just run&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;hugopeixoto@ruby&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;aptitude &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;libxslt-dev
hugopeixoto@ruby&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;rails
hugopeixoto@ruby:~/rails&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;bundle &lt;span class=&quot;nb&quot;&gt;install&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--without&lt;/span&gt; db
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Otherwise, you need to install the databases and their client development packages:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;hugopeixoto@ruby&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;aptitude &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;libxslt-dev libmysqlclient-dev libpq-dev
hugopeixoto@ruby&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;rails
hugopeixoto@ruby:~/rails&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;bundle &lt;span class=&quot;nb&quot;&gt;install&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--without&lt;/span&gt; db
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note that installing and configuring both mysql and postgresql servers is not
covered here. View the &lt;a href=&quot;http://edgeguides.rubyonrails.org/contributing_to_rails.html#testing-active-record&quot;&gt;rails guide on
contributing&lt;/a&gt;
for more details on this.&lt;/p&gt;

&lt;p&gt;This is pretty much it! Now you just need to make your changes, and run the
tests to see if anything is broken:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;rouge-gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;rouge-code&quot;&gt;&lt;pre&gt;hugopeixoto@ruby:~/rails&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;rake &lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2009-08-10:/articles/railsbridge-bugmash.html</id>
    <title type="html">Rails and RailsBridge BugMash</title>
    <published>2009-08-10T00:00:00Z</published>
    <updated>2009-08-10T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/railsbridge-bugmash.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;RailsBridge BugMash&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;p&gt;During the past weekend, the Rails team organized a &lt;em&gt;BugMash&lt;/em&gt; with the help of
the &lt;a href=&quot;http://railsbridge.org/&quot;&gt;&lt;em&gt;RailsBridge&lt;/em&gt;&lt;/a&gt; community. More than 180 tickets
from &lt;a href=&quot;https://rails.lighthouseapp.com/projects/8994-ruby-on-rails/tickets?q=all&quot;&gt;Rails
Lighthouse&lt;/a&gt;
were chosen and targeted during the past 48 hours.&lt;/p&gt;

&lt;p&gt;They were even able to gather a few prizes to raffle off. The more
contributions you made, the higher the chance to win something. About &lt;em&gt;120
tickets were solved&lt;/em&gt; during this joint effort and a few new bugs were
discovered, so I’d say that this initiative was pretty successful.&lt;/p&gt;

&lt;p&gt;I was able to commit 6 patches to both 2.3-stable and master branches. A part
of me will be in Rails 3.0! Neat, huh? I had lots of fun digging around mostly
through activerecord and actionpack. I also had the opportunity to get in touch
with &lt;a href=&quot;http://www.git-scm.org/&quot;&gt;&lt;em&gt;git&lt;/em&gt;&lt;/a&gt; — branching, patching and whatnot.
Lets see if I can win some cute books!&lt;/p&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2009-06-16:/articles/neatsqueak-at-epia2009.html</id>
    <title type="html">NEATSqueak @ EPIA&#39;2009</title>
    <published>2009-06-16T00:00:00Z</published>
    <updated>2009-06-16T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/neatsqueak-at-epia2009.html"/>
    <summary type="html">
      <![CDATA[]]>
    </summary>
    <content type="html">

      &lt;blockquote&gt;
  &lt;p&gt;Dear Hugo Peixoto, We have the pleasure to inform you that your contribution
entitled &lt;em&gt;NeatSqueak on wheels: Neural networks applied to movement
optimization of a simulated robot&lt;/em&gt; (paper #131) submitted to EPIA’2009 has
been accepted for presentation at the conference in Aveiro, October 12-15,
2009, and publication in the conference proceedings.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Somehow, we’re in. Our first
&lt;a href=&quot;http://hugopeixoto.net/neatsqueak.html&quot;&gt;NEATSqueak&lt;/a&gt; related paper got
accepted!&lt;/p&gt;

&lt;p&gt;This paper is the result of our work done during the Robotics course. It
focuses on the application of &lt;em&gt;unsupervised&lt;/em&gt; learning methods to the
&lt;a href=&quot;http://microrato.ua.pt/&quot;&gt;Ciber-Rato&lt;/a&gt; competition. We developed a neural
network to control a simple robot so that he follows a set of points.&lt;/p&gt;

&lt;p&gt;I don’t know how it got accepted; we were &lt;em&gt;severely&lt;/em&gt; bashed on most of the four
reviews and our work was very simple, not even suitable for a conference. We
were just aiming at getting a good grade on our course.&lt;/p&gt;

&lt;p&gt;Now we need to review a couple of issues, and we’ll be presenting it in
October, at &lt;em&gt;EPIA’2009&lt;/em&gt;. I really hope we don’t get flamed much during the
discussion.&lt;/p&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2009-06-09:/articles/openid-at-feup.html</id>
    <title type="html">The beginning of OpenID at FEUP</title>
    <published>2009-06-09T00:00:00Z</published>
    <updated>2009-06-09T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/openid-at-feup.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;OpenID at FEUP.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;p&gt;Early this year, a friend of mine at
&lt;a href=&quot;https://web.archive.org/web/20090218234900/http://ni.fe.up.pt/&quot;&gt;NIFEUP&lt;/a&gt; (our
local informatics students’ group) developed an application similar to
rapidshare (named
&lt;a href=&quot;https://web.archive.org/web/20110615185519/http://feupload.fe.up.pt/&quot;&gt;feupload&lt;/a&gt;,
although free and limited to our Faculty members. This application used LDAP
server as a means to authenticate the users — you just had to insert your
campus credentials, and an account would be automatically created.&lt;/p&gt;

&lt;p&gt;This mechanism, although promoting usability, leads to the usual trust issue:
&lt;em&gt;you have to give away your credentials to a third party&lt;/em&gt; in order to use the
service.&lt;/p&gt;

&lt;p&gt;Now, although we’re pretty much honest people regarding these kind of details,
one can imagine the damage that could’ve been done if we were storing the
users’ credentials. Several teachers are using our service. With this in mind,
we had to think of an alternative approach.&lt;/p&gt;

&lt;p&gt;Enter &lt;a href=&quot;https://openid.net/&quot;&gt;OpenID&lt;/a&gt;:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;OpenID is a free and easy way to use a single digital identity across the
Internet.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;This is exactly what we were looking for. Basically, the website that requires
authentication redirects the user to his OpenID page, where he can confirm his
identity with his credentials. After being validated, the user is redirected
again to the first website, carrying a token that guarantees his identity. This
way, there’s &lt;em&gt;no need to enter our credentials&lt;/em&gt; in the website requiring
authentication.&lt;/p&gt;

&lt;p&gt;OpenID also has some extensions (&lt;a href=&quot;https://openid.net/specs/openid-simple-registration-extension-1_0.html&quot;&gt;Simple
Registration&lt;/a&gt;
and &lt;a href=&quot;https://openid.net/specs/openid-attribute-exchange-1_0.html&quot;&gt;Attribute
Exchange&lt;/a&gt;), which
allow the identity provider to automatically fill in registration fields, such
as email address, full name, country, etc. Of course, this requires the user’s
permission. Or at least, it should.&lt;/p&gt;

&lt;p&gt;So, me and &lt;a href=&quot;https://ethereal.io/&quot;&gt;Pedro Coelho&lt;/a&gt; proposed implementing this
service so that it can be used with our faculty’s credentials. Obviously, it
will be deployed and validated by our IT department so that the users can trust
the service.&lt;/p&gt;

&lt;p&gt;Yesterday, we completed the first stage — we achieved OpenID 1.1 full
compliance:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/articles/openid-compliance1.png&quot; alt=&quot;OpenID@FEUP current status&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Now, we need to continue and implement the 2.0 features, along with the SREG/AX
extensions. We’ll also need to work on the user interface a bit, so that it
doesn’t look like this:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/articles/openid-interface.png&quot; alt=&quot;OpenID@FEUP user interface&quot; /&gt;&lt;/p&gt;

&lt;p&gt;In this case, OpenID can be used not only as a &lt;em&gt;centralized identity&lt;/em&gt;, but also
as a way for our services to verify if a user belongs to our institution
without asking for their passwords. I’m hoping that we have this finished by
the end of the semester, so that it can be integrated with feupload and other
applications before the next school year.&lt;/p&gt;

    </content>
  </entry>
  <entry>
    <id>tag:hugopeixoto.net,2009-06-05:/articles/hello-world.html</id>
    <title type="html">Hello, world</title>
    <published>2009-06-05T00:00:00Z</published>
    <updated>2009-06-05T00:00:00Z</updated>
    <link rel="alternate" href="https://hugopeixoto.net/articles/hello-world.html"/>
    <summary type="html">
      <![CDATA[&lt;p&gt;Obligatory first post.&lt;/p&gt;
]]>
    </summary>
    <content type="html">

      &lt;p&gt;So, I decided to start a blog. Why? I guess I just want to have a place where I
can register my random projects and experiments. Come to think of it, I believe
that most developers like talking about what they do — but nobody wants
to listen. Hence the great number of developer blogs.&lt;/p&gt;

&lt;p&gt;With this in mind, I’m planning on writing small and simple posts on what I’m
currently working on. An &lt;a href=&quot;http://openid.net&quot;&gt;OpenID&lt;/a&gt; provider implementation at
&lt;a href=&quot;https://sigarra.up.pt/feup/pt/web_page.inicial&quot;&gt;FEUP&lt;/a&gt;, A.I. experiments, or
something else that randomly pops into my interest.&lt;/p&gt;

    </content>
  </entry>
</feed>
